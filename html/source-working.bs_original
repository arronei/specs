<h2 id="editing">User interaction</h2>


  <h3>The <dfn><code data-x="attr-hidden">hidden</code></dfn> attribute</h3>

  <p>All <span>HTML elements</span> may have the <code data-x="attr-hidden">hidden</code> content
  attribute set. The <code data-x="attr-hidden">hidden</code> attribute is a <span>boolean
  attribute</span>. When specified on an element, it indicates that the element is not yet, or is no
  longer, directly relevant to the page's current state, or that it is being used to declare content
  to be reused by other parts of the page as opposed to being directly accessed by the user. <span
  class="impl">User agents should not render elements that have the <code
  data-x="attr-hidden">hidden</code> attribute specified. This requirement may be implemented
  indirectly through the style layer. For example, an HTML+CSS user agent could implement these
  requirements <a href="#hiddenCSS">using the rules suggested in the Rendering
  section</a>.</span></p>

  <p class="note">Because this attribute is typically implemented using CSS, it's also possible to
  override it using CSS. For instance, a rule that applies 'display: block' to all elements will
  cancel the effects of the <code data-x="attr-hidden">hidden</code> attribute. Authors therefore
  have to take care when writing their style sheets to make sure that the attribute is still styled
  as expected.</p>

  <div class="example">

   <p>In the following skeletal example, the attribute is used to hide the Web game's main screen
   until the user logs in:</p>

   <pre>  &lt;h1>The Example Game&lt;/h1>
  &lt;section id="login">
   &lt;h2>Login&lt;/h2>
   &lt;form>
    ...
    &lt;!-- calls login() once the user's credentials have been checked -->
   &lt;/form>
   &lt;script>
    function login() {
      // switch screens
      document.getElementById('login').hidden = true;
      document.getElementById('game').hidden = false;
    }
   &lt;/script>
  &lt;/section>
  &lt;section id="game" hidden>
   ...
  &lt;/section></pre>

  </div>

  <p>The <code data-x="attr-hidden">hidden</code> attribute must not be used to hide content that
  could legitimately be shown in another presentation. For example, it is incorrect to use <code
  data-x="attr-hidden">hidden</code> to hide panels in a tabbed dialog, because the tabbed interface
  is merely a kind of overflow presentation &mdash; one could equally well just show all the form
  controls in one big page with a scrollbar. It is similarly incorrect to use this attribute to hide
  content just from one presentation &mdash; if something is marked <code
  data-x="attr-hidden">hidden</code>, it is hidden from all presentations, including, for instance,
  screen readers.</p>

  <!-- for example, "<a hidden href=#content>Skip to content</a>" would be inappropriate. -->
  <!-- (but only add that example if you first add some more good valid examples -->

  <p>Elements that are not themselves <code data-x="attr-hidden">hidden</code> must not
  <span>hyperlink</span> to elements that are <code data-x="attr-hidden">hidden</code>. The <code
 >for</code> attributes of <code>label</code> and <code>output</code> elements that are not
  themselves <code data-x="attr-hidden">hidden</code> must similarly not refer to elements that are
  <code data-x="attr-hidden">hidden</code>. In both cases, such references would cause user
  confusion.</p>

  <p>Elements and scripts may, however, refer to elements that are <code
  data-x="attr-hidden">hidden</code> in other contexts.</p>
  <div class="example">

   <p>For example, it would be incorrect to use the <code
   data-x="attr-hyperlink-href">href</code> attribute to link to a
   section marked with the <code data-x="attr-hidden">hidden</code>
   attribute. If the content is not applicable or relevant, then there
   is no reason to link to it.</p>

   <p>It would be fine, however, to use the ARIA <code
   data-x="attr-aria-describedby">aria-describedby</code> attribute to
   refer to descriptions that are themselves <code
   data-x="attr-hidden">hidden</code>. While hiding the descriptions
   implies that they are not useful alone, they could be written in
   such a way that they are useful in the specific context of being
   referenced from the images that they describe.</p>

   <p>Similarly, a <code>canvas</code> element with the <code
   data-x="attr-hidden">hidden</code> attribute could be used by a
   scripted graphics engine as an off-screen buffer, and a form
   control could refer to a hidden <code>form</code> element using its
   <code data-x="attr-fae-form">form</code> attribute.</p>

  </div>

  <p>Accessibility APIs are encouraged to provide a way to expose
  structured content while marking it as hidden in the default view.
  Such content should not be perceivable to users in the normal document
  flow in any modality, whether using Assistive Technology (AT) or
  mainstream User Agents.</p>

  <p>When such features are available, User Agents may use them to
  expose the full semantics of <code data-x="attr-hidden">hidden</code>
  elements to AT when appropriate, if such content is referenced
  indirectly by an <span data-x="concept-id">ID reference</span> or
  <span>valid hash-name reference</span>. This allows ATs to access the
  structure of these <code data-x="attr-hidden">hidden</code> elements
  upon user request, while keeping the content hidden in all
  presentations of the normal document flow. Authors who wish to prevent
  user-initiated viewing of a <code data-x="attr-hidden">hidden</code>
  element should not reference the element with such a mechanism.</p>

  <p class="auth">Because some User Agents have flattened hidden content when
  exposing such content to AT, authors should not reference <code
  title="attr-hidden">hidden</code> content which would lose essential
  meaning when flattened.</p>

  <div class="example">

   <p>For example, it would be incorrect to use the <code data-x="attr-hyperlink-href">href</code>
   attribute to link to a section marked with the <code data-x="attr-hidden">hidden</code> attribute.
   If the content is not applicable or relevant, then there is no reason to link to it.</p>

   <p>It would be fine, however, to use the ARIA <code
   data-x="attr-aria-describedby">aria-describedby</code> attribute to refer to descriptions that are
   themselves <code data-x="attr-hidden">hidden</code>. While hiding the descriptions implies that
   they are not useful alone, they could be written in such a way that they are useful in the
   specific context of being referenced from the images that they describe.</p>

   <p>Similarly, a <code>canvas</code> element with the <code data-x="attr-hidden">hidden</code>
   attribute could be used by a scripted graphics engine as an off-screen buffer, and a form control
   could refer to a hidden <code>form</code> element using its <code
   data-x="attr-fae-form">form</code> attribute.</p>

  </div>

  <p>Elements in a section hidden by the <code data-x="attr-hidden">hidden</code> attribute are still
  active, e.g. scripts and form controls in such sections still execute and submit respectively.
  Only their presentation to the user changes.</p>

  <div class="impl">

  <p>The <dfn><code data-x="dom-hidden">hidden</code></dfn> IDL attribute must <span>reflect</span>
  the content attribute of the same name.</p>

  </div>



  <h3 id="inert-subtrees">Inert subtrees</h3>

  <p class="note">This section <strong>does not</strong> define or create any content attribute
  named "inert". This section merely defines an abstract <em>concept</em> of
  <span data-x="inert">inertness</span>.</p>

  <p>A node (in particular elements and text nodes) can be marked as <dfn>inert</dfn>. When a node
  is <span>inert</span>, then the user agent must act as if the node was absent for the purposes of
  targeting user interaction events, may ignore the node for the purposes of text search user
  interfaces (commonly known as "find in page"), and may prevent the user from selecting text in
  that node. User agents should allow the user to override the restrictions on search and text
  selection, however.</p>

  <p class="example">For example, consider a page that consists of just a single <span>inert</span>
  paragraph positioned in the middle of a <code>body</code>. If a user moves their pointing device
  from the <code>body</code> over to the <span>inert</span> paragraph and clicks on the paragraph,
  no <code data-x="event-mouseover">mouseover</code> event would be fired, and the <code
  data-x="event-mousemove">mousemove</code> and <code data-x="event-click">click</code> events would
  be fired on the <code>body</code> element rather than the paragraph.</p>

  <p class="note">When a node is inert, it generally cannot be focused. Inert nodes that are <span
  data-x="concept-command">commands</span> will also get disabled.</p>

  <p>While a <span>browsing context container</span> is marked as <span>inert</span>, its
  <span>nested browsing context</span>'s <span>active document</span>, and all nodes in that
  <code>Document</code>, must be marked as <span>inert</span>.</p>

  <p>An entire <code>Document</code> can be marked as <dfn>blocked by a modal dialog</dfn> <var>subject</var>. While a <code>Document</code> is so marked, every node that is <span
  data-x="in a Document">in the <code>Document</code></span>, with the exception of the <var>subject</var> element and its descendants, must be marked <span>inert</span>. (The
  elements excepted by this paragraph can additionally be marked <span>inert</span> through other
  means; being part of a modal dialog does not "protect" a node from being marked
  <span>inert</span>.)</p>

  <p>Only one element at a time can mark a <code>Document</code> as being <span>blocked by a modal
  dialog</span>. When a new <code>dialog</code> is made to <span data-x="blocked by a modal
  dialog">block</span> a <code>Document</code>, the previous element, if any, stops blocking the
  <code>Document</code>.</p>

  <p class="note">The <code>dialog</code> element's <code
  data-x="dom-dialog-showModal">showModal()</code> method makes use of this mechanism.</p>




  <h3 id="activation">Activation</h3>

  <p>Certain elements in HTML have an <span>activation behavior</span>, which means that the user
  can activate them. This triggers a sequence of events dependent on the activation mechanism, and
  normally culminating in a <code data-x="event-click">click</code> event<span class="impl">, as
  described below</span>.</p>

  <div class="impl">

  <p>The user agent should allow the user to manually trigger elements that have an <span>activation
  behavior</span>, for instance using keyboard or voice input, or through mouse clicks. When the
  user triggers an element with a defined <span>activation behavior</span> in a manner other than
  clicking it, the default action of the interaction event must be to <span>run synthetic click
  activation steps</span> on the element.</p> <!-- interaction event spec point -->

  <p>Each element has a <var>click in progress</var> flag, initially set to false.</p>

  <p>When a user agent is to <dfn>run synthetic click activation steps</dfn> on an element, the user
  agent must run the following steps:</p>

  <ol>

   <li><p>If the element's <var>click in progress</var> flag is set to true, then abort
   these steps.</p></li>

   <li><p>Set the <var>click in progress</var> flag on the element to true.</p></li>

   <li><p><span>Run pre-click activation steps</span> on the element.</p></li>

   <li><p><span>Fire a <code data-x="event-click">click</code> event</span> at the element. If the
   <span>run synthetic click activation steps</span> algorithm was invoked because the <code
   data-x="dom-click">click()</code> method was invoked, then the <code
   data-x="dom-event-isTrusted">isTrusted</code> attribute must be initialized to false.</p></li>

   <li>

    <p>If this <code data-x="event-click">click</code> event is not canceled, <span>run post-click
    activation steps</span> on the element.</p>

    <p>If the event <em>is</em> canceled, the user agent must <span>run canceled activation
    steps</span> on the element instead.</p>

   </li>

   <li><p>Set the <var>click in progress</var> flag on the element to false.</p></li>

  </ol>

  <p>When a pointing device is clicked, the user agent must <span>run authentic click activation
  steps</span> instead of firing the <code data-x="event-click">click</code>
  event<!-- interaction event spec point -->. When a user agent is to
  <dfn>run authentic click activation steps</dfn> for a given event <var>event</var>, it must
  follow these steps:</p>

  <ol>

   <li><p>Let <var>target</var> be the element designated by the user (the target of <var>event</var>).</p></li>

   <li><p>If <var>target</var> is a <code>canvas</code> element, run the <span>canvas
   <code>MouseEvent</code> rerouting steps</span>. If this changes <var>event</var>'s
   target, then let <var>target</var> be the new target.</p></li>

<!--(this is commented out because you can't possibly get here reentrantly and you can't get here while click() is running.)
   <li><p>If <var>target</var>'s <var>click in progress</var> flag is set to
   true, then abort these steps.</p></li>
-->

   <li><p>Set the <var>click in progress</var> flag on <var>target</var> to
   true.</p></li>

   <li><p>Let <var>e</var> be the <span>nearest activatable element</span> of <var>target</var> (defined below), if any.</p></li>

   <li><p>If there is an element <var>e</var>, <span>run pre-click activation steps</span>
   on it.</p></li>

   <li>

    <p><span data-x="concept-event-dispatch">Dispatch</span> <var>event</var> (the
    required <code data-x="event-click">click</code> event) at <var>target</var>.</p> <!--
    interaction event spec point -->

    <p>If there is an element <var>e</var> and the <code data-x="event-click">click</code>
    event is not canceled, <span>run post-click activation steps</span> on element <var>e</var>.</p>

    <p>If there is an element <var>e</var> and the event <em>is</em> canceled, <span>run
    canceled activation steps</span> on element <var>e</var>.</p>

   </li>

   <li><p>Set the <var>click in progress</var> flag on <var>target</var> to
   false.</p></li>

  </ol>

  <p class="note">The algorithms above don't run for arbitrary synthetic events dispatched by author
  script. The <code data-x="dom-click">click()</code> method can be used to make the <span>run
  synthetic click activation steps</span> algorithm happen programmatically.</p>

  <p class="note">Click-focusing behavior (e.g. the focusing of a text field when user clicks in
  one) typically happens before the click, when the mouse button is first depressed, and is
  therefore not discussed here.</p> <!-- interaction event spec point -->

  <p>Given an element <var>target</var>, the <dfn>nearest activatable element</dfn> is the
  element returned by the following algorithm:</p>

  <ol>

   <li><p>If <var>target</var> has a defined <span>activation behavior</span>, then return
   <var>target</var> and abort these steps.</p></li>

   <li><p>If <var>target</var> has a parent element, then set <var>target</var> to
   that parent element and return to the first step.</p></li>

   <li><p>Otherwise, there is no <span>nearest activatable element</span>.</p></li>

  </ol>

  <p>When a user agent is to <dfn>run pre-click activation steps</dfn> on an element, it must run
  the <dfn>pre-click activation steps</dfn> defined for that element, if any.</p>

  <p>When a user agent is to <dfn>run canceled activation steps</dfn> on an element, it must run the
  <dfn>canceled activation steps</dfn> defined for that element, if any.</p>

  <p>When a user agent is to <dfn>run post-click activation steps</dfn> on an element, it must run
  the <dfn>activation behavior</dfn> defined for that element, if any. Activation behaviors can
  refer to the <code data-x="event-click">click</code> event that was fired by the steps above
  leading up to this point.</p>

  </div>

<!--TOPIC:DOM APIs-->

  <!-- v2 idea: HTMLImageElement.click(x, y); or clickPoint(), if click() can't be done in IE; can
       this be emulated in IE by posting a synthetic mouse click event with those X and Y coords?
       (ack Csaba Gabor)
  -->

  <dl class="domintro">

   <dt><var>element</var> . <code subdfn data-x="dom-click">click</code>()</dt>

   <dd>

    <p>Acts as if the element was clicked.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-click">click()</code></dfn> method must run the following steps:</p>

  <ol>

   <li><p>If the element is a form control that is <span
   data-x="concept-fe-disabled">disabled</span>, abort these steps.</p></li>

   <li><p><span>Run synthetic click activation steps</span> on the element.</p></li>

  </ol>

  </div>


<!--TOPIC:HTML-->

  <h3 id="focus">Focus</h3>

  <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/?saved=2807 -->
  <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/?saved=2811 -->
  <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/?saved=2809 -->
  <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/?saved=2812 -->

  <!-- v2: more things to define, if no other specs define them:
   - define onfocus/onblur behavior for Window
   - Other things to look at are IE's focus APIs (HTMLElement.setActive(),
     onBeforeActivate, onActivate, onBeforeDeactivate, onDeactivate):
       https://bugzilla.mozilla.org/show_bug.cgi?id=296471
       https://bugzilla.mozilla.org/show_bug.cgi?id=296469
       http://msdn.microsoft.com/workshop/author/dhtml/reference/methods/setactive.asp
       http://msdn.microsoft.com/workshop/author/dhtml/reference/events/onbeforeactivate.asp
  -->

  <h4 id="introduction">Introduction</h4>

  <p><em>This section is non-normative.</em></p>

  <p>An HTML user interface typically consists of multiple interactive widgets, such as form
  controls, scrollable regions, links, dialog boxes, browser tabs, and so forth. These widgets form
  a hierarchy, with some (e.g. browser tabs, dialog boxes) containing others (e.g. links, form
  controls).</p>

  <p>When interacting with an interface using a keyboard, key input is channeled from the system,
  through the hierarchy of interactive widgets, to an active widget, which is said to be
  <span>focused</span>.</p>

  <div class="example">

   <p>Consider an HTML application running in a browser tab running in a graphical environment.
   Suppose this application had a page with some text fields and links, and was currently showing a
   modal dialog, which itself had a text field and a button.</p>

   <p>The hierarchy of focusable widgets, in this scenario, would include the browser window, which
   would have, amongst its children, the browser tab containing the HTML application. The tab itself
   would have as its children the various links and text fields, as well as the dialog. The dialog
   itself would have as its children the text field and the button.</p>

   <p><img src="images/focus-tree.png" alt="" width=800 height=450> <!-- purely decorative: it repeats the previous
   paragraph, in graphical form -->

   <p>If the widget with <span>focus</span> in this example was the text field in the dialog box, then key
   input would be channeled from the graphical system to &#x2460; the Web browser, then to &#x2461;
   the tab, then to &#x2462; the dialog, and finally to &#x2463; the text field.</p>

  </div>

  <p>Keyboard <em>events</em> are always targeted at this <span>focused</span> element.</p>


  <h4 id="data-model">Data model</h4>

  <p>The term <dfn>focusable area</dfn> is used to refer to regions of the interface that can become
  the target of keyboard input. Focusable areas can be elements, parts of elements, or other regions
  managed by the user agent.</p>

  <p>Each <span>focusable area</span> has a <dfn>DOM anchor</dfn>, which is a <code>Node</code> object
  that represents the position of the <span>focusable area</span> in the DOM. (When the <span>focusable
  area</span> is itself a <code>Node</code>, it is its own <span>DOM anchor</span>.) The <span>DOM anchor</span> is
  used in some APIs as a substitute for the <span>focusable area</span> when there is no other DOM object
  to represent the <span>focusable area</span>.</p>

  <p>The following table describes what objects can be <span data-x="focusable area">focusable
  areas</span>. The cells in the left column describe objects that can be <span data-x="focusable
  area">focusable areas</span>; the cells in the right column describe the <span data-x="DOM anchor">DOM
  anchors</span> for those elements. (The cells that span both columns are non-normative examples.)</p>

  <table id="table-fa">
   <thead>
    <tr>
     <th id="th-fa-area"><span>Focusable area</span>
     <th id="th-fa-dom-rep"><span>DOM anchor</span>
    <tr>
     <th id="th-fa-examples" colspan=2>Examples

   <tbody>
    <tr>
     <th class="data-header" headers="th-fa-area" id="td-fa-1">
     Elements that have their <span>tabindex focus flag</span> set, that are not <span
     data-x="concept-element-disabled">actually disabled</span>, that are not <span
     data-x="expressly inert control">expressly inert</span>, and that are either <span>being
     rendered</span> or <span>being used as relevant canvas fallback content</span>. <!--
     CANVAS-FOCUS-FALLBACK -->
     <td headers="td-fa-1 th-fa-dom-rep">
     The element itself.
    <tr>
     <td headers="td-fa-1 th-fa-examples" colspan=2>
     <p class="example"><code>iframe</code>, <code data-x="attr-input-type-text">&lt;input
     type=text></code>, sometimes <code data-x="a">&lt;a href=""></code> (depending on platform
     conventions).

   <tbody>
    <tr>
     <th class="data-header" headers="th-fa-area" id="td-fa-2">
     The shapes of <code>area</code> elements in an <span>image map</span> associated with an
     <code>img</code> element that is <span>being rendered</span> and is not <span data-x="expressly
     inert control">expressly inert</span>.
     <td headers="td-fa-2 th-fa-dom-rep">
     The <code>img</code> element.
    <tr>
     <td headers="td-fa-2 th-fa-examples" colspan=2>
     <div class="example">
      <p>In the following example, the <code>area</code> element creates two shapes, one on each
      image. The <span>DOM anchor</span> of the first shape is the first <code>img</code> element, and the
      <span>DOM anchor</span> of the second shape is the second <code>img</code> element.</p>
      <pre>&lt;map id=wallmap>&lt;area alt="Enter Door" coords="10,10,100,200" href="door.html">&lt;/map>
...
&lt;img src="images/innerwall.jpeg" alt="There is a white wall here, with a door." usemap="#wallmap">
...
&lt;img src="images/outerwall.jpeg" alt="There is a red wall here, with a door." usemap="#wallmap"></pre>
     </div>

   <tbody>
    <tr>
     <th class="data-header" headers="th-fa-area" id="td-fa-3">
     The user-agent provided subwidgets of elements that are <span>being rendered</span> and are not
     <span data-x="concept-element-disabled">actually disabled</span> or <span data-x="expressly
     inert control">expressly inert</span>.
     <td headers="td-fa-3 th-fa-dom-rep">
     The element for which the <span>focusable area</span> is a subwidget.
    <tr>
     <td headers="td-fa-3 th-fa-examples" colspan=2>
     <p class="example">The <span data-x="expose a user interface to the user">controls in the user
     interface that is exposed to the user</span> for a <code>video</code> element, the up and down
     buttons in a spin-control version of <code data-x="attr-input-type-number">&lt;input
     type=number></code>, the two range control widgets in a <code
     data-x="attr-input-type-range">&lt;input type=range multiple></code>, the part of a
     <code>details</code> element's rendering that enabled the element to be opened or closed using
     keyboard input.</p>

   <tbody>
    <tr>
     <th class="data-header" headers="th-fa-area" id="td-fa-4">
     The scrollable regions of elements that are <span>being rendered</span> and are not <span
     data-x="expressly inert control">expressly inert</span>. <!-- the being rendered part is kinda
     redundant, a scrollable region is a box generated for the element so by definition if the
     element has a scrollable region it is being rendered -->
     <td headers="td-fa-4 th-fa-dom-rep">
     The element for which the box that the scrollable region scrolls was created.
    <tr>
     <td headers="td-fa-4 th-fa-examples" colspan=2>
     <p class="example">The CSS 'overflow' property's 'scroll' value typically creates a scrollable
     region.</p>

   <tbody>
    <tr>
     <th class="data-header" headers="th-fa-area" id="td-fa-5">
     The viewport of a <code>Document</code> that is in a <span>browsing context</span> and is not
     <span>inert</span>.
     <td headers="td-fa-5 th-fa-dom-rep">
     The <code>Document</code> for which the viewport was created.
    <tr>
     <td headers="td-fa-5 th-fa-examples" colspan=2>
     <p class="example">The contents of an <code>iframe</code>.</p>

   <tbody>
    <tr>
     <th class="data-header" headers="th-fa-area" id="td-fa-6">
     Any other element or part of an element, especially to aid with accessibility or to better
     match platform conventions.
     <td headers="td-fa-6 th-fa-dom-rep">
     The element.
    <tr>
     <td headers="td-fa-6 th-fa-examples" colspan=2>
     <p class="example">A user agent could make all list item bullets focusable, so that a user can
     more easily navigate lists.</p>
     <p class="example">Similarly, a user agent could make all elements with <code
     data-x="attr-title">title</code> attributes focusable, so that their advisory information can
     be accessed.</p>

  </table>

  <p id="bc-focus-ergo-bcc-focus" class="note">A <span>browsing context container</span> (e.g. an
  <code>iframe</code>) is a <span>focusable area</span>, but key events routed to a <span>browsing context
  container</span> get immediately routed to the <span>nested browsing context</span>'s <span>active
  document</span>. Similarly, in sequential focus navigation a <span>browsing context
  container</span> essentially acts merely as a placeholder for its <span>nested browsing
  context</span>'s <span>active document</span>.</p>

  <p>Each <span>focusable area</span> belongs to a <dfn>control group</dfn>. Each <span>control group</span> has
  an <dfn data-x="control group owner">owner</dfn>. <span data-x="control group owner">Control group
  owners</span> are <dfn data-x="control group owner object">control group owner objects</dfn>. The
  following are <span data-x="control group owner object">control group owner objects</span>:</p>

  <ul class="brief">

   <li><code>Document</code> object in <span data-x="browsing context">browsing contexts</span>.</li>

   <li><code>dialog</code> elements that have an <code data-x="attr-dialog-open">open</code>
   attribute specified and that are <span>being rendered</span>.</li>

  </ul>

  <p>Each <span>control group owner object</span> owns one <span>control group</span> (though that
  group might be empty).</p>

  <p>If the <span>DOM anchor</span> of a <span>focusable area</span> is a <span>control group owner
  object</span>, then that <span>focusable area</span> belongs to that <span>control group owner
  object</span>'s <span>control group</span>. Otherwise, the <span>focusable area</span> belongs to its
  <span>DOM anchor</span>'s nearest ancestor <span>control group owner object</span>.</p>

  <div class="example">

   <p>Thus, a viewport always belongs to the <span>control group</span> of the <code>Document</code>
   for which the viewport was created, an <code>input</code> control belongs to the <span>control
   group</span> of its nearest ancestor <code>dialog</code> or <code>Document</code>, and an image
   map's shapes belong to the nearest ancestor <code>dialog</code> or <code>Document</code> of the
   <code>img</code> elements (not the <code>area</code> elements &mdash; this means one
   <code>area</code> element might create multiple shapes in different <span data-x="control
   group">control groups</span>).</p>

  </div>

  <p>An element is <dfn data-x="expressly inert control">expressly inert</dfn> if it is
  <span>inert</span> but it is not a <span>control group owner object</span> and its nearest
  ancestor <span>control group owner object</span> is not <span>inert</span>.</p>

  <p>One <span>focusable area</span> in each non-empty <span>control group</span> is designated the
  <dfn>focused area of the control group</dfn>. Which control is so designated changes over time,
  based on algorithms in this specification. If a <span>control group</span> is empty, it has no <span
  data-x="focused area of the control group">focused area</span>.</p>

  <p>Each <span>control group owner object</span> can also act as the <dfn data-x="dialog group
  manager">manager</dfn> of a <dfn>dialog group</dfn>.</p>

  <p>Each <code>dialog</code> element that has an <code data-x="attr-dialog-open">open</code>
  attribute specified and that is <span>being rendered</span> (i.e. that is a <span>control group
  owner object</span>) and is not <span data-x="expressly inert dialog">expressly inert</span>
  belongs to the <span>dialog group</span> whose <span data-x="dialog group manager">manager</span> is
  the <code>dialog</code> element's nearest ancestor <span>control group owner object</span>.</p>

  <p>A <code>dialog</code> is <dfn data-x="expressly inert dialog">expressly inert</dfn> if it is
  <span>inert</span> but its nearest ancestor <span>control group owner object</span> is not.</p>

  <p>If no <code>dialog</code> element has a particular <span>control group owner object</span> as
  its nearest ancestor <span>control group owner object</span>, then that <span>control group owner
  object</span> has no <span>dialog group</span>.</p>

  <p>Each <span>dialog group</span> can have a <code>dialog</code> designated as the <dfn>focused
  dialog of the dialog group</dfn>. Which <code>dialog</code> is so designated changes over time,
  based on algorithms in this specification.</p>

  <hr>

  <p><span data-x="focusable area">Focusable areas</span> in <span data-x="control group">control groups</span>
  are ordered relative to the <span>tree order</span> of their <span data-x="DOM anchor">DOM
  anchors</span>. <span data-x="focusable area">Focusable areas</span> with the same <span>DOM anchor</span> in a
  <span>control group</span> are ordered relative to their CSS box's relative positions in a pre-order,
  depth-first traversal of the box tree. <a href="#refsCSS">\[CSS]</a></p>

  <p>Elements in <span data-x="dialog group">dialog groups</span> are ordered in <span>tree
  order</span>.</p>

  <hr>

  <p>The <dfn>currently focused area of a top-level browsing context</dfn> at any particular time is
  the <span>focusable area</span> or <code>dialog</code> returned by this algorithm:</p>

  <ol>

   <li><p>Let <var>candidate</var> be the <code>Document</code> of the <span>top-level
   browsing context</span>.</p></li>

   <li>

    <p>If <var>candidate</var> has a <span>dialog group</span> with a designated
    <span>focused dialog of the dialog group</span>, then let <var>candidate</var> be the
    designated <span>focused dialog of the dialog group</span>, and redo this step.</p>

    <p>Otherwise, if <var>candidate</var> has a non-empty <span>control group</span>, and the
    designated <span>focused area of the control group</span> is a <span>browsing context
    container</span>, then let <var>candidate</var> be the <span>active document</span> of
    that <span>browsing context container</span>'s <span>nested browsing context</span>, and redo
    this step.</p>

    <p>Otherwise, if <var>candidate</var> has a non-empty <span>control group</span>, let
    <var>candidate</var> be the designated <span>focused area of the control
    group</span>.</p>

   </li>

   <li><p>Return <var>candidate</var>.</p></li>

  </ol>

  <p>An element that is the <span>DOM anchor</span> of a <span>focusable area</span> is said to <dfn
  data-x="gains focus">gain focus</dfn> when that <span>focusable area</span> becomes the <span>currently
  focused area of a top-level browsing context</span>. When an element is the <span>DOM anchor</span> of a
  <span>focusable area</span> of the <span>currently focused area of a top-level browsing context</span>,
  it is <dfn>focused</dfn>.</p>

  <div class="impl">

  <p>The <dfn>focus chain</dfn> of a <span>focusable area</span> or <span>control group owner
  object</span> <var>subject</var> is the ordered list constructed as follows:</p>

  <ol>

   <li><p>Let <var>current object</var> be <var>subject</var>.</p></li>

   <li><p>Let <var>output</var> be an empty list.</p></li>

   <li><p><i>Loop</i>: Append <var>current object</var> to <var>output</var>.</p></li>

   <li>

    <p>If <var>current object</var> is an <code>area</code> element's shape, append
    that <code>area</code> element to <var>output</var>.</p>

    <p>Otherwise, if <var>current object</var> is a <span>focusable area</span> whose <span>DOM
    anchor</span> is an element that is not <var>current object</var> itself, append that
    <span>DOM anchor</span> element to <var>output</var>.</p>

   </li>

   <li>

    <p>If <var>current object</var> is a <code>dialog</code> object in a <span>dialog group</span>,
    let <var>current object</var> be that <span>dialog group</span>'s <span data-x="dialog group
    manager">manager</span>, and return to the step labeled <i>loop</i>.</p>

    <p>Otherwise, if <var>current object</var> is a <span>focusable area</span>, let <var>current
    object</var> be that <span>focusable area</span>'s <span>control group</span>'s <span
    data-x="control group owner">owner</span>, and return to the step labeled <i>loop</i>.</p>

    <p>Otherwise, if <var>current object</var> is a <code>Document</code> in a <span>nested browsing
    context</span>, let <var>current object</var> be its <span>browsing context container</span>,
    and return to the step labeled <i>loop</i>.</p>

   </li>

   <li>

    <p>Return <var>output</var>.</p>

    <p class="note">The chain starts with <var>subject</var> and (if <var>subject</var> is or can be the <span>currently focused area of a top-level browsing
    context</span>) continues up the focus hierarchy up to the <code>Document</code> of the
    <span>top-level browsing context</span>.</p>

   </li>

  </ol>

  </div>


  <h4>The <code data-x="attr-tabindex">tabindex</code> attribute</h4>

  <p>The <dfn><code data-x="attr-tabindex">tabindex</code></dfn> content attribute allows authors to
  indicate that an element is supposed to be <span data-x="focusable area">focusable</span>, and
  whether it is supposed to be reachable using <span>sequential focus navigation</span> and, if so,
  what is to be the relative order of the element for the purposes of sequential focus navigation.
  The name "tab index" comes from the common use of the "tab" key to navigate through the focusable
  elements. The term "tabbing" refers to moving forward through the focusable elements that can be
  reached using sequential focus navigation.</p>

  <p>When the attribute is omitted, the user agent applies defaults. (There is no way to make an
  element that is <span>being rendered</span> be not focusable at all without <span
  data-x="concept-element-disabled">disabling</span> it or making it <span>inert</span>.)</p>

  <p>The <code data-x="attr-tabindex">tabindex</code> attribute, if specified, must have a value
  that is a <span>valid integer</span>. Positive numbers specify the relative position of the
  element's <span data-x="focusable area">focusable areas</span> in the <span>sequential focus
  navigation order</span>, and negative numbers indicate that the control is to be unreachable by
  <span>sequential focus navigation</span>.</p>

  <div class="impl">

  <p>Each element can have a <dfn id="specially-focusable">tabindex focus flag</dfn> set, as defined
  below. This flag is a factor that contributes towards determining whether an element is a
  <span>focusable area</span>, as described in the previous section.</p>

  <p>If the <code data-x="attr-tabindex">tabindex</code> attribute is specified on an element, it
  must be parsed using the <span>rules for parsing integers</span>. The attribute's values, or lack
  thereof, must be interpreted as follows:</p>

  <dl>

   <dt>If the attribute is omitted or parsing the value returns an error</dt>

   <dd>

    <p>The user agent should follow platform conventions to determine if the element's
    <span>tabindex focus flag</span> is set and, if so, whether the element and any <span
    data-x="focusable area">focusable areas</span> that have the element as their <span>DOM anchor</span> can
    be reached using <span>sequential focus navigation</span>, and if so, what their relative
    position in the <span>sequential focus navigation order</span> is to be.</p>

    <p>Modulo platform conventions, it is suggested that for the following elements, the
    <span>tabindex focus flag</span> be set:</p>

    <ul>

     <li><code>a</code> elements that have an <code data-x="attr-hyperlink-href">href</code>
     attribute</li>

     <li><code>link</code> elements that have an <code
     data-x="attr-link-href">href</code> attribute</li>

     <li><code>button</code> elements</li>

     <li><code>input</code> elements whose <code data-x="attr-input-type">type</code> attribute are
     not in the <span data-x="attr-input-type-hidden">Hidden</span> state</li>

     <li><code>select</code> elements</li>

     <li><code>textarea</code> elements</li>

     <li><code>menuitem</code> elements</li>

     <li>Elements with a <code data-x="attr-draggable">draggable</code> attribute set, if that would
     enable the user agent to allow the user to begin a drag operations for those elements without
     the use of a pointing device</li>

     <li><span data-x="editing host">Editing hosts</span></li>

     <li><span data-x="browsing context container">Browsing context containers</span></li> <!-- like
     <iframe>s -->

     <li><span data-x="sorting interface th element">Sorting interface <code>th</code>
     elements</span></li>

    </ul>

    <p class="note">One valid reason to ignore the platform conventions and always allow an element
    to be focused (by setting its <span>tabindex focus flag</span>) would be if the user's only
    mechanism for activating an element is through a keyboard action that triggers the focused
    element.</p>

   </dd>

   <dt id="negative-tabindex">If the value is a negative integer</dt>

   <dd>

    <p>The user agent must set the element's <span>tabindex focus flag</span>, but should omit the
    element from the <span>sequential focus navigation order</span>.</p>

    <p class="note">One valid reason to ignore the requirement that sequential focus navigation not
    allow the author to lead to the element would be if the user's only mechanism for moving the
    focus is sequential focus navigation. For instance, a keyboard-only user would be unable to
    click on a text field with a negative <code data-x="attr-tabindex">tabindex</code>, so that
    user's user agent would be well justified in allowing the user to tab to the control
    regardless.</p>

   </dd>

   <dt>If the value is a zero</dt>

   <dd>

    <p>The user agent must set the element's <span>tabindex focus flag</span>, should allow the
    element and any <span data-x="focusable area">focusable areas</span> that have the element as their
    <span>DOM anchor</span> to be reached using <span>sequential focus navigation</span>, following
    platform conventions to determine the element's relative position in the <span>sequential focus
    navigation order</span>.</p>

   </dd>

   <dt>If the value is greater than zero</dt>

   <dd>

    <p>The user agent must set the element's <span>tabindex focus flag</span>, should allow the
    element and any <span data-x="focusable area">focusable areas</span> that have the element as their
    <span>DOM anchor</span> to be reached using sequential focus navigation, and should place the element
    &mdash; referenced as <var>candidate</var> below &mdash; and the aforementioned <span
    data-x="focusable area">focusable areas</span> in the <span>sequential focus navigation</span>
    order so that, relative to other <span data-x="focusable area">focusable areas</span> in the
    <span>sequential focus navigation order</span>, they are:</p>

    <ul>

     <li>before any <span>focusable area</span> whose <span>DOM anchor</span> is an element whose <code
     data-x="attr-tabindex">tabindex</code> attribute has been omitted or whose value, when parsed,
     returns an error,</li>

     <li>before any <span>focusable area</span> whose <span>DOM anchor</span> is an element whose <code
     data-x="attr-tabindex">tabindex</code> attribute has a value equal to or less than zero,</li>

     <li>after any <span>focusable area</span> whose <span>DOM anchor</span> is an element whose <code
     data-x="attr-tabindex">tabindex</code> attribute has a value greater than zero but less than
     the value of the <code data-x="attr-tabindex">tabindex</code> attribute on <var>candidate</var>,</li>

     <li>after any <span>focusable area</span> whose <span>DOM anchor</span> is an element whose <code
     data-x="attr-tabindex">tabindex</code> attribute has a value equal to the value of the <code
     data-x="attr-tabindex">tabindex</code> attribute on <var>candidate</var> but that is
     earlier in the document in <span>tree order</span> than <var>candidate</var>,</li>

     <li>before any <span>focusable area</span> whose <span>DOM anchor</span> is an element whose <code
     data-x="attr-tabindex">tabindex</code> attribute has a value equal to the value of the <code
     data-x="attr-tabindex">tabindex</code> attribute on <var>candidate</var> but that is
     later in the document in <span>tree order</span> than <var>candidate</var>, and</li>

     <li>before any <span>focusable area</span> whose <span>DOM anchor</span> is an element whose <code
     data-x="attr-tabindex">tabindex</code> attribute has a value greater than the value of the
     <code data-x="attr-tabindex">tabindex</code> attribute on <var>candidate</var>.</li>

    </ul>

   </dd>

  </dl>

  <p>An element that has its <span>tabindex focus flag</span> set but does not otherwise have an
  <span>activation behavior</span> defined has an <span>activation behavior</span> that does
  nothing.</p>

  <p class="note">This means that an element that is only focusable because of its <code
  data-x="attr-tabindex">tabindex</code> attribute will fire a <code
  data-x="event-click">click</code> event in response to a non-mouse activation (e.g. hitting the
  "enter" key while the element is <span>focused</span>).</p>

  <p>An element with the <code data-x="attr-tabindex">tabindex</code> attribute specified is
  <span>interactive content</span>.</p>

  <p>The <dfn><code data-x="dom-tabIndex">tabIndex</code></dfn> IDL attribute must
  <span>reflect</span> the value of the <code data-x="attr-tabindex">tabindex</code> content
  attribute. Its default value is 0 for elements that are focusable and &#x2212;1 for elements that
  are not focusable.</p>

  </div>


  <div class="impl">

  <h4 id="processing-model">Processing model</h4>

  <p>The <dfn>focusing steps</dfn> for an object <var>new focus target</var> that is
  either a <span>focusable area</span>, or an element that is not a <span>focusable area</span>, or a
  <span>browsing context</span>, are as follows. They can optionally be run with a <i>fallback target</i>.</p>

  <ol>

   <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/saved/2816 div.focus() when it's got a scroll region -->
   <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/saved/2817 img.focus() when it's got an image map -->

   <li>

    <p>If <var>new focus target</var> is neither a <code>dialog</code> element that has an
    <code data-x="attr-dialog-open">open</code> attribute specified and that is <span>being
    rendered</span> (i.e. that is a <span>control group owner object</span>), nor a <span>focusable
    area</span>, then run the first matching set of steps from the following list:</p>

    <dl class="switch">

     <dt>If <var>new focus target</var> is an <code>area</code> element with one or more
     shapes that are <span data-x="focusable area">focusable areas</span></dt>

     <dd>

      <p>Let <var>new focus target</var> be the shape corresponding to the first
      <code>img</code> element in <span>tree order</span> that uses the image map to which the <code>area</code>
      element belongs.</p>

     </dd>


     <dt>If <var>new focus target</var> is an element with one or more scrollable regions
     that are <span data-x="focusable area">focusable areas</span></dt>

     <dd>

      <p>Let <var>new focus target</var> be the element's first scrollable region,
      according to a pre-order, depth-first traversal of the box tree. <a href="#refsCSS">\[CSS]</a></p>

     </dd>


     <dt>If <var>new focus target</var> is the <span>root element</span> of its
     <code>Document</code></dt>

     <dd>

      <p>Let <var>new focus target</var> be the <code>Document</code>'s viewport.</p>

     </dd>


     <dt>If <var>new focus target</var> is a <span>browsing context</span></dt>

     <dd>

      <p>Let <var>new focus target</var> be the <span>browsing context</span>'s
      <span>active document</span>.</p>

     </dd>


     <dt>If <var>new focus target</var> is a <span>browsing context container</span></dt>

     <dd>

      <p>Let <var>new focus target</var> be the <span>browsing context container</span>'s <span>nested browsing context</span>'s
      <span>active document</span>.</p>

     </dd>


     <dt>Otherwise</dt>

     <dd>

      <p>If no <i>fallback target</i> was specified, abort the <span>focusing steps</span>.</p>

      <p>Otherwise, let <var>new focus target</var> be the <i>fallback target</i>.</p>

     </dd>

    </dl>

   </li>

   <li>

    <p>If <var>new focus target</var> is a <span>control group owner object</span> that is
    not a <span>focusable area</span>, but does have a <span>dialog group</span>, and that <span>dialog group</span>
    has a designated <span data-x="focused dialog of the dialog group">focused dialog</span>, then
    let <var>new focus target</var> be the <span>focused dialog of the dialog
    group</span>, and redo this step.</p>

    <p>Otherwise, if <var>new focus target</var> is a <span>control group owner
    object</span> that is not a <span>focusable area</span>, and its <span>control group</span> is not empty,
    then designate <var>new focus target</var> as the <span>focused area of the control
    group</span>, and redo this step.</p>

    <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/?saved=2818 -->
    <p>Otherwise, if <var>new focus target</var> is a <span>browsing context
    container</span>, then let <var>new focus target</var> be the <span>nested browsing
    context</span>'s <span>active document</span>, and redo this step.</p>

    <p class="note">A <code>dialog</code> element can be both a <span>control group owner
    object</span> and a <span>focusable area</span>, if it has both an <code
    data-x="attr-dialog-open">open</code> attribute specified and a <code
    data-x="attr-tabindex">tabindex</code> attribute specified and is <span>being
    rendered</span>.</p>

   </li>

   <li><p>If <var>new focus target</var> is a <span>focusable area</span> and its <span>DOM
   anchor</span> is <span>inert</span>, then abort these steps.</p></li>

   <li><p>If <var>new focus target</var> is the <span>currently focused area of a
   top-level browsing context</span>, then abort these steps.</p></li>

   <li><p>Let <var>old chain</var> be the <span>focus chain</span> of the <span
   data-x="currently focused area of a top-level browsing context">currently focused area of the
   top-level browsing context</span> in which <var>new focus target</var> finds
   itself.</p></li>

   <li><p>Let <var>new chain</var> be the <span>focus chain</span> of <var>new
   focus target</var>.</p></li>

   <li><p>Run the <span>focus update steps</span> with <var>old chain</var>, <var>new chain</var>, and <var>new focus target</var> respectively.</p></li>

  </ol>

  <p>User agents must <span>immediately</span> run the <span>focusing steps</span> for a <span>focusable area</span>,
  <code>dialog</code>, or <span>browsing context</span> <var>candidate</var> whenever the
  user attempts to move the focus to <var>candidate</var>.</p>

  <p>The <dfn>unfocusing steps</dfn> for an object <var>old focus target</var> that is
  either a <span>focusable area</span> or an element that is not a <span>focusable area</span> are as
  follows:</p>

  <ol>

   <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/saved/2819 -->
   <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/saved/2822 -->

   <li><p>If <var>old focus target</var> is <span>inert</span>, then abort these
   steps.</p></li>

   <li>

    <p>If <var>old focus target</var> is an <code>area</code> element and one of its shapes is the
    <span>currently focused area of a top-level browsing context</span>, or, if <var>old focus
    target</var> is an element with one or more scrollable regions, and one of them is the
    <span>currently focused area of a top-level browsing context</span>, then let <var>old focus
    target</var> be that <span>currently focused area of a top-level browsing context</span>.</p>

   </li>

   <li><p>Let <var>old chain</var> be the <span>focus chain</span> of the <span>currently
   focused area of a top-level browsing context</span>.</p></li>

   <li><p>If <var>old focus target</var> is not one of the entries in <var>old
   chain</var>, then abort these steps.</p></li>

   <li>

    <p>If <var>old focus target</var> is a <code>dialog</code> in a <span>dialog group</span>, and
    the <span>dialog group manager</span> has a non-empty <span>control group</span>, then let
    <var>new focus target</var> be the designated <span data-x="focused area of the control
    group">focused area of that focus group</span>.</p>

    <p>Otherwise, if <var>old focus target</var> is a <span>focusable area</span>, then let <var>new
    focus target</var> be the first <span>focusable area</span> of its <span>control group</span>
    (if the <span>control group owner</span> is a <code>Document</code>, this will always be a
    viewport).</p>

    <p>Otherwise, let <var>new focus target</var> be null.</p>

   </li>

   <li><p>If <var>new focus target</var> is not null, then run the <span>focusing
   steps</span> for <var>new focus target</var>.</p></li>

  </ol>

  <p>When the <span>currently focused area of a top-level browsing context</span> is somehow
  unfocused without another element being explicitly focused in its stead, the user agent must
  <span>immediately</span> run the <span>unfocusing steps</span> for that object.</p>

  <p class="note">The <span>unfocusing steps</span> do not always result in the focus changing, even
  when applied to the <span>currently focused area of a top-level browsing context</span>. For
  example, if the <span>currently focused area of a top-level browsing context</span> is a viewport,
  then it will usually keep its focus regardless until another <span>focusable area</span> is explicitly
  focused with the <span>focusing steps</span>.</p>

  <hr>

  <p>When a <span>focusable area</span> is added to an empty <span>control group</span>, it must be designated
  the <span>focused area of the control group</span>.</p>

  <p>When a <span>dialog group</span> is formed, if the <span>dialog group manager</span> has an empty
  <span>control group</span>, the first non-<span>inert</span> <code>dialog</code> in the <span>dialog
  group</span>, if any, or else the first <code>dialog</code> in the <span>dialog group</span> regardless of
  <span data-x="inert">inertness</span>, must be designated the <span>focused dialog of the dialog
  group</span>.</p>

  <p><dfn>Focus fixup rule one</dfn>: When the designated <span data-x="focused area of the control
  group">focused area of a control group</span> is removed from that <span>control group</span> in
  some way (e.g. it stops being a <span>focusable area</span>, it is removed from the DOM, it
  becomes <span data-x="expressly inert control">expressly inert</span>, etc), and the <span>control
  group</span> is still not empty: designate the first non-<span>inert</span> <span data-x="focused
  area of the control group">focused area</span> in that <span>control group</span> to be the new
  <span>focused area of the control group</span>, if any; if they are all <span>inert</span>, then
  designate the first <span data-x="focused area of the control group">focused area</span> in that
  <span>control group</span> to be the new <span>focused area of the control group</span> regardless
  of <span data-x="inert">inertness</span>. If such a removal instead results in the <span>control
  group</span> being empty, then there is simply no longer a <span>focused area of the control
  group</span>.</p>

  <p class="example">For example, this might happen because an element is removed from its
  <code>Document</code>, or has a <code data-x="attr-hidden">hidden</code> attribute added. It might
  also happen to an <code>input</code> element when the element gets <span
  data-x="concept-fe-disabled">disabled</span>.</p>

  <p><dfn>Focus fixup rule two</dfn>: When a <span>dialog group</span> has no designed <span>focused
  dialog of the dialog group</span>, and its <span>dialog group manager</span>'s <span>control
  group</span> changes from being non-empty to being empty, the first non-<span>inert</span>
  <code>dialog</code> in the <span>dialog group</span>, if any, or else the first <code>dialog</code> in
  the <span>dialog group</span> regardless of <span data-x="inert">inertness</span>, must be designated
  the <span>focused dialog of the dialog group</span>.</p>

  <p><dfn>Focus fixup rule three</dfn>: When the designated <span data-x="focused dialog of the
  dialog group">focused dialog of a dialog group</span> is removed from that <span>dialog group</span> in
  some way (e.g. it stops <span>being rendered</span>, it loses its <code
  data-x="attr-dialog-open">open</code> attribute, it becomes <span data-x="expressly inert
  dialog">expressly inert</span>, etc), and there is still a <span>dialog group</span> (because the
  <code>dialog</code> in question was not the last <code>dialog</code> in that <span>dialog group</span>):
  if the <span>dialog group</span>'s <span data-x="dialog group manager">manager</span>'s <span>control
  group</span> is non-empty, let there be no designated <span>focused dialog of the dialog group</span>
  any more; otherwise (in the case that the <span>control group</span> is empty), designate the first
  non-<span>inert</span> <code>dialog</code> in the <span>dialog group</span> to be the <span>focused
  dialog of the dialog group</span>, or, if they are all <span>inert</span>, designate the first
  <code>dialog</code> in the <span>dialog group</span> to be the <span>focused dialog of the dialog
  group</span> regardless of <span data-x="inert">inertness</span>.</p>

  <p>When the <span>currently focused area of a top-level browsing context</span> was a <span>focusable
  area</span> but stops being a <span>focusable area</span>, or when it was a <code>dialog</code> in a
  <span>dialog group</span> and stops being part of that <span>dialog group</span>, or when it
  starts being <span>inert</span>, the user agent must run the following steps:</p>

  <ol> <!-- this is basically a special-cased version of the focusing steps -->

   <li><p>Let <var>old focus target</var> be whatever the <span data-x="currently focused
   area of a top-level browsing context">currently focused area of the top-level browsing
   context</span> was immediately before this algorithm became applicable (e.g. before the element
   was disabled, or the dialog was closed, or whatever caused this algorithm to run).</p></li>

   <li><p>Let <var>old chain</var> be the <span>focus chain</span> of the <span
   data-x="currently focused area of a top-level browsing context">currently focused area of the
   top-level browsing context</span> at the same time.</p></li>

   <li><p>Make sure that the changes implied by the focus fixup rules <span data-x="focus fixup rule
   one">one</span>, <span data-x="focus fixup rule two">two</span>, and <span data-x="focus fixup
   rule three">three</span> above are applied.</p></li>

   <li><p>Let <var>new focus target</var> be the <span>currently focused area of a
   top-level browsing context</span>.</p></li>

   <li><p>If <var>old focus target</var> and <var>new focus target</var> are the
   same, abort these steps.</p></li>

   <li><p>Let <var>new chain</var> be the <span>focus chain</span> of <var>new
   focus target</var>.</p></li>

   <li><p>Run the <span>focus update steps</span> with <var>old chain</var>, <var>new chain</var>, and <var>new focus target</var> respectively.</p></li>

  </ol>

  <hr>

  <p>The <dfn>focus update steps</dfn>, given an <var>old chain</var>, a <var>new chain</var>, and a <var>new focus target</var> respectively, are as
  follows:</p>

  <ol>

   <!-- focusin/focusout?: http://software.hixie.ch/utilities/js/live-dom-viewer/saved/723 -->

   <li><p>Unset the <span>sequential focus navigation starting point</span>.</p></li>

   <li><p>If the last entry in <var>old chain</var> and the last entry in <var>new chain</var> are the same, pop the last entry from <var>old chain</var>
   and the last entry from <var>new chain</var> and redo this step.</p></li>

   <li>

    <p>For each entry <var>entry</var> in <var>old chain</var>, in order, run
    these substeps:</p>

    <ol>

     <li id="unfocus-causes-change-event"><p>If <var>entry</var> is an <code>input</code>
     element, and the <code data-x="event-input-change">change</code> event <span
     data-x="concept-input-apply">applies</span> to the element, and the element does not have a
     defined <span>activation behavior</span>, and the user has changed the element's <span
     data-x="concept-fe-value">value</span> or its list of <span
     data-x="concept-input-type-file-selected">selected files</span> while the control was focused
     without committing that change, then <span>fire a simple event</span> that bubbles named <code
     data-x="event-change">change</code> at the element.</p>

     <li>

      <p>If <var>entry</var> is an element, let <var>blur event target</var> be
      <var>entry</var>.</p>

      <p>If <var>entry</var> is a <code>Document</code> object, let <var>blur
      event target</var> be that <code>Document</code> object's <code>Window</code> object.</p>

      <p>Otherwise, let <var>blur event target</var> be null.</p>

     </li>

     <li><p>If <var>entry</var> is the last entry in <var>old chain</var>, and
     <var>entry</var> is an <code>Element</code>, and the last entry in <var>new
     chain</var> is also an <code>Element</code>, then let <var>related blur target</var>
     be the last entry in <var>new chain</var>. Otherwise, let <var>related blur
     target</var> be null.</p></li>

     <li>

      <p>If <var>blur event target</var> is not null, <span>fire a focus event</span>
      named <code data-x="event-blur">blur</code> at <var>blur event target</var>, with
      <var>related blur target</var> as the related target.</p>

      <p class="note">In some cases, e.g. if <var>entry</var> is an <code>area</code>
      element's shape, a scrollable region, or a viewport, no event is fired.</p>

     </li>

    </ol>

   </li>

   <li><p>Apply any relevant platform-specific conventions for focusing <var>new focus
   target</var>. (For example, some platforms select the contents of a text field when that field is
   focused.)</p></li>

   <li>

    <p>For each entry <var>entry</var> in <var>new chain</var>, in reverse
    order, run these substeps:</p>

    <ol>

     <li><p>If <var>entry</var> is a <code>dialog</code> element: Let <var>entry</var> be the designated <span data-x="focused dialog of the dialog
     group">focused dialog of its dialog group</span>.</p></li>

     <li>

      <p>If <var>entry</var> is a <span>focusable area</span>: Designate <var>entry</var> as the <span>focused area of the control group</span>. If its <span>control
      group</span>'s <span data-x="control group owner">owner</span> is also a <span>dialog group
      manager</span>, then let there be no designated <span data-x="focused dialog of the dialog
      group">focused dialog</span> in that <span>dialog group</span>.</p>

      <p class="note">It is possible for <var>entry</var> to be both a <code>dialog</code>
      element and a <span>focusable area</span>, in which case it is its own <span>control group
      owner</span>.</p>

     </li>

     <li>

      <p>If <var>entry</var> is an element, let <var>focus event target</var> be
      <var>entry</var>.</p>

      <p>If <var>entry</var> is a <code>Document</code> object, let <var>focus
      event target</var> be that <code>Document</code> object's <code>Window</code> object.</p>

      <p>Otherwise, let <var>focus event target</var> be null.</p>

     </li>

     <li><p>If <var>entry</var> is the last entry in <var>new chain</var>, and
     <var>entry</var> is an <code>Element</code>, and the last entry in <var>old
     chain</var> is also an <code>Element</code>, then let <var>related focus target</var>
     be the last entry in <var>old chain</var>. Otherwise, let <var>related
     focus target</var> be null.</p></li>

     <li>

      <p>If <var>focus event target</var> is not null, <span>fire a focus event</span>
      named <code data-x="event-focus">focus</code> at <var>focus event target</var>, with
      <var>related focus target</var> as the related target.</p>

      <p class="note">In some cases, e.g. if <var>entry</var> is an <code>area</code>
      element's shape, a scrollable region, or a viewport, no event is fired.</p>

     </li>

    </ol>

   </li>

  </ol>

  <p>When a user agent is required to <dfn>fire a focus event</dfn> named <var>e</var> at
  an element <var>t</var> and with a given related target <var>r</var>, the user
  agent must create a <span data-x="concept-events-trusted">trusted</span> <code>FocusEvent</code>
  object, initialize it to have the given name <var>e</var>, to not bubble, to not be
  cancelable, and to have the <code data-x="dom-FocusEvent-relatedTarget">relatedTarget</code>
  attribute initialized to <var>r</var>, the <code
  data-x="dom-UIEvent-view">view</code> attribute initialized to the <code>Window</code> object of the <code>Document</code> object of <var>t</var>, and the <code
  data-x="dom-UIEvent-detail">detail</code> attribute initialized to 0, and must then <span
  data-x="concept-event-dispatch">dispatch</span> the newly created <code>FocusEvent</code> object
  at the specified target element <var>t</var>.</p>

  <hr>

  <p>When a key event is to be routed in a <span>top-level browsing context</span>, the user agent
  must run the following steps:</p>

  <ol>

   <li><p>Let <var>target area</var> be the <span data-x="currently focused area of a
   top-level browsing context">currently focused area of the top-level browsing
   context</span>.</p></li>

   <li><p>If <var>target area</var> is a <span>focusable area</span>, let <var>target
   node</var> be <var>target area</var>'s <span>DOM anchor</span>. Otherwise, <var>target area</var> is a <code>dialog</code>; let <var>target node</var> be
   <var>target area</var>.</p></li>

   <li>

    <p>If <var>target node</var> is a <code>Document</code> that has a <span data-x="the
    body element">body element</span>, then let <var>target node</var> be <span>the body
    element</span> of that <code>Document</code>.</p>

    <p>Otherwise, if <var>target node</var> is a <code>Document</code> that has a
    <span>root element</span>, then let <var>target node</var> be the <span>root
    element</span> of that <code>Document</code>.</p>

   </li>

   <li>

    <p>If <var>target node</var> is not <span>inert</span>, fire the event at <var>target node</var>.</p>

    <p class="note">It is possible for the <span>currently focused area of a top-level browsing
    context</span> to be <span>inert</span>, for example if a <span
    data-x="dom-dialog-showModal">modal dialog is shown</span>, and then that <code>dialog</code>
    element is made <span>inert</span>. It is likely to be the result of a logic error in the
    application, though.</p>

   </li>

   <li><p>If the event was not canceled, then let <var>target area</var> handle the key
   event. This might include <span data-x="run synthetic click activation steps">running synthetic
   click activation steps</span> for <var>target node</var>.</p></li>

  </ol>

  <hr>

  <p>The <dfn>has focus steps</dfn>, given a <code>Document</code> object <var>target</var>, are
  as follows:</p>

  <ol>

   <li><p>Let <var>candidate</var> be the <code>Document</code> of the <span>top-level browsing
   context</span>.</p></li>

   <li><p>If <var>candidate</var> is <var>target</var>, return true and abort these steps.</p></li>

   <li>

    <p>If <var>candidate</var> has a <span>dialog group</span> with a designated <span>focused
    dialog of the dialog group</span>, then let <var>candidate</var> be the designated
    <span>focused dialog of the dialog group</span>, and redo this step.</p>

    <p>Otherwise, if <var>candidate</var> has a non-empty <span>control group</span>, and the
    designated <span>focused area of the control group</span> is a <span>browsing context
    container</span>, and the <span>active document</span> of that <span>browsing context
    container</span>'s <span>nested browsing context</span> is <var>target</var>, then
    return true and abort these steps.</p>

    <p>Otherwise, if <var>candidate</var> has a non-empty <span>control group</span>, and the
    designated <span>focused area of the control group</span> is a <span>browsing context
    container</span>, then let <var>candidate</var> be the <span>active document</span> of
    that <span>browsing context container</span>'s <span>nested browsing context</span>, and redo
    this step.</p>

    <p>Otherwise, return false and abort these steps.</p>

   </li>

  </ol>



  <h4 id="sequential-focus-navigation"><dfn>Sequential focus navigation</dfn></h4>

  <p>Each <span>control group</span> has a <dfn>sequential focus navigation order</dfn>, which orders some
  or all of the <span data-x="focusable area">focusable areas</span> in the <span>control group</span>
  relative to each other. The order in the <span>sequential focus navigation order</span> does not
  have to be related to the order in the <span>control group</span> itself. If a <span>focusable area</span> is
  omitted from the <span>sequential focus navigation order</span> of its <span>control group</span>, then
  it is unreachable via <span>sequential focus navigation</span>.</p>

  <p>There can also be a <dfn>sequential focus navigation starting point</dfn>. It is initially
  unset. The user agent may set it when the user indicates that it should be moved.</p>

  <p class="example">For example, the user agent could set it to the position of the user's click if
  the user clicks on the document contents.</p>

  <p>When the user requests that focus move from the <span>currently focused area of a top-level
  browsing context</span> to the next or previous <span>focusable area</span> (e.g. as the default action
  of pressing the <kbd>tab</kbd> key), or when the user requests that focus sequentially move to a
  <span>top-level browsing context</span> in the first place (e.g. from the browser's location bar),
  the user agent must use the following algorithm:</p>

  <ol>

   <li><p>Let <var>starting point</var> be the <span>currently focused area of a top-level
   browsing context</span>, if the user requested to move focus sequentially from there, or else the
   <span>top-level browsing context</span> itself, if the user instead requested to move focus from
   outside the <span>top-level browsing context</span>.</p></li>

   <li><p>If there is a <span>sequential focus navigation starting point</span> defined and it is
   inside <var>starting point</var>, then let <var>starting point</var> be the <span>sequential
   focus navigation starting point</span> instead.</p></li>

   <li>

    <p>Let <var>direction</var> be <i>forward</i> if the user requested the <em>next</em>
    control, and <i>backward</i> if the user requested the previous control.</p>

    <p class="note">Typically, pressing <kbd>tab</kbd> requests the next control, and pressing
    <kbd><kbd>shift</kbd>+<kbd>tab</kbd></kbd> requests the previous control.</p>

   </li>

   <li>

    <p><i>Loop</i>: Let <var>selection mechanism</var> be <i>sequential</i> if the <var>starting
    point</var> is a <span>browsing context</span> or if <var>starting point</var> is in its
    <span>control group</span>'s <span>sequential focus navigation order</span>.</p>

    <p>Otherwise, <var>starting point</var> is not in its <span>control group</span>'s
    <span>sequential focus navigation order</span>; let <var>selection mechanism</var> be
    <i>DOM</i>.</p>

   </li>

   <li><p>Let <var>candidate</var> be the result of running the <span>sequential navigation search
   algorithm</span> with <var>starting point</var>, <var>direction</var>, and <var>selection
   mechanism</var> as the arguments.</p></li>

   <li><p>If <var>candidate</var> is not null, then run the <span>focusing steps</span> for
   <var>candidate</var> and abort these steps.</p></li>

   <li><p>Otherwise, unset the <span>sequential focus navigation starting point</span>.</p></li>

   <li>

    <p>If <var>starting point</var> is the <span>top-level browsing context</span>, or a
    <span>focusable area</span> in the <span>top-level browsing context</span>, the user agent
    should transfer focus to its own controls appropriately (if any), honouring
    <var>direction</var>, and then abort these steps.</p>

    <p class="example">For example, if <var>direction</var> is <i>backward</i>, then the last
    focusable control before the browser's rendering area would be the control to focus.</p>

    <p>If the user agent has no focusable controls &mdash; a kiosk-mode browser, for instance
    &mdash; <!--and <var>starting point</var> is not the <span>top-level browsing context</span>,-->
    then the user agent may instead restart these steps with the <var>starting point</var> being the
    <span>top-level browsing context</span> itself.</p>

    <!-- in theory, the top-level browsing context _always_ has at least one focusable area: the
    viewport. Even a "blocked by a modal dialog" doesn't disable the viewport (since the Document is
    its DOM anchor, and the Document isn't made inert by "blocked by a modal dialog"). Note that
    nested browsing contexts can have inert viewports, though (if the browsing context container
    itself is inert, for example) -->

   </li>

   <li><p>Otherwise, <var>starting point</var> is a <span>focusable area</span> in a
   <span>nested browsing context</span>. Let <var>starting point</var> be that
   <span>nested browsing context</span>'s <span>browsing context container</span>, and return to the
   step labeled <i>loop</i>.</p>
    <!--
     http://software.hixie.ch/utilities/js/live-dom-viewer/saved/2856
     http://software.hixie.ch/utilities/js/live-dom-viewer/saved/2857
    -->
   </li>

  </ol>


  <p>The <dfn>sequential navigation search algorithm</dfn> consists of the following steps. This
  algorithm takes three arguments: <var>starting point</var>, <var>direction</var>,
  and <var>selection mechanism</var>.</p>

  <ol>

   <li>

    <p>Pick the appropriate cell from the following table, and follow the instructions in that
    cell.</p>

    <p>The appropriate cell is the one that is from the column whose header describes <var>direction</var> and from the first row whose header describes <var>starting point</var> and <var>selection mechanism</var>.</p>

    <table>
     <thead>
      <tr>
       <th>
       <th> <var>direction</var> is <i>forward</i>
       <th> <var>direction</var> is <i>backward</i>
     <tbody>
      <tr>
       <th><var>starting point</var> is a <span>browsing context</span>
       <td>Let <var>candidate</var> be the first <span>suitable sequentially focusable area</span> in <var>starting point</var>'s <span>active document</span>'s <span>primary control group</span>, if any; or else null
       <td>Let <var>candidate</var> be the last <span>suitable sequentially focusable area</span> in <var>starting point</var>'s <span>active document</span>'s <span>primary control group</span>, if any; or else null
      <tr>
       <th><var>selection mechanism</var> is <i>DOM</i>
       <td>Let <var>candidate</var> be the first <span>suitable sequentially focusable area</span> in the <span>home control group</span> following <var>starting point</var>, if any; or else null
       <td>Let <var>candidate</var> be the last <span>suitable sequentially focusable area</span> in the <span>home control group</span> preceding <var>starting point</var>, if any; or else null
      <tr>
       <th><var>selection mechanism</var> is <i>sequential</i>
       <td>Let <var>candidate</var> be the first <span>suitable sequentially focusable area</span> in the <span>home sequential focus navigation order</span> following <var>starting point</var>, if any; or else null
       <td>Let <var>candidate</var> be the last <span>suitable sequentially focusable area</span> in the <span>home sequential focus navigation order</span> preceding <var>starting point</var>, if any; or else null

    </table>

    <p>A <dfn>suitable sequentially focusable area</dfn> is a <span>focusable area</span> whose <span>DOM
    anchor</span> is not <span>inert</span> and that is in its <span>control group</span>'s <span>sequential
    focus navigation order</span>.</p>

    <p>The <dfn>primary control group</dfn> of a <span>control group owner object</span> <var>X</var> is the <span>control group</span> of <var>X</var> if <var>X</var> has no <span>dialog group</span> or if its <span>dialog group</span> has no
    designated <span>focused dialog of the dialog group</span>, otherwise, it is the <span>primary
    control group</span> of <var>X</var>'s <span>dialog group</span>'s designated
    <span>focused dialog of the dialog group</span>.</p>

    <p>The <dfn>home control group</dfn> is the <span>control group</span> to which <var>starting point</var> belongs.</p>

    <p>The <dfn>home sequential focus navigation order</dfn> is the <span>sequential focus
    navigation order</span> to which <var>starting point</var> belongs.</p>

    <p class="note">The <span>home sequential focus navigation order</span> is the <span>home
    control group</span>'s <span>sequential focus navigation order</span>, but is only used when the
    <var>starting point</var> is in that <span>sequential focus navigation order</span>
    (when it's not, <var>selection mechanism</var> will be <i>DOM</i>).</p>

   </li>

   <li>

    <p>If <var>candidate</var> is a <span>browsing context container</span>, then let <var>new candidate</var> be the result of running the <span>sequential navigation search
    algorithm</span> with <var>candidate</var>'s <span>nested browsing context</span> as
    the first argument, <var>direction</var> as the second, and <i>sequential</i> <!--
    shift-tab from the end in http://software.hixie.ch/utilities/js/live-dom-viewer/saved/2855 -->
    as the third.</p>

    <p>If <var>new candidate</var> is null, then let <var>starting point</var>
    be <var>candidate</var>, and return to the top of this algorithm. Otherwise, let <var>candidate</var> be <var>new candidate</var>.</p>

   </li>

   <li><p>Return <var>candidate</var>.</p></li>

  </ol>

  </div>


<!--TOPIC:DOM APIs-->
  <h4 id="focus-management-apis">Focus management APIs</h4>

  <dl class="domintro">

   <dt><var>document</var> . <code subdfn data-x="dom-document-activeElement">activeElement</code></dt>

   <dd>

    <p>Returns the deepest element in the document through which or to which key events are being
    routed. This is, roughly speaking, the focused element in the document.</p>

    <p>For the purposes of this API, when a <span>child browsing context</span> is focused, its
    <span>browsing context container</span> is <a href="#bc-focus-ergo-bcc-focus">focused</a> in the
    <span>parent browsing context</span>. For example, if the user moves the focus to a text field
    in an <code>iframe</code>, the <code>iframe</code> is the element returned by the <code
    data-x="dom-document-activeElement">activeElement</code> API in the <code>iframe</code>'s
    <span>node document</span>.</p>

   </dd>

   <dt><var>document</var> . <code subdfn data-x="dom-document-hasFocus">hasFocus</code>()</dt>

   <dd>

    <p>Returns true if key events are being routed through or to the document; otherwise, returns
    false. Roughly speaking, this corresponds to the document, or a document nested inside this
    one, being focused.</p>

   </dd>

   <dt><var>window</var> . <code subdfn data-x="dom-window-focus">focus</code>()</dt>

   <dd>

    <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/?saved=2823 -->

    <p>Moves the focus to the window's <span>browsing context</span>, if any.</p>

   </dd>

<!--
   <dt><var>window</var> . <code subdfn data-x="dom-window-blur">blur</code>()</dt>

   <dd>

    <p>No effect.</p>

   </dd>
-->

   <dt><var>element</var> . <code subdfn data-x="dom-focus">focus</code>()</dt>

   <dd>

    <p>Moves the focus to the element.</p>

    <p>If the element is a <span>browsing context container</span>, moves the focus to the <span>nested browsing context</span> instead.</p>

   </dd>

   <dt><var>element</var> . <code subdfn data-x="dom-blur">blur</code>()</dt>

   <dd>

    <p>Moves the focus to the viewport. Use of this method is discouraged; if you want to focus the
    viewport, call the <code data-x="dom-focus">focus()</code> method on the <code>Document</code>'s root element.</p>

    <p>Do not use this method to hide the focus ring if you find the focus ring unsightly. Instead,
    use a CSS rule to override the 'outline' property, and provide a different way to show what
    element is focused. Be aware that if an alternative focusing style isn't made available, the
    page will be significantly less usable for people who primarily navigate pages using a keyboard,
    or those with reduced vision who use focus outlines to help them navigate the page.</p>

    <!-- we suggest using CSS here because users can override CSS, so it's no the end of the world,
    unlike using .blur(), which cannot be easily overridden by users and completely breaks tab
    navigation. -->

    <div class="example">

     <p>For example, to hide the outline from links and instead use a yellow background to indicate
     focus, you could use:</p>

     <pre>:link:focus, :visited:focus { outline: none; background: yellow; color: black; }</pre>

    </div>
<!--START w3c-html--><!--END complete--><!--END dev-html--><!--START FORK-->
    <p>Do not use this method to hide the focus ring. Do not use any
    other method that hides the focus ring from keyboard users, in
    particular do not use a CSS rule to override the 'outline'
    property. Removal of the focus ring leads to serious accessibility
    issues for users who navigate and interact with interactive
    content using the keyboard.</p>
<!--START complete--><!--START dev-html-->
<!--END FORK-->

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-document-activeElement">activeElement</code></dfn> attribute on
  <code>Document</code> objects must return the value returned by the following steps:</p>

  <ol>

   <li><p>Let <var>candidate</var> be the <code>Document</code> on which the method was
   invoked.</p></li>

   <li><p>If <var>candidate</var> has a <span>dialog group</span> with a designated
   <span>focused dialog of the dialog group</span>, then let <var>candidate</var> be the
   designated <span>focused dialog of the dialog group</span>, and redo this step.</p></li>

   <li><p>If <var>candidate</var> has a non-empty <span>control group</span>, let <var>candidate</var> be the designated <span>focused area of the control
   group</span>.</p>

   </li>

   <li><p>If <var>candidate</var> is a <span>focusable area</span>, let <var>candidate</var> be <var>candidate</var>'s <span>DOM anchor</span>.</p></li>

   <li>

    <p>If <var>candidate</var> is a <code>Document</code> that has a <span data-x="the
    body element">body element</span>, then let <var>candidate</var> be <span>the body
    element</span> of that <code>Document</code>.</p>

    <p>Otherwise, if <var>candidate</var> is a <code>Document</code> that has a <span>root
    element</span>, then let <var>candidate</var> be the <span>root element</span> of that
    <code>Document</code>.</p>

    <p>Otherwise, if <var>candidate</var> is a <code>Document</code>, then let <var>candidate</var> be null.</p>

   </li>

   <li><p>Return <var>candidate</var>.</p></li>

  </ol>

  <p>The <dfn><code data-x="dom-document-hasFocus">hasFocus()</code></dfn> method on the
  <code>Document</code> object, when invoked, must return the result of running the <span>has focus
  steps</span> with the <code>Document</code> object as the argument.</p>

  <p>The <dfn><code data-x="dom-window-focus">focus()</code></dfn> method on the <code>Window</code>
  object, when invoked, must run the <span>focusing steps</span> with the <code>Window</code>
  object's <span>browsing context</span>. Additionally, if this <span>browsing context</span> is a
  <span>top-level browsing context</span>, user agents are encouraged to trigger some sort of
  notification to indicate to the user that the page is attempting to gain focus.</p>

  <p>The <dfn><code data-x="dom-window-blur">blur()</code></dfn> method on the <code>Window</code>
  object, when invoked, provides a hint to the user agent that the script believes the user probably
  is not currently interested in the contents of the <span>browsing context</span> of the
  <code>Window</code> object on which the method was invoked, but that the contents might become
  interesting again in the future.</p>

  <p>User agents are encouraged to ignore calls to this <code data-x="dom-window-blur">blur()</code>
  method entirely.</p>

  <p class="note">Historically, the <code data-x="dom-window-blur">focus()</code> and <code
  data-x="dom-window-blur">blur()</code> methods actually affected the system-level focus of the
  system widget (e.g. tab or window) that contained the <span>browsing context</span>, but hostile
  sites widely abuse this behavior to the user's detriment.</p>

  <p>The <dfn><code data-x="dom-focus">focus()</code></dfn> method on elements, when invoked, must
  run the following algorithm:</p>

  <ol>

   <li><p>If the element is marked as <i data-x="locked for focus">locked for focus</i>, then abort these steps.</p></li>

   <li><p>Mark the element as <dfn>locked for focus</dfn>.</p></li>

   <li><p>Run the <span>focusing steps</span> for the element.</p></li>

   <li><p>Unmark the element as <i data-x="locked for focus">locked for focus</i>.</p></li>

  </ol>

  <p>The <dfn><code data-x="dom-blur">blur()</code></dfn> method, when invoked, should run the
  <span>unfocusing steps</span> for the element on which the method was called. User agents may
  selectively or uniformly ignore calls to this method for usability reasons.</p>

  <p class="example">For example, if the <code data-x="dom-blur">blur()</code> method is unwizely
  being used to remove the focus ring for aesthetics reasons, the page would become unusable by
  keyboard users. Ignoring calls to this method would thus allow keyboard users to interact with the
  page.</p>

  </div>


<!--TOPIC:HTML-->


  <h3 id="assigning-keyboard-shortcuts">Assigning keyboard shortcuts</h3>

  <h4 id="introduction">Introduction</h4>

  <p><em>This section is non-normative.</em></p>

  <p>Each element that can be activated or focused can be assigned a single key combination to
  activate it, using the <code data-x="attr-accesskey">accesskey</code> attribute.</p>

  <p>The exact shortcut is determined by the user agent, based on information about the user's
  keyboard, what keyboard shortcuts already exist on the platform, and what other shortcuts have
  been specified on the page, using the information provided in the <code
  data-x="attr-accesskey">accesskey</code> attribute as a guide.</p>

  <p>In order to ensure that a relevant keyboard shortcut is available on a wide variety of input
  devices, the author can provide a number of alternatives in the <code
  data-x="attr-accesskey">accesskey</code> attribute.</p>

  <p>Each alternative consists of a single character, such as a letter or digit.</p>

  <p>User agents can provide users with a list of the keyboard shortcuts, but authors are encouraged
  to do so also. The <code data-x="dom-accessKeyLabel">accessKeyLabel</code> IDL attribute returns a
  string representing the actual key combination assigned by the user agent.</p>

  <div class="example">

   <p>In this example, an author has provided a button that can be invoked using a shortcut key. To
   support full keyboards, the author has provided "C" as a possible key. To support devices
   equipped only with numeric keypads, the author has provided "1" as another possibly key.</p>

   <pre>&lt;input type=button value=Collect onclick="collect()"
       <strong>accesskey="C 1"</strong> id=c></pre>

  </div>

  <div class="example">

   <p>To tell the user what the shortcut key is, the author has this script here opted to explicitly
   add the key combination to the button's label:</p>

   <pre>function addShortcutKeyLabel(button) {
<strong>  if (button.accessKeyLabel != '')
    button.value += ' (' + button.accessKeyLabel + ')';</strong>
}
addShortcutKeyLabel(document.getElementById('c'));</pre>

   <p>Browsers on different platforms will show different labels, even for the same key combination,
   based on the convention prevalent on that platform. For example, if the key combination is the
   Control key, the Shift key, and the letter C, a Windows browser might display
   "<samp>Ctrl+Shift+C</samp>", whereas a Mac browser might display "<samp>^&#x21E7;C</samp>", while
   an Emacs browser might just display "<samp>C-C</samp>". Similarly, if the key combination is the
   Alt key and the Escape key, Windows might use "<samp>Alt+Esc</samp>", Mac might use
   "<samp>&#x2325;&#x238B;</samp>", and an Emacs browser might use "<samp>M-ESC</samp>" or
   "<samp>ESC ESC</samp>".</p>

   <p>In general, therefore, it is unwize to attempt to parse the value returned from the <code
   data-x="dom-accessKeyLabel">accessKeyLabel</code> IDL attribute.</p>

  </div>


  <h4>The <dfn><code data-x="attr-accesskey">accesskey</code></dfn> attribute</h4>

  <p>All <span>HTML elements</span> may have the <code data-x="attr-accesskey">accesskey</code>
  content attribute set. The <code data-x="attr-accesskey">accesskey</code> attribute's value is used
  by the user agent as a guide for creating a keyboard shortcut that activates or focuses the
  element.</p>

  <p>If specified, the value must be an <span>ordered set of unique space-separated tokens</span>
  that are <span>case-sensitive</span>, each of which must be exactly one Unicode code point in
  length.</p>

  <div class="example">

   <p>In the following example, a variety of links are given with access keys so that keyboard users
   familiar with the site can more quickly navigate to the relevant pages:</p>

   <pre>&lt;nav>
 &lt;p>
  &lt;a title="Consortium Activities" accesskey="A" href="/Consortium/activities">Activities&lt;/a> |
  &lt;a title="Technical Reports and Recommendations" accesskey="T" href="/TR/">Technical Reports&lt;/a> |
  &lt;a title="Alphabetical Site Index" accesskey="S" href="/Consortium/siteindex">Site Index&lt;/a> |
  &lt;a title="About This Site" accesskey="B" href="/Consortium/">About Consortium&lt;/a> |
  &lt;a title="Contact Consortium" accesskey="C" href="/Consortium/contact">Contact&lt;/a>
 &lt;/p>
&lt;/nav></pre>

  </div>

  <div class="example">

   <p>In the following example, the search field is given two possible access keys, "s" and "0" (in
   that order). A user agent on a device with a full keyboard might pick <kbd><kbd
  >Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>S</kbd></kbd> as the shortcut key,
   while a user agent on a small device with just a numeric keypad might pick just the plain
   unadorned key <kbd><kbd>0</kbd></kbd>:</p>

   <pre>&lt;form action="/search">
 &lt;label>Search: &lt;input type="search" name="q" accesskey="s 0">&lt;/label>
 &lt;input type="submit">
&lt;/form></pre>

  </div>

  <div class="example">

   <p>In the following example, a button has possible access keys described. A script then tries to
   update the button's label to advertise the key combination the user agent selected.</p>

   <pre>&lt;input type=submit accesskey="N @ 1" value="Compose">
...
&lt;script>
 function labelButton(button) {
   if (button.accessKeyLabel)
     button.value += ' (' + button.accessKeyLabel + ')';
 }
 var inputs = document.getElementsByTagName('input');
 for (var i = 0; i &lt; inputs.length; i += 1) {
   if (inputs[i].type == "submit")
     labelButton(inputs[i]);
 }
&lt;/script></pre>

   <p>On one user agent, the button's label might become "<samp>Compose (&#x2318;N)</samp>". On
   another, it might become "<samp>Compose (Alt+&#x21E7;+1)</samp>". If the user agent doesn't
   assign a key, it will be just "<samp>Compose</samp>". The exact string depends on what the
   <span>assigned access key</span> is, and on how the user agent represents that key
   combination.</p>

  </div>


  <div class="impl">

  <h4 id="processing-model">Processing model</h4>

  <p>An element's <dfn>assigned access key</dfn> is a key combination derived from the element's
  <code data-x="attr-accesskey">accesskey</code> content attribute. Initially, an element must not
  have an <span>assigned access key</span>.</p>

  <p>Whenever an element's <code data-x="attr-accesskey">accesskey</code> attribute is set, changed,
  or removed, the user agent must update the element's <span>assigned access key</span> by running
  the following steps:</p>

  <ol>

   <li><p>If the element has no <code data-x="attr-accesskey">accesskey</code> attribute, then skip
   to the <i>fallback</i> step below.</p></li>

   <li><p>Otherwise, <span data-x="split a string on spaces">split the attribute's value on
   spaces</span>, and let <var>keys</var> be the resulting tokens.</p></li>

   <li>

    <p>For each value in <var>keys</var> in turn, in the order the tokens appeared in the
    attribute's value, run the following substeps:</p>

    <ol>

     <li><p>If the value is not a string exactly one Unicode code point in length, then skip the
     remainder of these steps for this value.</p></li>

     <li><p>If the value does not correspond to a key on the system's keyboard, then skip the
     remainder of these steps for this value.</p></li>

     <li><p>If the user agent can find a mix of zero or more modifier keys that, combined with the
     key that corresponds to the value given in the attribute, can be used as the access key, then
     the user agent may assign that combination of keys as the element's <span>assigned access
     key</span> and abort these steps.
     <!--INSERT FINGERPRINT-->
     </p></li>

    </ol>

   </li>

   <li><p><i>Fallback</i>: Optionally, the user agent may assign a key combination of its choosing
   as the element's <span>assigned access key</span> and then abort these steps.</p></li>

   <li><p>If this step is reached, the element has no <span>assigned access key</span>.</p></li>

  </ol>

  <p>Once a user agent has selected and assigned an access key for an element, the user agent should
  not change the element's <span>assigned access key</span> unless the <code
  data-x="attr-accesskey">accesskey</code> content attribute is changed or the element is moved to
  another <code>Document</code>.</p>

  <p>When the user presses the key combination corresponding to the <span>assigned access key</span>
  for an element, if the element <span data-x="concept-command">defines a command</span>, the
  command's <span data-x="command-facet-HiddenState">Hidden State</span> facet is false (visible),
  the command's <span data-x="command-facet-DisabledState">Disabled State</span> facet is also false
  (enabled), the element is <span>in a <code>Document</code></span> that has an associated
  <span>browsing context</span>, and neither the element nor any of its ancestors has a <code
  data-x="attr-hidden">hidden</code> attribute specified, then the user agent must trigger the <span
  data-x="command-facet-Action">Action</span> of the command.</p>

  <p class="note">User agents <a href="#expose-commands-in-ui">might expose</a> elements that have
  an <code data-x="attr-accesskey">accesskey</code> attribute in other ways as well, e.g. in a menu
  displayed in response to a specific key combination.</p> <!-- the actual conformance criteria for
  this is in the section that defines commands -->

  <hr>

  <p>The <dfn><code data-x="dom-accessKey">accessKey</code></dfn> IDL attribute must
  <span>reflect</span> the <code data-x="attr-accesskey">accesskey</code> content attribute.</p>

  <p>The <dfn><code data-x="dom-accessKeyLabel">accessKeyLabel</code></dfn> IDL attribute must return
  a string that represents the element's <span>assigned access key</span>, if any. If the element
  does not have one, then the IDL attribute must return the empty string.</p>

  </div>



  <h3 id="editing">Editing</h3>

  <h4 id="contenteditable">Making document regions editable: The <code
  data-x="attr-contenteditable">contenteditable</code> content attribute</h4>

  <pre class="idl">[NoInterfaceObject]
interface <dfn>ElementContentEditable</dfn> {
  attribute DOMString <span data-x="dom-contentEditable">contentEditable</span>;
  readonly attribute boolean <span data-x="dom-isContentEditable">isContentEditable</span>;
};</pre>

  <p>The <dfn><code data-x="attr-contenteditable">contenteditable</code></dfn> content attribute is an
  <span>enumerated attribute</span> whose keywords are the empty string, <code>true</code>,
  and <code>false</code>. The empty string and the <code>true</code> keyword map
  to the <i>true</i> state. The <code>false</code> keyword maps to the <i>false</i> state.
  In addition, there is a third state, the <i>inherit</i> state, which is the <i data-x="missing value default">missing value default</i> (and the <i data-x="invalid value default">invalid value default</i>).</p>

  <p>The <i>true</i> state indicates that the element is editable. The <i>inherit</i> state
  indicates that the element is editable if its parent is. The <i>false</i> state indicates that the
  element is not editable.</p>

  <dl class="domintro">

   <dt><var>element</var> . <code subdfn data-x="dom-contentEditable">contentEditable</code> [ = <var>value</var> ]</dt>

   <dd>

    <p>Returns "<code>true</code>", "<code>false</code>", or "<code
   >inherit</code>", based on the state of the <code
    data-x="attr-contenteditable">contenteditable</code> attribute.</p>

    <p>Can be set, to change that state.</p>

    <p>Throws a <code>SyntaxError</code> exception if the new value isn't one of those strings.</p>

   </dd>

   <dt><var>element</var> . <code subdfn data-x="dom-isContentEditable">isContentEditable</code></dt>

   <dd>

    <p>Returns true if the element is editable; otherwise, returns false.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-contentEditable">contentEditable</code></dfn> IDL attribute, on
  getting, must return the string "<code>true</code>" if the content attribute is set to
  the true state, "<code>false</code>" if the content attribute is set to the false state,
  and "<code>inherit</code>" otherwise. On setting, if the new value is an <span>ASCII
  case-insensitive</span> match for the string "<code>inherit</code>" then the content
  attribute must be removed, if the new value is an <span>ASCII case-insensitive</span> match for
  the string "<code>true</code>" then the content attribute must be set to the string
  "<code>true</code>", if the new value is an <span>ASCII case-insensitive</span> match for
  the string "<code>false</code>" then the content attribute must be set to the string
  "<code>false</code>", and otherwise the attribute setter must throw a
  <code>SyntaxError</code> exception.</p>

  <p>The <dfn><code data-x="dom-isContentEditable">isContentEditable</code></dfn> IDL attribute, on
  getting, must return true if the element is either an <span>editing host</span> or
  <span>editable</span>, and false otherwise.</p>

  </div>


  <h4>Making entire documents editable: The <code data-x="dom-document-designMode">designMode</code> IDL attribute</h4>

  <div class="impl">

  <p>Documents have a <dfn id="designMode"
  data-x="dom-document-designMode"><code>designMode</code></dfn>, which can be either enabled or
  disabled.</p>

  </div>

  <dl class="domintro">

   <dt><var>document</var> . <code subdfn data-x="dom-document-designMode">designMode</code> [ = <var>value</var> ]</dt>

   <dd>

    <p>Returns "<code>on</code>" if the document is editable, and "<code
   >off</code>" if it isn't.</p>

    <p>Can be set, to change the document's current state. This focuses the document and resets the
    selection in that document.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <code data-x="dom-document-designMode">designMode</code> IDL attribute on the
  <code>Document</code> object takes two values, "<code>on</code>" and "<code
 >off</code>". On setting, the new value must be compared in an <span>ASCII
  case-insensitive</span> manner to these two values; if it matches the "<code>on</code>"
  value, then <code data-x="dom-document-designMode">designMode</code> must be enabled, and if it
  matches the "<code>off</code>" value, then <code
  data-x="dom-document-designMode">designMode</code> must be disabled. Other values must be
  ignored.</p>

  <p>On getting, if <code data-x="dom-document-designMode">designMode</code> is enabled, the IDL
  attribute must return the value "<code>on</code>"; otherwise it is disabled, and the
  attribute must return the value "<code>off</code>".</p>

  <p>The last state set must persist until the document is destroyed or the state is changed.
  Initially, documents must have their <code data-x="dom-document-designMode">designMode</code>
  disabled.</p>

  <p>When the <code data-x="dom-document-designMode">designMode</code> changes from being disabled to
  being enabled, the user agent must <span>immediately</span> reset the document's <span>active range</span>'s
  start and end boundary points to be at the start of the <code>Document</code> and then run the
  <span>focusing steps</span> for the root element of the <code>Document</code>, if any.</p>

  </div>


  <h4 id="best-practices-for-in-page-editors">Best practices for in-page editors</h4>

  <p>Authors are encouraged to set the 'white-space' property on <span data-x="editing host">editing
  hosts</span> and on markup that was originally created through these editing mechanisms to the
  value 'pre-wrap'. Default HTML whitespace handling is not well suited to WYSIWYG editing, and line
  wrapping will not work correctly in some corner cases if 'white-space' is left at its default
  value.</p>

  <div class="example">

   <p>As an example of problems that occur if the default 'normal' value is used instead, consider
   the case of the user typing "<kbd>yellow&#x2423;&#x2423;ball</kbd>", with two spaces (here
   represented by "&#x2423;") between the words. With the editing rules in place for the default
   value of 'white-space' ('normal'), the resulting markup will either consist of
   "<samp>yellow&amp;nbsp;&nbsp;ball</samp>" or "<samp>yellow&nbsp;&amp;nbsp;ball</samp>"; i.e.,
   there will be a non-breaking space between the two words in addition to the regular space. This
   is necessary because the 'normal' value for 'white-space' requires adjacent regular spaces to be
   collapsed together.</p>

   <p>In the former case, "<samp>yellow&#x237D;</samp>" might wrap to the next line ("&#x237D;"
   being used here to represent a non-breaking space) even though "<samp>yellow</samp>" alone might
   fit at the end of the line; in the latter case, "<samp>&#x237D;ball</samp>", if wrapped to the
   start of the line, would have visible indentation from the non-breaking space.</p>

   <p>When 'white-space' is set to 'pre-wrap', however, the editing rules will instead simply put
   two regular spaces between the words, and should the two words be split at the end of a line, the
   spaces would be neatly removed from the rendering.</p>

  </div>



  <h4 id="editing-apis">Editing APIs</h4>

  <p>The definition of the terms <dfn>active range</dfn>, <dfn>editing host</dfn>, and
  <dfn>editable</dfn>, the user interface requirements of elements that are <span data-x="editing
  host">editing hosts</span> or <span>editable</span>, the

  <dfn data-x="dom-document-execCommand" id="execCommand"><code>execCommand()</code></dfn>,
  <dfn><code data-x="dom-document-queryCommandEnabled">queryCommandEnabled()</code></dfn>,
  <dfn><code data-x="dom-document-queryCommandIndeterm">queryCommandIndeterm()</code></dfn>,
  <dfn><code data-x="dom-document-queryCommandState">queryCommandState()</code></dfn>,
  <dfn><code data-x="dom-document-queryCommandSupported">queryCommandSupported()</code></dfn>, and
  <dfn><code data-x="dom-document-queryCommandValue">queryCommandValue()</code></dfn>

  methods, text selections, and the <dfn>delete the selection</dfn> algorithm are defined in the
  HTML Editing APIs specification. The interaction of editing and the undo/redo features in user
  agents is defined by the UndoManager and DOM Transaction specification. <a
  href="#refsEDITING">\[EDITING]</a> <a href="#refsUNDO">\[UNDO]</a></p>

  <!-- those might get merged in here eventually -->



  <h4 id="spelling-and-grammar-checking">Spelling and grammar checking</h4>

  <div class="impl">

  <p>User agents can support the checking of spelling and grammar of editable text, either in form
  controls (such as the value of <code>textarea</code> elements), or in elements in an <span>editing
  host</span> (e.g. using <code data-x="attr-contenteditable">contenteditable</code>).</p>

  <p>For each element, user agents must establish a <dfn data-x="concept-spellcheck-default">default
  behavior</dfn>, either through defaults or through preferences expressed by the user. There are
  three possible default behaviors for each element:</p>

  <dl>

   <dt><dfn data-x="concept-spellcheck-default-true">true-by-default</dfn>

   <dd>The element will be checked for spelling and grammar if its contents are editable.

   <dt><dfn data-x="concept-spellcheck-default-false">false-by-default</dfn>

   <dd>The element will never be checked for spelling and grammar.

   <dt><dfn data-x="concept-spellcheck-default-inherit">inherit-by-default</dfn>

   <dd>The element's default behavior is the same as its parent element's. Elements that have no
   parent element cannot have this as their default behavior.

  </dl>

  <hr>

  </div>

  <p>The <dfn><code data-x="attr-spellcheck">spellcheck</code></dfn> attribute is an <span>enumerated
  attribute</span> whose keywords are the empty string, <code>true</code> and <code
 >false</code>. The empty string and the <code>true</code> keyword map to the
  <i>true</i> state. The <code>false</code> keyword maps to the <i>false</i> state. In
  addition, there is a third state, the <i>default</i> state, which is the <i data-x="missing value default">missing value default</i> (and the <i data-x="invalid value default">invalid value default</i>).</p>

  <p class="note">The <i>true</i> state indicates that the element is to have its spelling and
  grammar checked. The <i>default</i> state indicates that the element is to act according to a
  default behavior, possibly based on the parent element's own <code
  data-x="attr-spellcheck">spellcheck</code> state, as defined below. The <i>false</i> state
  indicates that the element is not to be checked.</p>

  <div class="impl">

  <hr>

  </div>

  <dl class="domintro">

   <dt><var>element</var> . <code subdfn data-x="dom-spellcheck">spellcheck</code> [ = <var>value</var> ]</dt>

   <dd>

    <p>Returns true if the element is to have its spelling and grammar checked; otherwise, returns
    false.</p>

    <p>Can be set, to override the default and set the <code
    data-x="attr-spellcheck">spellcheck</code> content attribute.</p>

   </dd>


   <dt><var>element</var> . <code subdfn data-x="dom-forceSpellCheck">forceSpellCheck</code>()</dt>

   <dd>

    <p>Forces the user agent to report spelling and grammar errors on the element (if checking is
    enabled), even if the user has never focused the element. (If the method is not invoked, user
    agents can hide errors in text that wasn't just entered by the user.)</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-spellcheck">spellcheck</code></dfn> IDL attribute, on getting, must
  return true if the element's <code data-x="attr-spellcheck">spellcheck</code> content attribute is
  in the <i>true</i> state, or if the element's <code data-x="attr-spellcheck">spellcheck</code>
  content attribute is in the <i>default</i> state and the element's <span
  data-x="concept-spellcheck-default">default behavior</span> is <span
  data-x="concept-spellcheck-default-true">true-by-default</span>, or if the element's <code
  data-x="attr-spellcheck">spellcheck</code> content attribute is in the <i>default</i> state and the
  element's <span data-x="concept-spellcheck-default">default behavior</span> is <span
  data-x="concept-spellcheck-default-inherit">inherit-by-default</span> and the element's parent
  element's <code data-x="dom-spellcheck">spellcheck</code> IDL attribute would return true;
  otherwise, if none of those conditions applies, then the attribute must instead return false.</p>

  <p class="note">The <code data-x="dom-spellcheck">spellcheck</code> IDL attribute is not affected
  by user preferences that override the <code data-x="attr-spellcheck">spellcheck</code> content
  attribute, and therefore might not reflect the actual spellchecking state.</p>

  <p>On setting, if the new value is true, then the element's <code
  data-x="attr-spellcheck">spellcheck</code> content attribute must be set to the literal string
  "<code>true</code>", otherwise it must be set to the literal string "<code
 >false</code>".

  <hr>

  <p>User agents must only consider the following pieces of text as checkable for the purposes of
  this feature:</p>

  <ul>

   <li>The <span data-x="concept-fe-value">value</span> of <code>input</code> elements whose <code
   data-x="attr-input-type">type</code> attributes are in the <span
   data-x="attr-input-type-text">Text</span>, <span data-x="attr-input-type-search">Search</span>,
   <span data-x="attr-input-type-url">URL</span>, or <span
   data-x="attr-input-type-email">E-mail</span> states and that are <i
   data-x="concept-fe-mutable">mutable</i> (i.e. that do not have the <code
   data-x="attr-input-readonly">readonly</code> attribute specified and that are not <span
   data-x="concept-fe-disabled">disabled</span>).</li>

   <li>The <span data-x="concept-fe-value">value</span> of <code>textarea</code> elements that do not
   have a <code data-x="attr-textarea-readonly">readonly</code> attribute and that are not <span
   data-x="concept-fe-disabled">disabled</span>.</li>

   <li>Text in <code>Text</code> nodes that are children of <span data-x="editing host">editing
   hosts</span> or <span>editable</span> elements.</li>

   <li>Text in attributes of <span>editable</span> elements.</li>

  </ul>

  <p>For text that is part of a <code>Text</code> node, the element with which the text is
  associated is the element that is the immediate parent of the first character of the word,
  sentence, or other piece of text. For text in attributes, it is the attribute's element. For the
  values of <code>input</code> and <code>textarea</code> elements, it is the element itself.</p>

  <p>To determine if a word, sentence, or other piece of text in an applicable element (as defined
  above) is to have spelling- and grammar-checking enabled, the UA must use the following
  algorithm:</p>

  <ol>

   <!-- user override -->

   <li>If the user has disabled the checking for this text, then the checking is disabled.</li>

   <li>Otherwise, if the user has forced the checking for this text to always be enabled, then the
   checking is enabled.</li>

   <!-- content attribute: on, off -->

   <li>Otherwise, if the element with which the text is associated has a <code
   data-x="attr-spellcheck">spellcheck</code> content attribute, then: if that attribute is in the
   <i>true</i> state, then checking is enabled; otherwise, if that attribute is in the <i>false</i>
   state, then checking is disabled.</li>

   <!-- inherit, if there is one to inherit from -->

   <li>Otherwise, if there is an ancestor element with a <code
   data-x="attr-spellcheck">spellcheck</code> content attribute that is not in the <i>default</i>
   state, then: if the nearest such ancestor's <code data-x="attr-spellcheck">spellcheck</code>
   content attribute is in the <i>true</i> state, then checking is enabled; otherwise, checking is
   disabled.</li>

   <!-- default -->

   <li>Otherwise, if the element's <span data-x="concept-spellcheck-default">default behavior</span>
   is <span data-x="concept-spellcheck-default-true">true-by-default</span>, then checking is
   enabled.</li>

   <li>Otherwise, if the element's <span data-x="concept-spellcheck-default">default behavior</span>
   is <span data-x="concept-spellcheck-default-false">false-by-default</span>, then checking is
   disabled.</li>

   <!-- default inheritance -->

   <li>Otherwise, if the element's parent element has <em>its</em> checking enabled, then checking
   is enabled.</li>

   <li>Otherwise, checking is disabled.</li>

  </ol>

  <p>If the checking is enabled for a word/sentence/text, the user agent should indicate spelling
  and grammar errors in that text. User agents should take into account the other semantics given in
  the document when suggesting spelling and grammar corrections. User agents may use the language of
  the element to determine what spelling and grammar rules to use, or may use the user's preferred
  language settings. UAs should use <code>input</code> element attributes such as <code
  data-x="attr-input-pattern">pattern</code> to ensure that the resulting value is valid, where
  possible.</p>

  <p>If checking is disabled, the user agent should not indicate spelling or grammar errors for that
  text.</p>

  <p>Even when checking is enabled, user agents may opt to not report spelling or grammar errors in
  text that the user agent deems the user has no interest in having checked (e.g. text that was
  already present when the page was loaded, or that the user did not type, or text in controls that
  the user has not focused, or in parts of e-mail addresses that the user agent is not confident
  were misspelt). The <dfn><code data-x="dom-forceSpellCheck">forceSpellCheck()</code></dfn> method,
  when invoked on an element, must override this behavior, forcing the user agent to consider all
  spelling and grammar errors in text in that element for which checking is enabled to be of
  interest to the user.</p>

  <div class="example">

   <p>The element with ID "a" in the following example would be the one used to determine if the
   word "Hello" is checked for spelling errors. In this example, it would not be.</p>

   <pre>&lt;div contenteditable="true">
 &lt;span spellcheck="false" id="a">Hell&lt;/span>&lt;em>o!&lt;/em>
&lt;/div></pre>

   <p>The element with ID "b" in the following example would have checking enabled (the leading
   space character in the attribute's value on the <code>input</code> element causes the attribute
   to be ignored, so the ancestor's value is used instead, regardless of the default).</p>

   <pre class="bad">&lt;p spellcheck="true">
 &lt;label>Name: &lt;input spellcheck=" false" id="b">&lt;/label>
&lt;/p></pre>

  </div>

  </div>

  <p class="note">This specification does not define the user interface for spelling and grammar
  checkers. A user agent could offer on-demand checking, could perform continuous checking while the
  checking is enabled, or could use other interfaces.</p>


  <h3 id="dnd"><dfn>Drag and drop</dfn></h3>

<!-- v2: ideas for drag and drop:

     * being able to animate a drop target:

       > To implement this with simple interface I've proposed, events should be handled either by
       > existing elements (like list items that compare their size and position of dragged element
       > to decide whether element should be dropped before or after) or handled by container that
       > would probably need to calculate positions of it's children and create new element to show
       > drop target. Smooth Mac-like drag'n'drop can be implemented by animating drop target's
       > padding/margin. So that's quite a bit of code that's going to be reinvented each time
       > someone implements reordering.

       <hyatt> :droptarget
       <hyatt> or something
       <hyatt> we don't support a pseudo-class for the drop target but that's a great idea
       <Hixie_> yeah, thinking about that too
       <Hixie_> :drop-target, :drop-target(above), :drop-target(below) and having ondragover be able to say "not on me, but next to me maybe"

       - some way to be able to match an element that is being dragged over.

       - some way to be able to animate an element as it goes into and out of this state (CSS
         transitions?), e.g. to be able to animate something "getting out of the way" to let you
         drop an item between others.

       - as an extension to the previous feature, a way to distinguish being dragged above or to the
         left of the drag target vs below or to the right of the drag target.

     * We should let drop targets communicate back to drag sources if they want to communicate.
       (e.g. expose Window, and thus postMessage(), on the dataTransfer object on drop.) Or maybe
       just use a MessagePort!

       We should let drag sources provide a set of options via a context menu when the drop happens.
       (So that, e.g., the source can know whether a capabilities URI that it is passing along is
       supposed to be read-write access or read-only access to the object being dragged.)

       We should let potential drop targets see the types (but not the contents!) of dragged data so
       they can establish if they care or not. (dataTransfer.hasType())

       Ack: Ben Laurie (@g)

     * Interop with native apps. In particular, we probably want to safelist the list of types that
       a Web page can see, since otherwise we'll end up exposing things like the username (if a user
       drags a file from their desktop, the path is exposed on some OSes).

     * Alex Velkov suggests that drags to and from the same origin should be able to read the data
       even before the drop.

     Other things listed below:
      DND-v2: more native support: text/html from selections, etc
      DND-v3: add Blob support
      DND-v4: add structured clone support
      DND-v5: add promises (should be able to say "if you accept this
              drop, then I can provide the File object that
              corresponds to it eventually")

         DataTransferPromise.type = 'string' or 'file' or 'blob' or 'data'
                            .onneeddata - can wait until this fires to provide data
                            .setData() - call this once you have data, must be the right type

-->

  <p>This section defines an event-based drag-and-drop mechanism.</p>

  <p>This specification does not define exactly what a <em>drag-and-drop operation</em> actually
  is.</p>

  <p>On a visual medium with a pointing device, a drag operation could be the default action of a
  <code data-x="event-mousedown">mousedown</code> event that is followed by a series of <code
  data-x="event-mousemove">mousemove</code> events, and the drop could be triggered by the mouse
  being released.</p>

  <p>When using an input modality other than a pointing device, users would probably have to
  explicitly indicate their intention to perform a drag-and-drop operation, stating what they wish
  to drag and where they wish to drop it, respectively.</p>

  <div class="impl">

  <p>However it is implemented, drag-and-drop operations must have a starting point (e.g. where the
  mouse was clicked, or the start of the selection or element that was selected for the drag), may
  have any number of intermediate steps (elements that the mouse moves over during a drag, or
  elements that the user picks as possible drop points as he cycles through possibilities), and must
  either have an end point (the element above which the mouse button was released, or the element
  that was finally selected), or be canceled. The end point must be the last element selected as a
  possible drop point before the drop occurs (so if the operation is not canceled, there must be at
  least one element in the middle step).</p>

  </div>


  <h4 id="event-drag">Introduction</h4>

  <p><em>This section is non-normative.</em></p>

  <p>To make an element draggable is simple: give the element a <code
  data-x="attr-draggable">draggable</code> attribute, and set an event listener for <code
  data-x="event-dnd-dragstart">dragstart</code> that stores the data being dragged.</p>

  <p>The event handler typically needs to check that it's not a text selection that is being
  dragged, and then needs to store data into the <code>DataTransfer</code> object and set the
  allowed effects (copy, move, link, or some combination).</p>

  <p>For example:</p>

  <pre>&lt;p>What fruits do you like?&lt;/p>
&lt;ol ondragstart="dragStartHandler(event)">
 &lt;li draggable="true" data-value="fruit-apple">Apples&lt;/li>
 &lt;li draggable="true" data-value="fruit-orange">Oranges&lt;/li>
 &lt;li draggable="true" data-value="fruit-pear">Pears&lt;/li>
&lt;/ol>
&lt;script>
  var internalDNDType = 'text/x-example'; // set this to something specific to your site
  function dragStartHandler(event) {
    if (event.target instanceof HTMLLIElement) {
      // use the element's data-value="" attribute as the value to be moving:
      event.dataTransfer.setData(internalDNDType, event.target.dataset.value);
      event.dataTransfer.effectAllowed = 'move'; // only allow moves
    } else {
      event.preventDefault(); // don't allow selection to be dragged
    }
  }
&lt;/script></pre>

  <hr>

  <p>To accept a drop, the drop target has to have a <code data-x="attr-dropzone">dropzone</code>
  attribute and listen to the <code data-x="event-dnd-drop">drop</code> event.</p>

  <p>The value of the <code data-x="attr-dropzone">dropzone</code> attribute specifies what kind of
  data to accept (e.g. "<code>string:text/plain</code>" to accept any text strings, or
  "<code>file:image/png</code>" to accept a PNG image file) and what kind of feedback to
  give (e.g. "<code>move</code>" to indicate that the data will be moved).</p>

  <p class="note">Instead of using the <code data-x="attr-dropzone">dropzone</code> attribute, a drop
  target can handle the <code data-x="event-dnd-dragenter">dragenter</code> event (to report whether or
  not the drop target is to accept the drop) and the <code data-x="event-dnd-dragover">dragover</code>
  event (to specify what feedback is to be shown to the user).</p>

  <p>The <code data-x="event-dnd-drop">drop</code> event allows the actual drop to be performed. This
  event needs to be canceled, so that the <code
  data-x="dom-DataTransfer-DropEffect">dropEffect</code> attribute's value can be used by the source
  (otherwise it's reset).</p>

  <p>For example:</p>

  <pre>&lt;p>Drop your favorite fruits below:&lt;/p>
&lt;ol dropzone="move string:text/x-example" ondrop="dropHandler(event)">
 &lt;!-- don't forget to change the "text/x-example" type to something
 specific to your site -->
&lt;/ol>
&lt;script>
  var internalDNDType = 'text/x-example'; // set this to something specific to your site
  function dropHandler(event) {
    var li = document.createElement('li');
    var data = event.dataTransfer.getData(internalDNDType);
    if (data == 'fruit-apple') {
      li.textContent = 'Apples';
    } else if (data == 'fruit-orange') {
      li.textContent = 'Oranges';
    } else if (data == 'fruit-pear') {
      li.textContent = 'Pears';
    } else {
      li.textContent = 'Unknown Fruit';
    }
    event.target.appendChild(li);
  }
&lt;/script></pre>

  <hr>

  <p>To remove the original element (the one that was dragged) from the display, the <code
  data-x="event-dnd-dragend">dragend</code> event can be used.</p>

  <p>For our example here, that means updating the original markup to handle that event:</p>

  <pre>&lt;p>What fruits do you like?&lt;/p>
&lt;ol ondragstart="dragStartHandler(event)" ondragend="dragEndHandler(event)">
 <em>...as before...</em>
&lt;/ol>
&lt;script>
  function dragStartHandler(event) {
    // <em>...as before...</em>
  }
  function dragEndHandler(event) {
    if (event.dataTransfer.dropEffect == 'move') {
      // remove the dragged element
      event.target.parentNode.removeChild(event.target);
    }
  }
&lt;/script></pre>



  <h4 id="the-drag-data-store">The drag data store</h4>

  <p>The data that underlies a drag-and-drop operation, known as the <dfn>drag data store</dfn>,
  consists of the following information:</p>

  <ul>

   <li><p>A <dfn>drag data store item list</dfn>, which is a list of items representing the dragged
   data, each consisting of the following information:</p>

    <dl>

     <dt><dfn>The drag data item kind</dfn></dt>

     <dd>

      <p>The kind of data:</p>

      <dl>

       <dt><i>Plain Unicode string</i></dt>
       <dd>
        <p>Text.</p>
       </dd>

<!-- DND-v3:
       <dt><i>Blob</i></dt>
       <dd>
        <p>Binary data.</p>
       </dd>
-->

       <dt><i>File</i></dt>
       <dd>
        <p>Binary data with a file name.</p>
       </dd>

<!-- DND-v4:
       <dt><i>Structured object</i></dt>
       <dd>
        <p>An object that will be cloned using the <span>structured clone</span> algorithm.</p>
       </dd>
-->

      </dl>

     </dd>

     <dt><dfn>The drag data item type string</dfn></dt>

     <dd>

      <p>A Unicode string giving the type or format of the data, generally given by a <span>MIME
      type</span>. Some values that are not <span data-x="MIME type">MIME types</span> are
      special-cased for legacy reasons. The API does not enforce the use of <span data-x="MIME
      type">MIME types</span>; other values can be used as well. In all cases, however, the values
      are all <span>converted to ASCII lowercase</span> by the API.</p>

      <p class="note">Strings that contain <span data-x="space character">space characters</span>
      cannot be used with the <code data-x="attr-dropzone">dropzone</code> attribute, so authors are
      encouraged to use only <span data-x="MIME type">MIME types</span> or custom strings (without
      spaces).</p>

      <p>There is a limit of one <i>Plain Unicode string</i> item per <span data-x="The drag data
      item type string">item type string</span>.</p> <!-- DND-v4: consider limiting the structured
      objects too -->

     </dd>

     <dt>The actual data</dt>

     <dd><p>A Unicode or binary string, in some cases with a file name (itself a Unicode string),
     <!-- (DND-v4:) or an object, --> as per <span>the drag data item kind</span>.</p></dd>

    </dl>

    <p>The <span>drag data store item list</span> is ordered in the order that the items were added
    to the list; most recently added last.</p>

   </li>

   <li>

    <p>The following information, used to generate the UI feedback during the drag:</p>

    <ul>

     <li>User-agent-defined default feedback information, known as the <dfn>drag data store default
     feedback</dfn>.</li>

     <li>Optionally, a bitmap image and the coordinate of a point within that image, known as the
     <dfn>drag data store bitmap</dfn> and <dfn>drag data store hot spot coordinate</dfn>.</li>

    </ul>

   </li>

   <li>

    <p>A <dfn>drag data store mode</dfn>, which is one of the following:</p>

    <dl>

     <dt><dfn data-x="concept-dnd-rw">Read/write mode</dfn></dt>
     <dd>

      <p>For the <code data-x="event-dnd-dragstart">dragstart</code> event. New data can be added to the
      <span>drag data store</span>.</p>

     </dd>

     <dt><dfn data-x="concept-dnd-ro">Read-only mode</dfn></dt>
     <dd>

      <p>For the <code data-x="event-dnd-drop">drop</code> event. The list of items representing dragged
      data can be read, including the data. No new data can be added.</p>

     </dd>

     <dt><dfn data-x="concept-dnd-p">Protected mode</dfn></dt>
     <dd>

      <p>For all other events. The formats and kinds in the <span>drag data store</span> list of
      items representing dragged data can be enumerated, but the data itself is unavailable and no
      new data can be added.</p>

     </dd>

    </dl>

   </li>

   <li>

    <p>A <dfn>drag data store allowed effects state</dfn>, which is a string.</p>

   </li>

  </ul>

  <p>When a <span>drag data store</span> is <dfn data-x="create a drag data store">created</dfn>, it
  must be initialized such that its <span>drag data store item list</span> is empty, it has no
  <span>drag data store default feedback</span>, it has no <span>drag data store bitmap</span> and
  <span>drag data store hot spot coordinate</span>, its <span>drag data store mode</span> is <span
  data-x="concept-dnd-p">protected mode</span>, and its <span>drag data store allowed effects
  state</span> is the string "<code
  data-x="dom-DataTransfer-effectAllowed-uninitialized">uninitialized</code>".</p>


  <h4>The <code>DataTransfer</code> interface</h4>

  <p><code>DataTransfer</code> objects are used to expose the <span>drag data store</span> that
  underlies a drag-and-drop operation.</p>

  <pre class="idl">interface <dfn>DataTransfer</dfn> {
  attribute DOMString <span data-x="dom-DataTransfer-dropEffect">dropEffect</span>;
  attribute DOMString <span data-x="dom-DataTransfer-effectAllowed">effectAllowed</span>;

  [SameObject] readonly attribute <span>DataTransferItemList</span> <span data-x="dom-DataTransfer-items">items</span>;

  void <span data-x="dom-DataTransfer-setDragImage">setDragImage</span>(Element image, long x, long y);

  /* old interface */
  [SameObject] readonly attribute DOMString[] <span data-x="dom-DataTransfer-types">types</span>;
  DOMString <span data-x="dom-DataTransfer-getData">getData</span>(DOMString format);
  void <span data-x="dom-DataTransfer-setData">setData</span>(DOMString format, DOMString data);
  void <span data-x="dom-DataTransfer-clearData">clearData</span>(optional DOMString format);
  [SameObject] readonly attribute <span>FileList</span> <span data-x="dom-DataTransfer-files">files</span>;
};</pre>

  <dl class="domintro">

   <dt><var>dataTransfer</var> . <code subdfn data-x="dom-DataTransfer-dropEffect">dropEffect</code> [ = <var>value</var> ]</dt>

   <dd>

    <p>Returns the kind of operation that is currently selected. If the kind of operation isn't one
    of those that is allowed by the <code
    data-x="dom-DataTransfer-effectAllowed">effectAllowed</code> attribute, then the operation will
    fail.</p>

    <p>Can be set, to change the selected operation.</p>

    <p>The possible values are "<code data-x="dom-DataTransfer-dropEffect-none">none</code>", "<code
    data-x="dom-DataTransfer-dropEffect-copy">copy</code>", "<code
    data-x="dom-DataTransfer-dropEffect-link">link</code>", and "<code
    data-x="dom-DataTransfer-dropEffect-move">move</code>".</p>

   </dd>


   <dt><var>dataTransfer</var> . <code subdfn data-x="dom-DataTransfer-effectAllowed">effectAllowed</code> [ = <var>value</var> ]</dt>

   <dd>

    <p>Returns the kinds of operations that are to be allowed.</p>

    <p>Can be set (during the <code data-x="event-dnd-dragstart">dragstart</code> event), to change
    the allowed operations.</p>

    <p>The possible values are "<code data-x="dom-DataTransfer-effectAllowed-none">none</code>",
    "<code data-x="dom-DataTransfer-effectAllowed-copy">copy</code>", "<code
    data-x="dom-DataTransfer-effectAllowed-copyLink">copyLink</code>", "<code
    data-x="dom-DataTransfer-effectAllowed-copyMove">copyMove</code>", "<code
    data-x="dom-DataTransfer-effectAllowed-link">link</code>", "<code
    data-x="dom-DataTransfer-effectAllowed-linkMove">linkMove</code>", "<code
    data-x="dom-DataTransfer-effectAllowed-move">move</code>", "<code
    data-x="dom-DataTransfer-effectAllowed-all">all</code>", and "<code
    data-x="dom-DataTransfer-effectAllowed-uninitialized">uninitialized</code>",</p>

   </dd>


   <dt><var>dataTransfer</var> . <code subdfn data-x="dom-DataTransfer-items">items</code></dt>

   <dd>

    <p>Returns a <code>DataTransferItemList</code> object, with the drag data.</p>

   </dd>


   <dt><var>dataTransfer</var> . <code subdfn data-x="dom-DataTransfer-setDragImage">setDragImage</code>(<var>element</var>, <var>x</var>, <var>y</var>)</dt>

   <dd>

    <p>Uses the given element to update the drag feedback, replacing any previously specified
    feedback.</p>

   </dd>


   <dt><var>dataTransfer</var> . <code subdfn data-x="dom-DataTransfer-types">types</code></dt>

   <dd>

    <p>Returns an array listing the formats that were set in the <code
    data-x="event-dnd-dragstart">dragstart</code> event. In addition, if any files are being dragged,
    then one of the types will be the string "<code>Files</code>".</p>

   </dd>


   <dt><var>data</var> = <var>dataTransfer</var> . <code subdfn data-x="dom-DataTransfer-getData">getData</code>(<var>format</var>)</dt>

   <dd>

    <p>Returns the specified data. If there is no such data, returns the empty string.</p>

   </dd>


   <dt><var>dataTransfer</var> . <code subdfn data-x="dom-DataTransfer-setData">setData</code>(<var>format</var>, <var>data</var>)</dt>

   <dd>

    <p>Adds the specified data.</p>

   </dd>


   <dt><var>dataTransfer</var> . <code subdfn data-x="dom-DataTransfer-clearData">clearData</code>( [ <var>format</var> ] )</dt>

   <dd>

    <p>Removes the data of the specified formats. Removes all data if the argument is omitted.</p>

   </dd>


   <dt><var>dataTransfer</var> . <code subdfn data-x="dom-DataTransfer-files">files</code></dt>

   <dd>

    <p>Returns a <code>FileList</code> of the files being dragged, if any.</p>

   </dd>

  </dl>

  <p><code>DataTransfer</code> objects are used during the <a href="#dndevents">drag-and-drop
  events</a>, and are only valid while those events are being fired.</p>

  <div class="impl">

  <p>A <code>DataTransfer</code> object is associated with a <span>drag data store</span> while it
  is valid.</p>

  <p>The <dfn><code data-x="dom-DataTransfer-dropEffect">dropEffect</code></dfn> attribute controls
  the drag-and-drop feedback that the user is given during a drag-and-drop operation. When the
  <code>DataTransfer</code> object is created, the <code
  data-x="dom-DataTransfer-dropEffect">dropEffect</code> attribute is set to a string value. On
  getting, it must return its current value. On setting, if the new value is one of "<dfn><code
  data-x="dom-DataTransfer-dropEffect-none">none</code></dfn>", "<dfn><code
  data-x="dom-DataTransfer-dropEffect-copy">copy</code></dfn>", "<dfn><code
  data-x="dom-DataTransfer-dropEffect-link">link</code></dfn>", or "<dfn><code
  data-x="dom-DataTransfer-dropEffect-move">move</code></dfn>", then the attribute's current value must be
  set to the new value. Other values must be ignored.</p>

  <p>The <dfn><code data-x="dom-DataTransfer-effectAllowed">effectAllowed</code></dfn> attribute is
  used in the drag-and-drop processing model to initialize the <code
  data-x="dom-DataTransfer-dropEffect">dropEffect</code> attribute during the <code
  data-x="event-dnd-dragenter">dragenter</code> and <code
  data-x="event-dnd-dragover">dragover</code> events. When the <code>DataTransfer</code> object is
  created, the <code data-x="dom-DataTransfer-effectAllowed">effectAllowed</code> attribute is set
  to a string value. On getting, it must return its current value. On setting, if <span>drag data
  store</span>'s <span data-x="drag data store mode">mode</span> is the <span
  data-x="concept-dnd-rw">read/write mode</span> and the new value is one of "<dfn><code
  data-x="dom-DataTransfer-effectAllowed-none">none</code></dfn>", "<dfn><code
  data-x="dom-DataTransfer-effectAllowed-copy">copy</code></dfn>", "<dfn><code
  data-x="dom-DataTransfer-effectAllowed-copyLink">copyLink</code></dfn>", "<dfn><code
  data-x="dom-DataTransfer-effectAllowed-copyMove">copyMove</code></dfn>", "<dfn><code
  data-x="dom-DataTransfer-effectAllowed-link">link</code></dfn>", "<dfn><code
  data-x="dom-DataTransfer-effectAllowed-linkMove">linkMove</code></dfn>", "<dfn><code
  data-x="dom-DataTransfer-effectAllowed-move">move</code></dfn>", "<dfn><code
  data-x="dom-DataTransfer-effectAllowed-all">all</code></dfn>", or "<dfn><code
  data-x="dom-DataTransfer-effectAllowed-uninitialized">uninitialized</code></dfn>", then the attribute's
  current value must be set to the new value. Otherwise it must be left unchanged.</p>

  <p>The <dfn><code data-x="dom-DataTransfer-items">items</code></dfn> attribute must return a
  <code>DataTransferItemList</code> object associated with the <code>DataTransfer</code> object.</p>

  <p>The <dfn><code data-x="dom-DataTransfer-setDragImage">setDragImage(<var>element</var>,
  <var>x</var>, <var>y</var>)</code></dfn> method must run the following steps:</p>

  <ol>

   <li><p>If the <code>DataTransfer</code> object is no longer associated with a <span>drag data
   store</span>, abort these steps. Nothing happens.</p></li>

   <li><p>If the <span>drag data store</span>'s <span data-x="drag data store mode">mode</span> is
   not the <span data-x="concept-dnd-rw">read/write mode</span>, abort these steps. Nothing
   happens.</p></li>

   <li><p>If the <var>element</var> argument is an <code>img</code> element, then set the <span>drag
   data store bitmap</span> to the element's image (at its
   <span data-x="intrinsic dimensions">intrinsic size</span>); otherwise, set the
   <span>drag data store bitmap</span> to an image generated from the given element (the exact
   mechanism for doing so is not currently specified).</p></li>

   <li><p>Set the <span>drag data store hot spot coordinate</span> to the given <var>x</var>,
   <var>y</var> coordinate.</p></li>

  </ol>

  <p>The <dfn><code data-x="dom-DataTransfer-types">types</code></dfn> attribute must return a
  <span>live</span> <span data-x="dfn-read-only-array">read only</span> array giving the strings
  that the following steps would produce.</p>

  <ol>

   <li><p>Start with an empty list <var>L</var>.</p></li>

   <li><p>If the <code>DataTransfer</code> object is no longer associated with a <span>drag data
   store</span>, the array is empty. Abort these steps; return the empty list <var>L</var>.</p></li>

   <li><p>For each item in the <span>drag data store item list</span> <!-- in some order...? -->
   whose <span data-x="the drag data item kind">kind</span> is <i>Plain Unicode string</i>, add an
   entry to the list <var>L</var> consisting of the item's <span data-x="the drag data item type
   string">type string</span>.</p></li>

   <li><p>If there are any items in the <span>drag data store item list</span> whose <span
   data-x="the drag data item kind">kind</span> is <i>File</i>, then add an entry to the list
   <var>L</var> consisting of the string "<code>Files</code>". (This value can be
   distinguished from the other values because it is not lowercase.)</p></li>

   <!-- <li><p>Sort the list...?</p></li> -->

   <li><p>The strings produced by these steps are those in the list <var>L</var>.</p></li>

  </ol>

  <p>The <dfn><code data-x="dom-DataTransfer-getData">getData(<var>format</var>)</code></dfn> method
  must run the following steps:</p>

  <ol>

   <li><p>If the <code>DataTransfer</code> object is no longer associated with a <span>drag data
   store</span>, return the empty string and abort these steps.</p></li>

   <li><p>If the <span>drag data store</span>'s <span data-x="drag data store mode">mode</span> is
   the <span data-x="concept-dnd-p">protected mode</span>, return the empty string and abort these
   steps.</p></li>

   <li><p>Let <var>format</var> be the first argument, <span>converted to ASCII
   lowercase</span>.</p></li>

   <li><p>Let <var>convert-to-URL</var> be false.</p></li>

   <li><p>If <var>format</var> equals "<code>text</code>", change it to "<code
  >text/plain</code>".</p></li>

   <li><p>If <var>format</var> equals "<code>url</code>", change it to "<code
  >text/uri-list</code>" and set <var>convert-to-URL</var> to true.</p></li>

   <li><p>If there is no item in the <span>drag data store item list</span> whose <span data-x="the
   drag data item kind">kind</span> is <i>Plain Unicode string</i> and whose <span data-x="the drag
   data item type string">type string</span> is equal to <var>format</var>, return the empty string
   and abort these steps.</p></li>

   <li><p>Let <var>result</var> be the data of the item in the <span>drag data store item
   list</span> whose <span data-x="the drag data item kind">kind</span> is <i>Plain Unicode
   string</i> and whose <span data-x="the drag data item type string">type string</span> is equal to
   <var>format</var>.</p></li>

   <li><p>If <var>convert-to-URL</var> is true, then parse <var>result</var> as appropriate for
   <code>text/uri-list</code> data, and then set <var>result</var> to the first URL from
   the list, if any, or the empty string otherwise. <a href="#refsRFC2483">\[RFC2483]</a></p></li>

   <li><p>Return <var>result</var>.</p></li>

  </ol>

  <p>The <dfn><code data-x="dom-DataTransfer-setData">setData(<var>format</var>,
  <var>data</var>)</code></dfn> method must run the following steps:</p>

  <ol>

   <li><p>If the <code>DataTransfer</code> object is no longer associated with a <span>drag data
   store</span>, abort these steps. Nothing happens.</p></li>

   <li><p>If the <span>drag data store</span>'s <span data-x="drag data store mode">mode</span> is
   not the <span data-x="concept-dnd-rw">read/write mode</span>, abort these steps. Nothing
   happens.</p></li>

   <li><p>Let <var>format</var> be the first argument, <span>converted to ASCII
   lowercase</span>.</p></li>

   <li>

    <p>If <var>format</var> equals "<code>text</code>", change it to "<code
   >text/plain</code>".</p>

    <p>If <var>format</var> equals "<code>url</code>", change it to "<code
   >text/uri-list</code>".</p>

   </li>

   <li><p>Remove the item in the <span>drag data store item list</span> whose <span data-x="the drag
   data item kind">kind</span> is <i>Plain Unicode string</i> and whose <span data-x="the drag data
   item type string">type string</span> is equal to <var>format</var>, if there is
   one.</p></li>

   <li><p>Add an item to the <span>drag data store item list</span> whose <span data-x="the drag data
   item kind">kind</span> is <i>Plain Unicode string</i>, whose <span data-x="the drag data item type
   string">type string</span> is equal to <var>format</var>, and whose data is the string
   given by the method's second argument.</p></li>

  </ol>

  <p>The <dfn><code data-x="dom-DataTransfer-clearData">clearData()</code></dfn> method must run the
  following steps:</p>

  <ol>

   <li><p>If the <code>DataTransfer</code> object is no longer associated with a <span>drag data
   store</span>, abort these steps. Nothing happens.</p></li>

   <li><p>If the <span>drag data store</span>'s <span data-x="drag data store mode">mode</span> is
   not the <span data-x="concept-dnd-rw">read/write mode</span>, abort these steps. Nothing
   happens.</p></li>

   <li><p>If the method was called with no arguments, remove each item in the <span>drag data store
   item list</span> whose <span data-x="the drag data item kind">kind</span> is <i>Plain Unicode
   string</i>, and abort these steps.</p></li>

   <li><p>Let <var>format</var> be the first argument, <span>converted to ASCII
   lowercase</span>.</p></li>

   <li>

    <p>If <var>format</var> equals "<code>text</code>", change it to "<code
   >text/plain</code>".</p>

    <p>If <var>format</var> equals "<code>url</code>", change it to "<code
   >text/uri-list</code>".</p>

   </li>

   <li><p>Remove the item in the <span>drag data store item list</span> whose <span data-x="the drag
   data item kind">kind</span> is <i>Plain Unicode string</i> and whose <span data-x="the drag data
   item type string">type string</span> is equal to <var>format</var>, if there is
   one.</p></li>

  </ol>

  <p class="note">The <code data-x="dom-DataTransfer-clearData">clearData()</code> method does not
  affect whether any files were included in the drag, so the <code
  data-x="dom-DataTransfer-types">types</code> attribute's list might still not be empty after
  calling <code data-x="dom-DataTransfer-clearData">clearData()</code> (it would still contain the
  "<code>Files</code>" string if any files were included in the drag).</p>

  <p>The <dfn><code data-x="dom-DataTransfer-files">files</code></dfn> attribute must return a
  <span>live</span> <code>FileList</code> sequence consisting of <code>File</code> objects
  representing the files found by the following steps.
  Furthermore, for a given <code>FileList</code> object and a given underlying file, the same
  <code>File</code> object must be used each time.</p>

  <ol>

   <li><p>Start with an empty list <var>L</var>.</p></li>

   <li><p>If the <code>DataTransfer</code> object is no longer associated with a <span>drag data
   store</span>, the <code>FileList</code> is empty. Abort these steps; return the empty list <var>L</var>.</p></li>

   <li><p>If the <span>drag data store</span>'s <span data-x="drag data store mode">mode</span> is
   the <span data-x="concept-dnd-p">protected mode</span>, abort these steps; return the empty list
   <var>L</var>.</p></li>

   <li><p>For each item in the <span>drag data store item list</span> <!-- in some order...? -->
   whose <span data-x="the drag data item kind">kind</span> is <i>File</i> <!-- DND-v3: (not
   <i>Blob</i>) -->, add the item's data (the file, in particular its name and contents, as well as
   its <span data-x="the drag data item type string">type</span>) to the list <var>L</var>.</p></li>

   <!-- <li><p>Sort the list...?</p></li> -->

   <li><p>The files found by these steps are those in the list <var>L</var>.</p></li>

  </ol>

  <p class="note">This version of the API does not expose the types of the files during the
  drag.</p>

  </div>


  <h5>The <code>DataTransferItemList</code> interface</h5>

  <p>Each <code>DataTransfer</code> object is associated with a <code>DataTransferItemList</code>
  object.</p>

  <pre class="idl">interface <dfn>DataTransferItemList</dfn> {
  readonly attribute unsigned long <span data-x="dom-DataTransferItemList-length">length</span>;
  <span data-x="dom-DataTransferItemList-item">getter</span> <span>DataTransferItem</span> (unsigned long index);
  <span>DataTransferItem</span>? <span data-x="dom-DataTransferItemList-add">add</span>(DOMString data, DOMString type);<!--
DND-v3:  <span>DataTransferItem</span>? <span data-x="dom-DataTransferItemList-add">add</span>(<span>Blob</span> data);-->
  <span>DataTransferItem</span>? <span data-x="dom-DataTransferItemList-add">add</span>(<span>File</span> data);<!--
DND-v4:  <span>DataTransferItem</span>? <span data-x="dom-DataTransferItemList-add">add</span>(any data, DOMString type);--><!--
DND-v5:  <span>DataTransferItem</span>? <span data-x="dom-DataTransferItemList-add">add</span>(<span>DataTransferPromise</span> data);-->
  void <span data-x="dom-DataTransferItemList-remove">remove</span>(unsigned long index);
  void <span data-x="dom-DataTransferItemList-clear">clear</span>();
};</pre>

  <dl class="domintro">

   <dt><var>items</var> . <code subdfn data-x="dom-DataTransferItemList-length">length</code></dt>

   <dd><p>Returns the number of items in the <span>drag data store</span>.</p></dd>


   <dt><var>items</var>[<var>index</var>]</dt>

   <dd>

    <p>Returns the <code>DataTransferItem</code> object representing the <var>index</var>th
    entry in the <span>drag data store</span>.</p>

   </dd>


   <dt><var>items</var> . <code subdfn data-x="dom-DataTransferItemList-remove">remove</code>(<var>index</var>)</dt>

   <dd>

    <p>Removes the <var>index</var>th entry in the <span>drag data store</span>.</p>

   </dd>


   <dt><var>items</var> . <code subdfn data-x="dom-DataTransferItemList-clear">clear</code>()</dt>

   <dd>

    <p>Removes all the entries in the <span>drag data store</span>.</p>

   </dd>


   <dt><var>items</var> . <code subdfn data-x="dom-DataTransferItemList-add">add</code>(<var>data</var>)</dt>
   <dt><var>items</var> . <code data-x="dom-DataTransferItemList-add">add</code>(<var>data</var>, <var>type</var>)</dt>

   <dd>

    <p>Adds a new entry for the given data to the <span>drag data store</span>. If the data is plain
    text <!-- DND-v4: or an object --> then a <var>type</var> string has to be provided
    also.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>While the <code>DataTransferItemList</code> object's <code>DataTransfer</code> object is
  associated with a <span>drag data store</span>, the <code>DataTransferItemList</code> object's
  <i>mode</i> is the same as the <span>drag data store mode</span>. When the
  <code>DataTransferItemList</code> object's <code>DataTransfer</code> object is <em>not</em>
  associated with a <span>drag data store</span>, the <code>DataTransferItemList</code> object's
  <i>mode</i> is the <i>disabled mode</i>. The <span>drag data store</span> referenced in this
  section (which is used only when the <code>DataTransferItemList</code> object is not in the
  <i>disabled mode</i>) is the <span>drag data store</span> with which the
  <code>DataTransferItemList</code> object's <code>DataTransfer</code> object is associated.</p>

  <p>The <dfn><code data-x="dom-DataTransferItemList-length">length</code></dfn> attribute must
  return zero if the object is in the <i>disabled mode</i>; otherwise it must return the number of
  items in the <span>drag data store item list</span>.</p>

  <p>When a <code>DataTransferItemList</code> object is not in the <i>disabled mode</i>, its
  <span>supported property indices</span> are the numbers in the range

    <span>0 .. <var>n</var>-1</span>,

  where <var>n</var> is the number of items in the <span>drag data store item
  list</span>.</p>

  <p>To <dfn data-x="dom-DataTransferItemList-item">determine the value of an indexed property</dfn>
  <var>i</var> of a <code>DataTransferItemList</code> object, the user agent must return a
  <code>DataTransferItem</code> object representing the <var>i</var>th item in the
  <span>drag data store</span>. The same object must be returned each time a particular item is
  obtained from this <code>DataTransferItemList</code> object. The <code>DataTransferItem</code>
  object must be associated with the same <code>DataTransfer</code> object as the
  <code>DataTransferItemList</code> object when it is first created.</p>

  <p>The <dfn><code data-x="dom-DataTransferItemList-add">add()</code></dfn> method must run the
  following steps:</p>

  <ol>

   <li><p>If the <code>DataTransferItemList</code> object is not in the <i
   data-x="concept-dnd-rw">read/write mode</i>, return null and abort these steps.</p></li>

   <li>

    <p>Jump to the appropriate set of steps from the following list:</p>

    <dl class="switch">

     <dt>If the first argument to the method is a string</dt>

     <dd>

      <p>If there is already an item in the <span>drag data store item list</span> whose <span
      data-x="the drag data item kind">kind</span> is <i>Plain Unicode string</i> and whose <span
      data-x="the drag data item type string">type string</span> is equal to the value of the
      method's second argument, <span>converted to ASCII lowercase</span>, then throw a
      <code>NotSupportedError</code> exception and abort these steps.</p>

      <p>Otherwise, add an item to the <span>drag data store item list</span> whose <span data-x="the
      drag data item kind">kind</span> is <i>Plain Unicode string</i>, whose <span data-x="the drag
      data item type string">type string</span> is equal to the value of the method's second
      argument, <span>converted to ASCII lowercase</span>, and whose data is the string given by the
      method's first argument.</p>

     </dd>

<!--DND-v3:
     <dt>If the first argument to the method is a <code>Blob</code></dt>

     <dd>

      <p>Add an item to the <span>drag data store item list</span> whose <span data-x="the drag data
      item kind">kind</span> is <i>Blob</i>, whose <span data-x="the drag data item type string">type
      string</span> is the <code data-x="dom-Blob-type">type</code> of the <code>Blob</code>,
      <span>converted to ASCII lowercase</span>, and whose data is the same as the
      <code>Blob</code>'s data.</p>

     </dd>
-->

     <dt>If the first argument to the method is a <code>File</code></dt>

     <dd>

      <p>Add an item to the <span>drag data store item list</span> whose <span data-x="the drag data
      item kind">kind</span> is <i>File</i>, whose <span data-x="the drag data item type string">type
      string</span> is the <code data-x="dom-Blob-type">type</code> of the <code>File</code>,
      <span>converted to ASCII lowercase</span>, and whose data is the same as the
      <code>File</code>'s data.</p>

     </dd>

<!--DND-v4: (might want to prevent duplicates like for strings; see above)
[make sure that the cloning happens before any side-effects can happen]
     <dt>Otherwise

     <dd>

      <p>Add an item to the <span>drag data store item list</span> whose <span data-x="the drag data
      item kind">kind</span> is <i>Object</i>, whose <span data-x="the drag data item type
      string">type string</span> is equal to the value of the method's second argument,
      <span>converted to ASCII lowercase</span>, and whose data is a <span>structured clone</span>
      of the method's first argument. If creating the clone throws an exception, then throw that
      exception and abort these steps.</p>

     </dd>
-->

    </dl>

   </li>

   <li><p><span data-x="dom-DataTransferItemList-item">Determine the value of the indexed
   property</span> corresponding to the newly added item, and return that value (a newly created
   <code>DataTransferItem</code> object).</p></li>

  </ol>

  <p>The <dfn><code data-x="dom-DataTransferItemList-remove">remove()</code></dfn> method, when
  invoked with the argument <var>i</var>, must run these steps:</p>

  <ol>

   <li><p>If the <code>DataTransferItemList</code> object is not in the <i
   data-x="concept-dnd-rw">read/write mode</i>, throw an <code>InvalidStateError</code> exception and
   abort these steps.</p></li>

   <li><p>Remove the <var>i</var>th item from the <span>drag data store</span>.</p></li>

  </ol>

  <p>The <dfn><code data-x="dom-DataTransferItemList-clear">clear</code></dfn> method, if the
  <code>DataTransferItemList</code> object is in the <i data-x="concept-dnd-rw">read/write mode</i>,
  must remove all the items from the <span>drag data store</span>. Otherwise, it must do
  nothing.</p>

  </div>


  <h5>The <code>DataTransferItem</code> interface</h5>

  <p>Each <code>DataTransferItem</code> object is associated with a <code>DataTransfer</code>
  object.</p>

  <pre class="idl">interface <dfn>DataTransferItem</dfn> {
  readonly attribute DOMString <span data-x="dom-DataTransferItem-kind">kind</span>;
  readonly attribute DOMString <span data-x="dom-DataTransferItem-type">type</span>;
  void <span data-x="dom-DataTransferItem-getAsString">getAsString</span>(<span>FunctionStringCallback</span>? _callback);<!--
DND-v3:  <span>Blob</span> <span data-x="dom-DataTransferItem-getAsBlob">getAsBlob</span>();-->
  <span>File</span>? <span data-x="dom-DataTransferItem-getAsFile">getAsFile</span>();<!--
DND-v4:  void <span data-x="dom-DataTransferItem-getAsObject">getAsObject</span>(<span>FunctionObjectCallback</span> _callback);-->
};

callback <dfn>FunctionStringCallback</dfn> = void (DOMString data);<!--

// DND-v4:
callback <dfn>FunctionObjectCallback</dfn> = void (any data);--></pre>

  <dl class="domintro">

   <dt><var>item</var> . <code subdfn data-x="dom-DataTransferItem-kind">kind</code></dt>
   <dd>

    <p>Returns <span>the drag data item kind</span>, one of: "string",
    <!-- DND-v3: "blob", --> "file"<!-- DND-v4: , "object" -->.</p>

   </dd>

   <dt><var>item</var> . <code subdfn data-x="dom-DataTransferItem-type">type</code></dt>
   <dd>

    <p>Returns <span>the drag data item type string</span>.</p>

   </dd>

   <dt><var>item</var> . <code subdfn data-x="dom-DataTransferItem-getAsString">getAsString</code>(<var>callback</var>)</dt>
   <dd>

    <p>Invokes the callback with the string data as the argument, if <span>the drag data item
    kind</span> is <i>Plain Unicode string</i>.</p>

   </dd>

<!-- DND-v3:
   <dt><var>file</var> = <var>item</var> . <code subdfn data-x="dom-DataTransferItem-getAsBlob">getAsBlob</code>()</dt>
   <dd>

    <p>Returns a <code>Blob</code> object, if <span>the drag data item kind</span> is <i>Blob</i> or <i>File</i>.</p>

   </dd>
-->

   <dt><var>file</var> = <var>item</var> . <code subdfn data-x="dom-DataTransferItem-getAsFile">getAsFile</code>()</dt>
   <dd>

    <p>Returns a <code>File</code> object, if <span>the drag data item kind</span> is <i>File</i>.</p>

   </dd>

<!-- DND-v4:
   <dt><var>file</var> = <var>item</var> . <code subdfn data-x="dom-DataTransferItem-getAsObject">getAsObject</code>()</dt>
   <dd>

    <p>Invokes the callback with the cloned object data as the argument, if <span>the drag data item
    kind</span> is <i>Plain Unicode string</i> or <i>Object</i>.</p>

   </dd>
-->

  </dl>

  <div class="impl">

  <p>While the <code>DataTransferItem</code> object's <code>DataTransfer</code> object is associated
  with a <span>drag data store</span> and that <span>drag data store</span>'s <span>drag data store
  item list</span> still contains the item that the <code>DataTransferItem</code> object represents,
  the <code>DataTransferItem</code> object's <i>mode</i> is the same as the <span>drag data store
  mode</span>. When the <code>DataTransferItem</code> object's <code>DataTransfer</code> object is
  <em>not</em> associated with a <span>drag data store</span>, or if the item that the
  <code>DataTransferItem</code> object represents has been removed from the relevant <span>drag data
  store item list</span>, the <code>DataTransferItem</code> object's <i>mode</i> is the <i>disabled
  mode</i>. The <span>drag data store</span> referenced in this section (which is used only when the
  <code>DataTransferItem</code> object is not in the <i>disabled mode</i>) is the <span>drag data
  store</span> with which the <code>DataTransferItem</code> object's <code>DataTransfer</code>
  object is associated.</p>

  <p>The <dfn><code data-x="dom-DataTransferItem-kind">kind</code></dfn> attribute must return the
  empty string if the <code>DataTransferItem</code> object is in the <i>disabled mode</i>; otherwise
  it must return the string given in the cell from the second column of the following table from the
  row whose cell in the first column contains <span>the drag data item kind</span> of the item
  represented by the <code>DataTransferItem</code> object:</p>

  <table>
   <thead>
    <tr> <th> Kind <th> String
   <tbody>
    <tr> <td> <i>Plain Unicode string</i> <td> "<code>string</code>"
<!-- DND-v3:    <tr> <td> <i>Blob</i> <td> "<code>blob</code>"-->
    <tr> <td> <i>File</i> <td> "<code>file</code>"
<!-- DND-v4:    <tr> <td> <i>Object</i> <td> "<code>object</code>"-->
  </table>

  <p>The <dfn><code data-x="dom-DataTransferItem-type">type</code></dfn> attribute must return the
  empty string if the <code>DataTransferItem</code> object is in the <i>disabled mode</i>; otherwise
  it must return <span>the drag data item type string</span> of the item represented by the
  <code>DataTransferItem</code> object.</p>

  <p>The <dfn><code data-x="dom-DataTransferItem-getAsString">getAsString(<var>callback</var>)</code></dfn> method must run the following steps:</p>

  <ol>

   <li><p>If the <var>callback</var> is null, abort these steps.</p></li>

   <li><p>If the <code>DataTransferItem</code> object is not in the <i
   data-x="concept-dnd-rw">read/write mode</i> or the <i data-x="concept-dnd-ro">read-only mode</i>,
   abort these steps. The callback is never invoked.</p></li>

   <li><p>If <span>the drag data item kind</span> is not <i>Plain Unicode string</i>, abort these
   steps. The callback is never invoked.</p></li>

   <li><p>Otherwise, <span>queue a task</span> to invoke <var>callback</var>, passing the
   actual data of the item represented by the <code>DataTransferItem</code> object as the
   argument.</p></li>

  </ol>

<!--DND-v3:
  <p>The <dfn><code data-x="dom-DataTransferItem-getAsBlob">getAsBlob()</code></dfn> method must run
  the following steps:</p>

  <ol>

   <li><p>If the <code>DataTransferItem</code> object is not in the <i
   data-x="concept-dnd-rw">read/write mode</i> or the <i data-x="concept-dnd-ro">read-only mode</i>,
   return null and abort these steps.</p></li>

   <li>

--><!--DND-v4:
    <p>If <span>the drag data item kind</span> is <i>Object</i>, return null.</p></li>
--><!--DND-v3:

    <p>If <span>the drag data item kind</span> is <i>File</i>, then return a new <code>File</code>
    object representing the actual data of the item represented by the <code>DataTransferItem</code>
    object.</p>

    <p>If <span>the drag data item kind</span> is <i>Unicode Data string</i>, then return a new
    <code>Blob</code> object representing the actual data of the item represented by the
    <code>DataTransferItem</code> object, with the <code data-x="dom-Blob-type">type</code> of the
    <code>Blob</code> being <span>the drag data item type string</span> and with the binary data of
    the <code>Blob</code> object being the Unicode string encoded as UTF-8. <a href="#refsENCODING">\[ENCODING]</a></p>

    <p>Otherwise, <span>the drag data item kind</span> is <i>Blob</i>; return a new
    <code>Blob</code> object representing the actual data of the item represented by the
    <code>DataTransferItem</code> object.</p>

   </li>

  </ol>
-->

  <p>The <dfn><code data-x="dom-DataTransferItem-getAsFile">getAsFile()</code></dfn>
  method must run the following steps:</p>

  <ol>

   <li><p>If the <code>DataTransferItem</code> object is not in the <i
   data-x="concept-dnd-rw">read/write mode</i> or the <i data-x="concept-dnd-ro">read-only mode</i>,
   return null and abort these steps.</p></li>

   <li><p>If <span>the drag data item kind</span> is not <i>File</i>, then return null and abort
   these steps.</p></li>

   <li><p>Return a new <code>File</code> object representing the actual data of the item represented
   by the <code>DataTransferItem</code> object.</p>

  </ol>

<!--DND-v4:
  <p>The <dfn><code data-x="dom-DataTransferItem-getAsObject">getAsObject(<var>callback</var>)</code></dfn> method must run the following steps:</p>

  <ol>

   <li><p>If the <code>DataTransferItem</code> object is not in the <i
   data-x="concept-dnd-rw">read/write mode</i> or the <i data-x="concept-dnd-ro">read-only mode</i>,
   return null and abort these steps.</p></li>

   <li>

    <p>Let <var>data</var> be the actual data of the item represented by the
    <code>DataTransferItem</code> object.</p>

    <p>If <span>the drag data item kind</span> is <i>Unicode Data string</i>, then <var>data</var>
    is a <code data-x="idl-DOMString">DOMString</code> containing the actual data.</p>

    <p>If <span>the drag data item kind</span> is <i>Blob</i>, then <var>data</var> is a
    <code>Blob</code> representing the actual data.</p>

    <p>If <span>the drag data item kind</span> is <i>File</i>, then <var>data</var> is a
    <code>File</code> representing the actual data.</p>

    <p>If <span>the drag data item kind</span> is <i>Object</i>, then <var>data</var> is the object
    that is the actual data.</p>

   </li>

   <li><span>Queue a task</span> to invoke <var>callback</var>, passing a <span>structured
   clone</span> of <var>data</var> as the argument.</p></li>

  </ol>
-->

  </div>



  <h4>The <code>DragEvent</code> interface</h4>

  <p>The drag-and-drop processing model involves several events. They all use the
  <code>DragEvent</code> interface.</p>

  <pre class="idl">[Constructor(DOMString type, optional <span>DragEventInit</span> eventInitDict)]
interface <dfn>DragEvent</dfn> : <span>MouseEvent</span> {
  readonly attribute <span>DataTransfer</span>? <span data-x="dom-DragEvent-dataTransfer">dataTransfer</span>;
};

dictionary <dfn>DragEventInit</dfn> : <span>MouseEventInit</span> {
  <span>DataTransfer</span>? dataTransfer = null;
};</pre>

  <dl class="domintro">

   <dt><var>event</var> . <code subdfn data-x="dom-DragEvent-dataTransfer">dataTransfer</code></dt>

   <dd>

    <p>Returns the <code>DataTransfer</code> object for the event.</p>

   </dd>

  </dl>

  <p class="note">Although, for consistency with other event interfaces, the <code>DragEvent</code>
  interface has a constructor, it is not particularly useful. In particular, there's no way to
  create a useful <code>DataTransfer</code> object from script, as <code>DataTransfer</code> objects
  have a processing and security model that is coordinated by the browser during drag-and-drops.</p>

  <div class="impl">

  <p>The <dfn><code data-x="dom-DragEvent-dataTransfer">dataTransfer</code></dfn> attribute of the
  <code>DragEvent</code> interface must return the value it was initialized to. It represents the
  context information for the event.</p>

  </div>

  <div class="impl">

  <p>When a user agent is required to <dfn>fire a DND event</dfn> named <var>e</var> at an element,
  using a particular <span>drag data store</span>, and optionally with a specific <var>related
  target</var>, the user agent must run the following steps:</p>

  <ol>

   <li><p>If no specific <var>related target</var> was provided, set <var>related target</var> to
   null.</p></li>

   <li><p>Let <var>window</var> be the <code>Window</code> object of the <code>Document</code>
   object of the specified target element.</p></li>

   <li>

    <p>If <var>e</var> is <code data-x="event-dnd-dragstart">dragstart</code>, set the <span>drag
    data store mode</span> to the <span data-x="concept-dnd-rw">read/write mode</span>.</p>

    <p>If <var>e</var> is <code data-x="event-dnd-drop">drop</code>, set the <span>drag data store
    mode</span> to the <span data-x="concept-dnd-ro">read-only mode</span>.</p>

   </li>

   <li><p>Let <var>dataTransfer</var> be a newly created <code>DataTransfer</code> object
   associated with the given <span>drag data store</span>.</p></li>

   <li><p id="effectAllowed-initialisation">Set the <code
   data-x="dom-DataTransfer-effectAllowed">effectAllowed</code> attribute to the <span>drag data
   store</span>'s <span>drag data store allowed effects state</span>.</p></li>

   <li>

    <p id="dropEffect-initialisation">Set the <code
    data-x="dom-DataTransfer-dropEffect">dropEffect</code> attribute to "<code
    data-x="dom-DataTransfer-dropEffect-none">none</code>" if <var>e</var> is <code
    data-x="event-dnd-dragstart">dragstart</code>, <code data-x="event-dnd-drag">drag</code>, <code
    data-x="event-dnd-dragexit">dragexit</code>, or <code
    data-x="event-dnd-dragleave">dragleave</code>; to the value corresponding to the <span>current
    drag operation</span> if <var>e</var> is <code data-x="event-dnd-drop">drop</code> or
    <code data-x="event-dnd-dragend">dragend</code>; and to a value based on the <code
    data-x="dom-DataTransfer-effectAllowed">effectAllowed</code> attribute's value and the
    drag-and-drop source, as given by the following table, otherwise (i.e. if <var>e</var>
    is <code data-x="event-dnd-dragenter">dragenter</code> or <code
    data-x="event-dnd-dragover">dragover</code>):</p>

    <table>
     <thead>
      <tr>
       <th><code data-x="dom-DataTransfer-effectAllowed">effectAllowed</code></th>
       <th><code data-x="dom-DataTransfer-dropEffect">dropEffect</code></th>
      </tr>
     </thead>
     <tr>
      <td>"<code data-x="dom-DataTransfer-effectAllowed-none">none</code>"</td>
      <td>"<code data-x="dom-DataTransfer-dropEffect-none">none</code>"</td>
     </tr>
     <tr>
      <td>"<code data-x="dom-DataTransfer-effectAllowed-copy">copy</code>"</td>
      <td>"<code data-x="dom-DataTransfer-dropEffect-copy">copy</code>"</td>
     </tr>
     <tr>
      <td>"<code data-x="dom-DataTransfer-effectAllowed-copyLink">copyLink</code>"</td>
      <td>"<code data-x="dom-DataTransfer-dropEffect-copy">copy</code>", or, <span data-x="concept-platform-dropEffect-override">if appropriate</span>, "<code data-x="dom-DataTransfer-dropEffect-link">link</code>"</td>
     </tr>
     <tr>
      <td>"<code data-x="dom-DataTransfer-effectAllowed-copyMove">copyMove</code>"</td>
      <td>"<code data-x="dom-DataTransfer-dropEffect-copy">copy</code>", or, <span data-x="concept-platform-dropEffect-override">if appropriate</span>, "<code data-x="dom-DataTransfer-dropEffect-move">move</code>"</td>
     </tr>
     <tr>
      <td>"<code data-x="dom-DataTransfer-effectAllowed-all">all</code>"</td>
      <td>"<code data-x="dom-DataTransfer-dropEffect-copy">copy</code>", or, <span data-x="concept-platform-dropEffect-override">if appropriate</span>, either "<code data-x="dom-DataTransfer-dropEffect-link">link</code>" or "<code data-x="dom-DataTransfer-dropEffect-move">move</code>"</td>
     </tr>
     <tr>
      <td>"<code data-x="dom-DataTransfer-effectAllowed-link">link</code>"</td>
      <td>"<code data-x="dom-DataTransfer-dropEffect-link">link</code>"</td>
     </tr>
     <tr>
      <td>"<code data-x="dom-DataTransfer-effectAllowed-linkMove">linkMove</code>"</td>
      <td>"<code data-x="dom-DataTransfer-dropEffect-link">link</code>", or, <span data-x="concept-platform-dropEffect-override">if appropriate</span>, "<code data-x="dom-DataTransfer-dropEffect-move">move</code>"</td>
     </tr>
     <tr>
      <td>"<code data-x="dom-DataTransfer-effectAllowed-move">move</code>"</td>
      <td>"<code data-x="dom-DataTransfer-dropEffect-move">move</code>"</td>
     </tr>
     <tr>
      <td>"<code data-x="dom-DataTransfer-effectAllowed-uninitialized">uninitialized</code>" when what is being dragged is a selection from a text field</td>
      <td>"<code data-x="dom-DataTransfer-dropEffect-move">move</code>", or, <span data-x="concept-platform-dropEffect-override">if appropriate</span>, either "<code data-x="dom-DataTransfer-dropEffect-copy">copy</code>" or "<code data-x="dom-DataTransfer-dropEffect-link">link</code>"</td>
     </tr>
     <tr>
      <td>"<code data-x="dom-DataTransfer-effectAllowed-uninitialized">uninitialized</code>" when what is being dragged is a selection</td>
      <td>"<code data-x="dom-DataTransfer-dropEffect-copy">copy</code>", or, <span data-x="concept-platform-dropEffect-override">if appropriate</span>, either "<code data-x="dom-DataTransfer-dropEffect-link">link</code>" or "<code data-x="dom-DataTransfer-dropEffect-move">move</code>"</td>
     </tr>
     <tr>
      <td>"<code data-x="dom-DataTransfer-effectAllowed-uninitialized">uninitialized</code>" when what is being dragged is an <code>a</code> element with an <code data-x="attr-hyperlink-href">href</code> attribute</td>
      <td>"<code data-x="dom-DataTransfer-dropEffect-link">link</code>", or, <span data-x="concept-platform-dropEffect-override">if appropriate</span>, either "<code data-x="dom-DataTransfer-dropEffect-copy">copy</code>" or "<code data-x="dom-DataTransfer-dropEffect-move">move</code>"</td>
     </tr>
     <tr>
      <td>Any other case</td>
      <td>"<code data-x="dom-DataTransfer-dropEffect-copy">copy</code>", or, <span data-x="concept-platform-dropEffect-override">if appropriate</span>, either "<code data-x="dom-DataTransfer-dropEffect-link">link</code>" or "<code data-x="dom-DataTransfer-dropEffect-move">move</code>"</td>
     </tr>
    </table>

    <p>Where the table above provides <dfn data-x="concept-platform-dropEffect-override">possibly
    appropriate alternatives</dfn>, user agents may instead use the listed alternative values if
    platform conventions dictate that the user has requested those alternate effects.</p>

    <p class="example">For example, Windows platform conventions are such that dragging while
    holding the "alt" key indicates a preference for linking the data, rather than moving or copying
    it. Therefore, on a Windows system, if "<code data-x="dom-DataTransfer-dropEffect-link">link</code>" is an option according to
    the table above while the "alt" key is depressed, the user agent could select that instead of
    "<code data-x="dom-DataTransfer-dropEffect-copy">copy</code>" or "<code data-x="dom-DataTransfer-dropEffect-move">move</code>".</p>

   </li>

   <li>

    <p>Create a <span data-x="concept-events-trusted">trusted</span> <code>DragEvent</code> object
    and initialize it to have the given name <var>e</var>, to bubble, to be cancelable unless
    <var>e</var> is <code data-x="event-dnd-dragexit">dragexit</code>, <code
    data-x="event-dnd-dragleave">dragleave</code>, or <code
    data-x="event-dnd-dragend">dragend</code>, and to have the <code
    data-x="dom-UIEvent-view">view</code> attribute initialized to <var>window</var>, the <code
    data-x="dom-UIEvent-detail">detail</code> attribute initialized to zero, the mouse and key
    attributes initialized according to the state of the input devices as they would be for user
    interaction events, the <code data-x="dom-MouseEvent-relatedTarget">relatedTarget</code>
    attribute initialized to <var>related target</var>, and the <code
    data-x="dom-DragEvent-dataTransfer">dataTransfer</code> attribute initialized to
    <var>dataTransfer</var>, the <code>DataTransfer</code> object created above.</p>

    <!-- interaction event spec point -->

    <p>If there is no relevant pointing device, the object must have its <code
   >screenX</code>, <code>screenY</code>, <code>clientX</code>, <code
   >clientY</code>, and <code>button</code> attributes set to 0.</p>

   </li>

   <li><p><span data-x="concept-event-dispatch">Dispatch</span> the newly created
   <code>DragEvent</code> object at the specified target element.</p></li>

   <li><p>Set the <span>drag data store allowed effects state</span> to the current value of
   <var>dataTransfer</var>'s <code data-x="dom-DataTransfer-effectAllowed">effectAllowed</code>
   attribute. (It can only have changed value if <var>e</var> is <code
   data-x="event-dnd-dragstart">dragstart</code>.)</p></li>

   <li><p>Set the <span>drag data store mode</span> back to the <span
   data-x="concept-dnd-p">protected mode</span> if it was changed in the first step.</p></li>

   <li><p>Break the association between <var>dataTransfer</var> and the <span>drag data
   store</span>.</p></li>

  </ol>

  </div>


  <div class="impl">

  <h4 id="drag-and-drop-processing-model">Drag-and-drop processing model</h4>

  <p>When the user attempts to begin a drag operation, the user agent must run the following steps.
  User agents must act as if these steps were run even if the drag actually started in another
  document or application and the user agent was not aware that the drag was occurring until it
  intersected with a document under the user agent's purview.</p>

  <ol>

   <li>

    <p>Determine what is being dragged, as follows:</p>

    <p>If the drag operation was invoked on a selection, then it is the selection that is being
    dragged.</p>

    <p>Otherwise, if the drag operation was invoked on a <code>Document</code>, it is the first
    element, going up the ancestor chain, starting at the node that the user tried to drag, that has
    the IDL attribute <code data-x="dom-draggable">draggable</code> set to true. If there is no such
    element, then nothing is being dragged; abort these steps, the drag-and-drop operation is never
    started.</p>

    <p>Otherwise, the drag operation was invoked outside the user agent's purview. What is being
    dragged is defined by the document or application where the drag was started.</p>

    <p class="note"><code>img</code> elements and <code>a</code> elements with an <code
    data-x="attr-hyperlink-href">href</code> attribute have their <code
    data-x="dom-draggable">draggable</code> attribute set to true by default.</p>

   </li>

   <li><p><span>Create a drag data store</span>. All the DND events fired subsequently by the steps
   in this section must use this <span>drag data store</span>.</p></li>

   <li>

    <p>Establish which DOM node is the <dfn>source node</dfn>, as follows:</p>

    <p>If it is a selection that is being dragged, then the <span>source node</span> is the
    <code>Text</code> node that the user started the drag on (typically the <code>Text</code> node
    that the user originally clicked). If the user did not specify a particular node, for example if
    the user just told the user agent to begin a drag of "the selection", then the <span>source
    node</span> is the first <code>Text</code> node containing a part of the selection.</p>

    <p>Otherwise, if it is an element that is being dragged, then the <span>source node</span> is
    the element that is being dragged.</p>

    <p>Otherwise, the <span>source node</span> is part of another document or application. When this
    specification requires that an event be dispatched at the <span>source node</span> in this case,
    the user agent must instead follow the platform-specific conventions relevant to that
    situation.</p>

    <p class="note">Multiple events are fired on the <span>source node</span> during the course of
    the drag-and-drop operation.</p>

   </li>

   <li>

    <p>Determine the <dfn>list of dragged nodes</dfn>, as follows:</p>

    <p>If it is a selection that is being dragged, then the <span>list of dragged nodes</span>
    contains, in <span>tree order</span>, every node that is partially or completely included in the
    selection (including all their ancestors).</p>

    <p>Otherwise, the <span>list of dragged nodes</span> contains only the <span>source node</span>,
    if any.</p>

   </li>

   <li>

    <p>If it is a selection that is being dragged, then add an item to the <span>drag data store
    item list</span>, with its properties set as follows:</p>

    <dl>

     <dt><span>The drag data item type string</span>
     <dd>"<code>text/plain</code>"</dd>

     <dt><span>The drag data item kind</span>
     <dd><i>Plain Unicode string</i></dd>

     <dt>The actual data</dt>
     <dd>The text of the selection</dd>

    </dl>

    <p>Otherwise, if any files are being dragged, then add one item per file to the <span>drag data
    store item list</span>, with their properties set as follows:</p>

    <dl>

     <dt><span>The drag data item type string</span>
     <dd>The MIME type of the file, if known, or "<code>application/octet-stream</code>" otherwise.</dd>

     <dt><span>The drag data item kind</span>
     <dd><i>File</i></dd>

     <dt>The actual data</dt>
     <dd>The file's contents and name.</dd>

    </dl>

    <p class="note">Dragging files can currently only happen from outside a <span>browsing
    context</span>, for example from a file system manager application.</p>

    <p>If the drag initiated outside of the application, the user agent must add items to the
    <span>drag data store item list</span> as appropriate for the data being dragged, honoring
    platform conventions where appropriate; however, if the platform conventions do not use <span
    data-x="MIME type">MIME types</span> to label dragged data, the user agent must make a
    best-effort attempt to map the types to MIME types, and, in any case, all the <span data-x="the
    drag data item type string">drag data item type strings</span> must be <span>converted to ASCII
    lowercase</span>.</p>

    <p>User agents may also add one or more items representing the selection or dragged element(s)
    in other forms, e.g. as HTML.</p>

   </li>

   <!-- DND-v2: text/html as an export format -->

   <li>

    <p>If the <span>list of dragged nodes</span> is not empty, then <span data-x="extracting
    JSON">extract the microdata from those nodes into a JSON form</span>, and add one item to the
    <span>drag data store item list</span>, with its properties set as follows:</p>

    <dl>

     <dt><span>The drag data item type string</span>
     <dd><code>application/microdata+json</code></dd>

     <dt><span>The drag data item kind</span>
     <dd><i>Plain Unicode string</i></dd>

     <dt>The actual data</dt>
     <dd>The resulting JSON string.</dd>

    </dl>

   </li>

   <li>

    <p>Run the following substeps:</p>

    <ol>

     <li><p>Let <var>urls</var> be an empty list of <span data-x="absolute URL">absolute
     URLs</span>.</p></li>

     <li>

      <p>For each <var>node</var> in the <span>list of dragged nodes</span>:</p>

      <dl>

       <dt>If the node is an <code>a</code> element with an <code
       data-x="attr-hyperlink-href">href</code> attribute</dt>

       <dd>Add to <var>urls</var> the result of <span data-x="resolve a
       url">resolving</span> the element's <code data-x="attr-hyperlink-href">href</code> content
       attribute relative to the element.</dd>

       <dt>If the node is an <code>img</code> element with a <code data-x="attr-img-src">src</code>
       attribute</dt>

       <dd>Add to <var>urls</var> the result of <span data-x="resolve a
       url">resolving</span> the element's <code data-x="attr-img-src">src</code> content attribute
       relative to the element.</dd>

       <!-- DND-v2: more -->

      </dl>

     </li>

     <li><p>If <var>urls</var> is still empty, abort these substeps.</p></li>

     <li><p>Let <var>url string</var> be the result of concatenating the strings in <var>urls</var>,
     in the order they were added, separated by a U+000D CARRIAGE RETURN U+000A LINE FEED character
     pair (CRLF).</p></li>

     <li><p>Add one item to the <span>drag data store item list</span>, with its properties set as
     follows:</p>

      <dl>

       <dt><span>The drag data item type string</span>
       <dd><code>text/uri-list</code></dd>

       <dt><span>The drag data item kind</span>
       <dd><i>Plain Unicode string</i></dd>

       <dt>The actual data</dt>
       <dd><var>url string</var></dd>

      </dl>

     </li>

    </ol>

   </li>

   <li>

    <p>Update the <span>drag data store default feedback</span> as appropriate for the user agent
    (if the user is dragging the selection, then the selection would likely be the basis for this
    feedback; if the user is dragging an element, then that element's rendering would be used; if
    the drag began outside the user agent, then the platform conventions for determining the drag
    feedback should be used).</p>

   </li>

   <li>

    <p><span>Fire a DND event</span> named <code data-x="event-dnd-dragstart">dragstart</code> at the
    <span>source node</span>.</p>

    <p>If the event is canceled, then the drag-and-drop operation should not occur; abort these
    steps.</p> <!-- only a should because the UA can always allow the user to drag without the page
    knowing -->

    <p class="note">Since events with no event listeners registered are, almost by definition, never
    canceled, drag-and-drop is always available to the user if the author does not specifically
    prevent it.</p>

   </li>

   <li>

    <p><span>Initiate the drag-and-drop operation</span> in a manner consistent with platform
    conventions, and as described below.</p>

    <p id="base-dnd-feedback">The drag-and-drop feedback must be generated from the first of the
    following sources that is available:</p>

    <ol>

     <li>The <span>drag data store bitmap</span>, if any. In this case, the <span>drag data store
     hot spot coordinate</span> should be used as hints for where to put the cursor relative to the
     resulting image. The values are expressed as distances in CSS pixels from the left side and
     from the top side of the image respectively. <a href="#refsCSS">\[CSS]</a></li>

     <li>The <span>drag data store default feedback</span>.</li>

    </ol>

   </li>

  </ol>

  <p>From the moment that the user agent is to <dfn>initiate the drag-and-drop operation</dfn>,
  until the end of the drag-and-drop operation, device input events (e.g. mouse and keyboard events)
  must be suppressed.</p>

  <p>During the drag operation, the element directly indicated by the user as the drop target is
  called the <dfn>immediate user selection</dfn>. (Only elements can be selected by the user; other
  nodes must not be made available as drop targets.) However, the <span>immediate user
  selection</span> is not necessarily the <dfn>current target element</dfn>, which is the element
  currently selected for the drop part of the drag-and-drop operation.</p>

  <p>The <span>immediate user selection</span> changes as the user selects different elements
  (either by pointing at them with a pointing device, or by selecting them in some other way). The
  <span>current target element</span> changes when the <span>immediate user selection</span>
  changes, based on the results of event listeners in the document, as described below.</p>

  <p>Both the <span>current target element</span> and the <span>immediate user selection</span> can
  be null, which means no target element is selected. They can also both be elements in other
  (DOM-based) documents, or other (non-Web) programs altogether. (For example, a user could drag
  text to a word-processor.) The <span>current target element</span> is initially null.</p>

  <p>In addition, there is also a <dfn>current drag operation</dfn>, which can take on the values
  "<dfn><code data-x="concept-current-drag-operation-none">none</code></dfn>", "<dfn><code
  data-x="concept-current-drag-operation-copy">copy</code></dfn>", "<dfn><code
  data-x="concept-current-drag-operation-link">link</code></dfn>", and "<dfn><code
  data-x="concept-current-drag-operation-move">move</code></dfn>". Initially, it has the value
  "<code data-x="concept-current-drag-operation-none">none</code>". It is updated by the user agent
  as described in the steps below.</p>

  <p>User agents must, as soon as the drag operation is <span data-x="initiate the drag-and-drop
  operation">initiated</span> and every 350ms (&#xB1;200ms) thereafter for as long as the drag
  operation is ongoing, <span>queue a task</span> to perform the following steps in sequence:</p>

  <ol>

   <li>

    <p>If the user agent is still performing the previous iteration of the sequence (if any) when
    the next iteration becomes due, abort these steps for this iteration (effectively "skipping
    missed frames" of the drag-and-drop operation).</p>

   </li>

   <li>

    <p><span>Fire a DND event</span> named <code data-x="event-dnd-drag">drag</code> at the
    <span>source node</span>. If this event is canceled, the user agent must set the <span>current
    drag operation</span> to "<code data-x="concept-current-drag-operation-none">none</code>" (no
    drag operation).</p>

   </li>

   <li>

    <p>If the <code data-x="event-dnd-drag">drag</code> event was not canceled and the user has not
    ended the drag-and-drop operation, check the state of the drag-and-drop operation, as
    follows:</p>

    <ol>

     <li>

      <p>If the user is indicating a different <span>immediate user selection</span> than during the
      last iteration (or if this is the first iteration), and if this <span>immediate user
      selection</span> is not the same as the <span>current target element</span>, then <span>fire a
      DND event</span> named <code data-x="event-dnd-dragexit">dragexit</code> at the <span>current
      target element</span>, and then update the <span>current target element</span> as follows:</p>

      <dl class="switch">

       <dt>If the new <span>immediate user selection</span> is null</dt>

       <dd><p>Set the <span>current target element</span> to null also.</p></dd>

       <dt>If the new <span>immediate user selection</span> is in a non-DOM document or
       application</dt>

       <dd><p>Set the <span>current target element</span> to the <span>immediate user
       selection</span>.</p></dd>

       <dt>Otherwise</dt>

       <dd>

        <p><span>Fire a DND event</span> named <code data-x="event-dnd-dragenter">dragenter</code>
        at the <span>immediate user selection</span>.</p>

        <p>If the event is canceled, then set the <span>current target element</span> to the
        <span>immediate user selection</span>.</p>

        <p>Otherwise, run the appropriate step from the following list:</p>

        <dl class="switch">

         <dt>If the <span>immediate user selection</span> is a text field (e.g.
         <code>textarea</code>, or an <code>input</code> element whose <code
         data-x="attr-input-type">type</code> attribute is in the <span
         data-x="attr-input-type-text">Text</span> state) or an <span>editing host</span> or
         <span>editable</span> element, and the <span>drag data store item list</span> has an item
         with <span>the drag data item type string</span> "<code>text/plain</code>" and <span>the
         drag data item kind</span> <i>Plain Unicode string</i></dt>

         <dd><p>Set the <span>current target element</span> to the <span>immediate user
         selection</span> anyway.</p></dd>


         <dt>If the <span>immediate user selection</span> is an element with a <code
         data-x="attr-dropzone">dropzone</code> attribute that <span
         data-x="concept-dropzone-match">matches</span> the <span>drag data store</span></dt>

         <dd><p>Set the <span>current target element</span> to the <span>immediate user
         selection</span> anyway.</p></dd>


         <dt>If the <span>immediate user selection</span> is an element that itself has an ancestor
         element with a <code data-x="attr-dropzone">dropzone</code> attribute that <span
         data-x="concept-dropzone-match">matches</span> the <span>drag data store</span></dt>

         <dd>

          <p>Let <var>new target</var> be the nearest (deepest) such ancestor element.</p>

          <p>If the <span>immediate user selection</span> is <var>new target</var>, then leave the
          <span>current target element</span> unchanged.</p>

          <p>Otherwise, <span>fire a DND event</span> named <code
          data-x="event-dnd-dragenter">dragenter</code> at <var>new target</var>, with the current
          <span>current target element</span> as the specific <var>related target</var>. Then, set
          the <span>current target element</span> to <var>new target</var>, regardless of whether
          that event was canceled or not.</p>

         </dd>


         <dt>If the <span>immediate user selection</span> is <span>the body element</span></dt>

         <dd><p>Leave the <span>current target element</span> unchanged.</p></dd>


         <dt>Otherwise</dt>

         <dd>

          <p><span>Fire a DND event</span> named <code data-x="event-dnd-dragenter">dragenter</code>
          at <span>the body element</span>, if there is one, or at the <code>Document</code> object,
          if not. Then, set the <span>current target element</span> to <span>the body
          element</span>, regardless of whether that event was canceled or not.</p>

         </dd>

        </dl>

       </dd>

      </dl>

     </li>

     <li>

      <p>If the previous step caused the <span>current target element</span> to change, and if the
      previous target element was not null or a part of a non-DOM document, then <span>fire a DND
      event</span> named <code data-x="event-dnd-dragleave">dragleave</code> at the previous target
      element, with the new <span>current target element</span> as the specific <var>related
      target</var>.</p>

     </li>

     <li>

      <p>If the <span>current target element</span> is a DOM element, then <span>fire a DND
      event</span> named <code data-x="event-dnd-dragover">dragover</code> at this <span>current
      target element</span>.</p>

      <p>If the <code data-x="event-dnd-dragover">dragover</code> event is not canceled, run the
      appropriate step from the following list:</p>

      <dl class="switch">

       <dt>If the <span>current target element</span> is a text field (e.g. <code>textarea</code>,
       or an <code>input</code> element whose <code data-x="attr-input-type">type</code> attribute
       is in the <span data-x="attr-input-type-text">Text</span> state) or an <span>editing
       host</span> or <span>editable</span> element, and the <span>drag data store item list</span>
       has an item with <span>the drag data item type string</span> "<code>text/plain</code>" and
       <span>the drag data item kind</span> <i>Plain Unicode string</i></dt>

       <dd><p>Set the <span>current drag operation</span> to either "<code
       data-x="concept-current-drag-operation-copy">copy</code>" or "<code
       data-x="concept-current-drag-operation-move">move</code>", as appropriate given the platform
       conventions.</p></dd>


       <dt>If the <span>current target element</span> is an element with a <code
       data-x="attr-dropzone">dropzone</code> attribute that <span
       data-x="concept-dropzone-match">matches</span> the <span>drag data store</span> and <span
       data-x="concept-dropzone-operation">specifies an operation</span></dt>

       <dd><p>Set the <span>current drag operation</span> to the operation <span
       data-x="concept-dropzone-operation">specified</span> by the <code
       data-x="attr-dropzone">dropzone</code> attribute of the <span>current target
       element</span>.</p>


       <dt>If the <span>current target element</span> is an element with a <code
       data-x="attr-dropzone">dropzone</code> attribute that <span
       data-x="concept-dropzone-match">matches</span> the <span>drag data store</span> and does not
       <span data-x="concept-dropzone-operation">specify an operation</span></dt>

       <dd><p>Set the <span>current drag operation</span> to "<code
       data-x="concept-current-drag-operation-copy">copy</code>".</p>


       <dt>Otherwise</dt>

       <dd><p>Reset the <span>current drag operation</span> to "<code
       data-x="concept-current-drag-operation-none">none</code>".</p></dd>

      </dl>

      <p>Otherwise (if the <code data-x="event-dnd-dragover">dragover</code> event <em>is</em>
      canceled), set the <span>current drag operation</span> based on the values of the <code
      data-x="dom-DataTransfer-effectAllowed">effectAllowed</code> and <code
      data-x="dom-DataTransfer-dropEffect">dropEffect</code> attributes of the
      <code>DragEvent</code> object's <code data-x="dom-DragEvent-dataTransfer">dataTransfer</code>
      object as they stood after the event <span data-x="concept-event-dispatch">dispatch</span>
      finished, as per the following table:</p>

      <table>
       <thead>
        <tr>
         <th><code data-x="dom-DataTransfer-effectAllowed">effectAllowed</code></th>
         <th><code data-x="dom-DataTransfer-dropEffect">dropEffect</code></th>
         <th>Drag operation</th>
        </tr>
       </thead>
       <tr>
        <td>"<code data-x="dom-DataTransfer-effectAllowed-uninitialized">uninitialized</code>", "<code data-x="dom-DataTransfer-effectAllowed-copy">copy</code>", "<code data-x="dom-DataTransfer-effectAllowed-copyLink">copyLink</code>", "<code data-x="dom-DataTransfer-effectAllowed-copyMove">copyMove</code>", or "<code data-x="dom-DataTransfer-effectAllowed-all">all</code>"</td>
        <td>"<code data-x="dom-DataTransfer-dropEffect-copy">copy</code>"</td>
        <td>"<code data-x="concept-current-drag-operation-copy">copy</code>"</td>
       </tr>
       <tr>
        <td>"<code data-x="dom-DataTransfer-effectAllowed-uninitialized">uninitialized</code>", "<code data-x="dom-DataTransfer-effectAllowed-link">link</code>", "<code data-x="dom-DataTransfer-effectAllowed-copyLink">copyLink</code>", "<code data-x="dom-DataTransfer-effectAllowed-linkMove">linkMove</code>", or "<code data-x="dom-DataTransfer-effectAllowed-all">all</code>"</td>
        <td>"<code data-x="dom-DataTransfer-dropEffect-link">link</code>"</td>
        <td>"<code data-x="concept-current-drag-operation-link">link</code>"</td>
       </tr>
       <tr>
        <td>"<code data-x="dom-DataTransfer-effectAllowed-uninitialized">uninitialized</code>", "<code data-x="dom-DataTransfer-effectAllowed-move">move</code>", "<code data-x="dom-DataTransfer-effectAllowed-copyMove">copyMove</code>", "<code data-x="dom-DataTransfer-effectAllowed-linkMove">linkMove</code>", or "<code data-x="dom-DataTransfer-effectAllowed-all">all</code>"</td>
        <td>"<code data-x="dom-DataTransfer-dropEffect-move">move</code>"</td>
        <td>"<code data-x="concept-current-drag-operation-move">move</code>"</td>
       </tr>
       <tr>
        <td colspan="2">Any other case</td>
        <td>"<code data-x="concept-current-drag-operation-none">none</code>"</td>
       </tr>
      </table>

     </li>

     <li>

      <p>Otherwise, if the <span>current target element</span> is not a DOM element, use
      platform-specific mechanisms to determine what drag operation is being performed (none, copy,
      link, or move), and set the <span>current drag operation</span> accordingly.</p>

     </li>

     <li>

      <p>Update the drag feedback (e.g. the mouse cursor) to match the <span>current drag
      operation</span>, as follows:</p>

      <table>
       <thead>
        <tr>
         <th>Drag operation</th>
         <th>Feedback</th>
        </tr>
       </thead>
       <tr>
        <td>"<code data-x="concept-current-drag-operation-copy">copy</code>"</td>
        <td>Data will be copied if dropped here.</td>
       </tr>
       <tr>
        <td>"<code data-x="concept-current-drag-operation-link">link</code>"</td>
        <td>Data will be linked if dropped here.</td>
       </tr>
       <tr>
        <td>"<code data-x="concept-current-drag-operation-move">move</code>"</td>
        <td>Data will be moved if dropped here.</td>
       </tr>
       <tr>
        <td>"<code data-x="concept-current-drag-operation-none">none</code>"</td>
        <td>No operation allowed, dropping here will cancel the drag-and-drop operation.</td>
       </tr>
      </table>

     </li>

    </ol>

   </li>

   <li>

    <p>Otherwise, if the user ended the drag-and-drop operation (e.g. by releasing the mouse button
    in a mouse-driven drag-and-drop interface), or if the <code data-x="event-dnd-drag">drag</code>
    event was canceled, then this will be the last iteration. Run the following steps, then stop the
    drag-and-drop operation:</p>

    <ol>

     <li>

      <p>If the <span>current drag operation</span> is "<code
      data-x="concept-current-drag-operation-none">none</code>" (no drag operation), or, if the user
      ended the drag-and-drop operation by canceling it (e.g. by hitting the <kbd>Escape</kbd> key),
      or if the <span>current target element</span> is null, then the drag operation failed. Run
      these substeps:</p>

      <ol>

       <li><p>Let <var>dropped</var> be false.</p></li>

       <li><p>If the <span>current target element</span> is a DOM element, <span>fire a DND
       event</span> named <code data-x="event-dnd-dragleave">dragleave</code> at it; otherwise, if
       it is not null, use platform-specific conventions for drag cancelation.</p></li>

       <li><p>Set the <span>current drag operation</span> to "<code
       data-x="concept-current-drag-operation-none">none</code>".</p></li>

      </ol>

      <p>Otherwise, the drag operation might be a success; run these substeps:</p>

      <ol>

       <li><p>Let <var>dropped</var> be true.</p></li>

       <li><p>If the <span>current target element</span> is a DOM element, <span>fire a DND
       event</span> named <code data-x="event-dnd-drop">drop</code> at it; otherwise, use
       platform-specific conventions for indicating a drop.</p></li>

       <li>

        <p>If the event is canceled, set the <span>current drag operation</span> to the value of the
        <code data-x="dom-DataTransfer-dropEffect">dropEffect</code> attribute of the
        <code>DragEvent</code> object's <code data-x="dom-DragEvent-dataTransfer">dataTransfer</code>
        object as it stood after the event <span data-x="concept-event-dispatch">dispatch</span>
        finished.</p>

        <p>Otherwise, the event is not canceled; perform the event's default action, which depends
        on the exact target as follows:</p>

        <dl class="switch">

         <dt>If the <span>current target element</span> is a text field (e.g. <code>textarea</code>,
         or an <code>input</code> element whose <code data-x="attr-input-type">type</code> attribute
         is in the <span data-x="attr-input-type-text">Text</span> state) or an <span>editing
         host</span> or <span>editable</span> element, and the <span>drag data store item
         list</span> has an item with <span>the drag data item type string</span>
         "<code>text/plain</code>" and <span>the drag data item kind</span> <i>Plain Unicode
         string</i></dt>

         <dd><p>Insert the actual data of the first item in the <span>drag data store item
         list</span> to have <span data-x="the drag data item type string">a drag data item type
         string</span> of "<code>text/plain</code>" and <span data-x="the drag data item kind">a drag
         data item kind</span> that is <i>Plain Unicode string</i> into the text field or
         <span>editing host</span> or <span>editable</span> element in a manner consistent with
         platform-specific conventions (e.g. inserting it at the current mouse cursor position, or
         inserting it at the end of the field).</p></dd>

         <dt>Otherwise</dt>

         <dd><p>Reset the <span>current drag operation</span> to "<code
         data-x="concept-current-drag-operation-none">none</code>".</p></dd>

        </dl>

       </li>

      </ol>

     </li>

     <li>

      <p><span>Fire a DND event</span> named <code data-x="event-dnd-dragend">dragend</code> at the
      <span>source node</span>.</p>

     </li>

     <li>

      <p>Run the appropriate steps from the following list as the default action of the <code
      data-x="event-dnd-dragend">dragend</code> event:</p>

      <dl class="switch">

       <dt>If <var>dropped</var> is true, the <span>current target element</span> is a <i>text
       field</i> (see below), the <span>current drag operation</span> is "<code
       data-x="concept-current-drag-operation-move">move</code>", and the source of the
       drag-and-drop operation is a selection in the DOM that is entirely contained within an
       <span>editing host</span></dt>

       <dd><p><span>Delete the selection</span>.</p></dd>

       <dt>If <var>dropped</var> is true, the <span>current target element</span> is a <i>text
       field</i> (see below), the <span>current drag operation</span> is "<code
       data-x="concept-current-drag-operation-move">move</code>", and the source of the
       drag-and-drop operation is a selection in a text field</dt>

       <dd><p>The user agent should delete the dragged selection from the relevant text
       field.</p></dd>

       <dt>If <var>dropped</var> is false or if the <span>current drag operation</span> is "<code
       data-x="concept-current-drag-operation-none">none</code>"</dt>

       <dd><p>The drag was canceled. If the platform conventions dictate that this be represented to
       the user (e.g. by animating the dragged selection going back to the source of the
       drag-and-drop operation), then do so.</p></dd>

       <dt>Otherwise</dt>

       <dd><p>The event has no default action.</p></dd>

      </dl>

      <p>For the purposes of this step, a <i>text field</i> is a <code>textarea</code> element or an
      <code>input</code> element whose <code data-x="attr-input-type">type</code> attribute is in
      one of the
      <span data-x="attr-input-type-text">Text</span>,
      <span data-x="attr-input-type-search">Search</span>,
      <span data-x="attr-input-type-tel">Tel</span>,
      <span data-x="attr-input-type-url">URL</span>,
      <span data-x="attr-input-type-email">E-mail</span>,
      <span data-x="attr-input-type-password">Password</span>, or
      <span data-x="attr-input-type-number">Number</span>
      states.</p>


     </li>

    </ol>

   </li>

  </ol>

  <p class="note">User agents are encouraged to consider how to react to drags near the edge of
  scrollable regions. For example, if a user drags a link to the bottom of the viewport on a long
  page, it might make sense to scroll the page so that the user can drop the link lower on the
  page.</p>

  <p class="note">This model is independent of which <code>Document</code> object the nodes involved
  are from; the events are fired as described above and the rest of the processing model runs as
  described above, irrespective of how many documents are involved in the operation.</p>

  </div>


  <h4 id="dndevents">Events summary</h4>

  <p><em>This section is non-normative.</em></p>

  <p>The following events are involved in the drag-and-drop
  model.</p>

  <table>

   <thead>
    <tr>
     <th> Event Name </th>
     <th> Target </th>
     <!-- <th> Bubbles? </th> -->
     <th> Cancelable? </th>
     <th> <span>Drag data store mode</span> </th>
     <!-- <th> <code data-x="dom-DataTransfer-effectAllowed">effectAllowed</code> </th> -->
     <th> <code data-x="dom-DataTransfer-dropEffect">dropEffect</code> </th>
     <th> Default Action </th>
    </tr>
   </thead>

   <tbody>

    <tr>
     <td><dfn><code data-x="event-dnd-dragstart">dragstart</code></dfn></td>
     <td><span>Source node</span></td>
     <!-- <td>&#x2713; Bubbles</td> -->
     <td>&#x2713; Cancelable</td>
     <td><span data-x="concept-dnd-rw">Read/write mode</span>
     <!-- <td>"<code data-x="dom-DataTransfer-effectAllowed-uninitialized">uninitialized</code>"</td> -->
     <td>"<code data-x="dom-DataTransfer-dropEffect-none">none</code>"</td>
     <td>Initiate the drag-and-drop operation</td>
    </tr>

    <tr>
     <td><dfn><code data-x="event-dnd-drag">drag</code></dfn></td>
     <td><span>Source node</span></td>
     <!-- <td>&#x2713; Bubbles</td> -->
     <td>&#x2713; Cancelable</td>
     <td><span data-x="concept-dnd-p">Protected mode</span>
     <!-- <td>Same as last event</td> -->
     <td>"<code data-x="dom-DataTransfer-dropEffect-none">none</code>"</td>
     <td>Continue the drag-and-drop operation</td>
    </tr>

    <tr>
     <td><dfn><code data-x="event-dnd-dragenter">dragenter</code></dfn></td>
     <td><span>Immediate user selection</span> or <span>the body element</span></td>
     <!-- <td>&#x2713; Bubbles</td> -->
     <td>&#x2713; Cancelable</td>
     <td><span data-x="concept-dnd-p">Protected mode</span>
     <!-- <td>Same as last event</td> -->
     <td><a href="#dropEffect-initialisation">Based on <code>effectAllowed</code> value</a></td>
     <td>Reject <span>immediate user selection</span> as potential <span data-x="current target element">target element</span></td>
    </tr>

    <tr>
     <td><dfn><code data-x="event-dnd-dragexit">dragexit</code></dfn></td>
     <td><span data-x="current target element">Previous target element</span></td>
     <!-- <td>&#x2713; Bubbles</td> -->
     <td>&mdash;</td>
     <td><span data-x="concept-dnd-p">Protected mode</span>
     <!-- <td>Same as last event</td> -->
     <td>"<code data-x="dom-DataTransfer-dropEffect-none">none</code>"</td>
     <td>None</td>
    </tr>

    <tr>
     <td><dfn><code data-x="event-dnd-dragleave">dragleave</code></dfn></td>
     <td><span data-x="current target element">Previous target element</span></td>
     <!-- <td>&#x2713; Bubbles</td> -->
     <td>&mdash;</td>
     <td><span data-x="concept-dnd-p">Protected mode</span>
     <!-- <td>Same as last event</td> -->
     <td>"<code data-x="dom-DataTransfer-dropEffect-none">none</code>"</td>
     <td>None</td>
    </tr>

    <tr>
     <td><dfn><code data-x="event-dnd-dragover">dragover</code></dfn></td>
     <td><span>Current target element</span></td>
     <!-- <td>&#x2713; Bubbles</td> -->
     <td>&#x2713; Cancelable</td>
     <td><span data-x="concept-dnd-p">Protected mode</span>
     <!-- <td>Same as last event</td> -->
     <td><a href="#dropEffect-initialisation">Based on <code>effectAllowed</code> value</a></td>
     <td>Reset the <span>current drag operation</span> to "none"</td>
    </tr>

    <tr>
     <td><dfn><code data-x="event-dnd-drop">drop</code></dfn></td>
     <td><span>Current target element</span></td>
     <!-- <td>&#x2713; Bubbles</td> -->
     <td>&#x2713; Cancelable</td>
     <td><span data-x="concept-dnd-ro">Read-only mode</span>
     <!-- <td>Same as last event</td> -->
     <td><span>Current drag operation</span></td>
     <td>Varies</td>
    </tr>

    <tr>
     <td><dfn><code data-x="event-dnd-dragend">dragend</code></dfn></td>
     <td><span>Source node</span></td>
     <!-- <td>&#x2713; Bubbles</td> -->
     <td>&mdash;</td>
     <td><span data-x="concept-dnd-p">Protected mode</span>
     <!-- <td>Same as last event</td> -->
     <td><span>Current drag operation</span></td>
     <td>Varies</td>
    </tr>

   </tbody>

  </table>

  <p>Not shown in the above table: all these events bubble, and the <code
  data-x="dom-DataTransfer-effectAllowed">effectAllowed</code> attribute always has the value it had
  after the <code data-x="event-dnd-dragstart">dragstart</code> event, defaulting to "<code
  data-x="dom-DataTransfer-effectAllowed-uninitialized">uninitialized</code>" in the <code
  data-x="event-dnd-dragstart">dragstart</code> event.</p>



  <h4>The <dfn><code data-x="attr-draggable">draggable</code></dfn> attribute</h4>

  <p>All <span>HTML elements</span> may have the <code data-x="attr-draggable">draggable</code>
  content attribute set. The <code data-x="attr-draggable">draggable</code> attribute is an
  <span>enumerated attribute</span>. It has three states. The first state is <i>true</i> and it has
  the keyword <code>true</code>. The second state is <i>false</i> and it has the keyword
  <code>false</code>. The third state is <i>auto</i>; it has no keywords but it is the
  <i data-x="missing value default">missing value default</i>.</p>

  <p>The <i>true</i> state means the element is draggable; the <i>false</i> state means that it is
  not. The <i>auto</i> state uses the default behavior of the user agent.</p>

  <p>An element with a <code data-x="attr-draggable">draggable</code> attribute should also have a
  <code data-x="attr-title">title</code> attribute that names the element for the purpose of
  non-visual interactions. <!-- "should", not "must", only because this is a relatively new
  attribute and its design implications are not entirely obvious yet. For example, what happens if
  you use an element with text as a drag source? Is that sufficiently clear for ATs? Indeed,
  shouldn't the element generally be distinguishable anyway for it to be useful to drag? See also
  the dropzone attribute. --></p>

  <dl class="domintro">

   <dt><var>element</var> . <code subdfn data-x="dom-draggable">draggable</code> [ = <var>value</var> ]</dt>

   <dd>

    <p>Returns true if the element is draggable; otherwise, returns false.</p>

    <p>Can be set, to override the default and set the <code data-x="attr-draggable">draggable</code>
    content attribute.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-draggable">draggable</code></dfn> IDL attribute, whose value depends
  on the content attribute's in the way described below, controls whether or not the element is
  draggable. Generally, only text selections are draggable, but elements whose <code
  data-x="dom-draggable">draggable</code> IDL attribute is true become draggable as well.</p>

  <p>If an element's <code data-x="attr-draggable">draggable</code> content attribute has the state
  <i>true</i>, the <code data-x="dom-draggable">draggable</code> IDL attribute must return true.</p>

  <p>Otherwise, if the element's <code data-x="attr-draggable">draggable</code> content attribute has
  the state <i>false</i>, the <code data-x="dom-draggable">draggable</code> IDL attribute must return
  false.</p>

  <p>Otherwise, the element's <code data-x="attr-draggable">draggable</code> content attribute has
  the state <i>auto</i>. If the element is an <code>img</code> element, an <code>object</code>
  element that <span>represents</span> an image, or an <code>a</code> element with an <code
  data-x="attr-hyperlink-href">href</code> content attribute, the <code
  data-x="dom-draggable">draggable</code> IDL attribute must return true; otherwise, the <code
  data-x="dom-draggable">draggable</code> IDL attribute must return false.</p>

  <p>If the <code data-x="dom-draggable">draggable</code> IDL attribute is set to the value false,
  the <code data-x="attr-draggable">draggable</code> content attribute must be set to the literal
  value "<code>false</code>". If the <code data-x="dom-draggable">draggable</code> IDL
  attribute is set to the value true, the <code data-x="attr-draggable">draggable</code> content
  attribute must be set to the literal value "<code>true</code>".</p>

  </div>


  <h4>The <dfn><code data-x="attr-dropzone">dropzone</code></dfn> attribute</h4>

  <p>All <span>HTML elements</span> may have the <code data-x="attr-dropzone">dropzone</code> content
  attribute set. When specified, its value must be an <span>unordered set of unique space-separated
  tokens</span> that are <span>ASCII case-insensitive</span>. The allowed values are the
  following:</p>

  <dl>

   <dt><dfn><code data-x="attr-dropzone-copy">copy</code></dfn></dt>

   <dd><p>Indicates that dropping an accepted item on the element will result in a copy of the
   dragged data.</p>


   <dt><dfn><code data-x="attr-dropzone-move">move</code></dfn></dt>

   <dd><p>Indicates that dropping an accepted item on the element will result in the dragged data
   being moved to the new location.</p>


   <dt><dfn><code data-x="attr-dropzone-link">link</code></dfn></dt>

   <dd><p>Indicates that dropping an accepted item on the element will result in a link to the
   original data.</p>


   <dt>Any keyword with eight characters or more, beginning with the an <span>ASCII
   case-insensitive</span> match for the string "<code>string:</code>"</dt>

   <dd><p>Indicates that items with <span>the drag data item kind</span> <i>Plain Unicode string</i>
   and <span>the drag data item type string</span> set to a value that matches the remainder of the
   keyword are accepted.</p></dd>

<!--DND-v3:
   <dt>Any keyword with six characters or more, beginning with an <span>ASCII
   case-insensitive</span> match for the string "<code>blob:</code>"</dt>

   <dd><p>Indicates that items with <span>the drag data item kind</span> <i>Blob</i>, <i>File</i>,
   or <i>Plain Unicode string</i> and <span>the drag data item type string</span> set to a value
   that matches the remainder of the keyword are accepted.</p></dd>
-->

   <dt>Any keyword with six characters or more, beginning with an <span>ASCII
   case-insensitive</span> match for the string "<code>file:</code>"</dt>

   <dd><p>Indicates that items with <span>the drag data item kind</span> <i>File</i> and <span>the
   drag data item type string</span> set to a value that matches the remainder of the keyword are
   accepted.</p></dd>

<!--DND-v4:
   <dt>Any keyword with eight characters or more, beginning with an <span>ASCII
   case-insensitive</span> match for the string "<code>object:</code>"</dt>

   <dd><p>Indicates that items with <span>the drag data item type string</span> set to a value that
   matches the remainder of the keyword are accepted.</p></dd>
-->

  </dl>

  <p>The <code data-x="attr-dropzone">dropzone</code> content attribute's values must not have more
  than one of the three feedback values (<code data-x="attr-dropzone-copy">copy</code>, <code
  data-x="attr-dropzone-move">move</code>, and <code data-x="attr-dropzone-link">link</code>)
  specified. If none are specified, the <code data-x="attr-dropzone-copy">copy</code> value is
  implied.</p>

  <p>An element with a <code data-x="attr-dropzone">dropzone</code> attribute should also have a
  <code data-x="attr-title">title</code> attribute that names the element for the purpose of
  non-visual interactions. <!-- "should", not "must", only because this is a relatively new
  attribute and its design implications are not entirely obvious yet. For example, what happens if
  you use an element with text as a drop zone? Is that sufficiently clear for ATs? See also the
  draggable attribute. --></p>

  <div class="impl">

  <p>A <code data-x="attr-dropzone">dropzone</code> attribute <dfn
  data-x="concept-dropzone-match">matches a drag data store</dfn> if the <span><code
  data-x="attr-dropzone">dropzone</code> processing steps</span> result in a match.</p>

  <p>A <code data-x="attr-dropzone">dropzone</code> attribute <dfn
  data-x="concept-dropzone-operation">specifies an operation</dfn> if the <span><code
  data-x="attr-dropzone">dropzone</code> processing steps</span> result in a specified operation. The
  specified operation is as given by those steps.</p>

  <p>The <dfn><code data-x="attr-dropzone">dropzone</code> processing steps</dfn> are as follows.
  They either result in a match or not, and separate from this result either in a specified
  operation or not, as defined below.</p>

  <ol>

   <li><p>Let <var>value</var> be the value of the <code
   data-x="attr-dropzone">dropzone</code> attribute.</p></li>

   <li><p>Let <var>keywords</var> be the result of <span data-x="split a string on
   spaces">splitting <var>value</var> on spaces</span>.</p></li>

   <li><p>Let <var>matched</var> be false.</p></li>

   <li><p>Let <var>operation</var> be unspecified.</p></li>

   <li>

    <p>For each value in <var>keywords</var>, if any, in the order that they were found in
    <var>value</var>, run the following steps.</p>

    <ol>

     <li><p>Let <var>keyword</var> be the keyword.</p></li>

     <li>

      <p>If <var>keyword</var> is one of "<code data-x="attr-dropzone-copy">copy</code>",
      "<code data-x="attr-dropzone-move">move</code>", or "<code
      data-x="attr-dropzone-link">link</code>", then: run the following substeps:</p>

      <ol>

       <li><p>If <var>operation</var> is still unspecified, then let <var>operation</var> be the string given by <var>keyword</var>.</p></li>

       <li><p>Skip to the step labeled <i>end of keyword</i> below.</p></li>

      </ol>

     </li>

     <li><p>If <var>keyword</var> does not contain a U+003A COLON character (:), or if the
     first such character in <var>keyword</var> is either the first character or the last
     character in the string, then skip to the step labeled <i>end of keyword</i> below.</p></li>

     <li><p>Let <var>kind code</var> be the substring of <var>keyword</var> from
     the first character in the string to the last character in the string that is before the first
     U+003A COLON character (:) in the string, <span>converted to ASCII lowercase</span>.</p>

     <li>

      <p>Jump to the appropriate step from the list below, based on the value of <var>kind
      code</var>:</p>

      <dl class="switch">

       <dt>If <var>kind code</var> is the string "<code>string</code>"</dt>
       <dd>

        <p>Let <var>kind<!--DND-v3:/DND-v4: s--></var> be <i>Plain Unicode string</i>.</p>

       </dd>

<!--DND-v3:
       <dt>If <var>kind code</var> is the string "<code>blob</code>"</dt>
       <dd>

        <p>Let <var>kinds</var> be <i>Plain Unicode string</i>, <i>Blob</i>, and
        <i>File</i>.</p>

       </dd>
-->

       <dt>If <var>kind code</var> is the string "<code>file</code>"</dt>
       <dd>

        <p>Let <var>kind<!--DND-v3:/DND-v4: s--></var> be <i>File</i>.</p>

       </dd>

<!--DND-v4:
       <dt>If <var>kind code</var> is the string "<code>object</code>"</dt>
       <dd>

        <p>Let <var>kinds</var> be <i>Plain Unicode string</i>, <i>Blob</i>, <i>File</i>,
        and <i>Object</i>.</p>

       </dd>
-->

       <dt>Otherwise</dt>
       <dd>

        <p>Skip to the step labeled <i>end of keyword</i> below.</p>

       </dd>

      </dl>

     </li>

     <li><p>Let <var>type</var> be the substring of <var>keyword</var> from the
     first character after the first U+003A COLON character (:) in the string, to the last character
     in the string, <span>converted to ASCII lowercase</span>.</p></li>

     <li><p>If there exist any items in the <span>drag data store item list</span> whose <span
     data-x="the drag data item kind">drag data item kind</span> is <!--DND-v3:/DND-v4: one of--> the
     kind<!--DND-v3:/DND-v4: s--> given in <var>kind<!--DND-v3:/DND-v4: s--></var> and
     whose <span data-x="the drag data item type string">drag data item type string</span> is <var>type</var>, then let <var>matched</var> be true.</p></li>

     <li><p><i>End of keyword</i>: Go on to the next keyword, if any, or the next step in the
     overall algorithm, if there are no more.</li>

    </ol>

   </li>

   <li>

    <p>The algorithm results in a match if <var>matched</var> is true, and does not
    otherwise.</p>

    <p>The algorithm results in a specified operation if <var>operation</var> is not
    unspecified. The specified operation, if one is specified, is the one given by <var>operation</var>.</p>

   </li>

  </ol>

  <p>The <dfn><code data-x="dom-dropzone">dropzone</code></dfn> IDL attribute must
  <span>reflect</span> the content attribute of the same name.</p>

  </div>

  <div class="example">

   <p>In this example, a <code>div</code> element is made into a drop target for image files using
   the <code data-x="attr-dropzone">dropzone</code> attribute. Images dropped into the target are
   then displayed.</p>

   <pre>&lt;div dropzone="copy file:image/png file:image/gif file:image/jpeg" ondrop="receive(event, this)">
 &lt;p>Drop an image here to have it displayed.&lt;/p>
&lt;/div>
&lt;script>
 function receive(event, element) {
   var data = event.dataTransfer.items;
   for (var i = 0; i &lt; data.length; i += 1) {
     if ((data[i].kind == 'file') && (data[i].type.match('^image/'))) {
       var img = new Image();
       img.src = window.createObjectURL(data[i].getAsFile());
       element.appendChild(img);
     }
   }
 }
&lt;/script></pre>

  </div>


<!--
  <h4 id="copy-and-paste">Copy and paste</h4>

  <p>Copy-and-paste is a form of drag-and-drop: the "copy" part is equivalent to dragging content to
  another application (the "clipboard"), and the "paste" part is equivalent to dragging content
  <em>from</em> another application.</p>

  <p>Select-and-paste (a model used by mouse operations in the X Window System) is equivalent to a
  drag-and-drop operation where the source is the selection.</p>


  <div class="impl">

  <h5 id="copy-to-clipboard">Copy to clipboard</h5>

  <p>When the user invokes a copy operation, the user agent must act as if the user had invoked a
  drag on the current selection. If the drag-and-drop operation initiates, then the user agent must
  act as if the user had indicated (as the <span>immediate user selection</span>) a hypothetical
  application representing the clipboard. Then, the user agent must act as if the user had ended the
  drag-and-drop operation without canceling it. If the drag-and-drop operation didn't get canceled,
  the user agent should then follow the relevant platform-specific conventions for copy operations
  (e.g. updating the clipboard).</p>

  <p>The events involved in this process are the <code data-x="event-dnd-dragstart">dragstart</code>,
  <code data-x="event-dnd-drag">drag</code>, and <code data-x="event-dnd-dragend">dragend</code> events.</p>


  <h5 id="cut-to-clipboard">Cut to clipboard</h5>

  <p>When the user invokes a cut operation, the user agent must act as if the user had invoked a
  copy operation (see the previous section), followed, if the copy was completed successfully, by <a
  href="#contenteditable-delete">a selection delete operation</a>.</p>

  <p>The events involved in this process are the <code data-x="event-dnd-dragstart">dragstart</code>,
  <code data-x="event-dnd-drag">drag</code>, and <code data-x="event-dnd-dragend">dragend</code> events.</p>


  <h5 id="paste-from-clipboard">Paste from clipboard</h5>

  <p>When the user invokes a clipboard paste operation, the user agent must act as if the user had
  invoked a drag on a hypothetical application representing the clipboard, setting the data
  associated with the drag as the content on the clipboard (in whatever formats are available).</p>

  <p>Then, the user agent must act as if the user had indicated (as the <span>immediate user
  selection</span>) the element with the keyboard focus, and then ended the drag-and-drop operation
  without canceling it.</p>

  <p>The events involved in this process are the <code data-x="event-dnd-dragenter">dragenter</code>,
  <code data-x="event-dnd-dragover">dragover</code>, <code data-x="event-dnd-dragexit">dragexit</code>, <code
  data-x="event-dnd-dragleave">dragleave</code>, and <code data-x="event-dnd-drop">drop</code> events.</p>


  <h5 id="paste-from-selection">Paste from selection</h5>

  <p>When the user invokes a selection paste operation, the user agent must act as if the user had
  invoked a drag on the current selection, then indicated (as the <span>immediate user
  selection</span>) the element with the keyboard focus, and then ended the drag-and-drop operation
  without canceling it.</p>

  <p>All the drag-and-drop events can be involved in this process.</p>

  </div>
-->


<!--ADD-TOPIC:Security-->
  <div class="impl">

  <h4 id="security-risks-in-the-drag-and-drop-model">Security risks in the drag-and-drop model</h4>

  <p>User agents must not make the data added to the <code>DataTransfer</code> object during the
  <code data-x="event-dnd-dragstart">dragstart</code> event available to scripts until the <code
  data-x="event-dnd-drop">drop</code> event, because otherwise, if a user were to drag sensitive
  information from one document to a second document, crossing a hostile third document in the
  process, the hostile document could intercept the data.</p>

  <p>For the same reason, user agents must consider a drop to be successful only if the user
  specifically ended the drag operation &mdash; if any scripts end the drag operation, it must be
  considered unsuccessful (canceled) and the <code data-x="event-dnd-drop">drop</code> event must not be
  fired.</p>

  <p>User agents should take care to not start drag-and-drop operations in response to script
  actions. For example, in a mouse-and-window environment, if a script moves a window while the user
  has his mouse button depressed, the UA would not consider that to start a drag. This is important
  because otherwise UAs could cause data to be dragged from sensitive sources and dropped into
  hostile documents without the user's consent.</p>

  <p>User agents should filter potentially active (scripted) content (e.g. HTML) when it is dragged
  and when it is dropped, using a safelist of known-safe features. Similarly, <span data-x="relative
  URL">relative URLs</span> should be turned into absolute URLs to avoid references changing in
  unexpected ways. This specification does not specify how this is performed.</p>

  <div class="example">

   <p>Consider a hostile page providing some content and getting the user to select and drag and
   drop (or indeed, copy and paste) that content to a victim page's <code
   data-x="attr-contenteditable">contenteditable</code> region. If the browser does not ensure that
   only safe content is dragged, potentially unsafe content such as scripts and event handlers in
   the selection, once dropped (or pasted) into the victim site, get the privileges of the victim
   site. This would thus enable a cross-site scripting attack.</p>

  </div>

  </div>
<!--REMOVE-TOPIC:Security-->



  <h2 id="browsers">Loading Web pages</h2>

  <div class="impl">

  <p>This section describes features that apply most directly to Web browsers. Having said that,
  except where specified otherwise, the requirements defined in this section <em>do</em> apply to
  all user agents, whether they are Web browsers or not.</p>

  </div>



  <h3 id="windows">Browsing contexts</h3>

  <p>A <dfn>browsing context</dfn> is an environment in which <code>Document</code> objects are
  presented to the user.</p>

  <p class="note">A tab or window in a Web browser typically contains a <span>browsing
  context</span>, as does an <code>iframe</code><span class="impl"> or <code>frame</code>s in a
  <code>frameset</code></span>.</p>

  <p>Each <span>browsing context</span> has a corresponding <code>WindowProxy</code> object.</p>

  <p>A <span>browsing context</span> has a <span>session history</span>, which lists the
  <code>Document</code> objects that that <span>browsing context</span> has presented, is
  presenting, or will present. At any time, one <code>Document</code> in each <span>browsing
  context</span> is designated the <dfn>active document</dfn>. A <code>Document</code>'s
  <span>browsing context</span> is that <span>browsing context</span> whose <span>session
  history</span> contains the <code>Document</code>, if any. (A <code>Document</code> created using
  an API such as <code data-x="dom-DOMImplementation-createDocument">createDocument()</code> has no
  <span>browsing context</span>.)</p>

  <p>Each <code>Document</code> in a <span>browsing context</span> is <dfn
  data-x="concept-document-window">associated</dfn> with a <code>Window</code> object. A
  <span>browsing context</span>'s <code>WindowProxy</code> object forwards everything to the
  <span>browsing context</span>'s <span>active document</span>'s <code>Window</code> object.</p>

  <p class="note">In general, there is a 1-to-1 mapping from the <code>Window</code> object to the
  <code>Document</code> object. There are two exceptions. First, a <code>Window</code> can be reused
  for the presentation of a second <code>Document</code> in the same <span>browsing context</span>,
  such that the mapping is then 1-to-2. This occurs when a <span>browsing context</span> is <span
  data-x="navigate">navigated</span> from the initial <code>about:blank</code> <code>Document</code>
  to another, with <span>replacement enabled</span>. Second, a <code>Document</code> can end up
  being reused for several <code>Window</code> objects when the <code
  data-x="dom-document-open">document.open()</code> method is used, such that the mapping is then
  many-to-1.</p>

  <p class="note">A <code>Document</code> does not necessarily have a <span>browsing context</span>
  associated with it. In particular, data mining tools are likely to never instantiate browsing
  contexts.</p>

  <hr>

  <p>A <span>browsing context</span> can have a <dfn>creator browsing context</dfn>, the
  <span>browsing context</span> that was responsible for its creation. If a <span>browsing
  context</span> has a <span>parent browsing context</span>, then that is its <span>creator browsing
  context</span>. Otherwise, if the <span>browsing context</span> has an <span>opener browsing
  context</span>, then <em>that</em> is its <span>creator browsing context</span>. Otherwise, the
  <span>browsing context</span> has no <span>creator browsing context</span>.</p>

  <p>If a <span>browsing context</span> <var>A</var> has a <span>creator browsing
  context</span>, then the <code>Document</code> that was the <span>active document</span> of that
  <span>creator browsing context</span> at the time <var>A</var> was created is the
  <dfn>creator <code>Document</code></dfn>.</p>

  <div class="impl">

  <p><dfn data-x="creating a new browsing context">Creating a browsing context</dfn>: When a <span>browsing context</span> is first created, it must be created with a single
  <code>Document</code> in its session history, whose <span data-x="the document's
  address">address</span> is <code>about:blank</code>, which is marked as being an <span
  data-x="HTML documents">HTML document</span>, whose <span data-x="document's character
  encoding">character encoding</span> is UTF-8, and which is both <span>ready for post-load
  tasks</span> and <span>completely loaded</span> immediately, along with a new <code>Window</code>
  object that the <code>Document</code> is associated with. The <code>Document</code> must have a
  single child <code>html</code> node, which itself has two empty child nodes: a <code>head</code>
  element, and a <code>body</code> element. As soon as this <code>Document</code> is created, the
  user agent must <span>implement the sandboxing</span> for it. If the <span>browsing context</span>
  has a <span>creator <code>Document</code></span>, then the <span>browsing context</span>'s
  <code>Document</code>'s <span data-x="the document's referrer">referrer</span> must be set to
  <span data-x="the document's address">the address</span> of that <span>creator
  <code>Document</code></span> at the time of the <span>browsing context</span>'s creation.</p>

  <p class="note">If the <span>browsing context</span> is created specifically to be immediately
  navigated, then that initial navigation will have <span>replacement enabled</span>.</p>

  <p id="about-blank-origin">The <span>origin</span> and <span>effective script origin</span> of the
  <code>about:blank</code> <code>Document</code> are set when the <code>Document</code> is created.
  If the new <span>browsing context</span> has a <span>creator browsing context</span>, then the
  <span>origin</span> of the <code>about:blank</code> <code>Document</code> is an <span
  data-x="concept-origin-alias">alias</span> to the <span>origin</span> of the <span>creator
  <code>Document</code></span> and the <span>effective script origin</span> of the
  <code>about:blank</code> <code>Document</code> is initially an <span
  data-x="concept-origin-alias">alias</span> to the <span>effective script origin</span> of the
  <span>creator <code>Document</code></span>. Otherwise, the <span>origin</span> of the
  <code>about:blank</code> <code>Document</code> is a globally unique identifier assigned when the
  new <span>browsing context</span> is created and the <span>effective script origin</span> of the
  <code>about:blank</code> <code>Document</code> is initially an <span
  data-x="concept-origin-alias">alias</span> to its <span>origin</span>.</p>

  </div>


  <h4 id="nested-browsing-contexts">Nested browsing contexts</h4>

  <p>Certain elements (for example, <code>iframe</code> elements) can instantiate further <span
  data-x="browsing context">browsing contexts</span>. These are called <dfn data-x="nested browsing
  context">nested browsing contexts</dfn>. If a browsing context <var>P</var> has a
  <code>Document</code> <var>D</var> with an element <var>E</var> that nests
  another browsing context <var>C</var> inside it, then <var>C</var> is said to be
  <dfn data-x="browsing context nested through">nested through</dfn> <var>D</var>, and <var>E</var> is said to be the <dfn>browsing context container</dfn> of <var>C</var>.
  If the <span>browsing context container</span> element <var>E</var> is <span data-x="in a
  Document">in</span> the <code>Document</code> <var>D</var>, then <var>P</var> is
  said to be the <dfn>parent browsing context</dfn> of <var>C</var> and <var>C</var> is said to be a <dfn>child browsing context</dfn> of <var>P</var>.
  Otherwise, the <span>nested browsing context</span> <var>C</var> has no <span>parent
  browsing context</span>.</p>

  <p>A browsing context <var>A</var> is said to be an <dfn data-x="ancestor browsing
  context">ancestor</dfn> of a browsing context <var>B</var> if there exists a browsing
  context <var>A</var> that is a <span>child browsing context</span> of <var>A</var> and that is itself an <span data-x="ancestor browsing context">ancestor</span> of
  <var>B</var>, or if the browsing context <var>A</var> is the
  <span>parent browsing context</span> of <var>B</var>.</p>

  <p>A browsing context that is not a <span>nested browsing context</span> has no <span>parent
  browsing context</span>, and is the <dfn>top-level browsing context</dfn> of all the browsing
  contexts for which it is an <span>ancestor browsing context</span>.</p>

  <p>The transitive closure of <span data-x="parent browsing context">parent browsing contexts</span>
  for a <span>nested browsing context</span> gives the list of <span data-x="ancestor browsing
  context">ancestor browsing contexts</span>.</p>

  <p>The <dfn>list of the descendant browsing contexts</dfn> of a <code>Document</code> <var>d</var> is the (ordered) list returned by the following algorithm:</p>

  <ol>

   <li><p>Let <var>list</var> be an empty list.</p></li>

   <li>

    <p>For each <span>child browsing context</span> of <var>d</var> that is <span
    data-x="browsing context nested through">nested through</span> an element that is <span data-x="in
    a document">in the <code>Document</code></span> <var>d</var>, in the <span>tree
    order</span> of the elements nesting those <span data-x="browsing context">browsing
    contexts</span>, run these substeps:</p>

    <ol>

     <li><p>Append that <span>child browsing context</span> to the list <var>list</var>.</p>

     <li><p>Append the <span>list of the descendant browsing contexts</span> of the <span>active
     document</span> of that <span>child browsing context</span> to the list <var>list</var>.</p></li>

    </ol>

   </li>

   <li><p>Return the constructed <var>list</var>.</p></li>

  </ol>

  <p>A <code>Document</code> is said to be <dfn>fully active</dfn> when it is the <span>active
  document</span> of its <span>browsing context</span>, and either its browsing context is a
  <span>top-level browsing context</span>, or it has a <span>parent browsing context</span> and the
  <code>Document</code> <span data-x="browsing context nested through">through which</span> it is
  <span data-x="nested browsing context">nested</span> is itself <span>fully active</span>.</p>

  <p>Because they are nested through an element, <span data-x="child browsing context">child browsing
  contexts</span> are always tied to a specific <code>Document</code> in their <span>parent browsing
  context</span>. User agents must not allow the user to interact with <span data-x="child browsing
  context">child browsing contexts</span> of elements that are in <code>Document</code>s that are
  not themselves <span>fully active</span>.</p>

  <p>A <span>nested browsing context</span> can have a <span>seamless browsing context flag</span>
  set, if it is embedded through an <code>iframe</code> element with a <code
  data-x="attr-iframe-seamless">seamless</code> attribute.</p>

  <p>A <span>nested browsing context</span> can be put into a <dfn>delaying <code
  data-x="event-load">load</code> events mode</dfn>. This is used when it is <span
  data-x="navigate">navigated</span>, to <span>delay the load event</span> of the <span>browsing
  context container</span> before the new <code>Document</code> is created.</p>

<!--(There's no current way for this to happen, since removing an iframe from a document discards its browsing context)
  <p class="note">A <span>nested browsing context</span> can in some cases be taken out of its
  <span>parent browsing context</span> (e.g. if an <code>iframe</code> element is removed from its
  <code>Document</code>). In such a situation, the <span>nested browsing context</span> has no
  <span>parent browsing context</span>, but it still has the same <span>browsing context
  container</span> and is still <span data-x="browsing context nested through">nested through</span>
  that element's <span>node document</span>. Such a <span>nested browsing context</span> is <em>not</em>
  a <span>top-level browsing context</span>, and cannot contain <code>Document</code>s that are
  <span>fully active</span>. Furthermore, if a <span>browsing context container</span> (such as an
  <code>iframe</code>) is moved to another <code>Document</code>, then the <span>parent browsing
  context</span> of its <span>nested browsing context</span> will change.</p>
-->

  <p>The <dfn>document family</dfn> of a <span>browsing context</span> consists of the union of all
  the <code>Document</code> objects in that <span>browsing context</span>'s <span>session
  history</span> and the <span data-x="document family">document families</span> of all those
  <code>Document</code> objects. The <span>document family</span> of a <code>Document</code> object
  consists of the union of all the <span data-x="document family">document families</span> of the
  <span data-x="browsing context">browsing contexts</span> that are <span data-x="browsing context
  nested through">nested through</span> the <code>Document</code> object.</p>


  <h5 id="navigating-nested-browsing-contexts-in-the-dom">Navigating nested browsing contexts in the DOM</h5>

  <dl class="domintro">

   <dt><var>window</var> . <code subdfn data-x="dom-top">top</code></dt>

   <dd>

    <p>Returns the <code>WindowProxy</code> for the <span>top-level browsing context</span>.</p>

   </dd>

   <dt><var>window</var> . <code subdfn data-x="dom-parent">parent</code></dt>

   <dd>

    <p>Returns the <code>WindowProxy</code> for the <span>parent browsing context</span>.</p>

   </dd>

   <dt><var>window</var> . <code subdfn data-x="dom-frameElement">frameElement</code></dt>

   <dd>

    <p>Returns the <code>Element</code> for the <span>browsing context container</span>.</p>

    <p>Returns null if there isn't one, and in cross-origin situations.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-top">top</code></dfn> IDL attribute on the <code>Window</code> object
  of a <code>Document</code> in a <span>browsing context</span> <var>b</var> must return
  the <code>WindowProxy</code> object of its <span>top-level browsing context</span> (which would be
  its own <code>WindowProxy</code> object if it was a <span>top-level browsing context</span>
  itself), if it has one, or its own <code>WindowProxy</code> object otherwise (e.g. if it was a
  detached <span>nested browsing context</span>).</p>

  <p>The <dfn><code data-x="dom-parent">parent</code></dfn> IDL attribute on the <code>Window</code>
  object of a <code>Document</code> in a <span>browsing context</span> <var>b</var> must
  return the <code>WindowProxy</code> object of the <span>parent browsing context</span>, if there
  is one (i.e. if <var>b</var> is a <span>child browsing context</span>), or the
  <code>WindowProxy</code> object of the <span>browsing context</span> <var>b</var> itself,
  otherwise (i.e. if it is a <span>top-level browsing context</span> or a detached <span>nested
  browsing context</span>).</p>

  <p>The <dfn><code data-x="dom-frameElement">frameElement</code></dfn> IDL attribute on the
  <code>Window</code> object of a <code>Document</code> <var>d</var>, on getting, must run
  the following algorithm:</p>

  <ol>

   <li><p>If <var>d</var> is not a <code>Document</code> in a <span>nested browsing
   context</span>, return null and abort these steps.</p></li>

   <li><p>If the <span>browsing context container</span>'s <span>node document</span> does not have the
   <span data-x="same origin">same</span> <span>effective script origin</span> as the
   <span>effective script origin</span> specified by the <span>entry settings object</span>, then
   return null and abort these steps.</p></li>

   <li><p>Return the <span>browsing context container</span> for <var>b</var>.</p></li>

  </ol>

  </div>



  <h4 id="auxiliary-browsing-contexts">Auxiliary browsing contexts</h4>

  <p>It is possible to create new browsing contexts that are related to a <span>top-level browsing
  context</span> without being nested through an element. Such browsing contexts are called <dfn
  data-x="auxiliary browsing context">auxiliary browsing contexts</dfn>. Auxiliary browsing contexts
  are always <span data-x="top-level browsing context">top-level browsing contexts</span>.</p>

  <p>An <span>auxiliary browsing context</span> has an <dfn>opener browsing context</dfn>, which is
  the <span>browsing context</span> from which the <span>auxiliary browsing context</span> was
  created.</p>


  <h5 id="navigating-auxiliary-browsing-contexts-in-the-dom">Navigating auxiliary browsing contexts in the DOM</h5>

  <p>The <dfn><code data-x="dom-opener">opener</code></dfn> IDL attribute on the <code>Window</code>
  object, on getting, must return the <code>WindowProxy</code> object of the <span>browsing
  context</span> from which the current <span>browsing context</span> was created (its <span>opener
  browsing context</span>), if there is one, if it is still available, and if the current
  <span>browsing context</span> has not <i data-x="disowned its opener">disowned its opener</i>;
  otherwise, it must return null. On setting, if the new value is null then the current
  <span>browsing context</span> must <dfn data-x="disowned its opener">disown its opener</dfn>; if
  the new value is anything else then the user agent must

    <!-- dark magic incantation begins -->
    call the [[DefineOwnProperty]] internal method of the <code>Window</code> object, passing the
    property name "<code>opener</code>" as the property key, and the Property Descriptor {
    [[Value]]: <var>value</var>, [[Writable]]: true, [[Enumerable]]: true,
    [[Configurable]]: true } as the property descriptor,
    <!-- dark magic incantation ends -->

  where <var>value</var> is the new value.</p>

  <h4 id="secondary-browsing-contexts">Secondary browsing contexts</h4>

  <p>User agents may support <dfn data-x="secondary browsing context">secondary browsing
  contexts</dfn>, which are <span data-x="browsing context">browsing contexts</span> that form part
  of the user agent's interface, apart from the main content area.</p>

<!-- This only exists for the purpose of defining
  rel=sidebar, which was dropped due to wg decision in
     http://www.w3.org/Bugs/Public/show_bug.cgi?id=11183
  and then moved to the wiki --><!--START FORK-->
<!--
  <p class="note">The <code data-x="rel-sidebar">sidebar</code> link type uses <span data-x="secondary
  browsing context">secondary browsing contexts</span>.</p>
-->
<!--END FORK-->


<!--ADD-TOPIC:Security-->
  <div class="impl">

  <h4 id="security-nav">Security</h4>

  <p id="security-1">A <span>browsing context</span> <var>A</var> is <dfn>familiar
  with</dfn> a second <span>browsing context</span> <var>B</var> if one of the following
  conditions is true:</p>

  <ul>

   <li>Either the <span>origin</span> of the <span>active document</span> of <var>A</var>
   is the <span data-x="same origin">same</span> as the <span>origin</span> of the <span>active
   document</span> of <var>B</var>, or</li>

   <li>The browsing context <var>A</var> is a <span>nested browsing context</span> with a
   <span>top-level browsing context</span>, and its <span>top-level browsing context</span> is <var>B</var>, or</li>

   <li>The browsing context <var>B</var> is an <span>auxiliary browsing context</span> and
   <var>A</var> is <span>familiar with</span> <var>B</var>'s <span>opener
   browsing context</span>, or</li>

   <li>The browsing context <var>B</var> is not a <span>top-level browsing context</span>,
   but there exists an <span>ancestor browsing context</span> of <var>B</var> whose
   <span>active document</span> has the <span data-x="same origin">same</span> <span>origin</span> as
   the <span>active document</span> of <var>A</var> (possibly in fact being <var>A</var> itself).</li>

  </ul>

  <hr>

  <p>A <span>browsing context</span> <var>A</var> is <dfn>allowed to navigate</dfn> a
  second <span>browsing context</span> <var>B</var> if the following algorithm terminates
  positively:</p>

  <ol>

   <li><p>If <var>A</var> is not the same <span>browsing context</span> as <var>B</var>, and <var>A</var> is not one of the <span data-x="ancestor browsing
   context">ancestor browsing contexts</span> of <var>B</var>, and <var>B</var>
   is not a <span>top-level browsing context</span>, and <var>A</var>'s <span>active
   document</span>'s <span>active sandboxing flag set</span> has its <span>sandboxed navigation
   browsing context flag</span> set, then abort these steps negatively.</p></li>

   <li><p>Otherwise, if <var>B</var> is a <span>top-level browsing context</span>, and is
   one of the <span data-x="ancestor browsing context">ancestor browsing contexts</span> of <var>A</var>, and <var>A</var>'s <span>node document</span>'s <span>active sandboxing
   flag set</span> has its <span>sandboxed top-level navigation browsing context flag</span> set,
   then abort these steps negatively.</p></li>

   <li><p>Otherwise, if <var>B</var> is a <span>top-level browsing context</span>, and is
   neither <var>A</var> nor one of the <span data-x="ancestor browsing context">ancestor
   browsing contexts</span> of <var>A</var>, and <var>A</var>'s
   <code>Document</code>'s <span>active sandboxing flag set</span> has its <span>sandboxed
   navigation browsing context flag</span> set, and <var>A</var> is not the <span>one
   permitted sandboxed navigator</span> of <var>B</var>, then abort these steps
   negatively.</p></li> <!-- we do not check the /sandboxed auxiliary navigation browsing context
   flag/ here, that's only for actually opening the new top-level browsing context. -->

   <li><p>Otherwise, terminate positively!</p></li>

  </ol>

  <hr>

  <p>An element has a <dfn>browsing context scope origin</dfn> if its <code>Document</code>'s
  <span>browsing context</span> is a <span>top-level browsing context</span> or if all of its
  <code>Document</code>'s <span data-x="ancestor browsing context">ancestor browsing contexts</span>
  all have <span data-x="active document">active documents</span> whose <span>origin</span> are the
  <span>same origin</span> as the element's <span>node document</span>'s <span>origin</span>. If an
  element has a <span>browsing context scope origin</span>, then its value is the
  <span>origin</span> of the element's <span>node document</span>.</p>

  </div>
<!--REMOVE-TOPIC:Security-->


  <div class="impl">

  <h4 id="groupings-of-browsing-contexts">Groupings of browsing contexts</h4>

  <p>Each <span>browsing context</span> is defined as having a list of one or more <dfn>directly
  reachable browsing contexts</dfn>. These are:</p>

  <ul>

   <li>The <span>browsing context</span> itself.</li>

   <li>All the <span>browsing context</span>'s <span data-x="child browsing context">child browsing
   contexts</span>.</li>

   <li>The <span>browsing context</span>'s <span>parent browsing context</span>.</li>

   <li>All the <span data-x="browsing context">browsing contexts</span> that have the <span>browsing
   context</span> as their <span>opener browsing context</span>.</li>

   <li>The <span>browsing context</span>'s <span>opener browsing context</span>.</li>

  </ul>

  <p>The transitive closure of all the <span data-x="browsing context">browsing contexts</span> that
  are <span>directly reachable browsing contexts</span> forms a <dfn>unit of related browsing
  contexts</dfn>.</p>

  <p>Each <span>unit of related browsing contexts</span> is then further divided into the smallest
  number of groups such that every member of each group has an <span>active document</span> with an
  <span>effective script origin</span> that, through appropriate manipulation of the <code
  data-x="dom-document-domain">document.domain</code> attribute, could be made to be the same as
  other members of the group, but could not be made the same as members of any other group. Each
  such group is a <dfn>unit of related similar-origin browsing contexts</dfn>.</p>

  <p class="note">There is also at most one <span>event loop</span> per <span>unit of related
  similar-origin browsing contexts</span> (though several <span data-x="unit of related
  similar-origin browsing contexts">units of related similar-origin browsing contexts</span> can
  have a shared <span>event loop</span>).</p>

  </div>



  <h4 id="browsing-context-names">Browsing context names</h4>

  <p>Browsing contexts can have a <dfn>browsing context name</dfn>. By default, a browsing context
  has no name (its name is not set).</p>

  <p>A <dfn>valid browsing context name</dfn> is any string with at least one character that does
  not start with a U+005F LOW LINE character. (Names starting with an underscore are reserved for
  special keywords.)</p>

  <p>A <dfn>valid browsing context name or keyword</dfn> is any string that is either a <span>valid
  browsing context name</span> or that is an <span>ASCII case-insensitive</span> match for one of:
  <code>_blank</code>, <code>_self</code>, <code>_parent</code>, or <code
 >_top</code>.</p>

  <p>These values have different meanings based on whether the page is sandboxed or not, as
  summarized in the following (non-normative) table. In this table, "current" means the
  <span>browsing context</span> that the link or script is in, "parent" means the <span>parent
  browsing context</span> of the one the link or script is in, "master" means the nearest
  <span>ancestor browsing context</span> of the one the link or script is in that is not itself in a
  <span data-x="attr-iframe-seamless">seamless iframe</span>, "top" means the <span>top-level
  browsing context</span> of the one the link or script is in, "new" means a new <span>top-level
  browsing context</span> or <span>auxiliary browsing context</span> is to be created, subject to
  various user preferences and user agent policies, "none" means that nothing will happen, and
  "maybe new" means the same as "new" if the "<code
  data-x="attr-iframe-sandbox-allow-popups">allow-popups</code>" keyword is also specified on the
  <code data-x="attr-iframe-sandbox">sandbox</code> attribute (or if the user overrode the
  sandboxing), and the same as "none" otherwise.</p>

  <table>
   <thead>
    <tr>
     <th rowspan=2>Keyword
     <th rowspan=2>Ordinary effect
     <th colspan=5>Effect in an <code>iframe</code> with...
    <tr>           <!-- nothing -->
     <th><code>seamless=""</code>
     <th><code>sandbox=""</code>
     <th><code>sandbox="" seamless=""</code>
     <th><code>sandbox="allow-top-navigation"</code>
     <th><code>sandbox="allow-top-navigation" seamless=""</code>

   <tbody>
    <tr>
     <td>none specified, for links and form submissions <!-- same as empty string -->
     <td>current
     <td>master
     <td>current
     <td>master
     <td>current
     <td>master

    <tr>
     <td>empty string
     <td>current
     <td>master
     <td>current
     <td>master
     <td>current
     <td>master

    <tr>
     <td><code>_blank</code>
     <td>new
     <td>new
     <td>maybe new
     <td>maybe new
     <td>maybe new
     <td>maybe new

    <tr>
     <td><code>_self</code>
     <td>current
     <td>current
     <td>current
     <td>current
     <td>current
     <td>current

    <tr>
     <td><code>_parent</code> if there isn't a parent
     <td>current
     <td>current
     <td>current
     <td>current
     <td>current
     <td>current

    <tr>
     <td><code>_parent</code> if parent is also top
     <td>parent/top
     <td>parent/top
     <td>none
     <td>none
     <td>parent/top
     <td>parent/top

    <tr>
     <td><code>_parent</code> if there is one and it's not top
     <td>parent
     <td>parent
     <td>none
     <td>none
     <td>none
     <td>none

    <tr>
     <td><code>_top</code> if top is current
     <td>current
     <td>current
     <td>current
     <td>current
     <td>current
     <td>current

    <tr>
     <td><code>_top</code> if top is not current
     <td>top
     <td>top
     <td>none
     <td>none
     <td>top
     <td>top

    <tr>
     <td>name that doesn't exist
     <td>new
     <td>new
     <td>maybe new
     <td>maybe new
     <td>maybe new
     <td>maybe new

    <tr>
     <td>name that exists and is a descendant
     <td>specified descendant
     <td>specified descendant
     <td>specified descendant
     <td>specified descendant
     <td>specified descendant
     <td>specified descendant

    <tr>
     <td>name that exists and is current
     <td>current
     <td>current
     <td>current
     <td>current
     <td>current
     <td>current

    <tr>
     <td>name that exists and is an ancestor that is top
     <td>specified ancestor
     <td>specified ancestor
     <td>none
     <td>none
     <td>specified ancestor/top
     <td>specified ancestor/top

    <tr>
     <td>name that exists and is an ancestor that is not top
     <td>specified ancestor
     <td>specified ancestor
     <td>none
     <td>none
     <td>none
     <td>none

    <tr>
     <td>other name that exists with common top
     <td>specified
     <td>specified
     <td>none
     <td>none
     <td>none
     <td>none

    <tr>
     <td>name that exists with different top, if <span data-x="familiar with">familiar</span> and <span>one permitted sandboxed navigator</span>
     <td>specified
     <td>specified
     <td>specified
     <td>specified
     <td>specified
     <td>specified

    <tr>
     <td>name that exists with different top, if <span data-x="familiar with">familiar</span> but not <span>one permitted sandboxed navigator</span>
     <td>specified
     <td>specified
     <td>none
     <td>none
     <td>none
     <td>none

    <tr>
     <td>name that exists with different top, not <span data-x="familiar with">familiar</span>
     <td>new
     <td>new
     <td>maybe new
     <td>maybe new
     <td>maybe new
     <td>maybe new

  </table>

  <p class="tablenote"><small>Most of the restrictions on sandboxed browsing contexts are applied by
  other algorithms, e.g. the <span data-x="navigate">navigation</span> algorithm, not <span>the rules
  for choosing a browsing context given a browsing context name</span> given below.</small></p>

  <div class="impl">

  <hr>

  <p>An algorithm is <dfn>allowed to show a popup</dfn> if any of the following conditions is
  true:</p>

  <ul>

   <li><p>The <span data-x="concept-task">task</span> in which the algorithm is running is currently
   processing an <span>activation behavior</span> whose <code data-x="event-click">click</code> event
   was <span data-x="concept-events-trusted">trusted</span>.</li>

   <li>

    <p>The <span data-x="concept-task">task</span> in which the algorithm is running is currently
    running the event listener for a <span data-x="concept-events-trusted">trusted</span> event whose
    type is in the following list:</p>

    <ul class="brief">
     <li><code data-x="event-change">change</code></li>
     <li><code data-x="event-click">click</code></li>
     <li><code data-x="event-dblclick">dblclick</code></li>
     <li><code data-x="event-mouseup">mouseup</code></li>
     <li><code data-x="event-reset">reset</code></li>
     <li><code data-x="event-submit">submit</code></li>
    </ul>

   </li>

   <li>

    <p>The <span data-x="concept-task">task</span> in which the algorithm is running was <span
    data-x="queue a task">queued</span> by an algorithm that was <span>allowed to show a popup</span>,
    and the chain of such algorithms started within a user-agent defined timeframe.</p>

    <p class="example">For example, if a user clicked a button, it might be acceptable for a popup
    to result from that after 4 seconds, but it would likely not be acceptable for a popup to result
    from that after 4 hours.</p>

   </li>

  </ul>

  <hr>

  <p><dfn>The rules for choosing a browsing context given a browsing context name</dfn> are as
  follows. The rules assume that they are being applied in the context of a <span>browsing
  context</span>, as part of the execution of a <span data-x="concept-task">task</span>.</p>

  <ol>

   <li>

    <p>If the given browsing context name is the empty string or <code>_self</code>, then
    the chosen browsing context must be the current one.</p>

    <p>If the given browsing context name is <code>_self</code>, then this is an
    <span>explicit self-navigation override</span>, which overrides the behavior of the
    <span>seamless browsing context flag</span> set by the <code
    data-x="attr-iframe-seamless">seamless</code> attribute on <code>iframe</code> elements.</p>

   </li>

   <li><p>If the given browsing context name is <code>_parent</code>, then the chosen
   browsing context must be the <span><em>parent</em> browsing context</span> of the current one,
   unless there isn't one, in which case the chosen browsing context must be the current browsing
   context.</p></li>

   <li><p>If the given browsing context name is <code>_top</code>, then the chosen browsing
   context must be the <span>top-level browsing context</span> of the current one, if there is one,
   or else the current browsing context.</p></li>

   <li>

    <p>If the given browsing context name is not <code>_blank</code> and there exists a
    browsing context whose <span data-x="browsing context name">name</span> is the same as the given
    browsing context name, and the current browsing context is <span>familiar with</span> that
    browsing context, and the user agent determines that the two browsing contexts are related
    enough that it is ok if they reach each other, then that browsing context must be the chosen
    one. If there are multiple matching browsing contexts, the user agent should select one in some
    arbitrary consistent manner, such as the most recently opened, most recently focused, or more
    closely related.</p>

    <p>If the browsing context is chosen by this step to be the current browsing context, then this
    is also an <span>explicit self-navigation override</span>.</p>

   </li>

   <li>

    <p>Otherwise, a new browsing context is being requested, and what happens depends on the user
    agent's configuration and abilities &mdash; it is determined by the rules given for the first
    applicable option from the following list:</p>

    <dl class="switch">

     <dt id="popup-blocker">If the algorithm is not <span>allowed to show a popup</span> and the
     user agent has been configured to not show popups (i.e. the user agent has a "popup blocker"
     enabled)</dt>

     <dd>

      <p>There is no chosen browsing context. The user agent may inform the user that a popup has
      been blocked.</p>

     </dd>

     <dt id="sandboxWindowOpen">If the current browsing context's <span>active document</span>'s
     <span>active sandboxing flag set</span> has the <span>sandboxed auxiliary navigation browsing
     context flag</span> set.</dt>

     <dd>

      <p>Typically, there is no chosen browsing context.</p>

      <p>The user agent may offer to <span data-x="creating a new browsing context">create</span> a new <span>top-level browsing context</span> or reuse
      an existing <span>top-level browsing context</span>. If the user picks one of those options,
      then the designated browsing context must be the chosen one (the browsing context's name isn't
      set to the given browsing context name). The default behavior (if the user agent doesn't
      offer the option to the user, or if the user declines to allow a browsing context to be used)
      must be that there must not be a chosen browsing context.</p>

      <p class="warning">If this case occurs, it means that an author has explicitly sandboxed the
      document that is trying to open a link.</p>

     </dd>


     <dt id="noopener">If the user agent has been configured such that in this instance it will
     create a new browsing context, and the browsing context is being requested as part of <span
     data-x="following hyperlinks">following a hyperlink</span> whose <a href="#linkTypes">link
     types</a> include the <code data-x="rel-noreferrer">noreferrer</code> keyword</dt>

     <dd><p>A new <span>top-level browsing context</span> must be <span data-x="creating a new browsing context">created</span>. If the given browsing
     context name is not <code>_blank</code>, then the new top-level browsing context's
     name must be the given browsing context name (otherwise, it has no name). The chosen browsing
     context must be this new browsing context. The creation of such a <span>browsing context</span>
     is <dfn>a new start for session storage</dfn>.</p>

     <p class="note">If it is immediately <span data-x="navigate">navigated</span>, then the
     navigation will be done with <span>replacement enabled</span>.</p></dd>


     <dt>If the user agent has been configured such that in this instance it will create a new
     browsing context, and the <code data-x="rel-noreferrer">noreferrer</code> keyword doesn't
     apply</dt>

     <dd><p>A new <span>auxiliary browsing context</span> must be created, with the <span>opener
     browsing context</span> being the current one. If the given browsing context name is not <code
    >_blank</code>, then the new auxiliary browsing context's name must be the given
     browsing context name (otherwise, it has no name). The chosen browsing context must be this new
     browsing context.</p>

     <p class="note">If it is immediately <span data-x="navigate">navigated</span>, then the
     navigation will be done with <span>replacement enabled</span>.</p></dd>


     <dt>If the user agent has been configured such that in this instance it will reuse the current
     browsing context</dt>

     <dd><p>The chosen browsing context is the current browsing context.</p></dd>


     <dt>If the user agent has been configured such that in this instance it will not find a
     browsing context</dt>

     <dd><p>There must not be a chosen browsing context.</p></dd>

    </dl>

    <p>User agent implementors are encouraged to provide a way for users to configure the user agent
    to always reuse the current browsing context.</p>

    <p>If the current browsing context's <span>active document</span>'s <span>active sandboxing flag
    set</span> has both the <span>sandboxed navigation browsing context flag</span> and
    <span>sandbox propagates to auxiliary browsing contexts flag</span> set, and the chosen browsing
    context picked above, if any, is a new browsing context, then all the flags that are set in the
    current browsing context's <span>active document</span>'s <span>active sandboxing flag
    set</span> when the new browsing context is created must be set in the new browsing context's
    <span>popup sandboxing flag set</span>, and the current browsing context must be set as the new
    browsing context's <span>one permitted sandboxed navigator</span>.</p>

   </li>

  </ol>

  </div>


<!--TOPIC:DOM APIs-->
  <h3>The <code>Window</code> object</h3>

  <pre class="idl">[PrimaryGlobal] <!-- Exposed=Window is implied because it's the primary global -->
/*sealed*/ interface <dfn>Window</dfn> : <span>EventTarget</span> {
  // the current browsing context
  [Unforgeable] readonly attribute <span>WindowProxy</span> <span data-x="dom-window">window</span>;
  [Replaceable] readonly attribute <span>WindowProxy</span> <span data-x="dom-self">self</span>;
  [Unforgeable] readonly attribute <span>Document</span> <span data-x="dom-document">document</span>;
  attribute DOMString <span data-x="dom-name">name</span>; <!-- not [Replaceable] per WebKit and IE8 -->
  [PutForwards=<span data-x="dom-location-href">href</span>, Unforgeable] readonly attribute <span>Location</span> <span data-x="dom-location">location</span>;
  readonly attribute <span>History</span> <span data-x="dom-history">history</span>;
  [Replaceable] readonly attribute <span>BarProp</span> <span data-x="dom-window-locationbar">locationbar</span>;
  [Replaceable] readonly attribute <span>BarProp</span> <span data-x="dom-window-menubar">menubar</span>;
  [Replaceable] readonly attribute <span>BarProp</span> <span data-x="dom-window-personalbar">personalbar</span>;
  [Replaceable] readonly attribute <span>BarProp</span> <span data-x="dom-window-scrollbars">scrollbars</span>;
  [Replaceable] readonly attribute <span>BarProp</span> <span data-x="dom-window-statusbar">statusbar</span>;
  [Replaceable] readonly attribute <span>BarProp</span> <span data-x="dom-window-toolbar">toolbar</span>;<!--
  [Replaceable] readonly attribute <span>BarProp</span> <span data-x="dom-window-directories">directories</span>; // legacy (Gecko-only) -->
  attribute DOMString <span data-x="dom-window-status">status</span>;
  void <span data-x="dom-window-close">close</span>();
  readonly attribute boolean <span data-x="dom-window-closed">closed</span>;
  void <span data-x="dom-window-stop">stop</span>();
  void <span data-x="dom-window-focus">focus</span>();
  void <span data-x="dom-window-blur">blur</span>();

  // other browsing contexts
  [Replaceable] readonly attribute <span>WindowProxy</span> <span data-x="dom-frames">frames</span>;
  [Replaceable] readonly attribute unsigned long <span data-x="dom-length">length</span>;
  [Unforgeable] readonly attribute <span>WindowProxy</span> <span data-x="dom-top">top</span>;
  attribute any <span data-x="dom-opener">opener</span>;
  [Replaceable] readonly attribute <span>WindowProxy</span> <span data-x="dom-parent">parent</span>;
  readonly attribute <span>Element</span>? <span data-x="dom-frameElement">frameElement</span>;
  <span>WindowProxy</span> <span data-x="dom-open">open</span>(optional DOMString url = "about:blank", optional DOMString target = "_blank", [TreatNullAs=EmptyString] optional DOMString features = "", optional boolean replace = false);
  <span data-x="dom-window-item">getter</span> <span>WindowProxy</span> (unsigned long index);
  <span data-x="dom-window-namedItem">getter</span> object (DOMString name);

  // the user agent
  readonly attribute <span>Navigator</span> <span data-x="dom-navigator">navigator</span>; <!-- IE also has window.clientInformation === window.navigator -->
  [Replaceable, SameObject] readonly attribute <span>External</span> <span data-x="dom-external">external</span>;
  readonly attribute <span>ApplicationCache</span> <span data-x="dom-applicationCache">applicationCache</span>;

  // user prompts
  void <span data-x="dom-alert">alert</span>();
  void <span data-x="dom-alert">alert</span>(DOMString message);
  boolean <span data-x="dom-confirm">confirm</span>(optional DOMString message = "");
  DOMString? <span data-x="dom-prompt">prompt</span>(optional DOMString message = "", optional DOMString default = "");
  void <span data-x="dom-print">print</span>();
  any <span data-x="dom-showModalDialog">showModalDialog</span>(DOMString url, optional any argument<!--, optional DOMString features-->); // deprecated
};
<span>Window</span> implements <span>GlobalEventHandlers</span>;
<span>Window</span> implements <span>WindowEventHandlers</span>;

callback <dfn>FrameRequestCallback</dfn> = void (<span>DOMHighResTimeStamp</span> time);</pre>

<!-- for more features to add here, look here:
 http://msdn.microsoft.com/workshop/author/dhtml/reference/objects/obj_window.asp
 http://www.mozilla.org/docs/dom/domref/dom_window_ref.html
 http://lxr.mozilla.org/mozilla/source/dom/public/idl/base/nsIDOMWindow.idl - scrollBy, etc
 http://lxr.mozilla.org/mozilla/source/dom/public/idl/base/nsIDOMWindowInternal.idl - DOM level 0
-->

  <dl class="domintro">

   <dt><var>window</var> . <code subdfn data-x="dom-window">window</code></dt>
   <dt><var>window</var> . <code subdfn data-x="dom-frames">frames</code></dt>
   <dt><var>window</var> . <code subdfn data-x="dom-self">self</code></dt>

   <dd>

    <p>These attributes all return <var>window</var>.</p>

   </dd>


   <dt><var>window</var> . <code subdfn data-x="dom-document">document</code></dt>

   <dd>

    <p>Returns the <code>Document</code> associated with <var>window</var>.</p>

   </dd>


   <dt><var>document</var> . <code subdfn data-x="dom-document-defaultView">defaultView</code></dt>

   <dd>

    <p>Returns the <code>Window</code> object of the <span>active document</span>.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <code>Window</code> has an <dfn data-x="concept-window-https-state">HTTPS state</dfn>,
  which represents the security properties of the network channel used to deliver the
  <code>Document</code> with which the <code>Window</code> is associated. The value will be one of
  "<code>modern</code>", "<code>deprecated</code>", or "<code
 >none</code>". If it is not explicitly set, then its value is "<code
 >none</code>".</p>

  <p>The <dfn><code data-x="dom-window">window</code></dfn>, <dfn><code data-x="dom-frames">frames</code></dfn>, and <dfn><code data-x="dom-self">self</code></dfn>
  IDL attributes must all return the <code>Window</code> object's <span>browsing context</span>'s
  <code>WindowProxy</code> object.</p>

  <p>The <dfn><code data-x="dom-document">document</code></dfn> IDL attribute must return
  <span data-x="concept-document-window">the <code>Window</code> object's newest <code>Document</code> object</span>.</p>

  <p class="note">The <code>Document</code> object associated with a <code>Window</code> object can
  change in exactly one case: when the <span>navigate</span> algorithm <span data-x="initialize the
  Document object">initializes a new <code>Document</code> object</span> for the first page loaded
  in a <span>browsing context</span>. In that specific case, the <code>Window</code> object of the
  original <code>about:blank</code> page is reused and gets a new <code>Document</code> object.</p>

  <p>The <dfn><code data-x="dom-document-defaultView">defaultView</code></dfn> IDL attribute of the
  <code>Document</code> interface must return the <code>Document</code>'s <span>browsing
  context</span>'s <code>WindowProxy</code> object, if there is one, or null otherwise.</p>

  <hr>

  <p>For historical reasons, <code>Window</code> objects must also have a writable, configurable,
  non-enumerable property named <dfn><code>HTMLDocument</code></dfn> whose value is the
  <code>Document</code> interface object.</p>

  </div>


<!--ADD-TOPIC:Security-->
  <div class="impl">

  <h4 id="security-window">Security</h4>

  <p class="critical">This section describes a security model that is underdefined, imperfect, and
  does not match implementations. Work is ongoing to attempt to resolve this, but in the meantime,
  please do not rely on this section for precision. Implementors are urged to send their feedback on
  how cross-origin cross-global access to <code>Window</code> and <code>Location</code> objects
  should work. See <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=20701">bug 20701</a>.</p>

  <p id="security-2">User agents must throw a <code>SecurityError</code> exception whenever any
  properties of a <code>Window</code> object are accessed when the <span>incumbent settings
  object</span> specifies an <span>effective script origin</span> that is not the <span data-x="same
  origin">same</span> as <span data-x="concept-document-window">the <code>Window</code> object's
  <code>Document</code></span>'s <span>effective script origin</span>, with the following
  exceptions:</p>

  <ul>

   <li>The <code data-x="dom-location">location</code> attribute

   <li>The <code data-x="dom-window-postMessage">postMessage()</code> method

   <li>The <code data-x="dom-window">window</code> attribute

   <li>The <code data-x="dom-frames">frames</code> attribute

   <li>The <code data-x="dom-self">self</code> attribute

   <li>The <code data-x="dom-top">top</code> attribute

   <li>The <code data-x="dom-parent">parent</code> attribute

   <li>The <code data-x="dom-opener">opener</code> attribute

   <li>The <code data-x="dom-window-closed">closed</code> attribute

   <li>The <code data-x="dom-window-close">close()</code> method

   <li>The <code data-x="dom-window-blur">blur()</code> method

   <li>The <code data-x="dom-window-focus">focus()</code> method

   <li>The <span>dynamic nested browsing context properties</span>

  </ul>

  <p>When the <span>incumbent settings object</span> specifies an <span>effective script
  origin</span> that is different than a <span data-x="concept-document-window"><code>Window</code>
  object's <code>Document</code></span>'s <span>effective script origin</span>, the user agent must
  act as if any changes to that <code>Window</code> object's properties, getters, setters, etc, were
  not present, and as if all the properties of that <code>Window</code> object had their
  [[Enumerable]] attribute set to false.</p>

  <p>For members that return objects (including function objects), each distinct <span>effective
  script origin</span> that is not the same as the <code>Window</code> object's
  <code>Document</code>'s <span>effective script origin</span> must be provided with a separate set
  of objects. These objects must have the prototype chain appropriate for the script for which the
  objects are created (not those that would be appropriate for scripts whose <span>global
  object</span>, as specified by their <span>settings object</span>, is the <code>Window</code>
  object in question).</p>

  <div class="example">

   <p>For instance, if two frames containing <code>Document</code>s from different <span
   data-x="origin">origins</span> access the same <code>Window</code> object's <code
   data-x="dom-window-postMessage">postMessage()</code> method, they will get distinct objects that
   are not equal.</p>

  </div>

  </div>
<!--REMOVE-TOPIC:Security-->



  <h4 id="apis-for-creating-and-navigating-browsing-contexts-by-name">APIs for creating and navigating browsing contexts by name</h4>

  <dl class="domintro">

   <dt><var>window</var> = <var>window</var> . <code subdfn data-x="dom-open">open</code>( [ <var>url</var> [, <var>target</var> [, <var>features</var> [, <var>replace</var> ] ] ] ] )</dt>

   <dd>

    <p>Opens a window to show <var>url</var> (defaults to <code>about:blank</code>), and
    returns it. The <var>target</var> argument gives the name of the new window. If a
    window exists with that name already, it is reused. The <var>replace</var> attribute,
    if true, means that whatever page is currently open in that window will be removed from the
    window's session history. The <var data-x="dom-open-features">features</var> argument can be used to influence the rendering of the new window.</p>

   </dd>

   <dt><var>window</var> . <code subdfn data-x="dom-name">name</code> [ = <var>value</var> ]</dt>

   <dd>

    <p>Returns the name of the window.</p>

    <p>Can be set, to change the name.</p>

   </dd>

   <dt><var>window</var> . <code subdfn data-x="dom-window-close">close</code>()</dt>

   <dd>

    <p>Closes the window.</p>

   </dd>

   <dt><var>window</var> . <code subdfn data-x="dom-window-closed">closed</code></dt>

   <dd>

    <p>Returns true if the window has been closed, false otherwise.</p>

   </dd>

   <dt><var>window</var> . <code subdfn data-x="dom-window-stop">stop</code>()</dt>

   <dd>

    <p>Cancels the document load.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-open">open()</code></dfn> method on <code>Window</code> objects
  provides a mechanism for <span data-x="navigate">navigating</span> an existing <span>browsing
  context</span> or opening and navigating an <span>auxiliary browsing context</span>.</p>

  <p>When the method is invoked, the user agent must run the following steps:</p>

  <ol>

   <li><p>Let <var>entry settings</var> be the <span>entry settings object</span> when the method
   was invoked.</p></li>

   <li><p>Let <var>url</var> be the first argument.</p></li>

   <li><p>Let <var>target</var> be the second argument.</p></li>

   <li><p>Let <var data-x="dom-open-features">features</var> be the third argument.</p></li>

   <li><p>Let <var>replace</var> be the fourth argument.</p></li>

   <li><p>Let <var>source browsing context</var> be the <span>responsible browsing context</span>
   specified by <var>entry settings</var>.</p></li>

   <li><p>If <var>target</var> is the empty string, let it be the string "<code
  >_blank</code>" instead.</p></li>

   <li>

    <p>If the user has indicated a preference for which <span>browsing context</span> to navigate,
    follow these substeps:</p>

    <ol>

     <li><p>Let <var>target browsing context</var> be the <span>browsing context</span> indicated by
     the user.</p></li>

     <li><p>If <var>target browsing context</var> is a new <span>top-level browsing context</span>,
     let the <var>source browsing context</var> be set as <var>target browsing context</var>'s
     <span>one permitted sandboxed navigator</span>.</p></li>

    </ol>

    <p class="example">For example, suppose there is a user agent that supports control-clicking a
    link to open it in a new tab. If a user clicks in that user agent on an element whose <code
    data-x="handler-onclick">onclick</code> handler uses the <code
    data-x="dom-open">window.open()</code> API to open a page in an iframe, but, while doing so,
    holds the control key down, the user agent could override the selection of the target browsing
    context to instead target a new tab.</p>

    <p>Otherwise, apply <span>the rules for choosing a browsing context given a browsing context
    name</span> using <var>target</var> as the name and <var>source browsing context</var> as the
    context in which the algorithm is executed. If this results in there not being a chosen browsing
    context, then throw an <code>InvalidAccessError</code> exception and abort these steps.
    Otherwise, let <var>target browsing context</var> be the <span>browsing context</span> so
    obtained.</p>

   </li>

   <li><p>If <var>target browsing context</var> was just created, either as part of <span>the rules
   for choosing a browsing context given a browsing context name</span> or due to the user
   indicating a preference for navigating a new <span>top-level browsing context</span>, then let
   <var>new</var> be true. Otherwise, let it be false.</p></li>

   <li><p>Interpret <var>features</var> as defined in the CSSOM View specification. <a
   href="CSSOMVIEW">\[CSSOMVIEW]</a></p></li>

   <li>

    <p>If <var>url</var> is the empty string, run the appropriate steps from the following list:</p>

    <dl>

     <dt>If <var>new</var> is false</dt>

     <dd><p>Jump to the step labeled <i>end</i>.</p></dd>

     <dt>If <var>new</var> is true</dt>

     <dd><p>Let <var>resource</var> be the <span>URL</span> "<code>about:blank</code>".</p></dd>

    </dl>

    <p>Otherwise, <span data-x="resolve a url">resolve</span> <var>url</var> relative to the
    <span>API base URL</span> specified by <var>entry settings</var>, and let <var>resource</var> be
    the <span>resulting absolute URL</span>, if any. If the <span>resolve a URL</span> algorithm
    failed, then run one of the following two steps instead:</p>

    <ul>

     <li><p>Let <var>resource</var> be a resource representing an inline error page.</p></li>

     <li><p>If <var>new</var> is false, jump to the step labeled <i>end</i>, otherwise, let
     <var>resource</var> be the <span>URL</span> "<code>about:blank</code>".</p></li>

    </ul>

   </li>

   <li>

    <p>If <var>resource</var> is "<code>about:blank</code>" and <var>new</var> is true, <span>queue
    a task</span> to <span>fire a simple event</span> named <code data-x="event-load">load</code> at
    <var>target browsing context</var>'s <code>Window</code> object, with <i
    data-x="concept-event-target-override">target override</i> set to <var>target browsing
    context</var>'s <span data-x="concept-document-window"><code>Window</code> object's
    <code>Document</code></span> object.</p>

    <p>Otherwise, <span>navigate</span><!--DONAV window.open()--> <var>target browsing context</var>
    to <var>resource</var>, with <span>exceptions enabled</span>. If <var>new</var> is true, then
    <span data-x="replacement enabled">replacement must be enabled</span> also. The <span>source
    browsing context</span> is <var>source browsing context</var>.</p>

   </li>

   <li><p><i>End</i>: Return the <code>WindowProxy</code> object of <var>target browsing
   context</var>.</p></li>

  </ol>

  <hr>

  <p>The <dfn><code data-x="dom-name">name</code></dfn> attribute of the <code>Window</code> object
  must, on getting, return the current <span data-x="browsing context name">name</span> of the
  <span>browsing context</span>, if one is set, or the empty string otherwise; and, on setting, set
  the <span data-x="browsing context name">name</span> of the <span>browsing context</span> to the
  new value.</p>

  <p class="note">The name <a href="#resetBCName">gets reset</a> when the browsing context is
  navigated to another domain.</p>

  <hr>

  <p>The <dfn><code data-x="dom-window-close">close()</code></dfn> method on <code>Window</code>
  objects should, if all the following conditions are met, <span data-x="close a browsing
  context">close</span> the <span>browsing context</span> <var>A</var>:

  <ul class="brief">

   <li>The corresponding <span>browsing context</span> <var>A</var> is
   <span>script-closable</span>.</li>

   <li>The <span>responsible browsing context</span> specified by the <span>incumbent settings
   object</span> is <span>familiar with</span> the <span>browsing context</span> <var>A</var>.</li>

   <li id="sandboxClose">The <span>responsible browsing context</span> specified by the
   <span>incumbent settings object</span> is <span>allowed to navigate</span> the <span>browsing
   context</span> <var>A</var>.</li>

  </ul>

  <p>A <span>browsing context</span> is <dfn>script-closable</dfn> if it is an <span>auxiliary
  browsing context</span> that was created by a script (as opposed to by an action of the user), or
  if it is a <span>top-level browsing context</span> whose <span>session history</span> contains
  only one <code>Document</code>.</p>

  <p>The <dfn><code data-x="dom-window-closed">closed</code></dfn> attribute on <code>Window</code>
  objects must return true if the <code>Window</code> object's <span>browsing context</span> has
  been <span data-x="a browsing context is discarded">discarded</span>, and false otherwise.</p>

  <p>The <dfn><code data-x="dom-window-stop">stop()</code></dfn> method on <code>Window</code>
  objects should, if there is an existing attempt to <span>navigate</span> the <span>browsing
  context</span> and that attempt is not currently running the <span>unload a document</span>
  algorithm, cancel that <span data-x="navigate">navigation</span>; then, it must <span
  data-x="abort a document">abort</span> the <span>active document</span> of the <span>browsing
  context</span> of the <code>Window</code> object on which it was invoked.</p>

  </div>


  <h4 id="accessing-other-browsing-contexts">Accessing other browsing contexts</h4>

  <dl class="domintro">

   <dt><var>window</var> . <code subdfn data-x="dom-length">length</code></dt>

   <dd>

    <p>Returns the number of <span data-x="child browsing context">child browsing
    contexts</span>.</p>

   </dd>

   <dt><var>window</var>[<var>index</var>]</dt>

   <dd>

    <p>Returns the indicated <span>child browsing context</span>.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-length">length</code></dfn> IDL attribute on the <code>Window</code>
  interface must return the number of <span data-x="child browsing context">child browsing
  contexts</span> that are <span data-x="browsing context nested through">nested through</span>
  elements that are <span data-x="in a document">in the <code>Document</code></span> that is the
  <span>active document</span> of that <code>Window</code> object, if that <code>Window</code>'s
  <span>browsing context</span> shares the same <span>event loop</span> as the <span>responsible
  document</span> specified by the <span>entry settings object</span> accessing the IDL attribute;
  otherwise, it must return zero.</p>

  <!-- in other words, frames are only accessible to same-thread processes -->

  <p>The <span>supported property indices</span> on the <code>Window</code> object at any instant
  are the numbers in the range 0 .. <span><var>n</var>-1</span>, where <var>n</var> is the number returned by the <code data-x="dom-length">length</code> IDL
  attribute. If <var>n</var> is zero then there are no <span>supported property
  indices</span>.</p>

  <!-- sort order: http://software.hixie.ch/utilities/js/live-dom-viewer/?saved=2860 -->
  <p>To <dfn data-x="dom-window-item">determine the value of an indexed property</dfn> <var>index</var> of a <code>Window</code> object, the user agent must return the
  <code>WindowProxy</code> object of the <var>index</var>th <span>child browsing
  context</span> of the <code>Document</code> that is <span data-x="browsing context nested
  through">nested through</span> an element that is <span data-x="in a document">in the
  <code>Document</code></span>, sorted in the order that the elements nesting those <span
  data-x="browsing context">browsing contexts</span> were most recently inserted into the
  <code>Document</code>, the <code>WindowProxy</code> object of the most recently inserted
  <span>browsing context container</span>'s <span>nested browsing context</span> being last.</p>

  <p>These properties are the <dfn>dynamic nested browsing context properties</dfn>.</p>

  </div>



  <h4>Named access on the <code>Window</code> object</h4>

  <dl class="domintro">

   <dt><var>window</var>[<var>name</var>]</dt>

   <dd>

    <p>Returns the indicated element or collection of elements.</p>

    <p>As a general rule, relying on this will lead to brittle code. Which IDs end up mapping to
    this API can vary over time, as new features are added to the Web platform, for example. Instead
    of this, use <code>document.getElementById()</code> or <code
   >document.querySelector()</code>.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <code>Window</code> interface <span data-x="support named properties">supports named
  properties</span>. The <span>supported property names</span> at any moment consist of the
  following, in <span>tree order</span>, ignoring later duplicates:</p>

  <ul>

   <li>the <span>browsing context name</span> of any <span>child browsing context</span> of the
   <span>active document</span> whose name is not the empty string,</li>

   <li>the value of the <code>name</code> content attribute for all <code>a</code>,
   <code>applet</code>, <code>area</code>, <code>embed</code>, <code>form</code>,
   <code>frameset</code>, <code>img</code>, and <code>object</code> elements in the <span>active
   document</span> that have a non-empty <code>name</code> content attribute, and</li>

   <li>the value of the <code data-x="attr-id">id</code> content attribute of any <span data-x="HTML
   elements">HTML element</span> in the <span>active document</span> with a non-empty <code
   data-x="attr-id">id</code> content attribute.</li>

  </ul>

  <p>The properties exposed in this way must be <span>unenumerable</span>.</p>

  <p>To <span>determine the value of a named property</span> <var>name</var> when <dfn
  data-x="dom-window-namedItem">the <code>Window</code> object is indexed for property
  retrieval</dfn>, the user agent must return the value obtained using the following steps:</p>

  <ol>

   <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1716 -->

   <li>

    <p>Let <var>objects</var> be the list of <span
    data-x="dom-window-namedItem-filter">named objects</span> with the name <var>name</var>
    in the <span>active document</span>.

    <p class="note">There will be at least one such object, by definition.<!-- (If there wasn't,
    then this algorithm wouldn't have been invoked by Web IDL.) --></p>

   </li>

   <li>

    <p>If <var>objects</var> contains a <span>nested browsing context</span>, then return
    the <code>WindowProxy</code> object of the <span>nested browsing context</span> corresponding to
    the first <span>browsing context container</span> in <span>tree order</span> whose
    <span>browsing context</span> is in <var>objects</var>, and abort these steps.</p>

   </li>

   <li>

    <p>Otherwise, if <var>objects</var> has only one element, return that element and
    abort these steps.</p>

   </li>

   <li>

    <p>Otherwise return an <code>HTMLCollection</code> rooted at the <code>Document</code> node,
    whose filter matches only <span data-x="dom-window-namedItem-filter">named objects</span> with
    the name <var>name</var>. (By definition, these will all be elements.)</p> <!-- the
    same one each time is returned, because of the rule under collections -->

   </li>

  </ol>

  <p><dfn data-x="dom-window-nameditem-filter">Named objects</dfn> with the name <var>name</var>, for the purposes of the above algorithm, are those that are either:</p>

  <ul>

   <li><span data-x="child browsing context">child browsing contexts</span> of the <span>active
   document</span> whose name is <var>name</var>,</li>

   <li><code>a</code>, <code>applet</code>, <code>area</code>, <code>embed</code>,
   <code>form</code>, <code>frameset</code>, <code>img</code>, or <code>object</code> elements that
   have a <code>name</code> content attribute whose value is <var>name</var>, or</li>

   <li><span>HTML elements</span> that have an <code data-x="attr-id">id</code> content attribute
   whose value is <var>name</var>.</li>

  </ul>

  </div>


  <div class="impl">

  <h4 id="garbage-collection-and-browsing-contexts">Garbage collection and browsing contexts</h4>

  <p>A <span>browsing context</span> has a strong reference to each of its <code>Document</code>s
  and its <code>WindowProxy</code> object, and the user agent itself has a strong reference to its
  <span data-x="top-level browsing context">top-level browsing contexts</span>.</p>

  <p>A <code>Document</code> has a strong reference to its <code>Window</code> object.</p>

  <p class="note">A <code>Window</code> object <span data-x="implied strong reference">has a strong
  reference</span> to its <code>Document</code> object through its <code
  data-x="dom-document">document</code> attribute. Thus, references from other scripts to either of
  those objects will keep both alive. Similarly, both <code>Document</code> and <code>Window</code>
  objects have <span data-x="implied strong reference">implied strong references</span> to the
  <code>WindowProxy</code> object.</p>

  <p>Each <span data-x="concept-script">script</span> has a strong reference to its <span>settings
  object</span>, and each <span>environment settings object</span> has strong references to its
  <span>global object</span>, <span>responsible browsing context</span>, and <span>responsible
  document</span> (if any).</p>

  <!-- discard a document -->
  <p>When a <span>browsing context</span> is to <dfn>discard a <code>Document</code></dfn>, the user
  agent must run the following steps:</p>

  <ol>

   <li><p>Set the <code>Document</code>'s <i
   data-x="concept-document-salvageable">salvageable</i> state to false.</p></li>

   <li><p>Run any <span>unloading document cleanup steps</span> for the <code>Document</code> that
   are defined by this specification and <span>other applicable specifications</span>.</p></li>

   <li><p><span data-x="abort a document">Abort the <code>Document</code></span>.</p></li>

   <li><p>Remove any <span data-x="concept-task">tasks</span> associated with the
   <code>Document</code> in any <span>task source</span>, without running those tasks.</p></li>

   <li><p><span data-x="a browsing context is discarded">Discard</span> all the <span data-x="child
   browsing context">child browsing contexts</span> of the <code>Document</code>.</p></li>

   <li><p>Lose the strong reference from the <code>Document</code>'s <span>browsing context</span>
   to the <code>Document</code>.</p></li>

  </ol>

  <p class="note">Whenever a <code>Document</code> object is <span data-x="discard a
  Document">discarded</span>, it is also removed from the list of <span>the worker's
  <code>Document</code>s</span> of each worker whose list contains that <code>Document</code>.</p>

  <p>When <dfn>a <em>browsing context</em> is discarded</dfn>, the strong reference from the user
  agent itself to the <span>browsing context</span> must be severed, and all the
  <code>Document</code> objects for all the entries in the <span>browsing context</span>'s session
  history must be <span data-x="discard a document">discarded</span> as well.</p>

  <p>User agents may <span data-x="a browsing context is discarded">discard</span> <span
  data-x="top-level browsing context">top-level browsing contexts</span> at any time (typically, in
  response to user requests, e.g. when a user force-closes a window containing one or more <span
  data-x="top-level browsing context">top-level browsing contexts</span>). Other <span
  data-x="browsing context">browsing contexts</span> must be discarded once their
  <code>WindowProxy</code> object is eligible for garbage collection.</p>

  </div>


  <h4 id="closing-browsing-contexts">Closing browsing contexts</h4>

  <p>When the user agent is required to <dfn>close a browsing context</dfn>, it must run the
  following steps:</p>

  <ol>

   <li><p>Let <var>specified browsing context</var> be the <span>browsing context</span>
   being closed.</p></li>

   <li><p><span data-x="prompt to unload a document">Prompt to unload</span> the <span>active
   document</span> of the <var>specified browsing context</var>. If the user <span>refused
   to allow the document to be unloaded</span>, then abort these steps.</p></li>

   <li><p><span data-x="unload a document">Unload</span> the <span>active document</span> of the <var>specified browsing context</var> with the <var>recycle</var> parameter set to
   false.</p></li>

   <li><p>Remove the <var>specified browsing context</var> from the user interface (e.g.
   close or hide its tab in a tabbed browser).</p></li>

   <li><p><span data-x="a browsing context is discarded">Discard</span> the <var>specified
   browsing context</var>.</p></li>

  </ol>

  <p>User agents should offer users the ability to arbitrarily <span data-x="close a browsing
  context">close</span> any <span>top-level browsing context</span>.</p>



  <h4 id="browser-interface-elements">Browser interface elements</h4>

  <p>To allow Web pages to integrate with Web browsers, certain Web browser interface elements are
  exposed in a limited way to scripts in Web pages.</p>

  <p>Each interface element is represented by a <code>BarProp</code> object:</p>

  <pre class="idl">interface <dfn>BarProp</dfn> {
  readonly attribute boolean <span data-x="dom-BarProp-visible">visible</span>;
};</pre>

  <dl class="domintro">

   <dt><var>window</var> . <code subdfn data-x="dom-window-locationbar">locationbar</code> . <code subdfn data-x="dom-BarProp-visible">visible</code></dt>
   <dd>
    <p>Returns true if the location bar is visible; otherwise, returns false.</p>
   </dd>

   <dt><var>window</var> . <code subdfn data-x="dom-window-menubar">menubar</code> . <code data-x="dom-BarProp-visible">visible</code></dt>
   <dd>
    <p>Returns true if the menu bar is visible; otherwise, returns false.</p>
   </dd>

   <dt><var>window</var> . <code subdfn data-x="dom-window-personalbar">personalbar</code> . <code data-x="dom-BarProp-visible">visible</code></dt>
   <!--<dt><var>window</var> . <code subdfn data-x="dom-window-directories">directories</code> . <code data-x="dom-BarProp-visible">visible</code></dt>-->
   <dd>
    <p>Returns true if the personal bar is visible; otherwise, returns false.</p>
   </dd>

   <dt><var>window</var> . <code subdfn data-x="dom-window-scrollbars">scrollbars</code> . <code data-x="dom-BarProp-visible">visible</code></dt>
   <dd>
    <p>Returns true if the scroll bars are visible; otherwise, returns false.</p>
   </dd>

   <dt><var>window</var> . <code subdfn data-x="dom-window-statusbar">statusbar</code> . <code data-x="dom-BarProp-visible">visible</code></dt>
   <dd>
    <p>Returns true if the status bar is visible; otherwise, returns false.</p>
   </dd>

   <dt><var>window</var> . <code subdfn data-x="dom-window-toolbar">toolbar</code> . <code data-x="dom-BarProp-visible">visible</code></dt>
   <dd>
    <p>Returns true if the toolbar is visible; otherwise, returns false.</p>
   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn data-x="dom-BarProp-visible">visible</dfn> attribute, on getting, must return either
  true or a value determined by the user agent to most accurately represent the visibility state of
  the user interface element that the object represents, as described below.</p>

  <p>The following <code>BarProp</code> objects exist for each <code>Document</code> object in a
  <span>browsing context</span>. Some of the user interface elements represented by these objects
  might have no equivalent in some user agents; for those user agents, except when otherwise
  specified, the object must act as if it was present and visible (i.e. its <code
  data-x="dom-BarProp-visible">visible</code> attribute must return true).</p>

  <dl>

   <dt><dfn>The location bar <code>BarProp</code> object</dfn></dt>

   <dd>Represents the user interface element that contains a control that displays the
   <span>URL</span> of the <span>active document</span>, or some similar interface concept.</dd>

   <dt><dfn>The menu bar <code>BarProp</code> object</dfn></dt>

   <dd>Represents the user interface element that contains a list of commands in menu form, or some
   similar interface concept.</dd>

   <dt><dfn>The personal bar <code>BarProp</code> object</dfn></dt>

   <dd>Represents the user interface element that contains links to the user's favorite pages, or
   some similar interface concept.</dd>

   <dt><dfn>The scrollbar <code>BarProp</code> object</dfn></dt>

   <dd>Represents the user interface element that contains a scrolling mechanism, or some similar
   interface concept.</dd>

   <dt><dfn>The status bar <code>BarProp</code> object</dfn></dt>

   <dd>Represents a user interface element found immediately below or after the document, as
   appropriate for the user's media, which typically provides information about ongoing network
   activity or information about elements that the user's pointing device is current indicating. If
   the user agent has no such user interface element, then the object may act as if the
   corresponding user interface element was absent (i.e. its <code
   data-x="dom-BarProp-visible">visible</code> attribute may return false).</dd>

   <dt><dfn>The toolbar <code>BarProp</code> object</dfn></dt>

   <dd>Represents the user interface element found immediately above or before the document, as
   appropriate for the user's media, which typically provides <span>session history</span> traversal
   controls (back and forward buttons, reload buttons, etc). If the user agent has no such user
   interface element, then the object may act as if the corresponding user interface element was
   absent (i.e. its <code data-x="dom-BarProp-visible">visible</code> attribute may return
   false).</dd>

  </dl>

  <p>The <dfn><code data-x="dom-window-locationbar">locationbar</code></dfn> attribute must return
  <span>the location bar <code>BarProp</code> object</span>.</p>

  <p>The <dfn><code data-x="dom-window-menubar">menubar</code></dfn> attribute must return <span>the
  menu bar <code>BarProp</code> object</span>.</p>

  <p>The <dfn><code data-x="dom-window-personalbar">personalbar</code></dfn> attribute must return
  <span>the personal bar <code>BarProp</code> object</span>.</p>

  <p>The <dfn><code data-x="dom-window-scrollbars">scrollbars</code></dfn> attribute must return
  <span>the scrollbar <code>BarProp</code> object</span>.</p>

  <p>The <dfn><code data-x="dom-window-statusbar">statusbar</code></dfn> attribute must return
  <span>the status bar <code>BarProp</code> object</span>.</p>

  <p>The <dfn><code data-x="dom-window-toolbar">toolbar</code></dfn> attribute must return <span>the
  toolbar <code>BarProp</code> object</span>.</p>

<!--
  <p>For legacy reasons, the <dfn><code data-x="dom-window-directories">directories</code></dfn>
  attribute must also return <span>the personal bar <code>BarProp</code> object</span>.</p>
-->

  <hr>

  <p>For historical reasons, the <dfn><code data-x="dom-window-status">status</code></dfn> attribute
  on the <code>Window</code> object must, on getting, return the last string it was set to, and on
  setting, must set itself to the new value. When the <code>Window</code> object is created, the
  attribute must be set to the empty string. It does not do anything else.</p>

  </div>


  <div class="impl">

  <h4>The <code>WindowProxy</code> object</h4>

<!--END complete--><!--END dev-html--><!--END w3c-html-->
<!-- this is for the purposes of the IDL validator -->
<pre class="idl">[NoInterfaceObject]
interface <span>WindowProxy</span> : <span>Window</span> {};
</pre>
<!--START complete--><!--START dev-html--><!--START w3c-html-->

  <p>As mentioned earlier, each <span>browsing context</span> has a
  <dfn><code>WindowProxy</code></dfn> object. This object is unusual in that all operations that
  would be performed on it must be performed on the <code>Window</code> object of the <span>browsing
  context</span>'s <span>active document</span> instead. It is thus indistinguishable from that
  <code>Window</code> object in every way until the <span>browsing context</span> is navigated.</p>

  <p>There is no <code>WindowProxy</code> interface object.</p>

  <p class="note">The <code>WindowProxy</code> object allows scripts to act as if each
  <span>browsing context</span> had a single <code>Window</code> object, while still keeping
  separate <code>Window</code> objects for each <code>Document</code>.</p>

  <div class="example">

   <p>In the following example, the variable <var>x</var> is set to the
   <code>WindowProxy</code> object returned by the <code data-x="dom-window">window</code> accessor
   on the global object. All of the expressions following the assignment return true, because in
   every respect, the <code>WindowProxy</code> object acts like the underlying <code>Window</code>
   object.</p>

   <pre>var x = window;
x instanceof Window; // true
x === this; // true</pre>

  </div>

  </div>
<!--TOPIC:HTML-->



<!--TOPIC:Security-->
  <h3 id="origin">Origin</h3>
  <!-- Hallowed are the Ori -->

  <p>Origins are the fundamental currency of the Web's security model. Two actors in the Web
  platform that share an origin are assumed to trust each other and to have the same authority.
  Actors with differing origins are considered potentially hostile versus each other, and are
  isolated from each other to varying degrees.</p>

  <p class="example">For example, if Example Bank's Web site, hosted at <code
 >bank.example.com</code>, tries to examine the DOM of Example Charity's Web site, hosted
  at <code>charity.example.org</code>, a <code>SecurityError</code> exception will be
  raised.</p>

  <hr>

  <p>The <dfn data-dfn-for="origin">origin</dfn> of a resource and the
  <dfn data-dfn-for="origin">effective script origin</dfn> of a resource are each one of the
  following:</p>

  <dl>


   <dt>Opaque identifiers

   <dd>

    <p>Internal values, with no serialization, for which the only meaningful operation is testing
    for equality.</p>


   <dt>Tuples

   <dd>

    <p>Tuples consisting of a scheme component, a host component, a port component, and optionally
    extra data.</p>

    <p class="note">The extra data could include the certificate of the site when using encrypted
    connections, to ensure that if the site's secure certificate changes, the origin is considered to
    change as well.</p>


   <dt>Aliases

   <dd>

    <p>A reference to another <span>origin</span> or <span>effective script origin</span>.</p>


  </dl>

  <div class="impl">

  <p>An <span>origin</span> or <span>effective script origin</span> can be defined as an <dfn
  data-x="concept-origin-alias">alias</dfn> to another <span>origin</span> or <span>effective script
  origin</span>. The value of the <span>origin</span> or <span>effective script origin</span> is
  then the value of the <span>origin</span> or <span>effective script origin</span> to which it is
  an alias.</p>

  <p>These characteristics are defined as follows:</p>

  <dl>

   <dt>For URLs</dt>

   <dd>

    <p>The <span>origin</span> and <span>effective script origin</span> of the <span>URL</span> are
    the origin defined in <cite>The Web Origin Concept</cite>. <a
    href="#refsORIGIN">\[ORIGIN]</a></p>

   </dd>


   <dt>For <code>Document</code> objects</dt>

   <dd>

    <dl class="switch">

     <dt id="sandboxOrigin">If a <code>Document</code>'s <span>active sandboxing flag set</span> has
     its <span>sandboxed origin browsing context flag</span> set</dt>

     <dd>

      <p>The <span>origin</span> is a globally unique identifier assigned when the
      <code>Document</code> is created.</p>

      <p>The <span>effective script origin</span> is initially an <span
      data-x="concept-origin-alias">alias</span> to the <span>origin</span> of the
      <code>Document</code>.</p>

     </dd>


     <dt>If a <code>Document</code> was served over the network and has an address that uses a URL
     scheme with a server-based naming authority</dt>

     <dd>

      <p>The <span>origin</span> is an <span data-x="concept-origin-alias">alias</span> to the
      <span>origin</span> of <span>the <code>Document</code>'s address</span>.</p>

      <p>The <span>effective script origin</span> is initially an <span
      data-x="concept-origin-alias">alias</span> to the <span>origin</span> of the
      <code>Document</code>.</p>

     </dd>


     <dt>If a <code>Document</code> was generated from a <span data-x="data
     protocol"><code>data:</code> URL</span> found in another <code>Document</code> or in a
     script</dt>

     <dd>

      <p>The <span>origin</span> is an <span data-x="concept-origin-alias">alias</span> to the
      <span>origin</span> specified by the <span>incumbent settings object</span> when the <span>navigate</span>
      algorithm was invoked, or, if no <span data-x="concept-script">script</span> was involved, of
      the <span>node document</span> of the element that initiated the <span
      data-x="navigate">navigation</span> to that <span>URL</span>.</p>

      <p>The <span>effective script origin</span> is initially an <span
      data-x="concept-origin-alias">alias</span> to the <span>effective script origin</span> of that
      same <span>environment settings object</span> or <code>Document</code>.</p>

     </dd>


     <dt>If a <code>Document</code> is the initial "<code>about:blank</code>" document</dt>

     <dd>

      <p>The <span>origin</span> and <span>effective script origin</span> of the
      <code>Document</code> are <a href="#about-blank-origin">those it was assigned when its
      browsing context was created</a>.</p>

     </dd>


     <dt>If a <code>Document</code> was created as part of the processing for <span
     data-x="javascript protocol"><code>javascript:</code> URLs</span></dt>

     <dd>

      <p>The <span>origin</span> is an <span data-x="concept-origin-alias">alias</span> to the
      <span>origin</span> of the <span>active document</span> of the <span>browsing context</span>
      being navigated when the <span>navigate</span> algorithm was invoked.</p>

      <p>The <span>effective script origin</span> is initially an <span
      data-x="concept-origin-alias">alias</span> to the <span>effective script origin</span> of that
      same <code>Document</code>.</p>

     </dd>


     <dt>If a <code>Document</code> is <span>an <code>iframe</code> <code
     data-x="attr-iframe-srcdoc">srcdoc</code> document</span></dt>

     <dd>

      <p>The <span>origin</span> of the <code>Document</code> is an <span
      data-x="concept-origin-alias">alias</span> to the <span>origin</span> of the
      <code>Document</code>'s <span>browsing context</span>'s <span>browsing context
      container</span>'s <span>node document</span>.</p>

      <p>The <span>effective script origin</span> is initially an <span
      data-x="concept-origin-alias">alias</span> to the <span>effective script origin</span> of the
      <code>Document</code>'s <span>browsing context</span>'s <span>browsing context
      container</span>'s <span>node document</span>.</p>

     </dd>


     <dt>If a <code>Document</code> was obtained in some other manner (e.g. a <span data-x="data
     protocol"><code>data:</code> URL</span> typed in by the user or that was returned as the
     location of a redirect, a <code>Document</code> created using the <code
     data-x="dom-DOMImplementation-createDocument">createDocument()</code> API, etc)</dt>

     <dd>

      <p>The default behavior as defined in the DOM standard applies. <a
      href="#refsDOM">\[DOM]</a>.</p>

      <p class="note">The <span>origin</span> is a globally unique identifier assigned when the
      <code>Document</code> is created, and the <span>effective script origin</span> is initially an
      <span data-x="concept-origin-alias">alias</span> to the <span>origin</span> of the
      <code>Document</code>.</p>

     </dd>

    </dl>

    <p class="note">The <span>effective script origin</span> of a <code>Document</code> can be
    manipulated using the <code data-x="dom-document-domain">document.domain</code> IDL
    attribute.</p>

   </dd>


   <dt>For images of <code>img</code> elements</dt>

   <dd>

    <dl class="switch">

     <dt>If the image data is <span>CORS-cross-origin</span></dt>

     <dd>The <span>origin</span> is a globally unique identifier assigned when the image is
     created.</dd>


     <dt>If the image data is <span>CORS-same-origin</span></dt>

     <dd>The <span>origin</span> is an <span data-x="concept-origin-alias">alias</span> to the
     <span>origin</span> of the <code>img</code> element's <span>node document</span>.</dd>

     <!-- all image loads go through the "potentially CORS-enabled fetch" algorithm so they're all
     either CORS-cross-origin or CORS-same-origin if they succeed at all -->

    </dl>

    <p>Images do not have an <span>effective script origin</span>.</p>

   </dd>


   <dt>For <code>audio</code> and <code>video</code> elements</dt>

   <dd>

    <dl class="switch">

     <dt>If the <span>media data</span> is <span>CORS-cross-origin</span></dt>

     <dd>The <span>origin</span> is a globally unique identifier assigned when the <span>media
     data</span> is fetched.</dd>


     <dt>If the <span>media data</span> is <span>CORS-same-origin</span></dt>

     <dd>The <span>origin</span> is an <span data-x="concept-origin-alias">alias</span> to the
     <span>origin</span> of the <span>media element</span>'s <span>node document</span>.</dd>

    </dl>

    <p><span data-x="media element">Media elements</span> do not have an <span>effective script
    origin</span>.</p>

   </dd>


   <dt>For fonts</dt>

   <dd>

    <p>The <span>origin</span> of a downloadable Web font is an <span
    data-x="concept-origin-alias">alias</span> to the <span>origin</span> of the <span>absolute
    URL</span> used to obtain the font (after any redirects). <a href="#refsCSSFONTS">\[CSSFONTS]</a>
    <a href="#refsCSSFONTLOAD">\[CSSFONTLOAD]</a></p> <!-- this means you can get data from a remote
    site if you can make it redirect to your own site in some fashion controlled by the data you
    want to read -->

    <p>The <span>origin</span> of a locally installed system font is an <span
    data-x="concept-origin-alias">alias</span> to the <span>origin</span> of the
    <code>Document</code> in which that font is being used.</p>

    <p>Fonts do not have an <span>effective script origin</span>.</p>

   </dd>

  </dl>

  <p>Other specifications can override the above definitions by themselves specifying the origin of
  a particular <span>URL</span>, <code>Document</code>, image, <span>media element</span>, or
  font.</p>

  <!-- e.g.:

    <p>The <span>origin</span> of a <code>Document</code> object returned by the
    <code>XMLHttpRequest</code> API is an <span data-x="concept-origin-alias">alias</span> to the
    <span>XMLHttpRequest origin</span> of the <code>XMLHttpRequest</code> object.</p>

  -->

  <hr>

  <p>The <dfn>Unicode serialization of an origin</dfn> is the string obtained by applying the
  following algorithm to the given <span>origin</span>:</p>

  <ol>

   <li><p>If the <span>origin</span> in question is not a scheme/host/port tuple, then return the
   literal string "<code>null</code>" and abort these steps.</p></li>

   <li><p>Otherwise, let <var>result</var> be the scheme part of the <span>origin</span>
   tuple.</p></li>

   <li><p>Append the string "<code>://</code>" to <var>result</var>.</p></li>

   <li><p>Apply the <span>domain to Unicode</span> algorithm to each component of the host
   part of the <span>origin</span> tuple, and append the results &mdash; each component, in the same
   order, separated by U+002E FULL STOP characters (.) &mdash; to <var>result</var>. <a href="#refsURL">\[URL]</a></p></li>

   <li><p>If the port part of the <span>origin</span> tuple gives a port that is different from the
   default port for the protocol given by the scheme part of the <span>origin</span> tuple, then
   append a U+003A COLON character (:) and the given port, in base ten, to <var>result</var>.</p></li>

   <li><p>Return <var>result</var>.</p></li>

  </ol>


  <p>The <dfn>ASCII serialization of an origin</dfn> is the string obtained by applying the
  following algorithm to the given <span>origin</span>:</p>

  <ol>

   <li><p>If the <span>origin</span> in question is not a scheme/host/port tuple, then return the
   literal string "<code>null</code>" and abort these steps.</p></li>

   <li><p>Otherwise, let <var>result</var> be the scheme part of the <span>origin</span>
   tuple.</p></li>

   <li><p>Append the string "<code>://</code>" to <var>result</var>.</p></li>

   <li>

    <p>Apply the <span>domain to ASCII</span> algorithm to each component of the host part of
    the <span>origin</span> tuple, and append the results &mdash; each component, in the same order,
    separated by U+002E FULL STOP characters (.) &mdash; to <var>result</var>. <a href="#refsURL">\[URL]</a></p>

    <p>If the <span>domain to ASCII</span> algorithm returns failure, e.g. because a component is too long or because it contains
    invalid characters, then throw a <code>SecurityError</code> exception and abort these steps.</p>

   </li>

   <li><p>If the port part of the <span>origin</span> tuple gives a port that is different from the
   default port for the protocol given by the scheme part of the <span>origin</span> tuple, then
   append a U+003A COLON character (:) and the given port, in base ten, to <var>result</var>.</p></li>

   <li><p>Return <var>result</var>.</p></li>

  </ol>


  <p>Two <span data-x="origin">origins</span> are said to be the <dfn>same origin</dfn> if the
  following algorithm returns true:</p>

  <ol>

   <li><p>Let <var>A</var> be the first <span>origin</span> being compared, and <var>B</var> be the second <span>origin</span> being compared.</p></li>

   <li><p>If <var>A</var> and <var>B</var> are both opaque identifiers, and their
   value is equal, then return true.</p></li>

   <li><p>Otherwise, if either <var>A</var> or <var>B</var> or both are opaque
   identifiers, return false.</p></li>

   <li><p>If <var>A</var> and <var>B</var> have scheme components that are not
   identical, return false.</p></li>

   <li><p>If <var>A</var> and <var>B</var> have host components that are not
   identical, return false.</p></li>

   <li><p>If <var>A</var> and <var>B</var> have port components that are not
   identical, return false.</p></li>

   <li><p>If either <var>A</var> or <var>B</var> have additional data, but that
   data is not identical for both, return false.</p></li>

   <li><p>Return true.</p></li>

  </ol>

  </div>


  <h4 id="relaxing-the-same-origin-restriction">Relaxing the same-origin restriction</h4>

  <dl class="domintro">

   <dt><var>document</var> . <code subdfn data-x="dom-document-domain">domain</code> [ = <var>domain</var> ]</dt>

   <dd>

    <p>Returns the current domain used for security checks.</p>

    <p>Can be set to a value that removes subdomains, to change the <span>effective script
    origin</span> to allow pages on other subdomains of the same domain (if they do the same thing)
    to access each other. (Can't be set in sandboxed <code>iframe</code>s.)</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-document-domain">domain</code></dfn> attribute on
  <code>Document</code> objects must be initialized to <span>the document's domain</span>, if it has
  one, and the empty string otherwise. If <span>the document's domain</span> starts with a U+005B
  LEFT SQUARE BRACKET character ([) and ends with a U+005D RIGHT SQUARE BRACKET character (]), it is
  an IPv6 address; these square brackets must be omitted when initializing the attribute's
  value.</p>

  <p>On getting, the attribute must return its current value, unless the <code>Document</code> has
  no <span>browsing context</span>, in which case it must return the empty string.</p>

  <p>On setting, the user agent must run the following algorithm:</p>

  <ol>

   <li>

    <p>If the <code>Document</code> has no <span>browsing context</span>, throw a
    <code>SecurityError</code> exception and abort these steps.</p>

   </li>

   <li>

    <p>If the <code>Document</code>'s <span>active sandboxing flag set</span> has its
    <span>sandboxed <code data-x="dom-document-domain">document.domain</code> browsing context
    flag</span> set, throw a <code>SecurityError</code> exception and abort these steps.</p>

   </li>

   <li>

    <p>If the new value is an IPv4 or IPv6 address, let <var>new value</var> be the new
    value.</p>

    <p>Otherwise, <span data-x="strictly split a string">strictly split</span> the new value on
    U+002E FULL STOP characters (.), apply the <span>domain to ASCII</span> algorithm to each
    returned token, and let <var>new value</var> be the result of concatenating the
    results of applying that algorithm to each token, in the same order, separated by U+002E FULL
    STOP characters (.). <a href="#refsURL">\[URL]</a></p>

    <p>If the <span>domain to ASCII</span> algorithm returns failure, e.g. because a component is too long or because it contains
    invalid characters, then throw a <code>SecurityError</code> exception and abort these steps.</p>

   </li>

   <li>

    <p>If <var>new value</var> is not exactly equal to the current value of the <code
    data-x="dom-document-domain">document.domain</code> attribute, then run these substeps:</p>

    <ol>

     <li>

      <p>If the current value is an IPv4 or IPv6 address, throw a <code>SecurityError</code>
      exception and abort these steps.</p>

     </li>

     <li>

      <p>If <var>new value</var>, prefixed by a U+002E FULL STOP (.), does not exactly
      match the end of the current value, throw a <code>SecurityError</code> exception and abort
      these steps.</p>

      <p class="note">If the <var>new value</var> is an IPv4 or IPv6 address, it cannot
      match the <var>new value</var> in this way and thus an exception will be thrown
      here.</p>

      <!-- this is the step that prevents us from ever setting document.domain if the >effective
      script origin< isn't a scheme/host/port tuple -->

     </li>

     <li>

      <p>If <var>new value</var> matches a suffix in the Public Suffix List, or, if <var>new value</var>, prefixed by a U+002E FULL STOP (.), matches the end of a suffix in
      the Public Suffix List, then throw a <code>SecurityError</code> exception and abort these
      steps. <a href="#refsPSL">\[PSL]</a></p>

      <p>Suffixes must be compared in an <span>ASCII case-insensitive</span> manner, after applying
      the <span>domain to ASCII</span> algorithm to their individual components, . <a href="#refsURL">\[URL]</a></p>

     </li>

    </ol>

   </li>

   <li><p>Release the <span>storage mutex</span>.</p></li>

   <li>

    <p>Set the attribute's value to <var>new value</var>.</p>

   </li>

   <li>

    <p>If the <span>effective script origin</span> of the <code>Document</code> is an <span
    data-x="concept-origin-alias">alias</span>, set it to the value of the <span>effective script
    origin</span> (essentially de-aliasing the <span>effective script origin</span>).</p>

   </li>

   <li>

    <p>If <var>new value</var> is not the empty string, then run these substeps:</p>

    <ol>

     <li>

      <p>Set the host part of the <span>effective script origin</span> tuple of the
      <code>Document</code> to <var>new value</var>.</p>

     </li>

     <li>

      <p>Set the port part of the <span>effective script origin</span> tuple of the
      <code>Document</code> to "manual override" (a value that, for the purposes of <span
      data-x="same origin">comparing origins</span>, is identical to "manual override" but not
      identical to any other value).</p>

     </li>

    </ol>

   </li>

  </ol>

  <p>The <dfn data-x="the document's domain">domain</dfn> of a <code>Document</code> is the host part
  of the document's <span>origin</span>, if the value of that <span>origin</span> is a
  scheme/host/port tuple. If it isn't, then the document does not have a domain.</p>

  </div>

  <p class="note">The <code data-x="dom-document-domain">domain</code> attribute is used to enable
  pages on different hosts of a domain to access each others' DOMs.</p>

  <p class="warning">Do not use the <code data-x="dom-document-domain">document.domain</code>
  attribute when using shared hosting. If an untrusted third party is able to host an HTTP server at
  the same IP address but on a different port, then the same-origin protection that normally
  protects two different sites on the same host will fail, as the ports are ignored when comparing
  origins after the <code data-x="dom-document-domain">document.domain</code> attribute has been
  used.</p>



<!--TOPIC:HTML-->

  <h3 id="sandboxing">Sandboxing</h3>

  <p>A <dfn>sandboxing flag set</dfn> is a set of zero or more of the following flags, which are
  used to restrict the abilities that potentially untrusted resources have:</p>

  <dl>

   <dt>The <dfn>sandboxed navigation browsing context flag</dfn></dt>

   <dd>

    <p>This flag <a href="#sandboxLinks">prevents content from navigating browsing contexts other
    than the sandboxed browsing context itself</a> (or browsing contexts further nested inside it),
    <span data-x="auxiliary browsing context">auxiliary browsing contexts</span> (which are protected
    by the <span>sandboxed auxiliary navigation browsing context flag</span> defined next), and the
    <span>top-level browsing context</span> (which is protected by the <span>sandboxed top-level
    navigation browsing context flag</span> defined below).</p>

    <p>If the <span>sandboxed auxiliary navigation browsing context flag</span> is not set, then in
    certain cases the restrictions nonetheless allow popups (new <span data-x="top-level browsing
    context">top-level browsing contexts</span>) to be opened. These <span data-x="browsing
    context">browsing contexts</span> always have <dfn>one permitted sandboxed navigator</dfn>, set
    when the browsing context is created, which allows the <span>browsing context</span> that
    created them to actually navigate them. (Otherwise, the <span>sandboxed navigation browsing
    context flag</span> would prevent them from being navigated even if they were opened.)</p>

   </dd>


   <dt>The <dfn>sandboxed auxiliary navigation browsing context flag</dfn></dt>

   <dd>

    <p>This flag <a href="#sandboxWindowOpen">prevents content from creating new auxiliary browsing
    contexts</a>, e.g. using the <code data-x="attr-hyperlink-target">target</code> attribute, the
    <code data-x="dom-open">window.open()</code> method, or the <code
    data-x="dom-showModalDialog">showModalDialog()</code> method.</p>

   </dd>


   <dt>The <dfn>sandboxed top-level navigation browsing context flag</dfn></dt>

   <dd>

    <p>This flag <a href="#sandboxLinks">prevents content from navigating their <span>top-level
    browsing context</span></a> and <a href="#sandboxClose">prevents content from closing their
    <span>top-level browsing context</span></a>.</p>

    <p>When the <span>sandboxed top-level navigation browsing context flag</span> is <em>not</em>
    set, content can navigate its <span>top-level browsing context</span>, but other <span
    data-x="browsing context">browsing contexts</span> are still protected by the <span>sandboxed
    navigation browsing context flag</span> and possibly the <span>sandboxed auxiliary navigation
    browsing context flag</span>.</p>

   </dd>


   <dt>The <dfn>sandboxed plugins browsing context flag</dfn></dt>

   <dd>

    <p>This flag prevents content from instantiating <span data-x="plugin">plugins</span>, whether
    using <a href="#sandboxPluginEmbed">the <code>embed</code> element</a>, <a
    href="#sandboxPluginObject">the <code>object</code> element</a>, <a
    href="#sandboxPluginApplet">the <code>applet</code> element</a>, or through <a
    href="#sandboxPluginNavigate">navigation</a> of a <span>nested browsing context</span>, unless
    those <span data-x="plugin">plugins</span> can be <span
    data-x="concept-plugin-secure">secured</span>.</p>

   </dd>


   <dt>The <dfn>sandboxed seamless iframes flag</dfn></dt>

   <dd>

    <p>This flag prevents content from using the <code data-x="attr-iframe-seamless">seamless</code>
    attribute on descendant <code>iframe</code> elements.</p>

    <p class="note">This prevents a page inserted using the <code
    data-x="attr-iframe-sandbox-allow-same-origin">allow-same-origin</code> keyword from using a
    CSS-selector-based method of probing the DOM of other pages on the same site (in particular,
    pages that contain user-sensitive information).</p>

    <!-- http://lists.w3.org/Archives/Public/public-web-security/2009Dec/thread.html#msg51 -->

   </dd>


   <dt>The <dfn>sandboxed origin browsing context flag</dfn></dt>

   <dd>

    <p>This flag <a href="#sandboxOrigin">forces content into a unique origin</a>, thus preventing
    it from accessing other content from the same <span>origin</span>.</p>

    <p>This flag also <a href="#sandboxCookies">prevents script from reading from or writing to the
    <code data-x="dom-document-cookie">document.cookie</code> IDL attribute</a>, and blocks access to
    <code data-x="dom-localStorage">localStorage</code>.
    <!--END complete-->
    <a href="#refsWEBSTORAGE">\[WEBSTORAGE]</a>
    <!--START complete-->
    </p>

   </dd>


   <dt>The <dfn>sandboxed forms browsing context flag</dfn></dt>

   <dd>

    <p>This flag <a href="#sandboxSubmitBlocked">blocks form submission</a>.</p>

   </dd>


   <dt>The <dfn>sandboxed pointer lock browsing context flag</dfn></dt>

   <dd>

    <p>This flag disables the Pointer Lock API. <a href="#refsPOINTERLOCK">\[POINTERLOCK]</a></p>

   </dd>


   <dt>The <dfn>sandboxed scripts browsing context flag</dfn></dt>

   <dd>

    <p>This flag <a href="#sandboxScriptBlocked">blocks script execution</a>.</p>

   </dd>


   <dt>The <dfn>sandboxed automatic features browsing context flag</dfn></dt>

   <dd>

    <p>This flag blocks features that trigger automatically, such as <span
    data-x="attr-media-autoplay">automatically playing a video</span> or <span
    data-x="attr-fe-autofocus">automatically focusing a form control</span>.</p>

   </dd>


   <dt>The <dfn>sandboxed storage area URLs flag</dfn></dt>

   <dd>

    <p>This flag prevents URL schemes that use storage areas from being able to access the origin's
    data.</p>

   </dd>


   <dt>The <dfn>sandboxed fullscreen browsing context flag</dfn></dt>

   <dd>

    <p>This flag prevents content from using the <code
    data-x="dom-element-requestFullscreen">requestFullscreen()</code> method.</p>

   </dd>


   <dt>The <dfn>sandboxed <code data-x="dom-document-domain">document.domain</code> browsing context flag</dfn></dt>

   <dd>

    <p>This flag prevents content from using the <code
    data-x="dom-document-domain">document.domain</code> feature to change the <span>effective script
    origin</span>.</p>

   </dd>


   <dt>The <dfn>sandbox propagates to auxiliary browsing contexts flag</dfn></dt>

   <dd>

    <p>This flag prevents content from escaping the sandbox by ensuring that any
    <span>auxiliary browsing context</span> it creates inherits the content's
    <span>active sandboxing flag set</span>.</p>

   </dd>

   <dt>The <dfn>sandboxed modals flag</dfn></dt>

   <dd>

    <p>This flag prevents content from using any of the following features to produce modal
    dialogs:</p>

    <ul>
     <li><code data-x="dom-alert">window.alert()</code></li>
     <li><code data-x="dom-confirm">window.confirm()</code></li>
     <li><code data-x="dom-print">window.print()</code></li>
     <li><code data-x="dom-prompt">window.prompt()</code></li>
     <li><code data-x="dom-showmodaldialog">window.showModalDialog()</code></li>
     <li>the <code data-x="event-beforeunload">beforeunload</code> event</li>
    </ul>

   </dd>


  </dl>

  <p>When the user agent is to <dfn>parse a sandboxing directive</dfn>, given a string <var>input</var>, a <span>sandboxing flag set</span> <var>output</var>, and
  optionally an <var>allow fullscreen flag</var>, it must run the following steps:</p>

  <ol>

   <li><p><span data-x="split a string on spaces">Split <var>input</var> on spaces</span>,
   to obtain <var>tokens</var>.</p></li>

   <li><p>Let <var>output</var> be empty.</p></li>

   <li>

    <p>Add the following flags to <var>output</var>:</p>

    <ul>

     <li><p>The <span>sandboxed navigation browsing context flag</span>.</p></li>

     <li><p>The <span>sandboxed auxiliary navigation browsing context flag</span>, unless <var>tokens</var> contains the <dfn><code data-x="attr-iframe-sandbox-allow-popups">allow-popups</code></dfn> keyword.</p></li>

     <li><p>The <span>sandboxed top-level navigation browsing context flag</span>, unless <var>tokens</var> contains the <dfn><code data-x="attr-iframe-sandbox-allow-top-navigation">allow-top-navigation</code></dfn>
     keyword.</p></li>

     <li><p>The <span>sandboxed plugins browsing context flag</span>.</p></li>

     <li><p>The <span>sandboxed seamless iframes flag</span>.</p></li>

     <li>

      <p>The <span>sandboxed origin browsing context flag</span>, unless the <var>tokens</var> contains the <dfn><code data-x="attr-iframe-sandbox-allow-same-origin">allow-same-origin</code></dfn>
      keyword.</p>

      <div class="note">

       <p>The <code data-x="attr-iframe-sandbox-allow-same-origin">allow-same-origin</code> keyword
       is intended for two cases.</p>

       <p>First, it can be used to allow content from the same site to be sandboxed to disable
       scripting, while still allowing access to the DOM of the sandboxed content.</p>

       <p>Second, it can be used to embed content from a third-party site, sandboxed to prevent that
       site from opening pop-up windows, etc, without preventing the embedded page from
       communicating back to its originating site, using the database APIs to store data, etc.</p>

      </div>

     </li>

     <li><p>The <span>sandboxed forms browsing context flag</span>, unless <var>tokens</var> contains the <dfn><code data-x="attr-iframe-sandbox-allow-forms">allow-forms</code></dfn> keyword.</p></li>

     <li><p>The <span>sandboxed pointer lock browsing context flag</span>, unless <var>tokens</var> contains the <dfn><code data-x="attr-iframe-sandbox-allow-pointer-lock">allow-pointer-lock</code></dfn>
     keyword.</p></li>

     <li><p>The <span>sandboxed scripts browsing context flag</span>, unless <var>tokens</var> contains the <dfn><code data-x="attr-iframe-sandbox-allow-scripts">allow-scripts</code></dfn> keyword.</p></li>

     <li>

      <p>The <span>sandboxed automatic features browsing context flag</span>, unless <var>tokens</var> contains the <code
      data-x="attr-iframe-sandbox-allow-scripts">allow-scripts</code> keyword (defined above).</p>

      <p class="note">This flag is relaxed by the same keyword as scripts, because when scripts are
      enabled these features are trivially possible anyway, and it would be unfortunate to force
      authors to use script to do them when sandboxed rather than allowing them to use the
      declarative features.</p>

     </li>

     <li><p>The <span>sandboxed storage area URLs flag</span>.</p></li>

     <li><p>The <span>sandboxed fullscreen browsing context flag</span>, unless the <var>allow fullscreen flag</var> was passed to the <span>parse a sandboxing
     directive</span> flag.</p></li>

     <li><p>The <span>sandboxed <code data-x="dom-document-domain">document.domain</code> browsing
     context flag</span>.</p></li>

     <li><p>The <span>sandbox propagates to auxiliary browsing contexts flag</span>, unless
     <var>tokens</var> contains the <dfn><code data-x="attr-iframe-sandbox-allow-popups-to-escape-sandbox">allow-popups-to-escape-sandbox</code></dfn>
     keyword.</p></li>

     <li><p>The <span>sandboxed modals flag</span>, unless <var>tokens</var> contains the <dfn><code
     data-x="attr-iframe-sandbox-allow-modals">allow-modals</code></dfn> keyword.</p></li>

    </ul>

   </li>

  </ol>

  <hr>

  <p>Every <span>top-level browsing context</span> has a <dfn>popup sandboxing flag set</dfn>, which
  is a <span>sandboxing flag set</span>. When a <span>browsing context</span> is created, its
  <span>popup sandboxing flag set</span> must be empty. It is populated by <span>the rules for
  choosing a browsing context given a browsing context name</span>.</p>

  <p>Every <span>nested browsing context</span> has an <dfn><code>iframe</code> sandboxing flag
  set</dfn>, which is a <span>sandboxing flag set</span>. Which flags in a <span>nested browsing
  context</span>'s <span><code>iframe</code> sandboxing flag set</span> are set at any particular
  time is determined by the <code>iframe</code> element's <code
  data-x="attr-iframe-sandbox">sandbox</code> attribute.</p>

  <p>Every <code>Document</code> has an <dfn>active sandboxing flag set</dfn>, which is a
  <span>sandboxing flag set</span>. When the <code>Document</code> is created, its <span>active
  sandboxing flag set</span> must be empty. It is populated by the <span data-x="navigate">navigation
  algorithm</span>.</p>

  <p>Every resource that is obtained by the <span data-x="navigate">navigation algorithm</span> has a
  <dfn>forced sandboxing flag set</dfn>, which is a <span>sandboxing flag set</span>. A resource by
  default has no flags set in its <span>forced sandboxing flag set</span>, but other specifications
  can define that certain flags are set.</p>

  <p class="note">In particular, the <span>forced sandboxing flag set</span> is used by the Content
  Security Policy specification. <a href="#refsCSP">\[CSP]</a></p>

  <hr>

  <p>When a user agent is to <dfn>implement the sandboxing</dfn> for a <code>Document</code>, it
  must populate <code>Document</code>'s <span>active sandboxing flag set</span> with the union of
  the flags that are present in the following <span data-x="sandboxing flag set">sandboxing flag
  sets</span> at the time the <code>Document</code> object is created:</p>

  <ul>

   <li><p>If the <code>Document</code>'s <span>browsing context</span> is a <span>top-level browsing
   context</span>, then: the flags set on the <span>browsing context</span>'s <span>popup sandboxing
   flag set</span>.</p></li>

   <li><p>If the <code>Document</code>'s <span>browsing context</span> is a <span>nested browsing
   context</span>, then: the flags set on the <span>browsing context</span>'s
   <span><code>iframe</code> sandboxing flag set</span>.</p></li>

   <li><p>If the <code>Document</code>'s <span>browsing context</span> is a <span>nested browsing
   context</span>, then: the flags set on the <span>browsing context</span>'s <span>parent browsing
   context</span>'s <span>active document</span>'s <span>active sandboxing flag set</span>.</p></li>

   <li><p>The flags set on the <code>Document</code>'s resource's <span>forced sandboxing flag
   set</span>, if it has one.</p></li>

  </ul>


  <h3 id="history">Session history and navigation</h3>

  <h4 id="the-session-history-of-browsing-contexts">The session history of browsing contexts</h4>

  <p>The sequence of <code>Document</code>s in a <span>browsing context</span> is its <dfn>session
  history</dfn>. Each <span>browsing context</span>, including <span data-x="nested browsing
  context">nested browsing contexts</span>, has a distinct session history. A <span>browsing
  context</span>'s session history consists of a flat list of <span data-x="session history
  entry">session history entries</span>. Each <dfn>session history entry</dfn> consists, at a
  minimum, of a <span>URL</span>, and each entry may in addition have a <span>state object</span>, a
  title, a <code>Document</code> object, form data, a scroll position, and other information
  associated with it.</p>

  <p class="note">Each entry, when first created, has a <code>Document</code>. However, when a
  <code>Document</code> is not <span data-x="fully active">active</span>, it's possible for it to be
  <span data-x="discard a Document">discarded</span> to free resources. The <span>URL</span> and
  other data in a <span>session history entry</span> is then used to bring a new
  <code>Document</code> into being to take the place of the original, should the user agent find
  itself having to reactivate that <code>Document</code>.</p>

  <p class="note">Titles associated with <span data-x="session history entry">session history
  entries</span> need not have any relation with the current <code>title</code> of the
  <code>Document</code>. The title of a <span>session history entry</span> is intended to explain
  the state of the document at that point, so that the user can navigate the document's history.</p>

  <p>URLs without associated <span data-x="state object">state objects</span> are added to the
  session history as the user (or script) navigates from page to page.</p>

  <hr>

  <p>Each <code>Document</code> object in a <span>browsing context</span>'s <span>session
  history</span> is associated with a unique <code>History</code> object which must all model the
  same underlying <span>session history</span>.</p>

  <div class="impl">

  <p>The <dfn><code data-x="dom-history">history</code></dfn> attribute of the <code>Window</code>
  interface must return the object implementing the <code>History</code> interface for that <span
  data-x="concept-document-window"><code>Window</code> object's newest
  <code>Document</code></span>.</p>

  </div>

  <hr>

  <p>A <dfn>state object</dfn> is an object representing a user interface state.</p>

  <p>Pages can <span data-x="dom-history-pushState">add</span> <span data-x="state object">state
  objects</span> to the session history. These are then <span data-x="event-popstate">returned to the
  script</span> when the user (or script) goes back in the history, thus enabling authors to use the
  "navigation" metaphor even in one-page applications.</p>

  <div class="note">

   <p><span data-x="state object">State objects</span> are intended to be used for two main purposes:
   first, storing a preparsed description of the state in the <span>URL</span> so that in the simple
   case an author doesn't have to do the parsing (though one would still need the parsing for
   handling <span data-x="URL">URLs</span> passed around by users, so it's only a minor
   optimization), and second, so that the author can store state that one wouldn't store in the URL
   because it only applies to the current <code>Document</code> instance and it would have to be
   reconstructed if a new <code>Document</code> were opened.</p>

   <p>An example of the latter would be something like keeping track of the precise coordinate from
   which a pop-up <code>div</code> was made to animate, so that if the user goes back, it can be
   made to animate to the same location. Or alternatively, it could be used to keep a pointer into a
   cache of data that would be fetched from the server based on the information in the
   <span>URL</span>, so that when going back and forward, the information doesn't have to be fetched
   again.</p>

  </div>

  <hr>

  <p>At any point, one of the entries in the session history is the <dfn>current entry</dfn>. This
  is the entry representing the <span>active document</span> of the <span>browsing context</span>.
  Which entry is the <span>current entry</span> is changed by the algorithms defined in this
  specification, e.g. during <span data-x="traverse the history">session history
  traversal</span>.</p>

  <p class="note">The <span>current entry</span> is usually an entry for the <span data-x="the
  document's address">address</span> of the <code>Document</code>. However, it can also be one of
  the entries for <span data-x="state object">state objects</span> added to the history by that
  document.</p>

  <p><dfn>An entry with persisted user state</dfn> is one that also has user-agent defined state.
  This specification does not specify what kind of state can be stored.</p>

  <p class="example">For example, some user agents might want to persist the scroll position, or the
  values of form controls.</p>

  <p class="note">User agents that persist the value of form controls are encouraged to also persist
  their directionality (the value of the element's <code data-x="attr-dir">dir</code> attribute).
  This prevents values from being displayed incorrectly after a history traversal when the user had
  originally entered the values with an explicit, non-default directionality.</p>

  <p>Entries that consist of <span data-x="state object">state objects</span> share the same
  <code>Document</code> as the entry for the page that was active when they were added.</p>

  <p>Contiguous entries that differ just by fragment identifier also share the same
  <code>Document</code>.</p>

  <p class="note">All entries that share the same <code>Document</code> (and that are therefore
  merely different states of one particular document) are contiguous by definition.</p>

  <p>Each <code>Document</code> in a <span>browsing context</span> can also have a <dfn>latest
  entry</dfn>. This is the entry for that <code>Document</code> to which the <span>browsing
  context</span>'s <span>session history</span> was most recently traversed. When a
  <code>Document</code> is created, it initially has no <span>latest entry</span>.</p>

  <div class="impl">

  <p>User agents may <span data-x="discard a Document">discard</span> the <code>Document</code>
  objects of entries other than the <span>current entry</span> that are not referenced from any
  script, reloading the pages afresh when the user or script navigates back to such pages. This
  specification does not specify when user agents should discard <code>Document</code> objects and
  when they should cache them.</p>

  <p>Entries that have had their <code>Document</code> objects discarded must, for the purposes of
  the algorithms given below, act as if they had not. When the user or script navigates back or
  forwards to a page which has no in-memory DOM objects, any other entries that shared the same
  <code>Document</code> object with it must share the new object as well.</p>

  </div>



<!--TOPIC:DOM APIs-->
  <h4>The <code>History</code> interface</h4>

  <pre class="idl">interface <dfn>History</dfn> {
  readonly attribute unsigned long <span data-x="dom-history-length">length</span>;
  readonly attribute any <span data-x="dom-history-state">state</span>;
  void <span data-x="dom-history-go">go</span>(optional long delta = 0);
  void <span data-x="dom-history-back">back</span>();
  void <span data-x="dom-history-forward">forward</span>();
  void <span data-x="dom-history-pushState">pushState</span>(any data, DOMString title, optional DOMString? url = null);
  void <span data-x="dom-history-replaceState">replaceState</span>(any data, DOMString title, optional DOMString? url = null);
};</pre>

  <dl class="domintro">

   <dt><var>window</var> . <code subdfn data-x="dom-history">history</code> . <code subdfn data-x="dom-history-length">length</code></dt>

   <dd>

    <p>Returns the number of entries in the <span>joint session history</span>.</p>

   </dd>

   <dt><var>window</var> . <code data-x="dom-history">history</code> . <code subdfn data-x="dom-history-state">state</code></dt>

   <dd>

    <p>Returns the current <span>state object</span>.</p>

   </dd>

   <dt><var>window</var> . <code data-x="dom-history">history</code> . <code subdfn data-x="dom-history-go">go</code>( [ <var>delta</var> ] )</dt>

   <dd>

    <p>Goes back or forward the specified number of steps in the <span>joint session history</span>.</p>

    <p>A zero delta will reload the current page.</p>

    <p>If the delta is out of range, does nothing.</p>

   </dd>

   <dt><var>window</var> . <code data-x="dom-history">history</code> . <code subdfn data-x="dom-history-back">back</code>()</dt>

   <dd>

    <p>Goes back one step in the <span>joint session history</span>.</p>

    <p>If there is no previous page, does nothing.</p>

   </dd>

   <dt><var>window</var> . <code data-x="dom-history">history</code> . <code subdfn data-x="dom-history-forward">forward</code>()</dt>

   <dd>

    <p>Goes forward one step in the <span>joint session history</span>.</p>

    <p>If there is no next page, does nothing.</p>

   </dd>

   <dt><var>window</var> . <code data-x="dom-history">history</code> . <code subdfn data-x="dom-history-pushState">pushState</code>(<var>data</var>, <var>title</var> [, <var>url</var> ] )</dt>

   <dd>

    <p>Pushes the given data onto the session history, with the given title, and, if provided and
    not null, the given URL.</p>

   </dd>

   <dt><var>window</var> . <code data-x="dom-history">history</code> . <code subdfn data-x="dom-history-replaceState">replaceState</code>(<var>data</var>, <var>title</var> [, <var>url</var> ] )</dt>

   <dd>

    <p>Updates the current entry in the session history to have the given data, title, and, if
    provided and not null, URL.</p>

   </dd>

  </dl>

<!--TOPIC:HTML-->

  <p>The <dfn>joint session history</dfn> of a <span>top-level browsing context</span> is the union
  of all the <span data-x="session history">session histories</span> of all <span data-x="browsing
  context">browsing contexts</span> of all the <span>fully active</span> <code>Document</code>
  objects that share that <span>top-level browsing context</span>, with all the entries that are
  <span data-x="current entry">current entries</span> in their respective <span data-x="session
  history">session histories</span> removed except for the <span>current entry of the joint session
  history</span>.</p>

  <p>The <dfn>current entry of the joint session history</dfn> is the entry that most recently
  became a <span>current entry</span> in its <span>session history</span>.</p>

  <p>Entries in the <span>joint session history</span> are ordered chronologically by the time they
  were added to their respective <span data-x="session history">session histories</span>. Each entry
  has an index; the earliest entry has index 0, and the subsequent entries are numbered with
  consecutively increasing integers (1, 2, 3, etc).</p>

  <p class="note">Since each <code>Document</code> in a <span>browsing context</span> might have a
  different <span>event loop</span>, the actual state of the <span>joint session history</span> can
  be somewhat nebulous. For example, two sibling <code>iframe</code> elements could both <span
  data-x="traverse the history">traverse</span> from one unique origin to another at the same time,
  so their precise order might not be well-defined; similarly, since they might only find out about
  each other later, they might disagree about the length of the <span>joint session
  history</span>.</p>

<!--TOPIC:DOM APIs-->

  <div class="impl">

<!--ADD-TOPIC:Security-->
  <p>All the getters and setters for attributes, and all the methods, defined on the
  <code>History</code> interface, when invoked on a <code>History</code> object associated with a
  <code>Document</code> that is not <span>fully active</span>, must throw a
  <code>SecurityError</code> exception instead of operating as described below.</p>
<!--REMOVE-TOPIC:Security-->

  <p>The <dfn><code data-x="dom-history-length">length</code></dfn> attribute of the
  <code>History</code> interface must return the number of entries in the <span>top-level browsing
  context</span>'s <span>joint session history</span>.</p>

  <p>The actual entries are not accessible from script.</p>

  <p>The <dfn><code data-x="dom-history-state">state</code></dfn> attribute of the
  <code>History</code> interface must return the last value it was set to by the user agent.
  Initially, its value must be null.</p>

  <p>When the <dfn><code data-x="dom-history-go">go(<var>delta</var>)</code></dfn> method is
  invoked, if <var>delta</var> is zero, the user agent must act as if the
  <code data-x="dom-location-reload">location.reload()</code> method was called instead. Otherwise,
  the user agent must <span>traverse the history by a delta</span> whose value is
  <var>delta</var>.</p>

  <p>When the <dfn><code data-x="dom-history-back">back()</code></dfn> method is invoked, the user
  agent must <span>traverse the history by a delta</span> &#x2212;1.</p>

  <p>When the <dfn><code data-x="dom-history-forward">forward()</code></dfn>method is invoked, the
  user agent must <span>traverse the history by a delta</span> +1.</p>

<!--TOPIC:HTML-->

  <hr>

  <p>Each <span>top-level browsing context</span> has a <dfn>session history traversal queue</dfn>,
  initially empty, to which <span data-x="concept-task">tasks</span> can be added.</p>

  <p>Each <span>top-level browsing context</span>, when created, must begin running
  the following algorithm, known as the <dfn>session history event loop</dfn> for that
  <span>top-level browsing context</span>, <span>in parallel</span>:</p>

  <ol>

   <li><p>Wait until this <span>top-level browsing context</span>'s <span>session history traversal
   queue</span> is not empty.</p></li>

   <li><p>Pull the first <span data-x="concept-task">task</span> from this <span>top-level browsing
   context</span>'s <span>session history traversal queue</span>, and execute it.</p></li>

   <li><p>Return to the first step of this algorithm.</p>

  </ol>

  <p>The <span>session history event loop</span> helps coordinate cross-browsing-context transitions
  of the <span>joint session history</span>: since each <span>browsing context</span> might, at any
  particular time, have a different <span>event loop</span> (this can happen if the user agent has
  more than one <span>event loop</span> per <span>unit of related browsing contexts</span>),
  transitions would otherwise have to involve cross-event-loop synchronisation.</p>

  <hr>

  <p>To <dfn>traverse the history by a delta</dfn> <var>delta</var>, the user agent must
  append a <span data-x="concept-task">task</span> to this <span>top-level browsing context</span>'s
  <span>session history traversal queue</span>, the <span data-x="concept-task">task</span>
  consisting of running the following steps:</p>

  <ol>

   <li><p>Let <var>delta</var> be the argument to the method.</p></li>

   <li><p>If the index of the <span>current entry of the joint session history</span> plus <var>delta</var> is less than zero or greater than or equal to the number of items in the
   <span>joint session history</span>, then abort these steps.</p>

   <li><p>Let <var>specified entry</var> be the entry in the <span>joint session
   history</span> whose index is the sum of <var>delta</var> and the index of the
   <span>current entry of the joint session history</span>.</p></li>

   <li><p>Let <var>specified browsing context</var> be the <span>browsing context</span> of
   the <var>specified entry</var>.</p></li>

   <li><p>If the <var>specified browsing context</var>'s <span>active document</span>'s
   <span>unload a document</span> algorithm is currently running, abort these steps.</p></li>

   <li>

    <p><span>Queue a task</span> that consists of running the following substeps. The relevant
    <span>event loop</span> is that of the <var>specified browsing context</var>'s
    <span>active document</span>. The <span>task source</span> for the queued task is the
    <span>history traversal task source</span>.</p>

    <ol>

     <li><p>If there is an ongoing attempt to navigate <var>specified browsing context</var>
     that has not yet <span data-x="concept-navigate-mature">matured</span> (i.e. it has not passed the
     point of making its <code>Document</code> the <span>active document</span>), then cancel that
     attempt to navigate the <span>browsing context</span>.</p></li>

     <li>

      <p>If the <var>specified browsing context</var>'s <span>active document</span> is not
      the same <code>Document</code> as the <code>Document</code> of the <var>specified
      entry</var>, then run these substeps:</p>

      <ol>

       <li><p><span data-x="prompt to unload a document">Prompt to unload</span> the <span>active
       document</span> of the <var>specified browsing context</var>. If the user
       <span>refused to allow the document to be unloaded</span>, then abort these steps.</p></li>

       <li><p><span data-x="unload a document">Unload</span> the <span>active document</span> of the
       <var>specified browsing context</var> with the <var>recycle</var> parameter
       set to false.</p></li>

      </ol>

     </li>

     <li><p><span>Traverse the history</span> of the <var>specified browsing context</var> to
     the <var>specified entry</var>.</p>

    </ol>

   </li>

  </ol>

  <p>When the user navigates through a <span>browsing context</span>, e.g. using a browser's back
  and forward buttons, the user agent must <span>traverse the history by a delta</span> equivalent
  to the action specified by the user.</p>

  <hr id="history-1"> <!--TOPIC:DOM APIs-->

  <p>The <dfn><code data-x="dom-history-pushState">pushState(<var>data</var>, <var>title</var>, <var>url</var>)</code></dfn> method adds a state object entry to
  the history.</p>

  <p>The <dfn><code data-x="dom-history-replaceState">replaceState(<var>data</var>, <var>title</var>, <var>url</var>)</code></dfn> method updates the state object,
  title, and optionally the <span>URL</span> of the <span>current entry</span> in the history.</p>

  <p>When either of these methods is invoked, the user agent must run the following steps:</p>

  <ol>

   <li><p>Let <var>cloned data</var> be a <span>structured clone</span> of the specified
   <var>data</var>. If this throws an exception, then rethrow that exception and abort
   these steps.</p></li>

   <li>

    <p>If the third argument is not null, run these substeps:</p>

    <ol>

     <li><span data-x="resolve a url">Resolve</span> the value of the third argument, relative to
     the <span>API base URL</span> specified by the <span>entry settings object</span>.</li>

     <li>If that fails, throw a <code>SecurityError</code> exception and abort these steps.</li>

     <li>Compare the resulting <span>parsed URL</span> to the result of applying the <span>URL
     parser</span> algorithm to <span>the document's address</span>. If any component of these two
     <span data-x="URL">URLs</span> differ other than the <span
     data-x="concept-url-path">path</span>, <span data-x="concept-url-query">query</span>, and <span
     data-x="concept-url-fragment">fragment</span> components, then throw a
     <code>SecurityError</code> exception and abort these steps.</li>

     <li>If the <span>origin</span> of the resulting <span>absolute URL</span> is not the same as
     the <span>origin</span> of the <span>responsible document</span> specified by the <span>entry
     settings object</span>, and either the <span data-x="concept-url-path">path</span> or <span
     data-x="concept-url-query">query</span> components of the two <span data-x="parsed URL">parsed
     URLs</span> compared in the previous step differ, throw a <code>SecurityError</code> exception
     and abort these steps. (This prevents sandboxed content from spoofing other pages on the same
     origin.)</li>

     <li><p>Let <var>new URL</var> be the resulting <span>absolute URL</span>.</p></li>

    </ol>

    <p>For the purposes of the comparisons in the above substeps, the <span
    data-x="concept-url-path">path</span> and <span data-x="concept-url-query">query</span> components
    can only be the same if the <span data-x="concept-url-scheme">scheme</span> component of both
    <span data-x="parsed URL">parsed URLs</span> are <span
    data-x="concept-url-scheme-relative">relative schemes</span>.</p>

   </li>

   <li>

    <p>If the third argument is null, then let <var>new URL</var> be the <span>URL</span>
    of the <span>current entry</span>.</p>

   <li>

    <p>If the method invoked was the <code data-x="dom-history-pushState">pushState()</code>
    method:</p>

    <ol>

     <li>

      <p>Remove all the entries in the <span>browsing context</span>'s <span>session history</span>
      after the <span>current entry</span>. If the <span>current entry</span> is the last entry in
      the session history, then no entries are removed.</p>

      <p class="note">This <a href="#history-notes">doesn't necessarily have to affect</a> the user
      agent's user interface.</p>

     </li>

     <li><p>Remove any <span data-x="concept-task">tasks</span> queued by the <span>history traversal
     task source</span> that are associated with any <code>Document</code> objects in the
     <span>top-level browsing context</span>'s <span>document family</span>.</p></li>

     <li><p>If appropriate, update the <span>current entry</span> to reflect any state that the user
     agent wishes to persist. The entry is then said to be <span>an entry with persisted user
     state</span>.</p></li>

     <li><p>Add a <span>state object</span> entry to the session history, after the <span>current
     entry</span>, with <var>cloned data</var> as the <span>state object</span>, the given
     <var>title</var> as the title, and <var>new URL</var> as the <span>URL</span>
     of the entry.</p></li>

     <li><p>Update the <span>current entry</span> to be this newly added entry.</p></li>

    </ol>

    <p>Otherwise, if the method invoked was the <code
    data-x="dom-history-replaceState">replaceState()</code> method:</p>

    <ol>

     <li><p>Update the <span>current entry</span> in the session history so that <var>cloned data</var> is the entry's new state object, the given <var>title</var>
     is the new title, and <var>new URL</var> is the entry's new <span>URL</span>.</p></li>

    </ol>

   </li>

   <li><p>If the <span>current entry</span> in the session history represents a non-GET request
   (e.g. it was the result of a POST submission) then update it to instead represent a GET
   request.</p></li>

   <li>

    <p>Set <span>the document's address</span> to <var>new URL</var>.</p>

    <p class="note">Since this is neither a <span data-x="navigate">navigation</span> of the
    <span>browsing context</span> nor a <span data-x="traverse the history">history traversal</span>,
    it does not cause a <code data-x="event-hashchange">hashchange</code> event to be fired.</p>

   </li>

   <li>

    <p>Set <code data-x="dom-history-state">history.state</code> to a <span>structured clone</span>
    of <var>cloned data</var>.</p> <!-- it's a clone of /cloned data/, not /data/, so that
    there's no risk of running scripts again -->

   </li>

   <li>

    <p>Let the <span>latest entry</span> of the <code>Document</code> of the <span>current
    entry</span> be the <span>current entry</span>.</p>

   </li>

  </ol>

  <p class="note">The <var>title</var> is purely advisory. User agents might use the title
  in the user interface.</p>

  <p>User agents may limit the number of state objects added to the session history per page. If a
  page hits the UA-defined limit, user agents must remove the entry immediately after the first
  entry for that <code>Document</code> object in the session history after having added the new
  entry. (Thus the state history acts as a FIFO buffer for eviction, but as a LIFO buffer for
  navigation.)</p>

  </div>

  <div class="example">

   <p>Consider a game where the user can navigate along a line, such that the user is always at some
   coordinate, and such that the user can bookmark the page corresponding to a particular
   coordinate, to return to it later.</p>

   <p>A static page implementing the x=5 position in such a game could look like the following:</p>

   <pre>&lt;!DOCTYPE HTML>
&lt;!-- this is http://example.com/line?x=5 -->
&lt;title>Line Game - 5&lt;/title>
&lt;p>You are at coordinate 5 on the line.&lt;/p>
&lt;p>
 &lt;a href="?x=6">Advance to 6&lt;/a> or
 &lt;a href="?x=4">retreat to 4&lt;/a>?
&lt;/p></pre>

   <p>The problem with such a system is that each time the user clicks, the whole page has to be
   reloaded. Here instead is another way of doing it, using script:</p>

   <pre>&lt;!DOCTYPE HTML>
&lt;!-- this starts off as http://example.com/line?x=5 -->
&lt;title>Line Game - 5&lt;/title>
&lt;p>You are at coordinate &lt;span id="coord">5&lt;/span> on the line.&lt;/p>
&lt;p>
 &lt;a href="?x=6" onclick="go(1); return false;">Advance to 6&lt;/a> or
 &lt;a href="?x=4" onclick="go(-1); return false;">retreat to 4&lt;/a>?
&lt;/p>
&lt;script>
 var currentPage = 5; // prefilled by server
 function go(d) {
   setupPage(currentPage + d);
   history.pushState(currentPage, document.title, '?x=' + currentPage);
 }
 onpopstate = function(event) {
   setupPage(event.state);
 }
 function setupPage(page) {
   currentPage = page;
   document.title = 'Line Game - ' + currentPage;
   document.getElementById('coord').textContent = currentPage;
   document.links[0].href = '?x=' + (currentPage+1);
   document.links[0].textContent = 'Advance to ' + (currentPage+1);
   document.links[1].href = '?x=' + (currentPage-1);
   document.links[1].textContent = 'retreat to ' + (currentPage-1);
 }
&lt;/script></pre>

   <p>In systems without script, this still works like the previous example. However, users that
   <em>do</em> have script support can now navigate much faster, since there is no network access
   for the same experience. Furthermore, contrary to the experience the user would have with just a
   na&iuml;ve script-based approach, bookmarking and navigating the session history still work.</p>

   <p>In the example above, the <var>data</var> argument to the <code
   data-x="dom-history-pushState">pushState()</code> method is the same information as would be sent
   to the server, but in a more convenient form, so that the script doesn't have to parse the URL
   each time the user navigates.</p>

  </div>

  <div class="example">

   <p>Applications might not use the same title for a <span>session history entry</span> as the
   value of the document's <code>title</code> element at that time. For example, here is a simple
   page that shows a block in the <code>title</code> element. Clearly, when navigating backwards to
   a previous state the user does not go back in time, and therefore it would be inappropriate to
   put the time in the session history title.</p>

   <pre>&lt;!DOCTYPE HTML>
&lt;TITLE>Line&lt;/TITLE>
&lt;SCRIPT>
 setInterval(function () { document.title = 'Line - ' + new Date(); }, 1000);
 var i = 1;
 function inc() {
   set(i+1);
   history.pushState(i, 'Line - ' + i);
 }
 function set(newI) {
   i = newI;
   document.forms.F.I.value = newI;
 }
&lt;/SCRIPT>
&lt;BODY ONPOPSTATE="set(event.state)">
&lt;FORM NAME=F>
State: &lt;OUTPUT NAME=I>1&lt;/OUTPUT> &lt;INPUT VALUE="Increment" TYPE=BUTTON ONCLICK="inc()">
&lt;/FORM></pre>

  </div>



  <h4>The <code>Location</code> interface</h4>

  <p>Each <code>Document</code> object in a <span>browsing context</span>'s session history is
  associated with a unique instance of a <code>Location</code> object.</p>

  <dl class="domintro">

   <dt><var>document</var> . <code subdfn data-x="dom-document-location">location</code> [ = <var>value</var> ]</dt>
   <dt><var>window</var> . <code subdfn data-x="dom-location">location</code> [ = <var>value</var> ]</dt>

   <dd>

    <p>Returns a <code>Location</code> object with the current page's location.</p>

    <p>Can be set, to navigate to another page.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-document-location">location</code></dfn> attribute of the
  <code>Document</code> interface must return the <code>Location</code> object for that
  <code>Document</code> object, if it is in a <span>browsing context</span>, and null otherwise.</p>

  <p>The <dfn><code data-x="dom-location">location</code></dfn> attribute of the <code>Window</code>
  interface must return the <code>Location</code> object for that <code>Window</code> object's
  <code>Document</code>.</p>

  </div>

  <p><code>Location</code> objects provide a representation of <span data-x="the document's
  address">the address</span> of the <span>active document</span> of their <code>Document</code>'s
  <span>browsing context</span>, and allow the <span>current entry</span> of the <span>browsing
  context</span>'s session history to be changed, by adding or replacing entries in the <code
  data-x="dom-history">history</code> object.</p>

  <pre class="idl">[Unforgeable] interface <dfn>Location</dfn> {
  stringifier attribute USVString <span data-x="dom-location-href">href</span>;
  attribute USVString <span data-x="dom-location-origin">origin</span>;
  attribute USVString <span data-x="dom-location-protocol">protocol</span>;
  attribute USVString <span data-x="dom-location-host">host</span>;
  attribute USVString <span data-x="dom-location-hostname">hostname</span>;
  attribute USVString <span data-x="dom-location-port">port</span>;
  attribute USVString <span data-x="dom-location-pathname">pathname</span>;
  attribute USVString <span data-x="dom-location-search">search</span>;
  attribute USVString <span data-x="dom-location-hash">hash</span>;

  void <span data-x="dom-location-assign">assign</span>(USVString url);
  void <span data-x="dom-location-replace">replace</span>(USVString url);
  void <span data-x="dom-location-reload">reload</span>();

  [SameObject] readonly attribute <span>USVString</span>[] <span data-x="dom-location-ancestorOrigins">ancestorOrigins</span>;
};</pre>

  <dl class="domintro">
   <dt><var>location</var> . <code>toString()</code></dt>
   <dt><var>location</var> . <code subdfn data-x="dom-hyperlink-href">href</code></dt>
   <dd>
    <p>Returns the <code>Location</code> object's URL.</p>
    <p>Can be set, to navigate to the given URL.</p>
   </dd>

   <dt><var>location</var> . <code subdfn data-x="dom-hyperlink-origin">origin</code></dt>
   <dd>
    <p>Returns the <code>Location</code> object's URL's origin.</p>
   </dd>

   <dt><var>location</var> . <code subdfn data-x="dom-hyperlink-protocol">protocol</code></dt>
   <dd>
    <p>Returns the <code>Location</code> object's URL's scheme.</p>
    <p>Can be set, to navigate to the same URL with a changed scheme.</p>
   </dd>

   <dt><var>location</var> . <code subdfn data-x="dom-hyperlink-host">host</code></dt>
   <dd>
    <p>Returns the <code>Location</code> object's URL's host and port (if different from the default
    port for the scheme).</p>
    <p>Can be set, to navigate to the same URL with a changed host and port.</p>
   </dd>

   <dt><var>location</var> . <code subdfn data-x="dom-hyperlink-hostname">hostname</code></dt>
   <dd>
    <p>Returns the <code>Location</code> object's URL's host.</p>
    <p>Can be set, to navigate to the same URL with a changed host.</p>
   </dd>

   <dt><var>location</var> . <code subdfn data-x="dom-hyperlink-port">port</code></dt>
   <dd>
    <p>Returns the <code>Location</code> object's URL's port.</p>
    <p>Can be set, to navigate to the same URL with a changed port.</p>
   </dd>

   <dt><var>location</var> . <code subdfn data-x="dom-hyperlink-pathname">pathname</code></dt>
   <dd>
    <p>Returns the <code>Location</code> object's URL's path.</p>
    <p>Can be set, to navigate to the same URL with a changed path.</p>
   </dd>

   <dt><var>location</var> . <code subdfn data-x="dom-hyperlink-search">search</code></dt>
   <dd>
    <p>Returns the <code>Location</code> object's URL's query (includes leading "<code
   >?</code>" if non-empty).</p>
    <p>Can be set, to navigate to the same URL with a changed query (ignores leading "<code
   >?</code>").</p>
   </dd>

   <dt><var>location</var> . <code subdfn data-x="dom-hyperlink-hash">hash</code></dt>
   <dd>
    <p>Returns the <code>Location</code> object's URL's fragment (includes leading "<code
   >#</code>" if non-empty).</p>
    <p>Can be set, to navigate to the same URL with a changed fragment (ignores leading "<code
   >#</code>").</p>
   </dd>

   <dt><var>location</var> . <code subdfn data-x="dom-location-assign">assign</code>(<var>url</var>)</dt>
   <dd>
    <p>Navigates to the given URL.</p>
   </dd>

   <dt><var>location</var> . <code subdfn data-x="dom-location-replace">replace</code>(<var>url</var>)</dt>
   <dd>
    <p>Removes the current page from the session history and navigates to the given URL.</p>
   </dd>

   <dt><var>location</var> . <code subdfn data-x="dom-location-reload">reload</code>()</dt>

   <dd>
    <p>Reloads the current page.</p>
   </dd>

   <dt><var>location</var> . <code subdfn data-x="dom-location-ancestorOrigins">ancestorOrigins</code></dt>
   <dd>
    <p>Returns an array whose values are the origins of the ancestor <span data-x="browsing
    context">browsing contexts</span>, from the <span>parent browsing context</span> to the
    <span>top-level browsing context</span>.</p>
   </dd>
  </dl>

  <div class="impl">

  <p>A <code>Location</code> object has an associated <dfn>relevant
  <code>Document</code></dfn>, which is this <code>Location</code> object's associated
  <code>Document</code> object's <span>browsing context</span>'s <span>active document</span>.</p>

  <p>A <code>Location</code> object has an associated <dfn
  data-x="concept-location-url">url</dfn>, which is this <code>Location</code> object's
  <span>relevant <code>Document</code></span>'s <span data-x="the document's
  address">address</span>.</p>

  <p>A <code>Location</code> object has an associated <dfn><code>Location</code>-object-setter
  navigate</dfn> algorithm, which given a <var>url</var>, runs these steps:</p>

  <ol>
   <li>
    <p>If any of the following conditions are met, let <var>replacement flag</var> be unset;
    otherwise, let it be set:</p>

    <ul class="brief">
     <li>This <code>Location</code> object's <span>relevant <code>Document</code></span> has
     <span>completely loaded</span>, or</li>

     <li>In the <span data-x="concept-task">task</span> in which the algorithm is running, an
     <span>activation behavior</span> is currently being processed whose <code
     data-x="event-click">click</code> event was <span
     data-x="concept-events-trusted">trusted</span>, or</li>

     <li>In the <span data-x="concept-task">task</span> in which the algorithm is running, the event
     listener for a <span data-x="concept-events-trusted">trusted</span> <code
     data-x="event-click">click</code> event is being handled.</li>
    </ul>
   </li>

   <li><p><span><code>Location</code>-object navigate</span>, given <var>url</var> and
   <var>replacement flag</var>.</p></li>
  </ol>

  <p>To <dfn><code>Location</code>-object navigate</dfn>, given a <var>url</var> and
  <var>replacement flag</var>, run these steps:</p>

  <ol>
   <li><p>The <span>source browsing context</span> is the <span>responsible browsing context</span>
   specified by the <span>incumbent settings object</span>.</p></li>

   <li>
    <p><span>Navigate</span><!--DONAV location--> the <span>browsing context</span> to
    <var>url</var>, with <span>exceptions enabled</span>.</p>

    <p>If the <var>replacement flag</var> is set or the <span>browsing context</span>'s
    <span>session history</span> contains only one <code>Document</code>, and that was the
    <code>about:blank</code> <code>Document</code> created when the <span>browsing context</span>
    was created, then the navigation must be done with <span>replacement enabled</span>.</p>
    <!-- READ ME WHEN EDITING THIS: IE and Firefox only seem to treat it that way if the DOM is
         still a virgin DOM; Safari doesn't check that. Thus this might need changing if testing
         shows the IE/Firefox behavior is required here. -->
   </li>
  </ol>

  <p>The <dfn><code data-x="dom-location-href">href</code></dfn> attribute's getter must return this
  <code>Location</code> object's <span data-x="concept-location-url">url</span>, <span
  data-x="concept-url-serializer">serialized</span>.</p>

  <p>The <code data-x="dom-location-href">href</code> attribute's setter must run these steps:</p>

  <ol>
   <li><p>Let <var>newURL</var> be the <span>resulting parsed URL</span> of <span data-x="resolve a
   url">resolving</span> the given value relative to the <span>entry settings object</span>'s
   <span>API base URL</span>.</p></li>

   <li><p>If that aborted with an error, throw a <code>TypeError</code> exception.</p></li>

   <li><p><span><code>Location</code>-object-setter navigate</span> to <var>newURL</var>.</p></li>
  </ol>

  <p>The <dfn><code data-x="dom-location-origin">origin</code></dfn> attribute's getter must return
  the <span data-x="Unicode serialization of an origin">Unicode serialization</span> of this
  <code>Location</code> object's <span data-x="concept-location-url">url</span>'s <span
  data-x="concept-url-origin">origin</span>.</p>

  <p class="note no-backref">It returns the Unicode rather than the ASCII serialization for
  compatibility with <code>MessageEvent</code>.</p>

  <p>The <dfn><code data-x="dom-location-protocol">protocol</code></dfn> attribute's getter must
  return this <code>Location</code> object's <span data-x="concept-location-url">url</span>'s <span
  data-x="concept-url-scheme">scheme</span>, followed by "<code>:</code>".</p>

  <p>The <code data-x="dom-location-protocol">protocol</code> attribute's setter must run these
  steps:</p>

  <ol>
   <li><p>Let <var>copyURL</var> be a copy of this <code>Location</code> object's <span
   data-x="concept-location-url">url</span>.</p></li>

   <li><p>Let <var>possibleFailure</var> be the result of <span data-x="basic url parser">basic URL
   parsing</span> the given value, followed by "<code>:</code>", with <var>copyURL</var>
   as <var>url</var> and <span>scheme start state</span> as <var>state override</var>.</p></li>

   <li><p>If <var>possibleFailure</var> is failure, throw a <code>TypeError</code>
   exception.</p></li>

   <li><p>If <var>copyURL</var>'s <span data-x="concept-url-scheme">scheme</span> is not "<code
  >http</code>" or "<code>https</code>", terminate these steps.</p></li>

   <li><p><span><code>Location</code>-object-setter navigate</span> to <var>copyURL</var>.</p></li>
  </ol>

  <p>The <dfn><code data-x="dom-location-host">host</code></dfn> attribute's getter must run these
  steps:</p>

  <ol>
   <li><p>Let <var>url</var> be this <code>Location</code> object's <span
   data-x="concept-location-url">url</span>.</p></li>

   <li><p>If <var>url</var>'s <span data-x="concept-url-host">host</span> is null, return the empty
   string.</p></li>

   <li><p>If <var>url</var>'s <span data-x="concept-url-port">port</span> is null, return
   <var>url</var>'s <span data-x="concept-url-host">host</span>, <span  data-x="host
   serializer">serialized</span>.</p></li>

   <li><p>Return <var>url</var>'s <span data-x="concept-url-host">host</span>, <span data-x="host
   serializer">serialized</span>, followed by "<code>:</code>" and <var>url</var>'s <span
   data-x="concept-url-port">port</span>, <span data-x="serialize an
   integer">serialized</span>.</p></li>
  </ol>

  <p>The <code data-x="dom-location-host">host</code> attribute's setter must run these steps:</p>

  <ol>
   <li><p>Let <var>copyURL</var> be a copy of this <code>Location</code> object's <span
   data-x="concept-location-url">url</span>.</p></li>

   <li><p>If <var>copyURL</var>'s <span>non-relative flag</span> is set, terminate these
   steps.</p></li>

   <li><p><span data-x="basic url parser">Basic URL parse</span> the given value, with
   <var>copyURL</var> as <var>url</var> and <span>host state</span> as <var>state
   override</var>.</p></li>

   <li><p><span><code>Location</code>-object-setter navigate</span> to <var>copyURL</var>.</p></li>
  </ol>

  <p>The <dfn><code data-x="dom-location-hostname">hostname</code></dfn> attribute's getter must
  run these steps:</p>

  <ol>
   <li><p>If this <code>Location</code> object's <span data-x="concept-location-url">url</span>'s
   <span data-x="concept-url-host">host</span> is null, return the empty string.</p></li>

   <li><p>Return this <code>Location</code> object's <span
   data-x="concept-location-url">url</span>'s <span data-x="concept-url-host">host</span>, <span
   data-x="host serializer">serialized</span>.</p></li>
  </ol>

  <p>The <code data-x="dom-location-hostname">hostname</code> attribute's setter must run these
  steps:</p>

  <ol>
   <li><p>Let <var>copyURL</var> be a copy of this <code>Location</code> object's <span
   data-x="concept-location-url">url</span>.</p></li>

   <li><p>If <var>copyURL</var>'s <span>non-relative flag</span> is set, terminate these
   steps.</p></li>

   <li><p><span data-x="basic url parser">Basic URL parse</span> the given value, with
   <var>copyURL</var> as <var>url</var> and <span>hostname state</span> as <var>state
   override</var>.</p></li>

   <li><p><span><code>Location</code>-object-setter navigate</span> to <var>copyURL</var>.</p></li>
  </ol>

  <p>The <dfn><code data-x="dom-location-port">port</code></dfn> attribute's getter must run these
  steps:</p>

  <ol>
   <li><p>If this <code>Location</code> object's <span data-x="concept-location-url">url</span>'s
   <span data-x="concept-url-port">port</span> is null, return the empty string.</p></li>

   <li><p>Return this <code>Location</code> object's <span
   data-x="concept-location-url">url</span>'s <span data-x="concept-url-port">port</span>, <span
   data-x="serialize an integer">serialized</span>.</p></li>
  </ol>

  <p>The <code data-x="dom-location-port">port</code> attribute's setter must run these steps:</p>

  <ol>
   <li><p>Let <var>copyURL</var> be a copy of this <code>Location</code> object's <span
   data-x="concept-location-url">url</span>.</p></li>

   <li><p>If <var>copyURL</var>'s <span data-x="concept-url-host">host</span> is null,
   <var>copyURL</var>'s <span>non-relative flag</span> is set, or <var>copyURL</var>'s <span
   data-x="concept-url-scheme">scheme</span> is "<code>file</code>", terminate these
   steps.</p></li>

   <li><p><span data-x="basic url parser">Basic URL parse</span> the given value, with
   <var>copyURL</var> as <var>url</var> and <span>port state</span> as <var>state
   override</var>.</p></li>

   <li><p><span><code>Location</code>-object-setter navigate</span> to <var>copyURL</var>.</p></li>
  </ol>

  <p>The <dfn><code data-x="dom-location-pathname">pathname</code></dfn> attribute's getter must
  run these steps:</p>

  <ol>
   <li><p>Let <var>url</var> be this <code>Location</code> object's <span
   data-x="concept-location-url">url</span>.</p></li>

   <li><p>If <var>url</var>'s <span>non-relative flag</span> is set, return the first string in
   <var>url</var>'s <span data-x="concept-url-path">path</span>.</p></li>

   <li><p>Return "<code>/</code>", followed by the strings in <var>url</var>'s <span
   data-x="concept-url-path">path</span> (including empty strings), separated from each other by
   "<code>/</code>".</p></li>
  </ol>

  <p>The <code data-x="dom-location-pathname">pathname</code> attribute's setter must run these
  steps:</p>

  <ol>
   <li><p>Let <var>copyURL</var> be a copy of this <code>Location</code> object's <span
   data-x="concept-location-url">url</span>.</p></li>

   <li><p>If <var>copyURL</var>'s <span>non-relative flag</span> is set, terminate these
   steps.</p></li>

   <li><p>Set <var>copyURL</var>'s <span data-x="concept-url-path">path</span> to the empty
   list.</p></li>

   <li><p><span data-x="basic url parser">Basic URL parse</span> the given value, with
   <var>copyURL</var> as <var>url</var> and <span>path start state</span> as <var>state
   override</var>.</p></li>

   <li><p><span><code>Location</code>-object-setter navigate</span> to <var>copyURL</var>.</p></li>
  </ol>

  <p>The <dfn><code data-x="dom-location-search">search</code></dfn> attribute's getter must run
  these steps:</p>

  <ol>
   <li><p>If this <code>Location</code> object's <span data-x="concept-location-url">url</span>'s
   <span data-x="concept-url-query">query</span> is either null or the empty string, return the
   empty string.</p></li>

   <li><p>Return "<code>?</code>", followed by this <code>Location</code> object's <span
   data-x="concept-location-url">url</span>'s <span
   data-x="concept-url-query">query</span>.</p></li>
  </ol>

  <p>The <code data-x="dom-location-search">search</code> attribute's setter must run these
  steps:</p>

  <ol>
   <li><p>Let <var>copyURL</var> be a copy of this <code>Location</code> object's <span
   data-x="concept-location-url">url</span>.</p></li>

   <li><p>If the given value is the empty string, set <var>copyURL</var>'s <span
   data-x="concept-url-query">query</span> to null.

   <li>
    <p>Otherwise, run these substeps:</p>

    <ol>
     <li><p>Let <var>input</var> be the given value with a single leading "<code>?</code>"
     removed, if any.</p></li>

     <li><p>Set <var>copyURL</var>'s <span data-x="concept-url-query">query</span> to the empty
     string.</p></li>

     <li><p><span data-x="basic url parser">Basic URL parse</span> <var>input</var>, with
     <var>copyURL</var> as <var>url</var> and <span>query state</span> as <var>state override</var>,
     and the <span>relevant <code>Document</code></span>'s <span>document's character
     encoding</span> as <var>encoding override</var>.</p></li>
    </ol>
   </li>

   <li><p><span><code>Location</code>-object-setter navigate</span> to <var>copyURL</var>.</p></li>
  </ol>

  <p>The <dfn><code data-x="dom-location-hash">hash</code></dfn> attribute's getter must run these
  steps:</p>

  <ol>
   <li><p>If this <code>Location</code> object's <span data-x="concept-location-url">url</span>'s
   <span data-x="concept-url-fragment">fragment</span> is either null or the empty string, return
   the empty string.</p></li>

   <li><p>Return "<code>#</code>", followed by this <code>Location</code> object's <span
   data-x="concept-location-url">url</span>'s <span
   data-x="concept-url-fragment">fragment</span>.</p></li>
  </ol>

  <p>The <code data-x="dom-location-hash">hash</code> attribute's setter must run these steps:</p>

  <ol>
   <li><p>Let <var>copyURL</var> be a copy of this <code>Location</code> object's <span
   data-x="concept-location-url">url</span>.</p></li>

   <li><p>If <var>copyURL</var>'s <span data-x="concept-url-scheme">scheme</span> is "<code
  >javascript</code>", terminate these steps.</p></li>

   <li><p>If the given value is the empty string, set <var>copyURL</var>'s <span
   data-x="concept-url-fragment">fragment</span> to null.

   <li>
    <p>Otherwise, run these substeps:</p>

    <ol>
     <li><p>Let <var>input</var> be the given value with a single leading "<code>#</code>"
     removed, if any.</p></li>

     <li><p>Set <var>copyURL</var>'s <span data-x="concept-url-fragment">fragment</span> to the
     empty string.</p></li>

     <li><p><span data-x="basic url parser">Basic URL parse</span> <var>input</var>, with
     <var>copyURL</var> as <var>url</var> and <span>fragment state</span> as <var>state
     override</var>.</p></li>
    </ol>
   </li>

   <li><p><span><code>Location</code>-object-setter navigate</span> to <var>copyURL</var>.</p></li>
  </ol>

  <hr>

  <p>When the <dfn><code data-x="dom-location-assign">assign(<var>url</var>)</code></dfn>
  method is invoked, the user agent must run the following steps:

  <ol>

   <li>

    <p><span data-x="resolve a url">Resolve</span> <var>url</var>, relative to the
    <span>API base URL</span> specified by the <span>entry settings object</span> and let
    <var>parsedURL</var> be the <span>resulting parsed URL</span>.</p>

    <p>If this is not successful, throw a <code>SyntaxError</code> exception and abort these
    steps.</p>

   </li>

   <li><p><span><code>Location</code>-object navigate</span> to <var>parsedURL</var>.</p></li>

  </ol>

  <p>When the <dfn><code data-x="dom-location-replace">replace(<var>url</var>)</code></dfn>
  method is invoked, the user agent must run the following steps:

  <ol>

   <li>

    <p><span data-x="resolve a url">Resolve</span> <var>url</var>, relative to the
    <span>API base URL</span> specified by the <span>entry settings object</span> and let
    <var>parsedURL</var> be the <span>resulting parsed URL</span>.</p>

    <p>If this is not successful, throw a <code>SyntaxError</code> exception and abort these
    steps.</p>

   </li>

   <li><p><span><code>Location</code>-object navigate</span> to <var>parsedURL</var> with the
   <var>replacement flag</var> set.</p></li>

  </ol>

  <p>When the <dfn><code data-x="dom-location-reload">reload()</code></dfn> method is invoked, the
  user agent must run the appropriate steps from the following list:</p>

  <dl class="switch">

   <dt>If the currently executing <span data-x="concept-task">task</span> is the dispatch of a <code
   data-x="event-resize">resize</code> event in response to the user resizing the <span>browsing
   context</span></dt>

   <dd><p>Repaint the <span>browsing context</span> and abort these steps.</p></dd> <!-- this
   theoretically would have no effect but in practice can be useful to work around rendering bugs.
   -->

   <dt>If the <span>browsing context</span>'s <span>active document</span> is <span>an
   <code>iframe</code> <code data-x="attr-iframe-srcdoc">srcdoc</code> document</span></dt>

   <dd><p><span data-x="process the iframe attributes">Reprocess the <code>iframe</code>
   attributes</span> of the <span>browsing context</span>'s <span>browsing context
   container</span>.</p></dd>

   <dt>If the <span>browsing context</span>'s <span>active document</span> has its <span>reload
   override flag</span> set</dt>

   <dd><p>Perform <span>an overridden reload</span>, with the <span>browsing context</span> being
   navigated as the <span>responsible browsing context</span>.</p></dd>
   <!-- http://damowmow.com/playground/demos/sandbox/001.html -->

   <dt>Otherwise</dt>

   <dd><p><span>Navigate</span><!--DONAV location.reload()--> the <span>browsing context</span> to
   <span>the document's address</span> with <span>replacement enabled</span> and <span>exceptions
   enabled</span>. The <span>source browsing context</span> must be the <span>browsing
   context</span> being navigated. This is a <span>reload-triggered navigation</span>.</p></dd> <!--
   it appears that document.reload() always uses GET and does not, e.g., re-POST. -->

   <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/saved/141 defends the source browsing context claim; submit, eval document.referrer, reload, eval document.referrer. -->

  </dl>

  <p>When a user requests that the <span>active document</span> of a <span>browsing context</span>
  be reloaded through a user interface element, the user agent should <span>navigate</span><!--DONAV
  user reload--> the <span>browsing context</span> to the same resource as that
  <code>Document</code>, with <span>replacement enabled</span>. In the case of non-idempotent
  methods (e.g. HTTP POST), the user agent should prompt the user to confirm the operation first,
  since otherwise transactions (e.g. purchases or database modifications) could be repeated. User
  agents may allow the user to explicitly override any caches when reloading. If <span>browsing
  context</span>'s <span>active document</span>'s <span>reload override flag</span> is set, then the
  user agent may instead perform <span>an overridden reload</span> rather than the navigation
  described in this paragraph (with the <span>browsing context</span> being reloaded as the
  <span>source browsing context</span>).</p>

  <hr>

  <p>The <dfn><code data-x="dom-location-ancestorOrigins">ancestorOrigins</code></dfn> attribute, on
  getting, must return a <span data-x="dfn-read-only-array">read only</span> array whose values are
  determined as follows. The same object must be returned each time the attribute's value is
  obtained for any particular <code>Location</code> object.</p>

  <ol>

   <li><p>Let <var>output</var> be an empty ordered list of strings.</p>

   <li><p>Let <var>current</var> be the <span>browsing context</span> of the <code>Document</code>
   with which the <code>Location</code> object is associated.</p></li>

   <li><p><i>Loop</i>: If <var>current</var> has no <span>parent browsing context</span>, jump to
   the step labeled <i>end</i>.</p></li>

   <li><p>Let <var>current</var> be <var>current</var>'s <span>parent browsing
   context</span>.</p></li>

   <li><p>Append the <span data-x="Unicode serialization of an origin">Unicode serialization</span>
   of <var>current</var>'s <span>active document</span>'s <span>origin</span> to <var>output</var>
   as a new value.</p></li>

   <li><p>Return to the step labeled <i>loop</i>.</p></li>

   <li><p><i>End</i>: Let <var>output</var> be the values of the array, in the same order.</p></li>

  </ol>

  </div>



<!--ADD-TOPIC:Security-->
  <div class="impl">

  <h5 id="security-location">Security</h5>

  <p class="critical">This section describes a security model that is underdefined, imperfect, and
  does not match implementations. Work is ongoing to attempt to resolve this, but in the meantime,
  please do not rely on this section for precision. Implementors are urged to send their feedback on
  how cross-origin cross-global access to <code>Window</code> and <code>Location</code> objects
  should work. See <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=20701">bug 20701</a>.</p>

  <p id="security-3">User agents must throw a <code>SecurityError</code> exception whenever any
  properties of a <code>Location</code> object are accessed when the <span>entry settings
  object</span> specifies an <span>effective script origin</span> that is not the <span data-x="same
  origin">same</span> as the <code>Location</code> object's associated <code>Document</code>'s
  <span>browsing context</span>'s <span>active document</span>'s <span>effective script
  origin</span>, with the following exceptions:</p>

  <ul>

   <li>The <code data-x="dom-location-href">href</code> setter, if the <span>responsible browsing
   context</span> specified by the <span>entry settings object</span> is <span>familiar with</span>
   the <span>browsing context</span> with which the <code>Location</code> object is associated

   <li>The <code data-x="dom-location-replace">replace()</code> method, if the <span>responsible
   browsing context</span> specified by the <span>entry settings object</span> is <span>familiar
   with</span> the <span>browsing context</span> with which the <code>Location</code> object is
   associated

   <li>Any properties not defined in the IDL for the <code>Location</code> object or indirectly via
   one of those properties (e.g. <code>toString()</code>, which is defined via the <code
  >stringifier</code> keyword), if the <span>effective script origin</span> specified by
   the <span>entry settings object</span> is the <span>same origin</span> as the
   <code>Location</code> object's associated <code>Document</code>'s <span>effective script
   origin</span>

  </ul>

  <p>When the <span>effective script origin</span> specified by the <span>entry settings
  object</span> is different than a <code>Location</code> object's associated
  <code>Document</code>'s <span>effective script origin</span>, the user agent must act as if any
  changes to that <code>Location</code> object's properties, getters, setters, etc, were not
  present, and as if all the properties of that <code>Location</code> object had their
  [[Enumerable]] attribute set to false.</p>

  <p>For members that return objects (including function objects), each distinct <span>effective
  script origin</span> that is not the <span>same origin</span> as the <code>Location</code>
  object's <code>Document</code>'s <span>effective script origin</span> must be provided with a
  separate set of objects. These objects must have the prototype chain appropriate for the script
  for which the objects are created (not those that would be appropriate for scripts whose
  <span>settings object</span> specifies a <span>global object</span> that is the
  <code>Location</code> object's <code>Document</code>'s <code>Window</code> object).</p>

  </div>
<!--REMOVE-TOPIC:Security-->


  <div class="impl">

  <h4 id="history-notes">Implementation notes for session history</h4>
  <!-- don't change the ID without updating multiple internal links -->

  <p><em>This section is non-normative.</em></p>

  <p>The <code>History</code> interface is not meant to place restrictions on how implementations
  represent the session history to the user.</p>

  <p>For example, session history could be implemented in a tree-like manner, with each page having
  multiple "forward" pages. This specification doesn't define how the linear list of pages in the
  <code data-x="dom-history">history</code> object are derived from the actual session history as
  seen from the user's perspective.</p>

  <p>Similarly, a page containing two <code>iframe</code>s has a <code
  data-x="dom-history">history</code> object distinct from the <code>iframe</code>s' <code
  data-x="dom-history">history</code> objects, despite the fact that typical Web browsers present the
  user with just one "Back" button, with a session history that interleaves the navigation of the
  two inner frames and the outer page.</p>

<!--ADD-TOPIC:Security-->
  <p><strong>Security</strong>: It is suggested that to avoid letting a page "hijack" the history
  navigation facilities of a UA by abusing <code data-x="dom-history-pushState">pushState()</code>,
  the UA provide the user with a way to jump back to the previous page (rather than just going back
  to the previous state). For example, the back button could have a drop down showing just the pages
  in the session history, and not showing any of the states. Similarly, an aural browser could have
  two "back" commands, one that goes back to the previous state, and one that jumps straight back to
  the previous page.</p>

  <p>In addition, a user agent could ignore calls to <code
  data-x="dom-history-pushState">pushState()</code> that are invoked on a timer, or from event
  listeners that are not triggered in response to a clear user action, or that are invoked in rapid
  succession.</p>
<!--REMOVE-TOPIC:Security-->

  </div>


<!--TOPIC:HTML-->
  <h3 id="browsing-the-web">Browsing the Web</h3>

  <div class="impl">

  <h4 id="navigating-across-documents">Navigating across documents</h4>

  <p>Certain actions cause the <span>browsing context</span> to <i data-x="navigate">navigate</i> to
  a new resource. A user agent may provide various ways for the user to explicitly cause a browsing
  context to navigate, in addition to those defined in this specification.</p>

  <p class="example">For example, <span data-x="following hyperlinks">following a hyperlink</span>,
  <span data-x="concept-form-submit">form submission</span>, and the <code
  data-x="dom-open">window.open()</code> and <code
  data-x="dom-location-assign">location.assign()</code> methods can all cause a browsing context to
  navigate.</p>

  <p class="note">A <i>resource</i> has a URL, but that might not be the only information necessary
  to identify it. For example, a form submission that uses HTTP POST would also have the HTTP method
  and payload. Similarly, <span>an <code>iframe</code> <code
  data-x="attr-iframe-srcdoc">srcdoc</code> document</span> needs to know the data it is to use.</p>

  <p>Navigation always involves <dfn>source browsing context</dfn>, which is the browsing context which
  was responsible for starting the navigation.</p>

  <!-- NAVIGATE <dfn>navigate</dfn> -->
  <!-- For places that _call_ this, as opposed to just referring to
  it, search for "DONAV" -->
  <p>When a browsing context is <dfn data-x="navigate">navigated</dfn> to a new resource, the user
  agent must run the following steps:</p>

  <ol>

   <li><p>Release the <span>storage mutex</span>.</p></li>

   <li id="sandboxLinks">

    <p>If the <span>source browsing context</span> is not <span>allowed to navigate</span> the
    <span>browsing context</span> being navigated, then abort these steps.</p>

    <p>If these steps are aborted here, the user agent may instead offer to open the new resource in
    a new <span>top-level browsing context</span> or in the <span>top-level browsing context</span>
    of the <span>source browsing context</span>, at the user's option, in which case the user agent
    must <span>navigate</span><!--DONAV sandbox manual load--> that designated <span>top-level
    browsing context</span> to the new resource as if the user had requested it independently.</p>

    <p class="note">Doing so, however, can be dangerous, as it means that the user is overriding the
    author's explicit request to sandbox the content.</p>

    <p>If the <span>navigate</span> algorithm was invoked with <dfn>exceptions enabled</dfn>, and it
    is aborted on this step, then in addition to aborting this algorithm, the user agent must also
    throw a <code>SecurityError</code> exception.</p>

   </li>

   <li id="seamlessLinks"><p>If the <span>source browsing context</span> is the same as the
   <span>browsing context</span> being navigated, and this browsing context has its <span>seamless
   browsing context flag</span> set, and the <span>browsing context</span> being navigated was not
   chosen using an <dfn>explicit self-navigation override</dfn>, then find the nearest
   <span>ancestor browsing context</span> that does not have its <span>seamless browsing context
   flag</span> set, and continue these steps as if <em>that</em> <span>browsing context</span> was
   the one that was going to be <span data-x="navigate">navigated</span> instead.</p></li>

   <li><p>If there is a preexisting attempt to navigate the <span>browsing context</span>, and the
   <span>source browsing context</span> is the same as the <span>browsing context</span> being
   navigated, and that attempt is currently running the <span>unload a document</span> algorithm,
   and the <span>origin</span> of the <span>URL</span> of the resource being loaded in that
   navigation is not the <span>same origin</span> as the <span>origin</span> of the <span>URL</span>
   of the resource being loaded in <em>this</em> navigation, then abort these steps without
   affecting the preexisting attempt to navigate the <span>browsing context</span>.</p></li> <!--
   http://www.hixie.ch/tests/adhoc/html/navigation/unload/ -->

   <li><p>If a <span data-x="concept-task">task</span> queued by the <span>traverse the history by a
   delta</span> algorithm is running the <span>unload a document</span> algorithm for the
   <span>active document</span> of the <span>browsing context</span> being navigated, then abort
   these steps without affecting the <span>unload a document</span> algorithm or the aforementioned
   history traversal task.</p></li> <!-- this stops pages from hijacking the back/forward button -->

   <li><p>If the <span>prompt to unload a document</span> algorithm is being run for the
   <span>active document</span> of the <span>browsing context</span> being navigated, then abort
   these steps without affecting the <span>prompt to unload a document</span> algorithm.</p></li>
   <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1946 to 1955 -->

   <li>

    <p>Let <var>gone async</var> be false.</p>

    <p class="note">The <a href="#navigate-redirect-step"><i>handle redirects</i></a> step later in
    this algorithm can in certain cases jump back to the step labeled <a
    href="#navigate-fragid-step"><i>fragment identifiers</i></a>. Since, between those two steps,
    this algorithm goes from operating immediately in the context of the calling <span
    data-x="concept-task">task</span> to operating <span>in parallel</span> independent of the <span>event
    loop</span>, some of the intervening steps need to be able to handle both being run as part of a <span data-x="concept-task">task</span> and
    running <span>in parallel</span>. The <var>gone async</var> flag is thus used to make these steps
    aware of which mode they are operating in.</p>

   </li>

   <li id="navigate-fragid-step"><p><i>Fragment identifiers</i>: If this is not a
   <dfn>reload-triggered navigation</dfn>: apply the <span>URL parser</span> algorithm to the
   <span>absolute URL</span> of the new resource and the <span data-x="the document's
   address">address</span> of the <span>active document</span> of the <span>browsing context</span>
   being navigated; if all the components of the resulting <span data-x="parsed URL">parsed
   URLs</span>, ignoring any <span data-x="concept-url-fragment">fragment</span> components, are
   identical, and the new resource is to be fetched using <code>GET</code>, and the
   <span>parsed URL</span> of the new resource has a <span
   data-x="concept-url-fragment">fragment</span> component that is not null (even if it is empty),
   then <span data-x="navigate-fragid">navigate to that fragment identifier</span> and abort these
   steps.</p></li>

   <li><p>If <var>gone async</var> is false, cancel any preexisting but not yet <span
   data-x="concept-navigate-mature">mature</span> attempt to navigate the <span>browsing
   context</span>, including canceling any instances of the <span
   data-x="concept-fetch">fetch</span> algorithm started by those attempts. If one of those attempts
   has already created and <span data-x="initialize the Document object">initialized a new
   <code>Document</code> object</span>, <span data-x="abort a document">abort</span> that
   <code>Document</code> also. (Navigation attempts that have <span
   data-x="concept-navigate-mature">matured</span> already have session history entries, and are
   therefore handled during the <span>update the session history with the new page</span> algorithm,
   later.)</p></li>

   <li><p>If the new resource is to be handled using a mechanism that does not affect the browsing
   context, e.g. ignoring the navigation request altogether because the specified scheme is not one
   of the supported protocols, then abort these steps and <span data-x="hand-off to external
   software">proceed with that mechanism instead</span>.</p></li>

   <li>

    <p>If <var>gone async</var> is false, <span data-x="prompt to unload a document">prompt
    to unload</span> the <code>Document</code> object. If the user <span>refused to allow the
    document to be unloaded</span>, then abort these steps.</p>

    <p>If this instance of the <span data-x="navigate">navigation</span> algorithm gets canceled
    while this step is running, the <span>prompt to unload a document</span> algorithm must
    nonetheless be run to completion.</p>

   </li>

   <li><p>If <var>gone async</var> is false, <span data-x="abort a document">abort</span>
   the <span>active document</span> of the <span>browsing context</span>.</p></li>

   <li>

    <p>If the new resource is to be handled by displaying some sort of inline content, e.g. an error
    message because the specified scheme is not one of the supported protocols, or an inline prompt
    to allow the user to select <span data-x="dom-navigator-registerProtocolHandler">a registered
    handler</span> for the given scheme, then <span data-x="navigate-ua-inline">display the inline
    content</span> and abort these steps.</p>

    <p class="note">In the case of a registered handler being used, the algorithm will be reinvoked
    with a new URL to handle the request.</p>

   </li>

   <li>

    <p>If the <span>browsing context</span> being navigated is a <span>nested browsing
    context</span>, then put it in the <span>delaying <code data-x="event-load">load</code> events
    mode</span>.</p>

    <p>The user agent must take this <span>nested browsing context</span> out of the <span>delaying
    <code data-x="event-load">load</code> events mode</span> when this <span
    data-x="navigate">navigation</span> algorithm later <span
    data-x="concept-navigate-mature">matures</span>, or when it terminates (whether due to having
    run all the steps, or being canceled, or being aborted), whichever happens first.</p>

    <!-- this is what makes <iframe> elements, <embed> elements, <object> elements, etc, delay the
    load event of their parent browsing context when their child browsing context is in between this
    step and the step that starts the parser. -->

   </li>

   <li>

    <p>This is the step that attempts to obtain the resource, if necessary. Jump to the first
    appropriate substep:</p>

    <dl>

     <dt>If the resource has already been obtained (e.g. because it is being used to populate an
     <code>object</code> element's new <span>child browsing context</span>)</dt>

     <dd><p>Skip this step. The data is already available.</p></dd>

     <dt>If the new resource is a <span>URL</span> whose <span
     data-x="concept-url-scheme">scheme</span> is <code data-x="javascript
     protocol">javascript</code></dt>

     <dd>

      <!-- http://www.hixie.ch/tests/adhoc/html/navigation/javascript-url/ -->

      <p><span>Queue a task</span> to run <dfn data-x="javascript protocol">these
      "<code>javascript:</code> URL" steps</dfn>, associated with the <span>active document</span>
      of the <span>browsing context</span> being navigated:</p>

      <ol id="concept-js-deref">

       <li><p>If the <span>origin</span> of the <span>source browsing context</span> is not the
       <span>same origin</span> as the <span>origin</span> of the <span>active document</span> of
       the <span>browsing context</span> being navigated, then act as if the result of evaluating
       the script was the void value, and jump to the step labeled <i>process results</i>
       below.</p></li>

       <li><p>Apply the <span>URL parser</span> to the <span>URL</span> being navigated.</p></li>

       <li><p>Let <var>parsed URL</var> be the result of the <span>URL
       parser</span>.</p></li>

       <li><p>Let <var>script source</var> be the empty string.</p></li>

       <li><p>Append <var>parsed URL</var>'s <span data-x="concept-url-scheme-data">scheme
       data</span> component to <var>script source</var>.</p></li>

       <li><p>If <var>parsed URL</var>'s <span data-x="concept-url-query">query</span>
       component is not null, then first append a U+003F QUESTION MARK character (?) to <var>script source</var>, and then append <var>parsed URL</var>'s <span
       data-x="concept-url-query">query</span> component to <var>script
       source</var>.</p></li>

       <li><p>If <var>parsed URL</var>'s <span
       data-x="concept-url-fragment">fragment</span> component is not null, then first append a
       U+0023 NUMBER SIGN character (#) to <var>script source</var>, and then append <var>parsed URL</var>'s <span data-x="concept-url-fragment">fragment</span> component to
       <var>script source</var>.</p></li>

       <li><p>Replace <var>script source</var> with the result of applying the
       <span>percent decode</span> algorithm to <var>script source</var>.</p></li>

       <li><p>Replace <var>script source</var> with the result of applying the <span>UTF-8
       decode</span> algorithm to <var>script source</var>.</p></li>

       <!-- <body onload="&#xFFFE;w('test')"> and javascript:%EF%BB%BF'test' both work, so we assume
            that JavaScript is stripping the BOM, and we don't have to -->

       <!--
         http://software.hixie.ch/utilities/js/live-dom-viewer/saved/2639 -> about:blank
         http://software.hixie.ch/utilities/js/live-dom-viewer/saved/2640 -> javascript:'test' in Firefox, about:blank otherwise
       -->
       <li><p>Let <var>address</var> be the <span data-x="the document's
       address">address</span> of the <span>active document</span> of the <span>browsing
       context</span> being navigated.</p></li>

       <li>

        <p><span>Create a script</span>, using <var>script source</var> as the script
        source, <var>address</var> as the script source URL, JavaScript as the scripting
        language, and the <span>environment settings object</span> of the <code>Window</code> object of
        the <span>active document</span> of the <span>browsing context</span> being navigated.</p>

        <p>Let <var>result</var> be the return value of the <span>code entry-point</span>
        of this <span data-x="concept-script">script</span>. If an exception was thrown, let <var>result</var> be void instead. (The result will be void also if <span
        data-x="concept-bc-noscript">scripting is disabled</span>.)</p>

       </li>

       <li>

        <p><i>Process results</i>: If the result of executing the script is void (there is no return
        value), then the result of obtaining the resource for the URL is a <span
        data-x="concept-response">response</span> whose
        <span data-x="concept-response-status">status</span> is <code>204</code>.</p>

        <p>Otherwise, the result of obtaining the resource for the URL is a <span
        data-x="concept-response">response</span> whose <span
        data-x="concept-response-header-list">header list</span> consists of <code
       >Content-Type</code>/<code>text/html</code> and whose <span
        data-x="concept-response-body">body</span> is the return value converted to a string
        value.</p>

        <p>When it comes time to <span>set the document's address</span> in the <span
        data-x="navigate">navigation algorithm</span>, use <var>address</var> as the
        <span>override URL</span>.</p>

       </li>

      </ol>

      <p>The <span>task source</span> for this <span data-x="concept-task">task</span> is the
      <span>DOM manipulation task source</span>.</p>

      <div class="example">

       <p>So for example a <span data-x="javascript protocol"><code>javascript:</code> URL</span> in
       an <code data-x="attr-hyperlink-href">href</code> attribute of an <code>a</code> element
       would only be evaluated when the link was <span data-x="following
       hyperlinks">followed</span>, while such a URL in the <code
       data-x="attr-iframe-src">src</code> attribute of an <code>iframe</code> element would be
       evaluated in the context of the <code>iframe</code>'s own <span>nested browsing
       context</span> when the <code>iframe</code> is being set up; once evaluated, its return value
       (if it was not void) would replace that <span>browsing context</span>'s <code>Document</code>, thus also
       changing the <code>Window</code> object of that <span>browsing context</span>.</p>

      </div>

     </dd>

     <dt>If the new resource is to be fetched using <code>GET</code>, and there are
     <span data-x="relevant application cache">relevant application caches</span> that are
     identified by a URL with the <span>same origin</span> as the URL in question, and that have
     this URL as one of their entries, excluding entries marked as <span
     data-x="concept-appcache-foreign">foreign</span>, and whose <span
     data-x="concept-appcache-mode">mode</span> is <span
     data-x="concept-appcache-mode-fast">fast</span>, and the user agent is not in a mode where it
     will avoid using <span data-x="application cache">application caches</span></dt>

     <dd>

      <p>Fetch the resource from the <span data-x="concept-appcache-selection">most appropriate
      application cache</span> of those that match.</p>

      <p class="example">For example, imagine an HTML page with an associated application cache
      displaying an image and a form, where the image is also used by several other application
      caches. If the user right-clicks on the image and chooses "View Image", then the user agent
      could decide to show the image from any of those caches, but it is likely that the most useful
      cache for the user would be the one that was used for the aforementioned HTML page. On the
      other hand, if the user submits the form, and the form does a POST submission, then the user
      agent will not use an application cache at all; the submission will be made to the
      network.</p>

      <p class="&#x0058;&#x0058;&#x0058;">This still needs to be integrated with the Fetch
      standard. <a href="#refsFETCH">\[FETCH]</a></p>

     </dd>

     <dt>Otherwise</dt>

     <dd>

      <ol>
       <li><p>Let <var>request</var> be the new resource.</p></li>

       <li><p>If <var>request</var> is a URL, set <var>request</var> to a new <span
       data-x="concept-request">request</span> whose <span data-x="concept-request-url">url</span>
       is <var>request</var>.</p></li>

       <li><p>Set <var>request</var>'s <span data-x="concept-request-client">client</span> to the
       <span>source browsing context</span>'s <span>active document</span>'s <code>Window</code>
       object's <span>environment settings object</span>, <span
       data-x="concept-request-target-browsing-context">target browsing context</span> to the
       <span>browsing context</span> being navigated, <span
       data-x="concept-request-destination">destination</span> to "<code>document</code>",
       <span data-x="concept-request-mode">mode</span> to "<code>navigate</code>", <span
       data-x="concept-request-credentials-mode">credentials mode</span> to "<code
      >include</code>", <span>use-URL-credentials flag</span>, and <span
       data-x="concept-request-redirect-mode">redirect mode</span> to "<code
      >manual</code>".</p></li>

       <li><p>Set <var>request</var>'s <span>omit-<code>Origin</code>-header flag</span>.

       <li><p>If <var>request</var>'s <span data-x="concept-request-method">method</span> is not
       <code>GET</code>, or, if the <span data-x="navigate">navigation algorithm</span>
       was invoked as a result of the <span data-x="concept-form-submit">form submission
       algorithm</span>, then if there is an <span>origin</span> of the <span>active document</span>
       of the <span>source browsing context</span>, unset <var>request</var>'s
       <span>omit-<code>Origin</code>-header flag</span>.</p></li>

       <li><p>Otherwise, if the <span>browsing context</span> being navigated is a <span>child
       browsing context</span>, and the <span>browsing context container</span> of the
       <span>browsing context</span> being navigated has a <span>browsing context scope
       origin</span>, set <var>request</var>'s <span data-x="concept-request-origin">origin</span>
       to that <span>browsing context scope origin</span> and unset <var>request</var>'s
       <span>omit-<code>Origin</code>-header flag</span>.</p></li>

       <!--FETCH--><li><p><span data-x="concept-fetch">Fetch</span> <var>request</var>.</p></li>
      </ol>

     </dd>

    </dl>

   </li>

   <li>

    <!-- *********************************** ASYNC BOUNDARY *********************************** -->

    <p>If <var>gone async</var> is false, return to whatever algorithm invoked the
    navigation steps and continue running these steps <span>in parallel</span>.</p>

   </li>

   <li><p>Let <var>gone async</var> be true.</p></li>

   <li><p>Wait for one or more bytes to be available or for the user agent to establish that the
   resource in question is empty. During this time, the user agent may allow the user to cancel this
   navigation attempt or start other navigation attempts.</p></li>

   <li id="navigate-redirect-step">

    <p><i>Handle redirects</i>: If fetching the resource results in a redirect, and either the
    <span>URL</span> of the target of the redirect has the <span>same origin</span> as the original
    resource, or the resource is being obtained using the POST method or a safe method (in HTTP
    terms), return to <a href="#navigate-fragid-step">the step labeled <i>fragment
    identifiers</i></a> with the new resource, except that if the <span>URL</span> of the target of
    the redirect does not have a fragment identifier and the <span>URL</span> of the resource that
    led to the redirect does, then the fragment identifier of the resource that led to the redirect
    must be propagated to the <span>URL</span> of the target of the redirect.</p>

    <p class="example">So for instance, if the original URL was "<code
   >http://example.com/#!sample</code>" and "<code>http://example.com/</code>" is
    found to redirect to "<code>https://example.com/</code>", the URL of the new resource
    will be "<code>https://example.com/#!sample</code>".</p>

    <p>Otherwise, if fetching the resource results in a redirect but the <span>URL</span> of the
    target of the redirect does not have the <span>same origin</span> as the original resource and
    the resource is being obtained using a method that is neither the POST method nor a safe method
    (in HTTP terms), then abort these steps. The user agent may indicate to the user that the
    navigation has been aborted for security reasons.</p>

   </li>

   <li>

    <p><strong>Fallback in prefer-online mode</strong>: If the resource was not fetched from an
    <span>application cache</span>, and was to be fetched using <code>GET</code>, and
    there are <span data-x="relevant application cache">relevant application caches</span> that are
    identified by a URL with the <span>same origin</span> as the URL in question, and that have this
    URL as one of their entries, excluding entries marked as <span
    data-x="concept-appcache-foreign">foreign</span>, and whose <span
    data-x="concept-appcache-mode">mode</span> is <span
    data-x="concept-appcache-mode-prefer-online">prefer-online</span>, and the user didn't cancel the
    navigation attempt during the earlier step, and the navigation attempt failed (e.g. the server
    returned a 4xx or 5xx status, or there was a DNS error), then:</p>

    <p>Let <var>candidate</var> be the resource identified by the URL in question from the
    <span data-x="concept-appcache-selection">most appropriate application cache</span> of those that
    match.</p> <!-- note that a redirect can never reach this point as it is handled earlier,
    meaning that a captive portal captures URLs in "prefer-online" caches and you can't ever get to
    the cached resource of a prefer-online cache if you have a captive portal -->

    <p>If <var>candidate</var> is not marked as <span
    data-x="concept-appcache-foreign">foreign</span>, then the user agent must discard the failed
    load and instead continue along these steps using <var>candidate</var> as the resource.
    The user agent may indicate to the user that the original page load failed, and that the page
    used was a previously cached resource.</p>

    <p class="note">This does not affect the <i>address of the resource from which Request-URIs are
    obtained</i>, as used to set <span>the document's referrer</span> in the <span>initialize the
    <code>Document</code> object</span> steps below; they still use the value as computed by the
    original fetch algorithm.</p>

   </li>

   <li>

    <p><strong>Fallback for fallback entries</strong>: If the resource was not fetched from an
    <span>application cache</span>, and was to be fetched using <code>GET</code>, and
    its URL <span data-x="concept-appcache-matches-fallback">matches the fallback namespace</span>
    of one or more <span data-x="relevant application cache">relevant application caches</span>, and
    the <span data-x="concept-appcache-selection">most appropriate application cache</span> of those
    that match does not have an entry in its <span data-x="concept-appcache-onlinesafelist">online
    safelist</span> that has the <span>same origin</span> as the resource's URL and that is a
    <span>prefix match</span> for the resource's URL, and the user didn't cancel the navigation
    attempt during the earlier step, and the navigation attempt failed (e.g. the server returned a
    4xx or 5xx status, or there was a DNS error), then:</p> <!-- note that a redirect can never
    reach this point as it is handled earlier, meaning that a captive portal captures URLs in
    fallback namespaces and you can't ever get to the fallback file of a resource if you have a
    captive portal -->

    <p>Let <var>candidate</var> be the <span data-x="concept-appcache-fallback">fallback
    resource</span> specified for the <span data-x="concept-appcache-fallback-ns">fallback
    namespace</span> in question. If multiple application caches match, the user agent must use the
    fallback of the <span data-x="concept-appcache-selection">most appropriate application
    cache</span> of those that match.</p>

    <p>If <var>candidate</var> is not marked as <span
    data-x="concept-appcache-foreign">foreign</span>, then the user agent must discard the failed
    load and instead continue along these steps using <var>candidate</var> as the resource.
    <span>The document's address</span>, if appropriate, will still be the originally requested URL,
    not the fallback URL, but the user agent may indicate to the user that the original page load
    failed, that the page used was a fallback resource, and what the URL of the fallback resource
    actually is.</p>

    <p class="note">This does not affect the <i>address of the resource from which Request-URIs are
    obtained</i>, as used to set <span>the document's referrer</span> in the <span>initialize the
    <code>Document</code> object</span> steps below; they still use the value as computed by the
    original fetch algorithm.</p>

   </li>

   <li>

    <p><i>Resource handling</i>: If the resource's out-of-band metadata (e.g. HTTP headers), not
    counting any <span data-x="Content-Type">type information</span> (such as the Content-Type HTTP
    header), requires some sort of processing that will not affect the browsing context, then
    perform that processing and abort these steps.</p>

    <div class="note">
     <p>Such processing might be triggered by, amongst other things, the following:</p>
     <ul class="brief">
      <li>HTTP status codes (e.g. 204 No Content or 205 Reset Content)</li>
      <li>Network errors (e.g. the network interface being unavailable)</li>
      <li>Cryptographic protocol failures (e.g. an incorrect TLS certificate)</li>
      <!-- Other schemes are handled earlier -->
      <!-- Content-Disposition is handled below -->
      <!-- Content-Type is handled in subsequent steps -->
      <!-- ...and I can't think of any others. -->
     </ul>
    </div>

    <p>Responses with HTTP <code data-x="http-content-disposition">Content-Disposition</code>
    headers specifying the <code>attachment</code> disposition type must be handled
    <span>as a download</span>.</p>

    <!-- theoretically, HTTP 205 processing would occur here, resetting all forms with no other
    effect. However, it seems nobody actually wants to use this ability, so requiring it here seems
    like unnecessary work. -->

    <p>HTTP 401 responses that do not include a challenge recognized by the user agent must be
    processed as if they had no challenge, e.g. rendering the entity body as if the response had
    been 200 OK.</p>

    <p>User agents may show the entity body of an HTTP 401 response even when the response does
    include a recognized challenge, with the option to login being included in a non-modal fashion,
    to enable the information provided by the server to be used by the user before authenticating.
    Similarly, user agents should allow the user to authenticate (in a non-modal fashion) against
    authentication challenges included in other responses such as HTTP 200 OK responses, effectively
    allowing resources to present HTTP login forms without requiring their use.</p>

   </li>

   <li><p>Let <var>type</var> be <span data-x="Content-Type sniffing">the sniffed type of
   the resource</span>.</p></li>

   <li><p>If the user agent has been configured to process resources of the given <var>type</var> using some mechanism other than rendering the content in a <span>browsing
   context</span>, then skip this step. Otherwise, if the <var>type</var> is one of the
   following types, jump to the appropriate entry in the following list, and process the resource as
   described there:</p>

    <dl class="switch">

     <dt>an <span>HTML MIME type</span></dt>
     <dd>Follow the steps given in the <span data-x="navigate-html">HTML document</span> section,
     and then, once they have completed, abort this <span>navigate</span> algorithm.</dd>

     <dt>an <span>XML MIME type</span> that is not an <span>explicitly supported XML
     type</span></dt>

     <dd>Follow the steps given in the <span data-x="navigate-xml">XML document</span> section. If
     that section determines that the content is <em>not</em> to be displayed as a generic XML
     document, then proceed to the next step in this overall set of steps. Otherwise, once the steps
     given in the <span data-x="navigate-xml">XML document</span> section have completed, abort this
     <span>navigate</span> algorithm.</dd>

     <dt>a <span>JavaScript MIME type</span></dt>
     <dt>a <span>JSON MIME type</span> that is not an <span>explicitly supported JSON
     type</span></dt>
     <dt>"<code>text/cache-manifest</code>"</dt>
     <dt>"<code>text/css</code>"</dt>
     <dt>"<code>text/plain</code>"</dt>
     <dt>"<code>text/vtt</code>"</dt>
     <dd>Follow the steps given in the <span data-x="navigate-text">plain text file</span> section,
     and then, once they have completed, abort this <span>navigate</span> algorithm.</dd>

     <dt>"<code>multipart/x-mixed-replace</code>"</dt>
     <dd>Follow the steps given in the <span
     data-x="navigate-multipart-x-mixed-replace">multipart/x-mixed-replace</span> section, and then,
     once they have completed, abort this <span>navigate</span> algorithm.</dd>

     <dt>A supported image, video, or audio type</dt>
     <dd>Follow the steps given in the <span data-x="navigate-media">media</span> section, and then,
     once they have completed, abort this <span>navigate</span> algorithm.</dd>

     <dt>A type that will use an external application to render the content in the <span>browsing
     context</span></dt>
     <dd>Follow the steps given in the <span data-x="navigate-plugin">plugin</span> section, and then,
     once they have completed, abort this <span>navigate</span> algorithm.</dd>

    </dl>

    <p>An <dfn>explicitly supported XML type</dfn> is one for which the user agent is configured to
    use an external application to render the content (either a <span>plugin</span> rendering
    directly in the <span>browsing context</span>, or a separate application), or one for which the
    user agent has dedicated processing rules (e.g. a Web browser with a built-in Atom feed viewer
    would be said to explicitly support the <code>application/atom+xml</code> MIME type), or one for
    which the user agent has a dedicated handler (e.g. one registered using <code
    data-x="dom-navigator-registerContentHandler">registerContentHandler()</code>).</p>

    <p>The term <dfn>JSON MIME type</dfn> is used to refer to the <span data-x="MIME type">MIME
    types</span> <code>application/json</code>, <code>text/json</code>, and any <span>MIME
    type</span> whose subtype ends with the five characters "<code>+json</code>".

    <p>An <dfn>explicitly supported JSON type</dfn> is one for which the user agent is configured to
    use an external application to render the content (either a <span>plugin</span> rendering
    directly in the <span>browsing context</span>, or a separate application), or one for which the
    user agent has dedicated processing rules, or one for which the user agent has a dedicated
    handler (e.g. one registered using <code
    data-x="dom-navigator-registerContentHandler">registerContentHandler()</code>).</p>

    <p><dfn data-x="set the document's address">Setting the document's address</dfn>: If there is no
    <dfn>override URL</dfn>, then any <code>Document</code> created by these steps must have its
    <span data-x="the document's address">address</span> set to the <span>URL</span> that was
    originally to be fetched, ignoring any other data that was used to obtain the resource. However,
    if there <em>is</em> an <span>override URL</span>, then any <code>Document</code> created by
    these steps must have its <span data-x="the document's address">address</span> set to that
    <span>URL</span> instead.</p>

    <p class="note">An <span data-x="override URL">override URL</span> is set when <span
    data-x="javascript protocol">dereferencing a <code>javascript:</code> URL</span> and when
    performing <span>an overridden reload</span>.</p>

    <p><dfn data-x="initialize the Document object">Initializing a new <code>Document</code>
    object</dfn>: when a <code>Document</code> is created as part of the above steps, the user agent
    will be required to additionally run the following algorithm after creating the new object:</p>

    <ol>

     <li><p>Create a new <code>Window</code> object, and associate it with the
     <code>Document</code>, with one exception: if the <span>browsing context</span>'s only entry in
     its <span>session history</span> is the <code>about:blank</code> <code>Document</code> that was
     added when the <span>browsing context</span> was created, and navigation is occurring with
     <span>replacement enabled</span>, and that <code>Document</code> has the <span>same
     origin</span> as the new <code>Document</code>, then use the <code>Window</code> object of that
     <code>Document</code> instead, and change the <code data-x="dom-document">document</code>
     attribute of the <code>Window</code> object to point to the new <code>Document</code>.</p>

     <li><p>Set the <code>Window</code> object's <span data-x="concept-window-https-state">HTTPS
     state</span> to the <span data-x="concept-response-https-state">HTTPS state</span> of the
     resource used to generate the document.</p></li>

     <li><p>Set <span>the document's referrer</span> to the <i>address of the resource from which
     Request-URIs are obtained</i> as determined when the fetch algorithm obtained the resource, if
     that algorithm was used and determined such a value; otherwise, set it to the empty
     string.</p></li>

     <li><p><span>Implement the sandboxing</span> for the <code>Document</code>.</p></li>

     <li id="fullscreen-logic">

      <p>If the <span>active sandboxing flag set</span> of the <code>Document</code>'s
      <span>browsing context</span> or any of its <span data-x="ancestor browsing context">ancestor
      browsing contexts</span> (if any) have the <span>sandboxed fullscreen browsing context
      flag</span> set, then skip this step.</p>

      <p>If the <code>Document</code>'s <span>browsing context</span> has a <span>browsing context
      container</span> and either it is not an <code>iframe</code> element, or it does not have the
      <code data-x="attr-iframe-allowfullscreen">allowfullscreen</code> attribute specified, or its
      <code>Document</code> does not have the <span>fullscreen enabled flag</span> set, then also
      skip this step.</p>

      <p>Otherwise, set the <code>Document</code>'s <span>fullscreen enabled flag</span>.</p>

    </ol>

   </li>

   <li id="navigate-non-Document">

    <p><i>Non-document content</i>: If, given <var>type</var>, the new resource is to be
    handled by displaying some sort of inline content, e.g. a native rendering of the content, an
    error message because the specified type is not supported, or an inline prompt to allow the user
    to select <span data-x="dom-navigator-registerContentHandler">a registered handler</span> for
    the given type, then <span data-x="navigate-ua-inline">display the inline content</span>, and
    then abort these steps.</p>

    <p class="note">In the case of a registered handler being used, the algorithm will be reinvoked
    with a new URL to handle the request.</p>

   </li>

   <li><p>Otherwise, the document's <var>type</var> is such that the resource will not
   affect the browsing context, e.g. because the resource is to be handed to an external application
   or because it is an unknown type that will be processed <span>as a download</span>. <span
   data-x="hand-off to external software">Process the resource appropriately</span>.</p>

  </ol>

  <p>When a resource is handled by <dfn data-x="hand-off to external software">passing its URL or
  data to an external software package</dfn> separate from the user agent (e.g. handing a <code
  data-x="mailto protocol">mailto:</code> URL to a mail client, or a Word document to a word
  processor), user agents should attempt to mitigate the risk that this is an attempt to exploit the
  target software, e.g. by prompting the user to confirm that the <span>source browsing
  context</span>'s <span>active document</span>'s <span>origin</span> is to be allowed to invoke the
  specified software. In particular, if the <span>navigate</span> algorithm, when it was invoked,
  was not <span>allowed to show a popup</span>, the user agent should not invoke the external
  software package without prior user confirmation.</p>

  <p class="example">For example, there could be a vulnerability in the target software's URL
  handler which a hostile page would attempt to exploit by tricking a user into clicking a link.</p>

  <hr>

  <p>Some of the sections below, to which the above algorithm defers in certain cases, require the
  user agent to <dfn>update the session history with the new page</dfn>. When a user agent is
  required to do this, it must <span>queue a task</span> (associated with the <code>Document</code>
  object of the <span>current entry</span>, not the new one) to run the following steps:</p>

  <ol>

   <li>

    <p><span data-x="unload a document">Unload</span> the <code>Document</code> object of the
    <span>current entry</span>, with the <var>recycle</var> parameter set to false.</p>

    <p>If this instance of the <span data-x="navigate">navigation</span> algorithm is canceled while
    this step is running the <span>unload a document</span> algorithm, then the <span>unload a
    document</span> algorithm must be allowed to run to completion, but this instance of the <span
    data-x="navigate">navigation</span> algorithm must not run beyond this step. (In particular, for
    instance, the cancelation of this algorithm does not abort any event dispatch or script
    execution occurring as part of unloading the document or its descendants.)</p>

   </li>

   <li>

    <dl>

     <dt>If the navigation was initiated for <dfn>entry update</dfn> of an entry</dt>

     <dd>

      <ol>

       <li><p>Replace the <code>Document</code> of the entry being updated, and any other entries
       that referenced the same document as that entry, with the new <code>Document</code>.</p></li>

       <li><p><span>Traverse the history</span> to the new entry.</p></li>

      </ol>

      <p class="note">This can only happen if the entry being updated is not the <span>current
      entry</span>, and can never happen with <span>replacement enabled</span>. (It happens when the
      user tried to traverse to a session history entry that no longer had a <code>Document</code>
      object.)</p>

     </dd>


     <dt>Otherwise</dt>

     <dd>

      <ol>

       <li>

        <p>Remove all the entries in the <span>browsing context</span>'s <span>session
        history</span> after the <span>current entry</span>. If the <span>current entry</span> is
        the last entry in the session history, then no entries are removed.</p>

        <p class="note">This <a href="#history-notes">doesn't necessarily have to affect</a> the
        user agent's user interface.</p>

       </li>

       <li><p>Append a new entry at the end of the <code>History</code> object representing the new
       resource and its <code>Document</code> object and related state.</p></li>

       <li><p><span>Traverse the history</span> to the new entry. If the navigation was initiated
       with <span>replacement enabled</span>, then the traversal must itself be initiated with
       <span>replacement enabled</span>.</p>

       </li>

      </ol>

     </dd>

    </dl>

   </li>

   <li><p>The <span data-x="navigate">navigation algorithm</span> has now <dfn
   data-x="concept-navigate-mature">matured</dfn>.</p></li>

   <li><p><i>Fragment identifier loop</i>: <span>Spin the event loop</span> for a user-agent-defined
   amount of time, as desired by the user agent implementor. (This is intended to allow the user
   agent to optimize the user experience in the face of performance concerns.)</p></li>

   <li><p>If the <code>Document</code> object has no parser, or its parser has <span data-x="stop
   parsing">stopped parsing</span>, or the user agent has reason to believe the user is no longer
   interested in scrolling to the fragment identifier, then abort these steps.</p></li>

   <li><p><span>Scroll to the fragment identifier</span> given in <span>the document's
   address</span>. If this fails to find <span data-x="the indicated part of the document">an
   indicated part of the document</span>, then return to the <i>fragment identifier loop</i>
   step.</p></li>

  </ol>

  <p>The <span>task source</span> for this <span data-x="concept-task">task</span> is the
  <span>networking task source</span>.</p>


  <h4 id="read-html"><dfn data-x="navigate-html">Page load processing model for HTML files</dfn></h4>

  <p>When an HTML document is to be loaded in a <span>browsing context</span>, the user agent must
  <span>queue a task</span> to create a <code>Document</code> object, mark it as being an <span
  data-x="HTML documents">HTML document</span>, set its <span
  data-x="concept-document-content-type">content type</span> to "<code>text/html</code>",
  <span>initialize the <code>Document</code> object</span>, and finally create an <span>HTML
  parser</span> and associate it with the <code>Document</code>. Each <span
  data-x="concept-task">task</span> that the <span>networking task source</span> places on the
  <span>task queue</span> while fetching runs must then fill the parser's <span>input byte
  stream</span> with the fetched bytes and cause the <span>HTML parser</span> to perform the
  appropriate processing of the input stream.</p>

  <p class="note">The <span>input byte stream</span> converts bytes into characters for use in the
  <span data-x="tokenization">tokenizer</span>. This process relies, in part, on character encoding
  information found in the real <span data-x="Content-Type">Content-Type metadata</span> of the
  resource; the "sniffed type" is not used for this purpose.</p>

  <!-- next two paragraphs are nearly identical to the navigate-text section, keep them in sync -->

  <p>When no more bytes are available, the user agent must <span>queue a task</span> for the parser
  to process the implied EOF character, which eventually causes a <code
  data-x="event-load">load</code> event to be fired.</p>

  <p>After creating the <code>Document</code> object, but before any script execution, certainly
  before the parser <span data-x="stop parsing">stops</span>, the user agent must <span>update the
  session history with the new page</span>.</p>

  <p class="note"><span data-x="concept-appcache-init">Application cache selection</span> happens <a
  href="#parser-appcache">in the HTML parser</a>.</p>

  <p>The <span>task source</span> for the two tasks mentioned in this section must be the
  <span>networking task source</span>.</p>



  <h4 id="read-xml"><dfn data-x="navigate-xml">Page load processing model for XML files</dfn></h4>

  <p>When faced with displaying an XML file inline, user agents must follow the requirements defined
  in the XML and Namespaces in XML recommendations, RFC 7303, DOM, and other relevant specifications
  to create a <code>Document</code> object and a corresponding <span>XML parser</span>. <a
  href="#refsXML">\[XML]</a> <a href="#refsXMLNS">\[XMLNS]</a> <a href="#refsRFC7303">\[RFC7303]</a> <a
  href="#refsDOM">\[DOM]</a></p>

  <p class="note">At the time of writing, the XML specification community had not actually yet
  specified how XML and the DOM interact.</p> <!--XMLPARSE-->

  <p>After the <code>Document</code> is created, the user agent must <span>initialize the
  <code>Document</code> object</span>.</p>

  <p>The actual HTTP headers and other metadata, not the headers as mutated or implied by the
  algorithms given in this specification, are the ones that must be used when determining the
  character encoding according to the rules given in the above specifications. Once the character
  encoding is established, the <span>document's character encoding</span> must be set to that
  character encoding.</p>

  <p>If the root element, as parsed according to the XML specifications cited above, is found to be
  an <code>html</code> element with an attribute <code data-x="attr-html-manifest">manifest</code>
  whose value is not the empty string, then, as soon as the element is <span data-x="insert an
  element into a document">inserted into the document</span>, the user agent must <span
  data-x="resolve a url">resolve</span> the value of that attribute relative to that element, and if
  that is successful, must apply the <span data-x="concept-url-serializer">URL serializer</span>
  algorithm to the resulting <span>parsed URL</span> with the <i>exclude fragment flag</i> set to
  obtain <var>manifest URL</var>, and then run the <span data-x="concept-appcache-init">application
  cache selection algorithm</span> with <var>manifest URL</var> as the manifest URL, passing in the
  newly-created <code>Document</code>. Otherwise, if the attribute is absent, its value is the empty
  string, or resolving its value fails, then as soon as the root element is <span data-x="insert an
  element into a document">inserted into the document</span>, the user agent must run the <span
  data-x="concept-appcache-init">application cache selection algorithm</span> with no manifest, and
  passing in the <code>Document</code>.</p>

  <p class="note">Because the processing of the <code data-x="attr-html-manifest">manifest</code>
  attribute happens only once the root element is parsed, any URLs referenced by processing
  instructions before the root element (such as <code>&lt;?xml-stylesheet?></code> PIs)
  will be fetched from the network and cannot be cached.</p><!-- v2: fix this somehow -->

  <p>User agents may examine the namespace of the root <code>Element</code> node of this
  <code>Document</code> object to perform namespace-based dispatch to alternative processing tools,
  e.g. determining that the content is actually a syndication feed and passing it to a feed handler.
  If such processing is to take place, abort the steps in this section, and jump to <a
  href="#navigate-non-Document">the next step</a> (labeled <i>non-document content</i>) in the
  <span>navigate</span> steps above.</p>

  <p>Otherwise, then, with the newly created <code>Document</code>, the user agent must <span>update
  the session history with the new page</span>. User agents may do this before the complete document
  has been parsed (thus achieving <i>incremental rendering</i>), and must do this before any scripts
  are to be executed.</p>

  <p>Error messages from the parse process (e.g. XML namespace well-formedness errors) may be
  reported inline by mutating the <code>Document</code>.</p>


  <h4 id="read-text"><dfn data-x="navigate-text">Page load processing model for text files</dfn></h4>

  <p>When a plain text document is to be loaded in a <span>browsing context</span>, the user agent
  must <span>queue a task</span> to create a <code>Document</code> object, mark it as being an <span
  data-x="HTML documents">HTML document</span>, set its <span
  data-x="concept-document-content-type">content type</span> to the sniffed MIME type of the
  resource (<var>type</var> in the <span>navigate</span> algorithm), <span>initialize the
  <code>Document</code> object</span>, create an <span>HTML parser</span>, associate it with the
  <code>Document</code>, act as if the tokenizer had emitted a start tag token with the tag name
  "pre" followed by a single U+000A LINE FEED (LF) character<!-- to get eaten, so that a leading LF
  in the text/plain stream doesn't get eaten itself-->, and switch the <span>HTML parser</span>'s
  tokenizer to the <span>PLAINTEXT state</span>. Each <span data-x="concept-task">task</span> that
  the <span>networking task source</span> places on the <span>task queue</span> while fetching runs
  must then fill the parser's <span>input byte stream</span> with the fetched bytes and cause the
  <span>HTML parser</span> to perform the appropriate processing of the input stream.</p>

  <p>The rules for how to convert the bytes of the plain text document into actual characters, and
  the rules for actually rendering the text to the user, are defined by the specifications for the
  sniffed MIME type of the resource (<var>type</var> in the <span>navigate</span> algorithm).</p>

  <p>The <span>document's character encoding</span> must be set to the character encoding used to
  decode the document.</p>

  <p>Upon creation of the <code>Document</code> object, the user agent must run the <span
  data-x="concept-appcache-init">application cache selection algorithm</span> with no manifest, and
  passing in the newly-created <code>Document</code>.</p>

  <!-- next two paragraphs are nearly identical to the navigate-html section and similar to the
  "navigate-ua-inline" section, and the next three are similar to the navigate-media and
  navigate-plugin sections; keep them all in sync -->

  <p>When no more bytes are available, the user agent must <span>queue a task</span> for the parser
  to process the implied EOF character, which eventually causes a <code
  data-x="event-load">load</code> event to be fired.</p>

  <p>After creating the <code>Document</code> object, but potentially before the page has finished
  parsing, the user agent must <span>update the session history with the new page</span>.</p>

  <p>User agents may add content to the <code>head</code> element of the <code>Document</code>, e.g.
  linking to a style sheet or a binding, providing script, giving the document a
  <code>title</code>, etc.</p>

  <p class="note">In particular, if the user agent supports the <code>Format=Flowed</code>
  feature of RFC 3676 then the user agent would need to apply extra styling to cause the text to
  wrap correctly and to handle the quoting feature. This could be performed using, e.g., a
  binding or a CSS extension.</p>

  <p>The <span>task source</span> for the two tasks mentioned in this section must be the
  <span>networking task source</span>.</p>


  <h4 id="read-multipart-x-mixed-replace"><dfn data-x="navigate-multipart-x-mixed-replace">Page load processing model for <code>multipart/x-mixed-replace</code> resources</dfn></h4>

  <p>When a resource with the type <code>multipart/x-mixed-replace</code> is to be loaded in a
  <span>browsing context</span>, the user agent must parse the resource using the rules for
  multipart types. <a href="#refsRFC2046">\[RFC2046]</a></p>

  <p>For each body part obtained from the resource, the user agent must run a new instance of the
  <span>navigate</span> algorithm, starting from the <i>resource handling</i> step, using the new
  body part as the resource being navigated, with <span>replacement enabled</span> if a previous
  body part from the same resource resulted in a <code>Document</code> object being created and
  <span data-x="initialize the Document object">initialized</span>, and otherwise using the same
  setup as the <span>navigate</span> attempt that caused this section to be invoked in the first
  place.</p>

  <p>For the purposes of algorithms processing these body parts as if they were complete stand-alone
  resources, the user agent must act as if there were no more bytes for those resources whenever the
  boundary following the body part is reached.</p>

  <p class="note">Thus, <code data-x="event-load">load</code> events (and for that matter <code
  data-x="event-unload">unload</code> events) do fire for each body part loaded.</p>


  <h4 id="read-media"><dfn data-x="navigate-media">Page load processing model for media</dfn></h4>

  <p>When an image, video, or audio resource is to be loaded in a <span>browsing context</span>, the
  user agent should create a <code>Document</code> object, mark it as being an <span data-x="HTML
  documents">HTML document</span>, set its <span data-x="concept-document-content-type">content
  type</span> to the sniffed MIME type of the resource (<var>type</var> in the
  <span>navigate</span> algorithm), <span>initialize the <code>Document</code> object</span>, append
  an <code>html</code> element to the <code>Document</code>, append a <code>head</code> element and
  a <code>body</code> element to the <code>html</code> element, append an element <var>host element</var> for the media, as described below, to the <code>body</code> element,
  and set the appropriate attribute of the element <var>host element</var>, as described
  below, to the address of the image, video, or audio resource.</p>

  <p>The element <var>host element</var> to create for the media is the element given in
  the table below in the second cell of the row whose first cell describes the media. The
  appropriate attribute to set is the one given by the third cell in that same row.</p>

  <table>
   <thead>
    <tr> <th> Type of media
         <th> Element for the media
         <th> Appropriate attribute
    <tr> <td> Image
         <td> <code>img</code>
         <td> <code data-x="attr-img-src">src</code>
    <tr> <td> Video
         <td> <code>video</code>
         <td> <code data-x="attr-media-src">src</code>
    <tr> <td> Audio
         <td> <code>audio</code>
         <td> <code data-x="attr-media-src">src</code>
  </table>

  <!-- next three paragraphs are similar to the navigate-text section, keep them in sync -->

  <p>Then, the user agent must act as if it had <span data-x="stop parsing">stopped
  parsing</span>.</p>

  <p>Upon creation of the <code>Document</code> object, the user agent must run the <span
  data-x="concept-appcache-init">application cache selection algorithm</span> with no manifest, and
  passing in the newly-created <code>Document</code>.</p>

  <p>After creating the <code>Document</code> object, but potentially before the page has finished
  fully loading, the user agent must <span>update the session history with the new page</span>.</p>

  <p>User agents may add content to the <code>head</code> element of the <code>Document</code>, or
  attributes to the element <var>host element</var>, e.g. to link to a style sheet or a
  binding, to provide a script, to give the document a <code>title</code>, to make the media
  <span data-x="attr-media-autoplay">autoplay</span>, etc.</p>


  <h4 id="read-plugin"><dfn data-x="navigate-plugin">Page load processing model for content that uses plugins</dfn></h4>

  <p>When a resource that requires an external resource to be rendered is to be loaded in a
  <span>browsing context</span>, the user agent should create a <code>Document</code> object, mark
  it as being an <span data-x="HTML documents">HTML document</span> and mark it as being a
  <dfn>plugin document</dfn>, set its <span data-x="concept-document-content-type">content
  type</span> to the sniffed MIME type of the resource (<var>type</var> in the
  <span>navigate</span> algorithm), <span>initialize the <code>Document</code> object</span>, append
  an <code>html</code> element to the <code>Document</code>, append a <code>head</code> element and
  a <code>body</code> element to the <code>html</code> element, append an <code>embed</code> to the
  <code>body</code> element, and set the <code data-x="attr-embed-src">src</code> attribute of the
  <code>embed</code> element to the address of the resource.</p>

  <p class="note">The term <span>plugin document</span> is used by
  <cite>Content Security Policy</cite> as part of the mechanism that ensures <code>iframe</code>s
  can't be used to evade <code>plugin-types</code> directives. <a href="#refsCSP">\[CSP]</a></p>

  <!-- next three paragraphs are similar to the navigate-text section, keep them in sync -->

  <p>Then, the user agent must act as if it had <span data-x="stop parsing">stopped
  parsing</span>.</p>

  <p>Upon creation of the <code>Document</code> object, the user agent must run the <span
  data-x="concept-appcache-init">application cache selection algorithm</span> with no manifest, and
  passing in the newly-created <code>Document</code>.</p>

  <p>After creating the <code>Document</code> object, but potentially before the page has finished
  fully loading, the user agent must <span>update the session history with the new page</span>.</p>

  <p>User agents may add content to the <code>head</code> element of the <code>Document</code>, or
  attributes to the <code>embed</code> element, e.g. to link to a style sheet or a binding, or
  to give the document a <code>title</code>.</p>

  <p class="note" id="sandboxPluginNavigate">If the <code>Document</code>'s <span>active sandboxing
  flag set</span> has its <span>sandboxed plugins browsing context flag</span> set, the synthesized
  <code>embed</code> element will <a href="#sandboxPluginEmbed">fail to render the content</a> if
  the relevant <span>plugin</span> cannot be <span data-x="concept-plugin-secure">secured</span>.</p>


  <h4 id="read-ua-inline"><dfn data-x="navigate-ua-inline">Page load processing model for inline
  content that doesn\'t have a DOM</dfn></h4>

  <p>When the user agent is to display a user agent page inline in a <span>browsing context</span>,
  the user agent should create a <code>Document</code> object, mark it as being an <span
  data-x="HTML documents">HTML document</span>, set its <span
  data-x="concept-document-content-type">content type</span> to "<code>text/html</code>",
  <span>initialize the <code>Document</code> object</span>, and then either associate that
  <code>Document</code> with a custom rendering that is not rendered using the normal
  <code>Document</code> rendering rules, or mutate that <code>Document</code> until it represents
  the content the user agent wants to render.</p>

  <!-- next two paragraphs are similar to the navigate-text section, keep them in sync -->

  <p>Once the page has been set up, the user agent must act as if it had <span data-x="stop
  parsing">stopped parsing</span>.</p>

  <p>Upon creation of the <code>Document</code> object, the user agent must run the <span
  data-x="concept-appcache-init">application cache selection algorithm</span> with no manifest,
  passing in the newly-created <code>Document</code>.</p>

  <p>After creating the <code>Document</code> object, but potentially before the page has been
  completely set up, the user agent must <span>update the session history with the new
  page</span>.</p>



  <h4 id="scroll-to-fragid"><dfn data-x="navigate-fragid">Navigating to a fragment identifier</dfn></h4>

  <p>When a user agent is supposed to navigate to a fragment identifier, then the user agent must
  run the following steps:</p>

  <ol>

   <li>

    <p>Remove all the entries in the <span>browsing context</span>'s <span>session history</span>
    after the <span>current entry</span>. If the <span>current entry</span> is the last entry in the
    session history, then no entries are removed.</p>

    <p class="note">This <a href="#history-notes">doesn't necessarily have to affect</a> the user
    agent's user interface.</p>

   </li>

   <li><p>Remove any <span data-x="concept-task">tasks</span> queued by the <span>history traversal
   task source</span> that are associated with any <code>Document</code> objects in the
   <span>top-level browsing context</span>'s <span>document family</span>.</p></li>

   <li><p>Append a new entry at the end of the <code>History</code> object representing the new
   resource and its <code>Document</code> object and related state. Its <span>URL</span> must be set
   to the address to which the user agent was <span data-x="navigate">navigating</span>. The title
   must be left unset.</p></li>

   <li><p><span>Traverse the history</span> to the new entry, with the <i>non-blocking events</i> flag
   set. This will <span>scroll to the fragment
   identifier</span> given in what is now <span>the document's address</span>.</p></li>

  </ol>

  <p class="note">If the scrolling fails because the relevant <span data-x="concept-id">ID</span> has
  not yet been parsed, then the original <span data-x="navigate">navigation</span> algorithm will
  take care of the scrolling instead, as the last few steps of its <span>update the session history
  with the new page</span> algorithm.</p>

  <hr>

  <p>When the user agent is required to <dfn>scroll to the fragment identifier</dfn> and <span>the
  indicated part of the document</span>, if any, is <span>being rendered</span>, the user agent must
  either change the scrolling position of the document using the following algorithm, or perform
  some other action such that <span>the indicated part of the document</span> is brought to the
  user's attention. If there is no indicated part, or if the indicated part is not <span>being
  rendered</span>, then the user agent must do nothing. The aforementioned algorithm is as
  follows:</p>

  <ol>

   <li><p>Let <var>target</var> be <span>the indicated part of the
   document</span>, as defined below.</p></li>

   <li><p>If <var>target</var> is the top of the document, then <span>scroll to the
   beginning of the document</span> for the <code>Document</code>, and abort these steps. <a href="#refsCSSOMVIEW">\[CSSOMVIEW]</a></p></li>

   <li><p>Use the <span>scroll an element into view</span> algorithm to scroll <var>target</var> into view, with the <var>align to top flag</var> set. <a href="#refsCSSOMVIEW">\[CSSOMVIEW]</a></p></li>

   <li><p>Run the <span>focusing steps</span> for that element, with the <code>Document</code>'s
   viewport as the <i>fallback target</i>.</p></li>

   <li><p>Optionally, move the <span>sequential focus navigation starting point</span> to
   <var>target</var>.</p>

  </ol>

  <p><dfn>The indicated part of the document</dfn> is the one that the fragment identifier, if any,
  identifies. The semantics of the fragment identifier in terms of mapping it to a specific DOM Node
  is defined by the specification that defines the <span>MIME type</span> used by the
  <code>Document</code> (for example, the processing of fragment identifiers for <span data-x="XML
  MIME type">XML MIME types</span> is the responsibility of RFC7303). <a href="#refsRFC7303">\[RFC7303]</a></p>

  <p>For HTML documents (and <span data-x="HTML MIME type">HTML MIME types</span>), the following
  processing model must be followed to determine what <span>the indicated part of the
  document</span> is.</p>

  <ol>

   <li><p>Apply the <span>URL parser</span> algorithm to the <span>URL</span>, and let <var>fragid</var> be the <span data-x="concept-url-fragment">fragment</span> component of the
   resulting <span>parsed URL</span>.</p></li><!-- parsing can't fail, since we checked earlier on
   when navigating -->

   <li><p>If <var>fragid</var> is the empty string, then <span>the indicated part of the
   document</span> is the top of the document; stop the algorithm here.</p></li>

   <li><p>Let <var>fragid bytes</var> be the result of <span data-x="percent
   decode">percent-decoding</span> <var>fragid</var>.</p></li>

   <li><p>Let <var>decoded fragid</var> be the result of applying the <span>UTF-8
   decoder</span> algorithm to <var>fragid bytes</var>. If the <span>UTF-8 decoder</span>
   emits a <span>decoder error</span>, abort the decoder and instead jump to the step labeled <i>no
   decoded fragid</i>.</p></li>

   <li><p>If there is an element in the DOM that has an <span data-x="concept-id">ID</span> exactly
   equal to <var>decoded fragid</var>, then the first such element in <span>tree order</span> is
   <span>the indicated part of the document</span>; stop the algorithm here.</p></li>

   <li><p><i>No decoded fragid</i>: If there is an <code>a</code> element in the DOM that has a <code
   data-x="attr-a-name">name</code> attribute whose value is exactly equal to <var>fragid</var> (<em>not</em> <var>decoded fragid</var>), then the first such
   element in <span>tree order</span> is <span>the indicated part of the document</span>; stop the algorithm
   here.</p></li>

   <li><p>If <var>fragid</var> is an <span>ASCII case-insensitive</span> match for the
   string <code>top</code>, then <span>the indicated part of the document</span> is the top
   of the document; stop the algorithm here.</p></li>

   <li><p>Otherwise, there is no <span data-x="the indicated part of the document">indicated part of
   the document</span>.</p></li>

  </ol>

  <p>For the purposes of the interaction of HTML with Selectors' <dfn><code
  data-x="selector-target">:target</code></dfn> pseudo-class, the <dfn><i>target element</i></dfn>
  is <span>the indicated part of the document</span>, if that is an element; otherwise there is no
  <i data-x="target element">target element</i>. <a href="#refsSELECTORS">\[SELECTORS]</a></p>

  <p>The <span>task source</span> for the task mentioned in this section must be the <span>DOM
  manipulation task source</span>.</p>

  </div>



  <h4 id="history-traversal">History traversal</h4> <!-- session history -->

  <div class="impl">

  <p>When a user agent is required to <dfn>traverse the history</dfn> to a <var>specified
  entry</var>, optionally with <span>replacement enabled</span>, and optionally with the
  <i>non-blocking events</i> flag set, the user agent must act as follows.</p>

  <p class="note">This algorithm is not just invoked when <span data-x="traverse the history by a
  delta">explicitly going back or forwards in the session history</span> &mdash; it is also invoked
  in other situations, for example when <span data-x="navigate">navigating a browsing context</span>,
  as part of <span data-x="update the session history with the new page">updating the session history
  with the new page</span>.</p>

  <ol>

   <li>

    <p>If there is no longer a <code>Document</code> object for the entry in question,
    <span>navigate</span><!--DONAV history traversal after eviction--> the <span>browsing
    context</span> to the resource for that entry to perform an <span>entry update</span> of that
    entry, and abort these steps. The "<span>navigate</span>" algorithm reinvokes this "traverse"
    algorithm to complete the traversal, at which point there <em>is</em> a <code>Document</code>
    object and so this step gets skipped. The navigation must be done using the same <span>source
    browsing context</span> as was used the first time this entry was created. (This can never
    happen with <span>replacement enabled</span>.)</p>

    <p class="note">If the resource was obtained using a non-idempotent action, for example a POST
    form submission, or if the resource is no longer available, for example because the computer is
    now offline and the page wasn't cached, navigating to it again might not be possible. In this
    case, the navigation will result in a different page than previously; for example, it might be
    an error message explaining the problem or offering to resubmit the form.</p>

   </li>

   <li><p>If the <span>current entry</span>'s title was not set by the <code
   data-x="dom-history-pushState">pushState()</code> or <code
   data-x="dom-history-replaceState">replaceState()</code> methods, then set its title to the value
   returned by the <code data-x="dom-document-title">document.title</code> IDL attribute.</p></li>

   <li><p>If appropriate, update the <span>current entry</span> in the <span>browsing
   context</span>'s <code>Document</code> object's <code>History</code> object to reflect any state
   that the user agent wishes to persist. The entry is then said to be <span>an entry with persisted
   user state</span>.</p></li>

   <li><p>If the <var>specified entry</var> has a different <code>Document</code> object
   than the <span>current entry</span>, then run the following substeps:</p>

    <ol>

     <li><p>Remove any <span data-x="concept-task">tasks</span> queued by the <span>history traversal
     task source</span> that are associated with any <code>Document</code> objects in the
     <span>top-level browsing context</span>'s <span>document family</span>.</p></li> <!-- so the
     network is racing history.back(), in the case of setting location.href="" and then calling
     history.back() -->

     <li>

      <p>If the <span>origin</span> of the <code>Document</code> of the <var>specified
      entry</var> is not the <span data-x="same origin">same</span> as the <span>origin</span> of the
      <code>Document</code> of the <span>current entry</span>, then run the following
      sub-sub-steps:</p>

      <ol>

       <li><p>The current <span>browsing context name</span> must be stored with all the entries in
       the history that are associated with <code>Document</code> objects with the <span>same
       origin</span> as the <span>active document</span> <em>and</em> that are contiguous with the
       <span>current entry</span>.</p></li>

       <li id="resetBCName"><p>If the browsing context is a <span>top-level browsing context</span>,
       but not an <span>auxiliary browsing context</span>, then the browsing context's
       <span>browsing context name</span> must be unset.</p></li>

      </ol>

     </li>

     <li id="appcache-history-2"><p>Make the <var>specified entry</var>'s
     <code>Document</code> object the <span>active document</span> of the <span>browsing
     context</span>.</p></li>

     <li>

      <p>If the <var>specified entry</var> has a <span>browsing context name</span> stored
      with it, then run the following sub-sub-steps:</p>

      <ol>

       <li><p>Set the browsing context's <span>browsing context name</span> to the name stored with
       the specified entry.</p></li>

       <li><p>Clear any <span data-x="browsing context name">browsing context names</span> stored
       with all entries in the history that are associated with <code>Document</code> objects with
       the <span>same origin</span> as the new <span>active document</span> and that are contiguous
       with the specified entry.</p></li>

      </ol>

     </li>

     <li id="history-autocomplete"><p>If the <var>specified entry</var>'s
     <code>Document</code> has any form controls whose <span>autofill field name</span> is "<code
     data-x="attr-fe-autocomplete-off">off</code>", invoke the <span
     data-x="concept-form-reset-control">reset algorithm</span> of each of those elements.</p></li>

     <li>

      <p>If the <span>current document readiness</span> of the <var>specified entry</var>'s
      <code>Document</code> is "<code>complete</code>", <span>queue a task</span> to run
      the following sub-sub-steps:</p>

      <ol>

       <li><p>If the <code>Document</code>'s <span>page showing</span> flag is true, then abort this
       task (i.e. don't fire the event below).</p></li>

       <li><p>Set the <code>Document</code>'s <span>page showing</span> flag to true.</p></li>

       <li>

        <p>Run any <dfn>session history document visibility change steps</dfn> for <code>Document</code> that
        are defined by <span>other applicable specifications</span>.</p>

        <p class="note">This is specifically intended for use by the Page Visibility specification. <a href="#refsPAGEVIS">\[PAGEVIS]</a></p>

       </li>

       <li><p><span data-x="concept-event-fire">Fire</span> a <span
       data-x="concept-events-trusted">trusted</span> event with the name <code
       data-x="event-pageshow">pageshow</code> at the <code>Window</code> object of that
       <code>Document</code>, with <i
       data-x="concept-event-target-override">target override</i> set to the <code>Document</code>
       object,
       using the <code>PageTransitionEvent</code> interface, with the <code
       data-x="dom-PageTransitionEvent-persisted">persisted</code> attribute initialized to true.
       This event must not bubble, must not be cancelable, and has no default action.</p></li>

      </ol>

      <!-- an interesting thing to test would be to traverse back during onload, before the first
      pageshow has fired, and then to traverse forward again, and see if we get _two_ pageshows. If
      so, it indicates that browsers don't have a "page showing" flag like this and that the history
      traversal task source has a higher priority than the DOM manipulation task source. -->

     </li>

    </ol>

   </li>

   <li><p>Set <span>the document's address</span> to the URL of the <var>specified
   entry</var>.</p></li>

   <li><p>If the <var>specified entry</var> has a URL whose fragment identifier differs
   from that of the <span>current entry</span>'s when compared in a <span>case-sensitive</span>
   manner, and the two share the same <code>Document</code> object, then let <var>hash
   changed</var> be true, and let <var>old URL</var> be the URL of the <span>current
   entry</span> and <var>new URL</var> be the URL of the <var>specified
   entry</var>. Otherwise, let <var>hash changed</var> be false.</p></li>

   <li><p>If the traversal was initiated with <dfn>replacement enabled</dfn>, remove the entry
   immediately before the <var>specified entry</var> in the session history.</p>

   <li><p>If the <var>specified entry</var> is not <span>an entry with persisted user
   state</span>, but its URL has a fragment identifier, <span>scroll to the fragment
   identifier</span>.</p></li>

   <li>

    <p>If the entry is <span>an entry with persisted user state</span>, the user agent may update
    aspects of the document and its rendering, for instance the scroll position or values of form
    fields, that it had previously recorded.</p>

    <!-- see similar paragraphs in the textarea and input sections -->
    <p class="note">This can even include updating the <code data-x="attr-dir">dir</code> attribute
    of <code>textarea</code> elements or <code>input</code> elements whose <code
    data-x="attr-input-type">type</code> attribute is in either the <span
    data-x="attr-input-type-text">Text</span> state or the <span
    data-x="attr-input-type-search">Search</span> state, if the persisted state includes the
    directionality of user input in such controls.</p>

   </li>

   <li><p>If the entry is a <span>state object</span> entry, let <var>state</var> be a
   <span>structured clone</span> of that state object. Otherwise, let <var>state</var> be
   null.</p></li>

   <li><p>Set <code data-x="dom-history-state">history.state</code> to <var>state</var>.</p></li>

   <li><p>Let <var>state changed</var> be true if the <code>Document</code> of the <var>specified entry</var> has a <span>latest entry</span>, and that entry is not the <var>specified entry</var>; otherwise let it be false.</p>

   <li><p>Let the <span>latest entry</span> of the <code>Document</code> of the <var>specified entry</var> be the <var>specified entry</var>.</p></li>

   <li>

    <p>If the <i>non-blocking events</i> flag is not set, then run the following steps
    <span>immediately</span>. Otherwise, the <i>non-blocking events</i> flag is set; <span>queue a task</span>
    to run the following substeps instead.</p>

    <ol>

     <li><p>If <var>state changed</var> is true, <span
     data-x="concept-event-fire">fire</span> a <span data-x="concept-events-trusted">trusted</span>
     event with the name <code data-x="event-popstate">popstate</code> at the <code>Window</code>
     object of the <code>Document</code>, using the <code>PopStateEvent</code> interface, with the
     <code data-x="dom-PopStateEvent-state">state</code> attribute initialized to the value of <var>state</var>. This event must bubble but not be cancelable and has no default
     action.</p></li>

     <li><p>If <var>hash changed</var> is true, then <span
     data-x="concept-event-fire">fire</span> a <span data-x="concept-events-trusted">trusted</span>
     event with the name <code data-x="event-hashchange">hashchange</code> at the <span>browsing
     context</span>'s <code>Window</code> object, using the <code>HashChangeEvent</code> interface,
     with the <code data-x="dom-HashChangeEvent-oldURL">oldURL</code> attribute initialized to <var>old URL</var> and the <code data-x="dom-HashChangeEvent-newURL">newURL</code> attribute
     initialized to <var>new URL</var>. This event must bubble but not be cancelable and
     has no default action.</p></li>

    </ol>

   </li>

   <li><p>The <span>current entry</span> is now the <var>specified entry</var>.</p></li>

  </ol>

  <p>The <span>task source</span> for the tasks mentioned above is the <span>DOM manipulation task
  source</span>.</p>

  </div>


  <h5>The <code>PopStateEvent</code> interface</h5>

  <pre class="idl">[Constructor(DOMString type, optional <span>PopStateEventInit</span> eventInitDict), Exposed=(Window,Worker)]
interface <dfn>PopStateEvent</dfn> : <span>Event</span> {
  readonly attribute any <span data-x="dom-PopStateEvent-state">state</span>;
};

dictionary <dfn>PopStateEventInit</dfn> : <span>EventInit</span> {
  any state;
};</pre>

  <dl class="domintro">

   <dt><var>event</var> . <code subdfn data-x="dom-PopStateEvent-state">state</code></dt>

   <dd>

    <p>Returns a copy of the information that was provided to <code
    data-x="dom-history-pushState">pushState()</code> or <code
    data-x="dom-history-replaceState">replaceState()</code>.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-PopStateEvent-state">state</code></dfn> attribute must return the
  value it was initialized to. When the object is created, this attribute must be initialized to
  null. It represents the context information for the event, or null, if the state represented is
  the initial state of the <code>Document</code>.</p>

  </div>


  <h5>The <code>HashChangeEvent</code> interface</h5>

  <pre class="idl">[Constructor(DOMString type, optional <span>HashChangeEventInit</span> eventInitDict), Exposed=(Window,Worker)]
interface <dfn>HashChangeEvent</dfn> : <span>Event</span> {
  readonly attribute DOMString <span data-x="dom-HashChangeEvent-oldURL">oldURL</span>;
  readonly attribute DOMString <span data-x="dom-HashChangeEvent-newURL">newURL</span>;
};

dictionary <dfn>HashChangeEventInit</dfn> : <span>EventInit</span> {
  DOMString oldURL;
  DOMString newURL;
};</pre>

  <dl class="domintro">

   <dt><var>event</var> . <code subdfn data-x="dom-HashChangeEvent-oldURL">oldURL</code></dt>

   <dd>

    <p>Returns the <span>URL</span> of the <span>session history entry</span> that was previously
    current.</p>

   </dd>


   <dt><var>event</var> . <code subdfn data-x="dom-HashChangeEvent-newURL">newURL</code></dt>

   <dd>

    <p>Returns the <span>URL</span> of the <span>session history entry</span> that is now
    current.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-HashChangeEvent-oldURL">oldURL</code></dfn> attribute must return the
  value it was initialized to. When the object is created, this attribute must be initialized to
  null. It represents context information for the event, specifically the URL of the <span>session
  history entry</span> that was traversed from.</p>

  <p>The <dfn><code data-x="dom-HashChangeEvent-newURL">newURL</code></dfn> attribute must return the
  value it was initialized to. When the object is created, this attribute must be initialized to
  null. It represents context information for the event, specifically the URL of the <span>session
  history entry</span> that was traversed to.</p>

  </div>


  <h5>The <code>PageTransitionEvent</code> interface</h5>

  <pre class="idl">[Constructor(DOMString type, optional <span>PageTransitionEventInit</span> eventInitDict), Exposed=(Window,Worker)]
interface <dfn>PageTransitionEvent</dfn> : <span>Event</span> {
  readonly attribute boolean <span data-x="dom-PageTransitionEvent-persisted">persisted</span>;
};

dictionary <dfn>PageTransitionEventInit</dfn> : <span>EventInit</span> {
  boolean persisted;
};</pre>

  <dl class="domintro">

   <dt><var>event</var> . <code subdfn data-x="dom-PageTransitionEvent-persisted">persisted</code></dt>

   <dd>

    <p>For the <code data-x="event-pageshow">pageshow</code> event, returns false if the page is
    newly being loaded (and the <code data-x="event-load">load</code> event will fire). Otherwise,
    returns true.</p>

    <p>For the <code data-x="event-pagehide">pagehide</code> event, returns false if the page is
    going away for the last time. Otherwise, returns true, meaning that (if nothing conspires to
    make the page unsalvageable) the page might be reused if the user navigates back to this
    page.</p>

    <p>Things that can cause the page to be unsalvageable include:</p>

    <ul class="brief">
     <li><code data-x="dom-document-open">document.open()</code>
     <li>Listening for <code data-x="event-beforeunload">beforeunload</code> events
     <li>Listening for <code data-x="event-unload">unload</code> events
     <li>Having <code>iframe</code>s that are not salvageable
     <li>Active <code>WebSocket</code> objects
     <li><span data-x="abort a document">Aborting a <code>Document</code></span>
    </ul>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-PageTransitionEvent-persisted">persisted</code></dfn> attribute must
  return the value it was initialized to. When the object is created, this attribute must be
  initialized to false. It represents the context information for the event.</p>

  </div>



  <h4 id="unloading-documents">Unloading documents</h4>

  <div class="impl">

  <p>A <code>Document</code> has a <dfn
  data-x="concept-document-salvageable"><i>salvageable</i></dfn> state, which must initially be
  true, a <dfn>fired unload</dfn> flag, which must initially be false, and a <dfn>page showing</dfn>
  flag, which must initially be false. The <span>page showing</span> flag is used to ensure that
  scripts receive <code data-x="event-pageshow">pageshow</code> and <code
  data-x="event-pagehide">pagehide</code> events in a consistent manner (e.g. that they never
  receive two <code data-x="event-pagehide">pagehide</code> events in a row without an intervening
  <code data-x="event-pageshow">pageshow</code>, or vice versa).</p>

  <p><span data-x="event loop">Event loops</span> have a <dfn>termination nesting level</dfn>
  counter, which must initially be zero.</p>

  <p>When a user agent is to <dfn>prompt to unload a document</dfn>, it must run the following
  steps.</p>

  <ol>

   <li><p>Increase the <span>event loop</span>'s <span>termination nesting level</span> by
   one.</p></li>

   <li><p>Increase the <code>Document</code>'s <span>ignore-opens-during-unload counter</span> by
   one.</p></li>

   <li><p>Let <var>event</var> be a new <span data-x="concept-events-trusted">trusted</span>
   <code>BeforeUnloadEvent</code> event object with the name <code
   data-x="event-beforeunload">beforeunload</code>, which does not bubble but is cancelable.</p></li>

   <li><p><i>Dispatch</i>: <span data-x="concept-event-dispatch">Dispatch</span> <var>event</var> at the <code>Document</code>'s <code>Window</code> object.</p></li>

   <li><p>Decrease the <span>event loop</span>'s <span>termination nesting level</span> by
   one.</p></li>

   <li><p>Release the <span>storage mutex</span>.</p></li>

   <li><p>If any event listeners were triggered by the earlier <i>dispatch</i> step, then set the
   <code>Document</code>'s <i data-x="concept-document-salvageable">salvageable</i> state to
   false.</p></li>

   <li>

    <p>If the <code>Document</code>'s <span>active sandboxing flag set</span> does not have its
    <span>sandboxed modals flag</span> set, and the <code
    data-x="dom-BeforeUnloadEvent-returnValue">returnValue</code> attribute of the <var>event</var>
    object is not the empty string, or if the event was canceled, then the user agent should ask the
    user to confirm that they wish to unload the document.</p>

    <p>The prompt shown by the user agent may include the string of the <code
    data-x="dom-BeforeUnloadEvent-returnValue">returnValue</code> attribute, or some leading subset
    thereof. (A user agent may want to truncate the string to 1024 characters for display, for
    instance.)</p>

    <p>The user agent must <span>pause</span> while waiting for the user's response.</p>

    <p>If the user did not confirm the page navigation, then the user agent <dfn>refused to allow
    the document to be unloaded</dfn>.</p>

   </li>

   <li><p>If this algorithm was invoked by another instance of the "prompt to unload a document"
   algorithm (i.e. through the steps below that invoke this algorithm for all descendant browsing
   contexts), then jump to the step labeled <i>end</i>.</p></li>

   <li><p>Let <var>descendants</var> be the <span>list of the descendant browsing
   contexts</span> of the <code>Document</code>.</p></li>

   <li>

    <p>If <var>descendants</var> is not an empty list, then for each <span>browsing
    context</span> <var>b</var> in <var>descendants</var> run the following
    substeps:</p>

    <ol>

     <li><p><span data-x="prompt to unload a document">Prompt to unload</span> the <span>active
     document</span> of the <span>browsing context</span> <var>b</var>. If the user
     <span>refused to allow the document to be unloaded</span>, then the user implicitly also <span
     data-x="refused to allow the document to be unloaded">refused to allow <em>this</em> document to
     be unloaded</span>; jump to the step labeled <i>end</i>.</p>

     <li><p>If the <i data-x="concept-document-salvageable">salvageable</i> state of the <span>active
     document</span> of the <span>browsing context</span> <var>b</var> is false, then set
     the <i data-x="concept-document-salvageable">salvageable</i> state of <em>this</em> document to
     false also.</p></li>

    </ol>

   </li>

   <li><p><i>End</i>: Decrease the <code>Document</code>'s <span>ignore-opens-during-unload
   counter</span> by one.</p></li>

  </ol>

  <p>When a user agent is to <dfn>unload a document</dfn>, it must run the following steps. These
  steps are passed an argument, <var>recycle</var>, which is either true or false,
  indicating whether the <code>Document</code> object is going to be re-used. (This is set by the
  <code data-x="dom-document-open">document.open()</code> method.)</p>

  <ol>

   <li><p>Increase the <span>event loop</span>'s <span>termination nesting level</span> by
   one.</p></li>

   <li><p>Increase the <code>Document</code>'s <span>ignore-opens-during-unload counter</span> by
   one.</p></li>

   <li><p>If the <code>Document</code>'s <span>page showing</span> flag is false, then jump to the
   step labeled <i>unload event</i> below (i.e. skip firing the <code
   data-x="event-pagehide">pagehide</code> event and don't rerun the <span>unloading document
   visibility change steps</span>).</p></li>

   <li><p>Set the <code>Document</code>'s <span>page showing</span> flag to false.</p></li>

   <li><p><span data-x="concept-event-fire">Fire</span> a <span
   data-x="concept-events-trusted">trusted</span> event with the name <code
   data-x="event-pagehide">pagehide</code> at the <code>Window</code> object of the
   <code>Document</code>, with <i
   data-x="concept-event-target-override">target override</i> set to the <code>Document</code>
   object, using the <code>PageTransitionEvent</code> interface,
   with the <code data-x="dom-PageTransitionEvent-persisted">persisted</code> attribute initialized
   to true if the <code>Document</code> object's <i
   data-x="concept-document-salvageable">salvageable</i> state is true, and false otherwise. This
   event must not bubble, must not be cancelable, and has no default action.</p></li>

   <li>

    <p>Run any <dfn>unloading document visibility change steps</dfn> for <code>Document</code> that
    are defined by <span>other applicable specifications</span>.</p>

    <p class="note">This is specifically intended for use by the Page Visibility specification. <a href="#refsPAGEVIS">\[PAGEVIS]</a></p>

   </li>

   <li><p><i>Unload event</i>: If the <code>Document</code>'s <span>fired unload</span> flag is
   false, <span>fire a simple event</span> named <code data-x="event-unload">unload</code> at the
   <code>Document</code>'s <code>Window</code> object, with <i data-x="concept-event-target-override">target override</i> set to the
   <code>Document</code> object.</p></li>

   <li><p>Decrease the <span>event loop</span>'s <span>termination nesting level</span> by
   one.</p></li>

   <li><p>Release the <span>storage mutex</span>.</p></li>

   <li><p>If any event listeners were triggered by the earlier <i>unload event</i> step, then set
   the <code>Document</code> object's <i data-x="concept-document-salvageable">salvageable</i> state
   to false and set the <code>Document</code>'s <span>fired unload</span> flag to true.</p></li>

   <li><p>Run any <span>unloading document cleanup steps</span> for <code>Document</code> that are
   defined by this specification and <span>other applicable specifications</span>.</p></li>

   <li><p>If this algorithm was invoked by another instance of the "unload a document" algorithm
   (i.e. by the steps below that invoke this algorithm for all descendant browsing contexts), then
   jump to the step labeled <i>end</i>.</p></li>

   <li><p>Let <var>descendants</var> be the <span>list of the descendant browsing
   contexts</span> of the <code>Document</code>.</p></li>

   <li>

    <p>If <var>descendants</var> is not an empty list, then for each <span>browsing
    context</span> <var>b</var> in <var>descendants</var> run the following
    substeps:</p>

    <ol>

     <li><p><span data-x="unload a document">Unload</span> the <span>active document</span> of the
     <span>browsing context</span> <var>b</var> with the <var>recycle</var>
     parameter set to false.</p></li>

     <li><p>If the <i data-x="concept-document-salvageable">salvageable</i> state of the <span>active
     document</span> of the <span>browsing context</span> <var>b</var> is false, then set
     the <i data-x="concept-document-salvageable">salvageable</i> state of <em>this</em> document to
     false also.</p></li>

    </ol>

   </li>

   <li><p>If both the <code>Document</code>'s <i
   data-x="concept-document-salvageable">salvageable</i> state and <var>recycle</var> are
   false, then the <code>Document</code>'s <span>browsing context</span> must <span data-x="discard a
   document">discard the <code>Document</code></span>.</p></li>

   <li><p><i>End</i>: Decrease the <code>Document</code>'s <span>ignore-opens-during-unload
   counter</span> by one.</p></li>

  </ol>

  <p>This specification defines the following <dfn>unloading document cleanup steps</dfn>. Other
  specifications can define more.</p>

  <ol>

   <li>

    <p><span>Make disappear</span> any <code>WebSocket</code> objects that were created by the <code
    data-x="dom-WebSocket">WebSocket()</code> constructor from the
    <code>Document</code>'s <code>Window</code> object.</p>

    <p>If this affected any <code>WebSocket</code> objects, then set <code>Document</code>'s <i
    data-x="concept-document-salvageable">salvageable</i> state to false.</p>

   </li>

   <li><p>If the <code>Document</code>'s <i data-x="concept-document-salvageable">salvageable</i>
   state is false, <span data-x="concept-EventSource-forcibly-close">forcibly close</span> any
   <code>EventSource</code> objects that whose constructor was invoked from the
   <code>Document</code>'s <code>Window</code> object.</p></li>

   <li><p>If the <code>Document</code>'s <i data-x="concept-document-salvageable">salvageable</i>
   state is false, empty the <code>Document</code>'s <code>Window</code>'s <span>list of active
   timers</span>.</p></li>

  </ol>

  </div>



  <h5>The <code>BeforeUnloadEvent</code> interface</h5>

  <pre class="idl">interface <dfn>BeforeUnloadEvent</dfn> : <span>Event</span> {
  attribute DOMString <span data-x="dom-BeforeUnloadEvent-returnValue">returnValue</span>;
};</pre>

  <dl class="domintro">

   <dt><var>event</var> . <code subdfn data-x="dom-BeforeUnloadEvent-returnValue">returnValue</code> [ = <var>value</var> ]</dt>

   <dd>

    <p>Returns the current return value of the event (the message to show the user).</p>

    <p>Can be set, to update the message.</p>

   </dd>

  </dl>

  <p class="note">There are no <code>BeforeUnloadEvent</code>-specific initialisation methods.</p>

  <div class="impl">

  <p>The <dfn><code data-x="dom-BeforeUnloadEvent-returnValue">returnValue</code></dfn> attribute
  represents the message to show the user. When the event is created, the attribute must be set to
  the empty string. On getting, it must return the last value it was set to. On setting, the
  attribute must be set to the new value.</p>

  </div>


  <div class="impl">

  <h4 id="aborting-a-document-load">Aborting a document load</h4>

  <p>If a <code>Document</code> is <dfn data-x="abort a document">aborted</dfn>, the user agent must
  run the following steps:</p>

  <ol>

   <li><p><span data-x="abort a document">Abort</span> the <span data-x="active document">active
   documents</span> of every <span>child browsing context</span>. If this results in any of those
   <code>Document</code> objects having their <i
   data-x="concept-document-salvageable">salvageable</i> state set to false, then set this
   <code>Document</code>'s <i data-x="concept-document-salvageable">salvageable</i> state to false
   also.</p></li>

   <li><p>Cancel any instances of the <span data-x="concept-fetch">fetch</span> algorithm in the
   context of this <code>Document</code>, discarding any <span data-x="concept-task">tasks</span>
   <span data-x="queue a task">queued</span> for them, and discarding any further data received from
   the network for them. If this resulted in any instances of the <span
   data-x="concept-fetch">fetch</span> algorithm being canceled or any <span data-x="queue a
   task">queued</span> <span data-x="concept-task">tasks</span> or any network data getting
   discarded, then set the <code>Document</code>'s <i
   data-x="concept-document-salvageable">salvageable</i> state to false.</p></li>

   <li><p>If the <code>Document</code> has an <span>active parser</span>, then <span data-x="abort a
   parser">abort that parser</span> and set the <code>Document</code>'s <i
   data-x="concept-document-salvageable">salvageable</i> state to false.</p></li>

   <!-- we could also stop all script, or stop animations -->

  </ol>

  <p>User agents may allow users to explicitly invoke the <span data-x="abort a document">abort a
  document</span> algorithm for a <code>Document</code>. If the user does so, then, if that
  <code>Document</code> is an <span>active document</span>, the user agent should <span>queue a
  task</span> to <span>fire a simple event</span> named <code data-x="event-abort">abort</code> at
  that <code>Document</code>'s <code>Window</code> object before invoking the <span data-x="abort a
  document">abort</span> algorithm.</p>

  <!-- I'd love to make this more precise, anyone have any suggestions on what it should say? -->

  </div>


<!--TOPIC:Offline Web Applications-->
  <h3 id="offline">Offline Web applications</h3> <!--APPCACHE-->

  <p class="critical">This feature is in the process of being removed from the Web platform. (This
  is a long process that takes many years.) Using any of the offline Web application features at
  this time is highly discouraged. Use service workers instead. <a href="#refsSW">\[SW]</a></p>

  <!-- v2 ideas for appcache:

     * A way to limit what gets download when the user agent is updating the application cache and
       it turns out the server has changed EVERY page because every page has a dynamic "site last
       modified" date on it.

       http://groups.google.com/group/gears-users/browse_thread/thread/efbd808325df607a/c73adb34f9b63cf7?hl=en&q=whatwg#c73adb34f9b63cf7


     * Multiuser appcaches.

       If the application code (HTML, JS, CSS) is all the same for two users, then appcache works
       for multiple users by just having the data for the users separate from the logic.

       This is the expected model for most apps. For example, your typical blog has just one set of
       CSS for all users.

       For systems where the user affects what HTML, JS, and CSS is served back, the spec as written
       pretty much requires that there be one app per user, and one generic "login" app that then
       redirects to one of those other apps - and where each app has a different base URL, separate
       manifest, etc.

       An alternative that we could explore in a future version is to have the manifest include a
       manifest name, and then have script that allows you to "activate" a particular manifest name
       for a given appcache.

       So each appcache group would be further subdivided into named subgroups, and for a given
       manifest URL with such a group of subgroups, one subgroup would be the default one at a time.
       The inactive ones would just lie dormant, but and the active ones would act like now, but
       there'd be a scripted way to change the default (and maybe query what available variants
       exist for the current appcache), so that you could log back in as someone else by just making
       the script pick the other user's variant, and then reloading.


     * Add and remove specific additional files from the cache (e.g. precaching new master entries).

  -->

  <h4 id="introduction">Introduction</h4>

  <p><em>This section is non-normative.</em></p>

  <p>In order to enable users to continue interacting with Web applications and documents even when
  their network connection is unavailable &mdash; for instance, because they are traveling outside
  of their ISP's coverage area &mdash; authors can provide a manifest which lists the files that are
  needed for the Web application to work offline and which causes the user's browser to keep a copy
  of the files for use offline.</p>

  <p>To illustrate this, consider a simple clock applet consisting of an HTML page "<code
 >clock.html</code>", a CSS style sheet "<code>clock.css</code>", and a JavaScript
  script "<code>clock.js</code>".</p>

  <p>Before adding the manifest, these three files might look like this:</p>

  <pre>EXAMPLE offline/clock/clock1.html</pre>
  <pre>EXAMPLE offline/clock/clock1.css</pre>
  <pre>EXAMPLE offline/clock/clock1.js</pre>

  <p>If the user tries to open the "<code>clock.html</code>" page while offline, though,
  the user agent (unless it happens to have it still in the local cache) will fail with an
  error.</p>

  <p>The author can instead provide a manifest of the three files, say "<code
 >clock.appcache</code>":</p>

  <pre>EXAMPLE offline/clock/clock2.appcache</pre>

  <p>With a small change to the HTML file, the manifest (served as <code>text/cache-manifest</code>)
  is linked to the application:</p>

  <pre>EXAMPLE offline/clock/clock2.html</pre>

  <p>Now, if the user goes to the page, the browser will cache the files and make them available
  even when the user is offline.</p>

  <p class="note">Authors are encouraged to include the main page in the manifest also, but in
  practice the page that referenced the manifest is automatically cached even if it isn't explicitly
  mentioned.</p>

  <p class="note">With the exception of "no-store" directive, HTTP cache headers and restrictions on
  caching pages served over TLS (encrypted, using <code data-x="https protocol">https:</code>) are
  overridden by manifests. Thus, pages will not expire from an application cache before the user
  agent has updated it, and even applications served over TLS can be made to work offline.</p>

  <p><a href="https://whatwg.org/demos/offline/clock/live-demo/clock.html">View this example online</a>.</p>



  <h5 id="supporting-offline-caching-for-legacy-applications">Supporting offline caching for legacy applications</h5>

  <p><em>This section is non-normative.</em></p>

  <p>The application cache feature works best if the application logic is separate from the
  application and user data, with the logic (markup, scripts, style sheets, images, etc) listed in
  the manifest and stored in the application cache, with a finite number of static HTML pages for
  the application, and with the application and user data stored in Web Storage or a client-side
  Indexed Database, updated dynamically using Web Sockets, <code>XMLHttpRequest</code>, server-sent
  events, or some other similar mechanism.</p>

  <p>This model results in a fast experience for the user: the application immediately loads, and
  fresh data is obtained as fast as the network will allow it (possibly while stale data shows).</p>

  <p>Legacy applications, however, tend to be designed so that the user data and the logic are mixed
  together in the HTML, with each operation resulting in a new HTML page from the server.</p>

  <div class="example">

   <p>For example, consider a news application. The typical architecture of such an application,
   when not using the application cache feature, is that the user fetches the main page, and the
   server returns a dynamically-generated page with the current headlines and the user interface
   logic mixed together.</p>

   <p>A news application designed for the application cache feature, however, would instead have the
   main page just consist of the logic, and would then have the main page fetch the data separately
   from the server, e.g. using <code>XMLHttpRequest</code>.</p>

  </div>

  <p>The mixed-content model does not work well with the application cache feature: since the
  content is cached, it would result in the user always seeing the stale data from the previous time
  the cache was updated.</p>

  <p>While there is no way to make the legacy model work as fast as the separated model, it
  <em>can</em> at least be retrofitted for offline use using the <span
  data-x="concept-appcache-mode-prefer-online">prefer-online</span> <span
  data-x="concept-appcache-mode">application cache mode</span>. To do so, list all the static
  resources used by the HTML page you want to have work offline in an <span
  data-x="concept-appcache-manifest">application cache manifest</span>, use the <code
  data-x="attr-html-manifest">manifest</code> attribute to select that manifest from the HTML file,
  and then add the following line at the bottom of the manifest:</p>

  <pre>SETTINGS:
prefer-online
NETWORK:
*</pre>

  <p>This causes the <span>application cache</span> to only be used for <span
  data-x="concept-appcache-master">master entries</span> when the user is offline, and causes the
  application cache to be used as an atomic HTTP cache (essentially pinning resources listed in the
  manifest), while allowing all resources not listed in the manifest to be accessed normally when
  the user is online.</p>



  <h5 id="appcacheevents">Event summary</h5>

  <p><em>This section is non-normative.</em></p>

  <p>When the user visits a page that declares a manifest, the browser will try to update the cache.
  It does this by fetching a copy of the manifest and, if the manifest has changed since the user
  agent last saw it, redownloading all the resources it mentions and caching them anew.</p>

  <p>As this is going on, a number of events get fired on the <code>ApplicationCache</code> object
  to keep the script updated as to the state of the cache update, so that the user can be notified
  appropriately. The events are as follows:</p>

  <table>
   <thead>
    <tr>
     <th> Event name
     <th> Interface
     <th> Fired when...
     <th> Next events
   <tbody>

    <tr>
     <td> <dfn><code data-x="event-appcache-checking">checking</code></dfn>
     <td> <code>Event</code>
     <td> The user agent is checking for an update, or attempting to download the manifest for the
          first time. <strong>This is always the first event in the sequence.</strong>
     <td> <code data-x="event-appcache-noupdate">noupdate</code>, <code
          data-x="event-appcache-downloading">downloading</code>, <code
          data-x="event-appcache-obsolete">obsolete</code>, <code
          data-x="event-appcache-error">error</code>

    <tr>
     <td> <dfn><code data-x="event-appcache-noupdate">noupdate</code></dfn>
     <td> <code>Event</code>
     <td> The manifest hadn't changed.
     <td> Last event in sequence.

    <tr>
     <td> <dfn><code data-x="event-appcache-downloading">downloading</code></dfn>
     <td> <code>Event</code>
     <td> The user agent has found an update and is fetching it, or is downloading the resources
          listed by the manifest for the first time.
     <td> <code data-x="event-appcache-progress">progress</code>, <code
          data-x="event-appcache-error">error</code>, <code
          data-x="event-appcache-cached">cached</code>, <code
          data-x="event-appcache-updateready">updateready</code>

    <tr>
     <td> <dfn><code data-x="event-appcache-progress">progress</code></dfn>
     <td> <code>ProgressEvent</code>
     <td> The user agent is downloading resources listed by the manifest.
          The event object's <code data-x="dom-ProgressEvent-total">total</code> attribute returns the total number of files to be downloaded.
          The event object's <code data-x="dom-ProgressEvent-loaded">loaded</code> attribute returns the number of files processed so far.
     <td> <code data-x="event-appcache-progress">progress</code>, <code
          data-x="event-appcache-error">error</code>, <code
          data-x="event-appcache-cached">cached</code>, <code
          data-x="event-appcache-updateready">updateready</code>

    <tr>
     <td> <dfn><code data-x="event-appcache-cached">cached</code></dfn>
     <td> <code>Event</code>
     <td> The resources listed in the manifest have been downloaded, and the application is now cached.
     <td> Last event in sequence.

    <tr>
     <td> <dfn><code data-x="event-appcache-updateready">updateready</code></dfn>
     <td> <code>Event</code>
     <td> The resources listed in the manifest have been newly redownloaded, and the script can use
          <code data-x="dom-appcache-swapCache">swapCache()</code> to switch to the new cache.
     <td> Last event in sequence.

    <tr>
     <td> <dfn><code data-x="event-appcache-obsolete">obsolete</code></dfn>
     <td> <code>Event</code>
     <td> The manifest was found to have become a 404 or 410 page, so the application cache is being deleted.
     <td> Last event in sequence.

    <tr>
     <td rowspan=4> <dfn><code data-x="event-appcache-error">error</code></dfn>
     <td rowspan=4> <code>Event</code>
     <td> The manifest was a 404 or 410 page, so the attempt to cache the application has been aborted.
     <td rowspan=3> Last event in sequence.

    <tr>
     <td> The manifest hadn't changed, but the page referencing the manifest failed to download properly.

    <tr>
     <td> A fatal error occurred while fetching the resources listed in the manifest.

    <tr>
     <td> The manifest changed while the update was being run.
     <td> The user agent will try fetching the files again momentarily.

  </table>

  <p>These events are cancelable; their default action is for the user agent to show download
  progress information. If the page shows its own update UI, canceling the events will prevent the
  user agent from showing redundant progress information.</p>



  <div class="impl">

  <h4 id="appcache">Application caches</h4> <!--APPCACHE-->

  <p>An <dfn>application cache</dfn> is a set of cached resources consisting of:</p>

  <ul>

   <li>

    <p>One or more resources (including their out-of-band metadata, such as HTTP headers, if any),
    identified by URLs, each falling into one (or more) of the following categories:</p>

    <dl>

     <dt><dfn data-x="concept-appcache-master">Master entries</dfn>

     <dd><p class="note">These are documents that were added to the cache because a <span>browsing
     context</span> was <span data-x="navigate">navigated</span> to that document and the document
     indicated that this was its cache, using the <code data-x="attr-html-manifest">manifest</code>
     attribute.</p>


     <dt><dfn data-x="concept-appcache-manifest">The manifest</dfn>

     <dd><p class="note">This is the resource corresponding to the URL that was given in a master
     entry's <code>html</code> element's <code data-x="attr-html-manifest">manifest</code> attribute.
     The manifest is fetched and processed during the <span>application cache download
     process</span>. All the <span data-x="concept-appcache-master">master entries</span> have the
     <span data-x="same origin">same origin</span> as the manifest.</p>


     <dt><dfn data-x="concept-appcache-explicit">Explicit entries</dfn>

     <dd><p class="note">These are the resources that were listed in the cache's <span
     data-x="concept-appcache-manifest">manifest</span> in an <span
     data-x="concept-appcache-manifest-explicit">explicit section</span>.</p>


     <dt><dfn data-x="concept-appcache-fallback">Fallback entries</dfn>

     <dd><p class="note">These are the resources that were listed in the cache's <span
     data-x="concept-appcache-manifest">manifest</span> in a <span
     data-x="concept-appcache-manifest-fallback">fallback section</span>.</p>


    </dl>

    <p><span data-x="concept-appcache-explicit">Explicit entries</span> and <span
    data-x="concept-appcache-fallback">Fallback entries</span> can be marked as <dfn
    data-x="concept-appcache-foreign">foreign</dfn>, which means that they have a <code
    data-x="attr-html-manifest">manifest</code> attribute but that it doesn't point at this cache's
    <span data-x="concept-appcache-manifest">manifest</span>.</p>

    <p class="note">A URL in the list can be flagged with multiple different types, and thus an
    entry can end up being categorized as multiple entries. For example, an entry can be a manifest
    entry and an explicit entry at the same time, if the manifest is listed within the manifest.</p>

   </li>

   <li>

    <p>Zero or more <dfn data-x="concept-appcache-fallback-ns">fallback namespaces</dfn>, each of
    which is mapped to a <span data-x="concept-appcache-fallback">fallback entry</span>.</p>

    <p class="note">These are URLs used as <span data-x="concept-appcache-matches-fallback">prefix
    match patterns</span> for resources that are to be fetched from the network if possible, or to
    be replaced by the corresponding <span data-x="concept-appcache-fallback">fallback entry</span>
    if not. Each namespace URL has the <span>same origin</span> as <span
    data-x="concept-appcache-manifest">the manifest</span>.</p>

   </li>

   <li>

    <p>Zero or more URLs that form the <dfn data-x="concept-appcache-onlinesafelist">online
    safelist namespaces</dfn>.</p>

    <p class="note">These are used as prefix match patterns, and declare URLs for which the user
    agent will ignore the application cache, instead fetching them normally (i.e. from the network
    or local HTTP cache as appropriate).</p>

   </li>

   <li>

    <p>An <dfn data-x="concept-appcache-onlinesafelist-wildcard">online safelist wildcard
    flag</dfn>, which is either <i>open</i> or <i>blocking</i>.</p>

    <p class="note">The <i>open</i> state indicates that any URL not listed as cached is to
    be implicitly treated as being in the <span data-x="concept-appcache-onlinesafelist">online
    safelist namespaces</span>; the <i>blocking</i> state indicates that URLs not listed
    explicitly in the manifest are to be treated as unavailable.</p>

   </li>

   <li>

    <p>A <dfn data-x="concept-appcache-mode">cache mode flag</dfn>, which is either in the <dfn
    data-x="concept-appcache-mode-fast"><i>fast</i></dfn> state or the <dfn
    data-x="concept-appcache-mode-prefer-online"><i>prefer-online</i></dfn> state.</p>

   </li>

  </ul>

  <p>Each <span>application cache</span> has a <dfn
  data-x="concept-appcache-completeness">completeness flag</dfn>, which is either <i>complete</i> or
  <i>incomplete</i>.</p>

  <hr>

  <p>An <dfn>application cache group</dfn> is a group of <span data-x="application cache">application
  caches</span>, identified by the <span>absolute URL</span> of a resource <span
  data-x="concept-appcache-manifest">manifest</span> which is used to populate the caches in the
  group.</p>

  <p>An <span>application cache</span> is <dfn data-x="concept-appcache-newer">newer</dfn> than
  another if it was created after the other (in other words, <span data-x="application
  cache">application caches</span> in an <span>application cache group</span> have a chronological
  order).</p>

  <p>Only the newest <span>application cache</span> in an <span>application cache group</span> can
  have its <span data-x="concept-appcache-completeness">completeness flag</span> set to
  <i>incomplete</i>; the others are always all <i>complete</i>.</p>

  <p>Each <span>application cache group</span> has an <dfn data-x="concept-appcache-status">update
  status</dfn>, which is one of the following: <i>idle</i>, <i>checking</i>, <i>downloading</i>.</p>

  <p>A <dfn>relevant application cache</dfn> is an <span>application cache</span> that is the <span
  data-x="concept-appcache-newer">newest</span> in its <span data-x="application cache
  group">group</span> to be <i>complete</i>.</p>

  <p>Each <span>application cache group</span> has a <dfn
  data-x="concept-appcache-pending-masters">list of pending master entries</dfn>. Each entry in this
  list consists of a resource and a corresponding <code>Document</code> object. It is used during
  the <span>application cache download process</span> to ensure that new master entries are cached
  even if the <span>application cache download process</span> was already running for their
  <span>application cache group</span> when they were loaded.</p>

  <p>An <span>application cache group</span> can be marked as <dfn
  data-x="concept-appcache-obsolete">obsolete</dfn>, meaning that it must be ignored when looking at
  what <span data-x="application cache group">application cache groups</span> exist.</p>

  <hr>

  <p>A <dfn>cache host</dfn> is a <code>Document</code> or a <code>SharedWorkerGlobalScope</code>
  object. A <span>cache host</span> can be associated with an <span>application cache</span>.
  <!--END complete-->
  <a href="#refsWEBWORKERS">\[WEBWORKERS]</a>
  <!--START complete-->
  </p>

  <p>A <code>Document</code> initially is not associated with an <span>application cache</span>, but
  can become associated with one early during the page load process, when steps <a
  href="#parser-appcache">in the parser</a> and in the <span data-x="navigate">navigation</span>
  sections cause <span data-x="concept-appcache-init">cache selection</span> to occur.</p>

  <p>A <code>SharedWorkerGlobalScope</code> can be associated with an <span>application cache</span>
  when it is created.
  <!--END complete-->
  <a href="#refsWEBWORKERS">\[WEBWORKERS]</a>
  <!--START complete-->
  </p>

  <p>Each <span>cache host</span> has an associated <code>ApplicationCache</code> object.</p>

  <hr>

  <p>Multiple <span data-x="application cache">application caches</span> in different <span
  data-x="application cache group">application cache groups</span> can contain the same resource,
  e.g. if the manifests all reference that resource. If the user agent is to <dfn
  data-x="concept-appcache-selection">select an application cache</dfn> from a list of <span
  data-x="relevant application cache">relevant application caches</span> that contain a resource, the
  user agent must use the application cache that the user most likely wants to see the resource
  from, taking into account the following:</p>

  <ul>

   <li>which application cache was most recently updated,

   <li>which application cache was being used to display the resource from which the user decided to
   look at the new resource, and

   <li>which application cache the user prefers.

  </ul>

  <hr>

  <p>A URL <dfn data-x="concept-appcache-matches-fallback">matches a fallback namespace</dfn> if
  there exists a <span>relevant application cache</span> whose <span
  data-x="concept-appcache-manifest">manifest</span>'s URL has the <span>same origin</span> as the
  URL in question, and that has a <span data-x="concept-appcache-fallback-ns">fallback
  namespace</span> that is a <span>prefix match</span> for the URL being examined. If multiple
  fallback namespaces match the same URL, the longest one is the one that matches. A URL looking for
  a fallback namespace can match more than one application cache at a time, but only matches one
  namespace in each cache.</p>

  <div class="example">

   <p>If a manifest <code>http://example.com/app1/manifest</code> declares that <code
  >http://example.com/resources/images</code> is a fallback namespace, and the user
   navigates to <code>HTTP://EXAMPLE.COM:80/resources/images/cat.png</code>, then the user
   agent will decide that the application cache identified by <code
  >http://example.com/app1/manifest</code> contains a namespace with a match for that
   URL.</p>

   <!-- "resolve a url" canonicalizes the case for the scheme and host and removes the port if it is
   the default -->

  </div>

  </div>



  <h4 id="manifests">The cache manifest syntax</h4>


  <h5 id="some-sample-manifests">Some sample manifests</h5>

  <p><em>This section is non-normative.</em></p>

  <div class="example">

   <p>This example manifest requires two images and a style sheet to be cached and safelists a CGI
   script.</p>

   <pre>CACHE MANIFEST
# the above line is required

# this is a comment
# there can be as many of these anywhere in the file
# they are all ignored
  # comments can have spaces before them
  # but must be alone on the line

# blank lines are ignored too

# these are files that need to be cached they can either be listed
# first, or a "CACHE:" header could be put before them, as is done
# lower down.
images/sound-icon.png
images/background.png
# note that each file has to be put on its own line

# here is a file for the online safelist -- it isn't cached, and
# references to this file will bypass the cache, always hitting the
# network (or trying to, if the user is offline).
NETWORK:
comm.cgi

# here is another set of files to cache, this time just the CSS file.
CACHE:
style/default.css</pre>

   <p>It could equally well be written as follows:</p>

   <pre>CACHE MANIFEST
NETWORK:
comm.cgi
CACHE:
style/default.css
images/sound-icon.png
images/background.png</pre>

  </div>

  <div class="example">

   <p>Offline application cache manifests can use absolute paths or even absolute URLs:</p>

   <pre>CACHE MANIFEST

/main/home
/main/app.js
/settings/home
/settings/app.js
http://img.example.com/logo.png
http://img.example.com/check.png
http://img.example.com/cross.png</pre>

  </div>

  <div class="example">

   <p>The following manifest defines a catch-all error page that is displayed for any page on the
   site while the user is offline. It also specifies that the <span
   data-x="concept-appcache-onlinesafelist-wildcard">online safelist wildcard flag</span> is <i>open</i>, meaning that accesses to resources on other sites will not be blocked.
   (Resources on the same site are already not blocked because of the catch-all fallback
   namespace.)</p>

   <p>So long as all pages on the site reference this manifest, they will get cached locally as they
   are fetched, so that subsequent hits to the same page will load the page immediately from the
   cache. Until the manifest is changed, those pages will not be fetched from the server again. When
   the manifest changes, then all the files will be redownloaded.</p>

   <p>Subresources, such as style sheets, images, etc, would only be cached using the regular HTTP
   caching semantics, however.</p>

   <pre>CACHE MANIFEST
FALLBACK:
/ /offline.html
NETWORK:
*</pre>

  </div>


  <h5 id="writing-cache-manifests">Writing cache manifests</h5>

  <p>Manifests must be served using the <code>text/cache-manifest</code> <span>MIME type</span>. All
  resources served using the <code>text/cache-manifest</code> <span>MIME type</span> must follow the
  syntax of application cache manifests, as described in this section.</p>

  <p>An application cache manifest is a text file, whose text is encoded using UTF-8. Data in
  application cache manifests is line-based. Newlines must be represented by U+000A LINE FEED (LF)
  characters, U+000D CARRIAGE RETURN (CR) characters, or U+000D CARRIAGE RETURN (CR) U+000A LINE
  FEED (LF) pairs. <a href="#refsENCODING">\[ENCODING]</a></p>

  <p class="note">This is a <span>willful violation</span> of RFC 2046, which requires all <code
 >text/*</code> types to only allow CRLF line breaks. This requirement, however, is
  outdated; the use of CR, LF, and CRLF line breaks is commonly supported and indeed sometimes CRLF
  is <em>not</em> supported by text editors. <a href="#refsRFC2046">\[RFC2046]</a></p>

  <p>The first line of an application cache manifest must consist of the string "CACHE", a single
  U+0020 SPACE character, the string "MANIFEST", and either a U+0020 SPACE character, a U+0009
  CHARACTER TABULATION (tab) character, a U+000A LINE FEED (LF) character, or a U+000D CARRIAGE
  RETURN (CR) character. The first line may optionally be preceded by a U+FEFF BYTE ORDER MARK (BOM)
  character. If any other text is found on the first line, it is ignored.</p>

  <p>Subsequent lines, if any, must all be one of the following:</p>

  <dl>
   <dt>A blank line
   <dd>
    <p>Blank lines must consist of zero or more U+0020 SPACE and
    U+0009 CHARACTER TABULATION (tab) characters only.</p>

   <dt>A comment
   <dd>
    <p>Comment lines must consist of zero or more U+0020 SPACE and U+0009 CHARACTER TABULATION (tab)
    characters, followed by a single U+0023 NUMBER SIGN character (#), followed by zero or more
    characters other than U+000A LINE FEED (LF) and U+000D CARRIAGE RETURN (CR) characters.</p>

    <p class="note">Comments must be on a line on their own. If they were to be included on a line
    with a URL, the "#" would be mistaken for part of a fragment identifier.</p>

   <dt>A section header
   <dd>

    <p>Section headers change the current section. There are four possible section headers:

    <dl>

     <dt><code>CACHE:</code>
     <dd>Switches to the <dfn data-x="concept-appcache-manifest-explicit">explicit section</dfn>.

     <dt><code>FALLBACK:</code>
     <dd>Switches to the <dfn data-x="concept-appcache-manifest-fallback">fallback section</dfn>.

     <dt><code>NETWORK:</code>
     <dd>Switches to the <dfn data-x="concept-appcache-manifest-network">online safelist section</dfn>.

     <dt><code>SETTINGS:</code>
     <dd>Switches to the <dfn data-x="concept-appcache-manifest-settings">settings section</dfn>.

    </dl>

    <p>Section header lines must consist of zero or more U+0020 SPACE and U+0009 CHARACTER
    TABULATION (tab) characters, followed by one of the names above (including the U+003A COLON
    character (:)) followed by zero or more U+0020 SPACE and U+0009 CHARACTER TABULATION (tab)
    characters.</p>

    <p>Ironically, by default, the current section is the <span
    data-x="concept-appcache-manifest-explicit">explicit section</span>.</p>

   <dt>Data for the current section
   <dd>

    <p>The format that data lines must take depends on the current section.</p>

    <p>When the current section is the <span data-x="concept-appcache-manifest-explicit">explicit
    section</span>, data lines must consist of zero or more U+0020 SPACE and U+0009 CHARACTER
    TABULATION (tab) characters, a <span>valid URL</span> identifying a resource other than the
    manifest itself, and then zero or more U+0020 SPACE and U+0009 CHARACTER TABULATION (tab)
    characters.</p>

    <p>When the current section is the <span data-x="concept-appcache-manifest-fallback">fallback
    section</span>, data lines must consist of zero or more U+0020 SPACE and U+0009 CHARACTER
    TABULATION (tab) characters, a <span>valid URL</span> identifying a resource other than the
    manifest itself, one or more U+0020 SPACE and U+0009 CHARACTER TABULATION (tab) characters,
    another <span>valid URL</span> identifying a resource other than the manifest itself, and then
    zero or more U+0020 SPACE and U+0009 CHARACTER TABULATION (tab) characters.</p>

    <p>When the current section is the <span data-x="concept-appcache-manifest-network">online
    safelist section</span>, data lines must consist of zero or more U+0020 SPACE and U+0009
    CHARACTER TABULATION (tab) characters, either a single U+002A ASTERISK character (*) <!--
    concept-appcache-onlinesafelist-wildcard --> or a <span>valid URL</span> identifying a resource
    other than the manifest itself, and then zero or more U+0020 SPACE and U+0009 CHARACTER
    TABULATION (tab) characters.</p>

    <p>When the current section is the <span data-x="concept-appcache-manifest-settings">settings
    section</span>, data lines must consist of zero or more U+0020 SPACE and U+0009 CHARACTER
    TABULATION (tab) characters, a <span data-x="concept-appcache-manifest-setting">setting</span>,
    and then zero or more U+0020 SPACE and U+0009 CHARACTER TABULATION (tab) characters.</p>

    <p>Currently only one <dfn data-x="concept-appcache-manifest-setting">setting</dfn> is
    defined:</p>

    <dl>

     <dt>The cache mode setting</dt>

     <dd>This consists of the string "<code>prefer-online</code>". It sets the <span
     data-x="concept-appcache-mode">cache mode</span> to <span
     data-x="concept-appcache-mode-prefer-online">prefer-online</span>. (The <span
     data-x="concept-appcache-mode">cache mode</span> defaults to <span
     data-x="concept-appcache-mode-fast">fast</span>.)</dd>

    </dl>

    <p>Within a <span data-x="concept-appcache-manifest-settings">settings section</span>, each <span
    data-x="concept-appcache-manifest-setting">setting</span> must occur no more than once.</p>

<!--
    <p class="note">The URLs in data lines can't be empty strings, since those would be relative
    URLs to the manifest itself. Such lines would be confused with blank or invalid lines,
    anyway.</p>
-->

  </dl>

  <p>Manifests may contain sections more than once. Sections may be empty.</p>

  <p>URLs that are to be fallback pages associated with <span
  data-x="concept-appcache-fallback-ns">fallback namespaces</span>, and those namespaces themselves,
  must be given in <span data-x="concept-appcache-manifest-fallback">fallback sections</span>, with
  the namespace being the first URL of the data line, and the corresponding fallback page being the
  second URL. All the other pages to be cached must be listed in <span
  data-x="concept-appcache-manifest-explicit">explicit sections</span>.</p>

  <p><span data-x="concept-appcache-fallback-ns">Fallback namespaces</span> and <span
  data-x="concept-appcache-fallback">fallback entries</span> must have the <span>same origin</span>
  as the manifest itself. <span data-x="concept-appcache-fallback-ns">Fallback namespaces</span>
  must also be <span>in the same path</span> as the manifest's URL.</p>

  <p>A <span data-x="concept-appcache-fallback-ns">fallback namespace</span> must not be listed more
  than once.</p>

  <p>Namespaces that the user agent is to put into the <span
  data-x="concept-appcache-onlinesafelist">online safelist</span> must all be specified in <span
  data-x="concept-appcache-manifest-network">online safelist sections</span>. (This is needed for
  any URL that the page is intending to use to communicate back to the server.) To specify that all
  URLs are automatically safelisted in this way, a U+002A ASTERISK character (*) may be specified
  as one of the URLs. <!-- concept-appcache-onlinesafelist-wildcard --></p>

  <p>Authors should not include namespaces in the <span
  data-x="concept-appcache-onlinesafelist">online safelist</span> for which another namespace in
  the <span data-x="concept-appcache-onlinesafelist">online safelist</span> is a <span>prefix
  match</span>.</p>

  <p><span data-x="relative URL">Relative URLs</span> must be given relative to the manifest's own
  URL. All URLs in the manifest must have the same <span data-x="concept-url-scheme">scheme</span> as
  the manifest itself (either explicitly or implicitly, through the use of <span data-x="relative
  URL">relative URLs</span>). <a href="#refsURL">\[URL]</a></p>

  <p>URLs in manifests must not have fragment identifiers (i.e. the U+0023 NUMBER SIGN character
  isn't allowed in URLs in manifests).</p>

  <p><span data-x="concept-appcache-fallback-ns">Fallback namespaces</span> and namespaces in the
  <span data-x="concept-appcache-onlinesafelist">online safelist</span> are matched by <span>prefix
  match</span>.</p>


  <div class="impl">

  <h5 id="parsing-cache-manifests">Parsing cache manifests</h5>

  <p>When a user agent is to <dfn>parse a manifest</dfn>, it means that the user agent must run the
  following steps:</p>

  <ol>

   <li>

    <p><span>UTF-8 decode</span> the byte stream corresponding with the manifest to be parsed.</p>

    <p class="note">The <span>UTF-8 decode</span> algorithm strips a leading BOM, if any.</p>

    <!--All U+0000 NULL characters must be replaced by U+FFFD REPLACEMENT CHARACTERs. (this isn't
    black-box testable since neither U+0000 nor U+FFFD are valid anywhere in the syntax and thus
    both will be treated the same anyway)-->

   </li>

   <li><p>Let <var>base URL</var> be the <span>absolute URL</span> representing the
   manifest.</p></li>

   <li><p>Apply the <span>URL parser</span> to <var>base URL</var>, and let <var>manifest path</var>
   be the <span data-x="concept-url-path">path</span> component thus obtained.</p></li>

   <li><p>Remove all the characters in <var>manifest path</var> after the last U+002F SOLIDUS
   character (/), if any. (The first character and the last character in <var>manifest path</var>
   after this step will both be slashes, the URL path separator character.)</p></li>

   <li><p>Apply the <span>URL parser</span> steps to the <var>base URL</var>, so that the
   components from its <span>parsed URL</span> can be used by the subseqent steps of this
   algorithm.</p></li>

   <li><p>Let <var>explicit URLs</var> be an initially empty list of <span data-x="absolute
   URL">absolute URLs</span> for <span data-x="concept-appcache-explicit">explicit
   entries</span>.</p></li>

   <li><p>Let <var>fallback URLs</var> be an initially empty mapping of <span
   data-x="concept-appcache-fallback-ns">fallback namespaces</span> to <span data-x="absolute
   URL">absolute URLs</span> for <span data-x="concept-appcache-fallback">fallback
   entries</span>.</p></li>

   <li><p>Let <var>online safelist namespaces</var> be an initially empty list of <span
   data-x="absolute URL">absolute URLs</span> for an <span
   data-x="concept-appcache-onlinesafelist">online safelist</span>.</p></li>

   <li><p>Let <var>online safelist wildcard flag</var> be <i>blocking</i>. <!--
   concept-appcache-onlinesafelist-wildcard --></p></li>

   <li><p>Let <var>cache mode flag</var> be <i>fast</i>. <!--
   concept-appcache-mode-fast --></p></li>

   <li><p>Let <var>input</var> be the decoded text of the manifest's byte stream.</p></li>

   <li><p>Let <var>position</var> be a pointer into <var>input</var>, initially
   pointing at the first character.</p></li>

   <li><p>If the characters starting from <var>position</var> are "CACHE", followed by a
   U+0020 SPACE character, followed by "MANIFEST", then advance <var>position</var> to the
   next character after those. Otherwise, this isn't a cache manifest; abort this algorithm with a
   failure while checking for the magic signature.</p></li>

   <li><p>If the character at <var>position</var> is neither a U+0020 SPACE character, a
   U+0009 CHARACTER TABULATION (tab) character, U+000A LINE FEED (LF) character, nor a U+000D
   CARRIAGE RETURN (CR) character, then this isn't a cache manifest; abort this algorithm with a
   failure while checking for the magic signature.</p></li>

   <li><p>This is a cache manifest. The algorithm cannot fail beyond
   this point (though bogus lines can get ignored).</p></li>

   <li><p><span>Collect a sequence of characters</span> that are <em>not</em> U+000A LINE FEED (LF)
   or U+000D CARRIAGE RETURN (CR) characters, and ignore those characters. (Extra text on the first
   line, after the signature, is ignored.)</p></li>

   <li><p>Let <var>mode</var> be "explicit".</p></li>

   <li><p><i>Start of line</i>: If <var>position</var> is past the end of <var>input</var>, then jump to the last step. Otherwise, <span>collect a sequence of
   characters</span> that are U+000A LINE FEED (LF), U+000D CARRIAGE RETURN (CR), U+0020 SPACE, or
   U+0009 CHARACTER TABULATION (tab) characters.</p></li>
   <!-- strips leading spaces, ignores space-only lines, ignores blank lines -->

   <li><p>Now, <span>collect a sequence of characters</span> that are <em>not</em> U+000A LINE FEED
   (LF) or U+000D CARRIAGE RETURN (CR) characters, and let the result be <var>line</var>.</p></li>

   <li><p>Drop any trailing U+0020 SPACE and U+0009 CHARACTER TABULATION (tab) characters at the end
   of <var>line</var>.</p></li>

   <li><p>If <var>line</var> is the empty string, then jump back to the step labeled <i>start
   of line</i>.</p></li>

   <li><p>If the first character in <var>line</var> is a U+0023 NUMBER SIGN character (#),
   then jump back to the step labeled <i>start of line</i>.</p></li>

   <li><p>If <var>line</var> equals "CACHE:" (the word "CACHE" followed by a U+003A COLON
   character (:)), then set <var>mode</var> to "explicit" and jump back to the step labeled
   <i>start of line</i>.</p></li>

   <li><p>If <var>line</var> equals "FALLBACK:" (the word "FALLBACK" followed by a U+003A
   COLON character (:)), then set <var>mode</var> to "fallback" and jump back to the step
   labeled <i>start of line</i>.</p></li>

   <li><p>If <var>line</var> equals "NETWORK:" (the word "NETWORK" followed by a U+003A
   COLON character (:)), then set <var>mode</var> to "online safelist" and jump back to
   the step labeled <i>start of line</i>.</p></li>

   <li><p>If <var>line</var> equals "SETTINGS:" (the word "SETTINGS" followed by a U+003A
   COLON character (:)), then set <var>mode</var> to "settings" and jump back to the step
   labeled <i>start of line</i>.</p></li>

   <li><p>If <var>line</var> ends with a U+003A COLON character (:), then set <var>mode</var> to "unknown" and jump back to the step labeled <i>start of line</i>.</p></li>

   <li><p>This is either a data line or it is syntactically incorrect.</p></li>

   <li><p>Let <var>position</var> be a pointer into <var>line</var>, initially
   pointing at the start of the string.</p></li>

   <li><p>Let <var>tokens</var> be a list of strings, initially empty.</p></li>

   <li>

    <p>While <var>position</var> doesn't point past the end of <var>line</var>:</p>

    <ol>

     <li><p>Let <var>current token</var> be an empty string.</p></li>

     <li><p>While <var>position</var> doesn't point past the end of <var>line</var> and the character at <var>position</var> is neither a U+0020 SPACE
     nor a U+0009 CHARACTER TABULATION (tab) character, add the character at <var>position</var> to <var>current token</var> and advance <var>position</var> to the next character in <var>input</var>.</p></li>

     <li><p>Add <var>current token</var> to the <var>tokens</var> list.</p></li>

     <li><p>While <var>position</var> doesn't point past the end of <var>line</var> and the character at <var>position</var> is either a U+0020 SPACE
     or a U+0009 CHARACTER TABULATION (tab) character, advance <var>position</var> to the
     next character in <var>input</var>.</p></li>

    </ol>

   </li>

   <li>

    <p>Process <var>tokens</var> as follows:</p>

    <dl class="switch">

     <dt>If <var>mode</var> is "explicit"</dt>

     <dd>

      <p><span data-x="resolve a url">Resolve</span> the first item in <var>tokens</var>,
      relative to <var>base URL</var>, with the URL character encoding set to UTF-8;
      ignore the rest.</p>

      <p>If this fails, then jump back to the step labeled <i>start of line</i>.</p>

      <p>If the resulting <span>parsed URL</span> has a different <span
      data-x="concept-url-scheme">scheme</span> component than <var>base URL</var> (the
      manifest's URL), then jump back to the step labeled <i>start of line</i>.</p>

      <p>Let <var>new URL</var> be the result of applying the <span
      data-x="concept-url-serializer">URL serializer</span> algorithm to the resulting <span>parsed
      URL</span>, with the <i>exclude fragment flag</i> set.</p>

      <p>Add <var>new URL</var> to the <var>explicit URLs</var>.</p>

     </dd>

     <dt>If <var>mode</var> is "fallback"</dt>

     <dd>

      <p>Let <var>part one</var> be the first token in <var>tokens</var>, and let
      <var>part two</var> be the second token in <var>tokens</var>.</p>

      <p><span data-x="resolve a url">Resolve</span> <var>part one</var> and <var>part two</var>, relative to <var>base URL</var>, with the URL character
      encoding set to UTF-8.</p>

      <p>If either fails, then jump back to the step labeled <i>start of line</i>.</p>

<!--ADD-TOPIC:Security-->
      <p>If the <span>absolute URL</span> corresponding to either <var>part one</var> or
      <var>part two</var> does not have the <span>same origin</span> as the manifest's URL,
      then jump back to the step labeled <i>start of line</i>.</p> <!-- SECURITY -->

      <p>Let <var>part one path</var> be the <span data-x="concept-url-path">path</span> component
      of the <span>resulting parsed URL</span> for <var>part one</var>.</p>

      <p>If <var>manifest path</var> is not a <span>prefix match</span> for <var>part one
      path</var>, then jump back to the step labeled <i>start of line</i>.</p> <!-- SECURITY (in
      depth) -->
<!--REMOVE-TOPIC:Security-->

      <p>Let <var>part one</var> be the result of applying the <span
      data-x="concept-url-serializer">URL serializer</span> algorithm to the first resulting
      <span>parsed URL</span>, with the <i>exclude fragment flag</i> set.</p>

      <p>Let <var>part two</var> be the result of applying the <span
      data-x="concept-url-serializer">URL serializer</span> algorithm to the second resulting
      <span>parsed URL</span>, with the <i>exclude fragment flag</i> set.</p>

      <p>If <var>part one</var> is already in the <var>fallback URLs</var> mapping
      as a <span data-x="concept-appcache-fallback-ns">fallback namespace</span>, then jump back to
      the step labeled <i>start of line</i>.</p>

      <p>Otherwise, add <var>part one</var> to the <var>fallback URLs</var>
      mapping as a <span data-x="concept-appcache-fallback-ns">fallback namespace</span>, mapped to
      <var>part two</var> as the <span data-x="concept-appcache-fallback">fallback
      entry</span>.</p>

     </dd>

     <dt>If <var>mode</var> is "online safelist"</dt>

     <dd>

      <p>If the first item in <var>tokens</var> is a U+002A ASTERISK character (*), then
      set <var>online safelist wildcard flag</var> to <i>open</i> and jump back
      to the step labeled <i>start of line</i>.</p>

      <p>Otherwise, <span data-x="resolve a url">resolve</span> the first item in <var>tokens</var>, relative to <var>base URL</var>, with the URL character
      encoding set to UTF-8; ignore the rest.</p>

      <p>If this fails, then jump back to the step labeled <i>start of line</i>.</p>

      <p>If the resulting <span>parsed URL</span> has a different <span
      data-x="concept-url-scheme">scheme</span> component than <var>base URL</var> (the
      manifest's URL), then jump back to the step labeled <i>start of line</i>.</p>

      <p>Let <var>new URL</var> be the result of applying the <span
      data-x="concept-url-serializer">URL serializer</span> algorithm to the resulting <span>parsed
      URL</span>, with the <i>exclude fragment flag</i> set.</p>

      <p>Add <var>new URL</var> to the <var>online safelist namespaces</var>.</p>

     </dd>

     <dt>If <var>mode</var> is "settings"</dt>

     <dd>

      <p>If <var>tokens</var> contains a single token, and that token is a
      <span>case-sensitive</span> match for the string "<code>prefer-online</code>", then
      set <var>cache mode flag</var> to <i>prefer-online</i> and jump back to the
      step labeled <i>start of line</i>.</p>

      <p>Otherwise, the line is an unsupported setting: do nothing; the line is ignored.</p>

     </dd>

     <dt>If <var>mode</var> is "unknown"</dt>

     <dd>

      <p>Do nothing. The line is ignored.</p>

     </dd>

    </dl>

   </li>

   <li><p>Jump back to the step labeled <i>start of line</i>. (That step jumps to the next, and last,
   step when the end of the file is reached.)</p></li>

   <li><p>Return the <var>explicit URLs</var> list, the <var>fallback URLs</var>
   mapping, the <var>online safelist namespaces</var>, the <var>online safelist
   wildcard flag</var>, and the <var>cache mode flag</var>.</p></li>

  </ol>

  <div class="note">

   <p>The resource that declares the manifest (with the <code
   data-x="attr-html-manifest">manifest</code> attribute) will always get taken from the cache,
   whether it is listed in the cache or not, even if it is listed in an <span
   data-x="concept-appcache-onlinesafelist">online safelist namespace</span>.</p>

   <p>If a resource is listed in the <span data-x="concept-appcache-manifest-explicit">explicit
   section</span> or as a <span data-x="concept-appcache-fallback">fallback entry</span> in the <span
   data-x="concept-appcache-manifest-fallback">fallback section</span>, the resource will always be
   taken from the cache, regardless of any other matching entries in the <span
   data-x="concept-appcache-fallback-ns">fallback namespaces</span> or <span
   data-x="concept-appcache-onlinesafelist">online safelist namespaces</span>.</p>

   <p>When a <span data-x="concept-appcache-fallback-ns">fallback namespace</span> and an <span
   data-x="concept-appcache-onlinesafelist">online safelist namespace</span> overlap, the <span
   data-x="concept-appcache-onlinesafelist">online safelist namespace</span> has priority.</p>

   <p>The <span data-x="concept-appcache-onlinesafelist-wildcard">online safelist wildcard
   flag</span> is applied last, only for URLs that match neither the <span
   data-x="concept-appcache-onlinesafelist">online safelist namespace</span> nor the <span
   data-x="concept-appcache-fallback-ns">fallback namespace</span> and that are not listed in the
   <span data-x="concept-appcache-manifest-explicit">explicit section</span>.</p>

  </div>


  <h4 id="downloading-or-updating-an-application-cache">Downloading or updating an application cache</h4>

  <p>When the user agent is required (by other parts of this specification) to start the
  <dfn>application cache download process</dfn> for an <span>absolute URL</span> purported to
  identify a <span data-x="concept-appcache-manifest">manifest</span>, or for an <span>application
  cache group</span>, potentially given a particular <span>cache host</span>, and potentially given
  a <span data-x="concept-appcache-master">master</span> resource, the user agent must run the steps
  below. These steps are always run <span>in parallel</span> with the <span>event loop</span>
  <span data-x="concept-task">tasks</span>.</p>

  <p>Some of these steps have requirements that only apply if the user agent <dfn>shows caching
  progress</dfn>. Support for this is optional. Caching progress UI could consist of a progress bar
  or message panel in the user agent's interface, or an overlay, or something else. Certain events
  fired during the <span>application cache download process</span> allow the script to override the
  display of such an interface. (Such events are delayed until after the <code
  data-x="event-load">load</code> event has fired.)

  The goal of this is to allow Web applications to provide more
  seamless update mechanisms, hiding from the user the mechanics of the application cache mechanism.
  User agents may display user interfaces independent of this, but are encouraged to not show
  prominent update progress notifications for applications that cancel the relevant events.</p>

  <p>The <span>application cache download process</span> steps are as follows:

  <ol>

   <li><p>Optionally, wait until the permission to start the <span>application cache download
   process</span> has been obtained from the user and until the user agent is confident that the
   network is available. This could include doing nothing until the user explicitly opts-in to
   caching the site, or could involve prompting the user for permission. The algorithm might never
   get past this point. (This step is particularly intended to be used by user agents running on
   severely space-constrained devices or in highly privacy-sensitive environments).</p></li>

   <li>

    <p>Atomically, so as to avoid race conditions, perform the following substeps:</p>

    <ol>

     <li>

      <p>Pick the appropriate substeps:</p>

      <dl class="switch">

       <dt>If these steps were invoked with an <span>absolute URL</span> purported to identify a
       <span data-x="concept-appcache-manifest">manifest</span></dt>

       <dd>

        <p>Let <var>manifest URL</var> be that <span>absolute URL</span>.</p>

        <p>If there is no <span>application cache group</span> identified by <var>manifest
        URL</var>, then create a new <span>application cache group</span> identified by <var>manifest URL</var>. Initially, it has no <span data-x="application
        cache">application caches</span>. One will be created later in this algorithm.</p>

       </dd>


       <dt>If these steps were invoked with an <span>application cache group</span></dt>

       <dd>

        <p>Let <var>manifest URL</var> be the <span>absolute URL</span> of the <span
        data-x="concept-appcache-manifest">manifest</span> used to identify the <span>application
        cache group</span> to be updated.</p>

        <p>If that <span>application cache group</span> is <span
        data-x="concept-appcache-obsolete">obsolete</span>, then abort this instance of the
        <span>application cache download process</span>. This can happen if another instance of this
        algorithm found the manifest to be 404 or 410 while this algorithm was waiting in the first
        step above.</p>

       </dd>

      </dl>

     </li>

     <li><p>Let <var>cache group</var> be the <span>application cache group</span>
     identified by <var>manifest URL</var>.</p></li>

     <li><p>If these steps were invoked with a <span data-x="concept-appcache-master">master</span>
     resource, then add the resource, along with the resource's <code>Document</code>, to <var>cache group</var>'s <span data-x="concept-appcache-pending-masters">list of pending
     master entries</span>.</p></li>

     <li><p>If these steps were invoked with a <span>cache host</span>, and the <span
     data-x="concept-appcache-status">status</span> of <var>cache group</var> is
     <i>checking</i> or <i>downloading</i>, then <span>queue a post-load task</span> to <span>fire a
     simple event</span> named <code data-x="event-appcache-checking">checking</code> that is
     cancelable at the <code>ApplicationCache</code> singleton of that <span>cache host</span>. The
     default action of this event must be, if the user agent <span>shows caching progress</span>,
     the display of some sort of user interface indicating to the user that the user agent is
     checking to see if it can download the application.</p></li>

     <li><p>If these steps were invoked with a <span>cache host</span>, and the <span
     data-x="concept-appcache-status">status</span> of <var>cache group</var> is
     <i>downloading</i>, then also <span>queue a post-load task</span> to <span>fire a simple
     event</span> named <code data-x="event-appcache-downloading">downloading</code> that is
     cancelable at the <code>ApplicationCache</code> singleton of that <span>cache host</span>. The
     default action of this event must be, if the user agent <span>shows caching progress</span>,
     the display of some sort of user interface indicating to the user the application is being
     downloaded.</p></li>

     <li><p>If the <span data-x="concept-appcache-status">status</span> of the <var>cache
     group</var> is either <i>checking</i> or <i>downloading</i>, then abort this instance of the
     <span>application cache download process</span>, as an update is already in progress.</p></li>

     <li><p>Set the <span data-x="concept-appcache-status">status</span> of <var>cache
     group</var> to <i>checking</i>.</p>

     <li><p>For each <span>cache host</span> associated with an <span>application cache</span> in
     <var>cache group</var>, <span>queue a post-load task</span> to <span>fire a simple
     event</span> that is cancelable named <code data-x="event-appcache-checking">checking</code> at
     the <code>ApplicationCache</code> singleton of the <span>cache host</span>. The default action
     of these events must be, if the user agent <span>shows caching progress</span>, the display of
     some sort of user interface indicating to the user that the user agent is checking for the
     availability of updates.</p></li>

    </ol>

    <p class="note">The remainder of the steps run <span>in parallel</span>.</p>

    <p>If <var>cache group</var> already has an <span>application cache</span> in it, then
    this is an <dfn data-x="concept-appcache-upgrade">upgrade attempt</dfn>. Otherwise, this is a
    <dfn data-x="concept-appcache-cache">cache attempt</dfn>.</p>

   </li>

   <li><p>If this is a <span data-x="concept-appcache-cache">cache attempt</span>, then this
   algorithm was invoked with a <span>cache host</span>; <span>queue a post-load task</span> to
   <span>fire a simple event</span> named <code data-x="event-appcache-checking">checking</code> that
   is cancelable at the <code>ApplicationCache</code> singleton of that <span>cache host</span>. The
   default action of this event must be, if the user agent <span>shows caching progress</span>, the
   display of some sort of user interface indicating to the user that the user agent is checking for
   the availability of updates.</p></li>

   <li><p>Let <var>request</var> be a new <span data-x="concept-request">request</span> whose
   <span data-x="concept-request-url">url</span> is <var>manifest URL</var>, <span
   data-x="concept-request-client">client</span> is null, <span
   data-x="concept-request-destination">destination</span> is "<code>subresource</code>",
   <span>omit-<code>Origin</code>-header flag</span> is set, <span
   data-x="concept-request-referrer">referrer</span> is "<code>no-referrer</code>",
   <span>synchronous flag</span> is set, <span data-x="concept-request-credentials-mode">credentials
   mode</span> is "<code>include</code>", and whose <span>use-URL-credentials
   flag</span> is set.</p></li>

   <li>

    <!--FETCH--><p><i>Fetching the manifest</i>: Let <var>manifest</var> be the result of <span
    data-x="concept-fetch">fetching</span> <var>request</var>. HTTP caching semantics should be
    honored for this request.<!--TODO: unclear if we still need this last sentence--></p>

    <p>Parse <var>manifest</var>'s <span data-x="concept-response-body">body</span> according to the
    <span data-x="parse a manifest">rules for parsing manifests</span>, obtaining a list of
    <span data-x="concept-appcache-explicit">explicit entries</span>, <span
    data-x="concept-appcache-fallback">fallback entries</span> and the <span
    data-x="concept-appcache-fallback-ns">fallback namespaces</span> that map to them, entries for
    the <span data-x="concept-appcache-onlinesafelist">online safelist</span>, and values for the
    <span data-x="concept-appcache-onlinesafelist-wildcard">online safelist wildcard flag</span>
    and the <span data-x="concept-appcache-mode">cache mode flag</span>.</p>

    <p class="note">The <span>MIME type</span> of the resource is ignored &mdash; it is assumed to
    be <code>text/cache-manifest</code>. In the future, if new manifest formats are supported, the
    different types will probably be distinguished on the basis of the file signatures (for the
    current format, that is the "<code>CACHE&nbsp;MANIFEST</code>" string at the top of the
    file).</p>

   </li>

   <li>

    <p>If <i>fetching the manifest</i> fails due to a 404 or 410 response status, then run these
    substeps:</p>

    <ol>

     <li><p>Mark <var>cache group</var> as <span
     data-x="concept-appcache-obsolete">obsolete</span>. This <var>cache group</var> no
     longer exists for any purpose other than the processing of <code>Document</code> objects
     already associated with an <span>application cache</span> in the <var>cache
     group</var>.</p></li>

     <li><p>Let <var>task list</var> be an empty list of <span
     data-x="concept-task">tasks</span>.</p>

     <li><p>For each <span>cache host</span> associated with an <span>application cache</span> in
     <var>cache group</var>, create a <span data-x="concept-task">task</span> to <span>fire
     a simple event</span> named <code data-x="event-appcache-obsolete">obsolete</code> that is
     cancelable at the <code>ApplicationCache</code> singleton of the <span>cache host</span>, and
     append it to <var>task list</var>. The default action of these events must be, if the
     user agent <span>shows caching progress</span>, the display of some sort of user interface
     indicating to the user that the application is no longer available for offline use.</p></li>

     <li><p>For each entry in <var>cache group</var>'s <span
     data-x="concept-appcache-pending-masters">list of pending master entries</span>, create a <span
     data-x="concept-task">task</span> to <span>fire a simple event</span> that is cancelable named
     <code data-x="event-appcache-error">error</code> (not <code
     data-x="event-appcache-obsolete">obsolete</code>!) at the <code>ApplicationCache</code>
     singleton of the <code>Document</code> for this entry, if there still is one, and append it to
     <var>task list</var>. The default action of this event must be, if the user agent
     <span>shows caching progress</span>, the display of some sort of user interface indicating to
     the user that the user agent failed to save the application for offline use.</p></li>

     <li><p>If <var>cache group</var> has an <span>application cache</span> whose <span
     data-x="concept-appcache-completeness">completeness flag</span> is <i>incomplete</i>, then
     discard that <span>application cache</span>.</p>

     <li><p>If appropriate, remove any user interface indicating that an update for this cache is in
     progress.</p></li>

     <li><p>Let the <span data-x="concept-appcache-status">status</span> of <var>cache
     group</var> be <i>idle</i>.</p></li>

     <li><p>For each <span data-x="concept-task">task</span> in <var>task list</var>, <span
     data-x="queue a post-load task">queue that task as a post-load task</span>.</p></li>

     <li><p>Abort the <span>application cache download process</span>.</p></li>

    </ol>

   </li>

   <li>

    <p>Otherwise, if <i>fetching the manifest</i> fails in some other way (e.g. the server returns
    another 4xx or 5xx response, or there is a DNS error, or the connection times out, or the user
    cancels the download, or the parser for manifests fails when checking the magic signature), or
    if the server returned a redirect, then run the <span>cache failure steps</span>. <a
    href="#refsHTTP">\[HTTP]</a></p>

   </li>

   <li>

    <p>If this is an <span data-x="concept-appcache-upgrade">upgrade attempt</span> and the newly
    downloaded <var>manifest</var> is byte-for-byte identical to the manifest found in the
    <span data-x="concept-appcache-newer">newest</span> <span>application cache</span> in <var>cache
    group</var>, or the response status is <code>304</code>, then run these substeps:</p>

    <ol>

     <li><p>Let <var>cache</var> be the <span data-x="concept-appcache-newer">newest</span>
     <span>application cache</span> in <var>cache group</var>.</p></li>

     <li><p>Let <var>task list</var> be an empty list of <span
     data-x="concept-task">tasks</span>.</p>

     <li>

      <p>For each entry in <var>cache group</var>'s <span
      data-x="concept-appcache-pending-masters">list of pending master entries</span>, wait for the
      resource for this entry to have either completely downloaded or failed.</p>

      <p>If the download failed (e.g. the server returns a 4xx or 5xx response, or there is a DNS
      error, the connection times out, or the user cancels the download), or if the resource is
      labeled with the "no-store" cache directive, then create a <span
      data-x="concept-task">task</span> to <span>fire a simple event</span> that is cancelable named
      <code data-x="event-appcache-error">error</code> at the <code>ApplicationCache</code>
      singleton of the <code>Document</code> for this entry, if there still is one, and append it to
      <var>task list</var>. The default action of this event must be, if the user agent <span>shows
      caching progress</span>, the display of some sort of user interface indicating to the user
      that the user agent failed to save the application for offline use.</p>

      <p>Otherwise, associate the <code>Document</code> for this entry with <var>cache</var>; store the resource for this entry in <var>cache</var>, if it
      isn't already there, and categorize its entry as a <span
      data-x="concept-appcache-master">master entry</span>. If applying the <span>URL parser</span>
      algorithm to the resource's <span>URL</span> results in a <span>parsed URL</span> that has a
      non-null <span data-x="concept-url-fragment">fragment</span> component, the <span>URL</span>
      used for the entry in <var>cache</var> must instead be the <span>absolute URL</span>
      obtained from applying the <span data-x="concept-url-serializer">URL serializer</span>
      algorithm to the <span>parsed URL</span> with the <i>exclude fragment flag</i> set
      (application caches never include fragment identifiers).</p>

     </li>

     <li><p>For each <span>cache host</span> associated with an <span>application cache</span> in
     <var>cache group</var>, create a <span data-x="concept-task">task</span> to <span>fire
     a simple event</span> that is cancelable named <code
     data-x="event-appcache-noupdate">noupdate</code> at the <code>ApplicationCache</code> singleton
     of the <span>cache host</span>, and append it to <var>task list</var>. The default
     action of these events must be, if the user agent <span>shows caching progress</span>, the
     display of some sort of user interface indicating to the user that the application is up to
     date.</p></li>

     <li><p>Empty <var>cache group</var>'s <span
     data-x="concept-appcache-pending-masters">list of pending master entries</span>.</p></li>

     <li><p>If appropriate, remove any user interface indicating that an update for this cache is in
     progress.</p></li>

     <li><p>Let the <span data-x="concept-appcache-status">status</span> of <var>cache
     group</var> be <i>idle</i>.</p></li>

     <li><p>For each <span data-x="concept-task">task</span> in <var>task list</var>, <span
     data-x="queue a post-load task">queue that task as a post-load task</span>.</p></li>

     <li><p>Abort the <span>application cache download process</span>.</p></li>

    </ol>

   </li>

   <li><p>Let <var>new cache</var> be a newly created <span>application cache</span> in
   <var>cache group</var>. Set its <span data-x="concept-appcache-completeness">completeness
   flag</span> to <i>incomplete</i>.</p></li>

   <li><p>For each entry in <var>cache group</var>'s <span
   data-x="concept-appcache-pending-masters">list of pending master entries</span>, associate the
   <code>Document</code> for this entry with <var>new cache</var>.</p></li>

   <li><p>Set the <span data-x="concept-appcache-status">status</span> of <var>cache
   group</var> to <i>downloading</i>.</p></li>

   <li><p>For each <span>cache host</span> associated with an <span>application cache</span> in <var>cache group</var>, <span>queue a post-load task</span> to <span>fire a simple
   event</span> that is cancelable named <code data-x="event-appcache-downloading">downloading</code>
   at the <code>ApplicationCache</code> singleton of the <span>cache host</span>. The default action
   of these events must be, if the user agent <span>shows caching progress</span>, the display of
   some sort of user interface indicating to the user that a new version is being
   downloaded.</p></li>

   <li><p>Let <var>file list</var> be an empty list of URLs with flags.</p></li>

   <li><p>Add all the URLs in the list of <span data-x="concept-appcache-explicit">explicit
   entries</span> obtained by parsing <var>manifest</var> to <var>file list</var>,
   each flagged with "explicit entry".</p></li>

   <li><p>Add all the URLs in the list of <span data-x="concept-appcache-fallback">fallback
   entries</span> obtained by parsing <var>manifest</var> to <var>file list</var>,
   each flagged with "fallback entry".</p></li>

   <li><p>If this is an <span data-x="concept-appcache-upgrade">upgrade attempt</span>, then add all
   the URLs of <span data-x="concept-appcache-master">master entries</span> in the <span
   data-x="concept-appcache-newer">newest</span> <span>application cache</span> in <var>cache group</var> whose <span data-x="concept-appcache-completeness">completeness
   flag</span> is <i>complete</i> to <var>file list</var>, each flagged with "master
   entry".</p></li>

   <li><p>If any URL is in <var>file list</var> more than once, then merge the entries into
   one entry for that URL, that entry having all the flags that the original entries had.</p></li>

   <li>

    <p>For each URL in <var>file list</var>, run the following steps. These steps may be
    run in parallel for two or more of the URLs at a time. If, while running these steps, the
    <code>ApplicationCache</code> object's <code data-x="dom-appcache-abort">abort()</code> method
    <span data-x="send a signal">sends a signal</span> to this instance of the <span>application
    cache download process</span> algorithm, then run the <span>cache failure steps</span>
    instead.</p>

    <ol>

     <li>

      <p>If the resource URL being processed was flagged as neither an "explicit entry" nor or a
      "fallback entry", then the user agent may skip this URL.</p>

      <p class="note">This is intended to allow user agents to expire resources not listed in the
      manifest from the cache. Generally, implementors are urged to use an approach that expires
      lesser-used resources first.</p>

     </li>

     <li><p>For each <span>cache host</span> associated with an <span>application cache</span> in
     <var>cache group</var>, <span>queue a progress post-load task</span> to <span
     data-x="concept-event-fire">fire</span> a <span data-x="concept-events-trusted">trusted</span>
     event with the name <code data-x="event-appcache-progress">progress</code>, which does not
     bubble, which is cancelable, and which uses the <code>ProgressEvent</code> interface, at the
     <code>ApplicationCache</code> singleton of the <span>cache host</span>. The <code
     data-x="dom-ProgressEvent-lengthComputable">lengthComputable</code> attribute must be set to
     true, the <code data-x="dom-ProgressEvent-total">total</code> attribute must be set to the
     number of files in <var>file list</var>, and the <code
     data-x="dom-ProgressEvent-loaded">loaded</code> attribute must be set to the number of files in
     <var>file list</var> that have been either downloaded or skipped so far. The default
     action of these events must be, if the user agent <span>shows caching progress</span>, the
     display of some sort of user interface indicating to the user that a file is being downloaded
     in preparation for updating the application. <a href="#refsXHR">\[XHR]</a></p></li>

     <li><p>Let <var>request</var> be a new <span data-x="concept-request">request</span> whose
     <span data-x="concept-request-url">url</span> is URL, <span
     data-x="concept-request-client">client</span> is null, <span
     data-x="concept-request-destination">destination</span> is "<code
    >subresource</code>", <span data-x="concept-request-origin">origin</span> is
     <var>manifest URL</var>'s <span>origin</span>, <span
     data-x="concept-request-referrer">referrer</span> is "<code>no-referrer</code>",
     <span>synchronous flag</span> is set, <span
     data-x="concept-request-credentials-mode">credentials mode</span> is "<code
    >include</code>", <span>use-URL-credentials flag</span> is set, and <span
     data-x="concept-request-redirect-mode">redirect mode</span> is "<code
    >manual</code>".</p></li>

     <!--FETCH--><li><p><span data-x="concept-fetch">Fetch</span> <var>request</var>. If this is an
     <span data-x="concept-appcache-upgrade">upgrade attempt</span>, then use the <span
     data-x="concept-appcache-newer">newest</span> <span>application cache</span> in <var>cache
     group</var> as an HTTP cache, and honor HTTP caching semantics (such as expiration, ETags, and
     so forth) with respect to that cache. User agents may also have other caches in place that are
     also honored.</p></li>

     <li>

      <p>If the previous step fails (e.g. the server returns a 4xx or 5xx response, or there is a
      DNS error, or the connection times out, or the user cancels the download), or if the server
      returned a redirect, or if the resource is labeled with the "no-store" cache directive, then
      run the first appropriate step from the following list: <a href="#refsHTTP">\[HTTP]</a></p>

      <dl class="switch">

       <dt>If the URL being processed was flagged as an "explicit entry" or a "fallback entry"</dt>

       <dd>

        <p>If these steps are being run in parallel for any other URLs in <var>file
        list</var>, then abort these steps for those other URLs. Run the <span>cache failure
        steps</span>.</p>

        <p class="note">Redirects are fatal because they are either indicative of a network problem
        (e.g. a captive portal); or would allow resources to be added to the cache under URLs that
        differ from any URL that the networking model will allow access to, leaving orphan entries;
        or would allow resources to be stored under URLs different than their true URLs. All of
        these situations are bad.</p>

       </dd>

       <dt>If the error was a 404 or 410 HTTP response</dt>

       <dt>If the resource was labeled with the "no-store" cache directive</dt>

       <dd>

        <p>Skip this resource. It is dropped from the cache.</p>

       </dd>

       <dt>Otherwise</dt>

       <dd>

        <p>Copy the resource and its metadata from the <span
        data-x="concept-appcache-newer">newest</span> <span>application cache</span> in <var>cache group</var> whose <span data-x="concept-appcache-completeness">completeness
        flag</span> is <i>complete</i>, and act as if that was the fetched resource, ignoring the
        resource obtained from the network.</p>

       </dd>

      </dl>

      <p>User agents may warn the user of these errors as an aid to development.</p>

      <p class="note">These rules make errors for resources listed in the manifest fatal, while
      making it possible for other resources to be removed from caches when they are removed from
      the server, without errors, and making non-manifest resources survive server-side errors.</p>

      <p class="note">Except for the "no-store" directive, HTTP caching rules that would cause a
      file to be expired or otherwise not cached are ignored for the purposes of the
      <span>application cache download process</span>.</p>

     </li>

     <li>

      <p>Otherwise, the fetching succeeded. Store the resource in the <var>new
      cache</var>.</p>

      <p>If the user agent is not able to store the resource (e.g. because of quota restrictions),
      the user agent may prompt the user or try to resolve the problem in some other manner (e.g.
      automatically pruning content in other caches). If the problem cannot be resolved, the user
      agent must run the <span>cache failure steps</span>.</p>

     </li>

     <li><p>If the URL being processed was flagged as an "explicit entry" in <var>file
     list</var>, then categorize the entry as an <span data-x="concept-appcache-explicit">explicit
     entry</span>.</p></li>

     <li><p>If the URL being processed was flagged as a "fallback entry" in <var>file
     list</var>, then categorize the entry as a <span data-x="concept-appcache-fallback">fallback
     entry</span>.</p></li>

     <li><p>If the URL being processed was flagged as an "master entry" in <var>file
     list</var>, then categorize the entry as a <span data-x="concept-appcache-master">master
     entry</span>.</p></li>

     <li><p>As an optimization, if the resource is an HTML or XML file whose root element is an
     <code>html</code> element with a <code data-x="attr-html-manifest">manifest</code> attribute
     whose value doesn't match the manifest URL of the application cache being processed, then the
     user agent should mark the entry as being <span
     data-x="concept-appcache-foreign">foreign</span>.</p>

    </ol>

   </li>

   <li><p>For each <span>cache host</span> associated with an <span>application cache</span> in <var>cache group</var>, <span>queue a progress post-load task</span> to <span
   data-x="concept-event-fire">fire</span> a <span data-x="concept-events-trusted">trusted</span>
   event with the name <code data-x="event-appcache-progress">progress</code>, which does not bubble,
   which is cancelable, and which uses the <code>ProgressEvent</code> interface, at the
   <code>ApplicationCache</code> singleton of the <span>cache host</span>. The <code
   data-x="dom-ProgressEvent-lengthComputable">lengthComputable</code> attribute must be set to
   true, the <code data-x="dom-ProgressEvent-total">total</code> and the <code
   data-x="dom-ProgressEvent-loaded">loaded</code> attributes must be set to the number of files in
   <var>file list</var>. The default action of these events must be, if the user agent
   <span>shows caching progress</span>, the display of some sort of user interface indicating to the
   user that all the files have been downloaded. <a href="#refsXHR">\[XHR]</a></p></li>

   <li><p>Store the list of <span data-x="concept-appcache-fallback-ns">fallback namespaces</span>,
   and the URLs of the <span data-x="concept-appcache-fallback">fallback entries</span> that they map
   to, in <var>new cache</var>.</p></li>

   <li><p>Store the URLs that form the new <span data-x="concept-appcache-onlinesafelist">online
   safelist</span> in <var>new cache</var>.</p></li>

   <li><p>Store the value of the new <span data-x="concept-appcache-onlinesafelist-wildcard">online
   safelist wildcard flag</span> in <var>new cache</var>.</p></li>

   <li><p>Store the value of the new <span data-x="concept-appcache-mode">cache mode flag</span> in
   <var>new cache</var>.</p></li>

   <li>

    <p>For each entry in <var>cache group</var>'s <span
    data-x="concept-appcache-pending-masters">list of pending master entries</span>, wait for the
    resource for this entry to have either completely downloaded or failed.</p>

    <p>If the download failed (e.g. the server returns a 4xx or 5xx response, or there is a DNS
    error, the connection times out, or the user cancels the download), or if the resource is
    labeled with the "no-store" cache directive, then run these substeps:</p>

    <ol>

     <li><p>Unassociate the <code>Document</code> for this entry from <var>new
     cache</var>.</p></li>

     <li><p><span>Queue a post-load task</span> to <span>fire a simple event</span> that is
     cancelable named <code data-x="event-appcache-error">error</code> at the
     <code>ApplicationCache</code> singleton of the <code>Document</code> for this entry, if there
     still is one. The default action of this event must be, if the user agent <span>shows caching
     progress</span>, the display of some sort of user interface indicating to the user that the
     user agent failed to save the application for offline use.</p>

     <li>

      <p>If this is a <span data-x="concept-appcache-cache">cache attempt</span> and this entry is
      the last entry in <var>cache group</var>'s <span
      data-x="concept-appcache-pending-masters">list of pending master entries</span>, then run these
      further substeps:</p>

      <ol>

       <li><p>Discard <var>cache group</var> and its only <span>application cache</span>,
       <var>new cache</var>.</p>

       <li><p>If appropriate, remove any user interface indicating that an update for this cache is
       in progress.</p></li>

       <li><p>Abort the <span>application cache download process</span>.</p></li>

      </ol>

     </li>

     <li><p>Otherwise, remove this entry from <var>cache group</var>'s <span
     data-x="concept-appcache-pending-masters">list of pending master entries</span>.</p></li>

    </ol>

    <p>Otherwise, store the resource for this entry in <var>new cache</var>, if it isn't
    already there, and categorize its entry as a <span data-x="concept-appcache-master">master
    entry</span>.</p>

   </li>

   <li><p>Let <var>request</var> be a new <span data-x="concept-request">request</span> whose
   <span data-x="concept-request-url">url</span> is <var>manifest URL</var>, <span
   data-x="concept-request-client">client</span> is null, <span
   data-x="concept-request-destination">destination</span> is "<code>subresource</code>",
   <span data-x="concept-request-referrer">referrer</span> is "<code>no-referrer</code>",
   <span>synchronous flag</span> is set, <span data-x="concept-request-credentials-mode">credentials
   mode</span> is "<code>include</code>", and whose <span>use-URL-credentials
   flag</span> is set.</p></li>

   <li>

    <!--FETCH--><p>Let <var>second manifest</var> be the result of <span
    data-x="concept-fetch">fetching</span> <var>request</var>. HTTP caching semantics should again
    be honored for this request.</p>

    <p class="note">Since caching can be honored, authors are encouraged to avoid setting the cache
    headers on the manifest in such a way that the user agent would simply not contact the network
    for this second request; otherwise, the user agent would not notice if the cache had changed
    during the cache update process.</p>

   </li>

   <li>

    <p>If the previous step failed for any reason, or if the fetching attempt involved a redirect,
    or if <var>second manifest</var> and <var>manifest</var> are not byte-for-byte
    identical, then schedule a rerun of the entire algorithm with the same parameters after a short
    delay, and run the <span>cache failure steps</span>.</p>

   </li>

   <li>

    <p>Otherwise, store <var>manifest</var> in <var>new cache</var>, if it's not
    there already, and categorize its entry as <span data-x="concept-appcache-manifest">the
    manifest</span>.</p>

   </li>

   <li><p>Set the <span data-x="concept-appcache-completeness">completeness flag</span> of <var>new cache</var> to <i>complete</i>.</p></li>

   <li><p>Let <var>task list</var> be an empty list of <span
   data-x="concept-task">tasks</span>.</p>

   <li>

    <p>If this is a <span data-x="concept-appcache-cache">cache attempt</span>, then for each
    <span>cache host</span> associated with an <span>application cache</span> in <var>cache
    group</var>, create a <span data-x="concept-task">task</span> to <span>fire a simple event</span>
    that is cancelable named <code data-x="event-appcache-cached">cached</code> at the
    <code>ApplicationCache</code> singleton of the <span>cache host</span>, and append it to <var>task list</var>. The default action of these events must be, if the user agent
    <span>shows caching progress</span>, the display of some sort of user interface indicating to
    the user that the application has been cached and that they can now use it offline.</p>

    <p>Otherwise, it is an <span data-x="concept-appcache-upgrade">upgrade attempt</span>. For each
    <span>cache host</span> associated with an <span>application cache</span> in <var>cache
    group</var>, create a <span data-x="concept-task">task</span> to <span>fire a simple event</span>
    that is cancelable named <code data-x="event-appcache-updateready">updateready</code> at the
    <code>ApplicationCache</code> singleton of the <span>cache host</span>, and append it to <var>task list</var>. The default action of these events must be, if the user agent
    <span>shows caching progress</span>, the display of some sort of user interface indicating to
    the user that a new version is available and that they can activate it by reloading the
    page.</p>

   </li>

   <li><p>If appropriate, remove any user interface indicating that an update for this cache is in
   progress.</p></li>

   <li><p>Set the <span data-x="concept-appcache-status">update status</span> of <var>cache
   group</var> to <i>idle</i>.</p></li>

   <li><p>For each <span data-x="concept-task">task</span> in <var>task list</var>, <span
   data-x="queue a post-load task">queue that task as a post-load task</span>.</p></li>

  </ol>

  <p>The <dfn>cache failure steps</dfn> are as follows:</p>

  <ol>

   <li><p>Let <var>task list</var> be an empty list of <span
   data-x="concept-task">tasks</span>.</p>

   <li>

    <p>For each entry in <var>cache group</var>'s <span
    data-x="concept-appcache-pending-masters">list of pending master entries</span>, run the
    following further substeps. These steps may be run in parallel for two or more entries at a
    time.</p>

    <ol>

     <li><p>Wait for the resource for this entry to have either completely downloaded or failed.</p>

     <li><p>Unassociate the <code>Document</code> for this entry from its <span>application
     cache</span>, if it has one.</p></li>

     <li><p>Create a <span data-x="concept-task">task</span> to <span>fire a simple event</span> that
     is cancelable named <code data-x="event-appcache-error">error</code> at the
     <code>ApplicationCache</code> singleton of the <code>Document</code> for this entry, if there
     still is one, and append it to <var>task list</var>. The default action of these
     events must be, if the user agent <span>shows caching progress</span>, the display of some sort
     of user interface indicating to the user that the user agent failed to save the application for
     offline use.</p>

    </ol>

   </li>

   <li><p>For each <span>cache host</span> still associated with an <span>application cache</span>
   in <var>cache group</var>, create a <span data-x="concept-task">task</span> to <span>fire
   a simple event</span> that is cancelable named <code data-x="event-appcache-error">error</code> at
   the <code>ApplicationCache</code> singleton of the <span>cache host</span>, and append it to <var>task list</var>. The default action of these events must be, if the user agent
   <span>shows caching progress</span>, the display of some sort of user interface indicating to the
   user that the user agent failed to save the application for offline use.</p></li>

   <li><p>Empty <var>cache group</var>'s <span
   data-x="concept-appcache-pending-masters">list of pending master entries</span>.</p></li>

   <li><p>If <var>cache group</var> has an <span>application cache</span> whose <span
   data-x="concept-appcache-completeness">completeness flag</span> is <i>incomplete</i>, then discard
   that <span>application cache</span>.</p>

   <li><p>If appropriate, remove any user interface indicating that an update for this cache is in
   progress.</p></li>

   <li><p>Let the <span data-x="concept-appcache-status">status</span> of <var>cache
   group</var> be <i>idle</i>.</p></li>

   <li><p>If this was a <span data-x="concept-appcache-cache">cache attempt</span>, discard <var>cache group</var> altogether.</p>

   <li><p>For each <span data-x="concept-task">task</span> in <var>task list</var>, <span
   data-x="queue a post-load task">queue that task as a post-load task</span>.</p></li>

   <li><p>Abort the <span>application cache download process</span>.</p></li>

  </ol>

  <p>Attempts to fetch resources as part of the <span>application cache download process</span> may
  be done with cache-defeating semantics, to avoid problems with stale or inconsistent intermediary
  caches.</p>

  <hr>

  <p>User agents may invoke the <span>application cache download process</span>, in the background,
  for any <span>application cache group</span>, at any time (with no <span>cache host</span>). This
  allows user agents to keep caches primed and to update caches even before the user visits a
  site.</p>

  <hr>

  <p>Each <code>Document</code> has a list of <dfn>pending application cache download process
  tasks</dfn> that is used to delay events fired by the algorithm above until the document's <code
  data-x="event-load">load</code> event has fired. When the <code>Document</code> is created, the
  list must be empty.</p>

  <p>When the steps above say to <dfn>queue a post-load task</dfn> <var>task</var>, where
  <var>task</var> is a <span data-x="concept-task">task</span> that dispatches an event on a
  target <code>ApplicationCache</code> object <var>target</var>, the user agent must run
  the appropriate steps from the following list:</p>

  <dl>

   <dt>If <var>target</var>'s <span>node document</span> is
   <span>ready for post-load tasks</span></dt>

   <dd><p><span data-x="queue a task">Queue</span> the task <var>task</var>.</p></dd>

   <dt>Otherwise</dt>

   <dd><p>Add <var>task</var> to <var>target</var>'s <span>node document</span>'s list
   of <span>pending application cache download process tasks</span>.</p></dd>

  </dl>

  <p>When the steps above say to <dfn>queue a progress post-load task</dfn> <var>task</var>, where
  <var>task</var> is a <span data-x="concept-task">task</span> that dispatches an event on a
  target <code>ApplicationCache</code> object <var>target</var>, the user agent must run
  the following steps:</p>

  <ol>

   <li><p>If there is a <var>task</var> in <var>target</var>'s <span>node document</span>'s list
   of <span>pending application cache download process tasks</span> that is labeled as a
   <i>progress task</i>, then remove that task from the list.</p></li>

   <li><p>Label <var>task</var> as a <i>progress task</i>.</p></li>

   <li><p><span>Queue a post-load task</span> <var>task</var>.</p></li>

  </ol>

  <p>The <span>task source</span> for these <span data-x="concept-task">tasks</span> is the
  <span>networking task source</span>.</p>




  <h4 id="the-application-cache-selection-algorithm">The application cache selection algorithm</h4>

  <p>When the <dfn data-x="concept-appcache-init">application cache selection algorithm</dfn>
  algorithm is invoked with a <code>Document</code> <var>document</var> and optionally a
  manifest <span>URL</span> <var>manifest URL</var>, the user agent must run the first
  applicable set of steps from the following list:</p>

  <dl class="switch">

   <dt>If there is a <var>manifest URL</var>, and <var>document</var> was loaded
   from an <span>application cache</span>, and the URL of the <span
   data-x="concept-appcache-manifest">manifest</span> of that cache's <span>application cache
   group</span> is <em>not</em> the same as <var>manifest URL</var></dt>

   <dd>

    <p>Mark the entry for the resource from which <var>document</var> was taken in the
    <span>application cache</span> from which it was loaded as <span
    data-x="concept-appcache-foreign">foreign</span>.</p>

    <p>Restart the current navigation from the top of the <span data-x="navigate">navigation
    algorithm</span>, undoing any changes that were made as part of the initial load (changes can be
    avoided by ensuring that the step to <span>update the session history with the new page</span>
    is only ever completed <em>after</em> this <span data-x="concept-appcache-init">application cache
    selection algorithm</span> is run, though this is not required).</p>

    <p class="note">The navigation will not result in the same resource being loaded, because
    "foreign" entries are never picked during navigation.</p>

    <p>User agents may notify the user of the inconsistency between the cache manifest and the
    document's own metadata, to aid in application development.</p>

   </dd>


   <dt>If <var>document</var> was loaded from an <span>application cache</span>, and that
   <span>application cache</span> still exists (it is not now <span
   data-x="concept-appcache-obsolete">obsolete</span>)<!--[redundant], and either there is no <var>manifest URL</var>, or the URL of the <span
   data-x="concept-appcache-manifest">manifest</span> of the cache's <span>application cache
   group</span> is the same as <var>manifest URL</var>--></dt>

   <dd>

    <p>Associate <var>document</var> with the <span>application cache</span> from which it
    was loaded. Invoke, in the background, the <span>application cache download process</span> for
    that <span>application cache</span>'s <span>application cache group</span>, with <var>document</var> as the <span>cache host</span>.</p>

   </dd>


   <dt>If <var>document</var> <!--[redundant] was not loaded from an <span>application
   cache</span>, but it--> was loaded using <code>GET</code>, and, there is a
   <var>manifest URL</var>, and <var>manifest URL</var> has the <span>same origin</span> as
   <var>document</var></dt>

   <dd>

    <p>Invoke, in the background, the <span>application cache download process</span> for <var>manifest URL</var>, with <var>document</var> as the <span>cache host</span>
    and with the resource from which <var>document</var> was parsed as the <span
    data-x="concept-appcache-master">master</span> resource.</p>

    <p>If there are <span data-x="relevant application cache">relevant application caches</span> that
    are identified by a URL with the <span>same origin</span> as the URL of <var>document</var>, and that have this URL as one of their entries, excluding entries
    marked as <span data-x="concept-appcache-foreign">foreign</span>, then the user agent should use
    the <span data-x="concept-appcache-selection">most appropriate application cache</span> of those
    that match as an HTTP cache for any subresource loads. User agents may also have other caches in
    place that are also honored.</p>

   </dd>


   <dt>Otherwise</dt> <!-- not from cache and either no <var>manifest URL</var>, or
   non-GET, or wrong-origin manifest -->

   <dd>

    <p>The <code>Document</code> is not associated with any <span>application cache</span>.</p>

    <p>If there was a <var>manifest URL</var>, the user agent may report to the user that
    it was ignored, to aid in application development.</p>

   </dd>

  </dl>



  <h4 id="changesToNetworkingModel">Changes to the networking model</h4>

  <!--FETCH--><p class="&#x0058;&#x0058;&#x0058;">If "AppCache" is not removed as a feature this
  section needs to be integrated into the Fetch standard.</p>

  <p>When a <span>cache host</span> is associated with an <span>application cache</span> whose <span
  data-x="concept-appcache-completeness">completeness flag</span> is <i>complete</i>, any and all
  loads for resources related to that <span>cache host</span> other than those for <span
  data-x="child browsing context">child browsing contexts</span> must go through the following steps
  instead of immediately invoking the mechanisms appropriate to that resource's scheme:</p>

  <ol>

   <li><p>If the resource is not to be fetched using the GET method, or if applying the <span>URL
   parser</span> algorithm to both its <span>URL</span> and the <span>application cache</span>'s
   <span data-x="concept-appcache-manifest">manifest</span>'s URL results in two <span data-x="parsed
   URL">parsed URLs</span> with different <span data-x="concept-url-scheme">scheme</span> components,
   then fetch the resource normally and abort these steps.</p></li>

   <li><p>If the resource's URL is <span data-x="concept-appcache-master">a master entry</span>,
   <span data-x="concept-appcache-manifest">the manifest</span>, <span
   data-x="concept-appcache-explicit">an explicit entry</span>, or <span
   data-x="concept-appcache-fallback">a fallback entry</span> in the <span>application cache</span>,
   then get the resource from the cache (instead of fetching it), and abort these steps.</p></li>

   <li><p>If there is an entry in the <span>application cache</span>'s <span
   data-x="concept-appcache-onlinesafelist">online safelist</span> that has the <span>same
   origin</span> as the resource's URL and that is a <span>prefix match</span> for the resource's
   URL, then fetch the resource normally and abort these steps.</p></li>

   <li>

    <p>If the resource's URL has the <span>same origin</span> as the manifest's URL, and there is a
    <span data-x="concept-appcache-fallback-ns">fallback namespace</span> <var>f</var> in
    the <span>application cache</span> that is a <span>prefix match</span> for the resource's URL,
    then:</p>

    <p>Fetch the resource normally. If this results in a redirect to a resource with another
    <span>origin</span> (indicative of a captive portal), or a 4xx or 5xx status code, or if there
    were network errors (but not if the user canceled the download), then instead get, from the
    cache, the resource of the <span data-x="concept-appcache-fallback">fallback entry</span>
    corresponding to the <span data-x="concept-appcache-fallback-ns">fallback namespace</span>
    <var>f</var>. Abort these steps.</p>

   </li>

   <li><p>If the <span>application cache</span>'s <span
   data-x="concept-appcache-onlinesafelist-wildcard">online safelist wildcard flag</span> is
   <i>open</i>, then fetch the resource normally and abort these steps.</p></li>

   <li><p>Fail the resource load as if there had been a generic network error.</p></li>

  </ol>

  <p class="note">The above algorithm ensures that so long as the <span
  data-x="concept-appcache-onlinesafelist-wildcard">online safelist wildcard flag</span> is
  <i>blocking</i>, resources that are not present in the <span
  data-x="concept-appcache-manifest">manifest</span> will always fail to load (at least, after the
  <span>application cache</span> has been primed the first time), making the testing of offline
  applications simpler.</p>

  </div>


  <div class="impl">

  <h4 id="expiring-application-caches">Expiring application caches</h4>

  <p>As a general rule, user agents should not expire application caches, except on request from the
  user, or after having been left unused for an extended period of time.</p>

  <p>Application caches and cookies have similar implications with respect to privacy (e.g. if the
  site can identify the user when providing the cache, it can store data in the cache that can be
  used for cookie resurrection). Implementors are therefore encouraged to expose application caches
  in a manner related to HTTP cookies, allowing caches to be expunged together with cookies and
  other origin-specific data.</p>

  <p class="example">For example, a user agent could have a "delete site-specific data" feature that
  clears all cookies, application caches, local storage, databases, etc, from an origin all at
  once.</p>

  </div>


  <div class="impl">

  <h4 id="disk-space">Disk space</h4>

  <p>User agents should consider applying constraints on disk usage of <span data-x="application
  cache">application caches</span>, and care should be taken to ensure that the restrictions cannot
  be easily worked around using subdomains.</p>

  <p>User agents should allow users to see how much space each domain is using, and may offer the
  user the ability to delete specific <span data-x="application cache">application caches</span>.</p>

  <p>For predictability, quotas should be based on the uncompressed size of data stored.</p>
  <!-- see https://www.w3.org/Bugs/Public/show_bug.cgi?id=21319#c3 -->

  <p class="note">How quotas are presented to the user is not defined by this specification. User
  agents are encouraged to provide features such as allowing a user to indicate that certain sites
  are trusted to use more than the default quota, e.g. by presenting a non-modal user interface
  while a cache is being updated, or by having an explicit safelist in the user agent's
  configuration interface.</p>

  </div>


<!--ADD-TOPIC:Security-->
  <h4 id="security-concerns-with-offline-applications-caches">Security concerns with offline applications caches</h4>

  <p><em>This section is non-normative.</em></p>

  <p>The main risk introduced by offline application caches is that an injection attack can be
  elevated into persistent site-wide page replacement. This attack involves using an injection
  vulnerability to upload two files to the victim site. The first file is an application cache
  manifest consisting of just a fallback entry pointing to the second file, which is an HTML page
  whose manifest is declared as that first file. Once the user has been directed to that second
  file, all subsequent accesses to any file covered by the given fallback namespace while either the
  user or the site is offline will instead show that second file. Targeted denial-of-service
  attacks or cookie bombing attacks (where the client is made to send so many cookies that the
  server refuses to process the request) can be used to ensure that the site appears offline.</p>

  <p>To mitigate this, manifests can only specify fallbacks that are in the same path as the
  manifest itself. This means that a content injection upload vulnerability in a particular
  directory on a server can only be escalated to a take-over of that directory and its
  subdirectories. If there is no way to inject a file into the root directory, the entire site
  cannot be taken over.</p>

  <p>If a site has been attacked in this way, simply removing the offending manifest might eventually
  clear the problem, since the next time the manifest is updated, a 404 error will be seen, and the
  user agent will clear the cache. "Eventually" is the key word here, however; while the attack on
  the user or server is ongoing, such that connections from an affected user to the affected site
  are blocked, the user agent will simply assume that the user is offline and will continue to use
  the hostile manifest. Unfortunately, if a cookie bombing attack has also been used, merely
  removing the manifest is insufficient; in addition, the server has to be configured to return a
  404 or 410 response instead of the 413 "Request Entity Too Large" response.</p>

  <p>TLS does not inherently protect a site from this attack, since the attack relies on content
  being served from the server itself. Not using application caches also does not prevent this
  attack, since the attack relies on an attacker-provided manifest.</p>
<!--REMOVE-TOPIC:Security-->


  <h4 id="application-cache-api">Application cache API</h4>

  <pre class="idl">[Exposed=(Window, SharedWorker)]
interface <dfn>ApplicationCache</dfn> : <span>EventTarget</span> {

  // <span data-x="concept-appcache-status">update status</span>
  const unsigned short <span data-x="dom-appcache-UNCACHED">UNCACHED</span> = 0;
  const unsigned short <span data-x="dom-appcache-IDLE">IDLE</span> = 1;
  const unsigned short <span data-x="dom-appcache-CHECKING">CHECKING</span> = 2;
  const unsigned short <span data-x="dom-appcache-DOWNLOADING">DOWNLOADING</span> = 3;
  const unsigned short <span data-x="dom-appcache-UPDATEREADY">UPDATEREADY</span> = 4;
  const unsigned short <span data-x="dom-appcache-OBSOLETE">OBSOLETE</span> = 5;
  readonly attribute unsigned short <span data-x="dom-appcache-status">status</span>;

  // updates
  void <span data-x="dom-appcache-update">update</span>();
  void <span data-x="dom-appcache-abort">abort</span>();
  void <span data-x="dom-appcache-swapCache">swapCache</span>();

  // events
  attribute <span>EventHandler</span> <span data-x="handler-appcache-onchecking">onchecking</span>;
  attribute <span>EventHandler</span> <span data-x="handler-appcache-onerror">onerror</span>;
  attribute <span>EventHandler</span> <span data-x="handler-appcache-onnoupdate">onnoupdate</span>;
  attribute <span>EventHandler</span> <span data-x="handler-appcache-ondownloading">ondownloading</span>;
  attribute <span>EventHandler</span> <span data-x="handler-appcache-onprogress">onprogress</span>;
  attribute <span>EventHandler</span> <span data-x="handler-appcache-onupdateready">onupdateready</span>;
  attribute <span>EventHandler</span> <span data-x="handler-appcache-oncached">oncached</span>;
  attribute <span>EventHandler</span> <span data-x="handler-appcache-onobsolete">onobsolete</span>;
};</pre>

  <dl class="domintro">

   <dt><var>cache</var> = <var>window</var> . <code subdfn data-x="dom-applicationCache">applicationCache</code></dt>
   <dd>

    <p>(In a window.) Returns the <code>ApplicationCache</code> object that applies to the
    <span>active document</span> of that <code>Window</code>.</p>

   </dd>

   <dt><var>cache</var> = <var>self</var> . <code data-x="dom-applicationCache">applicationCache</code></dt> <dd>

    <p>(In a shared worker.) Returns the <code>ApplicationCache</code> object that applies to the
    current shared worker.</p>

   </dd>

   <dt><var>cache</var> . <code subdfn data-x="dom-appcache-status">status</code></dt>
   <dd>

    <p>Returns the current status of the application cache, as given by the constants defined
    below.</p>

   </dd>

   <dt><var>cache</var> . <code subdfn data-x="dom-appcache-update">update</code>()</dt>
   <dd>

    <p>Invokes the <span>application cache download process</span>.</p>

    <p>Throws an <code>InvalidStateError</code> exception if there is no application cache to
    update.</p>

    <p>Calling this method is not usually necessary, as user agents will generally take care of
    updating <span data-x="application cache">application caches</span> automatically.</p>

    <p>The method can be useful in situations such as long-lived applications. For example, a Web
    mail application might stay open in a browser tab for weeks at a time. Such an application could
    want to test for updates each day.</p>

   </dd>

   <dt><var>cache</var> . <code subdfn data-x="dom-appcache-abort">abort</code>()</dt>
   <dd>

    <p>Cancels the <span>application cache download process</span>.</p>

    <p>This method is intended to be used by Web application showing their own caching progress UI,
    in case the user wants to stop the update (e.g. because bandwidth is limited).</p>

   </dd>

   <dt><var>cache</var> . <code subdfn data-x="dom-appcache-swapCache">swapCache</code>()</dt>
   <dd>

    <p>Switches to the most recent application cache, if there is a newer one. If there isn't,
    throws an <code>InvalidStateError</code> exception.</p>

    <p>This does not cause previously-loaded resources to be reloaded; for example, images do not
    suddenly get reloaded and style sheets and scripts do not get reparsed or reevaluated. The only
    change is that subsequent requests for cached resources will obtain the newer copies.</p>

    <p>The <code data-x="event-appcache-updateready">updateready</code> event will fire before this
    method can be called. Once it fires, the Web application can, at its leisure, call this method
    to switch the underlying cache to the one with the more recent updates. To make proper use of
    this, applications have to be able to bring the new features into play; for example, reloading
    scripts to enable new features.</p>

    <p>An easier alternative to <code data-x="dom-appcache-swapCache">swapCache()</code> is just to
    reload the entire page at a time suitable for the user, using <code
    data-x="dom-location-reload">location.reload()</code>.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>There is a one-to-one mapping from <span data-x="cache host">cache hosts</span> to
  <code>ApplicationCache</code> objects. The <dfn><code data-x="dom-applicationCache">applicationCache</code></dfn> attribute on <code>Window</code>
  objects must return the <code>ApplicationCache</code> object associated with the
  <code>Window</code> object's <span>active document</span>. The <dfn><code data-x="dom-SharedWorkerGlobalScope-applicationCache">applicationCache</code></dfn> attribute
  on <code>SharedWorkerGlobalScope</code> objects must return the <code>ApplicationCache</code>
  object associated with the worker.</p>

  <p class="note">A <code>Window</code> or <code>SharedWorkerGlobalScope</code> object has an
  associated <code>ApplicationCache</code> object even if that <span>cache host</span> has no actual
  <span>application cache</span>.</p>

  <hr>

  <p>The <dfn><code data-x="dom-appcache-status">status</code></dfn> attribute, on getting, must
  return the current state of the <span>application cache</span> that the
  <code>ApplicationCache</code> object's <span>cache host</span> is associated with, if any. This
  must be the appropriate value from the following list:</p>

  </div>

  <dl>

   <dt><dfn><code data-x="dom-appcache-UNCACHED">UNCACHED</code></dfn> (numeric value 0)</dt>

   <dd><p>The <code>ApplicationCache</code> object's <span>cache host</span> is not associated with
   an <span>application cache</span> at this time.</p></dd>

   <dt><dfn><code data-x="dom-appcache-IDLE">IDLE</code></dfn> (numeric value 1)</dt>

   <dd><p>The <code>ApplicationCache</code> object's <span>cache host</span> is associated with an
   <span>application cache</span> whose <span>application cache group</span>'s <span
   data-x="concept-appcache-status">update status</span> is <i>idle</i>, and that <span>application
   cache</span> is the <span data-x="concept-appcache-newer">newest</span> cache in its
   <span>application cache group</span>, and the <span>application cache group</span> is not marked
   as <span data-x="concept-appcache-obsolete">obsolete</span>.</p></dd>

   <dt><dfn><code data-x="dom-appcache-CHECKING">CHECKING</code></dfn> (numeric value 2)</dt>

   <dd><p>The <code>ApplicationCache</code> object's <span>cache host</span> is associated with an
   <span>application cache</span> whose <span>application cache group</span>'s <span
   data-x="concept-appcache-status">update status</span> is <i>checking</i>.</p></dd>

   <dt><dfn><code data-x="dom-appcache-DOWNLOADING">DOWNLOADING</code></dfn> (numeric value 3)</dt>

   <dd><p>The <code>ApplicationCache</code> object's <span>cache host</span> is associated with an
   <span>application cache</span> whose <span>application cache group</span>'s <span
   data-x="concept-appcache-status">update status</span> is <i>downloading</i>.</p></dd>

   <dt><dfn><code data-x="dom-appcache-UPDATEREADY">UPDATEREADY</code></dfn> (numeric value 4)</dt>

   <dd><p>The <code>ApplicationCache</code> object's <span>cache host</span> is associated with an
   <span>application cache</span> whose <span>application cache group</span>'s <span
   data-x="concept-appcache-status">update status</span> is <i>idle</i>, and whose <span>application
   cache group</span> is not marked as <span data-x="concept-appcache-obsolete">obsolete</span>, but
   that <span>application cache</span> is <em>not</em> the <span
   data-x="concept-appcache-newer">newest</span> cache in its group.</p></dd>

   <dt><dfn><code data-x="dom-appcache-OBSOLETE">OBSOLETE</code></dfn> (numeric value 5)</dt>

   <dd><p>The <code>ApplicationCache</code> object's <span>cache host</span> is associated with an
   <span>application cache</span> whose <span>application cache group</span> is marked as <span
   data-x="concept-appcache-obsolete">obsolete</span>.</p></dd>

  </dl>

  <div class="impl">

  <hr>

  <p>If the <dfn><code data-x="dom-appcache-update">update()</code></dfn> method is invoked, the user
  agent must invoke the <span>application cache download process</span>, in the background, for the
  <span>application cache group</span> of the <span>application cache</span> with which the
  <code>ApplicationCache</code> object's <span>cache host</span> is associated, but without giving
  that <span>cache host</span> to the algorithm. If there is no such <span>application cache</span>,
  or if its <span>application cache group</span> is marked as <span
  data-x="concept-appcache-obsolete">obsolete</span>, then the method must throw an
  <code>InvalidStateError</code> exception instead.</p>

  <p>If the <dfn><code data-x="dom-appcache-abort">abort()</code></dfn> method is invoked, the user
  agent must <dfn>send a signal</dfn> to the current <span>application cache download process</span>
  for the <span>application cache group</span> of the <span>application cache</span> with which the
  <code>ApplicationCache</code> object's <span>cache host</span> is associated, if any. If there is
  no such <span>application cache</span>, or it does not have a current <span>application cache
  download process</span>, then do nothing.</p>

  <p>If the <dfn><code data-x="dom-appcache-swapCache">swapCache()</code></dfn> method is invoked,
  the user agent must run the following steps:

  <ol>

   <li><p>Check that <code>ApplicationCache</code> object's <span>cache host</span> is associated
   with an <span>application cache</span>. If it is not, then throw an
   <code>InvalidStateError</code> exception and abort these steps.</p></li>

   <li><p>Let <var>cache</var> be the <span>application cache</span> with which the
   <code>ApplicationCache</code> object's <span>cache host</span> is associated. (By definition,
   this is the same as the one that was found in the previous step.)</p></li>

   <li><p>If <var>cache</var>'s <span>application cache group</span> is marked as <span
   data-x="concept-appcache-obsolete">obsolete</span>, then unassociate the
   <code>ApplicationCache</code> object's <span>cache host</span> from <var>cache</var> and
   abort these steps. (Resources will now load from the network instead of the cache.)</p></li>

   <li><p>Check that there is an application cache in the same <span>application cache group</span>
   as <var>cache</var> whose <span data-x="concept-appcache-completeness">completeness
   flag</span> is <i>complete</i> and that is <span data-x="concept-appcache-newer">newer</span> than
   <var>cache</var>. If there is not, then throw an <code>InvalidStateError</code>
   exception and abort these steps.</p></li>

   <li><p>Let <var>new cache</var> be the <span
   data-x="concept-appcache-newer">newest</span> <span>application cache</span> in the same
   <span>application cache group</span> as <var>cache</var> whose <span
   data-x="concept-appcache-completeness">completeness flag</span> is <i>complete</i>.</p></li>

   <li><p>Unassociate the <code>ApplicationCache</code> object's <span>cache host</span> from <var>cache</var> and instead associate it with <var>new cache</var>.</p></li>

  </ol>

  <p>The following are the <span>event handlers</span> (and their corresponding <span data-x="event
  handler event type">event handler event types</span>) <span class="impl">that must be</span>
  supported, as <span>event handler IDL attributes</span>, by all objects implementing the
  <code>ApplicationCache</code> interface:</p>

  <table>
   <thead>
    <tr><th><span data-x="event handlers">Event handler</span> <th><span>Event handler event type</span>
   <tbody>
    <tr><td><dfn><code data-x="handler-appcache-onchecking">onchecking</code></dfn> <td> <code data-x="event-appcache-checking">checking</code>
    <tr><td><dfn><code data-x="handler-appcache-onerror">onerror</code></dfn> <td> <code data-x="event-appcache-error">error</code>
    <tr><td><dfn><code data-x="handler-appcache-onnoupdate">onnoupdate</code></dfn> <td> <code data-x="event-appcache-noupdate">noupdate</code>
    <tr><td><dfn><code data-x="handler-appcache-ondownloading">ondownloading</code></dfn> <td> <code data-x="event-appcache-downloading">downloading</code>
    <tr><td><dfn><code data-x="handler-appcache-onprogress">onprogress</code></dfn> <td> <code data-x="event-appcache-progress">progress</code>
    <tr><td><dfn><code data-x="handler-appcache-onupdateready">onupdateready</code></dfn> <td> <code data-x="event-appcache-updateready">updateready</code>
    <tr><td><dfn><code data-x="handler-appcache-oncached">oncached</code></dfn> <td> <code data-x="event-appcache-cached">cached</code>
    <tr><td><dfn><code data-x="handler-appcache-onobsolete">onobsolete</code></dfn> <td> <code data-x="event-appcache-obsolete">obsolete</code>
  </table>

  </div>


  <h4 id="navigator.online"><span id="browser-state">Browser state</span></h4>

  <pre class="idl">[NoInterfaceObject, Exposed=(Window, Worker)]
interface <dfn>NavigatorOnLine</dfn> {
  readonly attribute boolean <span data-x="dom-navigator-onLine">onLine</span>;
};</pre>

  <dl class="domintro">

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-onLine">onLine</code></dt>

   <dd>

    <p>Returns false if the user agent is definitely offline (disconnected from the network).
    Returns true if the user agent might be online.</p>

    <p>The events <code data-x="event-online">online</code> and <code
    data-x="event-offline">offline</code> are fired when the value of this attribute changes.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-navigator-onLine">navigator.onLine</code></dfn> attribute must return
  false if the user agent will not contact the network when the user follows links or when a script
  requests a remote page (or knows that such an attempt would fail), and must return true
  otherwise.</p>

  <p>When the value that would be returned by the <code
  data-x="dom-navigator-onLine">navigator.onLine</code> attribute of a <code>Window</code> or
  <code>WorkerGlobalScope</code> changes from true to false, the user agent must <span>queue a
  task</span> to <span>fire a simple event</span> named <code data-x="event-offline">offline</code>
  at the <code>Window</code> or <code>WorkerGlobalScope</code> object.</p>

  <p>On the other hand, when the value that would be returned by the <code
  data-x="dom-navigator-onLine">navigator.onLine</code> attribute of a <code>Window</code> or
  <code>WorkerGlobalScope</code> changes from false to true, the user agent must <span>queue a
  task</span> to <span>fire a simple event</span> named <code data-x="event-online">online</code> at
  the <code>Window</code> or <code>WorkerGlobalScope</code> object.</p>

  <p>The <span>task source</span> for these <span data-x="concept-task">tasks</span> is the
  <span>networking task source</span>.</p>

  </div>

  <p class="note">This attribute is inherently unreliable. A computer can be connected to a network
  without having Internet access.</p>

  <div class="example">

   <p>In this example, an indicator is updated as the browser goes online and offline.</p>

   <pre>&lt;!DOCTYPE HTML>
&lt;html>
 &lt;head>
  &lt;title>Online status&lt;/title>
  &lt;script>
   function updateIndicator() {
     document.getElementById('indicator').textContent = navigator.onLine ? 'online' : 'offline';
   }
  &lt;/script>
 &lt;/head>
 &lt;body onload="updateIndicator()" ononline="updateIndicator()" onoffline="updateIndicator()">
  &lt;p>The network is: &lt;span id="indicator">(state unknown)&lt;/span>
 &lt;/body>
&lt;/html></pre>

  </div>

<!--TOPIC:DOM APIs-->



<!--TOPIC:HTML-->

  <h2 id="webappapis">Web application APIs</h2>

  <h3 id="scripting">Scripting</h3>

  <h4 id="introduction">Introduction</h4>

  <p>Various mechanisms can cause author-provided executable code to run in the context of a
  document. These mechanisms include, but are probably not limited to:</p>

  <ul>

   <li>Processing of <code>script</code> elements.</li>

   <li>Navigating to <span data-x="javascript protocol"><code>javascript:</code> URLs</span>.</li>

   <li>Event handlers, whether registered through the DOM using <code
  >addEventListener()</code>, by explicit <span>event handler content attributes</span>, by
   <span>event handler IDL attributes</span>, or otherwise.</li>

   <li>Processing of technologies like SVG that have their own scripting features.</li>

  </ul>


  <div class="impl">

  <h4 id="enabling-and-disabling-scripting">Enabling and disabling scripting</h4>

  <p><dfn data-x="concept-bc-script">Scripting is enabled</dfn> in a <em><span>browsing
  context</span></em> when all of the following conditions are true:</p>

  <ul>

   <li>The user agent supports scripting.</li>

   <li>The user has not disabled scripting for this <span>browsing context</span> at this time.
   (User agents may provide users with the option to disable scripting globally, or in a
   finer-grained manner, e.g. on a per-origin basis.)
   <!--INSERT FINGERPRINT-->
   </li>

   <li id="sandboxScriptBlocked">The <span>browsing context</span>'s <span>active document</span>'s
   <span>active sandboxing flag set</span> does not have its <span>sandboxed scripts browsing
   context flag</span> set.</li>

  </ul>

  <p><dfn data-x="concept-bc-noscript">Scripting is disabled</dfn> in a <span>browsing context</span>
  when any of the above conditions are false (i.e. when scripting is not <span
  data-x="concept-bc-script">enabled</span>).</p>

  <hr>

  <p><dfn data-x="concept-n-script">Scripting is enabled</dfn> for a <em>node</em> if the
  <code>Document</code> object of the node (the node itself, if it is itself a <code>Document</code>
  object) has an associated <span>browsing context</span>, and <span
  data-x="concept-bc-script">scripting is enabled</span> in that <span>browsing context</span>.</p>

  <p><dfn data-x="concept-n-noscript">Scripting is disabled</dfn> for a node if there is no such
  <span>browsing context</span>, or if <span data-x="concept-bc-noscript">scripting is
  disabled</span> in that <span>browsing context</span>.</p>

  </div>


  <div class="impl">

  <!-- SCRIPT EXEC (marks areas related to creation of scripts) -->
  <h4 id="processing-model">Processing model</h4>

  <h5 id="definitions">Definitions</h5>

  <p>This specification describes three kinds of <span data-x="JavaScript global
  environment">JavaScript global environments</span>: the <dfn>document environment</dfn>, the
  <dfn>dedicated worker environment</dfn>, and the <dfn>shared worker environment</dfn>. The
  <span>dedicated worker environment</span> and the <span>shared worker environment</span> are both
  types of <dfn data-x="worker environment">worker environments</dfn>.</p>

  <p>Except where otherwise specified, a <span>JavaScript global environment</span> is a
  <span>document environment</span>.</p> <!-- note that we never actually say where one of these is
  created... -->

  <hr>

  <p>A <dfn data-x="concept-script">script</dfn> has:</p>

  <dl>

   <dt>A <dfn>code entry-point</dfn></dt>

   <dd>

    <p>A code entry-point represents a block of executable code that the script exposes to other
    scripts and to the user agent. Typically, the code corresponding to the code entry-point is
    executed immediately after the script is parsed, but for event handlers, it is called each time
    the handler is invoked.</p>

    <p class="example">In JavaScript <code>script</code> blocks, this corresponds to the execution
    context of the global code.</p>

   </dd>

   <dt>Optionally, a <dfn>muted errors</dfn> flag</dt>

   <dd>

    <p>A flag which, if set, means that error information will not be provided for errors in this
    script (used to mute errors for cross-origin scripts, since that can leak private
    information).</p>

   </dd>

   <dt>A <dfn>settings object</dfn></dt>

   <dd>

    <p>An <span>environment settings object</span>, various settings that are shared with other scripts in
    the same context.</p>

   </dd>

  </dl>

  <hr>

  <p>An <dfn>environment settings object</dfn> specifies algorithms for obtaining the following:</p>

  <dl>

   <dt>A <dfn>script execution environment</dfn> for each language supported by the user agent</dt>

   <dd>

    <p>The characteristics of the script execution environment depend on the language, and are not
    defined by this specification.</p>

    <p class="example">In JavaScript, the script execution environment consists of the interpreter,
    the stack of <i>execution contexts</i>, the <i>global code</i> and <i>function code</i> and the
    <code data-x="idl-Function">Function</code> objects resulting, and so forth.</p>

   </dd>

   <dt>A <dfn>global object</dfn></dt>
   <dd>

    <p>An object that provides the APIs that can be called by the code in scripts that use this
    <span data-x="environment settings object">settings object</span>.</p>

    <p class="note">This is typically a <code>Window</code> object or a
    <code>WorkerGlobalScope</code> object. When a <span>global object</span> is an empty object, it
    can't do anything that interacts with the environment.</p>

    <p>If the <span>global object</span> is a <code>Window</code> object, then, in JavaScript, the
    ThisBinding of the global execution context for this script must be the <code>Window</code>
    object's <code>WindowProxy</code> object, rather than the global object. <a
    href="#refsECMA262">\[ECMA262]</a></p>

    <p class="note">This is a <span>willful violation</span> of the JavaScript specification current
    at the time of writing (ECMAScript edition 5, as defined in section 10.4.1.1 Initial Global
    Execution Context, step 3). The JavaScript specification requires that the <code
   >this</code> keyword in the global scope return the global object, but this is not
    compatible with the security design prevalent in implementations as specified herein. <a
    href="#refsECMA262">\[ECMA262]</a></p>

   </dd>

   <dt>A <dfn>responsible browsing context</dfn></dt>

   <dd>

    <p>A <span>browsing context</span> that is assigned responsibility for actions taken by the
    scripts that use this <span>environment settings object</span>.</p>

    <p class="example">When a script creates and <span data-x="navigate">navigates</span> a new
    <span>top-level browsing context</span>, the <code data-x="dom-opener">opener</code> attribute
    of the new <span>browsing context</span>'s <code>Window</code> object will be set to the
    <span>responsible browsing context</span>'s <code>WindowProxy</code> object.</p>

   </dd>

   <dt>A <dfn>responsible event loop</dfn></dt>

   <dd>

    <p>An <span>event loop</span> that is used when it would not be immediately clear what event
    loop to use.</p>

   </dd>

   <dt>A <dfn>responsible document</dfn></dt>

   <dd>

    <p>A <code>Document</code> that is assigned responsibility for actions taken by the scripts that
    use this <span>environment settings object</span>.</p>

    <p class="example">For example, the <span data-x="the document's address">address</span> of the
    <span>responsible document</span> is used to set the <span data-x="the document's
    address">address</span> of the <code>Document</code> after it has been reset using <code
    data-x="dom-document-open">document.open()</code>.</p>

    <p>If the <span>responsible event loop</span> is not a <span>browsing context</span> <span>event loop</span>,
    then the <span>environment settings object</span> has no <span>responsible document</span>.</p>

   </dd>

   <dt>An <dfn>API URL character encoding</dfn></dt>

   <dd>

    <p>A character encoding used to encode URLs by APIs called by scripts that use this <span>environment
    settings object</span>.</p>

   </dd>

   <dt>An <dfn>API base URL</dfn></dt>

   <dd>

    <p>An <span>absolute URL</span> used by APIs called by scripts that use this <span>environment
    settings object</span> to resolve <span data-x="relative URL">relative URLs</span>.</p>

   </dd>

   <dt>An <span>origin</span> and an <span>effective script origin</span></dt>

   <dd>

    <p>An instrument used in security checks.</p>

   </dd>

   <dt>A <dfn>creation URL</dfn></dt>

   <dd>
    <p>An <span>absolute URL</span> representing the location of the resource with which the
    <span>environment settings object</span> is associated. Note that this URL might be distinct
    from the resource's current URL, due to mechanisms such as <code
    data-x="dom-history-pushstate">history.pushState()</code>.</p>
   </dd>

   <dt>An <dfn>HTTPS state</dfn></dt>

   <dd>
    <p>A value representing the security properties of the network channel used to deliver the
    resource with which the <span>environment settings object</span> is associated. The value will
    be one of "<code>modern</code>", "<code>deprecated</code>", or
    "<code>none</code>".</p>

    <p class="note">Resources delivered over HTTPS will generally have an <span>HTTPS state</span>
    of "<code>modern</code>". A user agent can use "<code>deprecated</code>"
    during transitional periods where rejecting the response entirely would be inappropriate (e.g.,
    while removing support for a hash function or cypher suite).</p>
   </dd>

  </dl>

  <p>The <dfn>relevant settings object for a global object</dfn> <var>o</var> is the
  <span>environment settings object</span> whose <span>global object</span> is <var>o</var>.
  (There is always a 1:1 mapping of global objects to environment settings objects.)</p>

  <p>The <dfn>relevant settings object for a script</dfn> <var>s</var> is the
  <span>settings object</span> of <var>s</var>.</p>



  <h5 id="script-settings-for-browsing-contexts">Script settings for browsing contexts</h5>

  <p>Whenever a new <code>Window</code> object is created, the user agent must:</p>

  <ol>
   <li><p>Let <var>url</var> be a copy of the <span data-x="the document's address">address</span>
   of the <code>Document</code> with which the <code>Window</code> is associated.</p></li>

   <li>
    <p>Create an <span>environment settings object</span> whose algorithms are defined as
    follows:</p>

    <dl>

     <dt>The <span data-x="script execution environment">script execution environments</span></dt>
     <dd>

      <p>When the <span>environment settings object</span> is created, for each language supported by the
      user agent, create an appropriate execution environment as defined by the relevant
      specification.</p>

      <p>When a <span>script execution environment</span> is needed, return the appropriate one from
      those created when the <span>environment settings object</span> was created.</p>

     </dd>

     <dt>The <span>global object</span></dt>
     <dd>

      <p>Return the <code>Window</code> object itself.</p>

     </dd>

     <dt>The <span>responsible browsing context</span></dt>
     <dd>

      <p>Return the <span>browsing context</span> with which the <code>Window</code> object is
      associated.</p>

     </dd>

     <dt>The <span>responsible event loop</span></dt>
     <dd>

      <p>Return the <span>event loop</span> that is associated with the <span>unit of related
      similar-origin browsing contexts</span> to which the <code>Window</code> object's <span>browsing
      context</span> belongs.</p>

     </dd>

     <dt>The <span>responsible document</span></dt>
     <dd>

      <p>Return the <code>Document</code> with which the <code>Window</code> is currently
      associated.</p>

     </dd>

     <dt>The <span>API URL character encoding</span></dt>
     <dd>

      <p>Return the current <span data-x="document's character encoding">character encoding</span> of
      the <code>Document</code> with which the <code>Window</code> is currently associated.</p>

     </dd>

     <dt>The <span>API base URL</span></dt>
     <dd>

      <p>Return the current <span data-x="document base URL">base URL</span> of the
      <code>Document</code> with which the <code>Window</code> is currently associated.</p>

     </dd>

     <dt>The <span>origin</span></dt>
     <dd>

      <p>Return the <span>origin</span> of the <code>Document</code> with which the
      <code>Window</code> is currently associated.</p>

     </dd>

     <dt>The <span>effective script origin</span></dt>
     <dd>

      <p>Return the <span>effective script origin</span> of the <code>Document</code> with which the
      <code>Window</code> is currently associated.</p>

     </dd>

     <dt>The <span>creation URL</span></dt>
     <dd>

      <p>Return <var>url</var>.</p>

     </dd>

     <dt>The <span>HTTPS state</span></dt>
     <dd>

      <p>Return the <span data-x="concept-window-https-state">HTTPS state</span> of the
      <code>Window</code> object.</p>

     </dd>

    </dl>
   </li>
  </ol>

  <h5 id="calling-scripts">Calling scripts</h5>

  <p>Each <span>unit of related similar-origin browsing contexts</span> has a <dfn>stack of script
  settings objects</dfn>, which must be initially empty. When a new <span>environment settings
  object</span> is <i>pushed</i> onto this stack, the specified <span>environment settings object</span>
  is to be added to the stack; when the <span>environment settings object</span> on this stack that was
  most recently pushed onto it is to be <i>popped</i> from the stack, it must be removed. Entries on
  this stack can be labeled as <dfn data-x="candidate entry settings object">candidate entry
  settings objects</dfn>.</p>

  <p>When a user agent is to <dfn>jump to a code entry-point</dfn> for a <span
  data-x="concept-script">script</span> <var>s</var>, the user agent must run the
  following steps:</p>

  <ol>

   <li><p>Let <var>context</var> be the <span>settings object</span> of <var>s</var>.</p></li>

   <li><p><span>Prepare to run a callback</span> with <var>context</var> as the
   <span>environment settings object</span>. If this returns "do not run" then abort these
   steps.</p></li>

   <li><p>Make the appropriate <span>script execution environment</span> specified by <var>context</var> execute the <var>s</var>'s <span>code
   entry-point</span>.</p></li>

   <li><p><span>Clean up after running a callback</span>.</p></li>

  </ol>

  <p>The steps to <dfn>prepare to run a callback</dfn> with an <span>environment settings object</span>
  <var>o</var> are as follows. They return either "run" or "do not run".</p>

  <ol>

   <li><p>If the <span>global object</span> specified by <var>o</var> is a
   <code>Window</code> object whose <code>Document</code> object is not <span>fully active</span>,
   then return "do not run" and abort these steps.</p>

   <li><p>If <span data-x="concept-bc-noscript">scripting is disabled</span> for the
   <span>responsible browsing context</span> specified by <var>o</var>, then return "do
   not run" and abort these steps.</p>

   <li><p>Push <var>o</var> onto the <span>stack of script settings objects</span>, and
   label it as a <span>candidate entry settings object</span>.</p></li>

   <li><p>Return "run".</p></li>

  </ol>

  <p>The steps to <dfn>clean up after running a callback</dfn> are as follows:</p>

  <ol>

   <li><p>Pop the current <span>incumbent settings object</span> from the <span>stack of script
   settings objects</span>.</p></li>

   <li><p>If the <span>stack of script settings objects</span> is now empty, <span>run the global
   script clean-up jobs</span>. (These cannot run scripts.)</p></li>

   <li><p>If the <span>stack of script settings objects</span> is now empty, <span>perform a
   microtask checkpoint</span>. (If this runs scripts, these algorithms will be invoked
   reentrantly.)</p></li>

  </ol>

  <p class="note">These algorithms are not invoked by one script directly calling another, but they
  can be invoked reentrantly in an indirect manner, e.g. if a script dispatches an event which has
  event listeners registered.</p>

  <p>When a JavaScript <i>SourceElements</i> production is to be evaluated, the <span>settings
  object</span> of the <span data-x="concept-script">script</span> corresponding to that
  <i>SourceElements</i> must be pushed onto the <span>stack of script settings objects</span> before
  the evaluation begins, and popped when the evaluation ends (regardless of whether it's an abrupt
  completion or not).</p>

  <p>The <dfn>entry settings object</dfn> is the most-recently added <span>environment settings
  object</span> in the <span>stack of script settings objects</span> that is labeled as a
  <span>candidate entry settings object</span>. If the stack is empty, or has no entries labeled as
  such, then there is no <span>entry settings object</span>. It is used to obtain, amongst other
  things, the <span>API base URL</span> to <span data-x="resolve a url">resolve</span> relative
  <span data-x="URL">URLs</span> used in scripts running in that <span>unit of related
  similar-origin browsing contexts</span>.</p>

  <p>The <dfn>incumbent settings object</dfn> is the <span>environment settings object</span> in the
  <span>stack of script settings objects</span> that was most-recently added (i.e. the last one on
  the stack). If the stack is empty, then there is no <span>incumbent settings object</span>. It is
  used in some security checks.</p>

  <p class="note">The Web IDL specification also uses these algorithms. <a href="#refsWEBIDL">\[WEBIDL]</a></p>

  <div class="example">

   <p>Consider the following two pages, with the first being loaded in a browser window and the
   second being loaded in the <code>iframe</code> of the first:</p>

   <pre>&lt;!-- a/a.html -->
&lt;!DOCTYPE HTML>
&lt;title>Outer page&lt;/title>
&lt;iframe src="../b/b.html">&lt;/iframe>
&lt;input type=button onclick="frames[0].hello()" value="Hello"></pre>

   <pre>&lt;!-- b/b.html -->
&lt;!DOCTYPE HTML>
&lt;title>Inner page&lt;/title>
&lt;script>
 function hello() {
   location.assign('c.html');
 }
&lt;/script></pre>

   <p>When the button is pressed in the inner frame, the outer page runs script in the inner page.
   While the <code>hello()</code> function is running, the <span>entry settings
   object</span> is that of the outer file (<code>a/a.html</code>), and the
   <span>incumbent settings object</span> is that of the inner file (<code
  >b/b.html</code>). The <code data-x="dom-location-assign">assign()</code> method uses
   the <span>entry settings object</span> to resolve the URL, so we end up loading <code
  >a/c.html</code>, but it uses the <span>incumbent settings object</span> to establish
   the <span>source browsing context</span>, from which the referrer is established, so the <code
   data-x="http-Referer">Referer</code> header sent with the request for <code
  >a/c.html</code> specifies the inner file's URL (the one ending with <code
  >b/b.html</code>).</p>

   <!-- At least, per spec and in Safari and Chrome:
        http://damowmow.com/playground/demos/settings-objects/002/a/a.html -->

  </div>

  <hr>

  <p>Each <span>unit of related similar-origin browsing contexts</span> has a <dfn>global script
  clean-up jobs list</dfn>, which must initially be empty. A global script clean-up job cannot run
  scripts, and cannot be sensitive to the order in which other clean-up jobs are executed. The File
  API uses this to release <code data-x="blob protocol">blob:</code> URLs. <a href="#refsFILEAPI">\[FILEAPI]</a></p>

  <p>When the user agent is to <dfn>run the global script clean-up jobs</dfn>, the user agent must
  perform each of the jobs in the <span>global script clean-up jobs list</span> and then empty the
  list.</p>

  </div>


  <div class="impl">

  <h5 id="creating-scripts">Creating scripts</h5>

  <p>When the specification says that a <span data-x="concept-script">script</span> is to be <dfn
  data-x="create a script">created</dfn>, given some script source, a script source URL, its
  scripting language, an <span>environment settings object</span>, and optionally a <var>muted
  errors</var> flag, the user agent must run the following steps:</p>

  <ol>

   <li><p>Let <var>script</var> be a new <span data-x="concept-script">script</span> that
   this algorithm will subsequently initialize.</p></li>

   <li><p>If <span data-x="concept-bc-noscript">scripting is disabled</span> for <span>browsing
   context</span> passed to this algorithm, then abort these steps, as if the script source
   described a program that did nothing but return void.</p>

   <li><p>Obtain the appropriate <span>script execution environment</span> for the given scripting
   language from the <span>environment settings object</span> provided.</p></li>

   <li><p>Parse/compile/initialize the source of the script using the <span>script execution
   environment</span>, as appropriate for the scripting language, and thus obtain <var>script</var>'s <span>code entry-point</span>.</p></li>

   <li><p>Let <var>script</var>'s <span>settings object</span> be the <span>environment
   settings object</span> provided.</p></li>

   <li><p>If the <var>muted errors</var> flag was set, then set <var>script</var>'s <span>muted errors</span> flag.</p></li>

   <li>

    <p>If all the steps above succeeded (in particular, if the script was compiled successfully),
    <span data-x="jump to a code entry-point">Jump</span> to <var>script</var>'s <span>code
    entry-point</span>.</p>

    <p>Otherwise, <span>report the error</span> for <var>script</var>, with the
    problematic position (line number and column number), using the <span>global object</span>
    specified by the <span>environment settings object</span> as the target. If the error is still <i
    data-x="concept-error-nothandled">not handled</i> after this, then the error may be reported to
    the user.</p>

   </li>

  </ol>

  </div>


  <div class="impl">

  <h5 id="killing-scripts">Killing scripts</h5>

  <p>User agents may impose resource limitations on scripts, for example CPU quotas, memory limits,
  total execution time limits, or bandwidth limitations. When a script exceeds a limit, the user
  agent may either throw a <code>QuotaExceededError</code> exception, abort the script without an
  exception, prompt the user, or throttle script execution.</p>

  <div class="example">

   <p>For example, the following script never terminates. A user agent could, after waiting for a
   few seconds, prompt the user to either terminate the script or let it continue.</p>

   <pre>&lt;script>
 while (true) { /* loop */ }
&lt;/script></pre>

  </div>

  <p>User agents are encouraged to allow users to disable scripting whenever the user is prompted
  either by a script (e.g. using the <code data-x="dom-alert">window.alert()</code> API) or because
  of a script's actions (e.g. because it has exceeded a time limit).</p>

  <p>If scripting is disabled while a script is executing, the script should be terminated
  immediately.</p>

  <p>User agents may allow users to specifically disable scripts just for the purposes of closing a
  <span>browsing context</span>.</p>

  <p class="example">For example, the prompt mentioned in the example above could also offer the
  user with a mechanism to just close the page entirely, without running any <code
  data-x="event-unload">unload</code> event handlers.</p>

  </div>


  <h5 id="runtime-script-errors">Runtime script errors</h5>

  <div class="impl">

  <p>When the user agent is required to <dfn data-x="report the error">report an error</dfn> for a
  particular <span data-x="concept-script">script</span> <var>script</var> with a particular
  position <var>line</var>:<var>col</var>, using a particular target <var>target</var>, it must run these steps, after which the error is either <dfn
  data-x="concept-error-handled"><i>handled</i></dfn> or <dfn data-x="concept-error-nothandled"><i>not
  handled</i></dfn>:</p>

  <ol>

   <li><p>If <var>target</var> is <span>in error reporting mode</span>, then abort these
   steps; the error is <i data-x="concept-error-nothandled">not handled</i>.</p></li>

   <li><p>Let <var>target</var> be <dfn>in error reporting mode</dfn>.</p></li>

   <li><p>Let <var>message</var> be a user-agent-defined string describing the error in a
   helpful manner.
   <!--INSERT FINGERPRINT-->
   </p></li>

   <li><p>Let <var>error object</var> be the object that represents the error: in the case of an
   uncaught exception, that would be the object that was thrown; in the case of a JavaScript error
   that would be an <code data-x="idl-Error">Error</code> object. If there is no corresponding
   object, then the null value must be used instead.</p></li>

   <li>

    <p>Let <var>location</var> be an <span>absolute URL</span> that corresponds to the
    resource from which <var>script</var> was obtained.</p>

    <p class="note">The resource containing the script will typically be the file from which the
    <code>Document</code> was parsed, e.g. for inline <code>script</code> elements or <span>event
    handler content attributes</span>; or the JavaScript file that the script was in, for external
    scripts. Even for dynamically-generated scripts, user agents are strongly encouraged to attempt
    to keep track of the original source of a script. For example, if an external script uses the
    <code data-x="dom-document-write">document.write()</code> API to insert an inline
    <code>script</code> element during parsing, the URL of the resource containing the script would
    ideally be reported as being the external script, and the line number might ideally be reported
    as the line with the <code data-x="dom-document-write">document.write()</code> call or where the
    string passed to that call was first constructed. Naturally, implementing this can be somewhat
    non-trivial.</p>

    <p class="note">User agents are similarly encouraged to keep careful track of the original line
    numbers, even in the face of <code data-x="dom-document-write">document.write()</code> calls
    mutating the document as it is parsed, or <span>event handler content attributes</span> spanning
    multiple lines.</p>

   </li>

   <li><p>If <var>script</var> has <span>muted errors</span>, then set <var>message</var> to "<code>Script error.</code>", set <var>location</var>
   to the empty string, set <var>line</var> and <var>col</var> to 0, and set <var>error object</var> to null.</p></li>

   <li><p>Let <var>event</var> be a new <span data-x="concept-events-trusted">trusted</span>
   <code>ErrorEvent</code> object that does not bubble but is cancelable, and which has the event
   name <code data-x="event-error">error</code>.</p></li>

   <li><p>Initialize <var>event</var>'s <code data-x="dom-ErrorEvent-message">message</code>
   attribute to <var>message</var>.</p></li>

   <li><p>Initialize <var>event</var>'s <code
   data-x="dom-ErrorEvent-filename">filename</code> attribute to <var>location</var>.</p></li>

   <li><p>Initialize <var>event</var>'s <code data-x="dom-ErrorEvent-lineno">lineno</code>
   attribute to <var>line</var>.</p></li>

   <li><p>Initialize <var>event</var>'s <code data-x="dom-ErrorEvent-colno">colno</code>
   attribute to <var>col</var>.</p></li>

   <li><p>Initialize <var>event</var>'s <code data-x="dom-ErrorEvent-error">error</code>
   attribute to <var>error object</var>.</p></li>

   <li><p><span data-x="concept-event-dispatch">Dispatch</span> <var>event</var> at <var>target</var>.</p></li>

   <li><p>Let <var>target</var> no longer be <span>in error reporting mode</span>.</p></li>

   <li><p>If <var>event</var> was canceled, then the error is <i
   data-x="concept-error-handled">handled</i>. Otherwise, the error is <i
   data-x="concept-error-nothandled">not handled</i>.</p>

  </ol>


  <h6 id="runtime-script-errors-in-documents">Runtime script errors in documents</h6>

  <p>When the user agent is to <dfn data-x="report the exception">report an exception</dfn>
  <var>E</var>, the user agent must <span>report the error</span> for the relevant <span
  data-x="concept-script">script</span>, with the problematic position (line number and column
  number) in the resource containing the script, using the <span>global object</span> specified by
  the script's <span>settings object</span> as the target. If the error is still <i
  data-x="concept-error-nothandled">not handled</i> after this, then the error may be reported to
  the user.</p>

  <p>When an exception is thrown during the execution of one of the scripts associated with a
  <code>Document</code>, and the exception is not caught, the user agent must <span>report the
  exception</span>.</p>


  <h6>The <code>ErrorEvent</code> interface</h6>

  </div>

  <pre class="idl">[Constructor(DOMString type, optional <span>ErrorEventInit</span> eventInitDict), Exposed=(Window, Worker)]
interface <dfn>ErrorEvent</dfn> : <span>Event</span> {
  readonly attribute DOMString <span data-x="dom-ErrorEvent-message">message</span>;
  readonly attribute DOMString <span data-x="dom-ErrorEvent-filename">filename</span>;
  readonly attribute unsigned long <span data-x="dom-ErrorEvent-lineno">lineno</span>;
  readonly attribute unsigned long <span data-x="dom-ErrorEvent-colno">colno</span>;
  readonly attribute any <span data-x="dom-ErrorEvent-error">error</span>;
};

dictionary <dfn>ErrorEventInit</dfn> : <span>EventInit</span> {
  DOMString message;
  DOMString filename;
  unsigned long lineno;
  unsigned long colno;
  any error;
};</pre>

  <p>The <dfn><code data-x="dom-ErrorEvent-message">message</code></dfn> attribute must return the
  value it was initialized to. When the object is created, this attribute must be initialized to the
  empty string. It represents the error message.</p>

  <p>The <dfn><code data-x="dom-ErrorEvent-filename">filename</code></dfn> attribute must return the
  value it was initialized to. When the object is created, this attribute must be initialized to the
  empty string. It represents the <span>absolute URL</span> of the script in which the error
  originally occurred.</p>

  <p>The <dfn><code data-x="dom-ErrorEvent-lineno">lineno</code></dfn> attribute must return the
  value it was initialized to. When the object is created, this attribute must be initialized to
  zero. It represents the line number where the error occurred in the script.</p>

  <p>The <dfn><code data-x="dom-ErrorEvent-colno">colno</code></dfn> attribute must return the value
  it was initialized to. When the object is created, this attribute must be initialized to zero. It
  represents the column number where the error occurred in the script.</p>

  <p>The <dfn><code data-x="dom-ErrorEvent-error">error</code></dfn> attribute must return the value
  it was initialized to. When the object is created, this attribute must be initialized to null.
  Where appropriate, it is set to the object representing the error (e.g. the exception object in
  the case of an uncaught DOM exception).</p>



  <div class="impl">

  <h4 id="event-loops">Event loops</h4> <!-- <dfn>event loop</dfn> -->

  <h5 id="definitions">Definitions</h5>

  <p>To coordinate events, user interaction, scripts, rendering, networking, and so forth, user
  agents must use <dfn data-x="event loop">event loops</dfn> as described in this section. There are
  two kinds of event loops: those for <span data-x="browsing context">browsing contexts</span>, and
  those for <span>workers</span>.</p>

  <p>There must be at least one <span>browsing context</span> <span>event loop</span> per user
  agent, and at most one per <span>unit of related similar-origin browsing contexts</span>.</p>

  <p class="note">When there is more than one <span>event loop</span> for a <span>unit of related
  browsing contexts</span>, complications arise when a <span>browsing context</span> in that group
  is <span data-x="navigate">navigated</span> such that it switches from one <span>unit of related
  similar-origin browsing contexts</span> to another. This specification does not currently describe
  how to handle these complications.</p>

  <p>A <span>browsing context</span> <span>event loop</span> always has at least one <span>browsing
  context</span>. If such an <span>event loop</span>'s <span data-x="browsing context">browsing
  contexts</span> all go away, then the <span>event loop</span> goes away as well. A <span>browsing
  context</span> always has an <span>event loop</span> coordinating its activities.</p>

  <p><span>Worker event loops</span> are simpler: each worker has one
  <span>event loop</span>, and the <span data-x="run a worker">worker processing model</span>
  manages the <span>event loop</span>'s lifetime.</p>

  <hr>

  <p>An <span>event loop</span> has one or more <dfn data-x="task queue">task queues</dfn>. A
  <span>task queue</span> is an ordered list of <dfn data-x="concept-task">tasks</dfn>, which are
  algorithms that are responsible for such work as:</p>

  <dl>

   <dt>Events</dt>

   <dd>

    <p>Dispatching an <code>Event</code> object at a particular
    <code>EventTarget</code> object is often done by a dedicated task.</p>

    <p class="note">Not all events are dispatched using the <span>task queue</span>, many are
    dispatched during other tasks.</p>

   </dd>


   <dt>Parsing</dt>

   <dd><p>The <span>HTML parser</span> tokenizing one or more bytes, and then processing any
   resulting tokens, is typically a task.</p></dd>


   <dt>Callbacks</dt>

   <dd><p>Calling a callback is often done by a dedicated task.</p></dd>


   <dt>Using a resource</dt>

   <dd><p>When an algorithm <span data-x="concept-fetch">fetches</span> a resource, if the fetching
   occurs in a non-blocking fashion then the processing of the resource once some or all of the
   resource is available is performed by a task.</p></dd>


   <dt>Reacting to DOM manipulation</dt>

   <dd><p>Some elements have tasks that trigger in response to DOM manipulation, e.g. when that
   element is <span data-x="insert an element into a document">inserted into the document</span>.</p>

  </dl>

  <p>Each <span data-x="concept-task">task</span> in a <span>browsing context</span> <span>event
  loop</span> is associated with a <code>Document</code>; if the task was queued in the context of
  an element, then it is the element's <span>node document</span>; if the task was queued in the context
  of a <span>browsing context</span>, then it is the <span>browsing context</span>'s <span>active
  document</span> at the time the task was queued; if the task was queued by or for a <span
  data-x="concept-script">script</span> then the document is the <span>responsible document</span>
  specified by the script's <span>settings object</span>.</p>

  <p>A <span data-x="concept-task">task</span> is intended for a specific <span>event loop</span>:
  the <span>event loop</span> that is handling <span data-x="concept-task">tasks</span> for the
  <span data-x="concept-task">task</span>'s associated <code>Document</code> or <span
  title="workers">worker</span>.</p>

  <p>When a user agent is to <dfn>queue a task</dfn>, it must add the given task to one of the <span
  data-x="task queue">task queues</span> of the relevant <span>event loop</span>.</p>

  <p>Each <span data-x="concept-task">task</span> is defined as coming from a specific <dfn>task
  source</dfn>. All the tasks from one particular <span>task source</span> and destined to a
  particular <span>event loop</span> (e.g. the callbacks generated by timers of a
  <code>Document</code>, the events fired for mouse movements over that <code>Document</code>, the
  tasks queued for the parser of that <code>Document</code>) must always be added to the same
  <span>task queue</span>, but <span data-x="concept-task">tasks</span> from different <span
  data-x="task source">task sources</span> may be placed in different <span data-x="task queue">task
  queues</span>.</p>

  <p class="example">For example, a user agent could have one <span>task queue</span> for mouse and
  key events (the <span>user interaction task source</span>), and another for everything else. The
  user agent could then give keyboard and mouse events preference over other tasks three quarters of
  the time, keeping the interface responsive but not starving other task queues, and never
  processing events from any one <span>task source</span> out of order.</p>

  <p>Each <span>event loop</span> has a <dfn>currently running task</dfn>. Initially, this is null.
  It is used to handle reentrancy. Each <span>event loop</span> also has a <dfn>performing a
  microtask checkpoint</dfn> flag, which must initially be false. It is used to prevent reentrant
  invocation of the <span>perform a microtask checkpoint</span> algorithm.</p>

  <hr>

  <p>A user agent may have one <dfn>storage mutex</dfn>. This mutex is used to control access to
  shared state like cookies. At any one point, the <span>storage mutex</span> is either free, or
  owned by a particular <span>event loop</span> or instance of the <span
  data-x="concept-fetch">fetching</span> algorithm.</p>

  <p>If a user agent does not implement a <span>storage mutex</span>, it is exempt from implementing
  the requirements that require it to acquire or release it.</p>

  <p class="note">User agent implementors have to make a choice between two evils. On the one hand,
  not implementing the storage mutex means that there is a risk of data corruption: a site could,
  for instance, try to read a cookie, increment its value, then write it back out, using the new
  value of the cookie as a unique identifier for the session; if the site does this twice in two
  different browser windows at the same time, it might end up using the same "unique" identifier for
  both sessions, with potentially disastrous effects. On the other hand, implementing the storage
  mutex has potentially serious performance implications: whenever a site uses Web Storage or
  cookies, all other sites that try to use Web Storage or cookies are blocked until the first site
  finishes.</p>

  <p class="warning">So far, all browsers faced with this decision have opted to not implement the
  <span>storage mutex</span>.</p>

  <p>Whenever a <span data-x="concept-script">script</span> calls into a <span>plugin</span>, and
  whenever a <span>plugin</span> calls into a <span data-x="concept-script">script</span>, the user
  agent must release the <span>storage mutex</span>.</p>


  <h5 id="processing-model">Processing model</h5> <!-- EVENT LOOP -->

  <p>An <span>event loop</span> must continually run through the following steps for as long as it
  exists:</p>

  <ol>

   <!-- lots of places in the spec refer to "step 1" -->

   <li id="step1">

    <p>Select the oldest <span data-x="concept-task">task</span> on one of the <span>event
    loop</span>'s <span data-x="task queue">task queues</span>, if any, ignoring, in the case of a
    <span>browsing context</span> <span>event loop</span>, tasks whose associated
    <code>Document</code>s are not <span>fully active</span>. The user agent may pick any <span>task
    queue</span>. If there is no task to select, then jump to the <i>microtasks</i> step below.</p>

   </li>

   <!-- note: reference to 'previous step' below -->

   <li><p>Set the <span>event loop</span>'s <span>currently running task</span> to the <span
   data-x="concept-task">task</span> selected in the previous step.</p></li>

   <li><p><i>Run</i>: Run the selected <span data-x="concept-task">task</span>.</p></li>

   <li><p>Set the <span>event loop</span>'s <span>currently running task</span> back to
   null.</p></li>

   <li><p>If the <span>storage mutex</span> is now owned by the <span>event loop</span>, release it
   so that it is once again free.</p></li>

   <li><p>Remove the task that was run in the <i>run</i> step above from its <span>task
   queue</span>.</p></li>

   <li><p><i>Microtasks</i>: <span>Perform a microtask checkpoint</span>.</p></li>

   <li>

    <p><i>Update the rendering</i>: If this <span>event loop</span> is a <span>browsing
    context</span> <span>event loop</span> (as opposed to a <span title='workers'>worker</span>
    <span>event loop</span>), then run the following substeps.</p>

    <ol>

     <li><p>Let <var>now</var> be the value that would be returned by the <code>Performance</code>
     object's <code data-x="dom-Performance-now">now()</code> method. <a href="#refsHRT">\[HRT]</a></p>

     <li>

      <p>Let <var>docs</var> be the list of <code>Document</code> objects associated with the
      <span>event loop</span> in question, sorted arbitrarily except that the following conditions
      must be met:</p>

      <ul>

       <li><p>Any <code>Document</code> <var>B</var> that is <span>nested through</span> a
       <code>Document</code> <var>A</var> must be listed after <var>A</var> in the list.</p></li>

       <li><p>If there are two documents <var>A</var> and <var>B</var> whose <span data-x="browsing
       context">browsing contexts</span> are both <span data-x="nested browsing context">nested
       browsing contexts</span> and their <span data-x="browsing context container">browsing context
       containers</span> are both elements in the same <code>Document</code> <var>C</var>, then the
       order of <var>A</var> and <var>B</var> in the list must match the relative <span>tree
       order</span> of their respective <span data-x="browsing context container">browsing context
       containers</span> in <var>C</var>.</p></li>

      </ul>

      <p>In the steps below that iterate over <var>docs</var>, each <code>Document</code> must be
      processed in the order it is found in the list.</p>

     </li>

     <li>

      <p>If there is a <span>top-level browsing context</span> <var>B</var> that the user agent
      believes would not benefit from having its rendering updated at this time, then remove from
      <var>docs</var> all <code>Document</code> objects whose <span>browsing context</span>'s
      <span>top-level browsing context</span> is <var>B</var>.</p>

      <p class="note">Whether a <span>top-level browsing context</span> would benefit from having
      its rendering updated depends on various factors, such as the update frequency. For example,
      if the browser is attempting to achieve a 60 Hz refresh rate, then these steps are only
      necessary every 60th of a second (about 16.7ms). If the browser finds that a <span>top-level
      browsing context</span> is not able to sustain this rate, it might drop to a more sustainable
      30Hz for that set of <code>Document</code>s, rather than occasionally dropping frames. (This
      specification does not mandate any particular model for when to update the rendering.)
      Similarly, if a <span>top-level browsing context</span> is in the background, the user agent
      might decide to drop that page to a much slower 4Hz, or even less.</p>

     </li>

     <li><p>For each <span>fully active</span> <code>Document</code> in <var>docs</var>, <dfn>run the resize steps</dfn> for
     that <code>Document</code>, passing in <var>now</var> as the timestamp. <a
     href="#refsCSSOMVIEW">\[CSSOMVIEW]</a></p></li>

     <li><p>For each <span>fully active</span> <code>Document</code> in <var>docs</var>, <dfn>run the scroll steps</dfn> for
     that <code>Document</code>, passing in <var>now</var> as the timestamp. <a
     href="#refsCSSOMVIEW">\[CSSOMVIEW]</a></p></li>

     <li><p>For each <span>fully active</span> <code>Document</code> in <var>docs</var>, <dfn>evaluate media queries and
     report changes</dfn> for that <code>Document</code>, passing in <var>now</var> as the
     timestamp. <a href="#refsCSSOMVIEW">\[CSSOMVIEW]</a></p></li>

     <li><p>For each <span>fully active</span> <code>Document</code> in <var>docs</var>, <dfn>run CSS animations and send
     events</dfn> for that <code>Document</code>, passing in <var>now</var> as the timestamp. <a
     href="#refsCSSANIMATIONS">\[CSSANIMATIONS]</a></p></li>

     <li><p>For each <span>fully active</span> <code>Document</code> in <var>docs</var>, <dfn>run the fullscreen rendering
     steps</dfn> for that <code>Document</code>, passing in <var>now</var> as the timestamp. <a
     href="#refsFULLSCREEN">\[FULLSCREEN]</a></p></li>

     <li><p>For each <span>fully active</span> <code>Document</code> in <var>docs</var>, <span>run the animation frame
     callbacks</span> for that <code>Document</code>, passing in <var>now</var> as the
     timestamp.</p></li>

     <li><p>For each <span>fully active</span> <code>Document</code> in <var>docs</var>, update the rendering or user
     interface of that <code>Document</code> and its <span>browsing context</span> to reflect the
     current state.</p></li>

    </ol>

   </li>

   <li><p>If this is a <span title='workers'>worker</span> <span>event loop</span> (i.e. one running for a
   <code>WorkerGlobalScope</code>), but there are no <span data-x="concept-task">tasks</span> in the
   <span>event loop</span>'s <span data-x="task queue">task queues</span> and the
   <code>WorkerGlobalScope</code> object's <span
   data-x="dom-WorkerGlobalScope-closing">closing</span> flag is true, then destroy the <span>event
   loop</span>, aborting these steps, resuming the <span>run a worker</span> steps described in the
   <span title='workers'>Web Worker</span> section below.</p></li>

   <li><p>Return to the <a href="#step1">first step</a> of the <span>event loop</span>.</p></li>

  </ol>

  <hr>

  <p>Each <span>event loop</span> has a <dfn>microtask queue</dfn>. A <dfn>microtask</dfn> is a
  <span data-x="concept-task">task</span> that is originally to be queued on the <span>microtask
  queue</span> rather than a <span>task queue</span>. There are two kinds of <span
  data-x="microtask">microtasks</span>: <dfn data-x="solitary callback microtask">solitary callback
  microtasks</dfn>, and <dfn data-x="compound microtask">compound microtasks</dfn>.</p>

  <p class="note">This specification only has <span data-x="solitary callback microtask">solitary
  callback microtasks</span>. Specifications that use <span data-x="compound microtask">compound
  microtasks</span> have to take extra care to <span data-x="execute a compound microtask
  subtask">wrap callbacks</span> to handle <span data-x="spin the event loop">spinning the event
  loop</span>.</p>

  <p>When an algorithm requires a <span>microtask</span> to be <dfn data-x="queue a
  microtask">queued</dfn>, it must be appended to the relevant <span>event loop</span>'s
  <span>microtask queue</span>; the <span>task source</span> of such a <span>microtask</span> is the
  <dfn>microtask task source</dfn>.</p>

  <p class="note">It is possible for a <span>microtask</span> to be moved to a regular <span>task
  queue</span>, if, during its initial execution, it <span data-x="spin the event loop">spins the
  event loop</span>. In that case, the <span>microtask task source</span> is the <span>task
  source</span> used. Normally, the <span>task source</span> of a <span>microtask</span> is
  irrelevant.</p>

  <p>When a user agent is to <dfn>perform a microtask checkpoint</dfn>, if the <span>performing a
  microtask checkpoint</span> flag is false, then the user agent must run the following steps:</p>

  <ol>

   <li><p>Let the <span>performing a microtask checkpoint</span> flag be true.</p></li>

   <li><p><i>Microtask queue handling</i>: If the <span>event loop</span>'s <span>microtask
   queue</span> is empty, jump to the <i>done</i> step below.</p></li>

   <li><p>Select the oldest <span>microtask</span> on the <span>event loop</span>'s <span>microtask
   queue</span>.</p></li>

   <li><p>Set the <span>event loop</span>'s <span>currently running task</span> to the <span
   data-x="concept-task">task</span> selected in the previous step.</p></li>

   <li>

    <p><i>Run</i>: Run the selected <span data-x="concept-task">task</span>.</p>

    <p class="note">This might involve invoking scripted callbacks, which eventually calls the
    <span>clean up after running a callback</span> steps, which call this <span>perform a microtask
    checkpoint</span> algorithm again, which is why we use the <span>performing a microtask
    checkpoint</span> flag to avoid reentrancy.</p>

   </li>

   <li><p>Set the <span>event loop</span>'s <span>currently running task</span> back to
   null.</p></li>

   <li><p>If the <span>storage mutex</span> is now owned by the <span>event loop</span>, release it
   so that it is once again free.</p></li>

   <li><p>Remove the <span>microtask</span> run in the step above from the <span>microtask
   queue</span>, and return to the <i>microtask queue handling</i> step.</p></li>

   <li><p><i>Done</i>: Let the <span>performing a microtask checkpoint</span> flag be
   false.</p></li>

  </ol>

  <p>If, while a <span>compound microtask</span> is running, the user agent is required to
  <dfn>execute a compound microtask subtask</dfn> to run a series of steps, the user agent must run
  the following steps:</p>

  <ol>

   <li><p>Let <var>parent</var> be the <span>event loop</span>'s <span>currently running
   task</span> (the currently running <span>compound microtask</span>).</p></li>

   <li><p>Let <var>subtask</var> be a new <span data-x="concept-task">task</span> that
   consists of running the given series of steps. The <span>task source</span> of such a
   <span>microtask</span> is the <span>microtask task source</span>. This is a <dfn>compound
   microtask subtask</dfn>.</p></li>

   <li><p>Set the <span>event loop</span>'s <span>currently running task</span> to <var>subtask</var>.</p></li>

   <li><p>Run <var>subtask</var>.</p></li>

   <li><p>Set the <span>event loop</span>'s <span>currently running task</span> back to <var>parent</var>.</p></li>

  </ol>

  <hr>

  <p>When an algorithm running <span>in parallel</span> is to <dfn>await a stable state</dfn>, the
  user agent must <span>queue a microtask</span> that runs the following steps, and must then stop
  executing (execution of the algorithm resumes when the microtask is run, as described in the
  following steps):</p>

  <ol>

   <li><p>Run the algorithm's <dfn>synchronous section</dfn>.</p></li>

   <li><p>Resumes execution of the algorithm <span>in parallel</span>, if appropriate, as described
   in the algorithm's steps.</p></li>

  </ol>

  <p class="note">Steps in <span data-x="synchronous section">synchronous sections</span> are marked
  with &#x231B;.</p>

  <hr>

  <p>When an algorithm says to <dfn>spin the event loop</dfn> until a condition <var>goal</var> is met, the user agent must run the following steps:</p>

  <ol>

   <li>

    <p>Let <var>task</var> be the <span>event loop</span>'s <span>currently running
    task</span>.</p>

    <p class="note">This might be a <span>microtask</span>, in which case it is a <span>solitary
    callback microtask</span>. It could also be a <span>compound microtask subtask</span>, or a
    regular <span data-x="concept-task">task</span> that is not a <span>microtask</span>. It will
    <em>not</em> be a <span>compound microtask</span>.</p> <!-- well, not unless we messed up in the
    speccing, anyway... -->

   </li>

   <li><p>Let <var>task source</var> be <var>task</var>'s <span>task
   source</span>.</p></li>

   <li><p>Let <var>old stack of script settings objects</var> be a copy of the <span>stack
   of script settings objects</span>.</p></li>

   <li><p>Empty the <span>stack of script settings objects</span>.</p></li>

   <li><p><span>Run the global script clean-up jobs</span>.</p></li>

   <li><p><span>Perform a microtask checkpoint</span>.</p></li>

   <li>

    <p>Stop <var>task</var>, allowing whatever algorithm that invoked it to resume, but
    continue these steps <span>in parallel</span>.</p>

    <p class="note">This causes one of the following algorithms to continue: the <span>event
    loop</span>'s main set of steps, the <span>perform a microtask checkpoint</span> algorithm, or
    the <span>execute a compound microtask subtask</span> algorithm to continue.</p>

   </li>

   <li><p>Wait until the condition <var>goal</var> is met.</p></li>

   <li><p><span>Queue a task</span> to continue running these steps, using the <span>task
   source</span> <var>task source</var>. Wait until this new task runs before continuing
   these steps.</p></li>

   <li><p>Replace the <span>stack of script settings objects</span> with the <var>old
   stack of script settings objects</var>.</p></li>

   <li><p>Return to the caller.</p></li>

  </ol>

  <hr>

  <p>Some of the algorithms in this specification, for historical reasons, require the user agent to
  <dfn>pause</dfn> while running a <span data-x="concept-task">task</span> until a condition <var>goal</var> is met. This means running the following steps:</p>

  <ol>

   <li><p>If necessary, update the rendering or user interface of any <code>Document</code> or
   <span>browsing context</span> to reflect the current state.</p></li>

   <li><p>Wait until the condition <var>goal</var> is met. While a user agent has a paused
   <span data-x="concept-task">task</span>, the corresponding <span>event loop</span> must not run
   further <span data-x="concept-task">tasks</span>, and any script in the currently running <span
   data-x="concept-task">task</span> must block. User agents should remain responsive to user input
   while paused, however, albeit in a reduced capacity since the <span>event loop</span> will not be
   doing anything.</p></li>

  </ol>

  <hr>

  <p>When a user agent is to <dfn>obtain the storage mutex</dfn> as part of running a <span
  data-x="concept-task">task</span>, it must run through the following steps:</p>

  <ol>

   <li><p>If the <span>storage mutex</span> is already owned by this <span
   data-x="concept-task">task</span>'s <span>event loop</span>, then abort these steps.</p></li>

   <li><p>Otherwise, <span>pause</span> until the <span>storage mutex</span> can be taken by the
   <span>event loop</span>.</p></li>

   <li><p>Take ownership of the <span>storage mutex</span>.</p></li>

  </ol>

  </div>


  <div class="impl">

  <h5 id="generic-task-sources">Generic task sources</h5>

  <p>The following <span data-x="task source">task sources</span> are used by a number of mostly
  unrelated features in this and other specifications.</p>

  <dl>

   <dt>The <dfn>DOM manipulation task source</dfn></dt>

   <dd>

    <p>This <span>task source</span> is used for features that react to DOM manipulations, such as
    things that happen in a non-blocking fashion when an element is <span data-x="insert an element into a
    document">inserted into the document</span>.</p>

   </dd>

   <dt>The <dfn>user interaction task source</dfn></dt>

   <dd>

    <p>This <span>task source</span> is used for features that react to user interaction, for
    example keyboard or mouse input.</p>

    <p>Events sent in response to user input (e.g. <code
    data-x="event-click">click</code> events) must be fired using <span
    data-x="concept-task">tasks</span> <span data-x="queue a task">queued</span> with the <span>user
    interaction task source</span>. <a href="#refsUIEVENTS">\[UIEVENTS]</a></p> <!-- user
    interaction events integration point -->

   </dd>

   <dt>The <dfn>networking task source</dfn></dt>

   <dd>

    <p>This <span>task source</span> is used for features that trigger in response to network
    activity.</p>

   </dd>

   <dt>The <dfn>history traversal task source</dfn></dt>

   <dd>

    <p>This <span>task source</span> is used to queue calls to <code
    data-x="dom-history-back">history.back()</code> and similar APIs.</p>

   </dd>

  </dl>

  </div>




  <h4 id="events">Events</h4>

  <h5 id="event-handler-attributes">Event handlers</h5>

  <!--test: <a href="http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C!DOCTYPE%20html%3E%0A...%3Cscript%3E%0Aw(a%3Ddocument.implementation.createDocument(null%2C%20null%2C%20null))%3B%0Aw(a.appendChild(a.createElementNS('http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml'%2C%20'html')))%3B%0Aw(b%3Da.firstChild.appendChild(a.createElementNS('http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml'%2C%20'body')))%3B%0Aw(b.test%20%3D%20w)%3B%0Aw(b.setAttribute('onclick'%2C%20'test(%22fire%3A%20%22%20%2B%20event)'))%3B%0Aw(b.onclick)%3B%0Aw(e%3Da.createEvent('Event'))%3B%0Aw(e.initEvent('click'%2C%20false%2C%20false))%3B%0Aw(b.dispatchEvent(e))%3B%0A%3C%2Fscript%3E">test</a>-->

  <p>Many objects can have <dfn>event handlers</dfn> specified. These act as non-capture event
  listeners for the object on which they are specified. <a href="#refsDOM">\[DOM]</a></p>

  <p>An <span data-x="event handlers">event handler</span> has a name, which always starts with
  "<code>on</code>" and is followed by the name of the event for which it is intended.</p>

  <p>An <span data-x="event handlers">event handler</span> can either have the value null, or be set
  to a callback object<span class="impl">, or be set to an <span>internal raw uncompiled
  handler</span></span>. The <code>EventHandler</code> callback function type describes how this is
  exposed to scripts. <span class="impl">Initially, event handlers must be set to null.</span></p>

  <p>Event handlers are exposed in one of two ways.</p>

  <p>The first way, common to all event handlers, is as an <span data-x="event handler IDL
  attributes">event handler IDL attribute</span>.</p>

  <p>The second way is as an <span data-x="event handler content attributes">event handler content
  attribute</span>. Event handlers on <span>HTML elements</span> and some of the event handlers on
  <code>Window</code> objects are exposed in this way.</p>

  <div class="impl">

  <hr>

  <p>An <dfn data-x="event handler IDL attributes">event handler IDL attribute</dfn> is an IDL
  attribute for a specific <span data-x="event handlers">event handler</span>. The name of the IDL
  attribute is the same as the name of the <span data-x="event handlers">event handler</span>.</p>

  <p><span>Event handler IDL attributes</span>, on setting, must set the corresponding <span
  data-x="event handlers">event handler</span> to their new value, and on getting, must return the
  result of <span>getting the current value of the event handler</span> in question (this can throw
  an exception, in which case the getting propagates it to the caller, it does not catch it).</p>

  <p>If an <span data-x="event handler IDL attributes">event handler IDL attribute</span> exposes an
  <span data-x="event handlers">event handler</span> of an object that doesn't exist, it must always
  return null on getting and must do nothing on setting.</p>

  <p class="note">This can happen in particular for <span data-x="event handler IDL attributes">event
  handler IDL attribute</span> on <code>body</code> elements that do not have corresponding
  <code>Window</code> objects.</p>

  <p class="note">Certain event handler IDL attributes have additional requirements, in particular
  the <code data-x="handler-MessagePort-onmessage">onmessage</code> attribute of
  <code>MessagePort</code> objects.</p>

  <hr>

  </div>

  <p>An <dfn data-x="event handler content attributes">event handler content attribute</dfn> is a
  content attribute for a specific <span data-x="event handlers">event handler</span>. The name of
  the content attribute is the same as the name of the <span data-x="event handlers">event
  handler</span>.</p>

  <p><span>Event handler content attributes</span>, when specified, must contain valid JavaScript
  code which, when parsed, would match the <code>FunctionBody</code> production after
  automatic semicolon insertion. <a href="#refsECMA262">\[ECMA262]</a></p>

  <div class="impl">

  <p>When an <span data-x="event handler content attributes">event handler content attribute</span>
  is set, the user agent must set the corresponding <span data-x="event handlers">event
  handler</span> to an <span>internal raw uncompiled handler</span> consisting of the attribute's
  new value and the script location where the attribute was set to this value</p>

  <p>When an event handler content attribute is removed, the user agent must set the corresponding
  <span data-x="event handlers">event handler</span> to null.</p>
  <!--
  http://software.hixie.ch/utilities/js/live-dom-viewer/saved/245 onload
  http://software.hixie.ch/utilities/js/live-dom-viewer/saved/247 onclick
  see https://www.w3.org/Bugs/Public/show_bug.cgi?id=7626#c5 for reasoning
  -->

  <hr>

  <p>When an <span data-x="event handlers">event handler</span> <var>H</var> of an element
  or object <var>T</var> implementing the <code>EventTarget</code> interface is first set
  to a non-null value, the user agent must append an <span data-x="concept-event-listener">event
  listener</span> to the list of <span data-x="concept-event-listener">event listeners</span>
  associated with <var>T</var> with <i>type</i> set to the <dfn>event handler event
  type</dfn> corresponding to <var>H</var>, <i>capture</i> set to false, and
  <i>listener</i> set to <span>the event handler processing algorithm</span> defined below. <a href="#refsDOM">\[DOM]</a></p>

  <p class="note">The <i>listener</i> is emphatically <em>not</em> the <span data-x="event
  handlers">event handler</span> itself. Every event handler ends up registering the same
  <i>listener</i>, the algorithm defined below, which takes care of invoking the right callback, and
  processing the callback's return value.</p>

  <p class="note">This only happens the first time the <span data-x="event handlers">event
  handler</span>'s value is set. Since listeners are called in the order they were registered, the
  order of event listeners for a particular event type will always be first the event listeners
  registered with <code data-x="dom-EventTarget-addEventListener">addEventListener()</code> before
  the first time the <span data-x="event handlers">event handler</span> was set to a non-null value,
  then the callback to which it is currently set, if any, and finally the event listeners registered
  with <code data-x="dom-EventTarget-addEventListener">addEventListener()</code> <em>after</em> the
  first time the <span data-x="event handlers">event handler</span> was set to a non-null value.</p>

  </div>

  <div class="example">

   <p>This example demonstrates the order in which event listeners are invoked. If the button in
   this example is clicked by the user, the page will show four alerts, with the text "ONE", "TWO",
   "THREE", and "FOUR" respectively.</p>

   <pre>&lt;button id="test">Start Demo&lt;/button>
&lt;script>
 var button = document.getElementById('test');
 button.addEventListener('click', function () { alert('ONE') }, false);
 button.setAttribute('onclick', "alert('NOT CALLED')"); // event handler listener is registered here
 button.addEventListener('click', function () { alert('THREE') }, false);
 button.onclick = function () { alert('TWO'); };
 button.addEventListener('click', function () { alert('FOUR') }, false);
&lt;/script></pre>

  </div>

  <div class="impl">

  <p class="note">The interfaces implemented by the event object do not influence whether an <span
  data-x="event handlers">event handler</span> is triggered or not.</p>

  <p><dfn>The event handler processing algorithm</dfn> for an <span data-x="event handlers">event
  handler</span> <var>H</var> and an <code>Event</code> object <var>E</var> is as
  follows:</p>

  <ol>

   <li>

    <p>Let <var>callback</var> be the result of <span>getting the current value of the
    event handler</span> <var>H</var>.</p>

   </li>

   <li><p>If <var>callback</var> is null, then abort these steps.</p></li>

   <li>

    <p>Process the <code>Event</code> object <var>E</var> as follows:</p>

    <dl class="switch">

     <dt>If <var>E</var> is an <code>ErrorEvent</code> object and the <span data-x="event
     handler IDL attributes">event handler IDL attribute</span>'s type is
     <code>OnErrorEventHandler</code></dt>

     <dd>

      <p><span data-x="concept-invoke-event-handler">Invoke</span> <var>callback</var> with five
      arguments, the first one having the value of <var>E</var>'s <code
      data-x="dom-ErrorEvent-message">message</code> attribute, the second having the value of
      <var>E</var>'s <code data-x="dom-ErrorEvent-filename">filename</code> attribute, the third
      having the value of <var>E</var>'s <code data-x="dom-ErrorEvent-lineno">lineno</code>
      attribute, the fourth having the value of <var>E</var>'s <code
      data-x="dom-ErrorEvent-colno">colno</code> attribute, the fifth having the value of
      <var>E</var>'s <code data-x="dom-ErrorEvent-error">error</code> attribute, and with the <i
      data-x="dfn-callback-this-value">callback this value</i> set to <var>E</var>'s <code
      data-x="dom-Event-currentTarget">currentTarget</code>. Let <var>return value</var> be the
      callback's return value. <a href="#refsWEBIDL">\[WEBIDL]</a></p>

     </dd>

     <dt>Otherwise</dt>

     <dd>

      <p><span data-x="concept-invoke-event-handler">Invoke</span> <var>callback</var>
      with one argument, the value of which is the <code>Event</code> object <var>E</var>,
      with the <i data-x="dfn-callback-this-value">callback this value</i> set to <var>E</var>'s <code data-x="dom-Event-currentTarget">currentTarget</code>. Let <var>return value</var> be the callback's return value. <a href="#refsWEBIDL">\[WEBIDL]</a></p>

     </dd>

    </dl>

    <p>In this step, <dfn data-x="concept-invoke-event-handler">invoke</dfn> means to <span
    data-x="es-invoking-callback-functions">invoke the Web IDL callback function</span>.</p>

    <p>If an exception gets thrown by the callback, end these steps and allow the exception to
    propagate. (It will propagate to the <span data-x="concept-event-dispatch">DOM event dispatch
    logic</span>, which will then <span>report the exception</span>.)</p>

   </li>

   <li>

    <p>Process <var>return value</var> as follows:</p>

    <dl class="switch">

     <dt>If the event type is <code data-x="event-mouseover">mouseover</code></dt>
     <dt>If the event type is <code data-x="event-error">error</code> and <var>E</var> is an <code>ErrorEvent</code> object</dt>

     <dd><p>If <var>return value</var> is a Web IDL boolean true value, then cancel the event.</p></dd>


     <dt>If the event type is <code data-x="event-beforeunload">beforeunload</code></dt>

     <dd>

      <p class="note">The <span data-x="event handler IDL attributes">event handler IDL
      attribute</span>'s type is <code>OnBeforeUnloadEventHandler</code>, and the <var>return value</var> will therefore have been coerced into either the value null or a
      DOMString.</p>

      <p>If the <var>return value</var> is null, then cancel the event.</p>

      <p>Otherwise, If the <code>Event</code> object <var>E</var> is a
      <code>BeforeUnloadEvent</code> object, and the <code>Event</code> object <var>E</var>'s <code data-x="dom-BeforeUnloadEvent-returnValue">returnValue</code>
      attribute's value is the empty string, then set the <code
      data-x="dom-BeforeUnloadEvent-returnValue">returnValue</code> attribute's value to <var>return value</var>.</p>

     </dd>

     <dt>Otherwise</dt>

     <dd><p>If <var>return value</var> is a Web IDL boolean false value, then cancel the
     event.</p></dd>

     <!-- IE actually uncancels the event if the function returns true -->

    </dl>

   </li>

  </ol>

  </div>

  <hr>

  <p>The <code>EventHandler</code> callback function type represents a callback used for event
  handlers. It is represented in Web IDL as follows:</p>

  <pre class="idl">[TreatNonObjectAsNull]
callback <dfn>EventHandlerNonNull</dfn> = any (<span>Event</span> event);
typedef <span>EventHandlerNonNull</span>? <dfn>EventHandler</dfn>;</pre>

  <p class="note">In JavaScript, any <code data-x="idl-Function">Function</code> object implements
  this interface.</p>

  <div class="example">

   <p>For example, the following document fragment:</p>

   <pre>&lt;body onload="alert(this)" onclick="alert(this)"></pre>

   <p>...leads to an alert saying "<code>[object&nbsp;Window]</code>" when the document is
   loaded, and an alert saying "<code>[object&nbsp;HTMLBodyElement]</code>" whenever the
   user clicks something in the page.</p>

  </div>

  <p class="note">The return value of the function affects whether the event is canceled or not:
  <span class="impl">as described above,</span> if the return value is false, the event is canceled
  (except for <code data-x="event-mouseover">mouseover</code> events, where the return value has to
  be true to cancel the event). With <code data-x="event-beforeunload">beforeunload</code> events,
  the value is instead used to determine the message to show the user.</p>

  <p>For historical reasons, the <code data-x="handler-onerror">onerror</code> handler has different
  arguments:</p>

  <pre class="idl">[TreatNonObjectAsNull]
callback <dfn>OnErrorEventHandlerNonNull</dfn> = any ((<span>Event</span> or DOMString) event, optional DOMString source, optional unsigned long lineno, optional unsigned long column, optional any error);
typedef <span>OnErrorEventHandlerNonNull</span>? <dfn>OnErrorEventHandler</dfn>;</pre>

  <p>Similarly, the <code data-x="handler-window-onbeforeunload">onbeforeunload</code> handler has a
  different return value:</p>

  <pre class="idl">[TreatNonObjectAsNull]
callback <dfn>OnBeforeUnloadEventHandlerNonNull</dfn> = DOMString? (<span>Event</span> event);
typedef <span>OnBeforeUnloadEventHandlerNonNull</span>? <dfn>OnBeforeUnloadEventHandler</dfn>;</pre>

  <!-- onreadystatechange is also defined specially, using [LenientThis]; see IDL -->

  <div class="impl">

  <hr>

  <p>An <dfn>internal raw uncompiled handler</dfn> is a tuple with the following information:</p>

  <ul class="brief">

   <li>An uncompiled script body

   <li>A location where the script body originated, in case an error needs to be reported

  </ul>

  <p>When the user agent is to <dfn data-x="getting the current value of the event handler">get the
  current value of the event handler</dfn> <var>H</var>, it must run these steps:</p>

  <ol>

   <li>

    <p>If <var>H</var>'s value is an <span>internal raw uncompiled handler</span>, run these
    substeps:</p>

    <ol>

     <li>

      <p>If <var>H</var> is an element's <span data-x="event handlers">event
      handler</span>, then let <var>element</var> be the element, and <var>document</var> be the element's <span>node document</span>.</p>

      <p>Otherwise, <var>H</var> is a <code>Window</code> object's <span data-x="event
      handlers">event handler</span>: let <var>element</var> be null, and let <var>document</var> be the <code>Document</code> most recently associated with that
      <code>Window</code> object.</p>

     </li>

     <li><p>If <!--<var>element</var> is not null and--> <var>document</var> is
     not in a <span>browsing context</span>, or if <span data-x="concept-bc-script">scripting is
     enabled</span> for <var>document</var>'s <span>browsing context</span>, then return
     null and abort the algorithm for <span>getting the current value of the event
     handler</span>.</p></li>

     <li><p>Let <var>body</var> be the uncompiled script body in the <span>internal raw
     uncompiled handler</span>.</p></li>

     <li><p>Let <var>location</var> be the location where the script body originated, as
     given by the <span>internal raw uncompiled handler</span>.</p></li>

     <li><p>If <var>element</var> is not null and <var>element</var> has a
     <span>form owner</span>, let <var>form owner</var> be that <span>form owner</span>.
     Otherwise, let <var>form owner</var> be null.</p></li>

     <li><p>Let <var>script settings</var> be the <span>environment settings object</span>
     created for the <code>Window</code> object with which <var>document</var> is
     currently associated.</p></li>

     <li><p>Obtain the <span>script execution environment</span> for JavaScript from <var>script settings</var>.</p></li>
     <!-- v2: we could support HTML4's Content-Script-Type header here -->

     <li>

      <p>If <var>body</var> is not parsable as <i>FunctionBody</i> or if parsing detects
      an <i>early error</i>, then follow these substeps:</p>

      <ol>

       <li><p>Set <var>H</var>'s value to null.</p></li>

       <li><p><span>Report the error</span> for the appropriate <span
       data-x="concept-script">script</span> and with the appropriate position (line number and
       column number) given by <var>location</var>, using the <span>global object</span>
       specified by <var>script settings</var> as the target. If the error is still <i
       data-x="concept-error-nothandled">not handled</i> after this, then the error may be reported
       to the user.</p></li>

       <li><p>Jump to the step labeled <i>end</i> below.</p></li>

      </ol>

      <p class="note"><i>FunctionBody</i> is defined in ECMAScript edition 5 section 13 Function
      Definition. <i>Early error</i> is defined in ECMAScript edition 5 section 16 Errors. <a href="#refsECMA262">\[ECMA262]</a></p>

     </li>

     <li>

      <p>If <var>body</var> begins with a Directive Prolog that contains a Use Strict
      Directive then let <var>strict</var> be true, otherwise let <var>strict</var> be false.</p> <!-- we can't defer to 10.1.1 since we're not using a
      Function constructor but doing it ourselves. -->

      <p class="note">The terms "Directive Prolog" and "Use Strict Directive" are defined in
      ECMAScript edition 5 section 14.1 Directive Prologs and the Use Strict Directive. <a href="#refsECMA262">\[ECMA262]</a></p>

     </li>

  <!-- currently this is unnecessary: https://www.w3.org/Bugs/Public/show_bug.cgi?id=11977#c4
     <li>

      <p>If <var>strict</var> is true, and anything in <var>body</var> is a
      <code>SyntaxError</code> according to the Strict Mode Restrictions, then [...handle the error
      as described above...].</p>

      <p class="note">The Strict Mode Restrictions are those listed in ECMAScript edition 5 section
      13.1 Strict Mode Restrictions. <a href="#refsECMA262">\[ECMA262]</a></p>

     </li>
  -->

     <li>

      <p>Using the <span>script execution environment</span> obtained above, create a function
      object (as defined in ECMAScript edition 5 section 13.2 Creating Function Objects), with:</p>

      <dl>

       <dt>Parameter list <var>FormalParameterList</var></dt>

       <dd>

        <dl class="switch">

         <dt>If <var>H</var> is an <code data-x="handler-onerror">onerror</code> <span
         data-x="event handlers">event handler</span> of a <code>Window</code> object</dt>

         <dd>Let the function have five arguments, named <code>event</code>, <code
        >source</code>, <code>lineno</code>, <code>colno</code>, and
         <code>error</code>.</dd>

         <!-- /colno/ is new as of 2012; see https://www.w3.org/Bugs/Public/show_bug.cgi?id=13319 and 22800 -->
         <!-- /error/ is new as of 2013; see http://lists.w3.org/Archives/Public/public-whatwg-archive/2013Jul/0313.html -->

         <dt>Otherwise</dt>

         <dd>Let the function have a single argument called <code>event</code>.</dd>

        </dl>

       </dd>

       <dt>Function body <var>FunctionBody</var></dt>

       <dd>The result of parsing <var>body</var> above.</dd>

       <dt>Lexical Environment <var>Scope</var></dt>

       <dd>

        <ol>

         <li>

          <p>If <var>H</var> is an element's <span data-x="event handlers">event
          handler</span>, then let <var>Scope</var> be the result of
          NewObjectEnvironment(<var>document</var>, the <var>global
          environment</var>).</p>

          <p>Otherwise, <var>H</var> is a <code>Window</code> object's <span data-x="event
          handlers">event handler</span>: let <var>Scope</var> be the <var>global environment</var>.</p>

         </li>

         <li><p>If <var>form owner</var> is not null, let <var>Scope</var> be
         the result of NewObjectEnvironment(<var>form owner</var>, <var>Scope</var>).</p></li>

         <li><p>If <var>element</var> is not null, let <var>Scope</var> be the
         result of NewObjectEnvironment(<var>element</var>, <var>Scope</var>).</p></li>

        </ol>

        <p class="note">NewObjectEnvironment() is defined in ECMAScript edition 5 section 10.2.2.3
        NewObjectEnvironment (O, E). <a href="#refsECMA262">\[ECMA262]</a></p>

       </dd>

       <dt>Boolean flag <var>Strict</var></dt>

       <dd>The value of <var>strict</var>.</dd>

      </dl>

      <p>Let <var>function</var> be this new function.</p>

     </li>

     <li><p>Let <var>script</var> be a new <span
     data-x="concept-script">script</span>.</p></li>

     <!-- SCRIPT EXEC -->
     <li><p>Let <var>script</var>'s <span>code entry-point</span> be <var>function</var>.</p></li>

     <li><p>Let <var>script</var>'s <span>settings object</span> be <var>script
     settings</var>.</p></li>

     <li><p>Set <var>H</var> to <var>function</var>.</p></li>

    </ol>

   </li>

   <li><p><i>End</i>: Return <var>H</var>'s value.</p></li>

  </ol>

  </div>



  <h5>Event handlers on elements, <code>Document</code> objects, and <code>Window</code> objects</h5>

  <p>The following are the <span>event handlers</span> (and their corresponding <span data-x="event
  handler event type">event handler event types</span>) <span class="impl">that must be</span>
  supported by all <span>HTML elements</span>, as both <span>event handler content attributes</span>
  and <span>event handler IDL attributes</span>; and <span class="impl">that must be</span>
  supported by all <code>Document</code> and <code>Window</code> objects, as <span>event handler IDL
  attributes</span>:</p>

  <table>
   <thead>
    <tr><th><span data-x="event handlers">Event handler</span> <th><span>Event handler event type</span>
   <tbody>
    <tr><td><dfn><code data-x="handler-onabort">onabort</code></dfn> <td> <code data-x="event-abort">abort</code>
    <tr><td><dfn><code data-x="handler-onautocomplete">onautocomplete</code></dfn> <td> <code data-x="event-autocomplete">autocomplete</code> <!-- new for requestAutocomplete() -->
    <tr><td><dfn><code data-x="handler-onautocompleteerror">onautocompleteerror</code></dfn> <td> <code data-x="event-autocompleteerror">autocompleteerror</code> <!-- new for requestAutocomplete() -->
    <tr><td><dfn><code data-x="handler-oncancel">oncancel</code></dfn> <td> <code data-x="event-cancel">cancel</code>
    <tr><td><dfn><code data-x="handler-oncanplay">oncanplay</code></dfn> <td> <code data-x="event-media-canplay">canplay</code>
    <tr><td><dfn><code data-x="handler-oncanplaythrough">oncanplaythrough</code></dfn> <td> <code data-x="event-media-canplaythrough">canplaythrough</code>
    <tr><td><dfn><code data-x="handler-onchange">onchange</code></dfn> <td> <code data-x="event-change">change</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-onclick">onclick</code></dfn> <td> <code data-x="event-click">click</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-onclose">onclose</code></dfn> <td> <code data-x="event-close">close</code> <!-- new for <dialog> -->
    <tr><td><dfn><code data-x="handler-oncontextmenu">oncontextmenu</code></dfn> <td> <code data-x="event-contextmenu">contextmenu</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-oncuechange">oncuechange</code></dfn> <td> <code data-x="event-media-cuechange">cuechange</code>
    <tr><td><dfn><code data-x="handler-ondblclick">ondblclick</code></dfn> <td> <code data-x="event-dblclick">dblclick</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-ondrag">ondrag</code></dfn> <td> <code data-x="event-dnd-drag">drag</code>
    <tr><td><dfn><code data-x="handler-ondragend">ondragend</code></dfn> <td> <code data-x="event-dnd-dragend">dragend</code>
    <tr><td><dfn><code data-x="handler-ondragenter">ondragenter</code></dfn> <td> <code data-x="event-dnd-dragenter">dragenter</code>
    <tr><td><dfn><code data-x="handler-ondragexit">ondragexit</code></dfn> <td> <code data-x="event-dnd-dragexit">dragexit</code>
    <tr><td><dfn><code data-x="handler-ondragleave">ondragleave</code></dfn> <td> <code data-x="event-dnd-dragleave">dragleave</code>
    <tr><td><dfn><code data-x="handler-ondragover">ondragover</code></dfn> <td> <code data-x="event-dnd-dragover">dragover</code>
    <tr><td><dfn><code data-x="handler-ondragstart">ondragstart</code></dfn> <td> <code data-x="event-dnd-dragstart">dragstart</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-ondrop">ondrop</code></dfn> <td> <code data-x="event-dnd-drop">drop</code>
    <tr><td><dfn><code data-x="handler-ondurationchange">ondurationchange</code></dfn> <td> <code data-x="event-media-durationchange">durationchange</code>
    <tr><td><dfn><code data-x="handler-onemptied">onemptied</code></dfn> <td> <code data-x="event-media-emptied">emptied</code>
    <tr><td><dfn><code data-x="handler-onended">onended</code></dfn> <td> <code data-x="event-media-ended">ended</code>
    <tr><td><dfn><code data-x="handler-oninput">oninput</code></dfn> <td> <code data-x="event-input">input</code>
    <tr><td><dfn><code data-x="handler-oninvalid">oninvalid</code></dfn> <td> <code data-x="event-invalid">invalid</code>
    <tr><td><dfn><code data-x="handler-onkeydown">onkeydown</code></dfn> <td> <code data-x="event-keydown">keydown</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-onkeypress">onkeypress</code></dfn> <td> <code data-x="event-keypress">keypress</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-onkeyup">onkeyup</code></dfn> <td> <code data-x="event-keyup">keyup</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-onloadeddata">onloadeddata</code></dfn> <td> <code data-x="event-media-loadeddata">loadeddata</code>
    <tr><td><dfn><code data-x="handler-onloadedmetadata">onloadedmetadata</code></dfn> <td> <code data-x="event-media-loadedmetadata">loadedmetadata</code>
    <tr><td><dfn><code data-x="handler-onloadstart">onloadstart</code></dfn> <td> <code data-x="event-media-loadstart">loadstart</code>
    <tr><td><dfn><code data-x="handler-onmousedown">onmousedown</code></dfn> <td> <code data-x="event-mousedown">mousedown</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-onmouseenter">onmouseenter</code></dfn> <td> <code data-x="event-mouseenter">mouseenter</code> <!-- compat -->
    <tr><td><dfn><code data-x="handler-onmouseleave">onmouseleave</code></dfn> <td> <code data-x="event-mouseleave">mouseleave</code> <!-- compat -->
    <tr><td><dfn><code data-x="handler-onmousemove">onmousemove</code></dfn> <td> <code data-x="event-mousemove">mousemove</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-onmouseout">onmouseout</code></dfn> <td> <code data-x="event-mouseout">mouseout</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-onmouseover">onmouseover</code></dfn> <td> <code data-x="event-mouseover">mouseover</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-onmouseup">onmouseup</code></dfn> <td> <code data-x="event-mouseup">mouseup</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-onmousewheel">onmousewheel</code></dfn> <td> <code data-x="event-mousewheel">mousewheel</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-onpause">onpause</code></dfn> <td> <code data-x="event-media-pause">pause</code>
    <tr><td><dfn><code data-x="handler-onplay">onplay</code></dfn> <td> <code data-x="event-media-play">play</code>
    <tr><td><dfn><code data-x="handler-onplaying">onplaying</code></dfn> <td> <code data-x="event-media-playing">playing</code>
    <tr><td><dfn><code data-x="handler-onprogress">onprogress</code></dfn> <td> <code data-x="event-media-progress">progress</code>
    <tr><td><dfn><code data-x="handler-onratechange">onratechange</code></dfn> <td> <code data-x="event-media-ratechange">ratechange</code>
    <tr><td><dfn><code data-x="handler-onreset">onreset</code></dfn> <td> <code data-x="event-reset">reset</code>
    <tr><td><dfn><code data-x="handler-onseeked">onseeked</code></dfn> <td> <code data-x="event-media-seeked">seeked</code>
    <tr><td><dfn><code data-x="handler-onseeking">onseeking</code></dfn> <td> <code data-x="event-media-seeking">seeking</code>
    <tr><td><dfn><code data-x="handler-onselect">onselect</code></dfn> <td> <code data-x="event-select">select</code> <!-- widely used --> <!-- \[CSSOM] -->
    <tr><td><dfn><code data-x="handler-onshow">onshow</code></dfn> <td> <code data-x="event-show">show</code>
    <tr><td><dfn><code data-x="handler-onsort">onsort</code></dfn> <td> <code data-x="event-sort">sort</code>
    <tr><td><dfn><code data-x="handler-onstalled">onstalled</code></dfn> <td> <code data-x="event-media-stalled">stalled</code>
    <tr><td><dfn><code data-x="handler-onsubmit">onsubmit</code></dfn> <td> <code data-x="event-submit">submit</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-onsuspend">onsuspend</code></dfn> <td> <code data-x="event-media-suspend">suspend</code>
    <tr><td><dfn><code data-x="handler-ontimeupdate">ontimeupdate</code></dfn> <td> <code data-x="event-media-timeupdate">timeupdate</code>
    <tr><td><dfn><code data-x="handler-ontoggle">ontoggle</code></dfn> <td> <code data-x="event-toggle">toggle</code>
    <tr><td><dfn><code data-x="handler-onvolumechange">onvolumechange</code></dfn> <td> <code data-x="event-media-volumechange">volumechange</code>
    <tr><td><dfn><code data-x="handler-onwaiting">onwaiting</code></dfn> <td> <code data-x="event-media-waiting">waiting</code>

<!-- not supported, use dnd: -->
<!--<tr><td><dfn><code data-x="handler-onbeforecopy">onbeforecopy</code></dfn> <td> <code data-x="event-cp-beforecopy">beforecopy</code>--> <!-- widely used -->
<!--<tr><td><dfn><code data-x="handler-oncopy">oncopy</code></dfn> <td> <code data-x="event-cp-copy">copy</code>--> <!-- widely used -->
<!--<tr><td><dfn><code data-x="handler-onpaste">onpaste</code></dfn> <td> <code data-x="event-cp-paste">paste</code>--> <!-- widely used -->
<!-- not supported yet (v2?): -->
<!--<tr><td><dfn><code data-x="handler-onselectstart">onselectstart</code></dfn> <td> <code data-x="event-selectstart">selectstart</code>--> <!-- widely used -->
  </table>

  <hr>

  <p>The following are the <span>event handlers</span> (and their corresponding <span data-x="event
  handler event type">event handler event types</span>) <span class="impl">that must be</span>
  supported by all <span>HTML elements</span> other than <code>body</code> and <code>frameset</code>
  elements, as both <span>event handler content attributes</span> and <span>event handler IDL
  attributes</span>; <span class="impl">that must be</span> supported by all <code>Document</code>
  objects, as <span>event handler IDL attributes</span>; and <span class="impl">that must be</span>
  supported by all <code>Window</code> objects, as <span>event handler IDL attributes</span> on the
  <code>Window</code> objects themselves, and with corresponding <span>event handler content
  attributes</span> and <span>event handler IDL attributes</span> exposed on all <code>body</code>
  and <code>frameset</code> elements that are owned by <span data-x="concept-document-window">that
  <code>Window</code> object's <code>Document</code>s</span>:</p>

  <table>
   <thead>
    <tr><th><span data-x="event handlers">Event handler</span> <th><span>Event handler event type</span>
   <tbody>
    <tr><td><dfn><code data-x="handler-onblur">onblur</code></dfn> <td> <code data-x="event-blur">blur</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-onerror">onerror</code></dfn> <td> <code data-x="event-error">error</code>
    <tr><td><dfn><code data-x="handler-onfocus">onfocus</code></dfn> <td> <code data-x="event-focus">focus</code> <!-- widely used -->
    <tr><td><dfn><code data-x="handler-onload">onload</code></dfn> <td> <code data-x="event-load">load</code>
    <tr><td><dfn><code data-x="handler-onresize">onresize</code></dfn> <td> <code data-x="event-resize">resize</code>
    <tr><td><dfn><code data-x="handler-onscroll">onscroll</code></dfn> <td> <code data-x="event-scroll">scroll</code>
  </table>

  <hr>

  <p>The following are the <span>event handlers</span> (and their corresponding <span data-x="event
  handler event type">event handler event types</span>) <span class="impl">that must be</span>
  supported by <code>Window</code> objects, as <span>event handler IDL attributes</span> on the
  <code>Window</code> objects themselves, and with corresponding <span>event handler content
  attributes</span> and <span>event handler IDL attributes</span> exposed on all <code>body</code>
  and <code>frameset</code> elements that are owned by <span data-x="concept-document-window">that
  <code>Window</code> object's <code>Document</code>s</span>:</p>

  <table>
   <thead>
    <tr><th><span data-x="event handlers">Event handler</span> <th><span>Event handler event type</span>
   <tbody>
    <tr><td><dfn><code data-x="handler-window-onafterprint">onafterprint</code></dfn> <td> <code data-x="event-afterprint">afterprint</code>
    <tr><td><dfn><code data-x="handler-window-onbeforeprint">onbeforeprint</code></dfn> <td> <code data-x="event-beforeprint">beforeprint</code>
    <tr><td><dfn><code data-x="handler-window-onbeforeunload">onbeforeunload</code></dfn> <td> <code data-x="event-beforeunload">beforeunload</code>
    <tr><td><dfn><code data-x="handler-window-onhashchange">onhashchange</code></dfn> <td> <code data-x="event-hashchange">hashchange</code> <!-- new -->
    <tr><td><dfn><code data-x="handler-window-onlanguagechange">onlanguagechange</code></dfn> <td> <code data-x="event-languagechange">languagechange</code> <!-- new -->
    <tr><td><dfn><code data-x="handler-window-onmessage">onmessage</code></dfn> <td> <code data-x="event-message">message</code> <!-- new for postMessage -->
    <tr><td><dfn><code data-x="handler-window-onoffline">onoffline</code></dfn> <td> <code data-x="event-offline">offline</code> <!-- new -->
    <tr><td><dfn><code data-x="handler-window-ononline">ononline</code></dfn> <td> <code data-x="event-online">online</code> <!-- new -->
    <tr><td><dfn><code data-x="handler-window-onpagehide">onpagehide</code></dfn> <td> <code data-x="event-pagehide">pagehide</code> <!-- new -->
    <tr><td><dfn><code data-x="handler-window-onpageshow">onpageshow</code></dfn> <td> <code data-x="event-pageshow">pageshow</code> <!-- new -->
    <tr><td><dfn><code data-x="handler-window-onpopstate">onpopstate</code></dfn> <td> <code data-x="event-popstate">popstate</code> <!-- new -->
    <tr><td><dfn><code data-x="handler-window-onstorage">onstorage</code></dfn> <td> <code data-x="event-storage">storage</code> <!-- new -->
    <tr><td><dfn><code data-x="handler-window-onunload">onunload</code></dfn> <td> <code data-x="event-unload">unload</code> <!-- widely used -->
  </table>

  <hr>

  <!-- this guy is only on Document and not on HTMLElement because otherwise HTMLScriptElement would
  have it and that causes compatibility issues since IE fires readystatechange events on <script>,
  not load events, and we can't fire both, and some sites try to decide which to look for based on
  the presence of script.onreadystatechange on HTMLScriptElement.
     https://www.w3.org/Bugs/Public/show_bug.cgi?id=13965
     https://lists.w3.org/Archives/Public/public-whatwg-archive/2011Sep/0074.html
  -->

  <p>The following are the <span>event handlers</span> (and their corresponding <span data-x="event
  handler event type">event handler event types</span>) <span class="impl">that must be</span>
  supported on <code>Document</code> objects as <span>event handler IDL attributes</span>:</p>

  <table>
   <thead>
    <tr><th><span data-x="event handlers">Event handler</span> <th><span>Event handler event type</span>
   <tbody>
    <tr><td><dfn><code data-x="handler-onreadystatechange">onreadystatechange</code></dfn> <td> <code data-x="event-readystatechange">readystatechange</code>
  </table>


  <h6 id="idl-definitions">IDL definitions</h6>

  <pre class="idl">[NoInterfaceObject]
interface <dfn>GlobalEventHandlers</dfn> {
  attribute <span>EventHandler</span> <span data-x="handler-onabort">onabort</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onautocomplete">onautocomplete</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onautocompleteerror">onautocompleteerror</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onblur">onblur</span>;
  attribute <span>EventHandler</span> <span data-x="handler-oncancel">oncancel</span>;
  attribute <span>EventHandler</span> <span data-x="handler-oncanplay">oncanplay</span>;
  attribute <span>EventHandler</span> <span data-x="handler-oncanplaythrough">oncanplaythrough</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onchange">onchange</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onclick">onclick</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onclose">onclose</span>;
  attribute <span>EventHandler</span> <span data-x="handler-oncontextmenu">oncontextmenu</span>;
  attribute <span>EventHandler</span> <span data-x="handler-oncuechange">oncuechange</span>;
  attribute <span>EventHandler</span> <span data-x="handler-ondblclick">ondblclick</span>;
  attribute <span>EventHandler</span> <span data-x="handler-ondrag">ondrag</span>;
  attribute <span>EventHandler</span> <span data-x="handler-ondragend">ondragend</span>;
  attribute <span>EventHandler</span> <span data-x="handler-ondragenter">ondragenter</span>;
  attribute <span>EventHandler</span> <span data-x="handler-ondragexit">ondragexit</span>;
  attribute <span>EventHandler</span> <span data-x="handler-ondragleave">ondragleave</span>;
  attribute <span>EventHandler</span> <span data-x="handler-ondragover">ondragover</span>;
  attribute <span>EventHandler</span> <span data-x="handler-ondragstart">ondragstart</span>;
  attribute <span>EventHandler</span> <span data-x="handler-ondrop">ondrop</span>;
  attribute <span>EventHandler</span> <span data-x="handler-ondurationchange">ondurationchange</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onemptied">onemptied</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onended">onended</span>;
  attribute <span>OnErrorEventHandler</span> <span data-x="handler-onerror">onerror</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onfocus">onfocus</span>;
  attribute <span>EventHandler</span> <span data-x="handler-oninput">oninput</span>;
  attribute <span>EventHandler</span> <span data-x="handler-oninvalid">oninvalid</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onkeydown">onkeydown</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onkeypress">onkeypress</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onkeyup">onkeyup</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onload">onload</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onloadeddata">onloadeddata</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onloadedmetadata">onloadedmetadata</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onloadstart">onloadstart</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onmousedown">onmousedown</span>;
  [LenientThis] attribute <span>EventHandler</span> <span data-x="handler-onmouseenter">onmouseenter</span>;
  [LenientThis] attribute <span>EventHandler</span> <span data-x="handler-onmouseleave">onmouseleave</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onmousemove">onmousemove</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onmouseout">onmouseout</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onmouseover">onmouseover</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onmouseup">onmouseup</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onmousewheel">onmousewheel</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onpause">onpause</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onplay">onplay</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onplaying">onplaying</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onprogress">onprogress</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onratechange">onratechange</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onreset">onreset</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onresize">onresize</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onscroll">onscroll</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onseeked">onseeked</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onseeking">onseeking</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onselect">onselect</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onshow">onshow</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onsort">onsort</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onstalled">onstalled</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onsubmit">onsubmit</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onsuspend">onsuspend</span>;
  attribute <span>EventHandler</span> <span data-x="handler-ontimeupdate">ontimeupdate</span>;
  attribute <span>EventHandler</span> <span data-x="handler-ontoggle">ontoggle</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onvolumechange">onvolumechange</span>;
  attribute <span>EventHandler</span> <span data-x="handler-onwaiting">onwaiting</span>;
};

[NoInterfaceObject]
interface <dfn>WindowEventHandlers</dfn> {
  attribute <span>EventHandler</span> <span data-x="handler-window-onafterprint">onafterprint</span>;
  attribute <span>EventHandler</span> <span data-x="handler-window-onbeforeprint">onbeforeprint</span>;
  attribute <span>OnBeforeUnloadEventHandler</span> <span data-x="handler-window-onbeforeunload">onbeforeunload</span>;
  attribute <span>EventHandler</span> <span data-x="handler-window-onhashchange">onhashchange</span>;
  attribute <span>EventHandler</span> <span data-x="handler-window-onlanguagechange">onlanguagechange</span>;
  attribute <span>EventHandler</span> <span data-x="handler-window-onmessage">onmessage</span>;
  attribute <span>EventHandler</span> <span data-x="handler-window-onoffline">onoffline</span>;
  attribute <span>EventHandler</span> <span data-x="handler-window-ononline">ononline</span>;
  attribute <span>EventHandler</span> <span data-x="handler-window-onpagehide">onpagehide</span>;
  attribute <span>EventHandler</span> <span data-x="handler-window-onpageshow">onpageshow</span>;
  attribute <span>EventHandler</span> <span data-x="handler-window-onpopstate">onpopstate</span>;
  attribute <span>EventHandler</span> <span data-x="handler-window-onstorage">onstorage</span>;
  attribute <span>EventHandler</span> <span data-x="handler-window-onunload">onunload</span>;
};</pre>



  <div class="impl">

  <h5 id="event-firing">Event firing</h5>

  <p>Certain operations and methods are defined as firing events on elements. For example, the <code
  data-x="dom-click">click()</code> method on the <code>HTMLElement</code> interface is defined as
  firing a <code data-x="event-click">click</code> event on the element. <a href="#refsUIEVENTS">\[UIEVENTS]</a></p>

  <p><dfn data-x="fire a simple event">Firing a simple event named <var>e</var></dfn>
  means that a <span data-x="concept-events-trusted">trusted</span> event with the name <var>e</var>, which does not bubble (except where otherwise stated) and is not cancelable
  (except where otherwise stated), and which uses the <code>Event</code> interface, must be created
  and <span data-x="concept-event-dispatch">dispatched</span> at the given target.</p>

  <p><dfn data-x="fire a synthetic mouse event">Firing a synthetic mouse event named <var>e</var></dfn> means that an event with the name <var>e</var>, which is <span
  data-x="concept-events-trusted">trusted</span> (except where otherwise stated), does not bubble
  (except where otherwise stated), is not cancelable (except where otherwise stated), and which uses
  the <code>MouseEvent</code> interface, must be created and dispatched at the given target. The
  event object must have its <code>screenX</code>, <code>screenY</code>, <code
 >clientX</code>, <code>clientY</code>, and <code>button</code>
  attributes initialized to 0, its <code>ctrlKey</code>, <code>shiftKey</code>,
  <code>altKey</code>, and <code>metaKey</code> attributes initialized according
  to the current state of the key input device, if any (false for any keys that are not available),
  its <code>detail</code> attribute initialized to 1, its <code
  data-x="dom-MouseEvent-relatedTarget">relatedTarget</code> attribute initialized to null (except
  where otherwise stated), and its <code
  data-x="dom-UIEvent-view">view</code> attribute initialized to the <code>Window</code> object of the <code>Document</code> object of the given target node, if any, or else null. The <code>getModifierState()</code> method on the object must
  return values appropriately describing the state of the key input device at the time the event is
  created.</p>

  <p><dfn data-x="fire a click event">Firing a <code data-x="event-click">click</code> event</dfn>
  means <span data-x="fire a synthetic mouse event">firing a synthetic mouse event named <code
  data-x="event-click">click</code></span>, which bubbles and is cancelable.</p>

  <p>The default action of these events is to do nothing except where otherwise stated.</p>

  </div>


  <div class="impl">

  <h5>Events and the <code>Window</code> object</h5>

  <p>When an event is dispatched at a DOM node in a <code>Document</code> in a <span>browsing
  context</span>, if the event is not a <code data-x="event-load">load</code> event, the user agent
  must act as if, for the purposes of <span data-x="concept-event-dispatch">event dispatching</span>,
  the <code>Window</code> object is the parent of the <code>Document</code> object. <a href="#refsDOM">\[DOM]</a></p>

  <!-- If Anne does this: http://krijnhoetmer.nl/irc-logs/whatwg/20121205#l-4 (see bug 18780)
  <p>If a <code>Document</code> object is associated with a <code>Window</code> object, its
  <span>event parent</span> is that <code>Window</code> object.</p>
  -->

  </div>


  <h3 id="atob">Base64 utility methods</h3>

  <p>The <code data-x="dom-windowbase64-atob">atob()</code> and <code
  data-x="dom-windowbase64-btoa">btoa()</code> methods allow authors to transform content to and from
  the base64 encoding.</p>

  <!-- v2: actual binary support -->

  <pre class="idl">[NoInterfaceObject, Exposed=(Window, Worker)]
interface <dfn>WindowBase64</dfn> {
  DOMString <span data-x="dom-windowbase64-btoa">btoa</span>(DOMString btoa);
  DOMString <span data-x="dom-windowbase64-atob">atob</span>(DOMString atob);
};
<span>Window</span> implements <span>WindowBase64</span>;
<span>WorkerGlobalScope</span> implements <span>WindowBase64</span>;</pre>

  <p class="note">In these APIs, for mnemonic purposes, the "b" can be considered to stand for
  "binary", and the "a" for "ASCII". In practice, though, for primarily historical reasons, both the
  input and output of these functions are Unicode strings.</p>

  <dl class="domintro">

   <dt><var>result</var> = <var>window</var> . <code subdfn data-x="dom-windowbase64-btoa">btoa</code>( <var>data</var> )</dt>

   <dd>

    <p>Takes the input data, in the form of a Unicode string containing only characters in the range
    U+0000 to U+00FF, each representing a binary byte with values 0x00 to 0xFF respectively, and
    converts it to its base64 representation, which it returns.</p>

    <p>Throws an <code>InvalidCharacterError</code> exception if the input string contains any
    out-of-range characters.</p>

   </dd>

   <dt><var>result</var> = <var>window</var> . <code subdfn data-x="dom-windowbase64-atob">atob</code>( <var>data</var> )</dt>

   <dd>

    <p>Takes the input data, in the form of a Unicode string containing base64-encoded binary data,
    decodes it, and returns a string consisting of characters in the range U+0000 to U+00FF, each
    representing a binary byte with values 0x00 to 0xFF respectively, corresponding to that binary
    data.</p>

    <p>Throws an <code>InvalidCharacterError</code> exception if the input string is not valid
    base64 data.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-windowbase64-btoa">btoa()</code></dfn> method must throw an
  <code>InvalidCharacterError</code> exception if the method's first argument contains any character
  whose code point is greater than U+00FF. Otherwise, the user agent must convert that argument to a
  sequence of octets whose <var>n</var>th octet is the eight-bit representation of the code
  point of the <var>n</var>th character of the argument, and then must apply the base64
  algorithm to that sequence of octets, and return the result. <a href="#refsRFC4648">\[RFC4648]</a><!--base64--></p> <!-- Aryeh says: This seems to be what all
  browsers do as of January 2011 (except IE, which doesn't support these functions at all). -->


  <p>The <dfn><code data-x="dom-windowbase64-atob">atob()</code></dfn> method must run the following
  steps to parse the string passed in the method's first argument:</p>

  <ol>

   <!-- Aryeh says: Copies Firefox behavior as of January 2011 (4.0b8). WebKit is somewhat laxer,
   and Opera throws no exceptions at all. gsnedders reports Opera's behavior causes site-compat
   problems, and I figure most sites depend on Firefox if on anything, so go with that. -->

   <!-- Since updated to drop whitespace, based on the arguments here:
      http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2011-May/031613.html
   -->

   <li><p>Let <var>input</var> be the string being parsed.</p></li>

   <li><p>Let <var>position</var> be a pointer into <var>input</var>, initially
   pointing at the start of the string.</p></li>

   <li><p>Remove all <span data-x="space character">space characters</span> from <var>input</var>.</p></li>

   <li><p>If the length of <var>input</var> divides by 4 leaving no remainder, then: if
   <var>input</var> ends with one or two U+003D EQUALS SIGN (=) characters, remove them
   from <var>input</var>.</p></li>

   <li><p>If the length of <var>input</var> divides by 4 leaving a remainder of 1, throw an
   <code>InvalidCharacterError</code> exception and abort these steps.</p>

   <li>

    <p>If <var>input</var> contains a character that is not in the following list of
    characters and character ranges, throw an <code>InvalidCharacterError</code> exception and abort
    these steps:</p>

    <ul class="brief">
     <li>U+002B PLUS SIGN (+)
     <li>U+002F SOLIDUS (/)
     <li><span>Alphanumeric ASCII characters</span>
    </ul>

   </li>

   <li><p>Let <var>output</var> be a string, initially empty.</p></li>

   <li><p>Let <var>buffer</var> be a buffer that can have bits appended to it, initially
   empty.</p></li>

   <li>

    <p>While <var>position</var> does not point past the end of <var>input</var>,
    run these substeps:</p>

    <ol>

     <li>

      <p>Find the character pointed to by <var>position</var> in the first column of the
      following table. Let <var>n</var> be the number given in the second cell of the same
      row.</p>

      <div id="base64-table">
       <table>
        <thead>
         <tr>
          <th>Character
          <th>Number
        <tbody>
         <tr><td>A<td>0
         <tr><td>B<td>1
         <tr><td>C<td>2
         <tr><td>D<td>3
         <tr><td>E<td>4
         <tr><td>F<td>5
         <tr><td>G<td>6
         <tr><td>H<td>7
         <tr><td>I<td>8
         <tr><td>J<td>9
         <tr><td>K<td>10
         <tr><td>L<td>11
         <tr><td>M<td>12
         <tr><td>N<td>13
         <tr><td>O<td>14
         <tr><td>P<td>15
         <tr><td>Q<td>16
         <tr><td>R<td>17
         <tr><td>S<td>18
         <tr><td>T<td>19
         <tr><td>U<td>20
         <tr><td>V<td>21
         <tr><td>W<td>22
         <tr><td>X<td>23
         <tr><td>Y<td>24
         <tr><td>Z<td>25
         <tr><td>a<td>26
         <tr><td>b<td>27
         <tr><td>c<td>28
         <tr><td>d<td>29
         <tr><td>e<td>30
         <tr><td>f<td>31
         <tr><td>g<td>32
         <tr><td>h<td>33
         <tr><td>i<td>34
         <tr><td>j<td>35
         <tr><td>k<td>36
         <tr><td>l<td>37
         <tr><td>m<td>38
         <tr><td>n<td>39
         <tr><td>o<td>40
         <tr><td>p<td>41
         <tr><td>q<td>42
         <tr><td>r<td>43
         <tr><td>s<td>44
         <tr><td>t<td>45
         <tr><td>u<td>46
         <tr><td>v<td>47
         <tr><td>w<td>48
         <tr><td>x<td>49
         <tr><td>y<td>50
         <tr><td>z<td>51
         <tr><td>0<td>52
         <tr><td>1<td>53
         <tr><td>2<td>54
         <tr><td>3<td>55
         <tr><td>4<td>56
         <tr><td>5<td>57
         <tr><td>6<td>58
         <tr><td>7<td>59
         <tr><td>8<td>60
         <tr><td>9<td>61
         <tr><td>+<td>62
         <tr><td>/<td>63
       </table>
      </div>

     </li>

     <li><p>Append to <var>buffer</var> the six bits corresponding to <var>number</var>, most significant bit first.</p></li>

     <li><p>If <var>buffer</var> has accumulated 24 bits, interpret them as three 8-bit
     big-endian numbers. Append the three characters with code points equal to those numbers to <var>output</var>, in the same order, and then empty <var>buffer</var>.</p></li>

     <li><p>Advance <var>position</var> by one character.</p></li>

    </ol>

   </li>

   <li>

    <p>If <var>buffer</var> is not empty, it contains either 12 or 18 bits. If it contains
    12 bits, discard the last four and interpret the remaining eight as an 8-bit big-endian number.
    If it contains 18 bits, discard the last two and interpret the remaining 16 as two 8-bit
    big-endian numbers. Append the one or two characters with code points equal to those one or two
    numbers to <var>output</var>, in the same order.</p>

    <p class="note">The discarded bits mean that, for instance, <code>atob("YQ")</code> and
    <code>atob("YR")</code> both return "<code>a</code>".</p>

   </li>

   <li><p>Return <var>output</var>.</p></li>

  </ol>

  <!-- Note: this function is defined explicitly here because RFC4648 does not specify how to handle
  erroneous input, and no preexisting browser implementation simply throws an exception on all
  erroneous input. -->

  </div>


<!--TOPIC:HTML Syntax and Parsing-->
  <h3 id="dynamic-markup-insertion"><dfn>Dynamic markup insertion</dfn></h3>

  <p class="note">APIs for dynamically inserting markup into the document interact with the parser,
  and thus their behavior varies depending on whether they are used with <span>HTML documents</span>
  (and the <span>HTML parser</span>) or XHTML in <span>XML documents</span> (and the <span>XML
  parser</span>).</p>



  <h4 id="opening-the-input-stream">Opening the input stream</h4>

  <p>The <dfn><code data-x="dom-document-open">open()</code></dfn> method comes in several variants
  with different numbers of arguments.</p>

  <dl class="domintro">

   <dt><var>document</var> = <var>document</var> . <code subdfn data-x="dom-document-open">open</code>( [ <var>type</var> [, <var>replace</var> ] ] )</dt>

   <dd>

    <p>Causes the <code>Document</code> to be replaced in-place, as if it was a new
    <code>Document</code> object, but reusing the previous object, which is then returned.</p>

    <p>If the <var>type</var> argument is omitted or has the value
    "<code>text/html</code>", then the resulting <code>Document</code> has an HTML parser associated
    with it, which can be given data to parse using <code
    data-x="dom-document-write">document.write()</code>. Otherwise, all content passed to <code
    data-x="dom-document-write">document.write()</code> will be parsed as plain text.</p>

    <p>If the <var>replace</var> argument is present and has the value "<code
   >replace</code>", the existing entries in the session history for the
    <code>Document</code> object are removed.</p>

    <p>The method has no effect if the <code>Document</code> is still being parsed.</p>

    <p>Throws an <code>InvalidStateError</code> exception if the <code>Document</code> is an <span
    data-x="XML documents">XML document</span>.</p>

   </dd>

   <dt><var>window</var> = <var>document</var> . <code data-x="dom-document-open">open</code>( <var>url</var>, <var>name</var>, <var>features</var> [, <var>replace</var> ] )</dt>

   <dd>

    <p>Works like the <code data-x="dom-open">window.open()</code> method.</p>

   </dd>

  </dl>

  <div class="impl">

  <p><code>Document</code> objects have an <dfn>ignore-opens-during-unload counter</dfn>, which is
  used to prevent scripts from invoking the <code data-x="dom-document-open">document.open()</code>
  method (directly or indirectly) while the document is <span data-x="unload a document">being
  unloaded</span>. Initially, the counter must be set to zero.</p> <!--
  http://www.hixie.ch/tests/adhoc/dom/level0/document/open/unload/ -->

  <p>When called with two arguments (or fewer), the <code data-x="dom-document-open">document.open()</code>
  method must act as follows:</p>

  <ol>

   <li><p>If the <code>Document</code> object is not flagged as an <span data-x="HTML documents">HTML
   document</span>, throw an <code>InvalidStateError</code> exception and abort these steps.</p></li>

   <li><p>If the <code>Document</code> object is not an <span>active document</span>, then abort
   these steps.</p></li>

   <li><p>Let <var>type</var> be the value of the first argument.</p></li>

   <li>

    <p>If the second argument is an <span>ASCII case-insensitive</span> match for the value
    "replace", then let <var>replace</var> be true.</p>

    <p>Otherwise, if the <span>browsing context</span>'s <span>session history</span> contains only
    one <code>Document</code>, and that was the <code>about:blank</code> <code>Document</code>
    created when the <span>browsing context</span> was <span data-x="creating a new browsing context">created</span>, and that <code>Document</code> has
    never had the <span>unload a document</span> algorithm invoked on it (e.g. by a previous call to
    <code data-x="dom-document-open">document.open()</code>), then let <var>replace</var> be
    true.</p>

    <p>Otherwise, let <var>replace</var> be false.</p>

   </li>

   <li>

    <p>If the <code>Document</code> has an <span>active parser</span> whose <span>script nesting
    level</span> is greater than zero, then the method does nothing. Abort these steps and return
    the <code>Document</code> object on which the method was invoked.</p>

    <p class="note">This basically causes <code data-x="dom-document-open">document.open()</code> to
    be ignored when it's called in an inline script found during parsing, while still letting it
    have an effect when called from a non-parser task such as a timer callback or event handler.</p>

   </li>

   <li>

    <p>Similarly, if the <code>Document</code>'s <span>ignore-opens-during-unload counter</span> is
    greater than zero, then the method does nothing. Abort these steps and return the
    <code>Document</code> object on which the method was invoked.</p>

    <p class="note">This basically causes <code data-x="dom-document-open">document.open()</code> to
    be ignored when it's called from a <code data-x="event-beforeunload">beforeunload</code> <code
    data-x="event-pagehide">pagehide</code>, or <code data-x="event-unload">unload</code> event
    handler while the <code>Document</code> is being unloaded.</p>

   </li>

   <li><p>Release the <span>storage mutex</span>.</p></li>

   <li><p>Set the <code>Document</code>'s <i
   data-x="concept-document-salvageable">salvageable</i> state to false.</p></li>

   <li><p><span data-x="prompt to unload a document">Prompt to unload</span> the
   <code>Document</code> object. If the user <span>refused to allow the document to be
   unloaded</span>, then abort these steps and return the <code>Document</code> object on which the
   method was invoked.</p></li>

   <li><p><span data-x="unload a document">Unload</span> the <code>Document</code> object, with the
   <var>recycle</var> parameter set to true.</p></li>

   <li><p><span data-x="abort a document">Abort</span> the <code>Document</code>.</p></li>

   <li><p>Unregister all event listeners registered on the <code>Document</code> node and its
   descendants.</p>

   <li><p>Remove any <span data-x="concept-task">tasks</span> associated with the
   <code>Document</code> in any <span>task source</span>.</p></li> <!-- removes callbacks that fired
   between this algorithm starting and the times and databases being aborted in the "unload" step
   above -->

   <li><p>Remove all child nodes of the document, without firing any mutation events.</p></li> <!--
   as of 2009-03-30, only WebKit fired mutation events here. -->

   <li>

    <p>Replace the <code>Document</code>'s singleton objects with new instances of those objects.
    (This includes in particular the <code>Window</code>, <code>Location</code>,
    <code>History</code>, <code>ApplicationCache</code>, and <code>Navigator</code>, objects, the
    various <code>BarProp</code> objects, the two <code>Storage</code> objects, the various
    <code>HTMLCollection</code> objects, and objects defined by other specifications, like
    <code>Selection</code><!--and the document's <code>UndoManager</code>-->. It also includes all the Web
    IDL prototypes in the JavaScript binding, including the <code>Document</code> object's
    prototype.)</p>

    <p class="note">The new <code>Window</code> object has a new <span>environment settings
    object</span>.</p>

   </li>

   <li><p>Set the new <code>Window</code> object's <span data-x="concept-window-https-state">HTTPS
   state</span> to the <span data-x="concept-window-https-state">HTTPS state</span> of the
   <code>Window</code> object of the <a>responsible document</a> specified by the <span>entry
   settings object</span>.</p></li>

   <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C!DOCTYPE%20html%3E...%3Ciframe%20src%3D%22document%22%3E%3C%2Fiframe%3E%0A%3Cscript%3Eonload%20%3D%20function%20()%20%7B%20f%20%3D%20document.getElementsByTagName('iframe')%5B0%5D%3B%20d%20%3D%20f.contentWindow.document%3B%20%7D%3C%2Fscript%3E%0A%3Cinput%20type%3Dbutton%20onclick%3D%22w(d.documentElement.innerHTML)%22%20value%3D%22dump%22%3E%0A%3Cinput%20type%3Dbutton%20onclick%3D%22d.open()%3B%20d.write('%3Cscript%3Evar%20x%20%3D%20new%20XMLHttpRequest()%3Bx.open(%26quot%3BGET%26quot%3B%2C%20%26quot%3BGET%26quot%3B)%3Bx.onreadystatechange%3Dfunction()%20%7B%20alert(x.readyState)%3B%20%7D%3Bx.send(null)%3B%3C%2Fscript%3E')%3Bd.close()%3B%20setTimeout(function()%20%7B%20d.open()%3B%20d.write('%3Cp%3Etest%3C%2Fp%3E')%3B%20d.close()%20%7D%2C%200)%3B%22%20value%3D%22xhr%22%3E%0A%3Cinput%20type%3Dbutton%20onclick%3D%22d.onclick%20%3D%20function()%20%7B%20w('click')%20%7D%22%20value%3D%22add%20click%20handler%22%3E%0A%3Cinput%20type%3Dbutton%20onclick%3D%22d.open()%3B%20d.write('%3Cp%3Etest%3C%2Fp%3E')%3B%20d.close()%22%20value%3D%22replace%22%3E%0A%3Cinput%20type%3Dbutton%20onclick%3D%22d.open()%3B%20d.write('%3Cp%3E%3Cscript%3Ei%20%3D%200%3B%20setTimeout(%26quot%3Bparent.w(i%2B%2B)%26quot%3B%2C%202000)%3C%2Fscript%3E%3C%2Fp%3E')%3B%20d.close()%22%20value%3D%22replace%20with%20timer%22%3E -->
   <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C!DOCTYPE%20html%3E%0D%0A...%3Ciframe%3E%3C%2Fiframe%3E%0D%0A%3Cscript%3E%0D%0Aonload%20%3D%20function%20()%20%7B%0D%0A%20frames%5B0%5D.test%20%3D%201%0D%0A%20w(frames%5B0%5D.test)%3B%0D%0A%20var%20a%20%3D%20frames%5B0%5D.document.location.assign%3B%0D%0A%20w(a)%3B%0D%0A%20w(frames%5B0%5D.document.location.assign%20%3D%3D%3D%20a)%3B%0D%0A%20frames%5B0%5D.document.open()%3B%0D%0A%20frames%5B0%5D.document.write('%3Cscript%3Edocument.write(test)%3C%5C%2Fscript%3E')%3B%0D%0A%20frames%5B0%5D.document.close()%3B%0D%0A%20w(frames%5B0%5D.test)%3B%0D%0A%20w(frames%5B0%5D.document.location.assign%20%3D%3D%3D%20a)%3B%0D%0A%7D%0D%0A%3C%2Fscript%3E -->

   <li><p>Change the <span>document's character encoding</span> to UTF-8.</p></li>

   <li><p>If the <code>Document</code> is <span>ready for post-load tasks</span>, then set the
   <code>Document</code> object's <span>reload override flag</span> and set the
   <code>Document</code>'s <span>reload override buffer</span> to the empty string.</p></li>

   <li><p>Set the <code>Document</code>'s <i
   data-x="concept-document-salvageable">salvageable</i> state back to true.</p></li>

   <li><p>Change <span>the document's address</span> to the <span data-x="the document's
   address">address</span> of the <span>responsible document</span> specified by the <span>entry
   settings object</span>.</p></li>

   <!-- <span>the document's referrer</span> stays the same -->

   <li><p>If the <code>Document</code>'s <span>iframe load in progress</span> flag is set, set the
   <code>Document</code>'s <span>mute iframe load</span> flag.</p></li>

   <li><p>Create a new <span>HTML parser</span> and associate it with the document. This is a
   <dfn>script-created parser</dfn> (meaning that it can be closed by the <code
   data-x="dom-document-open">document.open()</code> and <code
   data-x="dom-document-close">document.close()</code> methods, and that the tokenizer will wait for
   an explicit call to <code data-x="dom-document-close">document.close()</code> before emitting an
   end-of-file token). The encoding <span data-x="concept-encoding-confidence">confidence</span> is
   <i>irrelevant</i>.</p></li>

   <li><p>Set the <span>current document readiness</span> of the document to "<code
  >loading</code>".</p></li>

   <li>

    <!-- text/plain handling -->

    <p>If <var>type</var> is an <span>ASCII case-insensitive</span> match for the string
    "<code>replace</code>", then, for historical reasons, set it to the string "<code
   >text/html</code>".</p>

    <p>Otherwise:</p>

    <p>If the <var>type</var> string contains a U+003B SEMICOLON character (;), remove the
    first such character and all characters from it up to the end of the string.</p>

    <p><span>Strip leading and trailing whitespace</span> from <var>type</var>.</p>

   </li>

   <li>

    <p>If <var>type</var> is <em>not</em> now an <span>ASCII case-insensitive</span> match
    for the string "<code>text/html</code>", then act as if the tokenizer had emitted a start tag
    token with the tag name "pre" followed by a single U+000A LINE FEED (LF) character<!-- to get
    eaten, so that a leading LF in the written text doesn't get eaten itself-->, then switch the
    <span>HTML parser</span>'s tokenizer to the <span>PLAINTEXT state</span>.</p>

    <!--
 http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C!DOCTYPE%20html%3E...%3Ciframe%3E%3C%2Fiframe%3E%3Cscript%3Eonload%20%3D%20function%20()%20%7B%20%0D%0A%20%20var%20d%20%3D%20document.getElementsByTagName('iframe')%5B0%5D.contentDocument%3B%0D%0A%20%20d.open('image%2Fsvg%2Bxml')%3B%0D%0A%20%20d.write(%22%3Cinput%20xmlns%3D'http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml'%20value%3D'(x)html'%2F%3E%22)%3B%0D%0A%20%20d.close()%3B%0D%0A%7D%3B%3C%2Fscript%3E
 http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C!DOCTYPE%20html%3E...%3Ciframe%3E%3C%2Fiframe%3E%3Cscript%3Eonload%20%3D%20function%20()%20%7B%20%0D%0A%20%20var%20d%20%3D%20document.getElementsByTagName('iframe')%5B0%5D.contentDocument%3B%0D%0A%20%20d.open('image%2Fgif')%3B%0D%0A%20%20var%20a%20%3D%20%5B%200x47%2C%200x49%2C%200x46%2C%200x38%2C%200x39%2C%200x61%2C%200x01%2C%200x00%2C%200x01%2C%200x00%2C%0D%0A%20%20%20%20%20%20%20%20%20%20%20%200x80%2C%200xff%2C%200x00%2C%200xc0%2C%200xc0%2C%200xc0%2C%200x00%2C%200x00%2C%200x00%2C%200x21%2C%0D%0A%20%20%20%20%20%20%20%20%20%20%20%200xf9%2C%200x04%2C%200x01%2C%200x00%2C%200x00%2C%200x00%2C%200x00%2C%200x2c%2C%200x00%2C%200x00%2C%0D%0A%20%20%20%20%20%20%20%20%20%20%20%200x00%2C%200x00%2C%200x01%2C%200x00%2C%200x01%2C%200x00%2C%200x00%2C%200x02%2C%200x02%2C%200x44%2C%0D%0A%20%20%20%20%20%20%20%20%20%20%20%200x01%2C%200x00%2C%200x3b%20%5D%3B%0D%0A%20%20var%20s%20%3D%20%22%22%3B%0D%0A%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20a.length%3B%20i%20%2B%3D%201)%0D%0A%20%20%20%20s%20%2B%3D%20String.fromCharCode(a%5Bi%5D)%3B%0D%0A%20%20d.write(s)%3B%0D%0A%20%20d.close()%3B%0D%0A%7D%3B%3C%2Fscript%3E
 http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C!DOCTYPE%20html%3E...%3Ciframe%3E%3C%2Fiframe%3E%3Cscript%3Eonload%20%3D%20function%20()%20{%20%0A%20%20var%20d%20%3D%20document.getElementsByTagName(%27iframe%27)[0].contentDocument%3B%0A%20%20d.open(%27Text%2Fplain%27)%3B%0A%20%20d.write(%27%3Cb%3Etest%27)%3B%0A%20%20d.close()%3B%0A}%3B%3C%2Fscript%3E
 http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C!DOCTYPE%20html%3E...%3Ciframe%3E%3C%2Fiframe%3E%3Cscript%3Eonload%20%3D%20function%20()%20{%20%0A%20%20var%20d%20%3D%20document.getElementsByTagName(%27iframe%27)[0].contentDocument%3B%0A%20%20d.open(%27%20text%2Fplain%27)%3B%0A%20%20d.write(%27%3Cb%3Etest%27)%3B%0A%20%20d.close()%3B%0A}%3B%3C%2Fscript%3E
 http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C!DOCTYPE%20html%3E...%3Ciframe%3E%3C%2Fiframe%3E%3Cscript%3Eonload%20%3D%20function%20()%20{%20%0A%20%20var%20d%20%3D%20document.getElementsByTagName(%27iframe%27)[0].contentDocument%3B%0A%20%20d.open(%27text%2Fplain%3B%27)%3B%0A%20%20d.write(%27%3Cb%3Etest%27)%3B%0A%20%20d.close()%3B%0A}%3B%3C%2Fscript%3E
    -->

   </li>

   <li>

    <p>Remove all the entries in the <span>browsing context</span>'s <span>session history</span>
    after the <span>current entry</span>. If the <span>current entry</span> is the last entry in the
    session history, then no entries are removed.</p>

    <p class="note">This <a href="#history-notes">doesn't necessarily have to affect</a> the user
    agent's user interface.</p>

   </li>

   <li><p>Remove any <span data-x="concept-task">tasks</span> queued by the <span>history traversal
   task source</span> that are associated with any <code>Document</code> objects in the
   <span>top-level browsing context</span>'s <span>document family</span>.</p></li>

   <li>Remove any earlier entries that share the same <code>Document</code>.</li>

   <li><p>If <var>replace</var> is false, then add a new entry, just before the last entry,
   and associate with the new entry the text that was parsed by the previous parser associated with
   the <code>Document</code> object, as well as the state of the document at the start of these
   steps. This allows the user to step backwards in the session history to see the page before it
   was blown away by the <code data-x="dom-document-open">document.open()</code> call. This new entry
   does not have a <code>Document</code> object, so a new one will be created if the session history
   is traversed to that entry.</p></li>

   <li><p>Finally, set the <span>insertion point</span> to point at just before the end of the
   <span>input stream</span> (which at this point will be empty).</p></li>

   <li><p>Return the <code>Document</code> on which the method was invoked.</p></li>

  </ol>

  <p class="note">The <code data-x="dom-document-open">document.open()</code> method does not affect
  whether a <code>Document</code> is <span>ready for post-load tasks</span> or <span>completely
  loaded</span>.</p>

  <p>When called with four arguments, the <code data-x="dom-document-open">open()</code> method on
  the <code>Document</code> object must call the <code data-x="dom-open">open()</code> method on the
  <code>Window</code> object of the <code>Document</code> object, with the same arguments as the
  original call to the <code data-x="dom-document-open">open()</code> method, and return whatever
  that method returned. If the <code>Document</code> object has no <code>Window</code> object, then
  the method must throw an <code>InvalidAccessError</code> exception.</p>

  </div>



  <h4 id="closing-the-input-stream">Closing the input stream</h4>

  <dl class="domintro">

   <dt><var>document</var> . <code subdfn data-x="dom-document-close">close</code>()</dt>

   <dd>

    <p>Closes the input stream that was opened by the <code
    data-x="dom-document-open">document.open()</code> method.</p>

    <p>Throws an <code>InvalidStateError</code> exception if the
    <code>Document</code> is an <span data-x="XML documents">XML
    document</span>.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-document-close">close()</code></dfn> method must run the following
  steps:</p>

  <ol>

   <li><p>If the <code>Document</code> object is not flagged as an <span data-x="HTML documents">HTML
   document</span>, throw an <code>InvalidStateError</code> exception and abort these
   steps.</p></li>

   <li><p>If there is no <span>script-created parser</span> associated with the document, then abort
   these steps.</p></li>

   <li><p>Insert an <span>explicit "EOF" character</span> at the end of the parser's <span>input
   stream</span>.</p></li>

   <li><p>If there is a <span>pending parsing-blocking script</span>, then abort these
   steps.</p></li>

   <li><p>Run the tokenizer, processing resulting tokens as they are emitted, and stopping when the
   tokenizer reaches the <span>explicit "EOF" character</span> or <span data-x="spin the event
   loop">spins the event loop</span>.</p></li>

  </ol>

  </div>



  <h4><code data-x="dom-document-write">document.write()</code></h4>

  <dl class="domintro">

   <dt><var>document</var> . <code subdfn data-x="dom-document-write">write</code>(<var>text</var>...)</dt>

   <dd>

    <p>In general, adds the given string(s) to the <code>Document</code>'s input stream.</p>

    <p class="warning">This method has very idiosyncratic behavior. In some cases, this method can
    affect the state of the <span>HTML parser</span> while the parser is running, resulting in a DOM
    that does not correspond to the source of the document (e.g. if the string written is the string
    "<code>&lt;plaintext&gt;</code>" or "<code>&lt;!--</code>"). In other cases,
    the call can clear the current page first, as if <code
    data-x="dom-document-open">document.open()</code> had been called. In yet more cases, the method
    is simply ignored, or throws an exception. To make matters worse, the exact behavior of this
    method can in some cases be dependent on network latency<!--

     Namely, in the following case:

        <script>
         document.write('<link rel=stylesheet href=foo.css><script></script>x');
         // at this point, whether the DOM contains an "x" or not depends on how quickly the foo.css file could be processed
        </script>

    -->, which can lead to failures that are very hard to debug. <strong>For all these reasons, use
    of this method is strongly discouraged.</strong></p>

    <p>This method throws an <code>InvalidStateError</code> exception when invoked on <span>XML
    documents</span>.</p>

   </dd>

  </dl>

  <div class="impl">

  <p><code>Document</code> objects have an <dfn>ignore-destructive-writes counter</dfn>, which is
  used in conjunction with the processing of <code>script</code> elements to prevent external
  scripts from being able to use <code data-x="dom-document-write">document.write()</code> to blow
  away the document by implicitly calling <code data-x="dom-document-open">document.open()</code>.
  Initially, the counter must be set to zero.</p>

  <p>The <dfn><code data-x="dom-document-write">document.write(...)</code></dfn> method must act as
  follows:</p>

  <ol>

   <li>

    <p>If the method was invoked on an <span data-x="XML documents">XML document</span>, throw an
    <code>InvalidStateError</code> exception and abort these steps.</p>

    <!--
    Where would document.write() insert?
    Consider: data:text/xml,<script xmlns="http://www.w3.org/1999/xhtml"><![CDATA[ document.write('<foo>Test</foo>'); ]]></script>
    -->

   </li>

   <li><p>If the <code>Document</code> object is not an <span>active document</span>, then abort
   these steps.</p></li>

   <li>

    <p>If the <span>insertion point</span> is undefined and either the <code>Document</code>'s
    <span>ignore-opens-during-unload counter</span> is greater than zero or the
    <code>Document</code>'s <span>ignore-destructive-writes counter</span> is greater than zero,
    abort these steps.</p>

   </li>

   <li>

    <p>If the <span>insertion point</span> is undefined, call the <code
    data-x="dom-document-open">open()</code> method on the <code data-x="Document">document</code>
    object (with no arguments). If the user <span>refused to allow the document to be
    unloaded</span>, then abort these steps. Otherwise, the <span>insertion point</span> will point
    at just before the end of the (empty) <span>input stream</span>.</p>

   </li>

   <li>

    <p>Insert the string consisting of the concatenation of all the arguments to the method into the
    <span>input stream</span> just before the <span>insertion point</span>.</p>

   </li>

   <li>

    <p>If the <code>Document</code> object's <span>reload override flag</span> is set, then append
    the string consisting of the concatenation of all the arguments to the method to the
    <code>Document</code>'s <span>reload override buffer</span>.</p>

   </li>

   <li>

    <p>If there is no <span>pending parsing-blocking script</span>, have the <span>HTML
    parser</span> process the characters that were inserted, one at a time, processing resulting
    tokens as they are emitted, and stopping when the tokenizer reaches the insertion point or when
    the processing of the tokenizer is aborted by the tree construction stage (this can happen if a
    <code>script</code> end tag token is emitted by the tokenizer).

    <p class="note">If the <code data-x="dom-document-write">document.write()</code> method was
    called from script executing inline (i.e. executing because the parser parsed a set of
    <code>script</code> tags), then this is a <a href="#nestedParsing">reentrant invocation of the
    parser</a>.</p>

   </li>

   <li>

    <p>Finally, return from the method.</p>

   </li>

  </ol>

  </div>


  <h4><code data-x="dom-document-writeln">document.writeln()</code></h4>

  <dl class="domintro">

   <dt><var>document</var> . <code subdfn data-x="dom-document-writeln">writeln</code>(<var>text</var>...)</dt>

   <dd>

    <p>Adds the given string(s) to the <code>Document</code>'s input stream, followed by a newline
    character. If necessary, calls the <code data-x="dom-document-open">open()</code> method
    implicitly first.</p>

    <p>This method throws an <code>InvalidStateError</code> exception when invoked on <span>XML
    documents</span>.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-document-writeln">document.writeln(...)</code></dfn> method, when
  invoked, must act as if the <code data-x="dom-document-write">document.write()</code> method had
  been invoked with the same argument(s), plus an extra argument consisting of a string containing a
  single line feed character (U+000A).</p>

  </div>



  <h3 id="timers">Timers</h3>

  <p>The <code data-x="dom-windowtimers-setTimeout">setTimeout()</code>
  and <code data-x="dom-windowtimers-setInterval">setInterval()</code>
  methods allow authors to schedule timer-based callbacks.</p>

  <pre class="idl">[NoInterfaceObject, Exposed=(Window,Worker)]
interface <dfn>WindowTimers</dfn> {
  long <span data-x="dom-windowtimers-setTimeout">setTimeout</span>(<span data-x="idl-Function">Function</span> handler, optional long timeout = 0, any... arguments);
  long <span data-x="dom-windowtimers-setTimeout">setTimeout</span>(DOMString handler, optional long timeout = 0, any... arguments);
  void <span data-x="dom-windowtimers-clearTimeout">clearTimeout</span>(optional long handle = 0);
  long <span data-x="dom-windowtimers-setInterval">setInterval</span>(<span data-x="idl-Function">Function</span> handler, optional long timeout = 0, any... arguments);
  long <span data-x="dom-windowtimers-setInterval">setInterval</span>(DOMString handler, optional long timeout = 0, any... arguments);
  void <span data-x="dom-windowtimers-clearInterval">clearInterval</span>(optional long handle = 0);
};
<span>Window</span> implements <span>WindowTimers</span>;
<span>WorkerGlobalScope</span> implements <span>WindowTimers</span>;</pre>

  <!-- Demonstrating the need for wrapping of the timeout argument value treated as long rather than clamping or treating as double:
          http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1228
       Demonstrating the need for the timeout argument to be signed rather than unsigned:
          http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1229
  -->

  <dl class="domintro">

   <dt><var>handle</var> = <var>window</var> . <code subdfn data-x="dom-windowtimers-setTimeout">setTimeout</code>( <var>handler</var> [, <var>timeout</var> [, <var>arguments</var>... ] ] )</dt>

   <dd>

    <p>Schedules a timeout to run <var>handler</var> after <var>timeout</var>
    milliseconds. Any <var>arguments</var> are passed straight through to the <var>handler</var>.</p>

   </dd>

   <dt><var>handle</var> = <var>window</var> . <code data-x="dom-windowtimers-setTimeout">setTimeout</code>( <var>code</var> [, <var>timeout</var> ] )</dt>

   <dd>

    <p>Schedules a timeout to compile and run <var>code</var> after <var>timeout</var> milliseconds.</p>

   </dd>

   <dt><var>window</var> . <code subdfn data-x="dom-windowtimers-clearTimeout">clearTimeout</code>( <var>handle</var> )</dt>
   <!-- don't mention that the handle is optional, since if omitted, the method does nothing -->

   <dd>

    <p>Cancels the timeout set with <code data-x="dom-windowtimers-setTimeout">setTimeout()</code>
    or <code data-x="dom-windowtimers-setInterval">setInterval()</code> identified by
    <var>handle</var>.</p>

   </dd>

   <dt><var>handle</var> = <var>window</var> . <code subdfn data-x="dom-windowtimers-setInterval">setInterval</code>( <var>handler</var> [, <var>timeout</var> [, <var>arguments</var>... ] ] )</dt>

   <dd>

    <p>Schedules a timeout to run <var>handler</var> every <var>timeout</var>
    milliseconds. Any <var>arguments</var> are passed straight through to the <var>handler</var>.</p>

   </dd>

   <dt><var>handle</var> = <var>window</var> . <code data-x="dom-windowtimers-setInterval">setInterval</code>( <var>code</var> [, <var>timeout</var> ] )</dt>

   <dd>

    <p>Schedules a timeout to compile and run <var>code</var> every <var>timeout</var> milliseconds.</p>

   </dd>

   <dt><var>window</var> . <code subdfn data-x="dom-windowtimers-clearInterval">clearInterval</code>( <var>handle</var> )</dt>
   <!-- don't mention that the handle is optional, since if omitted, the method does nothing -->

   <dd>

    <p>Cancels the timeout set with <code data-x="dom-windowtimers-setInterval">setInterval()
    </code> or <code data-x="dom-windowtimers-setTimeout">setTimeout()</code> identified by <var>
    handle</var>.</p>

   </dd>

  </dl>

  <p class="note">Timers can be nested; after five such nested timers, however, the interval is
  forced to be at least four milliseconds.</p>

  <p class="note">This API does not guarantee that timers will run exactly on schedule. Delays due
  to CPU load, other tasks, etc, are to be expected.</p>

  <div class="impl">

  <p>Each object that implements the <code>WindowTimers</code> interface has a <dfn>list of active
  timers</dfn>. Each entry in this lists is identified by a number, which must be unique within the
  list for the lifetime of the object that implements the <code>WindowTimers</code> interface.</p>

  <hr>

  <p>The <dfn><code data-x="dom-windowtimers-setTimeout">setTimeout()</code></dfn> method must return
  the value returned by the <span>timer initialisation steps</span>, passing them the method's
  arguments, the object on which the method for which the algorithm is running is implemented (a
  <code>Window</code> or <code>WorkerGlobalScope</code> object) as the <var>method
  context</var>, and the <var>repeat</var> flag set to false.</p>

  <p>The <dfn><code data-x="dom-windowtimers-setInterval">setInterval()</code></dfn> method must
  return the value returned by the <span>timer initialisation steps</span>, passing them the
  method's arguments, the object on which the method for which the algorithm is running is
  implemented (a <code>Window</code> or <code>WorkerGlobalScope</code> object) as the <var>method context</var>, and the <var>repeat</var> flag set to true.</p>

  <p>The <dfn><code data-x="dom-windowtimers-clearTimeout">clearTimeout()</code></dfn> and <dfn><code data-x="dom-windowtimers-clearInterval">clearInterval()</code></dfn> methods must clear the
  entry identified as <var>handle</var> from the <span>list of active timers</span> of the
  <code>WindowTimers</code> object on which the method was invoked, if any, where <var>handle</var> is the argument passed to the method. (If <var>handle</var> does
  not identify an entry in the <span>list of active timers</span> of the <code>WindowTimers</code>
  object on which the method was invoked, the method does nothing.)</p>

  <p class="note">Because <code data-x="dom-windowtimers-clearTimeout">clearTimeout()</code> and
  <code data-x="dom-windowtimers-clearInterval">clearInterval()</code> clear entries from the same
  list, either method can be used to clear timers created by
  <code data-x="dom-windowtimers-setTimeout">setTimeout()</code> or
  <code data-x="dom-windowtimers-setInterval">setInterval()</code>.</p>

  <hr>

  <p>The <dfn>timer initialisation steps</dfn>, which are invoked with some method arguments, a <var>method context</var>, a <var>repeat</var> flag which can be true or false, and
  optionally (and only if the <var>repeat</var> flag is true) a <var>previous
  handle</var>, are as follows:</p>

  <ol>

   <li><p>Let <var>method context proxy</var> be <var>method context</var> if that
   is a <code>WorkerGlobalScope</code> object, or else the <code>WindowProxy</code> that corresponds
   to <var>method context</var>.</p></li>

   <li><p>If <var>previous handle</var> was provided, let <var>handle</var> be
   <var>previous handle</var>; otherwise, let <var>handle</var> be a
   user-agent-defined integer that is greater than zero that will identify the timeout to be set by
   this call in the <span>list of active timers</span>.</p></li>

   <li><p>If <var>previous handle</var> was not provided, add an entry to the <span>list of
   active timers</span> for <var>handle</var>.</p></li>

   <li>

    <p>Let <var>task</var> be a <span data-x="concept-task">task</span> that runs the
    following substeps:</p>

    <ol>

     <li><p>If the entry for <var>handle</var> in the <span>list of active timers</span>
     has been cleared, then abort this <span data-x="concept-task">task</span>'s substeps.</p></li>

     <li>

      <p>Run the appropriate set of steps from the following list:</p>

      <dl class="switch">

       <dt>If the first method argument is a <code data-x="idl-Function">Function</code></dt>

       <dd>

        <p><span data-x="es-invoking-callback-functions">Invoke</span> the <code data-x="idl-Function">Function</code>. Use the third and subsequent method
        arguments (if any) as the arguments for invoking the <code
        data-x="idl-Function">Function</code>. Use <var>method context proxy</var> as the
        <var>thisArg</var> for invoking the <code data-x="idl-Function">Function</code>. <a
        href="#refsECMA262">\[ECMA262]</a></p>

       </dd>

       <dt>Otherwise</dt>

       <dd>

        <ol>

         <li><p>Let <var>script source</var> be the first method argument.</p></li>

         <li><p>Let <var>script language</var> be JavaScript.</p></li>

         <li><p>Let <var>settings object</var> be <var>method context</var>'s <span>environment settings
         object</span>.</p></li>

         <li><p><span>Create a script</span> using <var>script source</var> as the script source,
         the <span>URL</span> where <var>script source</var> can be found, <var>scripting
         language</var> as the scripting language, and <var>settings object</var> as the
         <span>environment settings object</span>.</p></li>

        </ol>

       </dd>

      </dl>

     </li>

     <li><p>If the <var>repeat</var> flag is true, then call <span>timer initialisation
     steps</span> again, passing them the same method arguments, the same <var>method
     context</var>, with the <var>repeat</var> flag still set to true, and with the <var>previous handle</var> set to <var>handler</var>.</p></li>

    </ol>

   </li>

   <li><p>Let <var>timeout</var> be the second method argument.</p></li>

   <li><p>If the currently running <span data-x="concept-task">task</span> is a task that was created
   by this algorithm, then let <var>nesting level</var> be the <span
   data-x="concept-task">task</span>'s <span>timer nesting level</span>. Otherwise, let <var>nesting level</var> be zero.</p></li>

   <li><p>If <var>nesting level</var> is greater than 5, and <var>timeout</var> is
   less than 4, then increase <var>timeout</var> to 4.</p></li>

   <li><p>Increment <var>nesting level</var> by one.</p></li>

   <li><p>Let <var>task</var>'s <dfn>timer nesting level</dfn> be <var>nesting
   level</var>.</p></li>

   <li><p>Return <var>handle</var>, and then continue running this algorithm
   <span>in parallel</span>.</p></li>

   <li>

    <p>If <var>method context</var> is a <code>Window</code> object, wait until the
    <code>Document</code> associated with <var>method context</var> has been <span>fully
    active</span> for a further <var>timeout</var> milliseconds (not necessarily
    consecutively).</p>

    <p>Otherwise, <var>method context</var> is a <code>WorkerGlobalScope</code> object;
    wait until <var>timeout</var> milliseconds have passed with the worker not suspended
    (not necessarily consecutively).</p>

   </li>

   <li>

    <p>Wait until any invocations of this algorithm that had the same <var>method
    context</var>, that started before this one, and whose <var>timeout</var> is equal to
    or less than this one's, have completed.</p>

    <p class="note">Argument conversion as defined by Web IDL (for example, invoking <code
   >toString()</code> methods on objects passed as the first argument) happens in the
    algorithms defined in Web IDL, before this algorithm is invoked.</p>

    <div class="example">

     <p>So for example, the following rather silly code will result in the log containing "<code
    >ONE&nbsp;TWO&nbsp;</code>":</p>

     <pre>var log = '';
function logger(s) { log += s + ' '; }

setTimeout({ toString: function () {
  setTimeout("logger('ONE')", 100);
  return "logger('TWO')";
} }, 100);</pre>

    </div>

   </li>

   <li>

    <p>Optionally, wait a further user-agent defined length of time.</p>

    <p class="note">This is intended to allow user agents to pad timeouts as needed to optimize the
    power usage of the device. For example, some processors have a low-power mode where the
    granularity of timers is reduced; on such platforms, user agents can slow timers down to fit
    this schedule instead of requiring the processor to use the more accurate mode with its
    associated higher power usage.</p>

   </li>

   <li>

    <p><span data-x="queue a task">Queue</span> the <span data-x="concept-task">task</span> <var>task</var>.</p>

    <p class="note">Once the task has been processed, if the <var>repeat</var> flag is
    false, it is safe to remove the entry for <var>handle</var> from the <span>list of
    active timers</span> (there is no way for the entry's existence to be detected past this point,
    so it does not technically matter one way or the other).</p>

   </li>

  </ol>

  <p>The <span>task source</span> for these <span data-x="concept-task">tasks</span> is the
  <dfn>timer task source</dfn>.</p>

  </div>

  <div class="example">

   <p>To run tasks of several milliseconds back to back without any delay, while still yielding back
   to the browser to avoid starving the user interface (and to avoid the browser killing the script
   for hogging the CPU), simply queue the next timer before performing work:</p>

   <pre>function doExpensiveWork() {
  var done = false;
  // ...
  // this part of the function takes up to five milliseconds
  // set done to true if we're done
  // ...
  return done;
}

function rescheduleWork() {
  var handle = setTimeout(rescheduleWork, 0); // preschedule next iteration
  if (doExpensiveWork())
    clearTimeout(handle); // clear the timeout if we don't need it
}

function scheduleWork() {
  setTimeout(rescheduleWork, 0);
}

scheduleWork(); // queues a task to do lots of work</pre>

  </div>


  <h3 id="user-prompts">User prompts</h3>

  <!--
   v2 ideas:
    * in-window modal dialogs
       - escape/enter handling
       - dragging the window out of the tab
    * in-window non-modal palettes
       - with a solution for the mobile space
  -->

  <h4 id="simple-dialogs">Simple dialogs</h4>

  <dl class="domintro">

   <dt><var>window</var> . <code subdfn data-x="dom-alert">alert</code>(<var>message</var>)</dt>
   <dd>

    <p>Displays a modal alert with the given message, and waits for the user to dismiss it.</p>

    <p>A call to the <code
    data-x="dom-navigator-yieldForStorageUpdates">navigator.yieldForStorageUpdates()</code> method is
    implied when this method is invoked.</p>

   </dd>

   <dt><var>result</var> = <var>window</var> . <code subdfn data-x="dom-confirm">confirm</code>(<var>message</var>)</dt>
   <dd>

    <p>Displays a modal OK/Cancel prompt with the given message, waits for the user to dismiss it,
    and returns true if the user clicks OK and false if the user clicks Cancel.</p>

    <p>A call to the <code
    data-x="dom-navigator-yieldForStorageUpdates">navigator.yieldForStorageUpdates()</code> method is
    implied when this method is invoked.</p>

   </dd>

   <dt><var>result</var> = <var>window</var> . <code subdfn data-x="dom-prompt">prompt</code>(<var>message</var> [, <var>default</var>] )</dt>
   <dd>

    <p>Displays a modal text field prompt with the given message, waits for the user to dismiss it,
    and returns the value that the user entered. If the user cancels the prompt, then returns null
    instead. If the second argument is present, then the given value is used as a default.</p>

    <p>A call to the <code
    data-x="dom-navigator-yieldForStorageUpdates">navigator.yieldForStorageUpdates()</code> method is
    implied when this method is invoked.</p>

   </dd>

  </dl>

  <p class="note">Logic that depends on <span data-x="concept-task">tasks</span> or <span
  data-x="microtask">microtasks</span>, such as <span data-x="media element">media elements</span>
  loading their <span>media data</span>, are stalled when these methods are invoked.</p>

  <div class="impl">

  <p>The <dfn><code data-x="dom-alert">alert(<var>message</var>)</code></dfn> method, when
  invoked, must run the following steps:</p>

  <ol>

   <li><p>If the <span>event loop</span>'s <span>termination nesting level</span> is non-zero,
   optionally abort these steps.</p></li>

   <li><p>Release the <span>storage mutex</span>.</p></li>

   <li><p>If the <span>active sandboxing flag set</span> of the <span>active document</span> of
   the <span>responsible browsing context</span> specified by the <span>incumbent settings
   object</span> has the <span>sandboxed modals flag</span> set, then abort these
   steps.</p></li>

   <li><p>Optionally, abort these steps. (For example, the user agent might give the user the option
   to ignore all alerts, and would thus abort at this step whenever the method was
   invoked.)</p></li>

   <li><p>If the method was invoked with no arguments, then let <var>message</var> be the
   empty string; otherwise, let <var>message</var> be the method's first
   argument.</p></li>

   <li><p>Show the given <var>message</var> to the user.</p></li>

   <li><p>Optionally, <span>pause</span> while waiting for the user to acknowledge the
   message.</p></li>

  </ol>

  <p>The <dfn><code data-x="dom-confirm">confirm(<var>message</var>)</code></dfn> method,
  when invoked, must run the following steps:</p>

  <ol>

   <li><p>If the <span>event loop</span>'s <span>termination nesting level</span> is non-zero,
   optionally abort these steps, returning false.</p></li>

   <li><p>Release the <span>storage mutex</span>.</p></li>

   <li><p>If the <span>active sandboxing flag set</span> of the <span>active document</span> of
   the <span>responsible browsing context</span> specified by the <span>incumbent settings
   object</span> has the <span>sandboxed modals flag</span> set, then return false and abort these
   steps.</p></li>

   <li><p>Optionally, return false and abort these steps. (For example, the user agent might give
   the user the option to ignore all prompts, and would thus abort at this step whenever the method
   was invoked.)</p></li>

   <li><p>Show the given <var>message</var> to the user, and ask the user to respond with a
   positive or negative response.</p></li>

   <li><p><span>Pause</span> until the user responds either positively or negatively.</p></li>

   <li><p>If the user responded positively, return true; otherwise, the user responded negatively:
   return false.</p></li>

  </ol>

  <p>The <dfn><code data-x="dom-prompt">prompt(<var>message</var>, <var>default</var>)</code></dfn> method, when invoked, must run the following steps:</p>

  <ol>

   <li><p>If the <span>event loop</span>'s <span>termination nesting level</span> is non-zero,
   optionally abort these steps, returning null.</p></li>

   <li><p>Release the <span>storage mutex</span>.</p></li>

   <li><p>If the <span>active sandboxing flag set</span> of the <span>active document</span> of
   the <span>responsible browsing context</span> specified by the <span>incumbent settings
   object</span> has the <span>sandboxed modals flag</span> set, then return null and abort these
   steps.</p></li>

   <li><p>Optionally, return null and abort these steps. (For example, the user agent might give the
   user the option to ignore all prompts, and would thus abort at this step whenever the method was
   invoked.)</p></li>

   <li><p>Show the given <var>message</var> to the user, and ask the user to either respond
   with a string value or abort. The response must be defaulted to the value given by
   <var>default</var>.</p></li>

   <li><p><span>Pause</span> while waiting for the user's response.</p></li>

   <li><p>If the user aborts, then return null; otherwise, return the string that the user responded
   with.</p></li>

  </ol>

  </div>


  <h4 id="printing">Printing</h4>

  <dl class="domintro">

   <dt><var>window</var> . <code subdfn data-x="dom-print">print</code>()</dt>

   <dd>

    <p>Prompts the user to print the page.</p>

    <p>A call to the <code
    data-x="dom-navigator-yieldForStorageUpdates">navigator.yieldForStorageUpdates()</code> method is
    implied when this method is invoked.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>When the <dfn><code data-x="dom-print">print()</code></dfn> method is invoked, if the
  <code>Document</code> is <span>ready for post-load tasks</span>, then the user agent must
  run the <span>printing steps</span> <span>in parallel</span>. Otherwise, the user agent must only set the
  <dfn>print when loaded</dfn> flag on the <code>Document</code>.</p>

<!--TOPIC:HTML-->

  <p>User agents should also run the <span>printing steps</span> whenever the user asks for the
  opportunity to <span>obtain a physical form</span> (e.g. printed copy), or the representation of a
  physical form (e.g. PDF copy), of a document.</p>

  <p>The <dfn>printing steps</dfn> are as follows:</p>

  <ol>

   <li>

    <p>The user agent may display a message to the user or abort these steps (or both).</p>

    <p class="example">For instance, a kiosk browser could silently ignore any invocations of the
    <code data-x="dom-print">print()</code> method.</p>

    <p class="example">For instance, a browser on a mobile device could detect that there are no
    printers in the vicinity and display a message saying so before continuing to offer a "save to
    PDF" option.</p>

   </li>

   <li>

     <p>If the <span>active sandboxing flag set</span> of the <span>active document</span> of
     the <span>responsible browsing context</span> specified by the <span>incumbent settings
     object</span> has the <span>sandboxed modals flag</span> set, then abort these
     steps.</p>

     <p class="note">If the printing dialog is blocked by a <code>Document</code>'s sandbox,
     then neither the <code data-x="event-beforeprint">beforeprint</code> nor <code
     data-x="event-afterprint">afterprint</code> events will be fired.</p>

   </li>

   <li>

    <p>The user agent must <span>fire a simple event</span> named <code
    data-x="event-beforeprint">beforeprint</code> at the <code>Window</code> object of the
    <code>Document</code> that is being printed, as well as any <span data-x="nested browsing
    context">nested browsing contexts</span> in it.</p>

    <p class="example">The <code data-x="event-beforeprint">beforeprint</code> event can be used to
    annotate the printed copy, for instance adding the time at which the document was printed.</p>

   </li>

   <li>

    <p>The user agent must release the <span>storage mutex</span>.</p>

   </li>

   <li>

    <p>The user agent should offer the user the opportunity to <span>obtain a physical form</span>
    (or the representation of a physical form) of the document. The user agent may wait for the user
    to either accept or decline before returning; if so, the user agent must <span>pause</span>
    while the method is waiting. Even if the user agent doesn't wait at this point, the user agent
    must use the state of the relevant documents as they are at this point in the algorithm if and
    when it eventually creates the alternate form.</p>

   </li>

   <li>

    <p>The user agent must <span>fire a simple event</span> named <code
    data-x="event-afterprint">afterprint</code> at the <code>Window</code> object of the
    <code>Document</code> that is being printed, as well as any <span data-x="nested browsing
    context">nested browsing contexts</span> in it.</p>

    <p class="example">The <code data-x="event-afterprint">afterprint</code> event can be used to
    revert annotations added in the earlier event, as well as showing post-printing UI. For
    instance, if a page is walking the user through the steps of applying for a home loan, the
    script could automatically advance to the next step after having printed a form or other.</p>

   </li>

  </ol>

  </div>


<!--TOPIC:DOM APIs-->
  <h4 id="dialogs-implemented-using-separate-documents">Dialogs implemented using separate documents with <code data-x="dom-showModalDialog">showModalDialog()</code></h4>

  <p class="critical">This feature is in the process of being removed from the Web platform. (This
  is a long process that takes many years.) Using the <code
  data-x="dom-showModalDialog">showModalDialog()</code> API at this time is highly discouraged.</p>

<!--
  <dl class="domintro">

   <dt><var>result</var> = <var>window</var> . <code subdfn data-x="dom-showModalDialog">showModalDialog</code>(<var>url</var> [, <var>argument</var>] )</dt>

   <dd>

    <p>Prompts the user with the given page, waits for that page to close, and returns the return
    value.</p>

    <p>A call to the <code
    data-x="dom-navigator-yieldForStorageUpdates">navigator.yieldForStorageUpdates()</code> method
    is implied when this method is invoked.</p>

   </dd>

  </dl>
-->

  <div class="impl">

  <p>The <dfn><code data-x="dom-showModalDialog">showModalDialog(<var>url</var>, <var>argument</var><!--, <var>features</var>-->)</code></dfn> method, when invoked,
  must cause the user agent to run the following steps:</p>

  <ol>

   <li>

    <p><span data-x="resolve a url">Resolve</span> <var>url</var> relative to the
    <span>API base URL</span> specified by the <span>entry settings object</span>.</p>

    <p>If this fails, then throw a <code>SyntaxError</code> exception and abort these steps.</p>

   </li>

   <li><p>If the <span>event loop</span>'s <span>termination nesting level</span> is non-zero,
   optionally abort these steps, returning the empty string.</p></li>

   <li>

    <p>Release the <span>storage mutex</span>.</p>

   </li>

   <li>

    <p>If the user agent is configured such that this invocation of <code
    data-x="dom-showModalDialog">showModalDialog()</code> is somehow disabled, then return the empty
    string and abort these steps.</p>

    <p class="note">User agents are expected to disable this method in certain cases to avoid user
    annoyance (e.g. as part of their popup blocker feature). For instance, a user agent could
    require that a site be safelisted before enabling this method, or the user agent could be
    configured to only allow one modal dialog at a time.</p>

   </li>

   <li>

    <p>If the <span>active sandboxing flag set</span> of the <span>active document</span> of the
    <span>responsible browsing context</span> specified by the <span>incumbent settings
    object</span> has either the <span>sandboxed auxiliary navigation browsing context flag</span>
    or <span>sandboxed modals flag</span> set, then return the empty string and abort these
    steps.</p>

   </li>

   <li>

    <p>Let <var>incumbent origin</var> be the <span>effective script origin</span>
    specified by the <span>incumbent settings object</span> at the time the <code
    data-x="dom-showModalDialog">showModalDialog()</code> method was called.</p>

   </li>

   <li>

    <p>Let <var>the list of background browsing contexts</var> be a list of all the
    browsing contexts that:</p>

    <ul>

     <li>are part of the same <span>unit of related browsing contexts</span> as the browsing context
     of the <code>Window</code> object on which the <code
     data-x="dom-showModalDialog">showModalDialog()</code> method was called, and that</li>

     <li>have an <span>active document</span> whose <span>origin</span> is the <span data-x="same
     origin">same</span> as <var>incumbent origin</var>,</li> <!-- Note that changing
     document.domain to talk to another domain doesn't make you able to block that domain -->

    </ul>

    <p>...as well as any browsing contexts that are nested inside any of the browsing contexts
    matching those conditions.</p>

   </li>

   <li>

    <p>Disable the user interface for all the browsing contexts in <var>the list of
    background browsing contexts</var>. This should prevent the user from navigating those browsing
    contexts, causing events to be sent to those browsing context, or editing any content in those
    browsing contexts. However, it does not prevent those browsing contexts from receiving events
    from sources other than the user, from running scripts, from running animations, and so
    forth.</p>

   </li>

   <li>

    <p><span data-x="creating a new browsing context">Create</span> a new <span>auxiliary browsing context</span>, with the <span>opener browsing
    context</span> being the browsing context of the <code>Window</code> object on which the <code
    data-x="dom-showModalDialog">showModalDialog()</code> method was called. The new auxiliary
    browsing context has no name.</p>

    <p class="note">This <span>browsing context</span>'s <code>Document</code>s' <code>Window</code>
    objects all implement the <code>WindowModal</code> interface.</p>

   </li>

   <li>

    <p>Set all the flags in the new browsing context's <span>popup sandboxing flag set</span> that
    are set in the <span>active sandboxing flag set</span> of the <span>active document</span> of
    the <span>responsible browsing context</span> specified by the <span>incumbent settings
    object</span>. The <span>responsible browsing context</span> specified by the <span>incumbent
    settings object</span> must be set as the new browsing context's <span>one permitted sandboxed
    navigator</span>.</p>

   </li>

   <li>

    <p>Let the <span>dialog arguments</span> of the new browsing context be set to the value of <var>argument</var>, or the <i>undefined</i> value if the argument was omitted.</p>

   </li>

   <li>

    <p>Let the <span>dialog arguments' origin</span> be <var>incumbent origin</var>.</p>

   </li>

   <li>

    <p>Let the <span>return value</span> of the new browsing context be the <i>undefined</i> value.</p>

   </li>

   <li>

    <p>Let the <span>return value origin</span> be <var>incumbent origin</var>.</p>

   </li>

   <li>

    <p><span>Navigate</span><!--DONAV showModalDialog--> the new <span>browsing context</span> to
    the <span>absolute URL</span> that resulted from <span data-x="resolve a url">resolving</span>
    <var>url</var> earlier, with <span>replacement enabled</span>, and with the
    <span>responsible browsing context</span> specified by the <span>incumbent settings
    object</span> as the <span>source browsing context</span>.</p>

    <!-- we don't call this with <span>exceptions enabled</span>, since that would risk leaving the
    browser in an unusuable state (or would require that we catch and rethrow the exception, and
    this API is deprecated so we're not worried about keeping it sane) -->

   </li>

   <li>

    <p><span>Spin the event loop</span> until the new <span>browsing context</span> is <span
    data-x="close a browsing context">closed</span>. The user agent must allow the user to indicate
    that the <span>browsing context</span> is to be closed.</p>

   </li>

   <li>

    <p>Reenable the user interface for all the browsing contexts in <var>the list of
    background browsing contexts</var>.</p>

   </li>

   <li>

    <p>If the <span>auxiliary browsing context</span>'s <span>return value origin</span> at the time
    the browsing context was <span data-x="close a browsing context">closed</span> was the <span
    data-x="same origin">same</span> as <var>incumbent origin</var>, then let <var>return value</var> be the <span>auxiliary browsing context</span>'s <span>return
    value</span> as it stood when the browsing context was <span data-x="close a browsing
    context">closed</span>.</p>

    <p>Otherwise, let <var>return value</var> be undefined.</p>

   </li>

   <li>

    <p>Return <var>return value</var>.</p>

   </li>

  </ol>

  <p>The <code>Window</code> objects of <code>Document</code>s hosted by <span data-x="browsing
  context">browsing contexts</span> created by the above algorithm must also implement the
  <code>WindowModal</code> interface.</p>

  <p class="note">When this happens, the members of the <code>WindowModal</code> interface, in
  JavaScript environments, appear to actually be part of the <code>Window</code> interface (e.g.
  they are on the same prototype chain as the <code data-x="dom-alert">window.alert()</code>
  method).</p>

  </div>

  <pre class="idl">[NoInterfaceObject]
interface <dfn>WindowModal</dfn> {
  readonly attribute any <span data-x="dom-WindowModal-dialogArguments">dialogArguments</span>;
  attribute any <span data-x="dom-WindowModal-returnValue">returnValue</span>;
};</pre>

  <dl class="domintro">

   <dt><var>window</var> . <code subdfn data-x="dom-WindowModal-dialogArguments">dialogArguments</code></dt>

   <dd>

    <p>Returns the <var>argument</var> argument that was passed to the <code
    data-x="dom-showModalDialog">showModalDialog()</code> method.</p>

   </dd>

   <dt><var>window</var> . <code subdfn data-x="dom-WindowModal-returnValue">returnValue</code> [ = <var>value</var> ]</dt>

   <dd>

    <p>Returns the current return value for the window.</p>

    <p>Can be set, to change the value that will be returned by the <code
    data-x="dom-showModalDialog">showModalDialog()</code> method.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>Such browsing contexts have associated <dfn>dialog arguments</dfn>, which are stored along with
  the <dfn>dialog arguments' origin</dfn>. These values are set by the <code
  data-x="dom-showModalDialog">showModalDialog()</code> method in the algorithm above, when the
  browsing context is created, based on the arguments provided to the method.</p>

  <p>The <dfn><code data-x="dom-WindowModal-dialogArguments">dialogArguments</code></dfn> IDL
  attribute, on getting, must check whether its browsing context's <span>active document</span>'s
  <span>effective script origin</span> is the <span data-x="same origin">same</span> as the <span>dialog arguments'
  origin</span>. If it is, then the browsing context's <span>dialog arguments</span> must be
  returned unchanged. Otherwise, the IDL attribute must return <i>undefined</i>.</p>

  <p>These browsing contexts also have an associated <dfn>return value</dfn> and <dfn>return value
  origin</dfn>. As with the previous two values, these values are set by the <code
  data-x="dom-showModalDialog">showModalDialog()</code> method in the algorithm above, when the
  browsing context is created.</p>

  <p>The <dfn><code data-x="dom-WindowModal-returnValue">returnValue</code></dfn> IDL attribute, on
  getting, must check whether its browsing context's <span>active document</span>'s <span>effective
  script origin</span> is the <span data-x="same origin">same</span> as the current <span>return
  value origin</span>. If it is, then the browsing context's <span>return value</span> must be
  returned unchanged. Otherwise, the IDL attribute must return <i>undefined</i>. On setting, the
  attribute must set the <span>return value</span> to the given new value, and the <span>return
  value origin</span> to the browsing context's <span>active document</span>'s <span>effective
  script origin</span>.</p>

  </div>

  <p class="note">The <code data-x="dom-window-close">window.close()</code> method can be used to
  close the browsing context.</p>


  <h3 id="system-state-and-capabilities">System state and capabilities</h3>

  <h4>The <code>Navigator</code> object</h4>

  <div class="impl">

  <p>The <dfn><code data-x="dom-navigator">navigator</code></dfn> attribute of the
  <code>Window</code> interface must return an instance of the <code>Navigator</code> interface,
  which represents the identity and state of the user agent (the client), and allows Web pages to
  register themselves as potential protocol and content handlers:</p>

  </div>

  <pre class="idl">interface <dfn>Navigator</dfn> {
  // objects implementing this interface also implement the interfaces given below
};
<span>Navigator</span> implements <span>NavigatorID</span>;
<span>Navigator</span> implements <span>NavigatorLanguage</span>;
<span>Navigator</span> implements <span>NavigatorOnLine</span>;
<span>Navigator</span> implements <span>NavigatorContentUtils</span>;
<span>Navigator</span> implements <span>NavigatorStorageUtils</span>;
<span>Navigator</span> implements <span>NavigatorPlugins</span>;</pre>

<!-- v2:
  geolocator mozIsLocallyAvailable preference
-->

  <div class="impl">

  <p>These interfaces are defined separately so that other specifications can re-use parts of the
  <code>Navigator</code> interface.</p>

  </div>


  <h5 id="client-identification">Client identification</h5>

  <pre class="idl">[NoInterfaceObject, Exposed=(Window, Worker)]
interface <dfn>NavigatorID</dfn> {
  [Exposed=Window] readonly attribute DOMString <span data-x="dom-navigator-appCodeName">appCodeName</span>; // constant "Mozilla"
  readonly attribute DOMString <span data-x="dom-navigator-appName">appName</span>; // constant "Netscape"
  readonly attribute DOMString <span data-x="dom-navigator-appVersion">appVersion</span>;
  readonly attribute DOMString <span data-x="dom-navigator-platform">platform</span>;
  [Exposed=Window]readonly attribute DOMString <span data-x="dom-navigator-product">product</span>; // constant "Gecko"
  readonly attribute DOMString <span data-x="dom-navigator-userAgent">userAgent</span>;
};</pre>

  <p>In certain cases, despite the best efforts of the entire industry, Web browsers have bugs and
  limitations that Web authors are forced to work around.</p>

  <p>This section defines a collection of attributes that can be used to determine, from script, the
  kind of user agent in use, in order to work around these issues.</p>

  <p>Client detection should always be limited to detecting known current versions; future versions
  and unknown versions should always be assumed to be fully compliant.</p>

  <dl class="domintro">

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-appCodeName">appCodeName</code></dt>
   <dd>
    <p>Returns the string "<code>Mozilla</code>".</p>
   </dd>

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-appName">appName</code></dt>
   <dd>
    <p>Returns the string "<code>Netscape</code>".</p>
   </dd>

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-appVersion">appVersion</code></dt>
   <dd>
    <p>Returns the version of the browser.</p>
   </dd>

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-platform">platform</code></dt>
   <dd>
    <p>Returns the name of the platform.</p>
   </dd>

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-product">product</code></dt>
   <dd>
    <p>Returns the string "<code>Gecko</code>".</p>
   </dd>

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code data-x="dom-navigator-taintEnabled">taintEnabled</code>()</dt>
   <dd>
    <p>Returns either the string "<code>20030107</code>", or the string "<code>20100101</code>".</p>
   </dd>

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-userAgent">userAgent</code></dt>
   <dd>
    <p>Returns the complete User-Agent header.</p>
   </dd>

  </dl>

  <div class="impl">

  <dl>

   <dt><dfn><code data-x="dom-navigator-appCodeName">appCodeName</code></dfn></dt>
   <dd><p>Must return the string "<code>Mozilla</code>".</p></dd>

   <!-- appMinorVersion: IE only. In IE8b1, returns " Beta" (with the space) -->

   <dt><dfn><code data-x="dom-navigator-appName">appName</code></dfn></dt>
   <dd><p>Must return the string "<code>Netscape</code>".</p></dd>

   <dt><dfn><code data-x="dom-navigator-appVersion">appVersion</code></dfn></dt>
   <dd><p>Must return either the string "<code>4.0</code>" or a string representing the
   version of the browser in detail, e.g. "<code>1.0 (VMS; en-US)
   Mellblomenator/9000</code>".</p></dd>

   <!-- buildID: Mozilla only -->

   <!-- oscpu: Mozilla only -->

   <dt><dfn><code data-x="dom-navigator-platform">platform</code></dfn></dt>
   <dd><p>Must return either the empty string or a string representing the platform on which the
   browser is executing, e.g. "<code>MacIntel</code>", "<code>Win32</code>",
   "<code>FreeBSD i386</code>", "<code>WebTV OS</code>".</p></dd>

   <dt><dfn><code data-x="dom-navigator-product">product</code></dfn></dt>
   <dd><p>Must return the string "<code>Gecko</code>".</p></dd>

   <!-- productSub: Mozilla and Safari only; returns same as buildID in Mozilla, and returns the fixed string "20030107" in Safari -->

   <!-- securityPolicy: Mozilla only; always returns "" -->

   <dt><dfn data-x="dom-navigator-taintEnabled"><code>taintEnabled()</code></dfn></dt>
   <dd><p>Must return false.</p></dd>

   <dt><dfn data-x="dom-navigator-userAgent"><code>userAgent</code></dfn></dt>
   <dd><p>Must return the string used for the value of the "<code>User-Agent</code>" header
   in HTTP requests, or the empty string if no such header is ever sent.</p></dd>

   <!-- vendor: Mozilla and Safari only; always returns "" in Mozilla, and returns the fixed string "Apple Computer, Inc." in Safari -->

   <!-- vendorSub: Mozilla and Safari only; always returns "" -->

    </dl>

  <!-- similar paragraph in next section -->
  <p class="warning">Any information in this API that varies from user to user can be used to
  profile the user. In fact, if enough such information is available, a user can actually be
  uniquely identified. For this reason, user agent implementors are strongly urged to include as
  little information in this API as possible.
  <!--INSERT FINGERPRINT-->
  </p>

  </div>

  <!-- next section refers to previous section as "previous section" -->

  <h5 id="language-preferences">Language preferences</h5>

  <pre class="idl">[NoInterfaceObject, Exposed=(Window, Worker)]
interface <dfn>NavigatorLanguage</dfn> {
  readonly attribute DOMString? <span data-x="dom-navigator-language">language</span>;
  readonly attribute DOMString[] <span data-x="dom-navigator-languages">languages</span>;
};</pre>

  <dl class="domintro">

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-language">language</code></dt>
   <dd>
    <p>Returns a language tag representing the user's preferred language.</p>
   </dd>

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-languages">languages</code></dt>
   <dd>
    <p>Returns an array of language tags representing the user's preferred languages, with the most preferred language first.</p>
    <p>The most preferred language is the one returned by <code data-x="dom-navigator-language">navigator.language</code>.</p>
   </dd>

  </dl>

  <p class="note">A <code data-x="event-languagechange">languagechange</code> event is fired at the
  <code>Window</code> or <code>WorkerGlobalScope</code> object when the user agent's understanding
  of what the user's preferred languages are changes.</p>

  <div class="impl">

  <dl>

   <!--
   <dt><dfn><code data-x="dom-navigator-browserLanguage">browserLanguage</code></dfn></dt> <!- - Opera and IE only - ->
   <dd><p>Must return a language tag representing either <span>a plausible language</span> or the
   language the browser uses in its interface.</p></dd>


   <dt><dfn><code data-x="dom-navigator-userLanguage">userLanguage</code></dfn></dt> <!- - Opera and IE only - ->
   -->
   <!-- at time of testing, this was supported by Opera, Safari, and Mozilla only -->
   <dt><dfn><code data-x="dom-navigator-language">language</code></dfn></dt>
   <dd><p>Must return a valid BCP 47 language tag representing either <span>a plausible
   language</span> or the user's most preferred language. <a href="#refsBCP47">\[BCP47]</a></p></dd>

   <dt><dfn><code data-x="dom-navigator-languages">languages</code></dfn></dt>
   <dd>

    <p>Must return a <span data-x="dfn-read-only-array">read only</span> array of valid BCP 47
    language tags representing either one or more <span data-x="a plausible language">plausible
    languages</span>, or the user's preferred languages, ordered by preference with the most
    preferred language first. The same object must be returned until the user agent needs to return
    different values, or values in a different order. <a href="#refsBCP47">\[BCP47]</a></p>

    <p>Whenever the user agent needs to make the <code
    data-x="dom-navigator-languages">navigator.languages</code> attribute of a <code>Window</code>
    or <code>WorkerGlobalScope</code> object return a new set of language tags, the user agent must
    <span>queue a task</span> to <span>fire a simple event</span> named <code
    data-x="event-languagechange">languagechange</code> at the <code>Window</code> or
    <code>WorkerGlobalScope</code> object and wait until that task begins to be executed before
    actually returning a new value.</p>

    <p>The <span>task source</span> for this <span data-x="concept-task">task</span> is the
    <span>DOM manipulation task source</span>.</p>

   </dd>

  </dl>

  <p>To determine <dfn>a plausible language</dfn>, the user agent should bear in mind the following:</p>

  <ul>

   <li>Any information in this API that varies from user to user can be used to profile or identify
   the user.
   <!--INSERT FINGERPRINT-->
   </li>

   <li>If the user is not using a service that obfuscates the user's point of origin (e.g. the Tor
   anonymity network), then the value that is least likely to distinguish the user from other users
   with similar origins (e.g. from the same IP address block) is the language used by the majority
   of such users. <a href="#refsTOR">\[TOR]</a></li>

   <li>If the user is using an anonymizing service, then the value "<code>en-US</code>" is
   suggested; if all users of the service use that same value, that reduces the possibility of
   distinguishing the users from each other.</li>

  </ul>

  <p>To avoid introducing any more fingerprinting vectors, user agents should use the same list for
  the APIs defined in this function as for the HTTP <code
  data-x="http-accept-language">Accept-Language</code> header.
  <!--INSERT FINGERPRINT-->
  </p>

  </div>



  <h5 id="custom-handlers">Custom scheme and content handlers: the <code data-x="dom-navigator-registerProtocolHandler">registerProtocolHandler()</code> and <code data-x="dom-navigator-registerContentHandler">registerContentHandler()</code> methods</h5>

  <pre class="idl">[NoInterfaceObject]
interface <dfn>NavigatorContentUtils</dfn> {
  // content handler registration
  void <span data-x="dom-navigator-registerProtocolHandler">registerProtocolHandler</span>(DOMString scheme, DOMString url, DOMString title);
  void <span data-x="dom-navigator-registerContentHandler">registerContentHandler</span>(DOMString mimeType, DOMString url, DOMString title);
  DOMString <span data-x="dom-navigator-isProtocolHandlerRegistered">isProtocolHandlerRegistered</span>(DOMString scheme, DOMString url);
  DOMString <span data-x="dom-navigator-isContentHandlerRegistered">isContentHandlerRegistered</span>(DOMString mimeType, DOMString url);
  void <span data-x="dom-navigator-unregisterProtocolHandler">unregisterProtocolHandler</span>(DOMString scheme, DOMString url);
  void <span data-x="dom-navigator-unregisterContentHandler">unregisterContentHandler</span>(DOMString mimeType, DOMString url);
};</pre>

  <p>The <dfn><code
  data-x="dom-navigator-registerProtocolHandler">registerProtocolHandler()</code></dfn> method
  allows Web sites to register themselves as possible handlers for particular schemes. For example,
  an online telephone messaging service could register itself as a handler of the <code data-x="sms
  protocol">sms:</code> scheme, so that if the user clicks on such a link, he is given the
  opportunity to use that Web site. Analogously, the <dfn><code
  data-x="dom-navigator-registerContentHandler">registerContentHandler()</code></dfn> method allows
  Web sites to register themselves as possible handlers for content in a particular <span>MIME
  type</span>. For example, the same online telephone messaging service could register itself as a
  handler for <code>text/vcard</code> files, so that if the user has no native application capable
  of handling vCards, his Web browser can instead suggest he use that site to view contact
  information stored on vCards that he opens. <a href="#refsSMS">\[SMS]</a> <a href="#refsRFC6350">\[RFC6350]</a></p>

  <dl class="domintro">

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-registerProtocolHandler">registerProtocolHandler</code>(<var>scheme</var>, <var>url</var>, <var>title</var>)</dt>
   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-registerContentHandler">registerContentHandler</code>(<var>mimeType</var>, <var>url</var>, <var>title</var>)</dt>

   <dd>

    <p>Registers a handler for the given scheme or content type, at the given URL, with the given
    title.</p>

    <p>The string "<code>%s</code>" in the URL is used as a placeholder for where to put
    the URL of the content to be handled.</p>

    <p>Throws a <code>SecurityError</code> exception if the user agent blocks the registration (this
    might happen if trying to register as a handler for "http", for instance).</p>

    <p>Throws a <code>SyntaxError</code> exception if the "<code>%s</code>" string is
    missing in the URL.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>User agents may, within the constraints described in this section, do whatever they like when
  the methods are called. A UA could, for instance, prompt the user and offer the user the
  opportunity to add the site to a shortlist of handlers, or make the handlers his default, or
  cancel the request. UAs could provide such a UI through modal UI or through a non-modal transient
  notification interface. UAs could also simply silently collect the information, providing it only
  when relevant to the user.</p>

  <p>User agents should keep track of which sites have registered handlers (even if the user has
  declined such registrations) so that the user is not repeatedly prompted with the same
  request.</p>

  <p>The arguments to the methods have the following meanings and corresponding implementation
  requirements. The requirements that involve throwing exceptions must be processed in the order
  given below, stopping at the first exception thrown. (So the exceptions for the first argument
  take precedence over the exceptions for the second argument.)</p>

  <dl>

   <dt><var>scheme</var> (<code data-x="dom-navigator-registerProtocolHandler">registerProtocolHandler()</code> only)</dt>

   <dd>

    <p>A scheme, such as "<code>mailto</code>" or "<code>web+auth</code>". The
    scheme must be compared in an <span>ASCII case-insensitive</span> manner by user agents for the
    purposes of comparing with the scheme part of URLs that they consider against the list of
    registered handlers.</p>

    <p>The <var>scheme</var> value, if it contains a colon (as in "<code>mailto:</code>"),
    will never match anything, since schemes don't contain colons.</p>

    <p>If the <code data-x="dom-navigator-registerProtocolHandler">registerProtocolHandler()</code>
    method is invoked with a scheme that is neither a <span>safelisted scheme</span> nor a scheme
    whose value starts with the substring "<code>web+</code>" and otherwise contains only
    <span>lowercase ASCII letters</span>, and whose length is at least five characters (including
    the "<code>web+</code>" prefix), the user agent must throw a <code>SecurityError</code>
    exception.</p>

    <p>The following schemes are the <dfn data-x="safelisted scheme">safelisted schemes</dfn>:</p>

    <ul class="brief">
     <li><code>bitcoin</code></li> <!-- https://en.bitcoin.it/wiki/BIP_0021 -->
     <li><code>geo</code></li>
     <li><code>im</code></li>
     <li><code>irc</code></li>
     <li><code>ircs</code></li>
     <li><code>magnet</code></li>
     <li><code>mailto</code></li>
     <li><code>mms</code></li>
     <li><code>news</code></li>
     <li><code>nntp</code></li>
     <li><code>openpgp4fpr</code></li>
     <li><code>sip</code></li>
     <li><code>sms</code></li>
     <li><code>smsto</code></li>
     <li><code>ssh</code></li>
     <li><code>tel</code></li>
     <li><code>urn</code></li>
     <li><code>webcal</code></li>
     <li><code>wtai</code></li>
     <li><code>xmpp</code></li>
    </ul>

    <p class="note">This list can be changed. If there are schemes that should be added, please send
    feedback.</p>

    <p class="note">This list excludes any schemes that could reasonably be expected to be supported
    inline, e.g. in an <code>iframe</code>, such as <code>http</code> or (more
    theoretically) <code>gopher</code>. If those were supported, they could potentially be
    used in man-in-the-middle attacks, by replacing pages that have frames with such content with
    content under the control of the protocol handler. If the user agent has native support for the
    schemes, this could further be used for cookie-theft attacks.</p>

   </dd>

   <dt><var>mimeType</var> (<code data-x="dom-navigator-registerContentHandler">registerContentHandler()</code> only)</dt>

   <dd>

    <p>A <span>MIME type</span>, such as <code>model/vnd.flatland.3dml</code> or <code
   >application/vnd.google-earth.kml+xml</code>. The <span>MIME type</span> must be
    compared in an <span>ASCII case-insensitive</span> manner by user agents for the purposes of
    comparing with MIME types of documents that they consider against the list of registered
    handlers.</p>

    <p>User agents must compare the given values only to the MIME type/subtype parts of content
    types, not to the complete type including parameters. Thus, if <var>mimeType</var>
    values passed to this method include characters such as commas or whitespace, or include MIME
    parameters, then the handler being registered will never be used.</p>

    <p class="note">The type is compared to the <span>MIME type</span> used by the user agent
    <em>after</em> the sniffing algorithms have been applied.</p>

    <p>If the <code data-x="dom-navigator-registerContentHandler">registerContentHandler()</code>
    method is invoked with a <span>MIME type</span> that is in the <span>type blocklist</span> or
    that the user agent has deemed a privileged type, the user agent must throw a
    <code>SecurityError</code> exception.</p>

    <p>The following <span data-x="MIME type">MIME types</span> are in the <dfn>type
    blocklist</dfn>:</p>

    <ul class="brief">

     <li><code>application/x-www-form-urlencoded</code></li>
     <li><code>application/xhtml+xml</code></li>
     <li><code>application/xml</code></li>
     <li><code>image/gif</code></li>
     <li><code>image/jpeg</code></li>
     <li><code>image/png</code></li>
     <li><code>image/svg+xml</code></li>
     <li><code>multipart/x-mixed-replace</code></li>
     <li><code>text/cache-manifest</code></li>
     <li><code>text/css</code></li>
     <li><code>text/html</code></li>
     <li><code>text/ping</code></li>
     <li><code>text/plain</code></li>
     <li><code>text/vtt</code></li>
     <li><code>text/xml</code></li>
     <li>All types that the user agent supports displaying natively in a <span>browsing context</span> during <span data-x="navigate">navigation</span>, except for <code>application/rss+xml</code> and <code>application/atom+xml</code></li>

    </ul>

    <p class="note">This list can be changed. If there are MIME types that should be added, please
    send feedback.</p>

   </dd>


   <dt><var>url</var></dt>

   <dd>

    <p>A string used to build the <span>URL</span> of the page that will handle the requests.</p>

    <p>User agents must throw a <code>SyntaxError</code> exception if the <var>url</var>
    argument passed to one of these methods does not contain the exact literal string
    "<code>%s</code>".</p>

    <p>User agents must throw a <code>SyntaxError</code> exception if <span data-x="resolve a
    url">resolving</span> the <var>url</var> argument relative to the <span>API base
    URL</span> specified by the <span>entry settings object</span> is not successful.</p>

    <p class="note">The resulting <span>absolute URL</span> would by definition not be a <span>valid
    URL</span> as it would include the string "<code>%s</code>" which is not a valid
    component in a URL.</p>

    <p>User agents must throw a <code>SecurityError</code> exception if the resulting <span>absolute
    URL</span> has an <span>origin</span> that differs from the <span>origin</span> specified by the
    <span>entry settings object</span>.</p>

    <p class="note">This is forcibly the case if the <code>%s</code> placeholder is in the
    scheme, host, or port parts of the URL.</p>

    <p>The resulting <span>absolute URL</span> is the <dfn>proto-URL</dfn>. It identifies the
    handler for the purposes of the methods described below.</p>

    <p>When the user agent uses this handler, it must replace the first occurrence of the exact
    literal string "<code>%s</code>" in the <var>url</var> argument with an
    escaped version of the <span>absolute URL</span> of the content in question (as defined below),
    then <span data-x="resolve a url">resolve</span> the resulting URL, relative to the <span>API
    base URL</span> specified by the <span>entry settings object</span> at the time the <code
    data-x="dom-navigator-registerContentHandler">registerContentHandler()</code> or <code
    data-x="dom-navigator-registerProtocolHandler">registerProtocolHandler()</code> methods were
    invoked, and then <span>navigate</span><!--DONAV user--> an appropriate <span>browsing
    context</span> to the resulting URL.</p>

    <p>To get the escaped version of the <span>absolute URL</span> of the content in question, the
    user agent must replace every character in that <span>absolute URL</span> that is not a
    character in the URL <span>default encode set</span> with the result of <span data-x="UTF-8
    percent encode">UTF-8 percent encoding</span> that character.</p>

    <div class="example">

     <p>If the user had visited a site at <code>http://example.com/</code> that made the
     following call:</p>

     <pre>navigator.registerContentHandler('application/x-soup', 'soup?url=%s', 'SoupWeb&trade;')</pre>

     <p>...and then, much later, while visiting <code>http://www.example.net/</code>,
     clicked on a link such as:</p>

     <pre>&lt;a href="chickenk&#xEF;wi.soup">Download our Chicken K&#xEF;wi soup!&lt;/a></pre>

     <p>...then, assuming this <code>chickenk&#xEF;wi.soup</code> file was served with the
     <span>MIME type</span> <code>application/x-soup</code>, the UA might navigate to the
     following URL:</p>

     <pre>http://example.com/soup?url=http://www.example.net/chickenk%C3%AFwi.soup</pre>

     <p>This site could then fetch the <code>chickenk&#xEF;wi.soup</code> file and do
     whatever it is that it does with soup (synthesize it and ship it to the user, or whatever).</p>

    </div>

   </dd>

   <dt><var>title</var></dt>

   <dd>

    <p>A descriptive title of the handler, which the UA might use to remind the user what the site
    in question is.</p>

   </dd>

  </dl>

  <p>This section does not define how the pages registered by these methods are used, beyond the
  requirements on how to process the <var>url</var> value (see above). To some extent, the
  <span data-x="navigate">processing model for navigating across documents</span> defines some cases
  where these methods are relevant, but in general UAs may use this information wherever they would
  otherwise consider handing content to native plugins or helper applications.</p>

  <p>UAs must not use registered content handlers to handle content that was returned as part of a
  non-GET transaction (or rather, as part of any non-idempotent transaction), as the remote site
  would not be able to fetch the same data.</p>

  <hr>

  </div>

  <p>In addition to the registration methods, there are also methods for determining if particular
  handlers have been registered, and for unregistering handlers.</p>

  <dl class="domintro">

   <dt><var>state</var> = <var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-isProtocolHandlerRegistered">isProtocolHandlerRegistered</code>(<var>scheme</var>, <var>url</var>)</dt>
   <dt><var>state</var> = <var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-isContentHandlerRegistered">isContentHandlerRegistered</code>(<var>mimeType</var>, <var>url</var>)</dt>

   <dd>

    <p>Returns one of the following strings describing the state of the handler given by the
    arguments:</p>

    <dl>

     <dt><code>new</code>

     <dd>Indicates that no attempt has been made to register the given handler (or that the handler
     has been unregistered). It would be appropriate to promote the availability of the handler or
     to just automatically register the handler.

     <dt><code>registered</code>

     <dd>Indicates that the given handler has been registered or that the site is blocked from
     registering the handler. Trying to register the handler again would have no effect.

     <dt><code>declined</code>

     <dd>Indicates that the given handler has been offered but was rejected. Trying to register the
     handler again may prompt the user again.

    </dl>

   </dd>

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-unregisterProtocolHandler">unregisterProtocolHandler</code>(<var>scheme</var>, <var>url</var>)</dt>
   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-unregisterContentHandler">unregisterContentHandler</code>(<var>mimeType</var>, <var>url</var>)</dt>

   <dd>

    <p>Unregisters the handler given by the arguments.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-navigator-isProtocolHandlerRegistered">isProtocolHandlerRegistered()</code></dfn>
  method must return the <span>handler state string</span> that most closely describes the current
  state of the handler described by the two arguments to the method, where the first argument gives
  the scheme and the second gives the string used to build the <span>URL</span> of the page that
  will handle the requests.
  <!--INSERT FINGERPRINT-->
  </p>

  <p>The first argument must be compared to the schemes for which custom protocol handlers are
  registered in an <span>ASCII case-insensitive</span> manner to find the relevant handlers.</p>

  <p>The second argument must be preprocessed as described below, and if that is successful, must
  then be matched against the <span data-x="proto-URL">proto-URLs</span> of the relevant handlers to
  find the described handler.</p>

  <hr>

  <p>The <dfn><code data-x="dom-navigator-isContentHandlerRegistered">isContentHandlerRegistered()</code></dfn>
  method must return the <span>handler state string</span> that most closely describes the current
  state of the handler described by the two arguments to the method, where the first argument gives
  the <span>MIME type</span> and the second gives the string used to build the <span>URL</span> of
  the page that will handle the requests.
  <!--INSERT FINGERPRINT-->
  </p>

  <p>The first argument must be compared to the <span data-x="MIME type">MIME types</span> for which
  custom content handlers are registered in an <span>ASCII case-insensitive</span> manner to find
  the relevant handlers.</p>

  <p>The second argument must be preprocessed as described below, and if that is successful, must
  then be matched against the <span data-x="proto-URL">proto-URLs</span> of the relevant handlers to
  find the described handler.</p>

  <hr>

  <p>The <dfn data-x="handler state string">handler state strings</dfn> are the following strings.
  Each string describes several situations, as given by the following list.</p>

  <dl>

   <dt><code>new</code>

   <dd>The described handler has never been registered for the given scheme or type.

   <dd>The described handler was once registered for the given scheme or type, but the site has
   since unregistered it. If the handler were to be reregistered, the user would be notified
   accordingly.

   <dd>The described handler was once registered for the given scheme or type, but the site has
   since unregistered it, but the user has indicated that the site is to be blocked from registering
   the type again, so the user agent would ignore further registration attempts.


   <dt><code>registered</code>

   <dd>An attempt was made to register the described handler for the given scheme or type, but the
   user has not yet been notified, and the user agent would ignore further registration attempts.
   (Maybe the user agent batches registration requests to display them when the user requests to be
   notified about them, and the user has not yet requested that the user agent notify it of the
   previous registration attempt.)

   <dd>The described handler is registered for the given scheme or type (maybe, or maybe not, as the
   default handler).

   <dd>The described handler is permanently blocked from being (re)registered. (Maybe the user
   marked the registration attempt as spam, or blocked the site for other reasons.)


   <dt><code>declined</code>

   <dd>An attempt was made to register the described handler for the given scheme or type, but the
   user has not yet been notified; however, the user might be notified if another registration
   attempt were to be made. (Maybe the last registration attempt was made while the page was in the
   background and the user closed the page without looking at it, and the user agent requires
   confirmation for this registration attempt.)

   <dd>An attempt was made to register the described handler for the given scheme or type, but the
   user has not yet responded.

   <dd>An attempt was made to register the described handler for the given scheme or type, but the
   user declined the offer. The user has not indicated that the handler is to be permanently
   blocked, however, so another attempt to register the described handler might result in the user
   being prompted again.

   <dd>The described handler was once registered for the given scheme or type, but the user has
   since removed it. The user has not indicated that the handler is to be permanently blocked,
   however, so another attempt to register the described handler might result in the user being
   prompted again.

  </dl>

  <hr>

  <p>The <dfn><code data-x="dom-navigator-unregisterProtocolHandler">unregisterProtocolHandler()</code></dfn>
  method must unregister the handler described by the two arguments to the method, where the first
  argument gives the scheme and the second gives the string used to build the <span>URL</span> of
  the page that will handle the requests.</p>

  <p>The first argument must be compared to the schemes for which custom protocol handlers are
  registered in an <span>ASCII case-insensitive</span> manner to find the relevant handlers.</p>

  <p>The second argument must be preprocessed as described below, and if that is successful, must
  then be matched against the <span data-x="proto-URL">proto-URLs</span> of the relevant handlers to
  find the described handler.</p>

  <hr>

  <p>The <dfn><code data-x="dom-navigator-unregisterContentHandler">unregisterContentHandler()</code></dfn>
  method must unregister the handler described by the two arguments to the method, where the first
  argument gives the <span>MIME type</span> and the second gives the string used to build the
  <span>URL</span> of the page that will handle the requests.</p>

  <p>The first argument must be compared to the <span data-x="MIME type">MIME types</span> for which
  custom content handlers are registered in an <span>ASCII case-insensitive</span> manner to find
  the relevant handlers.</p>

  <p>The second argument must be preprocessed as described below, and if that is successful, must
  then be matched against the <span data-x="proto-URL">proto-URLs</span> of the relevant handlers to
  find the described handler.</p>

  <hr>

  <p>The second argument of the four methods described above must be preprocessed as follows:</p>

  <ol>

   <li><p>If the string does not contain the substring "<code>%s</code>", abort these
   steps. There's no matching handler.</p></li>

   <li><p><span data-x="resolve a URL">Resolve</span> the string relative to the <span>API base
   URL</span> specified by the <span>entry settings object</span>.</p></li>

   <li><p>If this fails, then throw a <code>SyntaxError</code> exception, aborting the
   method.</p></li>

   <li><p>If the resulting <span>absolute URL</span>'s <span>origin</span> is not the <span>same
   origin</span> as the <span>origin</span> specified by the <span>entry settings object</span>,
   throw a <code>SecurityError</code> exception, aborting the method.</p></li>

   <li><p>Return the resulting <span>absolute URL</span> as the result of preprocessing the
   argument.</p></li>

  </ol>

  </div>



<!--ADD-TOPIC:Security-->
  <div class="impl">

  <h6 id="security-and-privacy">Security and privacy</h6>

  <p>These mechanisms can introduce a number of concerns, in particular privacy concerns.</p>

  <p><strong>Hijacking all Web usage.</strong> User agents should not allow schemes that are key to
  its normal operation, such as <code>http</code> or <code>https</code>, to be
  rerouted through third-party sites. This would allow a user's activities to be trivially tracked,
  and would allow user information, even in secure connections, to be collected.</p>

  <p><strong>Hijacking defaults.</strong> User agents are strongly urged to not automatically change
  any defaults, as this could lead the user to send data to remote hosts that the user is not
  expecting. New handlers registering themselves should never automatically cause those sites to be
  used.</p>

  <p><strong>Registration spamming.</strong> User agents should consider the possibility that a site
  will attempt to register a large number of handlers, possibly from multiple domains (e.g. by
  redirecting through a series of pages each on a different domain, and each registering a handler
  for <code>video/mpeg</code> &mdash; analogous practices abusing other Web browser features have
  been used by pornography Web sites for many years). User agents should gracefully handle such
  hostile attempts, protecting the user.</p>

  <p><strong>Misleading titles.</strong> User agents should not rely wholly on the <var>title</var>
  argument to the methods when presenting the registered handlers to the user, since sites could
  easily lie. For example, a site <code>hostile.example.net</code> could claim that it was
  registering the "Cuddly Bear Happy Content Handler". User agents should therefore use the
  handler's domain in any UI along with any title.</p>

  <p><strong>Hostile handler metadata.</strong> User agents should protect against typical attacks
  against strings embedded in their interface, for example ensuring that markup or escape characters
  in such strings are not executed, that null bytes are properly handled, that over-long strings do
  not cause crashes or buffer overruns, and so forth.</p>

  <p><strong>Leaking Intranet URLs.</strong> The mechanism described in this section can result in
  secret Intranet URLs being leaked, in the following manner:</p>

  <ol>

   <li>The user registers a third-party content handler as the default handler for a content
   type.</li>

   <li>The user then browses his corporate Intranet site and accesses a document that uses that
   content type.</li>

   <li>The user agent contacts the third party and hands the third party the URL to the Intranet
   content.</li>

  </ol>

  <p>No actual confidential file data is leaked in this manner, but the URLs themselves could
  contain confidential information. For example, the URL could be <code
 >http://www.corp.example.com/upcoming-aquisitions/the-sample-company.egf</code>, which
  might tell the third party that Example Corporation is intending to merge with The Sample Company.
  Implementors might wish to consider allowing administrators to disable this feature for certain
  subdomains, content types, or schemes.</p>

  <p><strong>Leaking secure URLs.</strong> User agents should not send HTTPS URLs to third-party
  sites registered as content handlers without the user's informed consent, for the same reason that
  user agents sometimes avoid sending <code data-x="http-referer">Referer</code> (sic) HTTP
  headers from secure sites to third-party sites.</p>

  <p><strong>Leaking credentials.</strong> User agents must never send username or password
  information in the URLs that are escaped and included sent to the handler sites. User agents may
  even avoid attempting to pass to Web-based handlers the URLs of resources that are known to
  require authentication to access, as such sites would be unable to access the resources in
  question without prompting the user for credentials themselves (a practice that would require the
  user to know whether to trust the third-party handler, a decision many users are unable to make or
  even understand).</p>

  <p><strong>Interface interference.</strong> User agents should be prepared to handle intentionally
  long arguments to the methods. For example, if the user interface exposed consists of an "accept"
  button and a "deny" button, with the "accept" binding containing the name of the handler, it's
  important that a long name not cause the "deny" button to be pushed off the screen.</p>

  <p><strong>Fingerprinting users.</strong> Since a site can detect if it has attempted to register
  a particular handler or not, whether or not the user responds, the mechanism can be used to store
  data. User agents are therefore strongly urged to treat registrations in the same manner as
  cookies: clearing cookies for a site should also clear all registrations for that site, and
  disabling cookies for a site should also disable registrations.</p>

  </div>
<!--REMOVE-TOPIC:Security-->


  <div class="impl">

  <h6 id="sample-handler-impl">Sample user interface</h6>

  <p><em>This section is non-normative.</em></p>

  <p>A simple implementation of this feature for a desktop Web browser might work as follows.</p>

  <p>The <code data-x="dom-navigator-registerContentHandler">registerContentHandler()</code> method
  could display a modal dialog box:</p>

  <p><img src="images/sample-content-handler-registration.png" width="534" height="374" alt="The modal dialog box could have the title 'Content Handler Registration', and could say 'This Web page: Kittens at work http://kittens.example.org/ ...would like permission to handle files of type: application/x-meowmeow using the following Web-based application: Kittens-at-work displayer http://kittens.example.org/?show=%s Do you trust the administrators of the &quot;kittens.example.org&quot; domain?' with two buttons, 'Trust kittens.example.org' and 'Cancel'."></p>

  <p>In this dialog box, "Kittens at work" is the title of the page that invoked the method,
  "http://kittens.example.org/" is the URL of that page, "application/x-meowmeow" is the string that
  was passed to the <code
  data-x="dom-navigator-registerContentHandler">registerContentHandler()</code> method as its first
  argument (<var>mimeType</var>), "http://kittens.example.org/?show=%s" was the second
  argument (<var>url</var>), and "Kittens-at-work displayer" was the third argument (<var>title</var>).</p>

  <p>If the user clicks the Cancel button, then nothing further happens. If the user clicks the
  "Trust" button, then the handler is remembered.</p>

  <p>When the user then attempts to fetch a URL that uses the "application/x-meowmeow" <span>MIME
  type</span>, then it might display a dialog as follows:</p>

  <p><img src="images/sample-content-handler.png" width="577" height="428" alt="The dialog box could have the title 'Unknown File Type' and could say 'You have attempted to access:' followed by a URL, followed by a prompt such as 'How would you like FerretBrowser to handle this resource?' with three radio buttons, one saying 'Contact the FerretBrowser plugin registry to see if there is an official way to handle this resource.', one saying 'Pass this URL to a local application' with an application selector, and one saying 'Pass this URL to the &quot;Kittens-at-work displayer&quot; application at &quot;kittens.example.org&quot;', with a checkbox labeled 'Always do this for resources using the &quot;application/x-meowmeow&quot; type in future.', and with two buttons, 'Ok' and 'Cancel'."></p>

  <p>In this dialog, the third option is the one that was primed by the site registering itself
  earlier.</p>

  <p>If the user does select that option, then the browser, in accordance with the requirements
  described in the previous two sections, will redirect the user to
  "http://kittens.example.org/?show=data%3Aapplication/x-meowmeow;base64,S2l0dGVucyBhcmUgdGhlIGN1dGVzdCE%253D".</p>

  <p>The <code data-x="dom-navigator-registerProtocolHandler">registerProtocolHandler()</code> method
  would work equivalently, but for schemes instead of unknown content types.</p>

  </div>



  <h5 id="manually-releasing-the-storage-mutex">Manually releasing the storage mutex</h5>

  <pre class="idl">[NoInterfaceObject]
interface <dfn>NavigatorStorageUtils</dfn> {
  readonly attribute boolean <span data-x="dom-navigator-cookieEnabled">cookieEnabled</span>;
  void <span data-x="dom-navigator-yieldForStorageUpdates">yieldForStorageUpdates</span>();
};</pre>

  <dl class="domintro">

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-cookieEnabled">cookieEnabled</code></dt>

   <dd>

    <p>Returns false if setting a cookie will be ignored, and true otherwise.</p>

   </dd>


   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-yieldForStorageUpdates">yieldForStorageUpdates</code>()</dt>

   <dd>

    <p>If a script uses the <code data-x="dom-document-cookie">document.cookie</code> API, or the
    <code data-x="dom-localStorage">localStorage</code> API, the browser will block other scripts
    from accessing cookies or storage until the first script finishes.
    <!--END complete-->
    <a href="#refsWEBSTORAGE">\[WEBSTORAGE]</a>
    <!--START complete-->
    </p>

    <p>Calling the <code
    data-x="dom-navigator-yieldForStorageUpdates">navigator.yieldForStorageUpdates()</code> method
    tells the user agent to unblock any other scripts that may be blocked, even though the script
    hasn't returned.</p>

    <p>Values of cookies and items in the <code>Storage</code> objects of <code
    data-x="dom-localStorage">localStorage</code> attributes can change after calling this method,
    whence its name.
    <!--END complete-->
    <a href="#refsWEBSTORAGE">\[WEBSTORAGE]</a>
    <!--START complete-->
    </p>

   </dd>

  </dl>

  <div class="impl">

   <p>The <dfn><code data-x="dom-navigator-cookieEnabled">cookieEnabled</code></dfn> attribute must
   return true if the user agent attempts to handle cookies according to the cookie specification,
   and false if it ignores cookie change requests. <a href="#refsCOOKIES">\[COOKIES]</a></p>

   <p>The <dfn><code data-x="dom-navigator-yieldForStorageUpdates">yieldForStorageUpdates()</code></dfn> method,
   when invoked, must, if the <span>storage mutex</span> is owned by the <span>event loop</span> of
   the <span data-x="concept-task">task</span> that resulted in the method being called, release the
   <span>storage mutex</span> so that it is once again free. Otherwise, it must do nothing.</p>

  </div>



  <h5 id="plugins">Plugins</h5>

  <pre class="idl">[NoInterfaceObject]
interface <dfn>NavigatorPlugins</dfn> {
  [SameObject] readonly attribute <span>PluginArray</span> <span data-x="dom-navigator-plugins">plugins</span>;
  [SameObject] readonly attribute <span>MimeTypeArray</span> <span data-x="dom-navigator-mimeTypes">mimeTypes</span>;
  readonly attribute boolean <span data-x="dom-navigator-javaEnabled">javaEnabled</span>;
};

interface <dfn>PluginArray</dfn> {
  void <span data-x="dom-PluginArray-refresh">refresh</span>(optional boolean reload = false);
  readonly attribute unsigned long <span data-x="dom-PluginArray-length">length</span>;
  getter <span data-x="dom-Plugin">Plugin</span>? <span data-x="dom-PluginArray-item">item</span>(unsigned long index);
  getter <span data-x="dom-Plugin">Plugin</span>? <span data-x="dom-PluginArray-namedItem">namedItem</span>(DOMString name);
};

interface <dfn>MimeTypeArray</dfn> {
  readonly attribute unsigned long <span data-x="dom-MimeTypeArray-length">length</span>;
  getter <span>MimeType</span>? <span data-x="dom-MimeTypeArray-item">item</span>(unsigned long index);
  getter <span>MimeType</span>? <span data-x="dom-MimeTypeArray-namedItem">namedItem</span>(DOMString name);
};

interface <dfn data-x="dom-Plugin">Plugin</dfn> {
  readonly attribute DOMString <span data-x="dom-Plugin-name">name</span>;
  readonly attribute DOMString <span data-x="dom-Plugin-description">description</span>;
  readonly attribute DOMString <span data-x="dom-Plugin-filename">filename</span>;
  readonly attribute unsigned long <span data-x="dom-Plugin-length">length</span>;
  getter <span>MimeType</span>? <span data-x="dom-Plugin-item">item</span>(unsigned long index);
  getter <span>MimeType</span>? <span data-x="dom-Plugin-namedItem">namedItem</span>(DOMString name);
};

interface <dfn>MimeType</dfn> {
  readonly attribute DOMString <span data-x="dom-MimeType-type">type</span>;
  readonly attribute DOMString <span data-x="dom-MimeType-description">description</span>;
  readonly attribute DOMString <span data-x="dom-MimeType-suffixes">suffixes</span>; // comma-separated
  readonly attribute <span data-x="dom-Plugin">Plugin</span> <span data-x="dom-MimeType-enabledPlugin">enabledPlugin</span>;
};</pre>

  <dl class="domintro">

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-plugins">plugins</code> . <code subdfn data-x="dom-PluginArray-refresh">refresh</code>( [ <var>refresh</var> ] )</dt>
   <dd>
    <p>Updates the lists of supported plugins and MIME types for this page, and reloads the page if the lists have changed.</p>
    <!-- that's not quite what all browsers have always done -->
   </dd>

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code data-x="dom-navigator-plugins">plugins</code> . <code subdfn data-x="dom-PluginArray-length">length</code></dt>
   <dd>
    <p>Returns the number of plugins, represented by <code data-x="dom-Plugin">Plugin</code> objects, that the user agent reports.</p>
   </dd>

   <dt><var>plugin</var> = <var>window</var> . <code data-x="dom-navigator">navigator</code> . <code data-x="dom-navigator-plugins">plugins</code> . <code subdfn data-x="dom-PluginArray-item">item</code>(<var>index</var>)</dt>
   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code data-x="dom-navigator-plugins">plugins</code>[<var>index</var>]</dt>
   <dd>
    <p>Returns the specified <code data-x="dom-Plugin">Plugin</code> object.</p>
   </dd>

   <dt><var>plugin</var> = <var>window</var> . <code data-x="dom-navigator">navigator</code> . <code data-x="dom-navigator-plugins">plugins</code> . <code data-x="dom-PluginArray-item">item</code>(<var>name</var>)</dt>
   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code data-x="dom-navigator-plugins">plugins</code>[<var>name</var>]</dt>
   <dd>
    <p>Returns the <code data-x="dom-Plugin">Plugin</code> object for the plugin with the given name.</p>
   </dd>

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-mimeTypes">mimeTypes</code> . <code subdfn data-x="dom-MimeTypeArray-length">length</code></dt>
   <dd>
    <p>Returns the number of MIME types, represented by <code>MimeType</code> objects, supported by the plugins that the user agent reports.</p>
   </dd>

   <dt><var>mimeType</var> = <var>window</var> . <code data-x="dom-navigator">navigator</code> . <code data-x="dom-navigator-mimeTypes">mimeTypes</code> . <code subdfn data-x="dom-MimeTypeArray-item">item</code>(<var>index</var>)</dt>
   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code data-x="dom-navigator-mimeTypes">mimeTypes</code>[<var>index</var>]</dt>
   <dd>
    <p>Returns the specified <code>MimeType</code> object.</p>
   </dd>

   <dt><var>mimeType</var> = <var>window</var> . <code data-x="dom-navigator">navigator</code> . <code data-x="dom-navigator-mimeTypes">mimeTypes</code> . <code data-x="dom-MimeTypeArray-item">item</code>(<var>name</var>)</dt>
   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code data-x="dom-navigator-mimeTypes">mimeTypes</code>[<var>name</var>]</dt>
   <dd>
    <p>Returns the <code>MimeType</code> object for the given MIME type.</p>
   </dd>

   <dt><var>plugin</var> . <code subdfn data-x="dom-Plugin-name">name</code>
   <dd>
    <p>Returns the plugin's name.</p>
   </dd>

   <dt><var>plugin</var> . <code subdfn data-x="dom-Plugin-description">description</code>
   <dd>
    <p>Returns the plugin's description.</p>
   </dd>

   <dt><var>plugin</var> . <code subdfn data-x="dom-Plugin-filename">filename</code>
   <dd>
    <p>Returns the plugin library's filename, if applicable on the current platform.</p>
   </dd>

   <dt><var>plugin</var> . <code subdfn data-x="dom-Plugin-length">length</code></dt>
   <dd>
    <p>Returns the number of MIME types, represented by <code>MimeType</code> objects, supported by the plugin.</p>
   </dd>

   <dt><var>mimeType</var> = <var>plugin</var> . <code subdfn data-x="dom-Plugin-item">item</code>(<var>index</var>)</dt>
   <dt><var>plugin</var>[<var>index</var>]</dt>
   <dd>
    <p>Returns the specified <code>MimeType</code> object.</p>
   </dd>

   <dt><var>mimeType</var> = <var>plugin</var> . <code data-x="dom-Plugin-item">item</code>(<var>name</var>)</dt>
   <dt><var>plugin</var>[<var>name</var>]</dt>
   <dd>
    <p>Returns the <code>MimeType</code> object for the given MIME type.</p>
   </dd>

   <dt><var>mimeType</var> . <code subdfn data-x="dom-MimeType-type">type</code>
   <dd>
    <p>Returns the MIME type.</p>
   </dd>

   <dt><var>mimeType</var> . <code subdfn data-x="dom-MimeType-description">description</code>
   <dd>
    <p>Returns the MIME type's description.</p>
   </dd>

   <dt><var>mimeType</var> . <code subdfn data-x="dom-MimeType-suffixes">suffixes</code>
   <dd>
    <p>Returns the MIME type's typical file extensions, in a comma-separated list.</p>
   </dd>

   <dt><var>mimeType</var> . <code subdfn data-x="dom-MimeType-enabledPlugin">enabledPlugin</code>
   <dd>
    <p>Returns the <code data-x="dom-Plugin">Plugin</code> object that implements this MIME type.</p>
   </dd>

   <dt><var>window</var> . <code data-x="dom-navigator">navigator</code> . <code subdfn data-x="dom-navigator-javaEnabled">javaEnabled</code></dt>
   <dd>
    <p>Returns true if there's a plugin that supports the MIME type "<code>application/x-java-vm</code>".</p>
   </dd>

  </dl>

  <div class="impl">

  <p>The <dfn><code data-x="dom-navigator-plugins">navigator.plugins</code></dfn> attribute must
  return a <code>PluginArray</code> object.</p>

  <p>The <dfn><code data-x="dom-navigator-mimeTypes">navigator.mimeTypes</code></dfn> attribute must
  return a <code>MimeTypeArray</code> object.</p>

  <hr>

  <p>A <code>PluginArray</code> object represents none, some, or all of the <span
  data-x="plugin">plugins</span> supported by the user agent, each of which is represented by a <code
  data-x="dom-Plugin">Plugin</code> object. Each of these <code data-x="dom-Plugin">Plugin</code>
  objects may be <dfn data-x="hidden plugin">hidden plugins</dfn>. A <span>hidden plugin</span> can't
  be enumerated, but can still be inspected by using its name.</p>

  <p class="note">The fewer <span data-x="plugin">plugins</span> are represented by the
  <code>PluginArray</code> object, and of those, the more that are <span data-x="hidden
  plugin">hidden</span>, the more the user's privacy will be protected. Each exposed plugin
  increases the number of bits that can be derived for fingerprinting. Hiding a plugin helps, but
  unless it is an extremely rare plugin, it is likely that a site attempting to derive the list of
  plugins can still determine whether the plugin is supported or not by probing for it by name (the
  names of popular plugins are widely known). Therefore not exposing a plugin at all is preferred.
  Unfortunately, many legacy sites use this feature to determine, for example, which plugin to use
  to play video. Not exposing any plugins at all might therefore not be entirely plausible.</p>

  <p>The <code>PluginArray</code> objects created by a user agent must not be <span>live</span>. The
  set of plugins represented by the objects must not change once an object is created, except when
  it is updated by the <code data-x="dom-PluginArray-refresh">refresh()</code> method.</p>

  <p>Each <span>plugin</span> represented by a <code>PluginArray</code> can support a number of
  <span data-x="MIME type">MIME types</span>. For each such <span>plugin</span>, the user agent must
  pick one or more of these <span data-x="MIME type">MIME types</span> to be those that are
  <dfn>explicitly supported</dfn>.</p>

  <p class="note">The <span>explicitly supported</span> <span data-x="MIME type">MIME types</span> of
  a <span>plugin</span> are those that are exposed through the <code
  data-x="dom-Plugin">Plugin</code> and <code>MimeTypeArray</code> interfaces. As with <span
  data-x="plugin">plugins</span> themselves, any variation between users regarding what is exposed
  allows sites to fingerprint users. User agents are therefore encouraged to expose the same <span
  data-x="MIME type">MIME types</span> for all users of a <span>plugin</span>, regardless of the
  actual types supported... at least, within the constraints imposed by compatibility with legacy
  content.</p>

  <p>The <span>supported property indices</span> of a <code>PluginArray</code> object are the
  numbers from zero to the number of non-<span data-x="hidden plugin">hidden</span> <span
  data-x="plugin">plugins</span> represented by the object, if any.
  <!--INSERT FINGERPRINT-->
  </p>

  <p>The <dfn><code data-x="dom-PluginArray-length">length</code></dfn> attribute must return the
  number of non-<span data-x="hidden plugin">hidden</span> <span data-x="plugin">plugins</span>
  represented by the object.
  <!--INSERT FINGERPRINT-->
  </p>

  <p>The <dfn><code data-x="dom-PluginArray-item">item()</code></dfn> method of a
  <code>PluginArray</code> object must return null if the argument is not one of the object's
  <span>supported property indices</span>, and otherwise must return the result of running the
  following steps, using the method's argument as <var>index</var>:</p>

  <ol>

   <li><p>Let <var>list</var> be the <code data-x="dom-Plugin">Plugin</code> objects
   representing the non-<span data-x="hidden plugin">hidden</span> <span
   data-x="plugin">plugins</span> represented by the <code>PluginArray</code> object.</p></li>

   <li><p>Sort <var>list</var> alphabetically by the <code
   data-x="dom-Plugin-name">name</code> of each <code data-x="dom-Plugin">Plugin</code>.</p></li>

   <li><p>Return the <var>index</var>th entry in <var>list</var>.</p></li>

  </ol>

  <p class="note">It is important <span class="no-backref" data-x="fingerprinting vector">for
  privacy</span> that the order of plugins not leak additional information, e.g. the order in which
  plugins were installed.</p>

  <p>The <span>supported property names</span> of a <code>PluginArray</code> object are the values
  of the <code data-x="dom-Plugin-name">name</code> attributes of all the <code
  data-x="dom-Plugin">Plugin</code> objects represented by the <code>PluginArray</code> object. The
  properties exposed in this way must be <span>unenumerable</span>.
  <!--INSERT FINGERPRINT-->
  </p>

  <p>The <dfn><code data-x="dom-PluginArray-namedItem">namedItem()</code></dfn> method of a
  <code>PluginArray</code> object must return null if the argument is not one of the object's
  <span>supported property names</span>, and otherwise must return the <code
  data-x="dom-Plugin">Plugin</code> object, of those represented by the <code>PluginArray</code>
  object, that has a <code data-x="dom-Plugin-name">name</code> equal to the method's argument.</p>

  <p>The <dfn><code data-x="dom-PluginArray-refresh">refresh()</code></dfn> method of the
  <code>PluginArray</code> object of a <code>Navigator</code> object, when invoked, must check to
  see if any <span data-x="plugin">plugins</span> have been installed or reconfigured since the user
  agent created the <code>PluginArray</code> object. If so, and the method's argument is true, then
  the user agent must act as if the <code data-x="dom-location-reload">location.reload()</code>
  method was called instead. Otherwise, the user agent must update the <code>PluginArray</code>
  object and <code>MimeTypeArray</code> object created for attributes of that <code>Navigator</code>
  object, and the <code data-x="dom-Plugin">Plugin</code> and <code>MimeType</code> objects created
  for those <code>PluginArray</code> and <code>MimeTypeArray</code> objects, using the same <code
  data-x="dom-Plugin">Plugin</code> objects for cases where the <code
  data-x="dom-Plugin-name">name</code> is the same, and the same <code>MimeType</code> objects for
  cases where the <code data-x="dom-MimeType-type">type</code> is the same, and creating new objects
  for cases where there were no matching objects immediately prior to the <code
  data-x="dom-PluginArray-refresh">refresh()</code> call. Old <code data-x="dom-Plugin">Plugin</code>
  and <code>MimeType</code> objects must continue to return the same values that they had prior to
  the update, though naturally now the data is stale and may appear inconsistent (for example, an
  old <code>MimeType</code> entry might list as its <code
  data-x="dom-MimeType-enabledPlugin">enabledPlugin</code> a <code data-x="dom-Plugin">Plugin</code>
  object that no longer lists that <code>MimeType</code> as a supported <code>MimeType</code>).</p>

  <hr>

  <p>A <code>MimeTypeArray</code> object represents the <span data-x="MIME type">MIME types</span>
  <span>explicitly supported</span> by <span data-x="plugin">plugins</span> supported by the user
  agent, each of which is represented by a <code>MimeType</code> object.</p>

  <p>The <code>MimeTypeArray</code> objects created by a user agent must not be <span>live</span>.
  The set of MIME types represented by the objects must not change once an object is created, except
  when it is updated by the <code>PluginArray</code> object's <code
  data-x="dom-PluginArray-refresh">refresh()</code> method.</p>

  <p>The <span>supported property indices</span> of a <code>MimeTypeArray</code> object are the
  numbers from zero to the number of <span data-x="MIME type">MIME types</span> <span>explicitly
  supported</span> by non-<span data-x="hidden plugin">hidden</span> <span
  data-x="plugin">plugins</span> represented by the corresponding <code>PluginArray</code> object, if
  any.
  <!--INSERT FINGERPRINT-->
  </p>

  <p>The <dfn><code data-x="dom-MimeTypeArray-length">length</code></dfn> attribute must return the
  number of <span data-x="MIME type">MIME types</span> <span>explicitly supported</span> by non-<span
  data-x="hidden plugin">hidden</span> <span data-x="plugin">plugins</span> represented by the
  corresponding <code>PluginArray</code> object, if any.
  <!--INSERT FINGERPRINT-->
  </p>

  <p>The <dfn><code data-x="dom-MimeTypeArray-item">item()</code></dfn> method of a
  <code>MimeTypeArray</code> object must return null if the argument is not one of the object's
  <span>supported property indices</span>, and otherwise must return the result of running the
  following steps, using the method's argument as <var>index</var>:</p>

  <ol>

   <li><p>Let <var>list</var> be the <code>MimeType</code> objects representing the <span
   data-x="MIME type">MIME types</span> <span>explicitly supported</span> by non-<span data-x="hidden
   plugin">hidden</span> <span data-x="plugin">plugins</span> represented by the corresponding
   <code>PluginArray</code> object, if any.</p></li>

   <li><p>Sort <var>list</var> alphabetically by the <code
   data-x="dom-MimeType-type">type</code> of each <code>MimeType</code>.</p></li>

   <li><p>Return the <var>index</var>th entry in <var>list</var>.</p></li>

  </ol>

  <p class="note">It is important <span class="no-backref" data-x="fingerprinting vector">for
  privacy</span> that the order of MIME types not leak additional information, e.g. the order in
  which plugins were installed.</p>

  <p>The <span>supported property names</span> of a <code>MimeTypeArray</code> object are the values
  of the <code data-x="dom-MimeType-type">type</code> attributes of all the <code>MimeType</code>
  objects represented by the <code>MimeTypeArray</code> object. The properties exposed in this way
  must be <span>unenumerable</span>.
  <!--INSERT FINGERPRINT-->
  </p>

  <p>The <dfn><code data-x="dom-MimeTypeArray-namedItem">namedItem()</code></dfn> method of a
  <code>MimeTypeArray</code> object must return null if the argument is not one of the object's
  <span>supported property names</span>, and otherwise must return the <code>MimeType</code> object
  that has a <code data-x="dom-MimeType-type">type</code> equal to the method's argument.</p>

  <hr>

  <p>A <code data-x="dom-Plugin">Plugin</code> object represents a <span>plugin</span>. It has
  several attributes to provide details about the plugin, and can be enumerated to obtain the list
  of <span data-x="MIME type">MIME types</span> that it <span data-x="explicitly supported">explicitly
  supports</span>.</p>

  <p>The <code data-x="dom-Plugin">Plugin</code> objects created by a user agent must not be
  <span>live</span>. The set of MIME types represented by the objects, and the values of the
  objects' attributes, must not change once an object is created, except when updated by the
  <code>PluginArray</code> object's <code data-x="dom-PluginArray-refresh">refresh()</code>
  method.</p>

  <p>The <dfn>reported MIME types</dfn> for a <code data-x="dom-Plugin">Plugin</code> object are the
  <span data-x="MIME type">MIME types</span> <span>explicitly supported</span> by the corresponding
  <span>plugin</span> when this object was last created or updated by <code
  data-x="dom-PluginArray-refresh">PluginArray.refresh()</code>, whichever happened most
  recently.</p>

  <p>The <span>supported property indices</span> of a <code data-x="dom-Plugin">Plugin</code> object
  are the numbers from zero to the number of <span>reported MIME types</span>.
  <!--INSERT FINGERPRINT-->
  </p>

  <p>The <dfn><code data-x="dom-Plugin-length">length</code></dfn> attribute must return the number
  of <span>reported MIME types</span>.
  <!--INSERT FINGERPRINT-->
  </p>

  <p>The <dfn><code data-x="dom-Plugin-item">item()</code></dfn> method of a <code
  data-x="dom-Plugin">Plugin</code> object must return null if the argument is not one of the
  object's <span>supported property indices</span>, and otherwise must return the result of running
  the following steps, using the method's argument as <var>index</var>:</p>

  <ol>

   <li><p>Let <var>list</var> be the <code>MimeType</code> objects representing the
   <span>reported MIME types</span>.</p></li>

   <li><p>Sort <var>list</var> alphabetically by the <code
   data-x="dom-MimeType-type">type</code> of each <code>MimeType</code>.</p></li>

   <li><p>Return the <var>index</var>th entry in <var>list</var>.</p></li>

  </ol>

  <p class="note">It is important <span class="no-backref" data-x="fingerprinting vector">for
  privacy</span> that the order of MIME types not leak additional information, e.g. the order in
  which plugins were installed.</p>

  <p>The <span>supported property names</span> of a <code data-x="dom-Plugin">Plugin</code> object
  are the values of the <code data-x="dom-MimeType-type">type</code> attributes of the
  <code>MimeType</code> objects representing the <span>reported MIME types</span>. The properties
  exposed in this way must be <span>unenumerable</span>.
  <!--INSERT FINGERPRINT-->
  </p>

  <p>The <dfn><code data-x="dom-Plugin-namedItem">namedItem()</code></dfn> method of a <code
  data-x="dom-Plugin">Plugin</code> object must return null if the argument is not one of the
  object's <span>supported property names</span>, and otherwise must return the
  <code>MimeType</code> object that has a <code data-x="dom-MimeType-type">type</code> equal to the
  method's argument.</p>

  <p>The <dfn><code data-x="dom-Plugin-name">name</code></dfn> attribute must return the
  <span>plugin</span>'s name.</p>

  <p>The <dfn><code data-x="dom-Plugin-description">description</code></dfn> and <dfn><code data-x="dom-Plugin-filename">filename</code></dfn> attributes must return user-agent-defined
  (or, in all likelihood, <span>plugin</span>-defined) strings. In each case, the same string must
  be returned each time, except that the strings returned may change when the <code
  data-x="dom-PluginArray-refresh">PluginArray.refresh()</code> method updates the object.</p>

  <p class="warning">If the values returned by the <code
  data-x="dom-Plugin-description">description</code> or <code
  data-x="dom-Plugin-filename">filename</code> attributes vary between versions of a
  <span>plugin</span>, they can be used both as a fingerprinting vector and, even more importantly,
  as a trivial way to determine what security vulnerabilities a <span>plugin</span> (and thus a
  browser) may have. It is thus highly recommended that the <code
  data-x="dom-Plugin-description">description</code> attribute just return the same value as the
  <code data-x="dom-Plugin-name">name</code> attribute, and that the <code
  data-x="dom-Plugin-filename">filename</code> attribute return the empty string.
  <!--INSERT FINGERPRINT-->
  </p>

  <hr>

  <p>A <code>MimeType</code> object represents a <span>MIME type</span> that is, or was,
  <span>explicitly supported</span> by a <span>plugin</span>.</p>

  <p>The <code>MimeType</code> objects created by a user agent must not be <span>live</span>. The
  values of the objects' attributes must not change once an object is created, except when updated
  by the <code>PluginArray</code> object's <code data-x="dom-PluginArray-refresh">refresh()</code>
  method.</p>

  <p>The <dfn><code data-x="dom-MimeType-type">type</code></dfn> attribute must return the
  <span>valid MIME type with no parameters</span> describing the <span>MIME type</span>.</p>

  <p>The <dfn><code data-x="dom-MimeType-description">description</code></dfn> and <dfn><code data-x="dom-MimeType-suffixes">suffixes</code></dfn> attributes must return
  user-agent-defined (or, in all likelihood, <span>plugin</span>-defined) strings. In each case, the
  same string must be returned each time, except that the strings returned may change when the <code
  data-x="dom-PluginArray-refresh">PluginArray.refresh()</code> method updates the object.</p>

  <p class="warning">If the values returned by the <code
  data-x="dom-MimeType-description">description</code> or <code
  data-x="dom-MimeType-suffixes">suffxies</code> attributes vary between versions of a
  <span>plugin</span>, they can be used both as a fingerprinting vector and, even more importantly,
  as a trivial way to determine what security vulnerabilities a <span>plugin</span> (and thus a
  browser) may have. It is thus highly recommended that the <code
  data-x="dom-MimeType-description">description</code> attribute just return the same value as the
  <code data-x="dom-MimeType-type">type</code> attribute, and that the <code
  data-x="dom-MimeType-suffixes">suffixes</code> attribute return the empty string.
  <!--INSERT FINGERPRINT-->
  </p>

  <p class="note">Commas in the <code data-x="dom-MimeType-suffixes">suffixes</code> attribute are
  interpreted as separating subsequent filename extensions, as in "<code
 >htm,html</code>".</p>

  <p>The <dfn><code data-x="dom-MimeType-enabledPlugin">enabledPlugin</code></dfn> attribute must
  return the <code data-x="dom-Plugin">Plugin</code> object that represents the <span>plugin</span>
  that <span>explicitly supported</span> the <span>MIME type</span> that this <code>MimeType</code>
  object represents when this object was last created or updated by <code
  data-x="dom-PluginArray-refresh">PluginArray.refresh()</code>, whichever happened most
  recently.</p>

  <hr>

  <p>The <dfn><code data-x="dom-navigator-javaEnabled">navigator.javaEnabled</code></dfn> attribute
  must return true if the user agent supports a <span>plugin</span> that supports the <span>MIME
  type</span> "<code>application/x-java-vm</code>"; otherwise it must return false.
  <!--INSERT FINGERPRINT-->
  </p>

  </div>



  <h4>The <code>External</code> interface</h4>

  <div class="impl">

  <p>The <dfn><code data-x="dom-external">external</code></dfn> attribute of the <code>Window</code>
  interface must return an instance of the <code>External</code> interface.</p>

  </div>

  <pre class="idl">interface <dfn>External</dfn> {
  void <span data-x="dom-external-AddSearchProvider">AddSearchProvider</span>(DOMString engineURL);
  unsigned long <span data-x="dom-external-IsSearchProviderInstalled">IsSearchProviderInstalled</span>(DOMString engineURL);
};</pre>

  <p class="note">For historical reasons, members on this interface are capitalized.</p>

  <dl class="domintro">

   <dt><var>window</var> . <code subdfn data-x="dom-external">external</code> . <code subdfn data-x="dom-external-AddSearchProvider">AddSearchProvider</code>( <var>url</var> )</dt>
   <dd>

    <p>Adds the search engine described by the OpenSearch description document at <var>url</var>. <a href="#refsOPENSEARCH">\[OPENSEARCH]</a></p>

    <p>The OpenSearch description document has to be on the same server as the script that calls
    this method.</p>

   </dd>

   <dt><var>installed</var> = <var>window</var> . <code data-x="dom-external">external</code> . <code subdfn data-x="dom-external-IsSearchProviderInstalled">IsSearchProviderInstalled</code>( <var>url</var> )</dt>
   <dd>

    <p>Returns a value based on comparing <var>url</var> to the URLs of the results pages
    of the installed search engines.</p>

    <dl>
     <dt>0 <dd>None of the installed search engines match <var>url</var>.
     <dt>1 <dd>One or more installed search engines match <var>url</var>, but none are the user's default search engine.
     <dt>2 <dd>The user's default search engine matches <var>url</var>.
    </dl>

    <p>The <var>url</var> is compared to the URLs of the results pages of the installed
    search engines using a prefix match. Only results pages on the same domain as the script that
    calls this method are checked.</p>

   </dd>

  </dl>

  <p class="note">Another way of exposing search engines using OpenSearch description documents is
  using a <code>link</code> element with the <code data-x="rel-search">search</code> link type.</p>

  <div class="impl">

   <p>The <dfn><code data-x="dom-external-AddSearchProvider">AddSearchProvider()</code></dfn> method,
   when invoked, must run the following steps:</p>

   <ol>

    <li><p>Optionally, abort these steps. User agents may implement the method as a stub method that
    never does anything, or may arbitrarily ignore invocations with particular arguments for
    security, privacy, or usability reasons.</p></li>

    <li><p><span data-x="resolve a url">Resolve</span> the value of the method's first argument
    relative to the <span>API base URL</span> specified by the <span>entry settings
    object</span>.</p></li>

    <li><p>If this fails, abort these steps.</p></li>

    <li><p>Process the resulting <span>absolute URL</span> as the <span>URL</span> to an OpenSearch
    description document. <a href="#refsOPENSEARCH">\[OPENSEARCH]</a></p></li>

   </ol>

   <p>The <dfn><code data-x="dom-external-IsSearchProviderInstalled">IsSearchProviderInstalled()</code></dfn>
   method, when invoked, must run the following steps:
   <!--INSERT FINGERPRINT-->
   </p>

   <ol>

    <li><p>Optionally, return 0 and abort these steps. User agents may implement the method as a
    stub method that never returns a non-zero value, or may arbitrarily ignore invocations with
    particular arguments for security, privacy, or usability reasons.</p></li>

    <li><p>If the <span>origin</span> specified by the <span>entry settings object</span> is an
    opaque identifier (i.e. it has no host component), then return 0 and abort these steps.</p></li>

    <li><p>Let <var>host1</var> be the host component of the <span>origin</span> specified
    by the <span>entry settings object</span>.</p></li>

    <li><p><span data-x="resolve a url">Resolve</span> the <var>scriptURL</var> argument
    relative to the <span>API base URL</span> specified by the <span>entry settings
    object</span>.</p></li>

    <li><p>If this fails, return 0 and abort these steps.</p></li>

    <li><p>Let <var>host2</var> be the <span data-x="concept-url-host">host</span> component
    of the resulting <span>parsed URL</span>.</p></li>

    <li>

     <p>If the longest suffix in the Public Suffix List that matches the end of <var>host1</var> is different than the longest suffix in the Public Suffix List that
     matches the end of <var>host2</var>, then return 0 and abort these steps. <a href="#refsPSL">\[PSL]</a></p>

     <p>If the next domain component of <var>host1</var> and <var>host2</var>
     after their common suffix are not the same, then return 0 and abort these steps.</p>

     <!-- host1 is ascii here because origins are ascii. host2 is ascii because resolve urls
     punycodes idna. -->

    </li>

    <li><p>Let <var>search engines</var> be the list of search engines known by the user
    agent and made available to the user by the user agent for which the resulting <span>absolute
    URL</span> is a <span>prefix match</span> of the search engine's <span>URL</span>, if any. For
    search engines registered using OpenSearch description documents, the <span>URL</span> of the
    search engine corresponds to the URL given in a <code>Url</code> element whose <code
   >rel</code> attribute is "<code>results</code>" (the default). <a href="#refsOPENSEARCH">\[OPENSEARCH]</a></p></li>

    <li><p>If <var>search engines</var> is empty, return 0 and abort these steps.</p></li>

    <li><p>If the user's default search engine (as determined by the user agent) is one of the
    search engines in <var>search engines</var>, then return 2 and abort these
    steps.</p></li>

    <li><p>Return 1.</p></li>

   </ol>

  </div>


<!--TOPIC:Canvas-->

  <h3 id="images">Images</h3>

  <pre class="idl">[Exposed=(Window, Worker)]
interface <dfn>ImageBitmap</dfn> {
  readonly attribute unsigned long <span data-x="dom-ImageBitmap-width">width</span>;
  readonly attribute unsigned long <span data-x="dom-ImageBitmap-height">height</span>;
};

typedef (<span>HTMLImageElement</span> or
         <span>HTMLVideoElement</span> or
         <span>HTMLCanvasElement</span> or
         <span>Blob</span> or
         <span>ImageData</span> or
         <span>CanvasRenderingContext2D</span> or
         <span>ImageBitmap</span>) <dfn>ImageBitmapSource</dfn>;

[NoInterfaceObject, Exposed=(Window, Worker)]
interface <dfn>ImageBitmapFactories</dfn> {
  Promise&lt;ImageBitmap&gt; <span data-x="dom-createImageBitmap">createImageBitmap</span>(<span>ImageBitmapSource</span> image);
  Promise&lt;ImageBitmap&gt; <span data-x="dom-createImageBitmap">createImageBitmap</span>(<span>ImageBitmapSource</span> image, long sx, long sy, long sw, long sh);
};
<span>Window</span> implements <span>ImageBitmapFactories</span>;
<span>WorkerGlobalScope</span> implements <span>ImageBitmapFactories</span>;</pre>

  <p>An <code>ImageBitmap</code> object represents a bitmap image that can be painted to a canvas
  without undue latency.</p>

  <p class="note">The exact judgement of what is undue latency of this is left up to the
  implementer, but in general if making use of the bitmap requires network I/O, or even local disk
  I/O, then the latency is probably undue; whereas if it only requires a blocking read from a GPU or
  system RAM, the latency is probably acceptable.</p>

  <dl class="domintro">

   <dt><var>promise</var> = <var>Window</var> . <code subdfn data-x="dom-createImageBitmap">createImageBitmap</code>(<var>image</var> [, <var>sx</var>, <var>sy</var>, <var>sw</var>, <var>sh</var> ] )</dt>

   <dd>

    <p>Takes <var>image</var>, which can be an <code>img</code> element,
    <code>video</code>, or <code>canvas</code> element, a <code>Blob</code> object, an
    <code>ImageData</code> object, a <code>CanvasRenderingContext2D</code> object, or another
    <code>ImageBitmap</code> object, and returns a promise that is resolved when a new
    <code>ImageBitmap</code> is created.</p>

    <p>If no <code>ImageBitmap</code> object can be constructed, for example because the provided
    <var>image</var> data is not actually an image, then the promise is rejected instead.</p>

    <p>If <var>sx</var>, <var>sy</var>, <var>sw</var>, and <var>sh</var> arguments are provided, the source image is cropped to the given pixels, with
    any pixels missing in the original replaced by transparent black. These coordinates are in the
    source image's pixel coordinate space, <em>not</em> in CSS pixels.</p>

    <p>Rejects the promise with an <code>InvalidStateError</code> exception if the source image is not in a valid
    state (e.g. an <code>img</code> element that hasn't finished loading, or a
    <code>CanvasRenderingContext2D</code> object whose bitmap data has zero length along one or both
    dimensions, or an <code>ImageData</code> object whose data is <code
    data-x="dom-imagedata-data">data</code> attribute has been <span
    data-x="concept-Transferable-neutered">neutered</span>). Rejects the promise with a <code>SecurityError</code>
    exception if the script is not allowed to access the image data of the source image (e.g. a
    <code>video</code> that is <span>CORS-cross-origin</span>, or a <code>canvas</code> being drawn
    on by a script in a worker from another <span>origin</span>).</p>

   </dd>

   <dt><var>imageBitmap</var> . <code subdfn data-x="dom-ImageBitmap-width">width</code></dt>

   <dd>

    <p>Returns the <span>intrinsic width</span> of the image, in CSS pixels.</p>

   </dd>

   <dt><var>imageBitmap</var> . <code subdfn data-x="dom-ImageBitmap-height">height</code></dt>

   <dd>

    <p>Returns the <span>intrinsic height</span> of the image, in CSS pixels.</p>

   </dd>

  </dl>

  <div class="impl">

  <p>An <code>ImageBitmap</code> object always has associated bitmap data, with a width and a
  height. However, it is possible for this data to be corrupted. If an <code>ImageBitmap</code>
  object's media data can be decoded without errors, it is said to be <dfn
  data-x="concept-ImageBitmap-good">fully decodable</dfn>.</p>

  <p>An <code>ImageBitmap</code> object can be obtained from a variety of different objects, using
  the <dfn><code data-x="dom-createImageBitmap">createImageBitmap()</code></dfn> method. When invoked, the
  method must act as follows:</p>
  <!-- the canvas createPattern() and drawImage() methods have similar requirements -->

  <dl>

   <dt>If <var>image</var> is an <code>img</code> element

   <dd>

    <ol>

     <li><p>If either the <var>sw</var> or <var>sh</var> arguments are specified
     but zero, return a promise rejected with an <code>IndexSizeError</code> exception and abort these steps.</p></li>

     <li><p>If the <code>img</code> element is not <span data-x="img-all">completely
     available</span>, then return a promise rejected with an <code>InvalidStateError</code> exception and abort these
     steps.</p></li>

<!--ADD-TOPIC:Security-->
     <li><p>If the <span>origin</span> of the <code>img</code> element's image is not the <span>same
     origin</span> as the <span>origin</span> specified by the <span>entry settings object</span>,
     then return a promise rejected with a <code>SecurityError</code> exception and abort these steps.</p></li>
<!--REMOVE-TOPIC:Security-->

     <li><p>If the <code>img</code> element's media data is not a bitmap (e.g. it's a vector
     graphic), then return a promise rejected with an <code>InvalidStateError</code> exception and abort these
     steps.</p></li>

     <li><p>Create a new <code>ImageBitmap</code> object.</p></li>

     <li><p>Let the <code>ImageBitmap</code> object's bitmap data be a copy of the <code>img</code>
     element's media data, <span>cropped to the source rectangle</span>. If this is an animated
     image, the <code>ImageBitmap</code> object's bitmap data must only be taken from the default
     image of the animation (the one that the format defines is to be used when animation is not
     supported or is disabled), or, if there is no such image, the first frame of the
     animation.</p></li>

     <li><p>Return a new promise, but continue running these steps
     <span>in parallel</span>.</p></li>

     <li><p>Resolve the promise with the new <code>ImageBitmap</code> object as the value.</p></li>

    </ol>

   </dd>

   <dt>If <var>image</var> is a <code>video</code> element

   <dd>

    <ol>

     <li><p>If either the <var>sw</var> or <var>sh</var> arguments are specified
     but zero, return a promise rejected with an <code>IndexSizeError</code> exception and abort these steps.</p></li>

     <li><p>If the <code>video</code> element's <code
     data-x="dom-media-networkState">networkState</code> attribute is <code
     data-x="dom-media-NETWORK_EMPTY">NETWORK_EMPTY</code>, then return a promise rejected with an
     <code>InvalidStateError</code> exception and abort these steps.</p></li>

<!--ADD-TOPIC:Security-->
     <li><p>If the <span>origin</span> of the <code>video</code> element is not the <span>same
     origin</span> as the <span>origin</span> specified by the <span>entry settings object</span>,
     then return a promise rejected with a <code>SecurityError</code> exception and abort these steps.</p></li>
<!--REMOVE-TOPIC:Security-->

     <li><p>If the <code>video</code> element's <code
     data-x="dom-media-readyState">readyState</code> attribute is either <code
     data-x="dom-media-HAVE_NOTHING">HAVE_NOTHING</code> or <code
     data-x="dom-media-HAVE_METADATA">HAVE_METADATA</code>, then return a promise rejected with an
     <code>InvalidStateError</code> exception and abort these steps.</p></li>

     <li><p>Create a new <code>ImageBitmap</code> object.</p></li>

     <li><p>Let the <code>ImageBitmap</code> object's bitmap data be a copy of the frame at the
     <span>current playback position</span>, at the <span>media resource</span>'s <span
     data-x="concept-video-intrinsic-width">intrinsic width</span> and <span
     data-x="concept-video-intrinsic-height">intrinsic height</span> (i.e. after any aspect-ratio
     correction has been applied), <span>cropped to the source rectangle</span>.</p>

     <li><p>Return a new promise, but continue running these steps
     <span>in parallel</span>.</p></li>

     <li><p>Resolve the promise with the new <code>ImageBitmap</code> object as the value.</p></li>

    </ol>

   </dd>

   <dt>If <var>image</var> is a <code>canvas</code> element

   <dd>

    <ol>

     <li><p>If either the <var>sw</var> or <var>sh</var> arguments are specified
     but zero, return a promise rejected with an <code>IndexSizeError</code> exception and abort these steps.</p></li>

<!--ADD-TOPIC:Security-->
     <li><p>If the <code>canvas</code> element's bitmap data does not have its <span
     data-x="concept-canvas-origin-clean">origin-clean</span> flag set, then return a promise rejected with an
     <code>InvalidStateError</code> exception and abort these steps.</p></li>
<!--REMOVE-TOPIC:Security-->

     <li><p>If the <code>canvas</code> element's bitmap has either a horizontal dimension or a
     vertical dimension equal to zero, then return a promise rejected with an <code>InvalidStateError</code> exception and
     abort these steps.</p></li>

     <li><p>Create a new <code>ImageBitmap</code> object.</p></li>

     <li><p>Let the <code>ImageBitmap</code> object's bitmap data be a copy of the
     <code>canvas</code> element's bitmap data, <span>cropped to the source
     rectangle</span>.</p></li>

     <li><p>Return a new promise, but continue running these steps
     <span>in parallel</span>.</p></li>

     <li><p>Resolve the promise with the new <code>ImageBitmap</code> object as the value.</p></li>

    </ol>

   </dd>


   <dt>If <var>image</var> is a <code>Blob</code> object

   <dd>

    <ol>

     <li><p>If either the <var>sw</var> or <var>sh</var> arguments are specified
     but zero, return a promise rejected with an <code>IndexSizeError</code> exception and abort these steps.</p></li>

     <li><p>If the <code>Blob</code> object has been disabled through the <code
     data-x="dom-Blob-close">close()</code> method, then return a promise rejected with an <code>InvalidStateError</code>
     exception and abort these steps.</p></li>

     <li><p>Return a new promise, but continue running these steps
     <span>in parallel</span>.</p></li>

     <li><p>Read the <code>Blob</code> object's data. If an <span data-x="file-error-read">error
     occurs during reading of the object</span>, then reject the promise with null, and abort these
     steps.</p></li>

     <li><p>Apply the <span data-x="Content-Type sniffing: image">image sniffing rules</span> to
     determine the file format of the image data, with MIME type of the <code>Blob</code> (as given
     by the <code>Blob</code> object's <code data-x="dom-Blob-type">type</code> attribute) giving the
     official type.</p></li>

     <li><p>If the image data is not in a supported file format (e.g. it's not actually an image at
     all), or if the image data is corrupted in some fatal way such that the image dimensions cannot
     be obtained, then reject the promise with null, and abort these steps.</p></li>

     <li><p>Create a new <code>ImageBitmap</code> object.</p></li>

     <li><p>Let the <code>ImageBitmap</code> object's bitmap data be the image data read from the
     <code>Blob</code> object, <span>cropped to the source rectangle</span>. If this is an animated
     image, the <code>ImageBitmap</code> object's bitmap data must only be taken from the default
     image of the animation (the one that the format defines is to be used when animation is not
     supported or is disabled), or, if there is no such image, the first frame of the
     animation.</p></li>

     <li><p>Resolve the promise with the new <code>ImageBitmap</code> object as the value.</p></li>

    </ol>

   </dd>


   <dt>If <var>image</var> is an <code>ImageData</code> object

   <dd>

    <ol>

     <li><p>If either the <var>sw</var> or <var>sh</var> arguments are specified
     but zero, return a promise rejected with an <code>IndexSizeError</code> exception and abort these steps.</p></li>

     <li><p>If the <var>image</var> object's <code data-x="dom-imagedata-data">data</code>
     attribute has been <span data-x="concept-Transferable-neutered">neutered</span>, return a promise rejected with an
     <code>InvalidStateError</code> exception and abort these steps.</p></li>

     <li><p>Create a new <code>ImageBitmap</code> object.</p></li>

     <li><p>Let the <code>ImageBitmap</code> object's bitmap data be the image data given by the
     <code>ImageData</code> object, <span>cropped to the source rectangle</span>.</p></li>

     <li><p>Return a new promise, but continue running these steps
     <span>in parallel</span>.</p></li>

     <li><p>Resolve the promise with the new <code>ImageBitmap</code> object as the value.</p></li>

    </ol>

   </dd>

   <dt>If <var>image</var> is a <code>CanvasRenderingContext2D</code> object

   <dd>

    <ol>

     <li><p>If either the <var>sw</var> or <var>sh</var> arguments are specified
     but zero, return a promise rejected with an <code>IndexSizeError</code> exception and abort these steps.</p></li>

<!--ADD-TOPIC:Security-->
     <li><p>If the <code>CanvasRenderingContext2D</code> object's <span>scratch bitmap</span> does
     not have its <span data-x="concept-canvas-origin-clean">origin-clean</span> flag set, then return a promise rejected with
     an <code>InvalidStateError</code> exception and abort these steps.</p></li>
<!--REMOVE-TOPIC:Security-->

     <li><p>If the <code>CanvasRenderingContext2D</code> object's <span>scratch bitmap</span> has
     either a horizontal dimension or a vertical dimension equal to zero, then return a promise rejected with an
     <code>InvalidStateError</code> exception and abort these steps.</p></li>

     <li><p>Create a new <code>ImageBitmap</code> object.</p></li>

     <li><p>Let the <code>ImageBitmap</code> object's bitmap data be a copy of the
     <code>CanvasRenderingContext2D</code> object's <span>scratch bitmap</span>, <span>cropped to
     the source rectangle</span>.</p></li>

     <li><p>Return a new promise, but continue running these steps
     <span>in parallel</span>.</p></li>

     <li><p>Resolve the promise with the new <code>ImageBitmap</code> object as the value.</p></li>

    </ol>

   </dd>


   <dt>If <var>image</var> is an <code>ImageBitmap</code> object

   <dd>

    <ol>

     <li><p>If either the <var>sw</var> or <var>sh</var> arguments are specified
     but zero, return a promise rejected with an <code>IndexSizeError</code> exception and abort these steps.</p></li>

     <li><p>Create a new <code>ImageBitmap</code> object.</p></li>

     <li><p>Let the <code>ImageBitmap</code> object's bitmap data be a copy of the <var>image</var> argument's bitmap data, <span>cropped to the source
     rectangle</span>.</p></li>

     <li><p>Return a new promise, but continue running these steps
     <span>in parallel</span>.</p></li>

     <li><p>Resolve the promise with the new <code>ImageBitmap</code> object as the value.</p></li>

    </ol>

   </dd>


  </dl>

  <p>When the steps above require that the user agent <dfn data-x="cropped to the source
  rectangle">crop bitmap data to the source rectangle</dfn>, the user agent must run the following
  steps:</p>

  <ol>

   <li><p>Let <var>input</var> be the image data being cropped.</p></li>

   <li><p>If the <var>sx</var>, <var>sy</var>, <var>sw</var>, and <var>sh</var> arguments are omitted, return <var>input</var>.</p></li>

   <li><p>Place <var>input</var> on an infinite transparent black grid plane, positioned so
   that it's top left corner is at the origin of the plane, with the <var>x</var>-coordinate increasing to the right, and the <var>y</var>-coordinate
   increasing down, and with each pixel in the <var>input</var> image data occupying a cell
   on the plane's grid.</p></li>

   <li>

    <p>Let <var>output</var> be the rectangle on the plane denoted by the rectangle whose
    corners are the four points (<var>sx</var>, <var>sy</var>), (<span
   ><var>sx</var>+<var>sw</var></span>, <var>sy</var>), (<span
   ><var>sx</var>+<var>sw</var></span>, <span><var>sy</var>+<var>sh</var></span>), (<var>sx</var>, <span><var>sy</var>+<var>sh</var></span>).</p>

    <p class="note">If either <var>sw</var> or <var>sh</var> are negative, then
    the top-left corner of this rectangle will be to the left or above the (<var>sx</var>,
    <var>sy</var>) point. If any of the pixels on this rectangle are outside the area where
    the <var>input</var> bitmap was placed, then they will be transparent black in <var>output</var>.</p>

   </li>

   <li><p>Return <var>output</var>.</p></li>

  </ol>

  <p>The <dfn><code data-x="dom-ImageBitmap-width">width</code></dfn> attribute must return the
  <code>ImageBitmap</code> object's width, in CSS pixels.</p>

  <p>The <dfn><code data-x="dom-ImageBitmap-height">height</code></dfn> attribute must return the
  <code>ImageBitmap</code> object's height, in CSS pixels.</p>

  </div>

  <div class="example">

   <p>Using this API, a sprite sheet can be precut and prepared:</p>

   <pre>var sprites = {};
function loadMySprites() {
  var image = new Image();
  image.src = 'mysprites.png';
  var resolver;
  var promise = new Promise(function (arg) { resolver = arg });
  image.onload = function () {
    resolver(Promise.all(
      createImageBitmap(image,  0,  0, 40, 40).then(function (image) { sprites.woman = image }),
      createImageBitmap(image, 40,  0, 40, 40).then(function (image) { sprites.man   = image }),
      createImageBitmap(image, 80,  0, 40, 40).then(function (image) { sprites.tree  = image }),
      createImageBitmap(image,  0, 40, 40, 40).then(function (image) { sprites.hut   = image }),
      createImageBitmap(image, 40, 40, 40, 40).then(function (image) { sprites.apple = image }),
      createImageBitmap(image, 80, 40, 40, 40).then(function (image) { sprites.snake = image }),
    ));
  };
  return promise;
}

function runDemo() {
  var canvas = document.querySelector('canvas#demo');
  var context = canvas.getContext('2d');
  context.drawImage(sprites.tree, 30, 10);
  context.drawImage(sprites.snake, 70, 10);
}

loadMySprites().then(runDemo);</pre>

  </div>

<!--TOPIC:HTML Syntax and Parsing-->

  <h2 id="syntax">The HTML syntax</h2>

  <p class="note">This section only describes the rules for resources labeled with an <span>HTML
  MIME type</span>. Rules for XML resources are discussed in the section below entitled "<span>The
  XHTML syntax</span>".</p>


  <h3 id="writing">Writing HTML documents</h3>

  <div class="impl">

  <p><i>This section only applies to documents, authoring tools, and markup generators. In
  particular, it does not apply to conformance checkers; conformance checkers must use the
  requirements given in the next section ("parsing HTML documents").</i></p>

  </div>

  <p>Documents must consist of the following parts, in the given
  order:</p>

  <ol>

   <li>Optionally, a single U+FEFF BYTE ORDER MARK (BOM) character.</li>

   <li>Any number of <span data-x="syntax-comments">comments</span> and <span data-x="space
   character">space characters</span>.</li>

   <li>A <span data-x="syntax-doctype">DOCTYPE</span>.

   <li>Any number of <span data-x="syntax-comments">comments</span> and <span data-x="space
   character">space characters</span>.</li>

   <li>The root element, in the form of an <code>html</code> <span
   data-x="syntax-elements">element</span>.</li>

   <li>Any number of <span data-x="syntax-comments">comments</span> and <span data-x="space
   character">space characters</span>.</li>

  </ol>

  <p>The various types of content mentioned above are described in the next few sections.</p>

  <p>In addition, there are some restrictions on how <span data-x="character encoding
  declaration">character encoding declarations</span> are to be serialized, as discussed in the
  section on that topic.</p>

  <div class="note">

   <p>Space characters before the root <code>html</code> element, and space characters at the start
   of the <code>html</code> element and before the <code>head</code> element, will be dropped when
   the document is parsed; space characters <em>after</em> the root <code>html</code> element will
   be parsed as if they were at the end of the <code>body</code> element. Thus, space characters
   around the root element do not round-trip.</p>

   <p>It is suggested that newlines be inserted after the DOCTYPE, after any comments that are
   before the root element, after the <code>html</code> element's start tag (if it is not <span
   data-x="syntax-tag-omission">omitted</span>), and after any comments that are inside the
   <code>html</code> element but before the <code>head</code> element.</p>

  </div>

  <p>Many strings in the HTML syntax (e.g. the names of elements and their attributes) are
  case-insensitive, but only for <span>uppercase ASCII letters</span> and <span>lowercase ASCII
  letters</span>. For convenience, in this section this is just referred to as
  "case-insensitive".</p>


  <h4 id="the-doctype">The DOCTYPE</h4>

  <p>A <dfn data-x="syntax-doctype">DOCTYPE</dfn> is a <!-- mostly useless but nonetheless -->
  required preamble.</p>

  <p class="note">DOCTYPEs are required for legacy reasons. When omitted, browsers tend to use a
  different rendering mode that is incompatible with some specifications. Including the DOCTYPE in a
  document ensures that the browser makes a best-effort attempt at following the relevant
  specifications.</p>

  <p>A DOCTYPE must consist of the following components, in this order:</p>

  <ol class="brief">
   <li>A string that is an <span>ASCII case-insensitive</span> match for the string "<code>&lt;!DOCTYPE</code>".</li>
   <li>One or more <span data-x="space character">space characters</span>.</li>
   <li>A string that is an <span>ASCII case-insensitive</span> match for the string "<code>html</code>".</li>
   <li>Optionally, a <span>DOCTYPE legacy string</span> or an <span>obsolete permitted DOCTYPE string</span> (defined below).</li>
   <li>Zero or more <span data-x="space character">space characters</span>.</li>
   <li>A U+003E GREATER-THAN SIGN character (&gt;).</li>
  </ol>

  <p class="note">In other words, <code>&lt;!DOCTYPE html></code>, case-insensitively.</p>

  <hr>

  <p>For the purposes of HTML generators that cannot output HTML markup with the short DOCTYPE
  "<code>&lt;!DOCTYPE html></code>", a <dfn>DOCTYPE legacy string</dfn> may be inserted
  into the DOCTYPE (in the position defined above). This string must consist of:</p>

  <ol class="brief">
   <li>One or more <span data-x="space character">space characters</span>.</li>
   <li>A string that is an <span>ASCII case-insensitive</span> match for the string "<code>SYSTEM</code>".</li>
   <li>One or more <span data-x="space character">space characters</span>.</li>
   <li>A U+0022 QUOTATION MARK or U+0027 APOSTROPHE character (the <i>quote mark</i>).</li>
   <li>The literal string "<code>about:legacy-compat</code>".</li>
   <li>A matching U+0022 QUOTATION MARK or U+0027 APOSTROPHE character (i.e. the same character as in the earlier step labeled <i>quote mark</i>).</li>
  </ol>

  <p class="note">In other words, <code>&lt;!DOCTYPE html SYSTEM "about:legacy-compat"></code> or
  <code>&lt;!DOCTYPE html SYSTEM 'about:legacy-compat'></code>, case-insensitively except for the
  part in single or double quotes.</p>

  <p>The <span>DOCTYPE legacy string</span> should not be used unless the document is generated from
  a system that cannot output the shorter string.</p>

  <hr>

  <!-- see the parser section before changing this bit -->

  <p>To help authors transition from HTML4 and XHTML1, an <dfn>obsolete permitted DOCTYPE
  string</dfn> can be inserted into the DOCTYPE (in the position defined above). This string must
  consist of:</p>

  <ol class="brief">
   <li>One or more <span data-x="space character">space characters</span>.</li>
   <li>A string that is an <span>ASCII case-insensitive</span> match for the string "<code>PUBLIC</code>".</li>
   <li>One or more <span data-x="space character">space characters</span>.</li>
   <li>A U+0022 QUOTATION MARK or U+0027 APOSTROPHE character (the <i>first quote mark</i>).</li>
   <li>The string from one of the cells in the first column of the table below. The row to which this cell belongs is the <i>selected row</i>.</li>
   <li>A matching U+0022 QUOTATION MARK or U+0027 APOSTROPHE character (i.e. the same character as in the earlier step labeled <i>first quote mark</i>).</li>
   <!--START FORK-->
   <li>If a system identifier is used,
      <ol>
        <li>One or more <span data-x="space character">space characters</span>.</li>
        <li>A U+0022 QUOTATION MARK or U+0027 APOSTROPHE character (the <i>third quote mark</i>).</li>
        <li>The string from the cell in the second column of the <i>selected row</i>.</li>
        <li>A matching U+0022 QUOTATION MARK or U+0027 APOSTROPHE character (i.e. the same character as in the earlier step labeled <i>third quote mark</i>).</li>
  </ol>
    </li>
    <!--END FORK-->
  </ol>

  <!--START FORK-->
  <table>
   <caption>
    Allowed values for public and system identifiers in an <span>obsolete permitted DOCTYPE string</span>.
   </caption>
   <thead>
    <tr>
     <th> Public identifier
     <th> System identifier
     <th> System identifier optional?
   <tbody>
    <tr>
     <td> <code>-//W3C//DTD&nbsp;HTML&nbsp;4.0//EN</code>
     <td> <code>http://www.w3.org/TR/REC-html40/strict.dtd</code>
     <td> Yes
    <tr>
     <td> <code>-//W3C//DTD&nbsp;HTML&nbsp;4.01//EN</code>
     <td> <code>http://www.w3.org/TR/html4/strict.dtd</code>
     <td> Yes
    <tr>
     <td> <code>-//W3C//DTD&nbsp;XHTML&nbsp;1.0&nbsp;Strict//EN</code>
     <td> <code>http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd</code>
     <td> No
    <tr>
     <td> <code>-//W3C//DTD&nbsp;XHTML&nbsp;1.1//EN</code>
     <td> <code>http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd</code>
     <td> No
  </table>
  <!--END FORK-->
  <p class="auth">A <span data-x="syntax-doctype">DOCTYPE</span> containing an <span>obsolete permitted DOCTYPE
  string</span> is an <dfn>obsolete permitted DOCTYPE</dfn>. Authors should not use <span
  data-x="obsolete permitted DOCTYPE">obsolete permitted DOCTYPEs</span>, as they are unnecessarily
  long.</p>



  <h4 id="elements">Elements</h4>

  <p>There are five different kinds of <dfn data-x="syntax-elements">elements</dfn>: <span>void
  elements</span>, <span>raw text elements</span>, <span>escapable raw text elements</span>,
  <span>foreign elements</span>, and <span>normal elements</span>.</p>

  <dl>

   <dt><dfn>Void elements</dfn></dt>

   <dd><code>area</code>, <code>base</code>, <code>br</code>, <code>col</code>, <code>embed</code>,
   <code>hr</code>, <code>img</code>, <code>input</code>, <code>keygen</code>, <code>link</code>,
   <code>menuitem</code>, <code>meta</code>, <code>param</code>, <code>source</code>,
   <code>track</code>, <code>wbr</code></dd>
   <!-- see also other places that say VOIDLIST -->

   <dt><dfn>Raw text elements</dfn></dt>

   <dd><code>script</code>, <code>style</code></dd> <!-- iframe and noscript don't count as raw text
   for syntax purposes -->

   <dt><dfn>escapable raw text elements</dfn></dt>

   <dd><code>textarea</code>, <code>title</code></dd>

   <dt><dfn>Foreign elements</dfn></dt>

   <dd>Elements from the <span>MathML namespace</span> and the <span>SVG namespace</span>.</dd>

   <dt><dfn>Normal elements</dfn></dt>

   <dd>All other allowed <span>HTML elements</span> are normal elements.</dd>

  </dl>

  <p><dfn data-x="syntax-tags">Tags</dfn> are used to delimit the start and end of elements in the
  markup. <span data-x="raw text elements">Raw text</span>, <span data-x="escapable raw text
  elements">escapable raw text</span>, and <span data-x="normal elements">normal</span> elements have
  a <span data-x="syntax-start-tag">start tag</span> to indicate where they begin, and an <span
  data-x="syntax-end-tag">end tag</span> to indicate where they end. The start and end tags of
  certain <span>normal elements</span> can be <span data-x="syntax-tag-omission">omitted</span>, as
  described below in the section on <span data-x="syntax-tag-omission">optional tags</span>. Those
  that cannot be omitted must not be omitted. <span>Void elements</span> only have a start tag; end
  tags must not be specified for <span>void elements</span>. <span>Foreign elements</span> must
  either have a start tag and an end tag, or a start tag that is marked as self-closing, in which
  case they must not have an end tag.</p>

  <p>The <span data-x="concept-html-contents">contents</span> of the element must be placed between
  just after the start tag (which <span data-x="syntax-tag-omission">might be implied, in certain
  cases</span>) and just before the end tag (which again, <span data-x="syntax-tag-omission">might be
  implied in certain cases</span>). The exact allowed contents of each individual element depend on
  the <span data-x="content models">content model</span> of that element, as described earlier in
  this specification. Elements must not contain content that their content model disallows. In
  addition to the restrictions placed on the contents by those content models, however, the five
  types of elements have additional <em>syntactic</em> requirements.</p>

  <p><span>Void elements</span> can't have any contents (since there's no end tag, no content can be
  put between the start tag and the end tag).</p>

  <p><span>Raw text elements</span> can have <span data-x="syntax-text">text</span>, though it has <a
  href="#cdata-rcdata-restrictions">restrictions</a> described below.</p>

  <p><span>Escapable raw text elements</span> can have <span data-x="syntax-text">text</span> and
  <span data-x="syntax-charref">character references</span>, but the text must not contain an <span
  data-x="syntax-ambiguous-ampersand">ambiguous ampersand</span>. There are also <a
  href="#cdata-rcdata-restrictions">further restrictions</a> described below.</p>

  <p><span>Foreign elements</span> whose start tag is marked as self-closing can't have any contents
  (since, again, as there's no end tag, no content can be put between the start tag and the end
  tag). <span>Foreign elements</span> whose start tag is <em>not</em> marked as self-closing can
  have <span data-x="syntax-text">text</span>, <span data-x="syntax-charref">character
  references</span>, <span data-x="syntax-cdata">CDATA sections</span>, other <span
  data-x="syntax-elements">elements</span>, and <span data-x="syntax-comments">comments</span>, but
  the text must not contain the character U+003C LESS-THAN SIGN (&lt;) or an <span
  data-x="syntax-ambiguous-ampersand">ambiguous ampersand</span>.</p>

  <div class="note">

   <p>The HTML syntax does not support namespace declarations, even in <span>foreign
   elements</span>.</p>

   <p>For instance, consider the following HTML fragment:</p>

   <pre>&lt;p>
 &lt;svg>
  &lt;metadata>
   &lt;!-- this is invalid -->
   &lt;cdr:license xmlns:cdr="http://www.example.com/cdr/metadata" name="MIT"/>
  &lt;/metadata>
 &lt;/svg>
&lt;/p></pre>

   <p>The innermost element, <code>cdr:license</code>, is actually in the SVG namespace, as
   the "<code>xmlns:cdr</code>" attribute has no effect (unlike in XML). In fact, as the
   comment in the fragment above says, the fragment is actually non-conforming. This is because the
   SVG specification does not define any elements called "<code>cdr:license</code>" in the
   SVG namespace.</p>

  </div>

  <p><span>Normal elements</span> can have <span data-x="syntax-text">text</span>, <span
  data-x="syntax-charref">character references</span>, other <span
  data-x="syntax-elements">elements</span>, and <span data-x="syntax-comments">comments</span>, but
  the text must not contain the character U+003C LESS-THAN SIGN (&lt;) or an <span
  data-x="syntax-ambiguous-ampersand">ambiguous ampersand</span>. Some <span>normal elements</span>
  also have <a href="#element-restrictions">yet more restrictions</a> on what content they are
  allowed to hold, beyond the restrictions imposed by the content model and those described in this
  paragraph. Those restrictions are described below.</p>

  <p>Tags contain a <dfn data-x="syntax-tag-name">tag name</dfn>, giving the element's name. HTML
  elements all have names that only use <span>alphanumeric ASCII characters</span>. In the HTML
  syntax, tag names, even those for <span>foreign elements</span>, may be written with any mix of
  lower- and uppercase letters that, when converted to all-lowercase, matches the element's tag
  name; tag names are case-insensitive.</p>


  <h5 id="start-tags">Start tags</h5>

  <p><dfn data-x="syntax-start-tag">Start tags</dfn> must have the following format:</p>

  <ol>

   <li>The first character of a start tag must be a U+003C LESS-THAN SIGN character (&lt;).</li>

   <li>The next few characters of a start tag must be the element's <span
   data-x="syntax-tag-name">tag name</span>.</li>

   <li>If there are to be any attributes in the next step, there must first be one or more <span
   data-x="space character">space characters</span>.</li>

   <li>Then, the start tag may have a number of attributes, the <span
   data-x="syntax-attributes">syntax for which</span> is described below. Attributes must be
   separated from each other by one or more <span data-x="space character">space
   characters</span>.</li>

   <li>After the attributes, or after the <span data-x="syntax-tag-name">tag name</span> if there are
   no attributes, there may be one or more <span data-x="space character">space characters</span>.
   (Some attributes are required to be followed by a space. See the <span
   data-x="syntax-attributes">attributes section</span> below.)</li>

   <li>Then, if the element is one of the <span>void elements</span>, or if the element is a <span
   data-x="foreign elements">foreign element</span>, then there may be a single U+002F SOLIDUS
   character (/). This character has no effect on <span>void elements</span>, but on <span>foreign
   elements</span> it marks the start tag as self-closing.</li>

   <li>Finally, start tags must be closed by a U+003E GREATER-THAN SIGN character (&gt;).</li>

  </ol>


  <h5 id="end-tags">End tags</h5>

  <p><dfn data-x="syntax-end-tag">End tags</dfn> must have the following format:</p>

  <ol>

   <li>The first character of an end tag must be a U+003C LESS-THAN SIGN character (&lt;).</li>

   <li>The second character of an end tag must be a U+002F SOLIDUS character (/).</li>

   <li>The next few characters of an end tag must be the element's <span data-x="syntax-tag-name">tag
   name</span>.</li>

   <li>After the tag name, there may be one or more <span data-x="space character">space
   characters</span>.</li>

   <li>Finally, end tags must be closed by a U+003E GREATER-THAN SIGN character (&gt;).</li>

  </ol>


  <h5 id="attributes">Attributes</h5>

  <p><dfn data-x="syntax-attributes">Attributes</dfn> for an element are expressed inside the
  element's start tag.</p>

  <p>Attributes have a name and a value. <dfn data-x="syntax-attribute-name">Attribute names</dfn>
  must consist of one or more characters other than the <span data-x="space character">space
  characters</span>, U+0000 NULL, U+0022 QUOTATION MARK (&#x22;), U+0027 APOSTROPHE (&#x27;), U+003E
  GREATER-THAN SIGN (&gt;), U+002F SOLIDUS (/), and U+003D EQUALS SIGN (=) characters, the <span>control
  characters</span>, and any characters that are not defined by Unicode. In the HTML syntax, attribute
  names, even those for <span>foreign elements</span>, may be written with any mix of lower- and
  uppercase letters that are an <span>ASCII case-insensitive</span> match for the attribute's
  name.</p>

  <p><dfn data-x="syntax-attribute-value">Attribute values</dfn> are a mixture of <span
  data-x="syntax-text">text</span> and <span data-x="syntax-charref">character references</span>,
  except with the additional restriction that the text cannot contain an <span
  data-x="syntax-ambiguous-ampersand">ambiguous ampersand</span>.</p>

  <p>Attributes can be specified in four different ways:</p>

  <dl>

   <dt>Empty attribute syntax</dt>

   <dd>

    <p>Just the <span data-x="syntax-attribute-name">attribute name</span>. The value is implicitly
    the empty string.</p>

    <div class="example">

     <p>In the following example, the <code data-x="attr-fe-disabled">disabled</code> attribute is
     given with the empty attribute syntax:</p>

     <pre>&lt;input <em>disabled</em>&gt;</pre>

    </div>

    <p>If an attribute using the empty attribute syntax is to be followed by another attribute, then
    there must be a <span>space character</span> separating the two.</p>

   </dd>

   <dt id="unquoted">Unquoted attribute value syntax</dt>

   <dd>

    <p>The <span data-x="syntax-attribute-name">attribute name</span>, followed by zero or more <span
    data-x="space character">space characters</span>, followed by a single U+003D EQUALS SIGN
    character, followed by zero or more <span data-x="space character">space characters</span>,
    followed by the <span data-x="syntax-attribute-value">attribute value</span>, which, in addition
    to the requirements given above for attribute values, must not contain any literal <span
    data-x="space character">space characters</span>, any U+0022 QUOTATION MARK characters (&#x22;),
    U+0027 APOSTROPHE characters (&#x27;), U+003D EQUALS SIGN characters (=), U+003C LESS-THAN SIGN
    characters (&lt;), U+003E GREATER-THAN SIGN characters (&gt;), or U+0060 GRAVE ACCENT characters
    (`), and must not be the empty string.</p>

    <!-- The ` character is in this list on a temporary basis, waiting for IE to fix its parsing bug
         whereby it treats ` as an attribute value delimiter. Otherwise, escaping software that
         tries to be clever and not use quotes when it doesn't need to could be tricked by an
         attacker.

         Posit a site that allows the user to input text that is used verbatim in two attributes,
         such that the user can set the first attribute's value to:

            `

         ...and the second to:

            ` onload='...payload...' end=x

         ...with the assumption that the site is going to not quote the first one, and quote the
         second one with double quotes:

            <body data-x=` class="` onload='...payload...' end=x">

         In IE, this is treated as:

            <body data-x=' class="'
                  onload='...payload...'
                  end='x"'>

    -->


    <div class="example">

     <p>In the following example, the <code data-x="attr-input-value">value</code> attribute is given
     with the unquoted attribute value syntax:</p>

     <pre>&lt;input <em>value=yes</em>&gt;</pre>

    </div>

    <p>If an attribute using the unquoted attribute syntax is to be followed by another attribute or
    by the optional U+002F SOLIDUS character (/) allowed in step 6 of the <span
    data-x="syntax-start-tag">start tag</span> syntax above, then there must be a <span>space
    character</span> separating the two.</p>

   </dd>

   <dt>Single-quoted attribute value syntax</dt>

   <dd>

    <p>The <span data-x="syntax-attribute-name">attribute name</span>, followed by zero or more <span
    data-x="space character">space characters</span>, followed by a single U+003D EQUALS SIGN
    character, followed by zero or more <span data-x="space character">space characters</span>,
    followed by a single U+0027 APOSTROPHE character ('), followed by the <span
    data-x="syntax-attribute-value">attribute value</span>, which, in addition to the requirements
    given above for attribute values, must not contain any literal U+0027 APOSTROPHE characters ('),
    and finally followed by a second single U+0027 APOSTROPHE character (').</p>

    <div class="example">

     <p>In the following example, the <code data-x="attr-input-type">type</code> attribute is given
     with the single-quoted attribute value syntax:</p>

     <pre>&lt;input <em>type='checkbox'</em>&gt;</pre>

    </div>

    <p>If an attribute using the single-quoted attribute syntax is to be followed by another
    attribute, then there must be a <span>space character</span> separating the two.</p>

   </dd>

   <dt>Double-quoted attribute value syntax</dt>

   <dd>

    <p>The <span data-x="syntax-attribute-name">attribute name</span>, followed by zero or more <span
    data-x="space character">space characters</span>, followed by a single U+003D EQUALS SIGN
    character, followed by zero or more <span data-x="space character">space characters</span>,
    followed by a single U+0022 QUOTATION MARK character ("), followed by the <span
    data-x="syntax-attribute-value">attribute value</span>, which, in addition to the requirements
    given above for attribute values, must not contain any literal U+0022 QUOTATION MARK characters
    ("), and finally followed by a second single U+0022 QUOTATION MARK character (").</p>

    <div class="example">

     <p>In the following example, the <code data-x="attr-fe-name">name</code> attribute is given with
     the double-quoted attribute value syntax:</p>

     <pre>&lt;input <em>name="be evil"</em>&gt;</pre>

    </div>

    <p>If an attribute using the double-quoted attribute syntax is to be followed by another
    attribute, then there must be a <span>space character</span> separating the two.</p>

   </dd>

  </dl>

  <p>There must never be two or more attributes on the same start tag whose names are an <span>ASCII
  case-insensitive</span> match for each other.</p>

  <hr>

  <p>When a <span data-x="foreign elements">foreign element</span> has one of the namespaced
  attributes given by the local name and namespace of the first and second cells of a row from the
  following table, it must be written using the name given by the third cell from the same row.</p>

  <table>
   <thead>
    <tr> <th> Local name <th> Namespace <th> Attribute name
   <tbody>
    <tr> <td> <code>actuate</code> <td> <span>XLink namespace</span> <td> <code>xlink:actuate</code>
    <tr> <td> <code>arcrole</code> <td> <span>XLink namespace</span> <td> <code>xlink:arcrole</code>
    <tr> <td> <code>href</code> <td> <span>XLink namespace</span> <td> <code>xlink:href</code>
    <tr> <td> <code>role</code> <td> <span>XLink namespace</span> <td> <code>xlink:role</code>
    <tr> <td> <code>show</code> <td> <span>XLink namespace</span> <td> <code>xlink:show</code>
    <tr> <td> <code>title</code> <td> <span>XLink namespace</span> <td> <code>xlink:title</code>
    <tr> <td> <code>type</code> <td> <span>XLink namespace</span> <td> <code>xlink:type</code>
    <tr> <td> <code>base</code> <td> <span>XML namespace</span> <!-- attr-xml-base --> <td> <code>xml:base</code>
    <tr> <td> <code>lang</code> <td> <span>XML namespace</span> <td> <code>xml:lang</code>
    <tr> <td> <code>space</code> <td> <span>XML namespace</span> <td> <code>xml:space</code>
    <tr> <td> <code>xmlns</code> <td> <span>XMLNS namespace</span> <td> <code>xmlns</code>
    <tr> <td> <code>xlink</code> <td> <span>XMLNS namespace</span> <td> <code>xmlns:xlink</code>
  </table>

  <p>No other namespaced attribute can be expressed in <span>the HTML syntax</span>.</p>

  <p class="note">Whether the attributes in the table above are conforming or not is defined by
  other specifications (e.g. the SVG and MathML specifications); this section only describes the
  syntax rules if the attributes are serialized using the HTML syntax.</p>


  <h5 id="optional-tags">Optional tags</h5>

  <p>Certain tags can be <dfn data-x="syntax-tag-omission">omitted</dfn>.</p>

  <p class="note">Omitting an element's <span data-x="syntax-start-tag">start tag</span> in the
  situations described below does not mean the element is not present; it is implied, but it is
  still there. For example, an HTML document always has a root <code>html</code> element, even if
  the string <code>&lt;html></code> doesn't appear anywhere in the markup.</p>

  <!-- <html> -->
  <p>An <code>html</code> element's <span data-x="syntax-start-tag">start tag</span> may be omitted
  if the first thing inside the <code>html</code> element is not a <span
  data-x="syntax-comments">comment</span>.</p>

  <div class="example">

   <p>For example, in the following case it's ok to remove the "<code>&lt;html></code>"
   tag:</p>

   <pre>&lt;!DOCTYPE HTML>
<strong>&lt;html></strong>
  &lt;head>
    &lt;title>Hello&lt;/title>
  &lt;/head>
  &lt;body>
    &lt;p>Welcome to this example.&lt;/p>
  &lt;/body>
&lt;/html></pre>

   <p>Doing so would make the document look like this:</p>

   <pre>&lt;!DOCTYPE HTML>

  &lt;head>
    &lt;title>Hello&lt;/title>
  &lt;/head>
  &lt;body>
    &lt;p>Welcome to this example.&lt;/p>
  &lt;/body>
&lt;/html></pre>

   <p>This has the exact same DOM. In particular, note that white space around the root element is
   ignored by the parser. The following example would also have the exact same DOM:</p>

   <pre>&lt;!DOCTYPE HTML>&lt;head>
    &lt;title>Hello&lt;/title>
  &lt;/head>
  &lt;body>
    &lt;p>Welcome to this example.&lt;/p>
  &lt;/body>
&lt;/html></pre>

   <p>However, in the following example, removing the start tag moves the comment to before the
   <code>html</code> element:</p>

   <pre>&lt;!DOCTYPE HTML>
&lt;html>
  <strong>&lt;!-- where is this comment in the DOM? --></strong>
  &lt;head>
    &lt;title>Hello&lt;/title>
  &lt;/head>
  &lt;body>
    &lt;p>Welcome to this example.&lt;/p>
  &lt;/body>
&lt;/html></pre>

   <p>With the tag removed, the document actually turns into the same as this:</p>

   <pre>&lt;!DOCTYPE HTML>
&lt;!-- where is this comment in the DOM? -->
<small>&lt;html></small>
  &lt;head>
    &lt;title>Hello&lt;/title>
  &lt;/head>
  &lt;body>
    &lt;p>Welcome to this example.&lt;/p>
  &lt;/body>
&lt;/html></pre>

   <p>This is why the tag can only be removed if it is not followed by a comment: removing the tag
   when there is a comment there changes the document's resulting parse tree. Of course, if the
   position of the comment does not matter, then the tag can be omitted, as if the comment had been
   moved to before the start tag in the first place.</p>

  </div>

  <!-- </html> -->
  <p>An <code>html</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if
  the <code>html</code> element is not immediately followed by a <span
  data-x="syntax-comments">comment</span>.</p>

  <!-- <head> -->
  <p>A <code>head</code> element's <span data-x="syntax-start-tag">start tag</span> may be omitted if
  the element is empty, or if the first thing inside the <code>head</code> element is an
  element.</p>

  <!-- </head> -->
  <p>A <code>head</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if the
  <code>head</code> element is not immediately followed by a <span>space character</span> or a <span
  data-x="syntax-comments">comment</span>.</p>

  <!-- <body> -->
  <p>A <code>body</code> element's <span data-x="syntax-start-tag">start tag</span> may be omitted
  if the element is empty, or if the first thing inside the <code>body</code> element is not a
  <span>space character</span> or a <span data-x="syntax-comments">comment</span>, except if the
  first thing inside the <code>body</code> element is a <code>meta</code>, <code>link</code>,
  <code>script</code>, <code>style</code>, or <code>template</code> element. <!-- Note that even if
  the </head> end tag is present, the parser makes <style> and <script> elements between </head> and
  <body> end up in the <head> instead of implying the <body> --></p>

  <!-- </body> -->
  <p>A <code>body</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if the
  <code>body</code> element is not immediately followed by a <span
  data-x="syntax-comments">comment</span>.</p>

  <div class="example">

   <p>Note that in the example above, the <code>head</code> element start and end tags, and the
   <code>body</code> element start tag, can't be omitted, because they are surrounded by white
   space:</p>

   <pre>&lt;!DOCTYPE HTML>
&lt;html><strong>
  </strong>&lt;head><strong>
    </strong>&lt;title>Hello&lt;/title><strong>
  </strong>&lt;/head><strong>
  </strong>&lt;body><strong>
    </strong>&lt;p>Welcome to this example.&lt;/p>
  &lt;/body>
&lt;/html></pre>

   <p>(The <code>body</code> and <code>html</code> element end tags could be omitted without
   trouble; any spaces after those get parsed into the <code>body</code> element anyway.)</p>

   <p>Usually, however, white space isn't an issue. If we first remove the white space we don't care
   about:</p>

   <pre>&lt;!DOCTYPE HTML>&lt;html>&lt;head>&lt;title>Hello&lt;/title>&lt;/head>&lt;body>&lt;p>Welcome to this example.&lt;/p>&lt;/body>&lt;/html></pre>

   <p>Then we can omit a number of tags without affecting the DOM:</p>

   <pre>&lt;!DOCTYPE HTML>&lt;title>Hello&lt;/title>&lt;p>Welcome to this example.&lt;/p></pre>

   <p>At that point, we can also add some white space back:</p>

   <pre>&lt;!DOCTYPE HTML>
&lt;title>Hello&lt;/title>
&lt;p>Welcome to this example.&lt;/p></pre>

   <p>This would be equivalent to this document, with the omitted tags shown in their
   parser-implied positions; the only white space text node that results from this is the newline at
   the end of the <code>head</code> element:</p>

   <pre>&lt;!DOCTYPE HTML>
<small>&lt;html>&lt;head></small>&lt;title>Hello&lt;/title>
<small>&lt;/head>&lt;body></small>&lt;p>Welcome to this example.&lt;/p><small>&lt;/body>&lt;/html></small></pre>

  </div>

  <!-- </li> -->
  <p>An <code>li</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if the
  <code>li</code> element is immediately followed by another <code>li</code> element or if there is
  no more content in the parent element.</p>

  <!-- </dt> -->
  <p>A <code>dt</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if the
  <code>dt</code> element is immediately followed by another <code>dt</code> element or a
  <code>dd</code> element.</p>

  <!-- </dd> -->
  <p>A <code>dd</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if the
  <code>dd</code> element is immediately followed by another <code>dd</code> element or a
  <code>dt</code> element, or if there is no more content in the parent element.</p>

  <!-- </p> -->
  <p>A <code>p</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if the
  <code>p</code> element is immediately followed by an <code>address</code>, <code>article</code>,
  <code>aside</code>, <code>blockquote</code>, <code>details</code>, <code>div</code>, <code>dl</code>,
  <code>fieldset</code>, <code>figcaption</code>, <code>figure</code>, <code>footer</code>, <code>form</code>, <code>h1</code>, <code>h2</code>,
  <code>h3</code>, <code>h4</code>, <code>h5</code>, <code>h6</code>, <code>header</code>,
  <code>hr</code>, <code>main</code>, <code>menu</code>, <code>nav</code>,
  <code>ol</code>, <code>p</code>, <code>pre</code>, <code>section</code>, <code>table</code>, or
  <code>ul</code> element, or if there is no more content in the parent element and the parent
  element is an <span data-x="HTML elements">HTML element</span> that is not an <code>a</code>, <code>audio</code>, <code>del</code>,
  <code>ins</code>, <code>map</code>, <code>noscript</code>, or <code>video</code> element.</p>

  <div class="example">

   <p>We can thus simplify the earlier example further:

   <pre>&lt;!DOCTYPE HTML>&lt;title>Hello&lt;/title>&lt;p>Welcome to this example.<small>&lt;/p></small></pre>

  </div>

  <!-- </rt> -->
  <p>An <code>rt</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if the
  <code>rt</code> element is immediately followed by an <code>rt</code> or <code>rp</code> element,
  or if there is no more content in the parent element.</p>

  <!-- </rp> -->
  <p>An <code>rp</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if the
  <code>rp</code> element is immediately followed by an <code>rt</code> or <code>rp</code> element,
  or if there is no more content in the parent element.</p>

  <!-- </optgroup> (the text assumes <optgroup> can only be inside a <select>; commented out text
  below can handle the non-<select> case if we ever allow it) -->
  <p>An <code>optgroup</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted
  if the <code>optgroup</code> element <!--has an ancestor <code>select</code> element and--> is
  immediately followed by another <code>optgroup</code> element, or if <!--all of the elements that
  are ancestors of the <code>optgroup</code> element, up to and including the first ancestor element
  that is not an <code>optgroup</code> element, have no more content--> there is no more content in
  the parent element.</p>
  <!-- so e.g. the max number of </optgroup>s are omitted here:
   <select><optgroup></select>
   <p id=x><optgroup></optgroup>x</p>
   <p id=x><optgroup><optgroup></optgroup></optgroup>x</p>
   <p><optgroup id=x><optgroup></optgroup>x</p>
   <p><optgroup><optgroup id=x>x</p>
  -->

  <!-- </option> -->
  <p>An <code>option</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if
  the <code>option</code> element is immediately followed by another <code>option</code> element, or
  if it is immediately followed by an <code>optgroup</code> element, or if there is no more content
  in the parent element.</p>

  <!-- <colgroup> -->
  <p>A <code>colgroup</code> element's <span data-x="syntax-start-tag">start tag</span> may be
  omitted if the first thing inside the <code>colgroup</code> element is a <code>col</code> element,
  and if the element is not immediately preceded by another <code>colgroup</code> element whose
  <span data-x="syntax-end-tag">end tag</span> has been omitted. (It can't be omitted if the element
  is empty.)</p>

  <!-- </colgroup> -->
  <p>A <code>colgroup</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if
  the <code>colgroup</code> element is not immediately followed by a <span>space character</span> or
  a <span data-x="syntax-comments">comment</span>.</p>

  <!-- </caption> -->
  <p>A <code>caption</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if
  the <code>caption</code> element is not immediately followed by a <span>space character</span> or
  a <span data-x="syntax-comments">comment</span>.</p>

  <!-- </thead> -->
  <p>A <code>thead</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if
  the <code>thead</code> element is immediately followed by a <code>tbody</code> or
  <code>tfoot</code> element.</p>

  <!-- <tbody> -->
  <p>A <code>tbody</code> element's <span data-x="syntax-start-tag">start tag</span> may be omitted
  if the first thing inside the <code>tbody</code> element is a <code>tr</code> element, and if the
  element is not immediately preceded by a <code>tbody</code>, <code>thead</code>, or
  <code>tfoot</code> element whose <span data-x="syntax-end-tag">end tag</span> has been omitted. (It
  can't be omitted if the element is empty.)</p>

  <!-- </tbody> -->
  <p>A <code>tbody</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if
  the <code>tbody</code> element is immediately followed by a <code>tbody</code> or
  <code>tfoot</code> element, or if there is no more content in the parent element.</p>

  <!-- </tfoot> -->
  <p>A <code>tfoot</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if
  the <code>tfoot</code> element is immediately followed by a <code>tbody</code> element, or if
  there is no more content in the parent element.</p>

  <!-- </tr> -->
  <p>A <code>tr</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if the
  <code>tr</code> element is immediately followed by another <code>tr</code> element, or if there is
  no more content in the parent element.</p>

  <!-- </td> -->
  <p>A <code>td</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if the
  <code>td</code> element is immediately followed by a <code>td</code> or <code>th</code> element,
  or if there is no more content in the parent element.</p>

  <!-- </th> -->
  <p>A <code>th</code> element's <span data-x="syntax-end-tag">end tag</span> may be omitted if the
  <code>th</code> element is immediately followed by a <code>td</code> or <code>th</code> element,
  or if there is no more content in the parent element.</p>

  <div class="example">

   <p>The ability to omit all these table-related tags makes table markup much terser.</p>

   <p>Take this example:</p>

   <pre>&lt;table>
 &lt;caption>37547 TEE Electric Powered Rail Car Train Functions (Abbreviated)&lt;/caption>
 &lt;colgroup>&lt;col>&lt;col>&lt;col>&lt;/colgroup>
 &lt;thead>
  &lt;tr>
   &lt;th>Function&lt;/th>
   &lt;th>Control Unit&lt;/th>
   &lt;th>Central Station&lt;/th>
  &lt;/tr>
 &lt;/thead>
 &lt;tbody>
  &lt;tr>
   &lt;td>Headlights&lt;/td>
   &lt;td>&#x2714;&lt;/td>
   &lt;td>&#x2714;&lt;/td>
  &lt;/tr>
  &lt;tr>
   &lt;td>Interior Lights&lt;/td>
   &lt;td>&#x2714;&lt;/td>
   &lt;td>&#x2714;&lt;/td>
  &lt;/tr>
  &lt;tr>
   &lt;td>Electric locomotive operating sounds&lt;/td>
   &lt;td>&#x2714;&lt;/td>
   &lt;td>&#x2714;&lt;/td>
  &lt;/tr>
  &lt;tr>
   &lt;td>Engineer's cab lighting&lt;/td>
   &lt;td>&lt;/td>
   &lt;td>&#x2714;&lt;/td>
  &lt;/tr>
  &lt;tr>
   &lt;td>Station Announcements - Swiss&lt;/td>
   &lt;td>&lt;/td>
   &lt;td>&#x2714;&lt;/td>
  &lt;/tr>
 &lt;/tbody>
&lt;/table></pre>

   <p>The exact same table, modulo some white space differences, could be marked up as follows:</p>

   <pre>&lt;table>
 &lt;caption>37547 TEE Electric Powered Rail Car Train Functions (Abbreviated)
 &lt;colgroup>&lt;col>&lt;col>&lt;col>
 &lt;thead>
  &lt;tr>
   &lt;th>Function
   &lt;th>Control Unit
   &lt;th>Central Station
 &lt;tbody>
  &lt;tr>
   &lt;td>Headlights
   &lt;td>&#x2714;
   &lt;td>&#x2714;
  &lt;tr>
   &lt;td>Interior Lights
   &lt;td>&#x2714;
   &lt;td>&#x2714;
  &lt;tr>
   &lt;td>Electric locomotive operating sounds
   &lt;td>&#x2714;
   &lt;td>&#x2714;
  &lt;tr>
   &lt;td>Engineer's cab lighting
   &lt;td>
   &lt;td>&#x2714;
  &lt;tr>
   &lt;td>Station Announcements - Swiss
   &lt;td>
   &lt;td>&#x2714;
&lt;/table></pre>

   <p>Since the cells take up much less room this way, this can be made even terser by having each
   row on one line:</p>

   <pre>&lt;table>
 &lt;caption>37547 TEE Electric Powered Rail Car Train Functions (Abbreviated)
 &lt;colgroup>&lt;col>&lt;col>&lt;col>
 &lt;thead>
  &lt;tr> &lt;th>Function                              &lt;th>Control Unit     &lt;th>Central Station
 &lt;tbody>
  &lt;tr> &lt;td>Headlights                            &lt;td>&#x2714;                &lt;td>&#x2714;
  &lt;tr> &lt;td>Interior Lights                       &lt;td>&#x2714;                &lt;td>&#x2714;
  &lt;tr> &lt;td>Electric locomotive operating sounds  &lt;td>&#x2714;                &lt;td>&#x2714;
  &lt;tr> &lt;td>Engineer's cab lighting               &lt;td>                 &lt;td>&#x2714;
  &lt;tr> &lt;td>Station Announcements - Swiss         &lt;td>                 &lt;td>&#x2714;
&lt;/table></pre>

   <p>The only differences between these tables, at the DOM level, is with the precise position of
   the (in any case semantically-neutral) white space.</p>

  </div>

  <p><strong>However</strong>, a <span data-x="syntax-start-tag">start tag</span> must never be
  omitted if it has any attributes.</p>

  <div class="example">

   <p>Returning to the earlier example with all the white space removed and then all the optional
   tags removed:</p>

   <pre>&lt;!DOCTYPE HTML>&lt;title>Hello&lt;/title>&lt;p>Welcome to this example.</pre>

   <p>If the <code>body</code> element in this example had to have a <code
   data-x="attr-class">class</code> attribute and the <code>html</code> element had to have a <code
   data-x="attr-lang">lang</code> attribute, the markup would have to become:</p>

   <pre>&lt;!DOCTYPE HTML>&lt;html lang="en">&lt;title>Hello&lt;/title>&lt;body class="demo">&lt;p>Welcome to this example.</pre>

  </div>

  <p class="note">This section assumes that the document is conforming, in particular, that there
  are no <span data-x="content models">content model</span> violations. Omitting tags in the fashion
  described in this section in a document that does not conform to the <span>content models</span>
  described in this specification is likely to result in unexpected DOM differences (this is, in
  part, what the content models are designed to avoid).</p>


  <h5 id="element-restrictions">Restrictions on content models</h5>

  <p>For historical reasons, certain elements have extra restrictions beyond even the restrictions
  given by their content model.</p>

  <p>A <code>table</code> element must not contain <code>tr</code> elements, even though these
  elements are technically allowed inside <code>table</code> elements according to the content
  models described in this specification. (If a <code>tr</code> element is put inside a
  <code>table</code> in the markup, it will in fact imply a <code>tbody</code> start tag before
  it.)</p>

  <p>A single <span data-x="syntax-newlines">newline</span> may be placed immediately after the <span
  data-x="syntax-start-tag">start tag</span> of <code>pre</code> and <code>textarea</code> elements.
  This does not affect the processing of the element. The otherwise optional <span
  data-x="syntax-newlines">newline</span> <em>must</em> be included if the element's contents
  themselves start with a <span data-x="syntax-newlines">newline</span> (because otherwise the
  leading newline in the contents would be treated like the optional newline, and ignored).</p>

  <div class="example">
   <p>The following two <code>pre</code> blocks are equivalent:</p>
   <pre>&lt;pre>Hello&lt;/pre></pre>
   <pre>&lt;pre><br>Hello&lt;/pre></pre>
  </div>


  <h5 id="cdata-rcdata-restrictions">Restrictions on the contents of raw text and escapable raw text elements</h5>

  <p>The text in <span data-x="raw text elements">raw text</span> and <span>escapable raw text
  elements</span> must not contain any occurrences of the string "<code>&lt;/</code>"
  (U+003C LESS-THAN SIGN, U+002F SOLIDUS) followed by characters that case-insensitively match the
  tag name of the element followed by one of U+0009 CHARACTER TABULATION (tab), U+000A LINE FEED
  (LF), U+000C FORM FEED (FF), U+000D CARRIAGE RETURN (CR), U+0020 SPACE, U+003E GREATER-THAN SIGN
  (>), or U+002F SOLIDUS (/).</p>


  <h4 id="text">Text</h4>

  <p><dfn data-x="syntax-text">Text</dfn> is allowed inside elements, attribute values, and comments.
  Extra constraints are placed on what is and what is not allowed in text based on where the text is
  to be put, as described in the other sections.</p>


  <h5 id="newlines">Newlines</h5>

  <p><dfn data-x="syntax-newlines">Newlines</dfn> in HTML may be represented either as U+000D
  CARRIAGE RETURN (CR) characters, U+000A LINE FEED (LF) characters, or pairs of U+000D CARRIAGE
  RETURN (CR), U+000A LINE FEED (LF) characters in that order.</p>

  <p>Where <span data-x="syntax-charref">character references</span> are allowed, a character
  reference of a U+000A LINE FEED (LF) character (but not a U+000D CARRIAGE RETURN (CR) character)
  also represents a <span data-x="syntax-newlines">newline</span>.</p>


  <h4 id="character-references">Character references</h4>

  <p>In certain cases described in other sections, <span data-x="syntax-text">text</span> may be
  mixed with <dfn data-x="syntax-charref">character references</dfn>. These can be used to escape
  characters that couldn't otherwise legally be included in <span
  data-x="syntax-text">text</span>.</p>

  <p>Character references must start with a U+0026 AMPERSAND character (&amp;). Following this,
  there are three possible kinds of character references:</p>

  <dl>

   <dt>Named character references</dt>

   <dd>The ampersand must be followed by one of the names given in the <span>named character
   references</span> section, using the same case. <span class="impl">The name must be one that is
   terminated by a U+003B SEMICOLON character (;).</span></dd>


   <dt>Decimal numeric character reference</dt>

   <dd>The ampersand must be followed by a U+0023 NUMBER SIGN character (#), followed by one or more
   <span>ASCII digits</span>, representing a base-ten integer that corresponds to a Unicode code
   point that is allowed according to the definition below. The digits must then be followed by a
   U+003B SEMICOLON character (;).</dd>


   <dt>Hexadecimal numeric character reference</dt>

   <dd>The ampersand must be followed by a U+0023 NUMBER SIGN character (#), which must be followed
   by either a U+0078 LATIN SMALL LETTER X character (x) or a U+0058 LATIN CAPITAL LETTER X
   character (X), which must then be followed by one or more <span>ASCII hex digits</span>,
   representing a hexadecimal integer that corresponds to a Unicode code point that is allowed
   according to the definition below. The digits must then be followed by a U+003B SEMICOLON
   character (;).</dd>

  </dl>

  <p>The numeric character reference forms described above are allowed to reference any Unicode code
  point other than U+0000, U+000D, permanently undefined Unicode characters (noncharacters),
  surrogates (U+D800&ndash;U+DFFF), and <span>control characters</span> other than <span
  data-x="space character">space characters</span>.</p>

  <p>An <dfn data-x="syntax-ambiguous-ampersand">ambiguous ampersand</dfn> is a U+0026 AMPERSAND
  character (&amp;) that is followed by one or more <span>alphanumeric ASCII characters</span>,
  followed by a U+003B SEMICOLON character (;), where these characters do not match any of the names
  given in the <span>named character references</span> section.</p>


  <h4 id="cdata-sections">CDATA sections</h4>

  <p><dfn data-x="syntax-cdata">CDATA sections</dfn> must consist of the following components, in
  this order:</p>

  <ol>

   <li>The string "<code>&lt;![CDATA[</code>".</li>

   <li>Optionally, <span data-x="syntax-text">text</span>, with the additional restriction that the
   text must not contain the string "<code>]]></code>".</li>

   <li>The string "<code>]]></code>".</li>

  </ol>

  <div class="example">

   <p>CDATA sections can only be used in foreign content (MathML or SVG). In this example, a CDATA
   section is used to escape the contents of an <code data-x="math:ms">ms</code> element:</p>

   <pre>&lt;p>You can add a string to a number, but this stringifies the number:&lt;/p>
&lt;math>
 &lt;ms>&lt;![CDATA[x&lt;y]]>&lt;/ms>
 &lt;mo>+&lt;/mo>
 &lt;mn>3&lt;/mn>
 &lt;mo>=&lt;/mo>
 &lt;ms>&lt;![CDATA[x&lt;y3]]>&lt;/ms>
&lt;/math></pre>

  </div>


  <h4 id="comments">Comments</h4>

  <p><dfn data-x="syntax-comments">Comments</dfn> must start with the four character sequence U+003C
  LESS-THAN SIGN, U+0021 EXCLAMATION MARK, U+002D HYPHEN-MINUS, U+002D HYPHEN-MINUS (<code
 >&lt;!--</code>). Following this sequence, the comment may have <span
  data-x="syntax-text">text</span>, with the additional restriction that the text must not start with
  a single U+003E GREATER-THAN SIGN character (&gt;), nor start with a U+002D HYPHEN-MINUS character
  (-) followed by a U+003E GREATER-THAN SIGN (&gt;) character, nor contain two consecutive U+002D
  HYPHEN-MINUS characters (<code>--</code>), nor end with a U+002D HYPHEN-MINUS character
  (-). Finally, the comment must be ended by the three character sequence U+002D HYPHEN-MINUS,
  U+002D HYPHEN-MINUS, U+003E GREATER-THAN SIGN (<code>--&gt;</code>).</p>


<!--HTMLPARSER-->

  <div class="impl">

  <h3 id="parsing">Parsing HTML documents</h3>

  <p><i>This section only applies to user agents, data mining tools, and conformance
  checkers.</i></p>

  <p class="note">The rules for parsing XML documents into DOM trees are covered by the next
  section, entitled "<span>The XHTML syntax</span>".</p>

  <p>User agents must use the parsing rules described in this section to generate the DOM trees from
  <code>text/html</code> resources. Together, these rules define what is referred to as the
  <dfn>HTML parser</dfn>.</p>

  <div class="note">

   <p>While the HTML syntax described in this specification bears a close resemblance to SGML and
   XML, it is a separate language with its own parsing rules.</p>

   <p>Some earlier versions of HTML (in particular from HTML2 to HTML4) were based on SGML and used
   SGML parsing rules. However, few (if any) web browsers ever implemented true SGML parsing for
   HTML documents; the only user agents to strictly handle HTML as an SGML application have
   historically been validators. The resulting confusion &mdash; with validators claiming documents
   to have one representation while widely deployed Web browsers interoperably implemented a
   different representation &mdash; has wasted decades of productivity. This version of HTML thus
   returns to a non-SGML basis.</p>

   <p>Authors interested in using SGML tools in their authoring pipeline are encouraged to use XML
   tools and the XML serialization of HTML.</p>

  </div>

  <p>This specification defines the parsing rules for HTML documents, whether they are syntactically
  correct or not. Certain points in the parsing algorithm are said to be <dfn data-x="parse
  error">parse errors</dfn>. The error handling for parse errors is well-defined (that's the
  processing rules described throughout this specification), but user agents, while parsing an HTML
  document, may <span data-x="abort a parser">abort the parser</span> at the first <span>parse
  error</span> that they encounter for which they do not wish to apply the rules described in this
  specification.</p>

  <p>Conformance checkers must report at least one parse error condition to the user if one or more
  parse error conditions exist in the document and must not report parse error conditions if none
  exist in the document. Conformance checkers may report more than one parse error condition if more
  than one parse error condition exists in the document.</p>

  <p class="note">Parse errors are only errors with the <em>syntax</em> of HTML. In addition to
  checking for parse errors, conformance checkers will also verify that the document obeys all the
  other conformance requirements described in this specification.</p>

  <p>For the purposes of conformance checkers, if a resource is determined to be in <span>the HTML
  syntax</span>, then it is an <span data-x="HTML documents">HTML document</span>.</p>

  <p class="note">As stated <span class="no-backref" data-x="HTML elements">in the terminology
  section</span>, references to <span data-x="element type">element types</span> that do not
  explicitly specify a namespace always refer to elements in the <span>HTML namespace</span>. For
  example, if the spec talks about "a <code>menuitem</code> element", then that is an element with
  the local name "<code>menuitem</code>", the namespace "<code
 >http://www.w3.org/1999/xhtml</code>", and the interface <code>HTMLMenuItemElement</code>.
  Where possible, references to such elements are hyperlinked to their definition.</p>

  </div>


  <div class="impl">

  <h4 id="overview-of-the-parsing-model">Overview of the parsing model</h4>

  <p class="overview"><object data="images/parsing-model-overview.svg" width="345" height="535"><img src="images/parsing-model-overview.png" width="345" height="450" alt=""></object></p>

  <p>The input to the HTML parsing process consists of a stream of <span data-x="Unicode code
  point">Unicode code points</span>, which is passed through a <span>tokenization</span> stage
  followed by a <span>tree construction</span> stage. The output is a <code>Document</code>
  object.</p>

  <p class="note">Implementations that <a href="#non-scripted">do not support scripting</a> do not
  have to actually create a DOM <code>Document</code> object, but the DOM tree in such cases is
  still used as the model for the rest of the specification.</p>

  <p>In the common case, the data handled by the tokenization stage comes from the network, but
  <span data-x="dynamic markup insertion">it can also come from script</span> running in the user
  agent, e.g. using the <code data-x="dom-document-write">document.write()</code> API.</p>

  <p id="nestedParsing">There is only one set of states for the tokenizer stage and the tree
  construction stage, but the tree construction stage is reentrant, meaning that while the tree
  construction stage is handling one token, the tokenizer might be resumed, causing further tokens
  to be emitted and processed before the first token's processing is complete.</p>

  <div class="example">

   <p>In the following example, the tree construction stage will be called upon to handle a "p"
   start tag token while handling the "script" end tag token:</p>

   <pre>...
&lt;script>
 document.write('&lt;p>');
&lt;/script>
...</pre>

  </div>

  <p>To handle these cases, parsers have a <dfn>script nesting level</dfn>, which must be initially
  set to zero, and a <dfn>parser pause flag</dfn>, which must be initially set to false.</p>

  </div>



  <div class="impl">

  <h4>The <dfn>input byte stream</dfn></h4>

  <p>The stream of Unicode code points that comprizes the input to the tokenization stage will be
  initially seen by the user agent as a stream of bytes (typically coming over the network or from
  the local file system). The bytes encode the actual characters according to a particular
  <i>character encoding</i>, which the user agent uses to decode the bytes into characters.</p>

  <p class="note">For XML documents, the algorithm user agents are required to use to determine the
  character encoding is given by the XML specification. This section does not apply to XML
  documents. <a href="#refsXML">\[XML]</a></p>

  <p>Usually, the <span>encoding sniffing algorithm</span> defined below is used to determine the
  character encoding.</p>

  <p>Given a character encoding, the bytes in the <span>input byte stream</span> must be converted
  to Unicode code points for the tokenizer's <span>input stream</span>, as described by the rules
  for that encoding's <span>decoder</span>.</p>

  <p class="note">Bytes or sequences of bytes in the original byte stream that did not conform to
  the Encoding standard (e.g. invalid UTF-8 byte sequences in a UTF-8 input byte stream) are errors
  that conformance checkers are expected to report. <a href="#refsENCODING">\[ENCODING]</a></p>

  <p class="note">Leading Byte Order Marks (BOMs) are not stripped by the decoder algorithms, they
  are stripped by the algorithm below.</p>

  <p class="warning">The decoder algorithms describe how to handle invalid input; for security
  reasons, it is imperative that those rules be followed precisely. Differences in how invalid byte
  sequences are handled can result in, amongst other problems, script injection vulnerabilities
  ("XSS").</p>

  <p>When the HTML parser is decoding an input byte stream, it uses a character encoding and a <dfn
  data-x="concept-encoding-confidence">confidence</dfn>. The confidence is either <i>tentative</i>,
  <i>certain</i>, or <i>irrelevant</i>. The encoding used, and whether the confidence in that
  encoding is <i>tentative</i> or <i>certain</i>, is <a href="#meta-charset-during-parse">used
  during the parsing</a> to determine whether to <span>change the encoding</span>. If no encoding is
  necessary, e.g. because the parser is operating on a Unicode stream and doesn't have to use a
  character encoding at all, then the <span data-x="concept-encoding-confidence">confidence</span> is
  <i>irrelevant</i>.</p>

  <p class="note">Some algorithms feed the parser by directly adding characters to the <span>input
  stream</span> rather than adding bytes to the <span>input byte stream</span>.</p>


  <h5 id="parsing-with-a-known-character-encoding">Parsing with a known character encoding</h5>

  <p>When the HTML parser is to operate on an input byte stream that has <dfn>a known definite
  encoding</dfn>, then the character encoding is that encoding and the <span
  data-x="concept-encoding-confidence">confidence</span> is <i>certain</i>.</p>


  <h5 id="determining-the-character-encoding">Determining the character encoding</h5>

  <p>In some cases, it might be impractical to unambiguously determine the encoding before parsing
  the document. Because of this, this specification provides for a two-pass mechanism with an
  optional pre-scan. Implementations are allowed, as described below, to apply a simplified parsing
  algorithm to whatever bytes they have available before beginning to parse the document. Then, the
  real parser is started, using a tentative encoding derived from this pre-parse and other
  out-of-band metadata. If, while the document is being loaded, the user agent discovers a character
  encoding declaration that conflicts with this information, then the parser can get reinvoked to
  perform a parse of the document with the real encoding.</p>

  <p id="documentEncoding">User agents must use the following algorithm, called the <dfn>encoding
  sniffing algorithm</dfn>, to determine the character encoding to use when decoding a document in
  the first pass. This algorithm takes as input any out-of-band metadata available to the user agent
  (e.g. the <span data-x="Content-Type">Content-Type metadata</span> of the document) and all the
  bytes available so far, and returns a character encoding and a <span
  data-x="concept-encoding-confidence">confidence</span> that is either <i>tentative</i> or
  <i>certain</i>.</p>

  <ol>

   <li>

    <p>If the user has explicitly instructed the user agent to override the document's character
    encoding with a specific encoding, optionally return that encoding with the <span
    data-x="concept-encoding-confidence">confidence</span> <i>certain</i> and abort these steps.</p>

    <p class="note">Typically, user agents remember such user requests across sessions, and in some
    cases apply them to documents in <code>iframe</code>s as well.</p>

   </li>

   <li>

    <p>The user agent may wait for more bytes of the resource to be available, either in this step
    or at any later step in this algorithm. For instance, a user agent might wait 500ms or 1024
    bytes, whichever came first. In general preparsing the source to find the encoding improves
    performance, as it reduces the need to throw away the data structures used when parsing upon
    finding the encoding information. However, if the user agent delays too long to obtain data to
    determine the encoding, then the cost of the delay could outweigh any performance improvements
    from the preparse.</p>

    <p class="note">The authoring conformance requirements for character encoding declarations limit
    them to only appearing <a href="#charset1024">in the first 1024 bytes</a>. User agents are
    therefore encouraged to use the prescan algorithm below (as invoked by these steps) on the first
    1024 bytes, but not to stall beyond that.</p>

   </li>

   <li>

    <!-- Doing this step before honouring HTTP is important for supporting
            http://kb.dsqq.cn/html/2012-09/16/node_193.htm
         which is encoded as UTF-8 but is incorrectly labeled as
            Content-Type: text/html; charset=GB2312
    -->

    <p>For each of the rows in the following table, starting with the first one and going down, if
    there are as many or more bytes available than the number of bytes in the first column, and the
    first bytes of the file match the bytes given in the first column, then return the encoding
    given in the cell in the second column of that row, with the <span
    data-x="concept-encoding-confidence">confidence</span> <i>certain</i>, and abort these steps:</p>

    <!-- this table is present in several forms in this file; keep them in sync -->
    <table>
     <thead>
      <tr>
       <th>Bytes in Hexadecimal
       <th>Encoding
     <tbody>
<!-- nobody uses this
      <tr>
       <td>00 00 FE FF
       <td>UTF-32BE
      <tr>
       <td>FF FE 00 00
       <td>UTF-32LE
-->
      <tr>
       <td>FE FF
       <td>Big-endian UTF-16
      <tr>
       <td>FF FE
       <td>Little-endian UTF-16
      <tr>
       <td>EF BB BF
       <td>UTF-8
<!-- nobody uses this
      <tr>
       <td>DD 73 66 73
       <td>UTF-EBCDIC
-->
    </table>

    <p class="note">This step looks for Unicode Byte Order Marks (BOMs).</p>

    <p class="note">That this step happens before the next one honoring the HTTP
    <code>Content-Type</code> header is a <span>willful violation</span> of the HTTP specification,
    motivated by a desire to be maximally compatible with legacy content. <a
    href="#refsHTTP">\[HTTP]</a></p>

   </li>

   <li><p>If the transport layer specifies a character encoding, and it is supported, return that
   encoding with the <span data-x="concept-encoding-confidence">confidence</span> <i>certain</i>, and
   abort these steps.</p></li>

   <li>

    <p>Optionally <span data-x="prescan a byte stream to determine its encoding">prescan the byte
    stream to determine its encoding</span>. The <var>end condition</var> is that the user
    agent decides that scanning further bytes would not be efficient. User agents are encouraged to
    only prescan the first 1024 bytes. User agents may decide that scanning <em>any</em> bytes is
    not efficient, in which case these substeps are entirely skipped.</p>

    <p>The aforementioned algorithm either aborts unsuccessfully or returns a character encoding. If
    it returns a character encoding, then this algorithm must be aborted, returning the same
    encoding, with <span data-x="concept-encoding-confidence">confidence</span> <i>tentative</i>.</p>

   </li>

   <li>

    <p>If the <span>HTML parser</span> for which this algorithm is being run is associated with a
    <code>Document</code> that is itself in a <span>nested browsing context</span>, run these
    substeps:</p>

    <ol>

     <li><p>Let <var>new document</var> be the <code>Document</code> with which the
     <span>HTML parser</span> is associated.</p></li>

     <li><p>Let <var>parent document</var> be the <code>Document</code> <span
     data-x="browsing context nested through">through which <var>new document</var> is
     nested</span> (the <span>active document</span> of the <span>parent browsing context</span> of
     <var>new document</var>).</p></li>

     <li><p>If <var>parent document</var>'s <span>origin</span> is not the <span>same
     origin</span> as <var>new document</var>'s <span>origin</span>, then abort these
     substeps.</p></li>

     <li><p>If <var>parent document</var>'s <span data-x="document's character
     encoding">character encoding</span> is not an <span>ASCII-compatible encoding</span>, then
     abort these substeps.</p></li>

     <li><p>Return <var>parent document</var>'s <span data-x="document's character
     encoding">character encoding</span>, with the <span
     data-x="concept-encoding-confidence">confidence</span> <i>tentative</i>, and abort the
     <span>encoding sniffing algorithm</span>'s steps.</p></li>

    </ol>

   </li>

   <li><p>Otherwise, if the user agent has information on the likely encoding for this page, e.g.
   based on the encoding of the page when it was last visited, then return that encoding, with the
   <span data-x="concept-encoding-confidence">confidence</span> <i>tentative</i>, and abort these
   steps.</p></li>

   <li>

    <p>The user agent may attempt to autodetect the character encoding from applying frequency
    analysis or other algorithms to the data stream. Such algorithms may use information about the
    resource other than the resource's contents, including the address of the resource. If
    autodetection succeeds in determining a character encoding, and that encoding is a supported
    encoding, then return that encoding, with the <span
    data-x="concept-encoding-confidence">confidence</span> <i>tentative</i>, and abort these steps.
    <a href="#refsUNIVCHARDET">\[UNIVCHARDET]</a></p>

    <p class="note">User agents are generally discouraged from attempting to autodetect encodings
    for resources obtained over the network, since doing so involves inherently non-interoperable
    heuristics. Attempting to detect encodings based on an HTML document's preamble is especially
    tricky since HTML markup typically uses only ASCII characters, and HTML documents tend to begin
    with a lot of markup rather than with text content.</p>

    <p class="note">The UTF-8 encoding has a highly detectable bit pattern. Files from the local
    file system that contain bytes with values greater than 0x7F which match the UTF-8 pattern are
    very likely to be UTF-8, while documents with byte sequences that do not match it are very
    likely not. When a user agent can examine the whole file, rather than just the preamble,
    detecting for UTF-8 specifically can be especially effective. <a href="#refsPPUTF8">\[PPUTF8]</a> <a
    href="#refsUTF8DET">\[UTF8DET]</a></p>

   </li>

   <li>

    <p>Otherwise, return an implementation-defined or user-specified default character encoding,
    with the <span data-x="concept-encoding-confidence">confidence</span> <i>tentative</i>.</p>

    <p>In controlled environments or in environments where the encoding of documents can be
    prescribed (for example, for user agents intended for dedicated use in new networks), the
    comprehensive <code>UTF-8</code> encoding is suggested.</p>

    <p>In other environments, the default encoding is typically dependent on the user's locale (an
    approximation of the languages, and thus often encodings, of the pages that the user is likely
    to frequent). The following table gives suggested defaults based on the user's locale, for
    compatibility with legacy content. Locales are identified by BCP 47 language tags. <a
    href="#refsBCP47">\[BCP47]</a> <a href="#refsENCODING">\[ENCODING]</a></p>

    <!-- based on three sources:
          1. mozilla 1.9.1 localizations: http://mxr.mozilla.org/l10n-mozilla1.9.1/find?string=global%2Fintl.properties&tree=l10n-mozilla1.9.1&hint= (though this data was apparently misinterpreted in some cases)
          2. windows vista encodings: http://msdn.microsoft.com/en-us/goglobal/bb896001
          3. chrome encodings: https://code.google.com/p/chromium/codesearch#search/&q=IDS_DEFAULT_ENCODING
         several assumptions were made in this process; amongst them:
          - ISO-8859-1 and Windows-1252 are the same (supported by encoding.spec.whatwg.org)
          - ISO-8859-9 and Windows-1254 are the same (supported by encoding.spec.whatwg.org)
          - Windows-31J and Shift_JIS are the same (supported by encoding.spec.whatwg.org)
          - Windows-932 is close enough to Shift_JIS to be treated as equivalent (supported by wikipedia)
          - Windows-936 is a basically a subset of GBK which is basically a subset of GB18030 (supported by wikipedia)
          - Windows-950 is basically the same as Big5 (supported by wikipedia)
          - Firefox's UTF-8 defaults are all bogus
    -->

    <table>
     <thead>
      <tr>
       <th colspan=2>Locale language
       <th>Suggested default encoding
     <tbody>

      <!-- af, Afrikaans, uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- am, Amharic, uses windows-1252: Firefox and Chrome agreed -->

      <tr>
       <td>ar
       <td>Arabic
       <td>windows-1256 <!-- Windows Vista and Chrome agreed -->

      <!-- arn-CL, Mapudungun (Chile), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- az, Azeri, is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1254 -->

      <!-- az-Cyrl-AZ, Azeri (Cyrillic, Azerbaijan), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1251 -->

      <!-- ba-RU, Bashkir (Russia), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1251 -->
      <!-- ba wasn't listed at all because none of the sources knew about it. However, further feedback has changed this: -->
      <tr>
       <td>ba
       <td>Bashkir
       <td>windows-1251 <!-- per https://www.w3.org/Bugs/Public/show_bug.cgi?id=23089 -->

      <!-- be, Belarusian, was not initially listed here because Windows Vista wanted windows-1251, Chrome wanted <none>, and Firefox wanted ISO-8859-5 -->
      <!-- further feedback has changed this: -->
      <tr>
       <td>be
       <td>Belarusian
       <td>windows-1251 <!-- per https://www.w3.org/Bugs/Public/show_bug.cgi?id=23089 -->

      <!-- be-BY, Belarusian (Belarus), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1251 -->

      <tr>
       <td>bg
       <td>Bulgarian
       <td>windows-1251 <!-- Windows Vista, Chrome, and Firefox agreed -->

      <!-- bn, Bengali, uses windows-1252: Firefox and Chrome agreed -->

      <!-- br-FR, Breton (France), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- bs-Cyrl-BA, Bosnian (Cyrillic, Bosnia and Herzegovina), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1251 -->

      <!-- bs-Latn-BA, Bosnian (Latin, Bosnia and Herzegovina), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1250 -->

      <!-- ca, Catalan, uses windows-1252: Windows Vista, Chrome, and Firefox agreed -->

      <!-- co-FR, Corsican (France), uses windows-1252: Windows Vista and Firefox agreed -->

      <tr>
       <td>cs
       <td>Czech
       <td>windows-1250 <!-- Windows Vista and Chrome agreed (but disagreed with Firefox, which reportedly agreed on Windows but thought the encoding should be ISO-8859-2 on Mac and Linux) -->

      <!-- cy-GB, Welsh (United Kingdom), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- da, Danish, uses windows-1252: Windows Vista, Chrome, and Firefox agreed -->

      <!-- de, German, uses windows-1252: Windows Vista, Chrome, and Firefox agreed -->

      <!-- el, Greek, was not initially listed here because Windows Vista wanted windows-1253, Chrome wanted ISO-8859-7, and Firefox wanted ISO-8859-7 but looked liked it wanted windows-1252 -->
      <!-- el-GR, Greek (Greece), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1253 -->
      <!-- further feedback has changed this: -->
      <tr>
       <td>el
       <td>Greek
       <td>ISO-8859-7 <!-- per https://www.w3.org/Bugs/Public/show_bug.cgi?id=23090 -->

      <!-- en, English, uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- es, Spanish, uses windows-1252: Windows Vista, Chrome, and Firefox agreed -->

      <tr>
       <td>et
       <td>Estonian
       <td>windows-1257 <!-- Windows Vista and Chrome agreed -->

      <!-- eu, Basque, uses windows-1252: Windows Vista and Firefox agreed -->

      <tr>
       <td>fa
       <td>Persian
       <td>windows-1256 <!-- Windows Vista and Chrome agreed -->

      <!-- fi, Finnish, uses windows-1252: Windows Vista, Chrome, and Firefox agreed -->

      <!-- fil, Filipino, uses windows-1252: Firefox and Chrome agreed -->

      <!-- fo, Faroese, uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- fr, French, uses windows-1252: Windows Vista, Chrome, and Firefox agreed -->

      <!-- fy-NL, Frisian (Netherlands), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- ga-IE, Irish (Ireland), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- gl, Galician, uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- gsw-FR, Alsatian (France), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- gu, Gujarati, uses windows-1252: Firefox and Chrome agreed -->

      <!-- ha-Latn-NG, Hausa (Latin, Nigeria), uses windows-1252: Windows Vista and Firefox agreed -->

      <tr>
       <td>he
       <td>Hebrew
       <td>windows-1255 <!-- Windows Vista, Chrome, and Firefox agreed -->

      <!-- hi, Hindi, uses windows-1252: Firefox and Chrome agreed -->

      <tr>
       <td>hr
       <td>Croatian
       <td>windows-1250 <!-- Windows Vista and Chrome agreed -->

      <tr>
       <td>hu
       <td>Hungarian
       <td>ISO-8859-2 <!-- Chrome and Firefox agreed (but disagreed with Windows Vista, which thought the encoding should be windows-1250) -->

      <!-- hu-HU, Hungarian (Hungary), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1250 -->

      <!-- id, Indonesian, uses windows-1252: Windows Vista, Chrome, and Firefox agreed -->

      <!-- ig-NG, Igbo (Nigeria), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- is, Icelandic, uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- it, Italian, uses windows-1252: Windows Vista, Chrome, and Firefox agreed -->

      <!-- iu-Latn-CA, Inuktitut (Latin, Canada), uses windows-1252: Windows Vista and Firefox agreed -->

      <tr>
       <td>ja
       <td>Japanese
       <td>Shift_JIS <!-- Windows Vista, Chrome, and Firefox agreed -->

      <!-- kk, Kazakh, was not initially listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1251 -->
      <!-- further feedback has changed this: -->
      <tr>
       <td>kk
       <td>Kazakh
       <td>windows-1251 <!-- per https://www.w3.org/Bugs/Public/show_bug.cgi?id=23089 -->

      <!-- kl-GL, Greenlandic (Greenland), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- kn, Kannada, uses windows-1252: Firefox and Chrome agreed -->

      <tr>
       <td>ko
       <td>Korean
       <td>euc-kr <!-- Windows Vista, Chrome, and Firefox agreed -->

      <tr>
       <td>ku
       <td>Kurdish
       <td>windows-1254 <!-- Best guess -->

      <!-- ky, Kyrgyz, was not initially listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1251 -->
      <!-- further feedback has changed this: -->
      <tr>
       <td>ky
       <td>Kyrgyz
       <td>windows-1251 <!-- per https://www.w3.org/Bugs/Public/show_bug.cgi?id=23089 -->

      <!-- lb-LU, Luxembourgish (Luxembourg), uses windows-1252: Windows Vista and Firefox agreed -->

      <tr>
       <td>lt
       <td>Lithuanian
       <td>windows-1257 <!-- Windows Vista, Chrome, and Windows Firefox agreed; Linux and Mac Firefox reportedly disagreed -->

      <tr>
       <td>lv
       <td>Latvian
       <td>windows-1257 <!-- Windows Vista and Chrome agreed (but disagreed with Firefox, which thought the encoding should be ISO-8859-13) -->

      <!-- mk, Macedonian, was not initially listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1251 -->
      <!-- further feedback has changed this: -->
      <tr>
       <td>mk
       <td>Macedonian
       <td>windows-1251 <!-- per https://www.w3.org/Bugs/Public/show_bug.cgi?id=23089 -->

      <!-- ml, Malayalam, uses windows-1252: Firefox and Chrome agreed -->

      <!-- mn, Mongolian, is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1251 -->

      <!-- moh-CA, Mohawk (Mohawk), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- mr, Marathi, uses windows-1252: Firefox and Chrome agreed -->

      <!-- ms, Malay, uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- nb, Norwegian Bokm&aring;l, uses windows-1252: Firefox and Chrome agreed -->

      <!-- nl, Dutch, uses windows-1252: Windows Vista, Chrome, and Firefox agreed -->

      <!-- nn-NO, Norwegian, Nynorsk (Norway), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- no, Norwegian, uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- nso-ZA, Sesotho sa Leboa (South Africa), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- oc-FR, Occitan (France), uses windows-1252: Windows Vista and Firefox agreed -->

      <tr>
       <td>pl
       <td>Polish
       <td>ISO-8859-2 <!-- Chrome and Firefox agreed (but disagreed with Windows Vista, which thought the encoding should be windows-1250) -->

      <!-- pl-PL, Polish (Poland), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1250 -->

      <!-- prs-AF, Dari (Afghanistan), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1256 -->

      <!-- pt, Portuguese, uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- qut-GT, K'iche (Guatemala), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- quz-BO, Quechua (Bolivia), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- quz-EC, Quechua (Ecuador), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- quz-PE, Quechua (Peru), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- rm-CH, Romansh (Switzerland), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- ro, Romanian, is not listed here because Windows Vista wanted windows-1250, Chrome wanted ISO-8859-2, and Firefox wanted <none> -->

      <!-- ro-RO, Romanian (Romania), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1250 -->

      <tr>
       <td>ru
       <td>Russian
       <td>windows-1251 <!-- Windows Vista, Chrome, and Firefox agreed -->

      <!-- rw-RW, Kinyarwanda (Rwanda), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- sah-RU, Yakut (Russia), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1251 -->
      <!-- sah wasn't listed at all because none of the sources knew about it. However, further feedback has changed this: -->
      <tr>
       <td>sah
       <td>Yakut
       <td>windows-1251 <!-- per https://www.w3.org/Bugs/Public/show_bug.cgi?id=23089 -->

      <!-- se-FI, Sami, Northern (Finland), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- se-NO, Sami, Northern (Norway), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- se-SE, Sami, Northern (Sweden), uses windows-1252: Windows Vista and Firefox agreed -->

      <tr>
       <td>sk
       <td>Slovak
       <td>windows-1250 <!-- Windows Vista, Chrome, and Firefox agreed -->

      <tr>
       <td>sl
       <td>Slovenian
       <td>ISO-8859-2 <!-- Chrome and Firefox agreed (but disagreed with Windows Vista, which thought the encoding should be windows-1250) -->

      <!-- sl-SI, Slovenian (Slovenia), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1250 -->

      <!-- sma-NO, Sami, Southern (Norway), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- sma-SE, Sami, Southern (Sweden), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- smj-NO, Sami, Lule (Norway), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- smj-SE, Sami, Lule (Sweden), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- smn-FI, Sami, Inari (Finland), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- sms-FI, Sami, Skolt (Finland), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- sq, Albanian, is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1250 -->

      <tr>
       <td>sr
       <td>Serbian
       <td>windows-1251 <!-- Windows Vista and Chrome agreed -->

      <!-- sr-Latn-BA, Serbian (Latin, Bosnia and Herzegovina), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1250 -->

      <!-- sr-Latn-SP, Serbian (Latin, Serbia), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1250 -->

      <!-- sv, Swedish, uses windows-1252: Windows Vista, Chrome, and Firefox agreed -->

      <!-- sw, Kiswahili, uses windows-1252: Windows Vista, Chrome, and Firefox agreed -->

      <!-- ta, Tamil, uses windows-1252: Firefox and Chrome agreed -->

      <!-- te, Telugu, uses windows-1252: Firefox and Chrome agreed -->

      <!-- tg-Cyrl-TJ, Tajik (Cyrillic, Tajikistan), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1251 -->
      <!-- tg wasn't listed at all because none of the sources knew about it. However, further feedback has changed this: -->
      <tr>
       <td>tg
       <td>Tajik
       <td>windows-1251 <!-- per https://www.w3.org/Bugs/Public/show_bug.cgi?id=23089 -->

      <tr>
       <td>th
       <td>Thai
       <td>windows-874 <!-- Windows Vista, Chrome, and Firefox agree (though Firefox didn't always) -->

      <!-- tk-TM, Turkmen (Turkmenistan), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1250 -->

      <!-- tn-ZA, Setswana (South Africa), uses windows-1252: Windows Vista and Firefox agreed -->

      <tr>
       <td>tr
       <td>Turkish
       <td>windows-1254 <!-- Windows Vista, Chrome, and Firefox agreed -->

      <!-- tt, Tatar, was not initially listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1251 -->
      <!-- further feedback has changed this: -->
      <tr>
       <td>tt
       <td>Tatar
       <td>windows-1251 <!-- per https://www.w3.org/Bugs/Public/show_bug.cgi?id=23089 -->

      <!-- tzm-Latn-DZ, Tamazight (Latin, Algeria), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- ug-CN, Uighur (PRC), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1256 -->

      <tr>
       <td>uk
       <td>Ukrainian
       <td>windows-1251 <!-- Windows Vista, Chrome, and Firefox agreed -->

      <!-- ur, Urdu, is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1256 -->

      <!-- uz, Uzbek, is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1254 -->

      <!-- uz-Cyrl-UZ, Uzbek (Cyrillic, Uzbekistan), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted windows-1251 -->

      <tr>
       <td>vi
       <td>Vietnamese
       <td>windows-1258 <!-- Windows Vista and Chrome agreed -->

      <!-- wee-DE, Lower Sorbian (Germany), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- wen-DE, Upper Sorbian (Germany), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- wo-SN, Wolof (Senegal), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- xh-ZA, isiXhosa (South Africa), uses windows-1252: Windows Vista and Firefox agreed -->

      <!-- yo-NG, Yoruba (Nigeria), uses windows-1252: Windows Vista and Firefox agreed -->

      <tr>
       <td>zh-CN
       <td>Chinese (People's Republic of China)
       <td>GB18030 <!-- Windows Vista, Chrome, and Firefox agreed -->

      <!-- zh-HK, Chinese (Hong Kong S.A.R.), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted Big5 -->

      <!-- zh-Hans, Chinese (Simplified), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted GB18030 -->

      <!-- zh-Hant, Chinese (Traditional), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted Big5 -->

      <!-- zh-MO, Chinese (Macao S.A.R.), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted Big5 -->

      <!-- zh-SG, Chinese (Singapore), is not listed here because neither Chrome nor Firefox knew about it. For what it's worth, Windows Vista wanted GB18030 -->

      <tr>
       <td>zh-TW
       <td>Chinese (Taiwan)
       <td>Big5 <!-- Windows Vista, Chrome, and Firefox agreed (though Firefox didn't always) -->

      <!-- zu-ZA, isiZulu (South Africa), uses windows-1252: Windows Vista and Firefox agreed -->

      <tr>
       <td colspan=2>All other locales
       <td>windows-1252

    </table>

    <p class="tablenote"><small>The contents of this table are derived from the intersection of
    Windows, Chrome, and Firefox defaults.</small></p>

   </li>

  </ol>

  <p>The <span>document's character encoding</span> must immediately be set to the value returned
  from this algorithm, at the same time as the user agent uses the returned value to select the
  decoder to use for the input byte stream.</p>

  <hr>

  <p>When an algorithm requires a user agent to <dfn>prescan a byte stream to determine its
  encoding</dfn>, given some defined <var>end condition</var>, then it must run the
  following steps. These steps either abort unsuccessfully or return a character encoding. If at any
  point during these steps (including during instances of the <span
  data-x="concept-get-attributes-when-sniffing">get an attribute</span> algorithm invoked by this
  one) the user agent either runs out of bytes (meaning the <var>position</var> pointer
  created in the first step below goes beyond the end of the byte stream obtained so far) or reaches
  its <var>end condition</var>, then abort the <span>prescan a byte stream to determine its
  encoding</span> algorithm unsuccessfully.</p>

  <ol>

   <li>

    <p>Let <var>position</var> be a pointer to a byte in the input byte stream, initially
    pointing at the first byte.</p>

   </li>

   <li>

    <p><i>Loop</i>: If <var>position</var> points to:</p>

    <dl class="switch">

     <dt>A sequence of bytes starting with: 0x3C 0x21 0x2D 0x2D (ASCII '&lt;!--')</dt>
     <dd>

      <p>Advance the <var>position</var> pointer so that it points at the first 0x3E byte
      which is preceded by two 0x2D bytes (i.e. at the end of an ASCII '-->' sequence) and comes
      after the 0x3C byte that was found. (The two 0x2D bytes can be the same as the those in the
      '&lt;!--' sequence.)</p>

     </dd>

     <dt>A sequence of bytes starting with: 0x3C, 0x4D or 0x6D, 0x45 or 0x65, 0x54 or 0x74, 0x41 or 0x61, and one of 0x09, 0x0A, 0x0C, 0x0D, 0x20, 0x2F (case-insensitive ASCII '&lt;meta' followed by a space or slash)</dt>
     <dd>

      <ol>

       <li><p>Advance the <var>position</var> pointer so that it points at the next 0x09,
       0x0A, 0x0C, 0x0D, 0x20, or 0x2F byte (the one in sequence of characters matched
       above).</p></li>

       <li><p>Let <var>attribute list</var> be an empty list of strings.</p></li> <!-- so
       long as we only care about http-equiv, content, and charset, this can be a 3-bit bitfield -->

       <li><p>Let <var>got pragma</var> be false.</p></li>

       <li><p>Let <var>need pragma</var> be null.</p></li>

       <li><p>Let <var>charset</var> be the null value (which, for the purposes of this
       algorithm, is distinct from an unrecognized encoding or the empty string).</p></li>

       <li><p><i>Attributes</i>: <span data-x="concept-get-attributes-when-sniffing">Get an
       attribute</span> and its value. If no attribute was sniffed, then jump to the
       <i>processing</i> step below.</p></li>

       <li><p>If the attribute's name is already in <var>attribute list</var>, then return
       to the step labeled <i>attributes</i>.</p>

       <li><p>Add the attribute's name to <var>attribute list</var>.</p>

       <li>

        <p>Run the appropriate step from the following list, if one applies:</p>

        <dl class="switch">

         <dt>If the attribute's name is "<code>http-equiv</code>"</dt>

         <dd><p>If the attribute's value is "<code>content-type</code>", then set <var>got pragma</var> to true.</p></dd>

         <dt>If the attribute's name is "<code>content</code>"</dt>

         <dd><p>Apply the <span>algorithm for extracting a character encoding from a
         <code>meta</code> element</span>, giving the attribute's value as the string to parse. If a
         character encoding is returned, and if <var>charset</var> is still set to null,
         let <var>charset</var> be the encoding returned, and set <var>need
         pragma</var> to true.</p></dd>

         <dt>If the attribute's name is "<code>charset</code>"</dt>

         <dd><p>Let <var>charset</var> be the result of <span>getting an encoding</span>
         from the attribute's value, and set <var>need pragma</var> to false.</p></dd>

        </dl>

       </li>

       <li><p>Return to the step labeled <i>attributes</i>.</p></li>

       <li><p><i>Processing</i>: If <var>need pragma</var> is null, then jump to the step
       below labeled <i>next byte</i>.</p></li>

       <li><p>If <var>need pragma</var> is true but <var>got pragma</var> is
       false, then jump to the step below labeled <i>next byte</i>.</p></li>

       <!-- the next two steps are redundant with steps in the 'change the encoding' algorithm -->

       <li><p>If <var>charset</var> is a <span>UTF-16 encoding</span>, change the value of
       <var>charset</var> to UTF-8.</p></li>

       <li><p>If <var>charset</var> is the x-user-defined encoding, change the value of
       <var>charset</var> to Windows-1252. <a href="#refsENCODING">\[ENCODING]</a></p></li>

       <li><p>If <var>charset</var> is not a supported character encoding, then jump to the
       step below labeled <i>next byte</i>.</p></li>

       <li><p>Abort the <span>prescan a byte stream to determine its encoding</span> algorithm,
       returning the encoding given by <var>charset</var>.</p></li>

      </ol>

     </dd>

     <dt>A sequence of bytes starting with a 0x3C byte (ASCII &lt;), optionally a 0x2F byte (ASCII /), and finally a byte in the range 0x41-0x5A or 0x61-0x7A (an ASCII letter)</dt>
     <dd>

      <ol>

       <li><p>Advance the <var>position</var> pointer so that it points at the next 0x09
       (ASCII TAB), 0x0A (ASCII LF), 0x0C (ASCII FF), 0x0D (ASCII CR), 0x20 (ASCII space), or 0x3E
       (ASCII >) byte.</p></li>

       <li><p>Repeatedly <span data-x="concept-get-attributes-when-sniffing">get an attribute</span>
       until no further attributes can be found, then jump to the step below labeled <i>next
       byte</i>.</p></li>

      </ol>

     </dd>

     <dt>A sequence of bytes starting with: 0x3C 0x21 (ASCII '&lt;!')</dt>
     <dt>A sequence of bytes starting with: 0x3C 0x2F (ASCII '&lt;/')</dt>
     <dt>A sequence of bytes starting with: 0x3C 0x3F (ASCII '&lt;?')</dt>
     <dd>

      <p>Advance the <var>position</var> pointer so that it points at the first 0x3E byte
      (ASCII >) that comes after the 0x3C byte that was found.</p>

     </dd>

     <dt>Any other byte</dt>
     <dd>

      <p>Do nothing with that byte.</p>

     </dd>

    </dl>

   </li>

   <li><i>Next byte</i>: Move <var>position</var> so it points at the next byte in the
   input byte stream, and return to the step above labeled <i>loop</i>.</li>

  </ol>

  <p>When the <span>prescan a byte stream to determine its encoding</span> algorithm says to <dfn
  data-x="concept-get-attributes-when-sniffing">get an attribute</dfn>, it means doing this:</p>

  <ol>

   <li><p>If the byte at <var>position</var> is one of 0x09 (ASCII TAB), 0x0A (ASCII LF),
   0x0C (ASCII FF), 0x0D (ASCII CR), 0x20 (ASCII space), or 0x2F (ASCII /) then advance <var>position</var> to the next byte and redo this step.</p></li>

   <li><p>If the byte at <var>position</var> is 0x3E (ASCII >), then abort the <span
   data-x="concept-get-attributes-when-sniffing">get an attribute</span> algorithm. There isn't
   one.</p></li>

   <li><p>Otherwise, the byte at <var>position</var> is the start of the attribute name.
   Let <var>attribute name</var> and <var>attribute value</var> be the empty
   string.</p></li>

   <li><p>Process the byte at <var>position</var> as follows:</p>

    <dl class="switch">

     <dt>If it is 0x3D (ASCII =), and the <var>attribute name</var> is longer than the
     empty string</dt>

     <dd>Advance <var>position</var> to the next byte and jump to the step below labeled
     <i>value</i>.</dd>

     <dt>If it is 0x09 (ASCII TAB), 0x0A (ASCII LF), 0x0C (ASCII FF), 0x0D (ASCII CR), or 0x20
     (ASCII space)</dt>

     <dd>Jump to the step below labeled <i>spaces</i>.</dd>

     <dt>If it is 0x2F (ASCII /) or 0x3E (ASCII >)</dt>

     <dd>Abort the <span data-x="concept-get-attributes-when-sniffing">get an attribute</span>
     algorithm. The attribute's name is the value of <var>attribute name</var>, its value
     is the empty string.</dd>

     <dt>If it is in the range 0x41 (ASCII A) to 0x5A (ASCII Z)</dt>

     <dd>Append the Unicode character with code point <span><var>b</var>+0x20</span> to <var>attribute name</var> (where <var>b</var>
     is the value of the byte at <var>position</var>). (This converts the input to
     lowercase.)</dd>

     <dt>Anything else</dt>

     <dd>Append the Unicode character with the same code point as the value of the byte at <var>position</var> to <var>attribute name</var>. (It doesn't actually matter how
     bytes outside the ASCII range are handled here, since only ASCII characters can contribute to
     the detection of a character encoding.)</dd>

    </dl>

   </li>

   <li><p>Advance <var>position</var> to the next byte and return to the previous
   step.</p></li>

   <li><p><i>Spaces</i>: If the byte at <var>position</var> is one of 0x09 (ASCII TAB),
   0x0A (ASCII LF), 0x0C (ASCII FF), 0x0D (ASCII CR), or 0x20 (ASCII space) then advance <var>position</var> to the next byte, then, repeat this step.</p></li>

   <li><p>If the byte at <var>position</var> is <em>not</em> 0x3D (ASCII =), abort the
   <span data-x="concept-get-attributes-when-sniffing">get an attribute</span> algorithm. The
   attribute's name is the value of <var>attribute name</var>, its value is the empty
   string.</p></li>

   <li><p>Advance <var>position</var> past the 0x3D (ASCII =) byte.</p></li>

   <li><p><i>Value</i>: If the byte at <var>position</var> is one of 0x09 (ASCII TAB), 0x0A
   (ASCII LF), 0x0C (ASCII FF), 0x0D (ASCII CR), or 0x20 (ASCII space) then advance <var>position</var> to the next byte, then, repeat this step.</p></li>

   <li><p>Process the byte at <var>position</var> as follows:</p>

    <dl class="switch">

     <dt>If it is 0x22 (ASCII ") or 0x27 (ASCII ')</dt>

     <dd>

      <ol>

       <li>Let <var>b</var> be the value of the byte at <var>position</var>.</li>

       <li><i>Quote loop</i>: Advance <var>position</var> to the next byte.</li>

       <li>If the value of the byte at <var>position</var> is the value of <var>b</var>, then advance <var>position</var> to the next byte and abort the
       "get an attribute" algorithm. The attribute's name is the value of <var>attribute
       name</var>, and its value is the value of <var>attribute value</var>.</li>

       <li>Otherwise, if the value of the byte at <var>position</var> is in the range 0x41
       (ASCII A) to 0x5A (ASCII Z), then append a Unicode character to <var>attribute
       value</var> whose code point is 0x20 more than the value of the byte at <var>position</var>.</li>

       <li>Otherwise, append a Unicode character to <var>attribute value</var> whose code
       point is the same as the value of the byte at <var>position</var>.</li>

       <li>Return to the step above labeled <i>quote loop</i>.</li>

      </ol>

     </dd>

     <dt>If it is 0x3E (ASCII >)</dt>

     <dd>Abort the <span data-x="concept-get-attributes-when-sniffing">get an attribute</span>
     algorithm. The attribute's name is the value of <var>attribute name</var>, its value
     is the empty string.</dd>


     <dt>If it is in the range 0x41 (ASCII A) to 0x5A (ASCII Z)</dt>

     <dd>Append the Unicode character with code point <span><var>b</var>+0x20</span> to <var>attribute value</var> (where <var>b</var> is the value of the byte at <var>position</var>). Advance <var>position</var> to the next byte.</dd>

     <dt>Anything else</dt>

     <dd>Append the Unicode character with the same code point as the value of the byte at <var>position</var> to <var>attribute value</var>. Advance <var>position</var> to the next byte.</dd>

    </dl>

   </li>

   <li><p>Process the byte at <var>position</var> as
   follows:</p>

    <dl class="switch">

     <dt>If it is 0x09 (ASCII TAB), 0x0A (ASCII LF), 0x0C (ASCII FF), 0x0D (ASCII CR), 0x20 (ASCII
     space), or 0x3E (ASCII >)</dt>

     <dd>Abort the <span data-x="concept-get-attributes-when-sniffing">get an attribute</span>
     algorithm. The attribute's name is the value of <var>attribute name</var> and its
     value is the value of <var>attribute value</var>.</dd>

     <dt>If it is in the range 0x41 (ASCII A) to 0x5A (ASCII Z)</dt>

     <dd>Append the Unicode character with code point <span><var>b</var>+0x20</span> to <var>attribute value</var> (where <var>b</var> is the value of the byte at <var>position</var>).</dd>

     <dt>Anything else</dt>

     <dd>Append the Unicode character with the same code point as the value of the byte at <var>position</var> to <var>attribute value</var>.</dd>

    </dl>

   </li>

   <li><p>Advance <var>position</var> to the next byte and return to the previous
   step.</p></li>

  </ol>

  <p>For the sake of interoperability, user agents should not use a pre-scan algorithm that returns
  different results than the one described above. (But, if you do, please at least let us know, so
  that we can improve this algorithm and benefit everyone...)</p>

<!--(removed this since the specs are being changed)
  <p class="note">These algorithms are a <span>willful violation</span> of the HTTP specification,
  which requires that the encoding be assumed to be ISO-8859-1 in the absence of a <span>character
  encoding declaration</span> to the contrary, and of RFC 2046, which requires that the encoding be
  assumed to be US-ASCII in the absence of a <span>character encoding declaration</span> to the
  contrary. This specification's third approach is motivated by a desire to be maximally compatible
  with legacy content. <a href="#refsHTTP">\[HTTP]</a> <a href="#refsRFC2046">\[RFC2046]</a></p>
-->



  <h5 id="character-encodings">Character encodings</h5>

  <p>User agents must support the encodings defined in the WHATWG Encoding standard. User agents
  must not support other encodings.</p>

  <p class="note">The above prohibits supporting, for example, CESU-8, UTF-7, BOCU-1, SCSU, EBCDIC,
  and UTF-32. This specification does not make any attempt to support prohibited encodings in its
  algorithms; support and use of prohibited encodings would thus lead to unexpected behavior. <a
  href="#refsCESU8">\[CESU8]</a> <a href="#refsUTF7">\[UTF7]</a> <a href="#refsBOCU1">\[BOCU1]</a> <a href="#refsSCSU">\[SCSU]</a></p>


  <h5 id="changing-the-encoding-while-parsing">Changing the encoding while parsing</h5>

  <p>When the parser requires the user agent to <dfn>change the encoding</dfn>, it must run the
  following steps. This might happen if the <span>encoding sniffing algorithm</span> described above
  failed to find a character encoding, or if it found a character encoding that was not the actual
  encoding of the file.</p>

  <ol>

   <li><p>If the encoding that is already being used to interpret the input stream is a <span>UTF-16
   encoding</span>, then set the <span data-x="concept-encoding-confidence">confidence</span> to
   <i>certain</i> and abort these steps. The new encoding is ignored; if it was anything but the
   same encoding, then it would be clearly incorrect.</p></li>

   <!-- the next two steps are redundant with similar logic in the sniffer -->
   <!-- if you add anything else here, then factor it out into a common algorithm -->

   <li><p>If the new encoding is a <span>UTF-16 encoding</span>, change it to UTF-8.</p></li>

   <li><p>If the new encoding is the x-user-defined encoding, change it to Windows-1252. <a href="#refsENCODING">\[ENCODING]</a></p></li> <!-- apparently this was a Chrome invention, later
   picked up by Mozilla -->

   <li><p>If the new encoding is identical or equivalent to the encoding that is already being used
   to interpret the input stream, then set the <span
   data-x="concept-encoding-confidence">confidence</span> to <i>certain</i> and abort these steps.
   This happens when the encoding information found in the file matches what the <span>encoding
   sniffing algorithm</span> determined to be the encoding, and in the second pass through the
   parser if the first pass found that the encoding sniffing algorithm described in the earlier
   section failed to find the right encoding.</p></li>

   <li><p>If all the bytes up to the last byte converted by the current decoder have the same
   Unicode interpretations in both the current encoding and the new encoding, and if the user agent
   supports changing the converter on the fly, then the user agent may change to the new converter
   for the encoding on the fly. Set the <span>document's character encoding</span> and the encoding
   used to convert the input stream to the new encoding, set the <span
   data-x="concept-encoding-confidence">confidence</span> to <i>certain</i>, and abort these
   steps.</p></li>

   <li><p>Otherwise, <span>navigate</span><!--DONAV reparse--> to the document again, with
   <span>replacement enabled</span>, and using the same <span>source browsing context</span>, but
   this time skip the <span>encoding sniffing algorithm</span> and instead just set the encoding to
   the new encoding and the <span data-x="concept-encoding-confidence">confidence</span> to
   <i>certain</i>. Whenever possible, this should be done without actually contacting the network
   layer (the bytes should be re-parsed from memory), even if, e.g., the document is marked as not
   being cacheable. If this is not possible and contacting the network layer would involve repeating
   a request that uses a method other than <code>GET</code>), then instead set the <span
   data-x="concept-encoding-confidence">confidence</span> to <i>certain</i> and ignore the new
   encoding. The resource will be misinterpreted. User agents may notify the user of the situation,
   to aid in application development.</p></li>

  </ol>

  <p class="note">This algorithm is only invoked when a new encoding is found declared on a
  <code>meta</code> element.</p> <!-- this is important for the x-user-defined stuff in particular
  -->


  <h5 id="preprocessing-the-input-stream">Preprocessing the input stream</h5>

  <p>The <dfn>input stream</dfn> consists of the characters pushed into it as the <span>input byte
  stream</span> is decoded or from the various APIs that directly manipulate the input stream.</p>

  <p>One leading U+FEFF BYTE ORDER MARK character must be ignored if any are present in the
  <span>input stream</span>.</p>

  <p class="note">The requirement to strip a U+FEFF BYTE ORDER MARK character regardless of whether
  that character was used to determine the byte order is a <span>willful violation</span> of
  Unicode, motivated by a desire to increase the resilience of user agents in the face of na&iuml;ve
  transcoders.</p>

  <p>Any occurrences of any characters in the ranges U+0001 to U+0008, <!-- HT, LF allowed --> <!--
  U+000B is in the next list --> <!-- FF, CR allowed --> U+000E to U+001F, <!-- ASCII allowed -->
  U+007F <!--to U+0084, (U+0085 NEL not allowed), U+0086--> to U+009F, U+FDD0 to U+FDEF, and
  characters U+000B, U+FFFE, U+FFFF, U+1FFFE, U+1FFFF, U+2FFFE, U+2FFFF, U+3FFFE, U+3FFFF, U+4FFFE,
  U+4FFFF, U+5FFFE, U+5FFFF, U+6FFFE, U+6FFFF, U+7FFFE, U+7FFFF, U+8FFFE, U+8FFFF, U+9FFFE, U+9FFFF,
  U+AFFFE, U+AFFFF, U+BFFFE, U+BFFFF, U+CFFFE, U+CFFFF, U+DFFFE, U+DFFFF, U+EFFFE, U+EFFFF, U+FFFFE,
  U+FFFFF, U+10FFFE, and U+10FFFF are <span data-x="parse error">parse errors</span>. These are all
  <span>control characters</span> or permanently undefined Unicode characters (noncharacters).</p>

  <p>Any <span>character</span> that is a not a <span>Unicode character</span>, i.e. any isolated
  surrogate, is a <span>parse error</span>. (These can only find their way into the input stream via
  script APIs such as <code data-x="dom-document-write">document.write()</code>.)</p>

  <p>U+000D CARRIAGE RETURN (CR) characters and U+000A LINE FEED (LF) characters are treated
  specially. Any LF character that immediately follows a CR character must be ignored, and all CR
  characters must then be converted to LF characters. Thus, newlines in HTML DOMs are represented by
  LF characters, and there are never any CR characters in the input to the <span>tokenization</span>
  stage.</p>

  <p>The <dfn>next input character</dfn> is the first character in the <span>input stream</span>
  that has not yet been <dfn>consumed</dfn> or explicitly ignored by the requirements in
  this section. Initially, the <i data-x="next input character">next input character</i> is the
  first character in the input. The <dfn>current input character</dfn> is the last character to have
  been <i>consumed</i>.</p>

  <p>The <dfn>insertion point</dfn> is the position (just before a character or just before the end
  of the input stream) where content inserted using <code
  data-x="dom-document-write">document.write()</code> is actually inserted. The insertion point is
  relative to the position of the character immediately after it, it is not an absolute offset into
  the input stream. Initially, the insertion point is undefined.</p>

  <p>The "EOF" character in the tables below is a conceptual character representing the end of the
  <span>input stream</span>. If the parser is a <span>script-created parser</span>, then the end of
  the <span>input stream</span> is reached when an <dfn>explicit "EOF" character</dfn> (inserted by
  the <code data-x="dom-document-close">document.close()</code> method) is consumed. Otherwise, the
  "EOF" character is not a real character in the stream, but rather the lack of any further
  characters.</p>

  <p class="note">The handling of U+0000 NULL characters varies based on where the characters are
  found. In general, they are ignored except where doing so could plausibly introduce an attack
  vector. This handling is, by necessity, spread across both the tokenization stage and the tree
  construction stage.</p>

  </div>


  <div class="impl">

  <h4 id="parse-state">Parse state</h4>

  <h5 id="the-insertion-mode">The insertion mode</h5>

  <p>The <dfn>insertion mode</dfn> is a state variable that controls the primary operation of the
  tree construction stage.</p>

  <p>Initially, the <span>insertion mode</span> is "<span data-x="insertion mode:
  initial">initial</span>". It can change to "<span data-x="insertion mode: before html">before
  html</span>", "<span data-x="insertion mode: before head">before head</span>", "<span
  data-x="insertion mode: in head">in head</span>", "<span data-x="insertion mode: in head
  noscript">in head noscript</span>", "<span data-x="insertion mode: after head">after head</span>",
  "<span data-x="insertion mode: in body">in body</span>", "<span data-x="insertion mode:
  text">text</span>", "<span data-x="insertion mode: in table">in table</span>", "<span
  data-x="insertion mode: in table text">in table text</span>", "<span data-x="insertion mode: in
  caption">in caption</span>", "<span data-x="insertion mode: in column group">in column
  group</span>", "<span data-x="insertion mode: in table body">in table body</span>", "<span
  data-x="insertion mode: in row">in row</span>", "<span data-x="insertion mode: in cell">in
  cell</span>", "<span data-x="insertion mode: in select">in select</span>", "<span data-x="insertion
  mode: in select in table">in select in table</span>", "<span data-x="insertion mode: in
  template">in template</span>", "<span data-x="insertion mode: after body">after body</span>",
  "<span data-x="insertion mode: in frameset">in frameset</span>", "<span data-x="insertion mode:
  after frameset">after frameset</span>", "<span data-x="insertion mode: after after body">after
  after body</span>", and "<span data-x="insertion mode: after after frameset">after after
  frameset</span>" during the course of the parsing, as described in the <span>tree
  construction</span> stage. The insertion mode affects how tokens are processed and whether CDATA
  sections are supported.</p>

  <p>Several of these modes, namely "<span data-x="insertion mode: in head">in head</span>", "<span
  data-x="insertion mode: in body">in body</span>", "<span data-x="insertion mode: in table">in
  table</span>", and "<span data-x="insertion mode: in select">in select</span>", are special, in
  that the other modes defer to them at various times. When the algorithm below says that the user
  agent is to do something "<dfn>using the rules for</dfn> the <var>m</var> insertion
  mode", where <var>m</var> is one of these modes, the user agent must use the rules
  described under the <var>m</var> <span>insertion mode</span>'s section, but must leave
  the <span>insertion mode</span> unchanged unless the rules in <var>m</var> themselves
  switch the <span>insertion mode</span> to a new value.</p>

  <p>When the insertion mode is switched to "<span data-x="insertion mode: text">text</span>" or
  "<span data-x="insertion mode: in table text">in table text</span>", the <dfn>original insertion
  mode</dfn> is also set. This is the insertion mode to which the tree construction stage will
  return.</p>

  <p>Similarly, to parse nested <code>template</code> elements, a <dfn>stack of template insertion
  modes</dfn> is used. It is initially empty. The <dfn>current template insertion mode</dfn> is the
  insertion mode that was most recently added to the <span>stack of template insertion modes</span>.
  The algorithms in the sections below will <i>push</i> insertion modes onto this stack, meaning
  that the specified insertion mode is to be added to the stack, and <i>pop</i> insertion modes from
  the stack, which means that the most recently added insertion mode must be removed from the
  stack.</p>

  <hr>

  <p>When the steps below require the UA to <dfn>reset the insertion mode appropriately</dfn>, it
  means the UA must follow these steps:</p>

  <ol>

   <li><p>Let <var>last</var> be false.</p></li>

   <li><p>Let <var>node</var> be the last node in the <span>stack of open
   elements</span>.</p></li>

   <li><p><i>Loop</i>: If <var>node</var> is the first node in the stack of open elements,
   then set <var>last</var> to true, and, if the parser was originally created as part of
   the <span>HTML fragment parsing algorithm</span> (<span>fragment case</span>), set <var>node</var> to the <var data-x="concept-frag-parse-context">context</var>
   element passed to that algorithm.</p></li>

   <li>

    <p>If <var>node</var> is a <code>select</code> element, run these substeps:</p>

    <ol>

     <li><p>If <var>last</var> is true, jump to the step below labeled
     <i>done</i>.</p></li>

     <li><p>Let <var>ancestor</var> be <var>node</var>.</p></li>

     <li><p><i>Loop</i>: If <var>ancestor</var> is the first node in the <span>stack of
     open elements</span>, jump to the step below labeled <i>done</i>.</p></li>

     <li><p>Let <var>ancestor</var> be the node before <var>ancestor</var> in the
     <span>stack of open elements</span>.</p></li>

     <li><p>If <var>ancestor</var> is a <code>template</code> node, jump to the step below
     labeled <i>done</i>.</p></li>

     <li><p>If <var>ancestor</var> is a <code>table</code> node, switch the <span>insertion
     mode</span> to "<span data-x="insertion mode: in select in table">in select in table</span>" and
     abort these steps.</p></li> <!-- consider
     <table><tr><td><select><template></template><caption></table>
     http://software.hixie.ch/utilities/js/live-dom-viewer/saved/2374 -->

     <li><p>Jump back to the step labeled <i>loop</i>.</p></li>

     <li><p><i>Done</i>: Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in
     select">in select</span>" and abort these steps.</p></li>

    </ol>

   </li>

   <li><p>If <var>node</var> is a <code>td</code> or <code>th</code> element and <var>last</var> is false, then switch the <span>insertion mode</span> to "<span
   data-x="insertion mode: in cell">in cell</span>" and abort these steps.</p></li>

   <li><p>If <var>node</var> is a <code>tr</code> element, then switch the <span>insertion
   mode</span> to "<span data-x="insertion mode: in row">in row</span>" and abort these
   steps.</p></li>

   <li><p>If <var>node</var> is a <code>tbody</code>, <code>thead</code>, or
   <code>tfoot</code> element, then switch the <span>insertion mode</span> to "<span
   data-x="insertion mode: in table body">in table body</span>" and abort these steps.</p></li>

   <li><p>If <var>node</var> is a <code>caption</code> element, then switch the
   <span>insertion mode</span> to "<span data-x="insertion mode: in caption">in caption</span>" and
   abort these steps.</p></li>

   <li><p>If <var>node</var> is a <code>colgroup</code> element, then switch the
   <span>insertion mode</span> to "<span data-x="insertion mode: in column group">in column
   group</span>" and abort these steps.</p></li>

   <li><p>If <var>node</var> is a <code>table</code> element, then switch the
   <span>insertion mode</span> to "<span data-x="insertion mode: in table">in table</span>" and abort
   these steps.</p></li>

   <li><p>If <var>node</var> is a <code>template</code> element, then switch the
   <span>insertion mode</span> to the <span>current template insertion mode</span> and abort these
   steps.</p></li>

   <!-- <li><p>If <var>node</var> is a <code>head</code> element and <var>last</var> is true, then switch the <span>insertion mode</span> to "<span
   data-x="insertion mode: in body">in body</span>" ("<span data-x="insertion mode: in body">in
   body</span>"! <em> not "<span data-x="insertion mode: in head">in head</span>"</em>!) and abort
   these steps. (<span>fragment case</span>)</p></li> --><!-- The above is only here in case people
   think that the spec accidentally omitted it and try to "fix" it. Note that noscript-in-head is
   also handled this way. This is all intentional. The only thing it doesn't handle is the
   scripting-disabled fragment parsing case for a <head> element containing a <noscript> which
   itself contains something other than a <link> or a <style> element; you'd expect that to break
   out of the <noscript> but it doesn't. This is an edge case that doesn't affect the spec, since
   the algorithm for fragment parsing is only used for innerHTML/outerHTML/insertAdjacentHTML(),
   where we know scripting is enabled. -->

   <li><p>If <var>node</var> is a <code>head</code> element and <var>last</var> is
   false, then switch the <span>insertion mode</span> to "<span data-x="insertion mode: in head">in
   head</span>" and abort these steps.</p></li> <!-- for the case of <head><template></template>...
   -->

   <li><p>If <var>node</var> is a <code>body</code> element, then switch the
   <span>insertion mode</span> to "<span data-x="insertion mode: in body">in body</span>" and abort
   these steps.</p></li>

   <li><p>If <var>node</var> is a <code>frameset</code> element, then switch the
   <span>insertion mode</span> to "<span data-x="insertion mode: in frameset">in frameset</span>" and
   abort these steps. (<span>fragment case</span>)</p></li>

   <li>

    <p>If <var>node</var> is an <code>html</code> element, run these substeps:</p>

    <ol>

     <li><p>If the <span><code>head</code> element pointer</span> is null, switch the
     <span>insertion mode</span> to "<span data-x="insertion mode: before head">before head</span>"
     and abort these steps. (<span>fragment case</span>)</p></li>

     <li><p>Otherwise, the <span><code>head</code> element pointer</span> is not null, switch the
     <span>insertion mode</span> to "<span data-x="insertion mode: after head">after head</span>" and
     abort these steps.</p></li> <!-- consider <html><head></head><template></template> -->

    </ol>

   </li>

   <li><p>If <var>last</var> is true, then switch the <span>insertion mode</span> to "<span
   data-x="insertion mode: in body">in body</span>" and abort these steps. (<span>fragment
   case</span>)</p></li>

   <li><p>Let <var>node</var> now be the node before <var>node</var> in the
   <span>stack of open elements</span>.</p></li>

   <li><p>Return to the step labeled <i>loop</i>.</p></li>

  </ol>


  <h5 id="the-stack-of-open-elements">The stack of open elements</h5>

  <p>Initially, the <dfn>stack of open elements</dfn> is empty. The stack grows downwards; the
  topmost node on the stack is the first one added to the stack, and the bottommost node of the
  stack is the most recently added node in the stack (notwithstanding when the stack is manipulated
  in a random access fashion as part of <a href="#adoptionAgency">the handling for misnested
  tags</a>).</p>

  <p class="note">The "<span data-x="insertion mode: before html">before html</span>" <span>insertion
  mode</span> creates the <code>html</code> root element node, which is then added to the stack.</p>

  <p class="note">In the <span>fragment case</span>, the <span>stack of open elements</span> is
  initialized to contain an <code>html</code> element that is created as part of <span data-x="html
  fragment parsing algorithm">that algorithm</span>. (The <span>fragment case</span> skips the
  "<span data-x="insertion mode: before html">before html</span>" <span>insertion mode</span>.)</p>

  <p>The <code>html</code> node, however it is created, is the topmost node of the stack. It only
  gets popped off the stack when the parser <span data-x="stop parsing">finishes</span>.</p>

  <p>The <dfn>current node</dfn> is the bottommost node in this <span>stack of open
  elements</span>.</p>

  <p>The <dfn>adjusted current node</dfn> is the <i data-x="concept-frag-parse-context">context</i>
  element if the parser was created by the <span>HTML fragment parsing algorithm</span> and the
  <span>stack of open elements</span> has only one element in it (<span>fragment case</span>);
  otherwise, the <span>adjusted current node</span> is the <span>current node</span>.</p>

  <p>Elements in the <span>stack of open elements</span> fall into the following categories:</p>

  <dl>

   <dt><dfn>Special</dfn></dt>

   <dd><p>The following elements have varying levels of special parsing rules: HTML's
   <code>address</code>, <code>applet</code>, <code>area</code>, <code>article</code>,
   <code>aside</code>, <code>base</code>, <code>basefont</code>, <code>bgsound</code>,
   <code>blockquote</code>, <code>body</code>, <code>br</code>, <code>button</code>,
   <code>caption</code>, <code>center</code>, <code>col</code>, <code>colgroup</code>,
   <code>dd</code>, <code>details</code>, <code>dir</code>, <code>div</code>, <code>dl</code>,
   <code>dt</code>, <code>embed</code>, <code>fieldset</code>, <code>figcaption</code>,
   <code>figure</code>, <code>footer</code>, <code>form</code>, <code>frame</code>,
   <code>frameset</code>, <code>h1</code>, <code>h2</code>, <code>h3</code>, <code>h4</code>,
   <code>h5</code>, <code>h6</code>, <code>head</code>, <code>header</code>,
   <code>hr</code>, <code>html</code>, <code>iframe</code>, <!-- <code>image</code>, (commented out
   because this isn't an element that can end up on the stack, so it doesn't matter) -->
   <code>img</code>, <code>input</code>, <code>isindex</code>, <code>li</code>, <code>link</code>,
   <code>listing</code>, <code>main</code>, <code>marquee</code>, <code>menu</code>,
   <code>menuitem</code>, <code>meta</code>, <code>nav</code>, <code>noembed</code>,
   <code>noframes</code>, <code>noscript</code>, <code>object</code>, <code>ol</code>,
   <code>p</code>, <code>param</code>, <code>plaintext</code>, <code>pre</code>,
   <code>script</code>, <code>section</code>, <code>select</code>, <code>source</code>,
   <code>style</code>, <code>summary</code>, <code>table</code>, <code>tbody</code>,
   <code>td</code>, <code>template</code>, <code>textarea</code>, <code>tfoot</code>,
   <code>th</code>, <code>thead</code>, <code>title</code>, <code>tr</code>, <code>track</code>,
   <code>ul</code>, <code>wbr</code>, and <code>xmp</code>; MathML's <code
   data-x="math:mi">mi</code>, <code data-x="math:mo">mo</code>, <code data-x="math:mn">mn</code>,
   <code data-x="math:ms">ms</code>, <code data-x="math:mtext">mtext</code>, and <code
   data-x="math:annotation-xml">annotation-xml</code>; and SVG's <code
  >foreignObject</code>, <code>desc</code>, and <code
  >title</code>.</p></dd> <!-- we could actually put all non-HTML elements in this list, I
   think -->

   <dt><dfn>Formatting</dfn></dt>
   <dd><p>The following HTML elements are those that end up in the <span>list of active formatting
   elements</span>: <code>a</code>, <code>b</code>, <code>big</code>, <code>code</code>,
   <code>em</code>, <code>font</code>, <code>i</code>, <code>nobr</code>, <code>s</code>,
   <code>small</code>, <code>strike</code>, <code>strong</code>, <code>tt</code>, and
   <code>u</code>.</p></dd>

   <dt><dfn>Ordinary</dfn></dt>
   <dd><p>All other elements found while parsing an HTML document.</p></dd>

  </dl>

  <p>The <span>stack of open elements</span> is said to <dfn data-x="has an element in the specific
  scope">have an element <var>target node</var> in a specific scope</dfn> consisting of a
  list of element types <var>list</var> when the following algorithm terminates in a match
  state:</p>

  <ol>

   <li><p>Initialize <var>node</var> to be the <span>current node</span> (the bottommost
   node of the stack).</p></li>

   <li><p>If <var>node</var> is the target node, terminate in a match state.</p></li>

   <li><p>Otherwise, if <var>node</var> is one of the element types in <var>list</var>, terminate in a failure state.</p></li>

   <li><p>Otherwise, set <var>node</var> to the previous entry in the <span>stack of open
   elements</span> and return to step 2. (This will never fail, since the loop will always terminate
   in the previous step if the top of the stack &mdash; an <code>html</code> element &mdash; is
   reached.)</p></li>

  </ol>

  <p>The <span>stack of open elements</span> is said to <dfn data-x="has an element in scope">have a
  particular element in scope</dfn> when it <span data-x="has an element in the specific scope">has
  that element in the specific scope</span> consisting of the following element types:</p>

  <ul class="brief">
   <li><code>applet</code> in the <span>HTML namespace</span></li>
   <li><code>caption</code> in the <span>HTML namespace</span></li>
   <li><code>html</code> in the <span>HTML namespace</span></li> <!-- (This can only happen if the <var>node</var> is the topmost node of the <span>stack of open elements</span>, and prevents the next step from being invoked if there are no more elements in the stack.) -->
   <li><code>table</code> in the <span>HTML namespace</span></li>
   <li><code>td</code> in the <span>HTML namespace</span></li>
   <li><code>th</code> in the <span>HTML namespace</span></li>
   <li><code>marquee</code> in the <span>HTML namespace</span></li>
   <li><code>object</code> in the <span>HTML namespace</span></li>
   <li><code>template</code> in the <span>HTML namespace</span></li>
   <li><code data-x="math:mi">mi</code> in the <span>MathML namespace</span></li>
   <li><code data-x="math:mo">mo</code> in the <span>MathML namespace</span></li>
   <li><code data-x="math:mn">mn</code> in the <span>MathML namespace</span></li>
   <li><code data-x="math:ms">ms</code> in the <span>MathML namespace</span></li>
   <li><code data-x="math:mtext">mtext</code> in the <span>MathML namespace</span></li>
   <li><code data-x="math:annotation-xml">annotation-xml</code> in the <span>MathML namespace</span></li>
   <li><code>foreignObject</code> in the <span>SVG namespace</span></li>
   <li><code>desc</code> in the <span>SVG namespace</span></li>
   <li><code>title</code> in the <span>SVG namespace</span></li>
  </ul>

  <p>The <span>stack of open elements</span> is said to <dfn data-x="has an element in list item
  scope">have a particular element in list item scope</dfn> when it <span data-x="has an element in
  the specific scope">has that element in the specific scope</span> consisting of the following
  element types:</p>

  <ul class="brief">
   <li>All the element types listed above for the <i data-x="has an element in scope">has an element in scope</i> algorithm.</li>
   <li><code>ol</code> in the <span>HTML namespace</span></li>
   <li><code>ul</code> in the <span>HTML namespace</span></li>
  </ul>

  <p>The <span>stack of open elements</span> is said to <dfn data-x="has an element in button
  scope">have a particular element in button scope</dfn> when it <span data-x="has an element in the
  specific scope">has that element in the specific scope</span> consisting of the following element
  types:</p>

  <ul class="brief">
   <li>All the element types listed above for the <i data-x="has an element in scope">has an element in scope</i> algorithm.</li>
   <li><code>button</code> in the <span>HTML namespace</span></li>
  </ul>

  <p>The <span>stack of open elements</span> is said to <dfn data-x="has an element in table
  scope">have a particular element in table scope</dfn> when it <span data-x="has an element in the
  specific scope">has that element in the specific scope</span> consisting of the following element
  types:</p>

  <ul class="brief">
   <li><code>html</code> in the <span>HTML namespace</span></li> <!-- (This can only happen if the
   <var>node</var> is the topmost node of the <span>stack of open elements</span>, and
   prevents the next step from being invoked if there are no more elements in the stack.) -->
   <li><code>table</code> in the <span>HTML namespace</span></li>
   <li><code>template</code> in the <span>HTML namespace</span></li>
  </ul>

  <p>The <span>stack of open elements</span> is said to <dfn data-x="has an element in select
  scope">have a particular element in select scope</dfn> when it <span data-x="has an element in the
  specific scope">has that element in the specific scope</span> consisting of all element types
  <em>except</em> the following:</p>

  <ul class="brief">
   <!--<li><code>select</code> in the <span>HTML namespace</span></li>-->
   <li><code>optgroup</code> in the <span>HTML namespace</span></li>
   <li><code>option</code> in the <span>HTML namespace</span></li>
  </ul>

  <p>Nothing happens if at any time any of the elements in the <span>stack of open elements</span>
  are moved to a new location in, or removed from, the <code>Document</code> tree. In particular,
  the stack is not changed in this situation. This can cause, amongst other strange effects, content
  to be appended to nodes that are no longer in the DOM.</p>

  <p class="note">In some cases (namely, when <a href="#adoptionAgency">closing misnested formatting
  elements</a>), the stack is manipulated in a random-access fashion.</p>


  <h5 id="the-list-of-active-formatting-elements">The list of active formatting elements</h5>

  <p>Initially, the <dfn>list of active formatting elements</dfn> is empty. It is used to handle
  mis-nested <span data-x="formatting">formatting element tags</span>.</p>

  <p>The list contains elements in the <span>formatting</span> category, and <span
  data-x="concept-parser-marker">markers</span>. The <dfn
  data-x="concept-parser-marker">markers</dfn> are inserted when entering <code>applet</code>
  elements, buttons, <code>object</code> elements, marquees, table cells, and table captions, and
  are used to prevent formatting from "leaking" <em>into</em> <code>applet</code> elements, buttons,
  <code>object</code> elements, marquees, and tables.</p>

  <p>In addition, each element in the <span>list of active formatting elements</span> is associated
  with the token for which it was created, so that further elements can be created for that token if
  necessary.</p>

  <p>When the steps below require the UA to <dfn>push onto the list of active formatting
  elements</dfn> an element <var>element</var>, the UA must perform the following
  steps:</p>

  <ol id="noah">

   <li><p>If there are already three elements in the <span>list of active formatting elements</span>
   after the last <span data-x="concept-parser-marker">marker</span>, if any, or anywhere in the
   list if there are no <span data-x="concept-parser-marker">markers</span>, that have the same tag
   name, namespace, and attributes as <var>element</var>, then remove the earliest such
   element from the <span>list of active formatting elements</span>. For these purposes, the
   attributes must be compared as they were when the elements were created by the parser; two
   elements have the same attributes if all their parsed attributes can be paired such that the two
   attributes in each pair have identical names, namespaces, and values (the order of the attributes
   does not matter).</p>

   <p class="note">This is the Noah's Ark clause. But with three per family instead of two.</p></li>
   <!-- A sort of polyamorous Noah's Ark, if you will. -->

   <li><p>Add <var>element</var> to the <span>list of active formatting
   elements</span>.</p></li>

  </ol>

  <p>When the steps below require the UA to <dfn>reconstruct the active formatting elements</dfn>,
  the UA must perform the following steps:</p>

  <ol>

   <li><p>If there are no entries in the <span>list of active formatting elements</span>, then there
   is nothing to reconstruct; stop this algorithm.</p></li>

   <li><p>If the last (most recently added) entry in the <span>list of active formatting
   elements</span> is a <span data-x="concept-parser-marker">marker</span>, or if it is an element
   that is in the <span>stack of open elements</span>, then there is nothing to reconstruct; stop
   this algorithm.</p></li>

   <li><p>Let <var>entry</var> be the last (most recently added) element in the <span>list
   of active formatting elements</span>.</p></li>

   <li><p><i>Rewind</i>: If there are no entries before <var>entry</var> in the <span>list
   of active formatting elements</span>, then jump to the step labeled <i>create</i>.</p></li>

   <li><p>Let <var>entry</var> be the entry one earlier than <var>entry</var> in
   the <span>list of active formatting elements</span>.</p></li>

   <li><p>If <var>entry</var> is neither a <span
   data-x="concept-parser-marker">marker</span> nor an element that is also in the <span>stack of
   open elements</span>, go to the step labeled <i>rewind</i>.</p></li>

   <li><p><i>Advance</i>: Let <var>entry</var> be the element one later than <var>entry</var> in the <span>list of active formatting elements</span>.</p></li>

   <li><p><i>Create</i>: <span>Insert an HTML element</span> for the token for which the element
   <var>entry</var> was created, to obtain <var>new element</var>.</p></li>

   <li><p>Replace the entry for <var>entry</var> in the list with an entry for <var>new element</var>.</p></li>

   <li><p>If the entry for <var>new element</var> in the <span>list of active formatting
   elements</span> is not the last entry in the list, return to the step labeled
   <i>advance</i>.</p></li>

  </ol>

  <p>This has the effect of reopening all the formatting elements that were opened in the current
  body, cell, or caption (whichever is youngest) that haven't been explicitly closed.</p>

  <p class="note">The way this specification is written, the <span>list of active formatting
  elements</span> always consists of elements in chronological order with the least recently added
  element first and the most recently added element last (except for while steps 8 to 10 of the
  above algorithm are being executed, of course).</p>

  <p>When the steps below require the UA to <dfn>clear the list of active formatting elements up to
  the last marker</dfn>, the UA must perform the following steps:</p>

  <ol>

   <li><p>Let <var>entry</var> be the last (most recently added) entry in the <span>list of
   active formatting elements</span>.</p></li>

   <li><p>Remove <var>entry</var> from the <span>list of active formatting
   elements</span>.</p></li>

   <li><p>If <var>entry</var> was a <span data-x="concept-parser-marker">marker</span>,
   then stop the algorithm at this point. The list has been cleared up to the last <span
   data-x="concept-parser-marker">marker</span>.</p></li>

   <li><p>Go to step 1.</p></li>

  </ol>


  <h5 id="the-element-pointers">The element pointers</h5>

  <p>Initially, the <dfn><code>head</code> element pointer</dfn> and the <dfn><code
 >form</code> element pointer</dfn> are both null.</p>

  <p>Once a <code>head</code> element has been parsed (whether implicitly or explicitly) the
  <span><code>head</code> element pointer</span> gets set to point to this node.</p>

  <p>The <span><code>form</code> element pointer</span> points to the last
  <code>form</code> element that was opened and whose end tag has not yet been seen. It is used to
  make form controls associate with forms in the face of dramatically bad markup, for historical
  reasons. It is ignored inside <code>template</code> elements.</p>


  <h5 id="other-parsing-state-flags">Other parsing state flags</h5>

  <p>The <dfn>scripting flag</dfn> is set to "enabled" if <span data-x="concept-n-script">scripting
  was enabled</span> for the <code>Document</code> with which the parser is associated when the
  parser was created, and "disabled" otherwise.</p>

  <p class="note">The <span>scripting flag</span> can be enabled even when the parser was originally
  created for the <span>HTML fragment parsing algorithm</span>, even though <code>script</code>
  elements don't execute in that case.</p>

  <p>The <dfn>frameset-ok flag</dfn> is set to "ok" when the parser is created. It is set to "not
  ok" after certain tokens are seen.</p>

  </div>


  <div class="impl">

  <h4 id="tokenization"><dfn>Tokenization</dfn></h4>

  <p>Implementations must act as if they used the following state machine to tokenize HTML. The
  state machine must start in the <span>data state</span>. Most states consume a single character,
  which may have various side-effects, and either switches the state machine to a new state to
  <i>reconsume</i> the same character, or switches it to a new state to consume the next character,
  or stays in the same state to consume the next character. Some states have more complicated
  behavior and can consume several characters before switching to another state. In some cases, the
  tokenizer state is also changed by the tree construction stage.</p>

  <p>The exact behavior of certain states depends on the <span>insertion mode</span> and the
  <span>stack of open elements</span>. Certain states also use a <dfn><var data-x="temporary
  buffer">temporary buffer</var></dfn> to track progress.</p>

  <p>The output of the tokenization step is a series of zero or more of the following tokens:
  DOCTYPE, start tag, end tag, comment, character, end-of-file. DOCTYPE tokens have a name, a public
  identifier, a system identifier, and a <dfn><i>force-quirks flag</i></dfn>. When a DOCTYPE token
  is created, its name, public identifier, and system identifier must be marked as missing (which is
  a distinct state from the empty string), and the <i data-x="force-quirks flag">force-quirks flag</i> must be set to
  <i>off</i> (its other state is <i>on</i>). Start and end tag tokens have a tag name, a <dfn
  data-x="self-closing flag">self-closing flag</dfn>, and a list of attributes, each of which has a
  name and a value. When a start or end tag token is created, its <i data-x="self-closing
  flag">self-closing flag</i> must be unset (its other state is that it be set), and its attributes
  list must be empty. Comment and character tokens have data.</p>

  <p>When a token is emitted, it must immediately be handled by the <span>tree construction</span>
  stage. The tree construction stage can affect the state of the tokenization stage, and can insert
  additional characters into the stream. (For example, the <code>script</code> element can result in
  scripts executing and using the <span>dynamic markup insertion</span> APIs to insert characters
  into the stream being tokenized.)</p>

  <p class="note">Creating a token and emitting it are distinct actions. It is possible for a token
  to be created but implicitly abandoned (never emitted), e.g. if the file ends unexpectedly while
  processing the characters that are being parsed into a start tag token.</p>

  <p>When a start tag token is emitted with its <i data-x="self-closing flag">self-closing flag</i> set, if the flag is not
  <dfn data-x="acknowledge self-closing flag">acknowledged</dfn> when it is processed by the tree
  construction stage, that is a <span>parse error</span>.</p>

  <p>When an end tag token is emitted with attributes, that is a <span>parse error</span>.</p>

  <p>When an end tag token is emitted with its <i data-x="self-closing flag">self-closing flag</i> set, that is a <span>parse
  error</span>.</p>

  <p>An <dfn>appropriate end tag token</dfn> is an end tag token whose tag name matches the tag name
  of the last start tag to have been emitted from this tokenizer, if any. If no start tag has been
  emitted from this tokenizer, then no end tag token is appropriate.</p>

  <p>Before each step of the tokenizer, the user agent must first check the <span>parser pause
  flag</span>. If it is true, then the tokenizer must abort the processing of any nested invocations
  of the tokenizer, yielding control back to the caller.</p>

  <p>The tokenizer state machine consists of the states defined in the following subsections.</p>


  <!-- Order of the lists below is supposed to be non-error then error, by unicode, then EOF, ending
  with "anything else" -->


  <h5 id="data-state"><dfn>Data state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0026 AMPERSAND (&amp;)</dt>
   <dd>Switch to the <span>character reference in data state</span>.</dd>

   <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
   <dd>Switch to the <span>tag open state</span>.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Emit the <span>current input character</span> as a character
   token.</dd>

   <dt>EOF</dt>
   <dd>Emit an end-of-file token.</dd>

   <dt>Anything else</dt>
   <dd>Emit the <span>current input character</span> as a character token.</dd>

  </dl>


  <h5 id="character-reference-in-data-state"><dfn>Character reference in data state</dfn></h5>

  <p>Switch to the <span>data state</span>.</p>

  <p>Attempt to <span>consume a character reference</span>, with no <span>additional allowed
  character</span>.</p>

  <p>If nothing is returned, emit a U+0026 AMPERSAND character (&amp;) token.</p>

  <p>Otherwise, emit the character tokens that were returned.</p>


  <h5 id="rcdata-state"><dfn>RCDATA state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0026 AMPERSAND (&amp;)</dt>
   <dd>Switch to the <span>character reference in RCDATA state</span>.</dd>

   <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
   <dd>Switch to the <span>RCDATA less-than sign state</span>.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Emit a U+FFFD REPLACEMENT CHARACTER character token.</dd>

   <dt>EOF</dt>
   <dd>Emit an end-of-file token.</dd>

   <dt>Anything else</dt>
   <dd>Emit the <span>current input character</span> as a character token.</dd>

  </dl>


  <h5 id="character-reference-in-rcdata-state"><dfn>Character reference in RCDATA state</dfn></h5>

  <p>Switch to the <span>RCDATA state</span>.</p>

  <p>Attempt to <span>consume a character reference</span>, with no <span>additional allowed
  character</span>.</p>

  <p>If nothing is returned, emit a U+0026 AMPERSAND character (&amp;) token.</p>

  <p>Otherwise, emit the character tokens that were returned.</p>


  <h5 id="rawtext-state"><dfn>RAWTEXT state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
   <dd>Switch to the <span>RAWTEXT less-than sign state</span>.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Emit a U+FFFD REPLACEMENT CHARACTER character token.</dd>

   <dt>EOF</dt>
   <dd>Emit an end-of-file token.</dd>

   <dt>Anything else</dt>
   <dd>Emit the <span>current input character</span> as a character token.</dd>

  </dl>


  <h5 id="script-data-state"><dfn>Script data state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
   <dd>Switch to the <span>script data less-than sign state</span>.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Emit a U+FFFD REPLACEMENT CHARACTER character token.</dd>

   <dt>EOF</dt>
   <dd>Emit an end-of-file token.</dd>

   <dt>Anything else</dt>
   <dd>Emit the <span>current input character</span> as a character token.</dd>

  </dl>


  <h5 id="plaintext-state"><dfn>PLAINTEXT state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Emit a U+FFFD REPLACEMENT CHARACTER character token.</dd>

   <dt>EOF</dt>
   <dd>Emit an end-of-file token.</dd>

   <dt>Anything else</dt>
   <dd>Emit the <span>current input character</span> as a character token.</dd>

  </dl>


  <h5 id="tag-open-state"><dfn>Tag open state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0021 EXCLAMATION MARK (!)</dt>
   <dd>Switch to the <span>markup declaration open state</span>.</dd>

   <dt>U+002F SOLIDUS (/)</dt>
   <dd>Switch to the <span>end tag open state</span>.</dd>

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Create a new start tag token, set its tag name to the lowercase version of the <span>current
   input character</span> (add 0x0020 to the character's code point), then switch to the <span>tag
   name state</span>. (Don't emit the token yet; further details will be filled in before it is
   emitted.)</dd>

   <dt><span data-x="lowercase ASCII letters">Lowercase ASCII letter</span></dt>
   <dd>Create a new start tag token, set its tag name to the <span>current input character</span>,
   then switch to the <span>tag name state</span>. (Don't emit the token yet; further details will
   be filled in before it is emitted.)</dd>

   <dt>U+003F QUESTION MARK (?)</dt>
   <dd><span>Parse error</span>. Switch to the <span>bogus comment state</span>.</dd>

   <dt>Anything else</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Emit a U+003C LESS-THAN SIGN
   character token. Reconsume the <span>current input character</span>.</dd>

  </dl>

  <h5 id="end-tag-open-state"><dfn>End tag open state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Create a new end tag token, set its tag name to the lowercase version of the <span>current
   input character</span> (add 0x0020 to the character's code point), then switch to the <span>tag
   name state</span>. (Don't emit the token yet; further details will be filled in before it is
   emitted.)</dd>

   <dt><span data-x="lowercase ASCII letters">Lowercase ASCII letter</span></dt>
   <dd>Create a new end tag token, set its tag name to the <span>current input character</span>,
   then switch to the <span>tag name state</span>. (Don't emit the token yet; further details will
   be filled in before it is emitted.)</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Emit a U+003C LESS-THAN SIGN
   character token and a U+002F SOLIDUS character token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd><span>Parse error</span>. Switch to the <span>bogus comment state</span>.</dd>

  </dl>


  <h5 id="tag-name-state"><dfn>Tag name state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Switch to the <span>before attribute name state</span>.</dd>

   <dt>U+002F SOLIDUS (/)</dt>
   <dd>Switch to the <span>self-closing start tag state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>data state</span>. Emit the current tag token.</dd>

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Append the lowercase version of the <span>current input character</span> (add 0x0020 to the
   character's code point) to the current tag token's tag name.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append a U+FFFD REPLACEMENT CHARACTER character to the current tag
   token's tag name.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd>Append the <span>current input character</span> to the current tag token's tag name.</dd>

  </dl>


  <h5 id="rcdata-less-than-sign-state"><dfn>RCDATA less-than sign state</dfn></h5>
  <!-- identical to the RAWTEXT less-than sign state, except s/RAWTEXT/RCDATA/g -->

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002F SOLIDUS (/)</dt>
   <dd>Set the <var data-x="temporary buffer">temporary buffer</var> to the empty string. Switch to
   the <span>RCDATA end tag open state</span>.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>RCDATA state</span>. Emit a U+003C LESS-THAN SIGN character token.
   Reconsume the <span>current input character</span>.</dd>

  </dl>


  <h5 id="rcdata-end-tag-open-state"><dfn>RCDATA end tag open state</dfn></h5>
  <!-- identical to the RAWTEXT (and Script data) end tag open state, except s/RAWTEXT/RCDATA/g -->

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Create a new end tag token, and set its tag name to the lowercase version of the
   <span>current input character</span> (add 0x0020 to the character's code point). Append the
   <span>current input character</span> to the <var data-x="temporary buffer">temporary
   buffer</var>. Finally, switch to the <span>RCDATA end tag name state</span>. (Don't emit the
   token yet; further details will be filled in before it is emitted.)</dd>

   <dt><span data-x="lowercase ASCII letters">Lowercase ASCII letter</span></dt>
   <dd>Create a new end tag token, and set its tag name to the <span>current input character</span>.
   Append the <span>current input character</span> to the <var data-x="temporary buffer">temporary
   buffer</var>. Finally, switch to the <span>RCDATA end tag name state</span>. (Don't emit the
   token yet; further details will be filled in before it is emitted.)</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>RCDATA state</span>. Emit a U+003C LESS-THAN SIGN character token and a
   U+002F SOLIDUS character token. Reconsume the <span>current input character</span>.</dd>

  </dl>


  <h5 id="rcdata-end-tag-name-state"><dfn>RCDATA end tag name state</dfn></h5>
  <!-- identical to the RAWTEXT (and Script data) end tag name state, except s/RAWTEXT/RCDATA/g -->

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>If the current end tag token is an <span>appropriate end tag token</span>, then switch to the
   <span>before attribute name state</span>. Otherwise, treat it as per the "anything else" entry
   below.</dd>

   <dt>U+002F SOLIDUS (/)</dt>
   <dd>If the current end tag token is an <span>appropriate end tag token</span>, then switch to the
   <span>self-closing start tag state</span>. Otherwise, treat it as per the "anything else" entry
   below.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>If the current end tag token is an <span>appropriate end tag token</span>, then switch to the
   <span>data state</span> and emit the current tag token. Otherwise, treat it as per the "anything
   else" entry below.</dd>

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Append the lowercase version of the <span>current input character</span> (add 0x0020 to the
   character's code point) to the current tag token's tag name. Append the <span>current input
   character</span> to the <var data-x="temporary buffer">temporary buffer</var>.</dd>

   <dt><span data-x="lowercase ASCII letters">Lowercase ASCII letter</span></dt>
   <dd>Append the <span>current input character</span> to the current tag token's tag name. Append
   the <span>current input character</span> to the <var data-x="temporary buffer">temporary
   buffer</var>.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>RCDATA state</span>. Emit a U+003C LESS-THAN SIGN character token, a
   U+002F SOLIDUS character token, and a character token for each of the characters in the <var
   data-x="temporary buffer">temporary buffer</var> (in the order they were added to the buffer).
   Reconsume the <span>current input character</span>.</dd>

  </dl>


  <h5 id="rawtext-less-than-sign-state"><dfn>RAWTEXT less-than sign state</dfn></h5>
  <!-- identical to the RCDATA less-than sign state, except s/RCDATA/RAWTEXT/g -->

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002F SOLIDUS (/)</dt>
   <dd>Set the <var data-x="temporary buffer">temporary buffer</var> to the empty string. Switch to
   the <span>RAWTEXT end tag open state</span>.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>RAWTEXT state</span>. Emit a U+003C LESS-THAN SIGN character token.
   Reconsume the <span>current input character</span>.</dd>

  </dl>


  <h5 id="rawtext-end-tag-open-state"><dfn>RAWTEXT end tag open state</dfn></h5>
  <!-- identical to the RCDATA (and Script data) end tag open state, except s/RCDATA/RAWTEXT/g -->

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Create a new end tag token, and set its tag name to the lowercase version of the
   <span>current input character</span> (add 0x0020 to the character's code point). Append the
   <span>current input character</span> to the <var data-x="temporary buffer">temporary
   buffer</var>. Finally, switch to the <span>RAWTEXT end tag name state</span>. (Don't emit the
   token yet; further details will be filled in before it is emitted.)</dd>

   <dt><span data-x="lowercase ASCII letters">Lowercase ASCII letter</span></dt>
   <dd>Create a new end tag token, and set its tag name to the <span>current input character</span>.
   Append the <span>current input character</span> to the <var data-x="temporary buffer">temporary
   buffer</var>. Finally, switch to the <span>RAWTEXT end tag name state</span>. (Don't emit the
   token yet; further details will be filled in before it is emitted.)</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>RAWTEXT state</span>. Emit a U+003C LESS-THAN SIGN character token and a
   U+002F SOLIDUS character token. Reconsume the <span>current input character</span>.</dd>

  </dl>


  <h5 id="rawtext-end-tag-name-state"><dfn>RAWTEXT end tag name state</dfn></h5>
  <!-- identical to the RCDATA (and Script data) end tag name state, except s/RCDATA/RAWTEXT/g -->

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>If the current end tag token is an <span>appropriate end tag token</span>, then switch to the
   <span>before attribute name state</span>. Otherwise, treat it as per the "anything else" entry
   below.</dd>

   <dt>U+002F SOLIDUS (/)</dt>
   <dd>If the current end tag token is an <span>appropriate end tag token</span>, then switch to the
   <span>self-closing start tag state</span>. Otherwise, treat it as per the "anything else" entry
   below.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>If the current end tag token is an <span>appropriate end tag token</span>, then switch to the
   <span>data state</span> and emit the current tag token. Otherwise, treat it as per the "anything
   else" entry below.</dd>

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Append the lowercase version of the <span>current input character</span> (add 0x0020 to the
   character's code point) to the current tag token's tag name. Append the <span>current input
   character</span> to the <var data-x="temporary buffer">temporary buffer</var>.</dd>

   <dt><span data-x="lowercase ASCII letters">Lowercase ASCII letter</span></dt>
   <dd>Append the <span>current input character</span> to the current tag token's tag name. Append
   the <span>current input character</span> to the <var data-x="temporary buffer">temporary
   buffer</var>.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>RAWTEXT state</span>. Emit a U+003C LESS-THAN SIGN character token, a
   U+002F SOLIDUS character token, and a character token for each of the characters in the <var
   data-x="temporary buffer">temporary buffer</var> (in the order they were added to the buffer).
   Reconsume the <span>current input character</span>.</dd>

  </dl>


  <h5 id="script-data-less-than-sign-state"><dfn>Script data less-than sign state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002F SOLIDUS (/)</dt>
   <dd>Set the <var data-x="temporary buffer">temporary buffer</var> to the empty string. Switch to
   the <span>script data end tag open state</span>.</dd>

   <dt>U+0021 EXCLAMATION MARK (!)</dt>
   <dd>Switch to the <span>script data escape start state</span>. Emit a U+003C LESS-THAN SIGN
   character token and a U+0021 EXCLAMATION MARK character token.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>script data state</span>. Emit a U+003C LESS-THAN SIGN character token.
   Reconsume the <span>current input character</span>.</dd>

  </dl>


  <h5 id="script-data-end-tag-open-state"><dfn>Script data end tag open state</dfn></h5>
  <!-- identical to the RCDATA (and RAWTEXT) end tag open state, except s/RCDATA/Script data/g -->

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Create a new end tag token, and set its tag name to the lowercase version of the
   <span>current input character</span> (add 0x0020 to the character's code point). Append the
   <span>current input character</span> to the <var data-x="temporary buffer">temporary
   buffer</var>. Finally, switch to the <span>script data end tag name state</span>. (Don't emit the
   token yet; further details will be filled in before it is emitted.)</dd>

   <dt><span data-x="lowercase ASCII letters">Lowercase ASCII letter</span></dt>
   <dd>Create a new end tag token, and set its tag name to the <span>current input character</span>.
   Append the <span>current input character</span> to the <var data-x="temporary buffer">temporary
   buffer</var>. Finally, switch to the <span>script data end tag name state</span>. (Don't emit the
   token yet; further details will be filled in before it is emitted.)</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>script data state</span>. Emit a U+003C LESS-THAN SIGN character token
   and a U+002F SOLIDUS character token. Reconsume the <span>current input character</span>.</dd>

  </dl>


  <h5 id="script-data-end-tag-name-state"><dfn>Script data end tag name state</dfn></h5>
  <!-- identical to the RCDATA (and RAWTEXT) end tag name state, except s/RCDATA/Script data/g -->

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>If the current end tag token is an <span>appropriate end tag token</span>, then switch to the
   <span>before attribute name state</span>. Otherwise, treat it as per the "anything else" entry
   below.</dd>

   <dt>U+002F SOLIDUS (/)</dt>
   <dd>If the current end tag token is an <span>appropriate end tag token</span>, then switch to the
   <span>self-closing start tag state</span>. Otherwise, treat it as per the "anything else" entry
   below.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>If the current end tag token is an <span>appropriate end tag token</span>, then switch to the
   <span>data state</span> and emit the current tag token. Otherwise, treat it as per the "anything
   else" entry below.</dd>

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Append the lowercase version of the <span>current input character</span> (add 0x0020 to the
   character's code point) to the current tag token's tag name. Append the <span>current input
   character</span> to the <var data-x="temporary buffer">temporary buffer</var>.</dd>

   <dt><span data-x="lowercase ASCII letters">Lowercase ASCII letter</span></dt>
   <dd>Append the <span>current input character</span> to the current tag token's tag name. Append
   the <span>current input character</span> to the <var data-x="temporary buffer">temporary
   buffer</var>.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>script data state</span>. Emit a U+003C LESS-THAN SIGN character token, a
   U+002F SOLIDUS character token, and a character token for each of the characters in the <var
   data-x="temporary buffer">temporary buffer</var> (in the order they were added to the buffer).
   Reconsume the <span>current input character</span>.</dd>

  </dl>


  <h5 id="script-data-escape-start-state"><dfn>Script data escape start state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002D HYPHEN-MINUS (-)</dt>
   <dd>Switch to the <span>script data escape start dash state</span>. Emit a U+002D HYPHEN-MINUS
   character token.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>script data state</span>. Reconsume the <span>current input
   character</span>.</dd>

  </dl>


  <h5 id="script-data-escape-start-dash-state"><dfn>Script data escape start dash state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002D HYPHEN-MINUS (-)</dt>
   <dd>Switch to the <span>script data escaped dash dash state</span>. Emit a U+002D HYPHEN-MINUS
   character token.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>script data state</span>. Reconsume the <span>current input
   character</span>.</dd>

  </dl>


  <h5 id="script-data-escaped-state"><dfn>Script data escaped state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002D HYPHEN-MINUS (-)</dt>
   <dd>Switch to the <span>script data escaped dash state</span>. Emit a U+002D HYPHEN-MINUS
   character token.</dd>

   <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
   <dd>Switch to the <span>script data escaped less-than sign state</span>.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Emit a U+FFFD REPLACEMENT CHARACTER character token.</dd>

   <dt>EOF</dt>
   <dd>Switch to the <span>data state</span>. <span>Parse error</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd>Emit the <span>current input character</span> as a character token.</dd>

  </dl>


  <h5 id="script-data-escaped-dash-state"><dfn>Script data escaped dash state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002D HYPHEN-MINUS (-)</dt>
   <dd>Switch to the <span>script data escaped dash dash state</span>. Emit a U+002D HYPHEN-MINUS
   character token.</dd>

   <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
   <dd>Switch to the <span>script data escaped less-than sign state</span>.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Switch to the <span>script data escaped state</span>. Emit a U+FFFD
   REPLACEMENT CHARACTER character token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>script data escaped state</span>. Emit the <span>current input
   character</span> as a character token.</dd>

  </dl>


  <h5 id="script-data-escaped-dash-dash-state"><dfn>Script data escaped dash dash state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002D HYPHEN-MINUS (-)</dt>
   <dd>Emit a U+002D HYPHEN-MINUS character token.</dd>

   <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
   <dd>Switch to the <span>script data escaped less-than sign state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>script data state</span>. Emit a U+003E GREATER-THAN SIGN character
   token.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Switch to the <span>script data escaped state</span>. Emit a U+FFFD
   REPLACEMENT CHARACTER character token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>script data escaped state</span>. Emit the <span>current input
   character</span> as a character token.</dd>

  </dl>


  <h5 id="script-data-escaped-less-than-sign-state"><dfn>Script data escaped less-than sign state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002F SOLIDUS (/)</dt>
   <dd>Set the <var data-x="temporary buffer">temporary buffer</var> to the empty string. Switch to
   the <span>script data escaped end tag open state</span>.</dd>

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Set the <var data-x="temporary buffer">temporary buffer</var> to the empty string. Append the
   lowercase version of the <span>current input character</span> (add 0x0020 to the character's code
   point) to the <var data-x="temporary buffer">temporary buffer</var>. Switch to the <span>script
   data double escape start state</span>. Emit a U+003C LESS-THAN SIGN character token and the
   <span>current input character</span> as a character token.</dd>

   <dt><span data-x="lowercase ASCII letters">Lowercase ASCII letter</span></dt>
   <dd>Set the <var data-x="temporary buffer">temporary buffer</var> to the empty string. Append the
   <span>current input character</span> to the <var data-x="temporary buffer">temporary
   buffer</var>. Switch to the <span>script data double escape start state</span>. Emit a U+003C
   LESS-THAN SIGN character token and the <span>current input character</span> as a character
   token.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>script data escaped state</span>. Emit a U+003C LESS-THAN SIGN character
   token. Reconsume the <span>current input character</span>.</dd>

  </dl>


  <h5 id="script-data-escaped-end-tag-open-state"><dfn>Script data escaped end tag open state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Create a new end tag token, and set its tag name to the lowercase version of the
   <span>current input character</span> (add 0x0020 to the character's code point). Append the
   <span>current input character</span> to the <var data-x="temporary buffer">temporary
   buffer</var>. Finally, switch to the <span>script data escaped end tag name state</span>. (Don't
   emit the token yet; further details will be filled in before it is emitted.)</dd>

   <dt><span data-x="lowercase ASCII letters">Lowercase ASCII letter</span></dt>
   <dd>Create a new end tag token, and set its tag name to the <span>current input character</span>.
   Append the <span>current input character</span> to the <var data-x="temporary buffer">temporary
   buffer</var>. Finally, switch to the <span>script data escaped end tag name state</span>. (Don't
   emit the token yet; further details will be filled in before it is emitted.)</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>script data escaped state</span>. Emit a U+003C LESS-THAN SIGN character
   token and a U+002F SOLIDUS character token. Reconsume the <span>current input
   character</span>.</dd>

  </dl>


  <h5 id="script-data-escaped-end-tag-name-state"><dfn>Script data escaped end tag name state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>If the current end tag token is an <span>appropriate end tag token</span>, then switch to the
   <span>before attribute name state</span>. Otherwise, treat it as per the "anything else" entry
   below.</dd>

   <dt>U+002F SOLIDUS (/)</dt>
   <dd>If the current end tag token is an <span>appropriate end tag token</span>, then switch to the
   <span>self-closing start tag state</span>. Otherwise, treat it as per the "anything else" entry
   below.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>If the current end tag token is an <span>appropriate end tag token</span>, then switch to the
   <span>data state</span> and emit the current tag token. Otherwise, treat it as per the "anything
   else" entry below.</dd>

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Append the lowercase version of the <span>current input character</span> (add 0x0020 to the
   character's code point) to the current tag token's tag name. Append the <span>current input
   character</span> to the <var data-x="temporary buffer">temporary buffer</var>.</dd>

   <dt><span data-x="lowercase ASCII letters">Lowercase ASCII letter</span></dt>
   <dd>Append the <span>current input character</span> to the current tag token's tag name. Append
   the <span>current input character</span> to the <var data-x="temporary buffer">temporary
   buffer</var>.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>script data escaped state</span>. Emit a U+003C LESS-THAN SIGN character
   token, a U+002F SOLIDUS character token, and a character token for each of the characters in the
   <var data-x="temporary buffer">temporary buffer</var> (in the order they were added to the
   buffer). Reconsume the <span>current input character</span>.</dd>

  </dl>


  <h5 id="script-data-double-escape-start-state"><dfn>Script data double escape start state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dt>U+002F SOLIDUS (/)</dt>
   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>If the <var data-x="temporary buffer">temporary buffer</var> is the string "<code
  >script</code>", then switch to the <span>script data double escaped state</span>.
   Otherwise, switch to the <span>script data escaped state</span>. Emit the <span>current input
   character</span> as a character token.</dd>

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Append the lowercase version of the <span>current input character</span> (add 0x0020 to the
   character's code point) to the <var data-x="temporary buffer">temporary buffer</var>. Emit the
   <span>current input character</span> as a character token.</dd>

   <dt><span data-x="lowercase ASCII letters">Lowercase ASCII letter</span></dt>
   <dd>Append the <span>current input character</span> to the <var data-x="temporary
   buffer">temporary buffer</var>. Emit the <span>current input character</span> as a character
   token.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>script data escaped state</span>. Reconsume the <span>current input
   character</span>.</dd>

  </dl>


  <h5 id="script-data-double-escaped-state"><dfn>Script data double escaped state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002D HYPHEN-MINUS (-)</dt>
   <dd>Switch to the <span>script data double escaped dash state</span>. Emit a U+002D HYPHEN-MINUS
   character token.</dd>

   <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
   <dd>Switch to the <span>script data double escaped less-than sign state</span>. Emit a U+003C
   LESS-THAN SIGN character token.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Emit a U+FFFD REPLACEMENT CHARACTER character token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd>Emit the <span>current input character</span> as a character token.</dd>

  </dl>


  <h5 id="script-data-double-escaped-dash-state"><dfn>Script data double escaped dash state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002D HYPHEN-MINUS (-)</dt>
   <dd>Switch to the <span>script data double escaped dash dash state</span>. Emit a U+002D
   HYPHEN-MINUS character token.</dd>

   <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
   <dd>Switch to the <span>script data double escaped less-than sign state</span>. Emit a U+003C
   LESS-THAN SIGN character token.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Switch to the <span>script data double escaped state</span>. Emit a
   U+FFFD REPLACEMENT CHARACTER character token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>script data double escaped state</span>. Emit the <span>current input
   character</span> as a character token.</dd>

  </dl>


  <h5 id="script-data-double-escaped-dash-dash-state"><dfn>Script data double escaped dash dash state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002D HYPHEN-MINUS (-)</dt>
   <dd>Emit a U+002D HYPHEN-MINUS character token.</dd>

   <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
   <dd>Switch to the <span>script data double escaped less-than sign state</span>. Emit a U+003C
   LESS-THAN SIGN character token.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>script data state</span>. Emit a U+003E GREATER-THAN SIGN character
   token.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Switch to the <span>script data double escaped state</span>. Emit a
   U+FFFD REPLACEMENT CHARACTER character token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>script data double escaped state</span>. Emit the <span>current input
   character</span> as a character token.</dd>

  </dl>


  <h5 id="script-data-double-escaped-less-than-sign-state"><dfn>Script data double escaped less-than sign state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002F SOLIDUS (/)</dt>
   <dd>Set the <var data-x="temporary buffer">temporary buffer</var> to the empty string. Switch to
   the <span>script data double escape end state</span>. Emit a U+002F SOLIDUS character token.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>script data double escaped state</span>. Reconsume the <span>current
   input character</span>.</dd>

  </dl>


  <h5 id="script-data-double-escape-end-state"><dfn>Script data double escape end state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dt>U+002F SOLIDUS (/)</dt>
   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>If the <var data-x="temporary buffer">temporary buffer</var> is the string "<code
  >script</code>", then switch to the <span>script data escaped state</span>. Otherwise,
   switch to the <span>script data double escaped state</span>. Emit the <span>current input
   character</span> as a character token.</dd>

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Append the lowercase version of the <span>current input character</span> (add 0x0020 to the
   character's code point) to the <var data-x="temporary buffer">temporary buffer</var>. Emit the
   <span>current input character</span> as a character token.</dd>

   <dt><span data-x="lowercase ASCII letters">Lowercase ASCII letter</span></dt>
   <dd>Append the <span>current input character</span> to the <var data-x="temporary
   buffer">temporary buffer</var>. Emit the <span>current input character</span> as a character
   token.</dd>

   <dt>Anything else</dt>
   <dd>Switch to the <span>script data double escaped state</span>. Reconsume the <span>current
   input character</span>.</dd>

  </dl>


  <h5 id="before-attribute-name-state"><dfn>Before attribute name state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Ignore the character.</dd>

   <dt>U+002F SOLIDUS (/)</dt>
   <dd>Switch to the <span>self-closing start tag state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>data state</span>. Emit the current tag token.</dd>

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Start a new attribute in the current tag token. Set that attribute's name to the lowercase
   version of the <span>current input character</span> (add 0x0020 to the character's code point),
   and its value to the empty string. Switch to the <span>attribute name state</span>.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Start a new attribute in the current tag token. Set that
   attribute's name to a U+FFFD REPLACEMENT CHARACTER character, and its value to the empty string.
   Switch to the <span>attribute name state</span>.</dd>

   <dt>U+0022 QUOTATION MARK (&quot;)</dt>
   <dt>U+0027 APOSTROPHE (')</dt>
   <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
   <dt>U+003D EQUALS SIGN (=)</dt>
   <dd><span>Parse error</span>. Treat it as per the "anything else" entry below.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd>Start a new attribute in the current tag token. Set that attribute's name to the
   <span>current input character</span>, and its value to the empty string. Switch to the
   <span>attribute name state</span>.</dd>

  </dl>


  <h5 id="attribute-name-state"><dfn>Attribute name state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Switch to the <span>after attribute name state</span>.</dd>

   <dt>U+002F SOLIDUS (/)</dt>
   <dd>Switch to the <span>self-closing start tag state</span>.</dd>

   <dt>U+003D EQUALS SIGN (=)</dt>
   <dd>Switch to the <span>before attribute value state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>data state</span>. Emit the current tag token.</dd>

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Append the lowercase version of the <span>current input character</span> (add 0x0020 to the
   character's code point) to the current attribute's name.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append a U+FFFD REPLACEMENT CHARACTER character to the current
   attribute's name.</dd>

   <dt>U+0022 QUOTATION MARK (&quot;)</dt>
   <dt>U+0027 APOSTROPHE (')</dt>
   <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
   <dd><span>Parse error</span>. Treat it as per the "anything else" entry below.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd>Append the <span>current input character</span> to the current attribute's name.</dd>

  </dl>

  <p>When the user agent leaves the attribute name state (and before emitting the tag token, if
  appropriate), the complete attribute's name must be compared to the other attributes on the same
  token; if there is already an attribute on the token with the exact same name, then this is a
  <span>parse error</span> and the new attribute must be removed from the token.</p>

  <p class="note">If an attribute is so removed from a token, it, and the value that gets associated
  with it, if any, are never subsequently used by the parser, and are therefore effectively
  discarded. Removing the attribute in this way does not change its status as the "current
  attribute" for the purposes of the tokenizer, however.</p>


  <h5 id="after-attribute-name-state"><dfn>After attribute name state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Ignore the character.</dd>

   <dt>U+002F SOLIDUS (/)</dt>
   <dd>Switch to the <span>self-closing start tag state</span>.</dd>

   <dt>U+003D EQUALS SIGN (=)</dt>
   <dd>Switch to the <span>before attribute value state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>data state</span>. Emit the current tag token.</dd>

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Start a new attribute in the current tag token. Set that attribute's name to the lowercase
   version of the <span>current input character</span> (add 0x0020 to the character's code point),
   and its value to the empty string. Switch to the <span>attribute name state</span>.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Start a new attribute in the current tag token. Set that
   attribute's name to a U+FFFD REPLACEMENT CHARACTER character, and its value to the empty string.
   Switch to the <span>attribute name state</span>.</dd>

   <dt>U+0022 QUOTATION MARK (&quot;)</dt>
   <dt>U+0027 APOSTROPHE (')</dt>
   <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
   <dd><span>Parse error</span>. Treat it as per the "anything else" entry below.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd>Start a new attribute in the current tag token. Set that attribute's name to the
   <span>current input character</span>, and its value to the empty string. Switch to the
   <span>attribute name state</span>.</dd>

  </dl>


  <h5 id="before-attribute-value-state"><dfn>Before attribute value state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Ignore the character.</dd>

   <dt>U+0022 QUOTATION MARK (&quot;)</dt>
   <dd>Switch to the <span>attribute value (double-quoted) state</span>.</dd>

   <dt>U+0026 AMPERSAND (&amp;)</dt>
   <dd>Switch to the <span>attribute value (unquoted) state</span>. Reconsume the <span>current
   input character</span>.</dd>

   <dt>U+0027 APOSTROPHE (')</dt>
   <dd>Switch to the <span>attribute value (single-quoted) state</span>.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append a U+FFFD REPLACEMENT CHARACTER character to the current
   attribute's value. Switch to the <span>attribute value (unquoted) state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Emit the current tag
   token.</dd>

   <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
   <dt>U+003D EQUALS SIGN (=)</dt>
   <dt>U+0060 GRAVE ACCENT (`)</dt>
   <dd><span>Parse error</span>. Treat it as per the "anything else" entry below.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd>Append the <span>current input character</span> to the current attribute's value. Switch to
   the <span>attribute value (unquoted) state</span>.</dd>

  </dl>


  <h5 id="attribute-value-(double-quoted)-state"><dfn>Attribute value (double-quoted) state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0022 QUOTATION MARK (&quot;)</dt>
   <dd>Switch to the <span>after attribute value (quoted) state</span>.</dd>

   <dt>U+0026 AMPERSAND (&amp;)</dt>
   <dd>Switch to the <span>character reference in attribute value state</span>, with the
   <span>additional allowed character</span> being U+0022 QUOTATION MARK (&quot;).</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append a U+FFFD REPLACEMENT CHARACTER character to the current
   attribute's value.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd>Append the <span>current input character</span> to the current attribute's value.</dd>

  </dl>


  <h5 id="attribute-value-(single-quoted)-state"><dfn>Attribute value (single-quoted) state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0027 APOSTROPHE (')</dt>
   <dd>Switch to the <span>after attribute value (quoted) state</span>.</dd>

   <dt>U+0026 AMPERSAND (&amp;)</dt>
   <dd>Switch to the <span>character reference in attribute value state</span>, with the
   <span>additional allowed character</span> being U+0027 APOSTROPHE (').</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append a U+FFFD REPLACEMENT CHARACTER character to the current
   attribute's value.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd>Append the <span>current input character</span> to the current attribute's value.</dd>

  </dl>


  <h5 id="attribute-value-(unquoted)-state"><dfn>Attribute value (unquoted) state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Switch to the <span>before attribute name state</span>.</dd>

   <dt>U+0026 AMPERSAND (&amp;)</dt>
   <dd>Switch to the <span>character reference in attribute value state</span>, with the
   <span>additional allowed character</span> being U+003E GREATER-THAN SIGN (&gt;).</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>data state</span>. Emit the current tag token.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append a U+FFFD REPLACEMENT CHARACTER character to the current
   attribute's value.</dd>

   <dt>U+0022 QUOTATION MARK (&quot;)</dt>
   <dt>U+0027 APOSTROPHE (')</dt>
   <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
   <dt>U+003D EQUALS SIGN (=)</dt>
   <dt>U+0060 GRAVE ACCENT (`)</dt>
   <dd><span>Parse error</span>. Treat it as per the "anything else" entry below.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd>Append the <span>current input character</span> to the current attribute's value.</dd>

  </dl>


  <h5 id="character-reference-in-attribute-value-state"><dfn>Character reference in attribute value state</dfn></h5>

  <p>Attempt to <span>consume a character reference</span>.</p>

  <p>If nothing is returned, append a U+0026 AMPERSAND character (&amp;) to the current attribute's
  value.</p>

  <p>Otherwise, append the returned character tokens to the current attribute's value.</p>

  <p>Finally, switch back to the attribute value state that switched into this state.</p>


  <h5 id="after-attribute-value-(quoted)-state"><dfn>After attribute value (quoted) state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Switch to the <span>before attribute name state</span>.</dd>

   <dt>U+002F SOLIDUS (/)</dt>
   <dd>Switch to the <span>self-closing start tag state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>data state</span>. Emit the current tag token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd><span>Parse error</span>. Switch to the <span>before attribute name state</span>. Reconsume
   the character.</dd>

  </dl>


  <h5 id="self-closing-start-tag-state"><dfn>Self-closing start tag state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Set the <i data-x="self-closing flag">self-closing flag</i> of the current tag token. Switch to the <span>data
   state</span>. Emit the current tag token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd><span>Parse error</span>. Switch to the <span>before attribute name state</span>. Reconsume
   the character.</dd>

  </dl>


  <h5 id="bogus-comment-state"><dfn>Bogus comment state</dfn></h5>

  <p>Consume every character up to and including the first U+003E GREATER-THAN SIGN character (&gt;)
  or the end of the file (EOF), whichever comes first.
  If more than one character was consumed, then emit a comment token whose data is the
  concatenation of all the characters starting from and including the character that caused the
  state machine to switch into the bogus comment state, up to and including the character
  immediately before the last consumed character (i.e. up to the character just before the U+003E or
  EOF character), but with any U+0000 NULL characters replaced by U+FFFD REPLACEMENT CHARACTER
  characters. (If the comment was started by the end of the file (EOF), the token is empty.
  Similarly, the token is empty if it was generated by the string "<code
 >&lt;!></code>".)</p>

  <p>Switch to the <span>data state</span>.</p>

  <p>If the end of the file was reached, reconsume the EOF character.</p>


  <h5 id="markup-declaration-open-state"><dfn>Markup declaration open state</dfn></h5>

  <p>If the next two characters are both U+002D HYPHEN-MINUS characters (-), consume those two
  characters, create a comment token whose data is the empty string, and switch to the <span>comment
  start state</span>.</p>

  <p>Otherwise, if the next seven characters are an <span>ASCII case-insensitive</span> match for
  the word "DOCTYPE", then consume those characters and switch to the <span>DOCTYPE
  state</span>.</p>

  <p>Otherwise, if there is an <span>adjusted current node</span> and it is not an element in the
  <span>HTML namespace</span> and the next seven characters are a <span>case-sensitive</span> match
  for the string "[CDATA[" (the five uppercase letters "CDATA" with a U+005B LEFT SQUARE BRACKET
  character before and after), then consume those characters and switch to the <span>CDATA section
  state</span>.</p>

  <p>Otherwise, this is a <span>parse error</span>. Switch to the <span>bogus comment state</span>.
  The next character that is consumed, if any, is the first character that will be in the
  comment.</p>


  <h5 id="comment-start-state"><dfn>Comment start state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002D HYPHEN-MINUS (-)</dt>
   <dd>Switch to the <span>comment start dash state</span>.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append a U+FFFD REPLACEMENT CHARACTER character to the comment
   token's data. Switch to the <span>comment state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Emit the comment token.</dd>
   <!-- see comment in comment end state -->

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Emit the comment token.
   Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd>Append the <span>current input character</span> to the comment token's data. Switch to the
   <span>comment state</span>.</dd>

  </dl>


  <h5 id="comment-start-dash-state"><dfn>Comment start dash state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002D HYPHEN-MINUS (-)</dt>
   <dd>Switch to the <span>comment end state</span></dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append a U+002D HYPHEN-MINUS character (-) and a U+FFFD REPLACEMENT
   CHARACTER character to the comment token's data. Switch to the <span>comment state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Emit the comment token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Emit the comment token.
   Reconsume the EOF character.</dd> <!-- see comment in comment end state -->

   <dt>Anything else</dt>
   <dd>Append a U+002D HYPHEN-MINUS character (-) and the <span>current input character</span> to
   the comment token's data. Switch to the <span>comment state</span>.</dd>

  </dl>


  <h5><dfn id="comment">Comment state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002D HYPHEN-MINUS (-)</dt>
   <dd>Switch to the <span>comment end dash state</span></dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append a U+FFFD REPLACEMENT CHARACTER character to the comment
   token's data.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Emit the comment token.
   Reconsume the EOF character.</dd> <!-- see comment in comment end state -->

   <dt>Anything else</dt>
   <dd>Append the <span>current input character</span> to the comment token's data.</dd>

  </dl>


  <h5 id="comment-end-dash-state"><dfn>Comment end dash state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002D HYPHEN-MINUS (-)</dt>
   <dd>Switch to the <span>comment end state</span></dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append a U+002D HYPHEN-MINUS character (-) and a U+FFFD REPLACEMENT
   CHARACTER character to the comment token's data. Switch to the <span>comment state</span>.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Emit the comment token.
   Reconsume the EOF character.</dd> <!-- see comment in comment end state -->

   <dt>Anything else</dt>
   <dd>Append a U+002D HYPHEN-MINUS character (-) and the <span>current input character</span> to
   the comment token's data. Switch to the <span>comment state</span>.</dd>

  </dl>


  <h5 id="comment-end-state"><dfn>Comment end state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>data state</span>. Emit the comment token.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append two U+002D HYPHEN-MINUS characters (-) and a U+FFFD
   REPLACEMENT CHARACTER character to the comment token's data. Switch to the <span>comment
   state</span>.</dd>

   <dt>U+0021 EXCLAMATION MARK (!)</dt>
   <dd><span>Parse error</span>. Switch to the <span>comment end bang state</span>.</dd>

   <dt>U+002D HYPHEN-MINUS (-)</dt>
   <dd><span>Parse error</span>. Append a U+002D HYPHEN-MINUS character (-) to the comment token's
   data.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Emit the comment token.
   Reconsume the EOF character.</dd> <!-- For security reasons: otherwise, hostile user could put a
   <script> in a comment e.g. in a blog comment and then DOS the server so that the end tag isn't
   read, and then the commented <script> tag would be treated as live code -->

   <dt>Anything else</dt>
   <dd><span>Parse error</span>. Append two U+002D HYPHEN-MINUS characters (-) and the <span>current
   input character</span> to the comment token's data. Switch to the <span>comment
   state</span>.</dd>

  </dl>


  <h5 id="comment-end-bang-state"><dfn>Comment end bang state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+002D HYPHEN-MINUS (-)</dt>
   <dd>Append two U+002D HYPHEN-MINUS characters (-) and a U+0021 EXCLAMATION MARK character (!) to
   the comment token's data. Switch to the <span>comment end dash state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>data state</span>. Emit the comment token.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append two U+002D HYPHEN-MINUS characters (-), a U+0021 EXCLAMATION
   MARK character (!), and a U+FFFD REPLACEMENT CHARACTER character to the comment token's data.
   Switch to the <span>comment state</span>.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Emit the comment token.
   Reconsume the EOF character.</dd> <!-- see comment in comment end state -->

   <dt>Anything else</dt>
   <dd>Append two U+002D HYPHEN-MINUS characters (-), a U+0021 EXCLAMATION MARK character (!), and
   the <span>current input character</span> to the comment token's data. Switch to the <span>comment
   state</span>.</dd>

  </dl>


  <h5 id="doctype-state"><dfn>DOCTYPE state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Switch to the <span>before DOCTYPE name state</span>.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Create a new DOCTYPE token.
   Set its <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Emit the token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd><span>Parse error</span>. Switch to the <span>before DOCTYPE name state</span>. Reconsume the
   character.</dd>

  </dl>


  <h5 id="before-doctype-name-state"><dfn>Before DOCTYPE name state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Ignore the character.</dd>

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Create a new DOCTYPE token. Set the token's name to the lowercase version of the
   <span>current input character</span> (add 0x0020 to the character's code point). Switch to the
   <span>DOCTYPE name state</span>.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Create a new DOCTYPE token. Set the token's name to a U+FFFD
   REPLACEMENT CHARACTER character. Switch to the <span>DOCTYPE name state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd><span>Parse error</span>. Create a new DOCTYPE token. Set its <i data-x="force-quirks flag">force-quirks flag</i> to
   <i>on</i>. Switch to the <span>data state</span>. Emit the token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Create a new DOCTYPE token.
   Set its <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Emit the token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd>Create a new DOCTYPE token. Set the token's name to the <span>current input character</span>.
   Switch to the <span>DOCTYPE name state</span>.</dd>

  </dl>


  <h5 id="doctype-name-state"><dfn>DOCTYPE name state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Switch to the <span>after DOCTYPE name state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>data state</span>. Emit the current DOCTYPE token.</dd>

   <dt><span data-x="uppercase ASCII letters">Uppercase ASCII letter</span></dt>
   <dd>Append the lowercase version of the <span>current input character</span> (add 0x0020 to the
   character's code point) to the current DOCTYPE token's name.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append a U+FFFD REPLACEMENT CHARACTER character to the current
   DOCTYPE token's name.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Set the DOCTYPE token's
   <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Emit that DOCTYPE token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd>Append the <span>current input character</span> to the current DOCTYPE token's name.</dd>

  </dl>


  <h5 id="after-doctype-name-state"><dfn>After DOCTYPE name state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Ignore the character.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>data state</span>. Emit the current DOCTYPE token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Set the DOCTYPE token's
   <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Emit that DOCTYPE token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd>

    <p>If the six characters starting from the <span>current input character</span> are an
    <span>ASCII case-insensitive</span> match for the word "PUBLIC", then consume those characters
    and switch to the <span>after DOCTYPE public keyword state</span>.</p>

    <p>Otherwise, if the six characters starting from the <span>current input character</span> are
    an <span>ASCII case-insensitive</span> match for the word "SYSTEM", then consume those
    characters and switch to the <span>after DOCTYPE system keyword state</span>.</p>

    <p>Otherwise, this is a <span>parse error</span>. Set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Switch to the <span>bogus DOCTYPE state</span>.</p>

   </dd>

  </dl>


  <h5 id="after-doctype-public-keyword-state"><dfn>After DOCTYPE public keyword state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Switch to the <span>before DOCTYPE public identifier state</span>.</dd>

   <dt>U+0022 QUOTATION MARK (&quot;)</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's public identifier to the empty string (not
   missing), then switch to the <span>DOCTYPE public identifier (double-quoted) state</span>.</dd>

   <dt>U+0027 APOSTROPHE (')</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's public identifier to the empty string (not
   missing), then switch to the <span>DOCTYPE public identifier (single-quoted) state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>.
   Switch to the <span>data state</span>. Emit that DOCTYPE token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Set the DOCTYPE token's
   <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Emit that DOCTYPE token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>.
   Switch to the <span>bogus DOCTYPE state</span>.</dd>

  </dl>


  <h5 id="before-doctype-public-identifier-state"><dfn>Before DOCTYPE public identifier state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Ignore the character.</dd>

   <dt>U+0022 QUOTATION MARK (&quot;)</dt>
   <dd>Set the DOCTYPE token's public identifier to the empty string (not missing), then switch to
   the <span>DOCTYPE public identifier (double-quoted) state</span>.</dd>

   <dt>U+0027 APOSTROPHE (')</dt>
   <dd>Set the DOCTYPE token's public identifier to the empty string (not missing), then switch to
   the <span>DOCTYPE public identifier (single-quoted) state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>.
   Switch to the <span>data state</span>. Emit that DOCTYPE token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Set the DOCTYPE token's
   <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Emit that DOCTYPE token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>.
   Switch to the <span>bogus DOCTYPE state</span>.</dd>

  </dl>


  <h5 id="doctype-public-identifier-(double-quoted)-state"><dfn>DOCTYPE public identifier (double-quoted) state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0022 QUOTATION MARK (&quot;)</dt>
   <dd>Switch to the <span>after DOCTYPE public identifier state</span>.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append a U+FFFD REPLACEMENT CHARACTER character to the current
   DOCTYPE token's public identifier.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>.
   Switch to the <span>data state</span>. Emit that DOCTYPE token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Set the DOCTYPE token's
   <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Emit that DOCTYPE token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd>Append the <span>current input character</span> to the current DOCTYPE token's public
   identifier.</dd>

  </dl>


  <h5 id="doctype-public-identifier-(single-quoted)-state"><dfn>DOCTYPE public identifier (single-quoted) state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0027 APOSTROPHE (')</dt>
   <dd>Switch to the <span>after DOCTYPE public identifier state</span>.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append a U+FFFD REPLACEMENT CHARACTER character to the current
   DOCTYPE token's public identifier.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>.
   Switch to the <span>data state</span>. Emit that DOCTYPE token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Set the DOCTYPE token's
   <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Emit that DOCTYPE token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd>Append the <span>current input character</span> to the current DOCTYPE token's public
   identifier.</dd>

  </dl>


  <h5 id="after-doctype-public-identifier-state"><dfn>After DOCTYPE public identifier state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Switch to the <span>between DOCTYPE public and system identifiers state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>data state</span>. Emit the current DOCTYPE token.</dd>

   <dt>U+0022 QUOTATION MARK (&quot;)</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's system identifier to the empty string (not
   missing), then switch to the <span>DOCTYPE system identifier (double-quoted) state</span>.</dd>

   <dt>U+0027 APOSTROPHE (')</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's system identifier to the empty string (not
   missing), then switch to the <span>DOCTYPE system identifier (single-quoted) state</span>.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Set the DOCTYPE token's
   <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Emit that DOCTYPE token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>.
   Switch to the <span>bogus DOCTYPE state</span>.</dd>

  </dl>


  <h5 id="between-doctype-public-and-system-identifiers-state"><dfn>Between DOCTYPE public and system identifiers state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Ignore the character.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>data state</span>. Emit the current DOCTYPE token.</dd>

   <dt>U+0022 QUOTATION MARK (&quot;)</dt>
   <dd>Set the DOCTYPE token's system identifier to the empty string (not missing), then switch to
   the <span>DOCTYPE system identifier (double-quoted) state</span>.</dd>

   <dt>U+0027 APOSTROPHE (')</dt>
   <dd>Set the DOCTYPE token's system identifier to the empty string (not missing), then switch to
   the <span>DOCTYPE system identifier (single-quoted) state</span>.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Set the DOCTYPE token's
   <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Emit that DOCTYPE token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>.
   Switch to the <span>bogus DOCTYPE state</span>.</dd>

  </dl>


  <h5 id="after-doctype-system-keyword-state"><dfn>After DOCTYPE system keyword state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Switch to the <span>before DOCTYPE system identifier state</span>.</dd>

   <dt>U+0022 QUOTATION MARK (&quot;)</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's system identifier to the empty string (not
   missing), then switch to the <span>DOCTYPE system identifier (double-quoted) state</span>.</dd>

   <dt>U+0027 APOSTROPHE (')</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's system identifier to the empty string (not
   missing), then switch to the <span>DOCTYPE system identifier (single-quoted) state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>.
   Switch to the <span>data state</span>. Emit that DOCTYPE token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Set the DOCTYPE token's
   <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Emit that DOCTYPE token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>.
   Switch to the <span>bogus DOCTYPE state</span>.</dd>

  </dl>


  <h5 id="before-doctype-system-identifier-state"><dfn>Before DOCTYPE system identifier state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Ignore the character.</dd>

   <dt>U+0022 QUOTATION MARK (&quot;)</dt>
   <dd>Set the DOCTYPE token's system identifier to the empty string (not missing), then switch to
   the <span>DOCTYPE system identifier (double-quoted) state</span>.</dd>

   <dt>U+0027 APOSTROPHE (')</dt>
   <dd>Set the DOCTYPE token's system identifier to the empty string (not missing), then switch to
   the <span>DOCTYPE system identifier (single-quoted) state</span>.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>.
   Switch to the <span>data state</span>. Emit that DOCTYPE token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Set the DOCTYPE token's
   <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Emit that DOCTYPE token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>.
   Switch to the <span>bogus DOCTYPE state</span>.</dd>

  </dl>


  <h5 id="doctype-system-identifier-(double-quoted)-state"><dfn>DOCTYPE system identifier (double-quoted) state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0022 QUOTATION MARK (&quot;)</dt>
   <dd>Switch to the <span>after DOCTYPE system identifier state</span>.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append a U+FFFD REPLACEMENT CHARACTER character to the current
   DOCTYPE token's system identifier.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>.
   Switch to the <span>data state</span>. Emit that DOCTYPE token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Set the DOCTYPE token's
   <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Emit that DOCTYPE token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd>Append the <span>current input character</span> to the current DOCTYPE token's system
   identifier.</dd>

  </dl>


  <h5 id="doctype-system-identifier-(single-quoted)-state"><dfn>DOCTYPE system identifier (single-quoted) state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0027 APOSTROPHE (')</dt>
   <dd>Switch to the <span>after DOCTYPE system identifier state</span>.</dd>

   <dt>U+0000 NULL</dt>
   <dd><span>Parse error</span>. Append a U+FFFD REPLACEMENT CHARACTER character to the current
   DOCTYPE token's system identifier.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd><span>Parse error</span>. Set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>.
   Switch to the <span>data state</span>. Emit that DOCTYPE token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Set the DOCTYPE token's
   <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Emit that DOCTYPE token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd>Append the <span>current input character</span> to the current DOCTYPE token's system
   identifier.</dd>

  </dl>


  <h5 id="after-doctype-system-identifier-state"><dfn>After DOCTYPE system identifier state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dd>Ignore the character.</dd>

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>data state</span>. Emit the current DOCTYPE token.</dd>

   <dt>EOF</dt>
   <dd><span>Parse error</span>. Switch to the <span>data state</span>. Set the DOCTYPE token's
   <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>. Emit that DOCTYPE token. Reconsume the EOF character.</dd>

   <dt>Anything else</dt>
   <dd><span>Parse error</span>. Switch to the <span>bogus DOCTYPE state</span>. (This does
   <em>not</em> set the DOCTYPE token's <i data-x="force-quirks flag">force-quirks flag</i> to <i>on</i>.)</dd>

  </dl>


  <h5 id="bogus-doctype-state"><dfn>Bogus DOCTYPE state</dfn></h5>

  <p>Consume the <span>next input character</span>:</p>

  <dl class="switch">

   <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
   <dd>Switch to the <span>data state</span>. Emit the DOCTYPE token.</dd>

   <dt>EOF</dt>
   <dd>Switch to the <span>data state</span>. Emit the DOCTYPE token. Reconsume the EOF
   character.</dd>

   <dt>Anything else</dt>
   <dd>Ignore the character.</dd>

  </dl>


  <h5 id="cdata-section-state"><dfn>CDATA section state</dfn></h5>

  <p>Switch to the <span>data state</span>.</p>

  <p>Consume every character up to the next occurrence of the three character sequence U+005D RIGHT
  SQUARE BRACKET U+005D RIGHT SQUARE BRACKET U+003E GREATER-THAN SIGN (<code>]]></code>),
  or the end of the file (EOF), whichever comes first. Emit a series of character tokens consisting
  of all the characters consumed except the matching three character sequence at the end (if one was
  found before the end of the file)<!--(not needed; taken care of by the tree constructor), but with
  any U+0000 NULL characters replaced by U+FFFD REPLACEMENT CHARACTER characters-->.</p>

  <p>If the end of the file was reached, reconsume the EOF character.</p>



  <h5 id="tokenizing-character-references">Tokenizing character references</h5>

  <p>This section defines how to <dfn>consume a character reference</dfn>, optionally with an
  <dfn>additional allowed character</dfn>, which, if specified where the algorithm is invoked, adds
  a character to the list of characters that cause there to not be a character reference.</p>

  <p>This definition is used when parsing character references <span data-x="character reference in
  data state">in text</span> and <span data-x="character reference in attribute value state">in
  attributes</span>.</p>

  <p>The behavior depends on the identity of the next character (the one immediately after the
  U+0026 AMPERSAND character), as follows:</p>

  <dl class="switch">

   <dt>U+0009 CHARACTER TABULATION (tab)</dt>
   <dt>U+000A LINE FEED (LF)</dt>
   <dt>U+000C FORM FEED (FF)</dt>
   <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
   <dt>U+0020 SPACE</dt>
   <dt>U+003C LESS-THAN SIGN</dt>
   <dt>U+0026 AMPERSAND</dt>
   <dt>EOF</dt>
   <dt>The <span>additional allowed character</span>, if there is one</dt>

   <dd>Not a character reference. No characters are consumed, and nothing is returned. (This is not
   an error, either.)</dd>


   <dt>U+0023 NUMBER SIGN (#)</dt>

   <dd>

    <p>Consume the U+0023 NUMBER SIGN.</p>

    <p>The behavior further depends on the character after the U+0023 NUMBER SIGN:</p>

    <dl class="switch">

     <dt>U+0078 LATIN SMALL LETTER X</dt>
     <dt>U+0058 LATIN CAPITAL LETTER X</dt>

     <dd>

      <p>Consume the X.</p>

      <p>Follow the steps below, but using <span>ASCII hex digits</span>.</p>

      <p>When it comes to interpreting the number, interpret it as a hexadecimal number.</p>

     </dd>


     <dt>Anything else</dt>

     <dd>

      <p>Follow the steps below, but using <span>ASCII digits</span>.</p>

      <p>When it comes to interpreting the number, interpret it as a decimal number.</p>

     </dd>

    </dl>

    <p>Consume as many characters as match the range of characters given above (<span>ASCII hex
    digits</span> or <span>ASCII digits</span>).</p>

    <p>If no characters match the range, then don't consume any characters (and unconsume the U+0023
    NUMBER SIGN character and, if appropriate, the X character). This is a <span>parse error</span>;
    nothing is returned.</p>

    <p>Otherwise, if the next character is a U+003B SEMICOLON, consume that too. If it isn't, there
    is a <span>parse error</span>.</p>

    <p>If one or more characters match the range, then take them all and interpret the string of
    characters as a number (either hexadecimal or decimal as appropriate).</p>

    <p>If that number is one of the numbers in the first column of the following table, then this is
    a <span>parse error</span>. Find the row with that number in the first column, and return a
    character token for the Unicode character given in the second column of that row.</p>

    <table id="table-charref-overrides">
     <thead>
      <tr><th>Number <th colspan=2>Unicode character
     <tbody>
      <tr><td>0x00 <td>U+FFFD <td>REPLACEMENT CHARACTER
      <!-- <tr><td>0x0D <td>U+000D <td>CARRIAGE RETURN (CR) -->
      <tr><td>0x80 <td>U+20AC <td>EURO SIGN (&#x20AC;)
      <!-- <tr><td>0x81 <td>U+0081 <td>&lt;control> -->
      <tr><td>0x82 <td>U+201A <td>SINGLE LOW-9 QUOTATION MARK (&#x201A;)
      <tr><td>0x83 <td>U+0192 <td>LATIN SMALL LETTER F WITH HOOK (&#x0192;)
      <tr><td>0x84 <td>U+201E <td>DOUBLE LOW-9 QUOTATION MARK (&#x201E;)
      <tr><td>0x85 <td>U+2026 <td>HORIZONTAL ELLIPSIS (&#x2026;)
      <tr><td>0x86 <td>U+2020 <td>DAGGER (&#x2020;)
      <tr><td>0x87 <td>U+2021 <td>DOUBLE DAGGER (&#x2021;)
      <tr><td>0x88 <td>U+02C6 <td>MODIFIER LETTER CIRCUMFLEX ACCENT (&#x02C6;)
      <tr><td>0x89 <td>U+2030 <td>PER MILLE SIGN (&#x2030;)
      <tr><td>0x8A <td>U+0160 <td>LATIN CAPITAL LETTER S WITH CARON (&#x0160;)
      <tr><td>0x8B <td>U+2039 <td>SINGLE LEFT-POINTING ANGLE QUOTATION MARK (&#x2039;)
      <tr><td>0x8C <td>U+0152 <td>LATIN CAPITAL LIGATURE OE (&#x0152;)
      <!-- <tr><td>0x8D <td>U+008D <td>&lt;control> -->
      <tr><td>0x8E <td>U+017D <td>LATIN CAPITAL LETTER Z WITH CARON (&#x017D;)
      <!-- <tr><td>0x8F <td>U+008F <td>&lt;control> -->
      <!-- <tr><td>0x90 <td>U+0090 <td>&lt;control> -->
      <tr><td>0x91 <td>U+2018 <td>LEFT SINGLE QUOTATION MARK (&#x2018;)
      <tr><td>0x92 <td>U+2019 <td>RIGHT SINGLE QUOTATION MARK (&#x2019;)
      <tr><td>0x93 <td>U+201C <td>LEFT DOUBLE QUOTATION MARK (&#x201C;)
      <tr><td>0x94 <td>U+201D <td>RIGHT DOUBLE QUOTATION MARK (&#x201D;)
      <tr><td>0x95 <td>U+2022 <td>BULLET (&#x2022;)
      <tr><td>0x96 <td>U+2013 <td>EN DASH (&#x2013;)
      <tr><td>0x97 <td>U+2014 <td>EM DASH (&#x2014;)
      <tr><td>0x98 <td>U+02DC <td>SMALL TILDE (&#x02DC;)
      <tr><td>0x99 <td>U+2122 <td>TRADE MARK SIGN (&#x2122;)
      <tr><td>0x9A <td>U+0161 <td>LATIN SMALL LETTER S WITH CARON (&#x0161;)
      <tr><td>0x9B <td>U+203A <td>SINGLE RIGHT-POINTING ANGLE QUOTATION MARK (&#x203A;)
      <tr><td>0x9C <td>U+0153 <td>LATIN SMALL LIGATURE OE (&#x0153;)
      <!-- <tr><td>0x9D <td>U+009D <td>&lt;control> -->
      <tr><td>0x9E <td>U+017E <td>LATIN SMALL LETTER Z WITH CARON (&#x017E;)
      <tr><td>0x9F <td>U+0178 <td>LATIN CAPITAL LETTER Y WITH DIAERESIS (&#x0178;)
    </table>

    <p>Otherwise, if the number is in the range 0xD800 to 0xDFFF<!-- surrogates --> or is greater
    than 0x10FFFF, then this is a <span>parse error</span>. Return a U+FFFD REPLACEMENT CHARACTER
    character token.</p>

    <p>Otherwise, return a character token for the Unicode character whose code point is that
    number.

    <!-- this is the same as the equivalent list in the input stream section, except U+000D is not
    allowed --> Additionally, if the number is in the range 0x0001 to 0x0008, <!-- HT, LF allowed
    --> <!-- U+000B is in the next list --> <!-- FF allowed --> 0x000D to 0x001F, <!-- ASCII allowed
    --> 0x007F <!--to 0x0084, (0x0085 NEL not allowed), 0x0086--> to 0x009F, 0xFDD0 to 0xFDEF, or is
    one of 0x000B, 0xFFFE, 0xFFFF, 0x1FFFE, 0x1FFFF, 0x2FFFE, 0x2FFFF, 0x3FFFE, 0x3FFFF, 0x4FFFE,
    0x4FFFF, 0x5FFFE, 0x5FFFF, 0x6FFFE, 0x6FFFF, 0x7FFFE, 0x7FFFF, 0x8FFFE, 0x8FFFF, 0x9FFFE,
    0x9FFFF, 0xAFFFE, 0xAFFFF, 0xBFFFE, 0xBFFFF, 0xCFFFE, 0xCFFFF, 0xDFFFE, 0xDFFFF, 0xEFFFE,
    0xEFFFF, 0xFFFFE, 0xFFFFF, 0x10FFFE, or 0x10FFFF, then this is a <span>parse error</span>.</p>

   </dd>


   <dt>Anything else</dt>

   <dd>

    <p>Consume the maximum number of characters possible, with the consumed characters matching one
    of the identifiers in the first column of the <span>named character references</span> table (in
    a <span>case-sensitive</span> manner).</p>

    <p>If no match can be made, then no characters are consumed, and nothing is returned. In this
    case, if the characters after the U+0026 AMPERSAND character (&amp;) consist of a sequence of
    one or more <span>alphanumeric ASCII characters</span> followed by a U+003B SEMICOLON character
    (;), then this is a <span>parse error</span>.</p>

    <p>If the character reference is being consumed <span data-x="character reference in attribute
    value state">as part of an attribute</span>, and the last character matched is not a U+003B
    SEMICOLON character (;), and the next character is either a U+003D EQUALS SIGN character (=) or
    an <span data-x="alphanumeric ASCII characters">alphanumeric ASCII character</span>, then, for
    historical reasons, all the characters that were matched after the U+0026 AMPERSAND character
    (&amp;) must be unconsumed, and nothing is returned. <!-- "=" added because of
    https://www.w3.org/Bugs/Public/show_bug.cgi?id=9207#c5 -->

    However, if this next character is in fact a U+003D EQUALS SIGN character (=), then this is a
    <span>parse error</span>, because some legacy user agents <!-- IE, version 9 and before --> will
    misinterpret the markup in those cases.</p> <!-- v2: should make this no longer a conformance
    error at some point in the future; revisit in 2015? -->

    <p>Otherwise, a character reference is parsed. If the last character matched is not a U+003B
    SEMICOLON character (;), there is a <span>parse error</span>.</p>

    <p>Return one or two character tokens for the character(s) corresponding to the character
    reference name (as given by the second column of the <span>named character references</span>
    table).</p>

    <div class="example">

     <p>If the markup contains (not in an attribute) the string <code>I'm &amp;notit; I
     tell you</code>, the character reference is parsed as "not", as in, <code>I'm &not;it;
     I tell you</code> (and this is a parse error). But if the markup was <code>I'm
     &amp;notin; I tell you</code>, the character reference would be parsed as "notin;", resulting
     in <code>I'm &notin; I tell you</code> (and no parse error).</p>

    </div>

   </dd>

  </dl>

  </div>


  <div class="impl">

  <!-- v2: One thing that this doesn't define is handling deeply nested documents. There are
  compatibility requirements around that: you can't throw away the elements altogether, consider Tux
  made only with opening <font> elements, one per character. Seems that the best thing to do is to
  close some formatting elements from the middle of the stack when you hit a limit, or something.
  -->

  <h4 id="tree-construction"><dfn>Tree construction</dfn></h4>

  <p>The input to the tree construction stage is a sequence of tokens from the
  <span>tokenization</span> stage. The tree construction stage is associated with a DOM
  <code>Document</code> object when a parser is created. The "output" of this stage consists of
  dynamically modifying or extending that document's DOM tree.</p>

  <p>This specification does not define when an interactive user agent has to render the
  <code>Document</code> so that it is available to the user, or when it has to begin accepting user
  input.</p>

  <hr>

  <p>As each token is emitted from the tokenizer, the user agent must follow the appropriate steps
  from the following list, known as the <dfn>tree construction dispatcher</dfn>:</p>

  <dl class="switch">

   <dt>If the <span>stack of open elements</span> is empty</dt>
   <dt>If the <span>adjusted current node</span> is an element in the <span>HTML namespace</span></dt>
   <dt>If the <span>adjusted current node</span> is a <span>MathML text integration point</span> and the token is a start tag whose tag name is neither "mglyph" nor "malignmark"</dt>
   <dt>If the <span>adjusted current node</span> is a <span>MathML text integration point</span> and the token is a character token</dt>
   <dt>If the <span>adjusted current node</span> is an <code data-x="math:annotation-xml">annotation-xml</code> element in the <span>MathML namespace</span> and the token is a start tag whose tag name is "svg"</dt>
   <dt>If the <span>adjusted current node</span> is an <span>HTML integration point</span> and the token is a start tag</dt>
   <dt>If the <span>adjusted current node</span> is an <span>HTML integration point</span> and the token is a character token</dt>
   <dt>If the token is an end-of-file token</dt>

   <dd>Process the token according to the rules given in the section corresponding to the current
   <span>insertion mode</span> in HTML content.</dd>

   <dt>Otherwise</dt>

   <dd>Process the token according to the rules given in the section for parsing tokens <span
   data-x="insertion mode: in foreign content">in foreign content</span>.</dd>

  </dl>

  <p>The <dfn>next token</dfn> is the token that is about to be processed by the <span>tree
  construction dispatcher</span> (even if the token is subsequently just ignored).</p>

  <p>A node is a <dfn>MathML text integration point</dfn> if it is one of the following
  elements:</p>

  <ul class="brief">
   <li>An <code data-x="math:mi">mi</code> element in the <span>MathML namespace</span></li>
   <li>An <code data-x="math:mo">mo</code> element in the <span>MathML namespace</span></li>
   <li>An <code data-x="math:mn">mn</code> element in the <span>MathML namespace</span></li>
   <li>An <code data-x="math:ms">ms</code> element in the <span>MathML namespace</span></li>
   <li>An <code data-x="math:mtext">mtext</code> element in the <span>MathML namespace</span></li>
  </ul>

  <p>A node is an <dfn>HTML integration point</dfn> if it is one of the following elements:</p>

  <ul class="brief">
   <li>An <code data-x="math:annotation-xml">annotation-xml</code> element in the <span>MathML
   namespace</span> whose start tag token had an attribute with the name "encoding" whose value was
   an <span>ASCII case-insensitive</span> match for the string "<code
  >text/html</code>"</li>
   <li>An <code data-x="math:annotation-xml">annotation-xml</code> element in the <span>MathML
   namespace</span> whose start tag token had an attribute with the name "encoding" whose value was
   an <span>ASCII case-insensitive</span> match for the string "<code
  >application/xhtml+xml</code>"</li>
   <li>A <code>foreignObject</code> element in the <span>SVG namespace</span></li>
   <li>A <code>desc</code> element in the <span>SVG namespace</span></li>
   <li>A <code>title</code> element in the <span>SVG namespace</span></li>
  </ul>

  <p class="note">If the node in question is the <var
  data-x="concept-frag-parse-context">context</var> element passed to the <span>HTML fragment
  parsing algorithm</span>, then the start tag token for that element is the "fake" token created
  during by that <span>HTML fragment parsing algorithm</span>.</p>

  <hr>

  <p class="note">Not all of the tag names mentioned below are conformant tag names in this
  specification; many are included to handle legacy content. They still form part of the algorithm
  that implementations are required to implement to claim conformance.</p>

  <p class="note">The algorithm described below places no limit on the depth of the DOM tree
  generated, or on the length of tag names, attribute names, attribute values, <code>Text</code>
  nodes, etc. While implementors are encouraged to avoid arbitrary limits, it is recognized that <a
  href="#hardwareLimitations">practical concerns</a> will likely force user agents to impose nesting
  depth constraints.</p>


  <h5 id="creating-and-inserting-nodes">Creating and inserting nodes</h5>

  <p>While the parser is processing a token, it can enable or disable <dfn data-x="foster
  parent">foster parenting</dfn>. This affects the following algorithm.</p>

  <p>The <dfn>appropriate place for inserting a node</dfn>, optionally using a particular
  <i>override target</i>, is the position in an element returned by running the following steps:</p>

  <ol>

   <li>

    <p>If there was an <i>override target</i> specified, then let <var>target</var> be the
    <i>override target</i>.</p>

    <p>Otherwise, let <var>target</var> be the <span>current node</span>.</p>

   </li>

   <li>

    <p>Determine the <var>adjusted insertion location</var> using the first matching steps
    from the following list:</p>

    <dl class="switch">

     <dt>If <span data-x="foster parent">foster parenting</span> is enabled and <var>target</var> is a <code>table</code>, <code>tbody</code>, <code>tfoot</code>,
     <code>thead</code>, or <code>tr</code> element</dt> <!-- same list as handling of characters
     in "in table" mode -->

     <dd>

      <p class="note">Foster parenting happens when content is misnested in tables.</p>

      <p>Run these substeps:</p>

      <ol>

       <li><p>Let <var>last template</var> be the last <code>template</code> element in the
       <span>stack of open elements</span>, if any.</p>

       <li><p>Let <var>last table</var> be the last <code>table</code> element in the
       <span>stack of open elements</span>, if any.</p>

       <li><p>If there is a <var>last template</var> and either there is no <var>last table</var>, or there is one, but <var>last template</var> is lower
       (more recently added) than <var>last table</var> in the <span>stack of open
       elements</span>, then: let <var>adjusted insertion location</var> be inside <var>last template</var>'s <span>template contents</span>, after its last child (if any),
       and abort these substeps.</p></li>

       <li><p>If there is no <var>last table</var>, <!-- there's also implicitly no last
       template, since we didn't hit the previous step --> then let <var>adjusted insertion
       location</var> be inside the first element in the <span>stack of open elements</span> (the
       <code>html</code> element), after its last child (if any), and abort these substeps.
       (<span>fragment case</span>)</p>

       <!-- if we get here, we know there's a last table, and if there's a last template, it's older
       than the last table. -->

       <li><p>If <var>last table</var> has a parent node, then let <var>adjusted insertion location</var> be inside <var>last table</var>'s parent
       node, immediately before <var>last table</var>, and abort these
       substeps.</p></li>

       <!-- if we get here, we know there's a last table, but it has no parent, and if there's a
       last template, it's older than the last table. -->

       <li><p>Let <var>previous element</var> be the element immediately above <var>last table</var> in the <span>stack of open elements</span>.</p></li>

       <li><p>Let <var>adjusted insertion location</var> be inside <var>previous
       element</var>, after its last child (if any).</p></li>

      </ol>

      <p class="note">These steps are involved in part because it's possible for elements, the
      <code>table</code> element in this case in particular, to have been moved by a script around
      in the DOM, or indeed removed from the DOM entirely, after the element was inserted by the
      parser.</p>

     </dd>

     <dt>Otherwise</dt>

     <dd>

      <p>Let <var>adjusted insertion location</var> be inside <var>target</var>,
      after its last child (if any).</p>

     </dd>

    </dl>

   </li>

   <li>

    <p>If the <var>adjusted insertion location</var> is inside a <code>template</code>
    element, let it instead be inside the <code>template</code> element's <span>template
    contents</span>, after its last child (if any).</p>

   </li>

   <li>

    <p>Return the <var>adjusted insertion location</var>.</p>

   </li>

  </ol>

  <hr>

  <p>When the steps below require the UA to <dfn data-x="create an element for the token">create an
  element for a token</dfn> in a particular <var>given namespace</var> and with a
  particular <var>intended parent</var>, the UA must run the following steps:</p>

  <ol>

   <li>

    <p>Create a node implementing the interface appropriate for the element type corresponding to
    the tag name of the token in <var>given namespace</var> (as given in the specification
    that defines that element, e.g. for an <code>a</code> element in the <span>HTML
    namespace</span>, this specification defines it to be the <code>HTMLAnchorElement</code>
    interface), with the tag name being the name of that element, with the node being in the given
    namespace, and with the attributes on the node being those given in the given token.</p>

    <p>The interface appropriate for an element in the <span>HTML namespace</span> that is not
    defined in this specification (or <span>other applicable specifications</span>) is
    <code>HTMLUnknownElement</code>. Elements in other namespaces whose interface is not defined by
    that namespace's specification must use the interface <code>Element</code>.</p>

    <p>The <span>node document</span> of the newly created element
    must be the <span>node document</span> of the <var>intended parent</var>.</p>

   </li>

   <li><p>If the newly created element has an <code>xmlns</code> attribute <em>in the
   <span>XMLNS namespace</span></em> whose value is not exactly the same as the element's namespace,
   that is a <span>parse error</span>. Similarly, if the newly created element has an <code
  >xmlns:xlink</code> attribute in the <span>XMLNS namespace</span> whose value is not the
   <span>XLink Namespace</span>, that is a <span>parse error</span>.</p></li>

   <li><p>If the newly created element is a <span data-x="category-reset">resettable element</span>,
   invoke its <span data-x="concept-form-reset-control">reset algorithm</span>. (This initializes the
   element's <span data-x="concept-fe-value">value</span> and <span
   data-x="concept-fe-checked">checkedness</span> based on the element's attributes.)</p></li>

   <li><p>If the element is a <span>form-associated element</span>, and the <span><code
  >form</code> element pointer</span> is not null, and there is no <code>template</code>
   element on the <span>stack of open elements</span>, and the newly created element is either not
   <span data-x="category-form-attr">reassociateable</span> or doesn't have a <code
   data-x="attr-fae-form">form</code> attribute, and the <var>intended parent</var> is in
   the same <span>home subtree</span> as the element pointed to by the <span><code
  >form</code> element pointer</span>, <span
   data-x="concept-form-association">associate</span> the newly created element with the
   <code>form</code> element pointed to by the <span><code>form</code> element
   pointer</span>, and suppress the running of the <span>reset the form owner</span> algorithm when
   the parser subsequently attempts to insert the element.</p></li>

   <li><p>Return the newly created element.</p></li>

  </ol>

  <hr>

  <!-- The names of these algorithms are kinda confusing; e.g. see the confusion in
         https://www.w3.org/Bugs/Public/show_bug.cgi?id=18367
       Not sure what we could call them instead, though... -->

  <p>When the steps below require the user agent to <dfn>insert a foreign element</dfn> for a token
  in a given namespace, the user agent must run these steps:</p>

  <ol>

   <li><p>Let the <var>adjusted insertion location</var> be the <span>appropriate place for
   inserting a node</span>.</p></li>

   <li><p><span>Create an element for the token</span> in the given namespace, with the intended
   parent being the element in which the <var>adjusted insertion location</var> finds
   itself.</p></li>

   <li>

    <p>If it is possible to insert an element at the <var>adjusted insertion
    location</var>, then insert the newly created element at the <var>adjusted insertion
    location</var>.</p>

    <p class="note">If the <var>adjusted insertion location</var> cannot accept more
    elements, e.g. because it's a <code>Document</code> that already has an element child, then the
    newly created element is dropped on the floor.</p>

   </li>

   <li><p>Push the element onto the <span>stack of open elements</span> so that it is the new
   <span>current node</span>.</p></li>

   <li><p>Return the newly created element.</p></li>

  </ol>

  <p>When the steps below require the user agent to <dfn>insert an HTML element</dfn> for a token,
  the user agent must <span>insert a foreign element</span> for the token, in the <span>HTML
  namespace</span>.</p>

  <hr>

  <p>When the steps below require the user agent to <dfn>adjust MathML attributes</dfn> for a token,
  then, if the token has an attribute named <code>definitionurl</code>, change its name to
  <code>definitionURL</code> (note the case difference).</p>

  <p>When the steps below require the user agent to <dfn>adjust SVG attributes</dfn> for a token,
  then, for each attribute on the token whose attribute name is one of the ones in the first column
  of the following table, change the attribute's name to the name given in the corresponding cell in
  the second column. (This fixes the case of SVG attributes that are not all lowercase.)</p>

  <table>
   <thead>
    <tr> <th> Attribute name on token <th> Attribute name on element
   <tbody>
    <tr> <td> <code>attributename</code> <td> <code>attributeName</code>
    <tr> <td> <code>attributetype</code> <td> <code>attributeType</code>
    <tr> <td> <code>basefrequency</code> <td> <code>baseFrequency</code>
    <tr> <td> <code>baseprofile</code> <td> <code>baseProfile</code>
    <tr> <td> <code>calcmode</code> <td> <code>calcMode</code>
    <tr> <td> <code>clippathunits</code> <td> <code>clipPathUnits</code>
    <tr> <td> <code>diffuseconstant</code> <td> <code>diffuseConstant</code>
    <tr> <td> <code>edgemode</code> <td> <code>edgeMode</code>
    <tr> <td> <code>filterunits</code> <td> <code>filterUnits</code>
    <tr> <td> <code>glyphref</code> <td> <code>glyphRef</code>
    <tr> <td> <code>gradienttransform</code> <td> <code>gradientTransform</code>
    <tr> <td> <code>gradientunits</code> <td> <code>gradientUnits</code>
    <tr> <td> <code>kernelmatrix</code> <td> <code>kernelMatrix</code>
    <tr> <td> <code>kernelunitlength</code> <td> <code>kernelUnitLength</code>
    <tr> <td> <code>keypoints</code> <td> <code>keyPoints</code>
    <tr> <td> <code>keysplines</code> <td> <code>keySplines</code>
    <tr> <td> <code>keytimes</code> <td> <code>keyTimes</code>
    <tr> <td> <code>lengthadjust</code> <td> <code>lengthAdjust</code>
    <tr> <td> <code>limitingconeangle</code> <td> <code>limitingConeAngle</code>
    <tr> <td> <code>markerheight</code> <td> <code>markerHeight</code>
    <tr> <td> <code>markerunits</code> <td> <code>markerUnits</code>
    <tr> <td> <code>markerwidth</code> <td> <code>markerWidth</code>
    <tr> <td> <code>maskcontentunits</code> <td> <code>maskContentUnits</code>
    <tr> <td> <code>maskunits</code> <td> <code>maskUnits</code>
    <tr> <td> <code>numoctaves</code> <td> <code>numOctaves</code>
    <tr> <td> <code>pathlength</code> <td> <code>pathLength</code>
    <tr> <td> <code>patterncontentunits</code> <td> <code>patternContentUnits</code>
    <tr> <td> <code>patterntransform</code> <td> <code>patternTransform</code>
    <tr> <td> <code>patternunits</code> <td> <code>patternUnits</code>
    <tr> <td> <code>pointsatx</code> <td> <code>pointsAtX</code>
    <tr> <td> <code>pointsaty</code> <td> <code>pointsAtY</code>
    <tr> <td> <code>pointsatz</code> <td> <code>pointsAtZ</code>
    <tr> <td> <code>preservealpha</code> <td> <code>preserveAlpha</code>
    <tr> <td> <code>preserveaspectratio</code> <td> <code>preserveAspectRatio</code>
    <tr> <td> <code>primitiveunits</code> <td> <code>primitiveUnits</code>
    <tr> <td> <code>refx</code> <td> <code>refX</code>
    <tr> <td> <code>refy</code> <td> <code>refY</code>
    <tr> <td> <code>repeatcount</code> <td> <code>repeatCount</code>
    <tr> <td> <code>repeatdur</code> <td> <code>repeatDur</code>
    <tr> <td> <code>requiredextensions</code> <td> <code>requiredExtensions</code>
    <tr> <td> <code>requiredfeatures</code> <td> <code>requiredFeatures</code>
    <tr> <td> <code>specularconstant</code> <td> <code>specularConstant</code>
    <tr> <td> <code>specularexponent</code> <td> <code>specularExponent</code>
    <tr> <td> <code>spreadmethod</code> <td> <code>spreadMethod</code>
    <tr> <td> <code>startoffset</code> <td> <code>startOffset</code>
    <tr> <td> <code>stddeviation</code> <td> <code>stdDeviation</code>
    <tr> <td> <code>stitchtiles</code> <td> <code>stitchTiles</code>
    <tr> <td> <code>surfacescale</code> <td> <code>surfaceScale</code>
    <tr> <td> <code>systemlanguage</code> <td> <code>systemLanguage</code>
    <tr> <td> <code>tablevalues</code> <td> <code>tableValues</code>
    <tr> <td> <code>targetx</code> <td> <code>targetX</code>
    <tr> <td> <code>targety</code> <td> <code>targetY</code>
    <tr> <td> <code>textlength</code> <td> <code>textLength</code>
    <tr> <td> <code>viewbox</code> <td> <code>viewBox</code>
    <tr> <td> <code>viewtarget</code> <td> <code>viewTarget</code>
    <tr> <td> <code>xchannelselector</code> <td> <code>xChannelSelector</code>
    <tr> <td> <code>ychannelselector</code> <td> <code>yChannelSelector</code>
    <tr> <td> <code>zoomandpan</code> <td> <code>zoomAndPan</code>
  </table>

  <p>When the steps below require the user agent to <dfn>adjust foreign attributes</dfn> for a
  token, then, if any of the attributes on the token match the strings given in the first column of
  the following table, let the attribute be a namespaced attribute, with the prefix being the string
  given in the corresponding cell in the second column, the local name being the string given in the
  corresponding cell in the third column, and the namespace being the namespace given in the
  corresponding cell in the fourth column. (This fixes the use of namespaced attributes, in
  particular <span data-x="attr-xml-lang"><code>lang</code> attributes in the <span>XML
  namespace</span></span>.)</p>

  <table>
   <thead>
    <tr> <th> Attribute name <th> Prefix <th> Local name <th> Namespace
   <tbody>
    <tr> <td> <code>xlink:actuate</code> <td> <code>xlink</code> <td> <code>actuate</code> <td> <span>XLink namespace</span>
    <tr> <td> <code>xlink:arcrole</code> <td> <code>xlink</code> <td> <code>arcrole</code> <td> <span>XLink namespace</span>
    <tr> <td> <code>xlink:href</code> <td> <code>xlink</code> <td> <code>href</code> <td> <span>XLink namespace</span>
    <tr> <td> <code>xlink:role</code> <td> <code>xlink</code> <td> <code>role</code> <td> <span>XLink namespace</span>
    <tr> <td> <code>xlink:show</code> <td> <code>xlink</code> <td> <code>show</code> <td> <span>XLink namespace</span>
    <tr> <td> <code>xlink:title</code> <td> <code>xlink</code> <td> <code>title</code> <td> <span>XLink namespace</span>
    <tr> <td> <code>xlink:type</code> <td> <code>xlink</code> <td> <code>type</code> <td> <span>XLink namespace</span>
    <tr> <td> <code>xml:lang</code> <td> <code>xml</code> <td> <code>lang</code> <td> <span>XML namespace</span>
    <tr> <td> <code>xml:space</code> <td> <code>xml</code> <td> <code>space</code> <td> <span>XML namespace</span>
    <tr> <td> <code>xmlns</code> <td> (none) <td> <code>xmlns</code> <td> <span>XMLNS namespace</span>
    <tr> <td> <code>xmlns:xlink</code> <td> <code>xmlns</code> <td> <code>xlink</code> <td> <span>XMLNS namespace</span>
  </table>

  <hr>

  <p>When the steps below require the user agent to <dfn>insert a character</dfn> while processing a
  token, the user agent must run the following steps:</p>

  <ol>

   <li><p>Let <var>data</var> be the characters passed to the algorithm, or, if no
   characters were explicitly specified, the character of the character token being
   processed.</p></li>

   <li><p>Let the <var>adjusted insertion location</var> be the <span>appropriate
   place for inserting a node</span>.</p></li>

   <li>

    <p>If the <var>adjusted insertion location</var> is in a <code>Document</code> node,
    then abort these steps.

    <p class="note">The DOM will not let <code>Document</code> nodes have <code>Text</code> node
    children, so they are dropped on the floor.</p>

   </li>

   <li>

    <p>If there is a <code>Text</code> node immediately before the <var>adjusted insertion
    location</var>, then append <var>data</var> to that <code>Text</code> node's data.</p>

    <p>Otherwise, create a new <code>Text</code> node whose data is <var>data</var> and
    whose <span>node document</span> is the same as that of the
    element in which the <var>adjusted insertion location</var> finds itself, and insert
    the newly created node at the <var>adjusted insertion location</var>.</p>

   </li>

  </ol>

  <div class="example">

   <p>Here are some sample inputs to the parser and the corresponding number of <code>Text</code>
   nodes that they result in, assuming a user agent that executes scripts.</p>

   <table>
    <thead>
     <tr>
      <th>Input <th>Number of <code>Text</code> nodes
    <tbody>
     <tr>
      <td><pre>A&lt;script>
var&nbsp;script&nbsp;=&nbsp;document.getElementsByTagName('script')[0];
document.body.removeChild(script);
&lt;/script>B</pre>
      <td>One <code>Text</code> node in the document, containing "AB".
     <tr>
      <td><pre>A&lt;script>
var&nbsp;text&nbsp;=&nbsp;document.createTextNode('B');
document.body.appendChild(text);
&lt;/script>C</pre>
      <td>Three <code>Text</code> nodes; "A" before the script, the script's contents, and "BC" after the script (the parser appends to the <code>Text</code> node created by the script).
     <tr>
      <td><pre>A&lt;script>
var&nbsp;text&nbsp;=&nbsp;document.getElementsByTagName('script')[0].firstChild;
text.data&nbsp;=&nbsp;'B';
document.body.appendChild(text);
&lt;/script>C</pre>
      <td>Two adjacent <code>Text</code> nodes in the document, containing "A" and "BC".
     <tr>
      <td><pre>A&lt;table>B&lt;tr>C&lt;/tr>D&lt;/table></pre>
      <td>One <code>Text</code> node before the table, containing "ABCD". (This is caused by <span data-x="foster parent">foster parenting</span>.)
     <tr>
      <td><pre>A&lt;table>&lt;tr>&nbsp;B&lt;/tr>&nbsp;C&lt;/table></pre>
      <td>One <code>Text</code> node before the table, containing "A&nbsp;B&nbsp;C" (A-space-B-space-C). (This is caused by <span data-x="foster parent">foster parenting</span>.)
     <tr>
      <td><pre>A&lt;table>&lt;tr>&nbsp;B&lt;/tr>&nbsp;&lt;/em>C&lt;/table></pre>
      <td>One <code>Text</code> node before the table, containing "A&nbsp;BC" (A-space-B-C), and one <code>Text</code> node inside the table (as a child of a <code>tbody</code>) with a single space character. (Space characters separated from non-space characters by non-character tokens are not affected by <span data-x="foster parent">foster parenting</span>, even if those other tokens then get ignored.)
   </table>

  </div>

  <hr>

  <p>When the steps below require the user agent to <dfn>insert a comment</dfn> while processing a
  comment token, optionally with an explicitly insertion position <var>position</var>, the
  user agent must run the following steps:</p>

  <ol>

   <li><p>Let <var>data</var> be the data given in the comment token being
   processed.</p></li>

   <li><p>If <var>position</var> was specified, then let the <var>adjusted
   insertion location</var> be <var>position</var>. Otherwise, let <var>adjusted
   insertion location</var> be the <span>appropriate place for inserting a node</span>.</p></li>

   <li><p>Create a <code>Comment</code> node whose <code>data</code> attribute is set to
   <var>data</var> and whose <span>node document</span> is
   the same as that of the node in which the <var>adjusted insertion location</var> finds
   itself.</p>

   <li><p>Insert the newly created node at the <var>adjusted insertion
   location</var>.</p></li>

  </ol>

  <hr>

  <p id="mutation-during-parsing">DOM mutation events must not fire for changes caused by the UA
  parsing the document. This includes the parsing of any content inserted using <code
  data-x="dom-document-write">document.write()</code> and <code
  data-x="dom-document-writeln">document.writeln()</code> calls. <a href="#refsUIEVENTS">\[UIEVENTS]</a></p>

  <p>However, <span>mutation observers</span> <em>do</em> fire, as required by the DOM specification.</p>



  <h5 id="parsing-elements-that-contain-only-text">Parsing elements that contain only text</h5>

  <p>The <dfn>generic raw text element parsing algorithm</dfn> and the <dfn>generic RCDATA element
  parsing algorithm</dfn> consist of the following steps. These algorithms are always invoked in
  response to a start tag token.</p>

  <ol>

   <li><p><span>Insert an HTML element</span> for the token.</p></li>

   <li><p>If the algorithm that was invoked is the <span>generic raw text element parsing
   algorithm</span>, switch the tokenizer to the <span>RAWTEXT state</span>; otherwise the algorithm
   invoked was the <span>generic RCDATA element parsing algorithm</span>, switch the tokenizer to
   the <span>RCDATA state</span>.</p></li>

   <li><p>Let the <span>original insertion mode</span> be the current <span>insertion
   mode</span>.</p>

   <li><p>Then, switch the <span>insertion mode</span> to "<span data-x="insertion mode:
   text">text</span>".</p></li>

  </ol>


  <h5 id="closing-elements-that-have-implied-end-tags">Closing elements that have implied end tags</h5>

  <!-- FORK -->
<!--CLEANUP-->
  <p>When the steps below require the UA to <dfn>generate implied end
  tags</dfn>, then, while the <span>current node</span> is a
  <code>dd</code> element, a <code>dt</code> element, an
  <code>li</code> element, an <code>option</code> element, an
  <code>optgroup</code> element, a <code>p</code> element, an
  <code>rb</code> element, an <code>rp</code> element, an <code>rt</code>
  element, or an <code>rtc</code> element, the UA must
  pop the <span>current node</span> off the <span>stack of open
  elements</span>.</p>
  <!-- /FORK -->

<!--CLEANUP-->
  <p>If a step requires the UA to generate implied end tags but lists
  an element to exclude from the process, then the UA must perform the
  above steps as if that element was not in the above list.</p>

  <p>When the steps below require the UA to <dfn>generate all implied end tags thoroughly</dfn>,
  then, while the <span>current node</span> is a <code>caption</code> element, a
  <code>colgroup</code> element, a <code>dd</code> element, a <code>dt</code> element, an
  <code>li</code> element, an <code>optgroup</code> element, an <code>option</code> element, a
  <code>p</code> element, an <code>rb</code> element, an <code>rp</code> element, an <code>rt</code>
  element, an <code>rtc</code> element, a <code>tbody</code> element, a <code>td</code> element, a
  <code>tfoot</code> element, a <code>th</code> element, a <code>thead</code> element, or a
  <code>tr</code> element, the UA must pop the <span>current node</span> off the
  <span>stack of open elements</span>.</p>



  <h5 id="parsing-main-inhtml">The rules for parsing tokens in HTML content</h5>


  <h6>The "<dfn data-x="insertion mode: initial">initial</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode:
  initial">initial</span>" <span>insertion mode</span>, the user agent must handle the token as
  follows:</p>

  <dl class="switch">

   <dt>A character token that is one of U+0009 CHARACTER
   TABULATION, U+000A LINE FEED (LF), U+000C FORM FEED (FF),
   U+000D CARRIAGE RETURN (CR), or U+0020 SPACE</dt>
   <dd>
    <p>Ignore the token.</p>
   </dd>

   <dt>A comment token</dt>
   <dd>
    <p><span>Insert a comment</span> as the last child of the <code>Document</code> object.</p>
   </dd>

   <dt>A DOCTYPE token</dt>
   <dd>

    <p>If the DOCTYPE token's name is not a <span>case-sensitive</span> match for the string "<code
   >html</code>", or the token's public identifier is not missing, or the token's system
    identifier is neither missing nor a <span>case-sensitive</span> match for the string
    "<code>about:legacy-compat</code>", and none of the sets of conditions in the following list are
    matched, then there is a <span>parse error</span>.</p>

    <ul>

     <!-- only things that trigger no-quirks mode and were valid in some other spec are allowed in
     this list -->

     <li>The DOCTYPE token's name is a <span>case-sensitive</span> match for the string "<code
    >html</code>", the token's public identifier is the <span>case-sensitive</span> string
     "<code>-//W3C//DTD&nbsp;HTML&nbsp;4.0//EN</code>", and the token's system identifier
     is either missing or the <span>case-sensitive</span> string "<code
    >http://www.w3.org/TR/REC-html40/strict.dtd</code>".</li>

     <li>The DOCTYPE token's name is a <span>case-sensitive</span> match for the string "<code
    >html</code>", the token's public identifier is the <span>case-sensitive</span> string
     "<code>-//W3C//DTD&nbsp;HTML&nbsp;4.01//EN</code>", and the token's system identifier
     is either missing or the <span>case-sensitive</span> string "<code
    >http://www.w3.org/TR/html4/strict.dtd</code>".</li>

     <li>The DOCTYPE token's name is a <span>case-sensitive</span> match for the string "<code
    >html</code>", the token's public identifier is the <span>case-sensitive</span> string
     "<code>-//W3C//DTD&nbsp;XHTML&nbsp;1.0&nbsp;Strict//EN</code>", and the token's system
     identifier is the <span>case-sensitive</span> string "<code
    >http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd</code>".</li>

     <li>The DOCTYPE token's name is a <span>case-sensitive</span> match for the string "<code
    >html</code>", the token's public identifier is the <span>case-sensitive</span> string
     "<code>-//W3C//DTD&nbsp;XHTML&nbsp;1.1//EN</code>", and the token's system identifier
     is the <span>case-sensitive</span> string "<code
    >http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd</code>".</li>

    </ul>

    <p>Conformance checkers may, based on the values (including presence or lack thereof) of the
    DOCTYPE token's name, public identifier, or system identifier, switch to a conformance checking
    mode for another language (e.g. based on the DOCTYPE token a conformance checker could recognize
    that the document is an HTML4-era document, and defer to an HTML4 conformance checker.)</p>

    <p>Append a <code>DocumentType</code> node to the <code>Document</code> node, with the <code
   >name</code> attribute set to the name given in the DOCTYPE token, or the empty string
    if the name was missing; the <code>publicId</code> attribute set to the public
    identifier given in the DOCTYPE token, or the empty string if the public identifier was missing;
    the <code>systemId</code> attribute set to the system identifier given in the DOCTYPE
    token, or the empty string if the system identifier was missing; and the other attributes
    specific to <code>DocumentType</code> objects set to null and empty lists as appropriate.
    Associate the <code>DocumentType</code> node with the <code>Document</code> object so that it is
    returned as the value of the <code>doctype</code> attribute of the
    <code>Document</code> object.</p>

    <p id="quirks-mode-doctypes">Then, if the document is <em>not</em> <span>an <code>iframe</code>
    <code data-x="attr-iframe-srcdoc">srcdoc</code> document</span>, and the DOCTYPE token matches
    one of the conditions in the following list, then set the <code>Document</code> to <span>quirks
    mode</span>:</p>

    <ul class="brief">
     <li> The <i data-x="force-quirks flag">force-quirks flag</i> is set to <i>on</i>. </li>
     <li> The name is set to anything other than "<code>html</code>" (compared <span data-x="case-sensitive">case-sensitively</span>). </li>
     <li> The public identifier is set to: "<code>-//W3O//DTD W3 HTML Strict 3.0//EN//</code>" </li>
     <li> The public identifier is set to: "<code>-/W3C/DTD HTML 4.0 Transitional/EN</code>" </li>
     <li> The public identifier is set to: "<code>HTML</code>" </li>
     <li> The system identifier is set to: "<code>http://www.ibm.com/data/dtd/v11/ibmxhtml1-transitional.dtd</code>" </li>
     <li> The public identifier starts with: "<code>+//Silmaril//dtd html Pro v0r11 19970101//</code>" </li>
     <li> The public identifier starts with: "<code>-//AS//DTD HTML 3.0 asWedit + extensions//</code>" </li>
     <li> The public identifier starts with: "<code>-//AdvaSoft Ltd//DTD HTML 3.0 asWedit + extensions//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML 2.0 Level 1//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML 2.0 Level 2//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML 2.0 Strict Level 1//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML 2.0 Strict Level 2//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML 2.0 Strict//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML 2.0//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML 2.1E//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML 3.0//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML 3.2 Final//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML 3.2//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML 3//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML Level 0//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML Level 1//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML Level 2//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML Level 3//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML Strict Level 0//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML Strict Level 1//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML Strict Level 2//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML Strict Level 3//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML Strict//</code>" </li>
     <li> The public identifier starts with: "<code>-//IETF//DTD HTML//</code>" </li>
     <li> The public identifier starts with: "<code>-//Metrius//DTD Metrius Presentational//</code>" </li>
     <li> The public identifier starts with: "<code>-//Microsoft//DTD Internet Explorer 2.0 HTML Strict//</code>" </li>
     <li> The public identifier starts with: "<code>-//Microsoft//DTD Internet Explorer 2.0 HTML//</code>" </li>
     <li> The public identifier starts with: "<code>-//Microsoft//DTD Internet Explorer 2.0 Tables//</code>" </li>
     <li> The public identifier starts with: "<code>-//Microsoft//DTD Internet Explorer 3.0 HTML Strict//</code>" </li>
     <li> The public identifier starts with: "<code>-//Microsoft//DTD Internet Explorer 3.0 HTML//</code>" </li>
     <li> The public identifier starts with: "<code>-//Microsoft//DTD Internet Explorer 3.0 Tables//</code>" </li>
     <li> The public identifier starts with: "<code>-//Netscape Comm. Corp.//DTD HTML//</code>" </li>
     <li> The public identifier starts with: "<code>-//Netscape Comm. Corp.//DTD Strict HTML//</code>" </li>
     <li> The public identifier starts with: "<code>-//O'Reilly and Associates//DTD HTML 2.0//</code>" </li>
     <li> The public identifier starts with: "<code>-//O'Reilly and Associates//DTD HTML Extended 1.0//</code>" </li>
     <li> The public identifier starts with: "<code>-//O'Reilly and Associates//DTD HTML Extended Relaxed 1.0//</code>" </li>
     <li> The public identifier starts with: "<code>-//SQ//DTD HTML 2.0 HoTMetaL + extensions//</code>" </li>
     <li> The public identifier starts with: "<code>-//SoftQuad Software//DTD HoTMetaL PRO 6.0::19990601::extensions to HTML 4.0//</code>" </li>
     <li> The public identifier starts with: "<code>-//SoftQuad//DTD HoTMetaL PRO 4.0::19971010::extensions to HTML 4.0//</code>" </li>
     <li> The public identifier starts with: "<code>-//Spyglass//DTD HTML 2.0 Extended//</code>" </li>
     <li> The public identifier starts with: "<code>-//Sun Microsystems Corp.//DTD HotJava HTML//</code>" </li>
     <li> The public identifier starts with: "<code>-//Sun Microsystems Corp.//DTD HotJava Strict HTML//</code>" </li>
     <li> The public identifier starts with: "<code>-//W3C//DTD HTML 3 1995-03-24//</code>" </li>
     <li> The public identifier starts with: "<code>-//W3C//DTD HTML 3.2 Draft//</code>" </li>
     <li> The public identifier starts with: "<code>-//W3C//DTD HTML 3.2 Final//</code>" </li>
     <li> The public identifier starts with: "<code>-//W3C//DTD HTML 3.2//</code>" </li>
     <li> The public identifier starts with: "<code>-//W3C//DTD HTML 3.2S Draft//</code>" </li>
     <li> The public identifier starts with: "<code>-//W3C//DTD HTML 4.0 Frameset//</code>" </li>
     <li> The public identifier starts with: "<code>-//W3C//DTD HTML 4.0 Transitional//</code>" </li>
     <li> The public identifier starts with: "<code>-//W3C//DTD HTML Experimental 19960712//</code>" </li>
     <li> The public identifier starts with: "<code>-//W3C//DTD HTML Experimental 970421//</code>" </li>
     <li> The public identifier starts with: "<code>-//W3C//DTD W3 HTML//</code>" </li>
     <li> The public identifier starts with: "<code>-//W3O//DTD W3 HTML 3.0//</code>" </li>
     <li> The public identifier starts with: "<code>-//WebTechs//DTD Mozilla HTML 2.0//</code>" </li>
     <li> The public identifier starts with: "<code>-//WebTechs//DTD Mozilla HTML//</code>" </li>
     <li> The system identifier is missing and the public identifier starts with: "<code>-//W3C//DTD HTML 4.01 Frameset//</code>" </li>
     <li> The system identifier is missing and the public identifier starts with: "<code>-//W3C//DTD HTML 4.01 Transitional//</code>" </li>
    </ul>

    <p>Otherwise, if the document is <em>not</em> <span>an <code>iframe</code> <code
    data-x="attr-iframe-srcdoc">srcdoc</code> document</span>, and the DOCTYPE token matches one of
    the conditions in the following list, then set the <code>Document</code> to <span>limited-quirks
    mode</span>:</p>

    <ul class="brief">
     <li> The public identifier starts with: "<code>-//W3C//DTD XHTML 1.0 Frameset//</code>" </li>
     <li> The public identifier starts with: "<code>-//W3C//DTD XHTML 1.0 Transitional//</code>" </li>
     <li> The system identifier is not missing and the public identifier starts with: "<code>-//W3C//DTD HTML 4.01 Frameset//</code>" </li>
     <li> The system identifier is not missing and the public identifier starts with: "<code>-//W3C//DTD HTML 4.01 Transitional//</code>" </li>
    </ul>

    <p>The system identifier and public identifier strings must be compared to the values given in
    the lists above in an <span>ASCII case-insensitive</span> manner. A system identifier whose
    value is the empty string is not considered missing for the purposes of the conditions
    above.</p>

    <p>Then, switch the <span>insertion mode</span> to "<span data-x="insertion mode: before
    html">before html</span>".</p>

   </dd>

   <dt>Anything else</dt>
   <dd>

    <p>If the document is <em>not</em> <span>an <code>iframe</code> <code
    data-x="attr-iframe-srcdoc">srcdoc</code> document</span>, then this is a <span>parse
    error</span>; set the <code>Document</code> to <span>quirks mode</span>.</p>

    <p>In any case, switch the <span>insertion mode</span> to "<span data-x="insertion mode: before
    html">before html</span>", then reprocess the token.</p>

   </dd>

  </dl>


  <h6>The "<dfn data-x="insertion mode: before html">before html</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: before
  html">before html</span>" <span>insertion mode</span>, the user agent must handle the token as
  follows:</p>

  <dl class="switch">

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A comment token</dt>
   <dd>
    <p><span>Insert a comment</span> as the last child of the <code>Document</code> object.</p>
   </dd>

   <dt>A character token that is one of U+0009 CHARACTER TABULATION, U+000A LINE FEED (LF), U+000C
   FORM FEED (FF), U+000D CARRIAGE RETURN (CR), or U+0020 SPACE</dt>
   <dd>
    <p>Ignore the token.</p>
   </dd>

   <dt>A start tag whose tag name is "html"</dt>
   <dd>

    <p><span>Create an element for the token</span> in the <span>HTML namespace</span>, with the
    <code>Document</code> as the intended parent. Append it to the <code>Document</code> object. Put
    this element in the <span>stack of open elements</span>.</p>

    <p id="parser-appcache">If the <code>Document</code> is being loaded as part of <span
    data-x="navigate">navigation</span> of a <span>browsing context</span>, run these steps:</p>

    <ol>

     <li><p>If the result of running <span data-x="scope-match-algorithm">match service worker
     registration</span> for <span>the <code>Document</code>'s address</span> is non-null, run the
     <span data-x="concept-appcache-init">application cache selection algorithm</span> passing the
     <code>Document</code> object with no manifest.</p></li>

     <li>

      <p>Otherwise, run these substeps:</p>

      <ol>

       <li><p>If the newly created element has a <code data-x="attr-html-manifest">manifest</code>
       attribute whose value is not the empty string, then <span data-x="resolve a
       url">resolve</span> the value of that attribute to an <span>absolute URL</span>, relative to
       the newly created element, and if that is  successful, run the <span
       data-x="concept-appcache-init">application cache selection algorithm</span> passing the
       <code>Document</code> object with the result of applying the <span
       data-x="concept-url-serializer">URL serializer</span> algorithm to the resulting <span>parsed
       URL</span> with the <i>exclude fragment flag</i> set.</p></li>

       <li><p>Otherwise, run the <span data-x="concept-appcache-init">application cache selection
       algorithm</span> passing the <code>Document</code> object with no manifest.</p></li>

      </ol>

     </li>

    </ol>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: before head">before
    head</span>".</p>

   </dd>

   <dt>An end tag whose tag name is one of: "head", "body", "html", "br"</dt>
   <dd>
    <p>Act as described in the "anything else" entry below.</p>
   </dd>

   <dt>Any other end tag</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>Anything else</dt>
   <dd>

    <p>Create an <code>html</code> element whose <span>node document</span> is the <code>Document</code> object. Append
    it to the <code>Document</code> object. Put this element in the <span>stack of open
    elements</span>.</p>

    <p>If the <code>Document</code> is being loaded as part of <span
    data-x="navigate">navigation</span> of a <span>browsing context</span>, then: run the <span
    data-x="concept-appcache-init">application cache selection algorithm</span> with no manifest,
    passing it the <code>Document</code> object.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: before head">before
    head</span>", then reprocess the token.</p>

   </dd>

  </dl>

  <p>The root element can end up being removed from the <code>Document</code> object, e.g. by
  scripts; nothing in particular happens in such cases, content continues being appended to the
  nodes as described in the next section.</p>


  <h6>The "<dfn data-x="insertion mode: before head">before head</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: before
  head">before head</span>" <span>insertion mode</span>, the user agent must handle the token as
  follows:</p>

  <dl class="switch">

   <dt>A character token that is one of U+0009 CHARACTER
   TABULATION, U+000A LINE FEED (LF), U+000C FORM FEED (FF),
   U+000D CARRIAGE RETURN (CR), or U+0020 SPACE</dt>
   <dd>
    <p>Ignore the token.</p> <!-- :-( -->
   </dd>

   <dt>A comment token</dt>
   <dd>
    <p><span>Insert a comment</span>.</p>
   </dd>

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A start tag whose tag name is "html"</dt>
   <dd>
    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>
   </dd>

   <dt>A start tag whose tag name is "head"</dt>
   <dd>

    <p><span>Insert an HTML element</span> for the token.</p>

    <p>Set the <span><code>head</code> element pointer</span> to the newly created
    <code>head</code> element.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in head">in
    head</span>".</p>

   </dd>

   <dt>An end tag whose tag name is one of: "head", "body", "html", "br"</dt>
   <dd>

    <p>Act as described in the "anything else" entry below.</p>

   </dd>

   <dt>Any other end tag</dt>
   <dd>

    <p><span>Parse error</span>. Ignore the token.</p>

   </dd>

   <dt>Anything else</dt>
   <dd>

    <!-- fake <head> -->

    <p><span>Insert an HTML element</span> for a "head" start tag token with no attributes.</p>

    <p>Set the <span><code>head</code> element pointer</span> to the newly created
    <code>head</code> element.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in head">in
    head</span>".</p>

    <!-- end of fake <head> -->

    <p>Reprocess the current token.</p>

   </dd>

  </dl>


  <h6 id="parsing-main-inhead">The "<dfn data-x="insertion mode: in head">in head</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: in head">in
  head</span>" <span>insertion mode</span>, the user agent must handle the token as follows:</p>

  <dl class="switch">

   <dt>A character token that is one of U+0009 CHARACTER
   TABULATION, U+000A LINE FEED (LF), U+000C FORM FEED (FF),
   U+000D CARRIAGE RETURN (CR), or U+0020 SPACE</dt>
   <dd>
    <p><span data-x="insert a character">Insert the character</span>.</p>
   </dd>

   <dt>A comment token</dt>
   <dd>
    <p><span>Insert a comment</span>.</p>
   </dd>

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A start tag whose tag name is "html"</dt>
   <dd>
    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>
   </dd>

   <dt>A start tag whose tag name is one of: "base", "basefont",
   "bgsound", "link"</dt>
   <dd>

    <p><span>Insert an HTML element</span> for the token. Immediately pop the <span>current
    node</span> off the <span>stack of open elements</span>.</p>

    <p><span data-x="acknowledge self-closing flag">Acknowledge the token's <i data-x="self-closing flag">self-closing
    flag</i></span>, if it is set.</p>

   </dd>

   <dt>A start tag whose tag name is "meta"</dt>
   <dd>

    <p><span>Insert an HTML element</span> for the token. Immediately pop the <span>current
    node</span> off the <span>stack of open elements</span>.</p>

    <p><span data-x="acknowledge self-closing flag">Acknowledge the token's <i data-x="self-closing flag">self-closing
    flag</i></span>, if it is set.</p>

    <p id="meta-charset-during-parse">If the element has a <code
    data-x="attr-meta-charset">charset</code> attribute, and <span>getting an encoding</span> from
    its value results in an <span>encoding</span>, and the
    <span data-x="concept-encoding-confidence">confidence</span> is currently <i>tentative</i>, then
    <span>change the encoding</span> to the resulting encoding.</p>

    <p>Otherwise, if the element has an <code data-x="attr-meta-http-equiv">http-equiv</code>
    attribute whose value is an <span>ASCII case-insensitive</span> match for the string "<code
   >Content-Type</code>", and the element has a <code
    data-x="attr-meta-content">content</code> attribute, and applying the <span>algorithm for
    extracting a character encoding from a <code>meta</code> element</span> to that attribute's
    value returns an <span>encoding</span>, and the
    <span data-x="concept-encoding-confidence">confidence</span> is currently <i>tentative</i>, then
    <span>change the encoding</span> to the extracted encoding.</p>

   </dd>

   <dt>A start tag whose tag name is "title"</dt>
   <dd>
    <p>Follow the <span>generic RCDATA element parsing algorithm</span>.</p>
   </dd>

   <dt>A start tag whose tag name is "noscript", if the <span>scripting flag</span> is enabled</dt>
   <dt>A start tag whose tag name is one of: "noframes", "style"</dt>
   <dd>
    <p>Follow the <span>generic raw text element parsing algorithm</span>.</p>
   </dd>

   <dt>A start tag whose tag name is "noscript", if the <span>scripting flag</span> is disabled</dt>
   <dd>

    <p><span>Insert an HTML element</span> for the token.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in head noscript">in
    head noscript</span>".</p>

   </dd>


   <dt id="scriptTag">A start tag whose tag name is "script"</dt>
   <dd>

    <p>Run these steps:</p>

    <ol>

     <li><p>Let the <var>adjusted insertion location</var> be the <span>appropriate place
     for inserting a node</span>.</p></li>

     <li><p><span>Create an element for the token</span> in the <span>HTML namespace</span>, with
     the intended parent being the element in which the <var>adjusted insertion
     location</var> finds itself.</p></li>

     <li>

      <p>Mark the element as being <span>"parser-inserted"</span> and unset the element's
      <span>"non-blocking"</span> flag.</p>

      <p class="note">This ensures that, if the script is external, any <code
      data-x="dom-document-write">document.write()</code> calls in the script will execute in-line,
      instead of blowing the document away, as would happen in most other cases. It also prevents
      the script from executing until the end tag is seen.</p>

     </li>

     <li><p>If the parser was originally created for the <span>HTML fragment parsing
     algorithm</span>, then mark the <code>script</code> element as <span>"already started"</span>.
     (<span>fragment case</span>)</p></li>

     <li><p>Insert the newly created element at the <var>adjusted insertion
     location</var>.</p></li>

     <li><p>Push the element onto the <span>stack of open elements</span> so that it is the new
     <span>current node</span>.</p></li>

     <li><p>Switch the tokenizer to the <span>script data state</span>.</p></li>

     <li><p>Let the <span>original insertion mode</span> be the current <span>insertion
     mode</span>.</p>

     <li><p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode:
     text">text</span>".</p></li>

    </ol>

   </dd>

   <dt>An end tag whose tag name is "head"</dt>
   <dd>

    <p>Pop the <span>current node</span> (which will be the <code>head</code> element) off the
    <span>stack of open elements</span>.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: after head">after
    head</span>".</p>

   </dd>

   <dt>An end tag whose tag name is one of: "body", "html", "br"</dt>
   <dd>
    <p>Act as described in the "anything else" entry below.</p>
   </dd>

   <dt>A start tag whose tag name is "template"</dt>
   <dd>

    <p><span>Insert an HTML element</span> for the token.</p>

    <p>Insert a <span data-x="concept-parser-marker">marker</span> at the end of the <span>list of
    active formatting elements</span>.</p>

    <p>Set the <span>frameset-ok flag</span> to "not ok".</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in template">in
    template</span>".</p>

    <p>Push "<span data-x="insertion mode: in template">in template</span>" onto the <span>stack of
    template insertion modes</span> so that it is the new <span>current template insertion
    mode</span>.</p>

   </dd>

   <dt>An end tag whose tag name is "template"</dt>
   <dd>

    <p>If there is no <code>template</code> element on the <span>stack of open elements</span>, then
    this is a <span>parse error</span>; ignore the token.</p>

    <p>Otherwise, run these steps:</p>

    <ol>

     <li><p><span>Generate all implied end tags thoroughly</span>.</p></li>

     <li><p>If the <span>current node</span> is not a <code>template</code> element, then this is a
     <span>parse error</span>.</p></li>

     <li><p>Pop elements from the <span>stack of open elements</span> until a <code>template</code>
     element has been popped from the stack.</p></li>

     <li><span>Clear the list of active formatting elements up to the last marker</span>.</li>

     <li><p>Pop the <span>current template insertion mode</span> off the <span>stack of template
     insertion modes</span>.</p>

     <li><p><span>Reset the insertion mode appropriately</span>.</p></li>

    </ol>

   </dd>

   <dt>A start tag whose tag name is "head"</dt>
   <dt>Any other end tag</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>Anything else</dt>
   <dd>

    <!-- can't get here with an EOF and a fragment case -->

    <!-- start of fake </head> -->
    <p>Pop the <span>current node</span> (which will be the <code>head</code> element) off the
    <span>stack of open elements</span>.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: after head">after
    head</span>".</p>
    <!-- end of fake </head> -->

    <p>Reprocess the token.</p>

   </dd>

  </dl>


  <h6 id="parsing-main-inheadnoscript">The "<dfn data-x="insertion mode: in head noscript">in head noscript</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: in head
  noscript">in head noscript</span>" <span>insertion mode</span>, the user agent must handle the
  token as follows:</p>

  <dl class="switch">

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A start tag whose tag name is "html"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>An end tag whose tag name is "noscript"</dt>
   <dd>

    <p>Pop the <span>current node</span> (which will be a <code>noscript</code> element) from the
    <span>stack of open elements</span>; the new <span>current node</span> will be a
    <code>head</code> element.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in head">in
    head</span>".</p>

   </dd>

   <dt>A character token that is one of U+0009 CHARACTER TABULATION, U+000A LINE FEED (LF), U+000C
   FORM FEED (FF), U+000D CARRIAGE RETURN (CR), or U+0020 SPACE</dt>
   <dt>A comment token</dt>
   <dt>A start tag whose tag name is one of: "basefont", "bgsound", "link", "meta", "noframes",
   "style"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    head">in head</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>An end tag whose tag name is "br"</dt>
   <dd>
    <p>Act as described in the "anything else" entry below.</p>
   </dd>

   <dt>A start tag whose tag name is one of: "head", "noscript"</dt>
   <dt>Any other end tag</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>Anything else</dt>
   <dd>

    <!-- can't get here with an EOF and a fragment case -->

    <p><span>Parse error</span>.</p>

    <!-- fake </noscript> -->
    <p>Pop the <span>current node</span> (which will be a <code>noscript</code> element) from the
    <span>stack of open elements</span>; the new <span>current node</span> will be a
    <code>head</code> element.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in head">in
    head</span>".</p>
    <!-- end fake </noscript> -->

    <p>Reprocess the token.</p>

   </dd>

  </dl>


  <h6>The "<dfn data-x="insertion mode: after head">after head</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: after
  head">after head</span>" <span>insertion mode</span>, the user agent must handle the token as
  follows:</p>

  <dl class="switch">

   <dt>A character token that is one of U+0009 CHARACTER
   TABULATION, U+000A LINE FEED (LF), U+000C FORM FEED (FF),
   U+000D CARRIAGE RETURN (CR), or U+0020 SPACE</dt>
   <dd>
    <p><span data-x="insert a character">Insert the character</span>.</p>
   </dd>

   <dt>A comment token</dt>
   <dd>
    <p><span>Insert a comment</span>.</p>
   </dd>

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A start tag whose tag name is "html"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>A start tag whose tag name is "body"</dt>
   <dd>

    <p><span>Insert an HTML element</span> for the token.</p>

    <p>Set the <span>frameset-ok flag</span> to "not ok".</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in body">in
    body</span>".</p>

   </dd>

   <dt>A start tag whose tag name is "frameset"</dt>
   <dd>

    <p><span>Insert an HTML element</span> for the token.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in frameset">in
    frameset</span>".</p>

   </dd>

   <dt>A start tag whose tag name is one of: "base", "basefont", "bgsound", "link", "meta",
   "noframes", "script", "style", "template", "title"</dt>
   <dd>

    <p><span>Parse error</span>.</p>

    <p>Push the node pointed to by the <span><code>head</code> element pointer</span> onto
    the <span>stack of open elements</span>.</p>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    head">in head</span>" <span>insertion mode</span>.</p>

    <p>Remove the node pointed to by the <span><code>head</code> element pointer</span>
    from the <span>stack of open elements</span>. (It might not be the <span>current node</span> at
    this point.)</p>

    <p class="note">The <span><code>head</code> element pointer</span> cannot be null at
    this point.</p>

   </dd>

   <dt>An end tag whose tag name is "template"</dt>
   <dd>
    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    head">in head</span>" <span>insertion mode</span>.</p>
   </dd>

   <dt>An end tag whose tag name is one of: "body", "html", "br"</dt>
   <dd>
    <p>Act as described in the "anything else" entry below.</p>
   </dd>

   <dt>A start tag whose tag name is "head"</dt>
   <dt>Any other end tag</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>Anything else</dt>
   <dd>

    <!-- fake <body>, but without resetting frameset-ok -->
    <p><span>Insert an HTML element</span> for a "body" start tag token with no attributes.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in body">in
    body</span>".</p>
    <!-- end fake <body> -->

    <p>Reprocess the current token.</p>

   </dd>

  </dl>


  <h6 id="parsing-main-inbody">The "<dfn data-x="insertion mode: in body">in body</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: in body">in
  body</span>" <span>insertion mode</span>, the user agent must handle the token as follows:</p>

  <dl class="switch">

   <dt>A character token that is U+0000 NULL</dt>
   <dd>

    <p><span>Parse error</span>. Ignore the token.</p>

    <!-- The D-Link DSL-G604T ADSL router has a zero byte in its
         configuration UI before a <frameset>, which is why U+0000 is
         special-cased here.
         refs: https://bugzilla.mozilla.org/show_bug.cgi?id=563526
               https://www.w3.org/Bugs/Public/show_bug.cgi?id=9659
    -->

   </dd>

   <dt>A character token that is one of U+0009 CHARACTER TABULATION,
   U+000A LINE FEED (LF), U+000C FORM FEED (FF), U+000D CARRIAGE
   RETURN (CR), or U+0020 SPACE</dt>
   <dd>

    <p><span>Reconstruct the active formatting elements</span>, if any.</p>

    <p><span data-x="insert a character">Insert the token's character</span>.</p>

   </dd>

   <dt>Any other character token</dt>
   <dd>

    <p><span>Reconstruct the active formatting elements</span>, if any.</p>

    <p><span data-x="insert a character">Insert the token's character</span>.</p>

    <p>Set the <span>frameset-ok flag</span> to "not ok".</p>

   </dd>

   <dt>A comment token</dt>
   <dd>
    <p><span>Insert a comment</span>.</p>
   </dd>

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A start tag whose tag name is "html"</dt>
   <dd>

    <p><span>Parse error</span>.</p>

    <p>If there is a <code>template</code> element on the <span>stack of open elements</span>, then
    ignore the token.</p>

    <p>Otherwise, for each attribute on the token, check to see if the attribute is already present
    on the top element of the <span>stack of open elements</span>. If it is not, add the attribute
    and its corresponding value to that element.</p>

   </dd>

   <dt>A start tag whose tag name is one of: "base", "basefont", "bgsound", "link", "meta",
   "noframes", "script", "style", "template", "title"</dt>
   <dt>An end tag whose tag name is "template"</dt>
   <dd>
    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    head">in head</span>" <span>insertion mode</span>.</p>
   </dd>

   <dt>A start tag whose tag name is "body"</dt>
   <dd>

    <p><span>Parse error</span>.</p>

    <p>If the second element on the <span>stack of open elements</span> is not a <code>body</code>
    element, if the <span>stack of open elements</span> has only one node on it, or if there is a
    <code>template</code> element on the <span>stack of open elements</span>, then ignore the token.
    (<span>fragment case</span>)</p>

    <p>Otherwise, set the <span>frameset-ok flag</span> to "not ok"; then, for each attribute on the
    token, check to see if the attribute is already present on the <code>body</code> element (the
    second element) on the <span>stack of open elements</span>, and if it is not, add the attribute
    and its corresponding value to that element.</p>

   </dd>

   <dt>A start tag whose tag name is "frameset"</dt>
   <dd>

    <p><span>Parse error</span>.</p>

    <p>If the <span>stack of open elements</span> has only one node on it, or if the second element
    on the <span>stack of open elements</span> is not a <code>body</code> element, then ignore the
    token. (<span>fragment case</span>)</p>

    <p>If the <span>frameset-ok flag</span> is set to "not ok", ignore the token.</p>

    <p>Otherwise, run the following steps:</p>

    <ol>

     <li><p>Remove the second element on the <span>stack of open elements</span> from its parent
     node, if it has one.</p></li>

     <li><p>Pop all the nodes from the bottom of the <span>stack of open elements</span>, from the
     <span>current node</span> up to, but not including, the root <code>html</code> element.</p>

     <li><p><span>Insert an HTML element</span> for the token.</p></li>

     <li><p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in frameset">in
     frameset</span>".</p>

    </ol>

   </dd>

   <dt>An end-of-file token</dt>
   <dd>

    <p>If the <span>stack of template insertion modes</span> is not empty, then process the token
    <span>using the rules for</span> the "<span data-x="insertion mode: in template">in
    template</span>" <span>insertion mode</span>.</p>
    <!-- this is needed to handle <head><template>...\[EOF] - otherwise we don't construct the <body> element -->

    <p>Otherwise, follow these steps:</p>

    <ol>

     <li><p>If there is a node in the <span>stack of open elements</span> that is not either a
     <code>dd</code> element, a <code>dt</code> element, an <code>li</code> element, an
     <code>optgroup</code> element, an <code>option</code> element, a <code>p</code> element, an
     <code>rb</code> element, an <code>rp</code> element, an <code>rt</code> element, an
     <code>rtc</code> element, a <code>tbody</code> element, a <code>td</code> element, a
     <code>tfoot</code> element, a <code>th</code> element, a <code>thead</code> element, a
     <code>tr</code> element, the <code>body</code> element, or the <code>html</code> element, then
     this is a <span>parse error</span>.</p></li> <!-- (some of those are fragment cases) -->

     <li><p><span>Stop parsing</span>.</p></li>

    </ol>

   </dd>

   <dt>An end tag whose tag name is "body"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in
    scope">have a <code>body</code> element in scope</span>, this is a <span>parse error</span>;
    ignore the token.</p>

    <!-- if we get here, the insertion mode here is forcibly "in body". -->

    <!-- FORK -->
    <p>Otherwise, if there is a node in the <span>stack of open elements</span> that is not either a
    <code>dd</code> element, a <code>dt</code> element, an <code>li</code> element, an
    <code>optgroup</code> element, an <code>option</code> element, a <code>p</code> element, an
    <code>rb</code> element, an <code>rp</code> element, an <code>rt</code> element, an
    <code>rtc</code> element, a <code>tbody</code> element, a <code>td</code> element, a
    <code>tfoot</code> element, a <code>th</code> element, a <code>thead</code> element, a
    <code>tr</code> element, the <code>body</code> element, or the <code>html</code> element, then
    this is a <span>parse error</span>.</p> <!-- (some of those are fragment cases, e.g. for <tbody>
    you'd have hit the first paragraph since the <body> wouldn't be in scope, unless it was a
    fragment case) -->
    <!-- /FORK -->

    <!-- If we ever change the frameset-ok flag to an insertion mode, then we'd have to somehow keep
    track of its state when we switch to after-body. -->

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: after body">after
    body</span>".</p>

   </dd>

   <dt>An end tag whose tag name is "html"</dt>
   <dd>

    <!-- fake </body> -->
    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in
    scope">have a <code>body</code> element in scope</span>, this is a <span>parse error</span>;
    ignore the token.</p>

    <!-- if we get here, the insertion mode here is forcibly "in body". -->

    <!-- FORK -->
    <p>Otherwise, if there is a node in the <span>stack of open elements</span> that is not either a
    <code>dd</code> element, a <code>dt</code> element, an <code>li</code> element, an
    <code>optgroup</code> element, an <code>option</code> element, a <code>p</code> element, an
    <code>rb</code> element, an <code>rp</code> element, an <code>rt</code> element, an
    <code>rtc</code> element, a <code>tbody</code> element, a <code>td</code> element, a
    <code>tfoot</code> element, a <code>th</code> element, a <code>thead</code> element, a
    <code>tr</code> element, the <code>body</code> element, or the <code>html</code> element, then
    this is a <span>parse error</span>.</p> <!-- (some of those are fragment cases, e.g. for <tbody>
    you'd have hit the first paragraph since the <body> wouldn't be in scope, unless it was a
    fragment case) -->
    <!-- /FORK -->

    <!-- If we ever change the frameset-ok flag to an insertion mode, then we'd have to somehow keep
    track of its state when we switch to after-body. -->

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: after body">after
    body</span>".</p>
    <!-- end fake </body> -->

    <p>Reprocess the token.</p>

   </dd>

   <!-- start tags for non-phrasing flow content elements -->

   <!-- the normal ones -->
   <dt>A start tag whose tag name is one of: "address", "article", "aside", "blockquote", "center",
   "details", "dialog", "dir", "div", "dl", "fieldset", "figcaption", "figure", "footer", "header",
   "main", "menu", "nav", "ol", "p", "section", "summary", "ul"</dt>
   <dd>

    <!-- As of May 2008 this doesn't match any browser exactly, but is as close to what IE does as I
    can get without doing the non-tree DOM nonsense, and thus should actually afford better
    compatibility when implemented by the other browsers. -->

    <p>If the <span>stack of open elements</span> <span data-x="has an element in button scope">has a
    <code>p</code> element in button scope</span>, then <span>close a <code>p</code>
    element</span>.</p>

    <p><span>Insert an HTML element</span> for the token.</p>

   </dd>

   <!-- as normal, but close h1-h6 if it's the current node -->
   <dt>A start tag whose tag name is one of: "h1", "h2", "h3", "h4",
   "h5", "h6"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> <span data-x="has an element in button scope">has a
    <code>p</code> element in button scope</span>, then <span>close a <code>p</code>
    element</span>.</p>

    <p>If the <span>current node</span> is an <span data-x="HTML elements">HTML element</span> whose
    tag name is one of "h1", "h2", "h3", "h4", "h5", or "h6", then this is a <span>parse
    error</span>; pop the <span>current node</span> off the <span>stack of open elements</span>.</p>
    <!-- See https://bugs.webkit.org/show_bug.cgi?id=12646 -->

    <p><span>Insert an HTML element</span> for the token.</p>

   </dd>

   <!-- as normal, but drops leading newline -->
   <dt>A start tag whose tag name is one of: "pre", "listing"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> <span data-x="has an element in button scope">has
    a <code>p</code> element in button scope</span>, then <span>close a <code>p</code>
    element</span>.</p>

    <p><span>Insert an HTML element</span> for the token.</p>

    <p>If the <span>next token</span> is a U+000A LINE FEED (LF) character token, then ignore that
    token and move on to the next one. (Newlines at the start of <code>pre</code> blocks are ignored
    as an authoring convenience.)</p>

    <!-- <pre>\[CR]X will eat the \[CR], <pre>&#x10;X will eat the
    &#x10;, but <pre>&#x13;X will not eat the &#x13;. -->

    <p>Set the <span>frameset-ok flag</span> to "not ok".</p>

   </dd>

   <!-- as normal, but interacts with the form element pointer -->
   <dt>A start tag whose tag name is "form"</dt>
   <dd>

    <p>If the <span><code data-x="form">form</code> element pointer</span> is not null, and there is
    no <code>template</code> element on the <span>stack of open elements</span>, then this is a
    <span>parse error</span>; ignore the token.</p>

    <p>Otherwise:</p>

    <p>If the <span>stack of open elements</span> <span data-x="has an element in button scope">has
    a <code>p</code> element in button scope</span>, then <span>close a <code>p</code>
    element</span>.</p>

    <p><span>Insert an HTML element</span> for the token, and, if there is no <code>template</code>
    element on the <span>stack of open elements</span>, set the <span><code
    data-x="form">form</code> element pointer</span> to point to the element created.</p>

   </dd>

   <!-- as normal, but imply </li> when there's another <li> open in weird cases -->
   <dt>A start tag whose tag name is "li"</dt>
   <dd>

    <p>Run these steps:</p>

    <ol>

     <li><p>Set the <span>frameset-ok flag</span> to "not ok".</p></li>

     <li><p>Initialize <var>node</var> to be the <span>current
     node</span> (the bottommost node of the stack).</p></li>

     <li>

      <p><i>Loop</i>: If <var>node</var> is an <code>li</code> element, then run these
      substeps:</p>

      <ol>

       <!-- fake </li> -->
       <li><p><span>Generate implied end tags</span>, except for <code>li</code> elements.</p></li>

       <li><p>If the <span>current node</span> is not an <code>li</code> element, then this is a
       <span>parse error</span>.</p></li>

       <li><p>Pop elements from the <span>stack of open elements</span> until an <code>li</code>
       element has been popped from the stack.</p></li>
       <!-- end of fake </li> -->

       <li><p>Jump to the step labeled <i>done</i> below.</p></li>

      </ol>

     </li>

     <li><p>If <var>node</var> is in the <span>special</span> category, but is not an
     <code>address</code>, <code>div</code>, or <code>p</code> element, then jump to the step
     labeled <i>done</i> below.</p></li>
     <!-- an element <foo> is in this list if the following markup:

         <!DOCTYPE html><body><ol><li><foo><li>

     ...results in the second <li> not being (in any way) a descendant of the first <li>, or if
     <foo> is a formatting element that gets reopened later. -->

     <li><p>Otherwise, set <var>node</var> to the previous entry in the <span>stack of open
     elements</span> and return to the step labeled <i>loop</i>.</p></li>

     <li><p><i>Done</i>: If the <span>stack of open elements</span> <span data-x="has an element in
     button scope">has a <code>p</code> element in button scope</span>, then <span>close a
     <code>p</code> element</span>.</p></li>

     <li><p>Finally, <span>insert an HTML element</span> for the token.</p></li>

    </ol>

   </dd>

   <!-- as normal, but imply </dt> or </dd> when there's another <dt> or <dd> open in weird cases  -->
   <dt>A start tag whose tag name is one of: "dd", "dt"</dt>
   <dd>

    <p>Run these steps:</p>

    <ol>

     <li><p>Set the <span>frameset-ok flag</span> to "not ok".</p></li>

     <li><p>Initialize <var>node</var> to be the <span>current
     node</span> (the bottommost node of the stack).</p></li>

     <li>

      <p><i>Loop</i>: If <var>node</var> is a <code>dd</code> element, then run these
      substeps:</p>

      <ol>

       <!-- fake </dd> -->
       <li><p><span>Generate implied end tags</span>, except for <code>dd</code> elements.</p></li>

       <li><p>If the <span>current node</span> is not a <code>dd</code> element, then this is a
       <span>parse error</span>.</p></li>

       <li><p>Pop elements from the <span>stack of open elements</span> until a <code>dd</code>
       element has been popped from the stack.</p></li>
       <!-- end of fake </dd> -->

       <li><p>Jump to the step labeled <i>done</i> below.</p></li>

      </ol>

     </li>

     <li>

      <p>If <var>node</var> is a <code>dt</code> element, then run these substeps:</p>

      <ol>

       <!-- fake </dt> -->
       <li><p><span>Generate implied end tags</span>, except for <code>dt</code> elements.</p></li>

       <li><p>If the <span>current node</span> is not a <code>dt</code> element, then this is a
       <span>parse error</span>.</p></li>

       <li><p>Pop elements from the <span>stack of open elements</span> until a <code>dt</code>
       element has been popped from the stack.</p></li>
       <!-- end of fake </dt> -->

       <li><p>Jump to the step labeled <i>done</i> below.</p></li>

      </ol>

     </li>

     <li><p>If <var>node</var> is in the <span>special</span> category, but is not an
     <code>address</code>, <code>div</code>, or <code>p</code> element, then jump to the step
     labeled <i>done</i> below.</p></li>
     <!-- an element <foo> is in this list if the following markup:

         <!DOCTYPE html><body><dl><dt><foo><dt>

     ...results in the second <dt> not being (in any way) a descendant of the first <dt>, or if
     <foo> is a formatting element that gets reopened later. -->

     <li><p>Otherwise, set <var>node</var> to the previous entry in the <span>stack of open
     elements</span> and return to the step labeled <i>loop</i>.</p></li>

     <li><p><i>Done</i>: If the <span>stack of open elements</span> <span data-x="has an element in
     button scope">has a <code>p</code> element in button scope</span>, then <span>close a
     <code>p</code> element</span>.</p></li>

     <li><p>Finally, <span>insert an HTML element</span> for the token.</p></li>

    </ol>

   </dd>

   <!-- same as normal, but effectively ends parsing -->
   <dt>A start tag whose tag name is "plaintext"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> <span data-x="has an element in button scope">has a
    <code>p</code> element in button scope</span>, then <span>close a <code>p</code>
    element</span>.</p>

    <p><span>Insert an HTML element</span> for the token.</p>

    <p>Switch the tokenizer to the <span>PLAINTEXT state</span>.</p>

    <p class="note">Once a start tag with the tag name "plaintext" has been seen, that will be the
    last token ever seen other than character tokens (and the end-of-file token), because there is
    no way to switch out of the <span>PLAINTEXT state</span>.</p>

   </dd>

   <!-- button is a hybrid -->
   <dt>A start tag whose tag name is "button"</dt>
   <dd>

    <ol>

     <li>

      <p>If the <span>stack of open elements</span> <span data-x="has an element in scope">has a
      <code>button</code> element in scope</span>, then run these substeps:</p>

      <ol>

       <li><p><span>Parse error</span>.</p></li>

       <li><p><span>Generate implied end tags</span>.</p></li>

       <li><p>Pop elements from the <span>stack of open elements</span> until a <code>button</code>
       element has been popped from the stack.</p></li>

      </ol>

     </li>

     <li><p><span>Reconstruct the active formatting elements</span>, if any.</p></li>

     <li><p><span>Insert an HTML element</span> for the token.</p></li>

     <li><p>Set the <span>frameset-ok flag</span> to "not ok".</p></li>

    </ol>

   </dd>

   <!-- end tags for non-phrasing flow content elements (and button) -->

   <!-- the normal ones -->
   <dt>An end tag whose tag name is one of: "address", "article", "aside", "blockquote", "button",
   "center", "details", "dialog", "dir", "div", "dl", "fieldset", "figcaption", "figure", "footer",
   "header", "listing", "main", "menu", "nav", "ol", "pre", "section", "summary",
   "ul"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in
    scope">have an element in scope</span> that is an <span data-x="HTML elements">HTML
    element</span> with the same tag name as that of the token, then this is a <span>parse
    error</span>; ignore the token.</p>

    <p>Otherwise, run these steps:</p>

    <ol>

     <li><p><span>Generate implied end tags</span>.</p></li>

     <li><p>If the <span>current node</span> is not an <span data-x="HTML elements">HTML element</span> with
     the same tag name as that of the token, then this is a
     <span>parse error</span>.</p></li>

     <li><p>Pop elements from the <span>stack of open elements</span> until an <span data-x="HTML
     elements">HTML element</span> with the same tag name as the token has been popped from the
     stack.</p></li>

    </ol>

   </dd>

   <!-- removes the form element pointer instead of the matching node -->
   <dt>An end tag whose tag name is "form"</dt>
   <dd>

    <p>If there is no <code>template</code> element on the <span>stack of open elements</span>, then
    run these substeps:</p>

    <ol>

     <li><p>Let <var>node</var> be the element that the <span><code>form</code>
     element pointer</span> is set to, or null if it is not set to an element.</p></li>

     <li><p>Set the <span><code>form</code> element pointer</span> to null.</p></li>

     <li><p>If <var>node</var> is null or if the <span>stack of open elements</span> does
     not <span data-x="has an element in scope">have <var>node</var> in scope</span>, then
     this is a <span>parse error</span>; abort these steps and ignore the token.</p></li>

     <li><p><span>Generate implied end tags</span>.</p></li>

     <li><p>If the <span>current node</span> is not <var>node</var>, then this is a
     <span>parse error</span>.</p></li>

     <li><p>Remove <var>node</var> from the <span>stack of open elements</span>.</p></li>

    </ol>

    <p>If there <em>is</em> a <code>template</code> element on the <span>stack of open
    elements</span>, then run these substeps instead:</p>

    <ol>

     <li><p>If the <span>stack of open elements</span> does not <span data-x="has an element in
     scope">have a <code>form</code> element in scope</span>, then this is a <span>parse
     error</span>; abort these steps and ignore the token.</p></li>

     <li><p><span>Generate implied end tags</span>.</p></li>

     <li><p>If the <span>current node</span> is not a <code>form</code> element, then this is a
     <span>parse error</span>.</p></li>

     <li><p>Pop elements from the <span>stack of open elements</span> until a <code>form</code>
     element has been popped from the stack.</p></li>

    </ol>

   </dd>

   <!-- as normal, except </p> implies <p> if there's no <p> in scope, and needs care as the elements have optional tags -->
   <dt>An end tag whose tag name is "p"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in button
    scope">have a <code>p</code> element in button scope</span>, then this is a <span>parse
    error</span>; <span>insert an HTML element</span> for a "p" start tag token with no
    attributes.</p>

    <p><span>Close a <code>p</code> element</span>.</p>

   </dd>

   <!-- as normal, but needs care as the elements have optional tags, and are further scoped by <ol>/<ul> -->
   <dt>An end tag whose tag name is "li"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in list item
    scope">have an <code>li</code> element in list item scope</span>, then this is a <span>parse
    error</span>; ignore the token.</p>

    <p>Otherwise, run these steps:</p>

    <ol>

     <li><p><span>Generate implied end tags</span>, except for <code>li</code> elements.</p></li>

     <li><p>If the <span>current node</span> is not an <code>li</code> element, then this is a
     <span>parse error</span>.</p></li>

     <li><p>Pop elements from the <span>stack of open elements</span> until an <code>li</code>
     element has been popped from the stack.</p></li>

    </ol>

   </dd>

   <!-- as normal, but needs care as the elements have optional tags -->
   <dt>An end tag whose tag name is one of: "dd", "dt"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in
    scope">have an element in scope</span> that is an <span data-x="HTML elements">HTML
    element</span> with the same tag name as that of the token, then this is a <span>parse
    error</span>; ignore the token.</p>

    <p>Otherwise, run these steps:</p>

    <ol>

     <li><p><span>Generate implied end tags</span>, except for <span>HTML elements</span> with the
     same tag name as the token.</p></li>

     <li><p>If the <span>current node</span> is not an <span data-x="HTML elements">HTML
     element</span> with the same tag name as that of the token, then this is a <span>parse
     error</span>.</p></li>

     <li><p>Pop elements from the <span>stack of open elements</span> until an <span data-x="HTML
     elements">HTML element</span> with the same tag name as the token has been popped from the
     stack.</p></li>

    </ol>

   </dd>

   <!-- as normal, except acts as a closer for any of the h1-h6 elements -->
   <dt>An end tag whose tag name is one of: "h1", "h2", "h3", "h4", "h5", "h6"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in
    scope">have an element in scope</span> that is an <span data-x="HTML elements">HTML
    element</span> and whose tag name is one of "h1", "h2", "h3", "h4", "h5", or "h6", then this is
    a <span>parse error</span>; ignore the token.</p>

    <p>Otherwise, run these steps:</p>

    <ol>

     <li><p><span>Generate implied end tags</span>.</p></li>

     <li><p>If the <span>current node</span> is not an <span data-x="HTML elements">HTML
     element</span> with the same tag name as that of the token, then this is a <span>parse
     error</span>.</p></li>

     <li><p>Pop elements from the <span>stack of open elements</span> until an <span data-x="HTML
     elements">HTML element</span> whose tag name is one of "h1", "h2", "h3", "h4", "h5", or "h6"
     has been popped from the stack.</p></li>

    </ol>

   </dd>

   <!-- see also applet/marquee/object lower down -->

   <dt>An end tag whose tag name is "sarcasm"</dt>
   <dd>
    <p>Take a deep breath, then act as described in the "any other end
    tag" entry below.</p>
   </dd>

   <!-- ADOPTION AGENCY ELEMENTS
        Mozilla-only: bdo blink del ins sub sup q
        Safari-only: code dfn kbd nobr samp var wbr
        Both: a b big em font i s small strike strong tt u -->

   <dt>A start tag whose tag name is "a"</dt>
   <dd>

    <p>If the <span>list of active formatting elements</span> contains an <code>a</code> element
    between the end of the list and the last <span data-x="concept-parser-marker">marker</span> on
    the list (or the start of the list if there is no <span
    data-x="concept-parser-marker">marker</span> on the list), then this is a <span>parse
    error</span>; run the <span>adoption agency algorithm</span> for the tag name "a", then remove
    that element from the <span>list of active formatting elements</span> and the <span>stack of
    open elements</span> if the <span>adoption agency algorithm</span> didn't already remove it (it
    might not have if the element is not <span data-x="has an element in table scope">in table
    scope</span>).</p>

    <p class="example">In the non-conforming stream
    <code>&lt;a&nbsp;href="a">a&lt;table>&lt;a&nbsp;href="b">b&lt;/table>x</code>, the first
    <code>a</code> element would be closed upon seeing the second one, and the "x" character would
    be inside a link to "b", not to "a". This is despite the fact that the outer <code>a</code>
    element is not in table scope (meaning that a regular <code>&lt;/a></code> end tag at the start
    of the table wouldn't close the outer <code>a</code> element). The result is that the two
    <code>a</code> elements are indirectly nested inside each other &mdash; non-conforming markup
    will often result in non-conforming DOMs when parsed.</p>

    <p><span>Reconstruct the active formatting elements</span>, if any.</p>

    <p><span>Insert an HTML element</span> for the token. <span>Push onto the list of active
    formatting elements</span> that element.</p>

   </dd>

   <dt>A start tag whose tag name is one of: "b", "big", "code", "em",
   "font", "i", "s", "small", "strike", "strong", "tt", "u"</dt>
   <dd>

    <p><span>Reconstruct the active formatting elements</span>, if any.</p>

    <p><span>Insert an HTML element</span> for the token. <span>Push onto the list of active
    formatting elements</span> that element.</p>

   </dd>

   <dt>A start tag whose tag name is "nobr"</dt>
   <dd>

    <p><span>Reconstruct the active formatting elements</span>, if any.</p>

    <p>If the <span>stack of open elements</span> <span data-x="has an element in scope">has a
    <code>nobr</code> element in scope</span>, then this is a <span>parse error</span>; run the
    <span>adoption agency algorithm</span> for the tag name "nobr", then once again
    <span>reconstruct the active formatting elements</span>, if any.</p>

    <p><span>Insert an HTML element</span> for the token. <span>Push onto the list of active
    formatting elements</span> that element.</p>

   </dd>

   <dt>An end tag whose tag name is one of: "a",
   "b", "big", "code", "em", "font", "i", "nobr", "s", "small",
   "strike", "strong", "tt", "u"</dt>
   <dd>

    <p>Run the <span>adoption agency algorithm</span> for the token's tag name.</p>

   </dd>

   <dt>A start tag whose tag name is one of: "applet", "marquee", "object"</dt>
   <dd>

    <p><span>Reconstruct the active formatting elements</span>, if any.</p>

    <p><span>Insert an HTML element</span> for the token.</p>

    <p>Insert a <span data-x="concept-parser-marker">marker</span> at the end of the <span>list of
    active formatting elements</span>.</p>

    <p>Set the <span>frameset-ok flag</span> to "not ok".</p>

   </dd>

   <dt>An end tag token whose tag name is one of: "applet", "marquee", "object"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in
    scope">have an element in scope</span> that is an <span data-x="HTML elements">HTML
    element</span> with the same tag name as that of the token, then this is a <span>parse
    error</span>; ignore the token.</p>

    <p>Otherwise, run these steps:</p>

    <ol>

     <li><p><span>Generate implied end tags</span>.</p></li>

     <li><p>If the <span>current node</span> is not an <span data-x="HTML elements">HTML
     element</span> with the same tag name as that of the token, then this is a <span>parse
     error</span>.</p></li>

     <li><p>Pop elements from the <span>stack of open elements</span> until an <span data-x="HTML
     elements">HTML element</span> with the same tag name as the token has been popped from the
     stack.</p></li>

     <li><span>Clear the list of active formatting elements up to the last marker</span>.</li>

    </ol>

   </dd>

   <dt>A start tag whose tag name is "table"</dt>
   <dd>

    <p>If the <code>Document</code> is <em>not</em> set to <span>quirks mode</span>, and the
    <span>stack of open elements</span> <span data-x="has an element in button scope">has a
    <code>p</code> element in button scope</span>, then <span>close a <code>p</code>
    element</span>.</p> <!-- i hate myself (this quirk was basically caused by acid2; if i'd
    realized we could change the specs when i wrote acid2, we could have avoided having any
    parsing-mode quirks) -Hixie -->

    <p><span>Insert an HTML element</span> for the token.</p>

    <p>Set the <span>frameset-ok flag</span> to "not ok".</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in table">in
    table</span>".</p>

   </dd>

   <dt>An end tag whose tag name is "br"</dt>
   <dd>

    <p><span>Parse error</span>. Drop the attributes from the token, and act as described in the
    next entry; i.e. act as if this was a "br" start tag token with no attributes, rather than the
    end tag token that it actually is.</p>

   </dd>

   <!-- do not insert things here, since the previous entry refers to the next entry -->

   <dt>A start tag whose tag name is one of: "area", "br", "embed",
   "img", "keygen", "wbr"</dt>
   <dd>

    <p><span>Reconstruct the active formatting elements</span>, if any.</p>

    <p><span>Insert an HTML element</span> for the token. Immediately pop the <span>current
    node</span> off the <span>stack of open elements</span>.</p>

    <p><span data-x="acknowledge self-closing flag">Acknowledge the token's <i data-x="self-closing flag">self-closing
    flag</i></span>, if it is set.</p>

    <p>Set the <span>frameset-ok flag</span> to "not ok".</p>
    <!-- shouldn't really do this for <area> -->

   </dd>

   <dt>A start tag whose tag name is "input"</dt>
   <dd>

    <p><span>Reconstruct the active formatting elements</span>, if any.</p>

    <p><span>Insert an HTML element</span> for the token. Immediately pop the <span>current
    node</span> off the <span>stack of open elements</span>.</p>

    <p><span data-x="acknowledge self-closing flag">Acknowledge the token's <i data-x="self-closing flag">self-closing
    flag</i></span>, if it is set.</p>

    <p>If the token does not have an attribute with the name "type", or if it does, but that
    attribute's value is not an <span>ASCII case-insensitive</span> match for the string "<code
   >hidden</code>", then: set the <span>frameset-ok flag</span> to "not ok".</p>

   </dd>

   <dt>A start tag whose tag name is one of: "menuitem", "param", "source", "track"</dt>
   <dd>

    <p><span>Insert an HTML element</span> for the token. Immediately pop the <span>current
    node</span> off the <span>stack of open elements</span>.</p>

    <p><span data-x="acknowledge self-closing flag">Acknowledge the token's <i data-x="self-closing flag">self-closing
    flag</i></span>, if it is set.</p>

   </dd>

   <dt>A start tag whose tag name is "hr"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> <span data-x="has an element in button scope">has a
    <code>p</code> element in button scope</span>, then <span>close a <code>p</code>
    element</span>.</p>

    <p><span>Insert an HTML element</span> for the token. Immediately pop the <span>current
    node</span> off the <span>stack of open elements</span>.</p>

    <p><span data-x="acknowledge self-closing flag">Acknowledge the token's <i data-x="self-closing flag">self-closing
    flag</i></span>, if it is set.</p>

    <p>Set the <span>frameset-ok flag</span> to "not ok".</p>

   </dd>

   <dt>A start tag whose tag name is "image"</dt>
   <dd>
    <!-- As of 2005-12, studies showed that around 0.2% of pages used the <image> element. -->
    <p><span>Parse error</span>. Change the token's tag name to "img" and reprocess it. (Don't
    ask.)</p>
   </dd>

   <dt id="isindex">A start tag whose tag name is "isindex"</dt>
   <dd>

    <p><span>Parse error</span>.</p>

    <p>If there is no <code>template</code> element on the <span>stack of open elements</span> and
    the <span><code>form</code> element pointer</span> is not null, then ignore the
    token.</p>

    <p>Otherwise:</p>

    <p><span data-x="acknowledge self-closing flag">Acknowledge the token's <i data-x="self-closing flag">self-closing
    flag</i></span>, if it is set.</p> <!-- purely to reduce the number of errors (we don't care if
    they included the /, they're not supposed to be including the tag at all! -->

    <p>Set the <span>frameset-ok flag</span> to "not ok".</p>

    <!-- fake <form> -->
    <p>If the <span>stack of open elements</span> <span data-x="has an element in button scope">has a
    <code>p</code> element in button scope</span>, then <span>close a <code>p</code>
    element</span>.</p>

    <p><span>Insert an HTML element</span> for a "form" start tag token with no attributes, and, if
    there is no <code>template</code> element on the <span>stack of open elements</span>, set the
    <span><code data-x="form">form</code> element pointer</span> to point to the element
    created.</p>

    <p>If the token has an attribute called "action", set the <code
    data-x="attr-fs-action">action</code> attribute on the resulting <code>form</code> element to the
    value of the "action" attribute of the token.</p>

    <!-- fake <hr> -->
    <p><span>Insert an HTML element</span> for an "hr" start tag token with no attributes.
    Immediately pop the <span>current node</span> off the <span>stack of open elements</span>.</p>

    <!-- fake <label> -->
    <p><span>Reconstruct the active formatting elements</span>, if any.</p>

    <p><span>Insert an HTML element</span> for a "label" start tag token with no attributes.</p>

    <!-- fake text -->
    <p><span data-x="insert a character">Insert characters</span> (see below for <span
    data-x="attr-isindex-prompt">what they should say</span>).</p>

    <!-- fake <input> -->
    <p><span>Insert an HTML element</span> for an "input" start tag token with all the attributes
    from the "isindex" token except "name", "action", and "prompt", and with an attribute named
    "name" with the value "isindex". (This creates an <code>input</code> element with the <code
    data-x="attr-fe-name">name</code> attribute set to the magic value "<code
    data-x="attr-fe-name-isindex">isindex</code>".) Immediately pop the <span>current node</span> off
    the <span>stack of open elements</span>.</p>

    <!-- fake text -->
    <p><span data-x="insert a character">Insert more characters</span> (see below for <span
    data-x="attr-isindex-prompt">what they should say</span>).</p>

    <!-- fake </label> -->
    <p>Pop the <span>current node</span> (which will be the <code>label</code> element created
    earlier) off the <span>stack of open elements</span>.</p>

    <!-- fake <hr> -->
    <p><span>Insert an HTML element</span> for an "hr" start tag token with no attributes.
    Immediately pop the <span>current node</span> off the <span>stack of open elements</span>.</p>

    <!-- fake </form> -->
    <p>Pop the <span>current node</span> (which will be the <code>form</code> element created
    earlier) off the <span>stack of open elements</span>, and, if there is no <code>template</code>
    element on the <span>stack of open elements</span>, set the <span><code
    data-x="form">form</code> element pointer</span> back to null.</p>

    <!-- explanation of text -->
    <p><dfn data-x="attr-isindex-prompt"><strong>Prompt</strong></dfn>: If the token has an attribute
    with the name "prompt", then the first stream of characters must be the same string as given in
    that attribute, and the second stream of characters must be empty. Otherwise, the two streams of
    character tokens together should, together with the <code>input</code> element, express the
    equivalent of "This is a searchable index. Enter search keywords: (input field)" in the user's
    preferred language.</p>

   </dd>

   <dt>A start tag whose tag name is "textarea"</dt>
   <dd>

    <p>Run these steps:</p>

    <ol>

     <li><p><span>Insert an HTML element</span> for the token.</p></li>

     <li><p>If the <span>next token</span> is a U+000A LINE FEED (LF) character token, then ignore
     that token and move on to the next one. (Newlines at the start of <code>textarea</code>
     elements are ignored as an authoring convenience.)</p></li>

     <!-- see comment in <pre> start tag bit -->

     <li><p>Switch the tokenizer to the <span>RCDATA state</span>.</p></li>

     <li><p>Let the <span>original insertion mode</span> be the current <span>insertion
     mode</span>.</p>

     <li><p>Set the <span>frameset-ok flag</span> to "not ok".</p></li>

     <li><p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode:
     text">text</span>".</p></li>

    </ol>

   </dd>

   <dt>A start tag whose tag name is "xmp"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> <span data-x="has an element in button scope">has a
    <code>p</code> element in button scope</span>, then <span>close a <code>p</code>
    element</span>.</p>

    <p><span>Reconstruct the active formatting elements</span>, if any.</p>

    <p>Set the <span>frameset-ok flag</span> to "not ok".</p>

    <p>Follow the <span>generic raw text element parsing algorithm</span>.</p>

   </dd>

   <dt>A start tag whose tag name is "iframe"</dt>
   <dd>

    <p>Set the <span>frameset-ok flag</span> to "not ok".</p>

    <p>Follow the <span>generic raw text element parsing algorithm</span>.</p>

   </dd>

   <dt>A start tag whose tag name is "noembed"</dt>
   <dt>A start tag whose tag name is "noscript", if the <span>scripting flag</span> is enabled</dt>
   <dd>

    <p>Follow the <span>generic raw text element parsing algorithm</span>.</p>

   </dd>

   <dt>A start tag whose tag name is "select"</dt>
   <dd>

    <p><span>Reconstruct the active formatting elements</span>, if any.</p>

    <p><span>Insert an HTML element</span> for the token.</p>

    <p>Set the <span>frameset-ok flag</span> to "not ok".</p>

    <p>If the <span>insertion mode</span> is one of "<span data-x="insertion mode: in table">in
    table</span>", "<span data-x="insertion mode: in caption">in caption</span>", "<span
    data-x="insertion mode: in table body">in table body</span>", "<span data-x="insertion mode: in
    row">in row</span>", or "<span data-x="insertion mode: in cell">in cell</span>", then switch the
    <span>insertion mode</span> to "<span data-x="insertion mode: in select in table">in select in
    table</span>". Otherwise, switch the <span>insertion mode</span> to "<span data-x="insertion
    mode: in select">in select</span>".</p>

   </dd>

   <dt>A start tag whose tag name is one of: "optgroup", "option"</dt>
   <dd>

    <p>If the <span>current node</span> is an <code>option</code> element, then pop the
    <span>current node</span> off the <span>stack of open elements</span>.</p>

    <p><span>Reconstruct the active formatting elements</span>, if any.</p>

    <p><span>Insert an HTML element</span> for the token.</p>

   </dd>

   <!-- FORK -->
   <dt>A start tag whose tag name is one of: "rb", "rtc"</dt>
   <dd>
    <p>If the <span>stack of open elements</span> <span data-x="has an element in scope">has a
    <code>ruby</code> element in scope</span>, then <span>generate implied end tags</span>. If the
    <span>current node</span> is not now a <code>ruby</code> element, this is a
    <span>parse error</span>.</p>

    <p><span>Insert an HTML element</span> for the token.</p>

   </dd>

   <dt>A start tag whose tag name is one of: "rp", "rt"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> <span data-x="has an element in scope">has a
    <code>ruby</code> element in scope</span>, then <span>generate implied end tags</span>, except
    for <code>rtc</code> elements. If the <span>current node</span> is not then a <code>ruby</code>
    element or an <code>rtc</code> element, this is a <span>parse error</span>.</p>

    <p><span>Insert an HTML element</span> for the token.</p>
   </dd>
   <!-- /FORK -->

   <dt>A start tag whose tag name is "math"</dt>
   <dd>

    <p><span>Reconstruct the active formatting elements</span>, if any.</p>

    <p><span>Adjust MathML attributes</span> for the token. (This fixes the case of MathML
    attributes that are not all lowercase.)</p>

    <p><span>Adjust foreign attributes</span> for the token. (This fixes the use of namespaced
    attributes, in particular XLink.)</p>

    <p><span>Insert a foreign element</span> for the token, in the <span>MathML
    namespace</span>.</p>

    <!-- If we ever change the frameset-ok flag to an insertion mode, the following change would be
    implied, except we'd have to do it even in the face of a self-closed tag:
    <p>Set the <span>frameset-ok flag</span> to "not ok".</p>
    -->

    <p>If the token has its <i data-x="self-closing flag">self-closing flag</i> set, pop the <span>current node</span> off the
    <span>stack of open elements</span> and <span data-x="acknowledge self-closing flag">acknowledge
    the token's <i data-x="self-closing flag">self-closing flag</i></span>.</p>

   </dd>

   <dt>A start tag whose tag name is "svg"</dt>
   <dd>

    <p><span>Reconstruct the active formatting elements</span>, if any.</p>

    <p><span>Adjust SVG attributes</span> for the token. (This fixes the case of SVG attributes that
    are not all lowercase.)</p>

    <p><span>Adjust foreign attributes</span> for the token. (This fixes the use of namespaced
    attributes, in particular XLink in SVG.)</p>

    <p><span>Insert a foreign element</span> for the token, in the <span>SVG namespace</span>.</p>

    <!-- If we ever change the frameset-ok flag to an insertion mode, the following change would be
    implied, except we'd have to do it even in the face of a self-closed tag:
    <p>Set the <span>frameset-ok flag</span> to "not ok".</p>
    -->

    <p>If the token has its <i data-x="self-closing flag">self-closing flag</i> set, pop the <span>current node</span> off the
    <span>stack of open elements</span> and <span data-x="acknowledge self-closing flag">acknowledge
    the token's <i data-x="self-closing flag">self-closing flag</i></span>.</p>

   </dd>

   <dt>A start <!--or end--> tag whose tag name is one of: "caption", "col", "colgroup", "frame",
   "head", "tbody", "td", "tfoot", "th", "thead", "tr"</dt>
   <!--<dt>An end tag whose tag name is one of: "area", "base", "basefont", "bgsound", "embed",
   "hr", "iframe", "image", "img", "input", "isindex", "keygen", "link", "menuitem", "meta",
   "noembed", "noframes", "param", "script", "select", "source", "style", "table", "textarea",
   "title", "track", "wbr"</dt>-->
   <!--<dt>An end tag whose tag name is "noscript", if the <span>scripting flag</span> is
   enabled</dt>-->
   <dd>

    <p><span>Parse error</span>. Ignore the token.</p>

    <!-- end tags are commented out because since they can never end up on the stack anyway, the
    default end tag clause will automatically handle them. we don't want to have text in the spec
    that is just an optimisation, as that detracts from the spec itself -->

   </dd>

   <dt>Any other start tag</dt>
   <dd>

    <p><span>Reconstruct the active formatting elements</span>, if any.</p>

    <p><span>Insert an HTML element</span> for the token.</p>

    <p class="note">This element will be an <span>ordinary</span>
    element.</p>

   </dd>

   <dt>Any other end tag</dt>
   <dd>

    <p>Run these steps:</p>

    <ol>

     <li><p>Initialize <var>node</var> to be the <span>current node</span> (the bottommost
     node of the stack).</p></li>

     <li><p><i>Loop</i>: If <var>node</var> is an <span data-x="HTML elements">HTML
     element</span> with the same tag name as the token, then:</p>

      <ol>

       <li><p><span>Generate implied end tags</span>, except for <span>HTML elements</span> with the
       same tag name as the token.</p></li>

       <li><p>If <var>node</var> is not the <span>current node</span>, then this is a
       <span>parse error</span>.</p></li>

       <li><p>Pop all the nodes from the <span>current node</span> up to <var>node</var>,
       including <var>node</var>, then stop these steps.</p></li>

      </ol>

     </li>

     <li><p>Otherwise, if <var>node</var> is in the <span>special</span> category, then
     this is a <span>parse error</span>; ignore the token, and abort these steps.</p></li>

     <li><p>Set <var>node</var> to the previous entry in the <span>stack of open
     elements</span>.</p></li>

     <li><p>Return to the step labeled <i>loop</i>.</p></li>

    </ol>

   </dd>

  </dl>

  <p>When the steps above say the user agent is to <dfn>close a <code>p</code> element</dfn>, it
  means that the user agent must run the following steps:</p>

  <ol> <!-- prereq: p in scope -->

   <li><p><span>Generate implied end tags</span>, except for <code>p</code> elements.</p></li>

   <li><p>If the <span>current node</span> is not a <code>p</code> element, then this is a
   <span>parse error</span>.</p></li>

   <li><p>Pop elements from the <span>stack of open elements</span> until a <code>p</code> element
   has been popped from the stack.</p></li>

  </ol>

  <!-- AAA -->
  <p id="adoptionAgency">The <dfn>adoption agency algorithm</dfn>, which takes as its only argument
  a tag name <var>subject</var> for which the algorithm is being run, consists of the
  following steps:</p>

  <ol>

   <!-- don't forget about the noah's ark clause when looking at this algorithm! -->

   <li><p>If the <span>current node</span> is an <span data-x="HTML elements">HTML element</span>
   whose tag name is <var>subject</var>, and the <span>current node</span> is not in the
   <span>list of active formatting elements</span>, then pop the <span>current node</span> off the
   <span>stack of open elements</span>, and abort these steps.</p></li>

   <li><p>Let <var>outer loop counter</var> be zero.</p></li>

   <li><p><i>Outer loop</i>: If <var>outer loop counter</var> is greater than or equal to
   eight, then abort these steps.</p></li>

   <li><p>Increment <var>outer loop counter</var> by one.</p></li>

   <li>

    <p>Let <var>formatting element</var> be the last element in the <span>list of active
    formatting elements</span> that:</p>

    <ul>

     <li>is between the end of the list and the last <span
     data-x="concept-parser-marker">marker</span> in the list, if any, or the start of the list
     otherwise, and</li>

     <li>has the tag name <var>subject</var>.</li>

    </ul>

    <p>If there is no such element, then abort these steps and instead act as described in the "any
    other end tag" entry above.</p>

   </li>

   <li><p>If <var>formatting element</var> is not in the <span>stack of open
   elements</span>, then this is a <span>parse error</span>; remove the element from the list, and
   abort these steps.</p></li>

   <li><p>If <var>formatting element</var> is in the <span>stack of open elements</span>,
   but the element is not <span data-x="has an element in scope">in scope</span>, then this is a
   <span>parse error</span>; abort these steps.</p></li>

   <!-- at this point, <var>formatting element</var> is in <span data-x="stack of open
        elements">the stack</span> and <span data-x="list of active formatting elements">the
        list</span>, and is <span data-x="has an element in scope">in scope</span>. -->

   <li><p>If <var>formatting element</var> is not the <span>current node</span>, this is a
   <span>parse error</span>. (But do not abort these steps.)</p></li>

   <li><p>Let <var>furthest block</var> be the topmost node in the <span>stack of open
   elements</span> that is lower in the stack than <var>formatting element</var>, and is an
   element in the <span>special</span> category. There might not be one.</p></li>

   <!-- <html> ... <formatting element> ... <furthest block> ... <current node> -->

   <li><p>If there is no <var>furthest block</var>, then the UA must first pop all the
   nodes from the bottom of the <span>stack of open elements</span>, from the <span>current
   node</span> up to and including <var>formatting element</var>, then remove <var>formatting element</var> from the <span>list of active formatting elements</span>, and
   finally abort these steps.</p></li> <!-- the "reconstruct the active formatting elements"
   algorithm will rebuild them later -->

   <li><p>Let <var>common ancestor</var> be the element immediately above <var>formatting element</var> in the <span>stack of open elements</span>.</p></li>

   <!-- <html> ... <common ancestor> <formatting element> ... <furthest block> ... <current node> -->

   <li><p>Let a bookmark note the position of <var>formatting element</var> in the
   <span>list of active formatting elements</span> relative to the elements on either side of it in
   the list.</p></li>

   <li>

    <p>Let <var>node</var> and <var>last node</var> be <var>furthest
    block</var>. Follow these steps:</p>

    <ol>

     <li><p>Let <var>inner loop counter</var> be zero.</p></li>

     <li><p><i>Inner loop</i>: Increment <var>inner loop counter</var> by one.</p></li>

     <li><p>Let <var>node</var> be the element immediately above <var>node</var>
     in the <span>stack of open elements</span>, or if <var>node</var> is no longer in the
     <span>stack of open elements</span> (e.g. because it got removed by this algorithm<!-- in
     particular, the step labeled "removal" below -->), the element that was immediately above <var>node</var> in the <span>stack of open elements</span> before <var>node</var>
     was removed.</p></li>

     <li><p>If <var>node</var> is <var>formatting element</var>, then go to the
     next step in the overall algorithm.</p></li>

     <li><p>If <var>inner loop counter</var> is greater than three and <var>node</var> is in the <span>list of active formatting elements</span>, then remove <var>node</var> from the <span>list of active formatting elements</span>.</p></li>

     <li><p><!-- "removal" step: -->If <var>node</var> is not in the <span>list of active
     formatting elements</span>, then remove <var>node</var> from the <span>stack of open
     elements</span> and then go back to the step labeled <i>inner loop</i>.</p></li>

     <li><p><span>Create an element for the token</span> for which the element <var>node</var> was created, in the <span>HTML namespace</span>, with <var>common
     ancestor</var> as the intended parent; replace the entry for <var>node</var> in the
     <span>list of active formatting elements</span> with an entry for the new element, replace the
     entry for <var>node</var> in the <span>stack of open elements</span> with an entry for
     the new element, and let <var>node</var> be the new element.</p></li>

     <li><p>If <var>last node</var> is <var>furthest block</var>, then move the
     aforementioned bookmark to be immediately after the new <var>node</var> in the
     <span>list of active formatting elements</span>.</p></li>

     <li><p>Insert <var>last node</var> into <var>node</var>, first removing it
     from its previous parent node if any.</p></li>

     <li><p>Let <var>last node</var> be <var>node</var>.</p></li>

     <li><p>Return to the step labeled <i>inner loop</i>.</p></li>

    </ol>

   </li>

   <li><p>Insert whatever <var>last node</var> ended up being in the previous step at the
   <span>appropriate place for inserting a node</span>, but using <var>common
   ancestor</var> as the <i>override target</i>.</p></li>

   <li><p><span>Create an element for the token</span> for which <var>formatting
   element</var> was created, in the <span>HTML namespace</span>, with <var>furthest
   block</var> as the intended parent.</p></li>

   <li><p>Take all of the child nodes of <var>furthest block</var> and append them to the
   element created in the last step.</p></li>

   <li><p>Append that new element to <var>furthest block</var>.</p></li>

   <li><p>Remove <var>formatting element</var> from the <span>list of active formatting
   elements</span>, and insert the new element into the <span>list of active formatting
   elements</span> at the position of the aforementioned bookmark.</p></li>

   <li><p>Remove <var>formatting element</var> from the <span>stack of open
   elements</span>, and insert the new element into the <span>stack of open elements</span>
   immediately below the position of <var>furthest block</var> in that stack.</p></li>

   <li><p>Jump back to the step labeled <i>outer loop</i>.</p></li>

  </ol>

  <p class="note">This algorithm's name, the "adoption agency algorithm", comes from the way it
  causes elements to change parents, and is in contrast with other possible algorithms for dealing
  with misnested content, which included the "incest algorithm", the "secret affair algorithm", and
  the "Heizenberg algorithm".</p>





  <h6 id="parsing-main-incdata">The "<dfn data-x="insertion mode: text">text</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode:
  text">text</span>" <span>insertion mode</span>, the user agent must handle the token as
  follows:</p>

  <dl class="switch">

   <dt>A character token</dt>
   <dd>

    <p><span data-x="insert a character">Insert the token's character</span>.</p>

    <p class="note">This can never be a U+0000 NULL character; the tokenizer converts those to
    U+FFFD REPLACEMENT CHARACTER characters.</p>

   </dd>

   <dt>An end-of-file token</dt>
   <dd>

    <!-- can't be the fragment case -->
    <p><span>Parse error</span>.</p>

    <p>If the <span>current node</span> is a <code>script</code> element, mark the
    <code>script</code> element as <span>"already started"</span>.</p>

    <p>Pop the <span>current node</span> off the <span>stack of open elements</span>.</p>

    <p>Switch the <span>insertion mode</span> to the <span>original insertion mode</span> and
    reprocess the token.</p>

   </dd>

   <dt id="scriptEndTag">An end tag whose tag name is "script"</dt>
   <dd>

    <p>If the <span>stack of script settings objects</span> is empty, <span>perform a microtask checkpoint</span>.</p>

    <p>Let <var>script</var> be the <span>current node</span> (which will be a
    <code>script</code> element).</p>

    <p>Pop the <span>current node</span> off the <span>stack of open elements</span>.</p>

    <p>Switch the <span>insertion mode</span> to the <span>original insertion mode</span>.</p>

    <p>Let the <var>old insertion point</var> have the same value as the current
    <span>insertion point</span>. Let the <span>insertion point</span> be just before the <span>next
    input character</span>.</p>

    <p>Increment the parser's <span>script nesting level</span> by one.</p>

    <p><span data-x="prepare a script">Prepare</span> the <var>script</var>. This might
    cause some script to execute, which might cause <span data-x="dom-document-write">new characters
    to be inserted into the tokenizer</span>, and might cause the tokenizer to output more tokens,
    resulting in a <a href="#nestedParsing">reentrant invocation of the parser</a>.</p>

    <p>Decrement the parser's <span>script nesting level</span> by one. If the parser's <span>script
    nesting level</span> is zero, then set the <span>parser pause flag</span> to false.</p>

    <p>Let the <span>insertion point</span> have the value of the <var>old insertion
    point</var>. (In other words, restore the <span>insertion point</span> to its previous value.
    This value might be the "undefined" value.)</p>

    <p id="scriptTagParserResumes">At this stage, if there is a <span>pending parsing-blocking
    script</span>, then:</p>

    <dl class="switch">

     <dt>If the <span>script nesting level</span> is not zero:</dt>

     <dd>

      <p>Set the <span>parser pause flag</span> to true, and abort the processing of any nested
      invocations of the tokenizer, yielding control back to the caller. (Tokenization will resume
      when the caller returns to the "outer" tree construction stage.)</p>

      <p class="note">The tree construction stage of this particular parser is <a
      href="#nestedParsing">being called reentrantly</a>, say from a call to <code
      data-x="dom-document-write">document.write()</code>.</p>

     </dd>


     <dt>Otherwise:</dt>

     <dd>

      <p>Run these steps:</p>

      <ol>

       <li><p>Let <var>the script</var> be the <span>pending parsing-blocking
       script</span>. There is no longer a <span>pending parsing-blocking script</span>.</p></li>

       <li><p>Block the <span data-x="tokenization">tokenizer</span> for this instance of the
       <span>HTML parser</span>, such that the <span>event loop</span> will not run <span
       data-x="concept-task">tasks</span> that invoke the <span
       data-x="tokenization">tokenizer</span>.</p></li>

       <li><p>If the parser's <code>Document</code> <span>has a style sheet that is blocking
       scripts</span> or <var>the script</var>'s <span>"ready to be parser-executed"</span>
       flag is not set: <span>spin the event loop</span> until the parser's <code>Document</code>
       <span>has no style sheet that is blocking scripts</span> and <var>the script</var>'s
       <span>"ready to be parser-executed"</span> flag is set.</p></li>

       <li>

        <p>If this <span data-x="abort a parser">parser has been aborted</span> in the meantime,
        abort these steps.</p>

        <p class="note">This could happen if, e.g., while the <span>spin the event loop</span>
        algorithm is running, the <span>browsing context</span> gets closed, or the <code
        data-x="dom-document-open">document.open()</code> method gets invoked on the
        <code>Document</code>.</p>

       </li>

       <li><p>Unblock the <span data-x="tokenization">tokenizer</span> for this instance of the
       <span>HTML parser</span>, such that <span data-x="concept-task">tasks</span> that invoke the
       <span data-x="tokenization">tokenizer</span> can again be run.</p></li>

       <li><p>Let the <span>insertion point</span> be just before the <span>next input
       character</span>.</p></li>

       <li><p>Increment the parser's <span>script nesting level</span> by one (it should be zero
       before this step, so this sets it to one).</p></li>

       <li><p><span data-x="execute the script block">Execute</span> <var>the
       script</var>.</p></li>

       <li><p>Decrement the parser's <span>script nesting level</span> by one. If the parser's
       <span>script nesting level</span> is zero (which it always should be at this point), then set
       the <span>parser pause flag</span> to false.</p>

       <li><p>Let the <span>insertion point</span> be undefined again.</p></li>

       <li><p>If there is once again a <span>pending parsing-blocking script</span>, then repeat
       these steps from step 1.</p></li>

      </ol>

     </dd>

    </dl>

   </dd>

   <dt>Any other end tag</dt>
   <dd>

    <p>Pop the <span>current node</span> off the <span>stack of open elements</span>.</p>

    <p>Switch the <span>insertion mode</span> to the <span>original insertion mode</span>.</p>

   </dd>

  </dl>


  <h6 id="parsing-main-intable">The "<dfn data-x="insertion mode: in table">in table</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: in table">in
  table</span>" <span>insertion mode</span>, the user agent must handle the token as follows:</p>

  <dl class="switch">

   <dt>A character token, if the <span>current node</span> is <code>table</code>, <code>tbody</code>, <code>tfoot</code>, <code>thead</code>, or <code>tr</code> element</dt> <!-- same list as foster parenting -->
   <dd>

     <p>Let the <dfn><var data-x="concept-pending-table-char-tokens">pending table character
     tokens</var></dfn> be an empty list of tokens.</p>

     <p>Let the <span>original insertion mode</span> be the current <span>insertion mode</span>.</p>

     <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in table text">in
     table text</span>" and reprocess the token.</p>

   </dd>

   <dt>A comment token</dt>
   <dd>
    <p><span>Insert a comment</span>.</p>
   </dd>

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A start tag whose tag name is "caption"</dt>
   <dd>

    <p><span>Clear the stack back to a table context</span>. (See below.)</p>

    <p>Insert a <span data-x="concept-parser-marker">marker</span> at the end of the <span>list of
    active formatting elements</span>.</p>

    <p><span>Insert an HTML element</span> for the token, then switch the <span>insertion
    mode</span> to "<span data-x="insertion mode: in caption">in caption</span>".</p>

   </dd>

   <dt>A start tag whose tag name is "colgroup"</dt>
   <dd>

    <p><span>Clear the stack back to a table context</span>. (See below.)</p>

    <p><span>Insert an HTML element</span> for the token, then switch the <span>insertion
    mode</span> to "<span data-x="insertion mode: in column group">in column group</span>".</p>

   </dd>

   <dt>A start tag whose tag name is "col"</dt>
   <dd>

    <!-- fake <colgroup> -->
    <p><span>Clear the stack back to a table context</span>. (See below.)</p>

    <p><span>Insert an HTML element</span> for a "colgroup" start tag token with no attributes, then
    switch the <span>insertion mode</span> to "<span data-x="insertion mode: in column group">in
    column group</span>".</p>
    <!-- end of fake <colgroup> -->

    <p>Reprocess the current token.</p>

   </dd>

   <dt>A start tag whose tag name is one of: "tbody", "tfoot", "thead"</dt>
   <dd>

    <p><span>Clear the stack back to a table context</span>. (See below.)</p>

    <p><span>Insert an HTML element</span> for the token, then switch the <span>insertion
    mode</span> to "<span data-x="insertion mode: in table body">in table body</span>".</p>

   </dd>

   <dt>A start tag whose tag name is one of: "td", "th", "tr"</dt>
   <dd>

    <!-- fake <colgroup> -->
    <p><span>Clear the stack back to a table context</span>. (See below.)</p>

    <p><span>Insert an HTML element</span> for a "tbody" start tag token with no attributes, then
    switch the <span>insertion mode</span> to "<span data-x="insertion mode: in table body">in table
    body</span>".</p>
    <!-- end of fake <colgroup> -->

    <p>Reprocess the current token.</p>

   </dd>

   <dt>A start tag whose tag name is "table"</dt>
   <dd>

    <p><span>Parse error</span>.</p>

    <!-- fake </table> -->
    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in table
    scope">have a <code>table</code> element in table scope</span>, ignore the token.</p>

    <p>Otherwise:</p>

    <p>Pop elements from this stack until a <code>table</code> element has been popped from the
    stack.</p>

    <p><span>Reset the insertion mode appropriately</span>.</p>
    <!-- end of fake </table> -->

    <p>Reprocess the token.</p>

   </dd>

   <dt>An end tag whose tag name is "table"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in table
    scope">have a <code>table</code> element in table scope</span>, this is a <span>parse
    error</span>; ignore the token.</p>

    <p>Otherwise:</p>

    <p>Pop elements from this stack until a <code>table</code> element has been popped from the
    stack.</p>

    <p><span>Reset the insertion mode appropriately</span>.</p>

   </dd>

   <dt>An end tag whose tag name is one of: "body", "caption", "col", "colgroup", "html", "tbody",
   "td", "tfoot", "th", "thead", "tr"</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A start tag whose tag name is one of: "style", "script", "template"</dt>
   <dt>An end tag whose tag name is "template"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span
    data-x="insertion mode: in head">in head</span>" <span>insertion
    mode</span>.</p>

   </dd>

   <dt>A start tag whose tag name is "input"</dt>
   <dd>

    <p>If the token does not have an attribute with the name "type", or if it does, but that
    attribute's value is not an <span>ASCII case-insensitive</span> match for the string "<code
   >hidden</code>", then: act as described in the "anything else" entry below.</p>

    <p>Otherwise:</p>

    <p><span>Parse error</span>.</p>

    <p><span>Insert an HTML element</span> for the token.</p>

    <p>Pop that <code>input</code> element off the <span>stack of open elements</span>.</p>

    <p><span data-x="acknowledge self-closing flag">Acknowledge the token's <i data-x="self-closing flag">self-closing
    flag</i></span>, if it is set.</p>

   </dd>

   <dt>A start tag whose tag name is "form"</dt>
   <dd>

    <p><span>Parse error</span>.</p>

    <p>If there is a <code>template</code> element on the <span>stack of open elements</span>, or if
    the <span><code data-x="form">form</code> element pointer</span> is not null, ignore the
    token.</p> <!-- in a <template>, the <form> would have no effect and thus be a waste of time... -->

    <p>Otherwise:</p>

    <p><span>Insert an HTML element</span> for the token, and set the <span><code
    data-x="form">form</code> element pointer</span> to point to the element created.</p>

    <p>Pop that <code>form</code> element off the <span>stack of open elements</span>.</p>

   </dd>

   <!-- "form" end tag falls through to in-body, which does the right thing -->

   <dt>An end-of-file token</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>Anything else</dt>
   <dd>

    <p><span>Parse error</span>. Enable <span data-x="foster parent">foster parenting</span>, process
    the token <span>using the rules for</span> the "<span data-x="insertion mode: in body">in
    body</span>" <span>insertion mode</span>, and then disable <span data-x="foster parent">foster
    parenting</span>.</p>

   </dd>

  </dl>

  <p>When the steps above require the UA to <dfn>clear the stack back to a table context</dfn>, it
  means that the UA must, while the <span>current node</span> is not a <code>table</code>,
  <code>template</code>, or <code>html</code> element, pop elements from the <span>stack of open
  elements</span>.</p>

  <p class="note">This is the same list of elements as used in the <i data-x="has an element in
  table scope">has an element in table scope</i> steps.</p>

  <p class="note">The <span>current node</span> being an <code>html</code> element after this
  process is a <span>fragment case</span>.</p>



  <h6 id="parsing-main-intabletext">The "<dfn data-x="insertion mode: in table text">in table text</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: in table
  text">in table text</span>" <span>insertion mode</span>, the user agent must handle the token as
  follows:</p>

  <dl class="switch">

   <dt>A character token that is U+0000 NULL</dt>
   <dd>

    <p><span>Parse error</span>. Ignore the token.</p>

   </dd>


   <dt>Any other character token</dt>
   <dd>

    <p>Append the character token to the <var data-x="concept-pending-table-char-tokens">pending
    table character tokens</var> list.</p>

   </dd>


   <dt>Anything else</dt>
   <dd>

    <!-- this can only be called if the current node is one of the table model elements -->

    <p>If any of the tokens in the <var data-x="concept-pending-table-char-tokens">pending table
    character tokens</var> list are character tokens that are not <span data-x="space
    character">space characters</span>, then this is a <span>parse error</span>: reprocess the
    character tokens in the <var data-x="concept-pending-table-char-tokens">pending table character
    tokens</var> list using the rules given in the "anything else" entry in the "<span
    data-x="insertion mode: in table">in table</span>" insertion mode.</p>

    <!-- if there's active formatting elements, it'll recreate those and foster parent the top one
    and then put the text nodes in the formatting elements; otherwise, it'll foster parent the
    character tokens. -->

    <p>Otherwise, <span data-x="insert a character">insert the characters</span> given by the <var
    data-x="concept-pending-table-char-tokens">pending table character tokens</var> list.</p> <!--
    i.e. inter-element whitespace in the table model isn't foster parented -->

    <!-- no need to empty the list, we're leaving the insertion mode and the list is always emptied
    before we reenter the mode -->

    <p>Switch the <span>insertion mode</span> to the <span>original insertion mode</span> and
    reprocess the token.</p>

   </dd>

  </dl>


  <h6 id="parsing-main-incaption">The "<dfn data-x="insertion mode: in caption">in caption</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: in caption">in
  caption</span>" <span>insertion mode</span>, the user agent must handle the token as follows:</p>

  <dl class="switch">

   <dt>An end tag whose tag name is "caption"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in table
    scope">have a <code>caption</code> element in table scope</span>, this is a <span>parse
    error</span>; ignore the token. (<span>fragment case</span>)</p>

    <p>Otherwise:</p>

    <p><span>Generate implied end tags</span>.</p>

    <p>Now, if the <span>current node</span> is not a <code>caption</code> element, then this is a
    <span>parse error</span>.</p>

    <p>Pop elements from this stack until a <code>caption</code> element has been popped from the
    stack.</p>

    <p><span>Clear the list of active formatting elements up to the last marker</span>.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in table">in
    table</span>".</p>

   </dd>

   <dt>A start tag whose tag name is one of: "caption", "col", "colgroup", "tbody", "td", "tfoot",
   "th", "thead", "tr"</dt> <dt>An end tag whose tag name is "table"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in table
    scope">have a <code>caption</code> element in table scope</span>, this is a <span>parse
    error</span>; ignore the token. (<span>fragment case</span>)</p>

    <p>Otherwise:</p>

    <!-- fake </caption> -->
    <p><span>Generate implied end tags</span>.</p>

    <p>Now, if the <span>current node</span> is not a <code>caption</code> element, then this is a
    <span>parse error</span>.</p>

    <p>Pop elements from this stack until a <code>caption</code> element has been popped from the
    stack.</p>

    <p><span>Clear the list of active formatting elements up to the last marker</span>.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in table">in
    table</span>".</p>
    <!-- end of fake </caption> -->

    <p>Reprocess the token.</p>

   </dd>

   <dt>An end tag whose tag name is one of: "body", "col", "colgroup", "html", "tbody", "td",
   "tfoot", "th", "thead", "tr"</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>Anything else</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

  </dl>


  <h6 id="parsing-main-incolgroup">The "<dfn data-x="insertion mode: in column group">in column group</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: in column
  group">in column group</span>" <span>insertion mode</span>, the user agent must handle the token
  as follows:</p>

  <dl class="switch">

   <dt>A character token that is one of U+0009 CHARACTER TABULATION, U+000A LINE FEED (LF), U+000C
   FORM FEED (FF), U+000D CARRIAGE RETURN (CR), or U+0020 SPACE</dt>
   <dd>
    <p><span data-x="insert a character">Insert the character</span>.</p>
   </dd>

   <dt>A comment token</dt>
   <dd>
    <p><span>Insert a comment</span>.</p>
   </dd>

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A start tag whose tag name is "html"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>A start tag whose tag name is "col"</dt>
   <dd>

    <p><span>Insert an HTML element</span> for the token. Immediately pop the <span>current
    node</span> off the <span>stack of open elements</span>.</p>

    <p><span data-x="acknowledge self-closing flag">Acknowledge the token's <i data-x="self-closing flag">self-closing
    flag</i></span>, if it is set.</p>
   </dd>

   <dt>An end tag whose tag name is "colgroup"</dt>
   <dd>

    <p>If the <span>current node</span> is not a <code>colgroup</code> element, then this is a
    <span>parse error</span>; ignore the token.</p> <!-- e.g. colgroup fragment case, or
    <template><col></colgroup> -->

    <p>Otherwise, pop the <span>current node</span> from the <span>stack of open elements</span>.
    Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in table">in
    table</span>".</p>

   </dd>

   <dt>An end tag whose tag name is "col"</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A start tag whose tag name is "template"</dt>
   <dt>An end tag whose tag name is "template"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    head">in head</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>An end-of-file token</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>Anything else</dt>
   <dd>

    <!-- fake </colgroup> -->
    <p>If the <span>current node</span> is not a <code>colgroup</code> element, then this is a
    <span>parse error</span>; ignore the token.</p> <!-- e.g. colgroup fragment case, or
    <template><col></colgroup> -->

    <p>Otherwise, pop the <span>current node</span> from the <span>stack of open
    elements</span>.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in table">in
    table</span>".</p>
    <!-- end of fake </colgroup> -->

    <p>Reprocess the token.</p>

   </dd>

  </dl>


  <h6 id="parsing-main-intbody">The "<dfn data-x="insertion mode: in table body">in table body</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: in table
  body">in table body</span>" <span>insertion mode</span>, the user agent must handle the token as
  follows:</p>

  <dl class="switch">

   <dt>A start tag whose tag name is "tr"</dt>
   <dd>

    <p><span>Clear the stack back to a table body context</span>. (See below.)</p>

    <p><span>Insert an HTML element</span> for the token, then switch the <span>insertion
    mode</span> to "<span data-x="insertion mode: in row">in row</span>".</p>

   </dd>

   <dt>A start tag whose tag name is one of: "th", "td"</dt>
   <dd>

    <p><span>Parse error</span>.</p>

    <!-- fake </tr> -->
    <p><span>Clear the stack back to a table body context</span>. (See below.)</p>

    <p><span>Insert an HTML element</span> for a "tr" start tag token with no attributes, then
    switch the <span>insertion mode</span> to "<span data-x="insertion mode: in row">in
    row</span>".</p>
    <!-- end of fake </tr> -->

    <p>Reprocess the current token.</p>

   </dd>

   <dt>An end tag whose tag name is one of: "tbody", "tfoot",
   "thead"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in table
    scope">have an element in table scope</span> that is an <span data-x="HTML elements">HTML
    element</span> with the same tag name as the token, this is a <span>parse error</span>;
    ignore the token.</p>

    <p>Otherwise:</p>

    <p><span>Clear the stack back to a table body context</span>. (See below.)</p>

    <p>Pop the <span>current node</span> from the <span>stack of open elements</span>. Switch the
    <span>insertion mode</span> to "<span data-x="insertion mode: in table">in table</span>".</p>

   </dd>

   <dt>A start tag whose tag name is one of: "caption", "col",
   "colgroup", "tbody", "tfoot", "thead"</dt>
   <dt>An end tag whose tag name is "table"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in table
    scope">have a <code>tbody</code>, <code>thead</code>, or <code>tfoot</code> element in table
    scope</span>, this is a <span>parse error</span>; ignore the token.</p>

    <p>Otherwise:</p>

    <p><span>Clear the stack back to a table body context</span>. (See below.)</p>

    <!-- fake </tbody>, </tfoot>, or </thead>, whatever is the current node -->

    <p>Pop the <span>current node</span> from the <span>stack of open elements</span>. Switch the
    <span>insertion mode</span> to "<span data-x="insertion mode: in table">in table</span>".</p>

    <!-- end of fake </tbody>, </tfoot>, or </thead>, whatever was the current node -->

    <p>Reprocess the token.</p>

   </dd>

   <dt>An end tag whose tag name is one of: "body", "caption", "col", "colgroup", "html", "td",
   "th", "tr"</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>Anything else</dt>
   <dd>
    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    table">in table</span>" <span>insertion mode</span>.</p>
   </dd>

  </dl>

  <p>When the steps above require the UA to <dfn>clear the stack back to a table body context</dfn>,
  it means that the UA must, while the <span>current node</span> is not a <code>tbody</code>,
  <code>tfoot</code>, <code>thead</code>, <code>template</code>, or <code>html</code> element, pop
  elements from the <span>stack of open elements</span>.</p>

  <p class="note">The <span>current node</span> being an <code>html</code> element after this
  process is a <span>fragment case</span>.</p>


  <h6 id="parsing-main-intr">The "<dfn data-x="insertion mode: in row">in row</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: in row">in
  row</span>" <span>insertion mode</span>, the user agent must handle the token as follows:</p>

  <dl class="switch">

   <dt>A start tag whose tag name is one of: "th", "td"</dt>
   <dd>

    <p><span>Clear the stack back to a table row context</span>. (See below.)</p>

    <p><span>Insert an HTML element</span> for the token, then switch the <span>insertion
    mode</span> to "<span data-x="insertion mode: in cell">in cell</span>".</p>

    <p>Insert a <span data-x="concept-parser-marker">marker</span> at the end of the <span>list of
    active formatting elements</span>.</p>

   </dd>

   <dt>An end tag whose tag name is "tr"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in table
    scope">have a <code>tr</code> element in table scope</span>, this is a <span>parse error</span>;
    ignore the token.</p>

    <p>Otherwise:</p>

    <p><span>Clear the stack back to a table row context</span>. (See below.)</p>

    <p>Pop the <span>current node</span> (which will be a <code>tr</code> element) from the
    <span>stack of open elements</span>. Switch the <span>insertion mode</span> to "<span
    data-x="insertion mode: in table body">in table body</span>".</p>

   </dd>

   <dt>A start tag whose tag name is one of: "caption", "col", "colgroup", "tbody", "tfoot",
   "thead", "tr"</dt>
   <dt>An end tag whose tag name is "table"</dt>
   <dd>

    <!-- fake <tr> -->
    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in table
    scope">have a <code>tr</code> element in table scope</span>, this is a <span>parse error</span>;
    ignore the token.</p>

    <p>Otherwise:</p>

    <p><span>Clear the stack back to a table row context</span>. (See below.)</p>

    <p>Pop the <span>current node</span> (which will be a <code>tr</code> element) from the
    <span>stack of open elements</span>. Switch the <span>insertion mode</span> to "<span
    data-x="insertion mode: in table body">in table body</span>".</p>
    <!-- end of fake </tr> -->

    <p>Reprocess the token.</p>

   </dd>

   <dt>An end tag whose tag name is one of: "tbody", "tfoot", "thead"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in table
    scope">have an element in table scope</span> that is an <span data-x="HTML elements">HTML
    element</span> with the same tag name as the token, this is a <span>parse error</span>;
    ignore the token.</p>

    <!-- fake <tr> -->
    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in table
    scope">have a <code>tr</code> element in table scope</span>, ignore the token.</p>

    <p>Otherwise:</p>

    <p><span>Clear the stack back to a table row context</span>. (See below.)</p>

    <p>Pop the <span>current node</span> (which will be a <code>tr</code> element) from the
    <span>stack of open elements</span>. Switch the <span>insertion mode</span> to "<span
    data-x="insertion mode: in table body">in table body</span>".</p>
    <!-- end of fake </tr> -->

    <p>Reprocess the token.</p>

   </dd>

   <dt>An end tag whose tag name is one of: "body", "caption", "col", "colgroup", "html", "td",
   "th"</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>Anything else</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    table">in table</span>" <span>insertion mode</span>.</p>

   </dd>

  </dl>

  <p>When the steps above require the UA to <dfn>clear the stack back to a table row context</dfn>,
  it means that the UA must, while the <span>current node</span> is not a <code>tr</code>,
  <code>template</code>, or <code>html</code> element, pop elements from the <span>stack of open
  elements</span>.</p>

  <p class="note">The <span>current node</span> being an <code>html</code> element after this
  process is a <span>fragment case</span>.</p>


  <h6 id="parsing-main-intd">The "<dfn data-x="insertion mode: in cell">in cell</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: in cell">in cell</span>" <span>insertion mode</span>, the user agent must handle the token as follows:</p>

  <dl class="switch">

   <dt>An end tag whose tag name is one of: "td", "th"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in table
    scope">have an element in table scope</span> that is an <span data-x="HTML elements">HTML
    element</span> with the same tag name as that of the token, then this is a <span>parse
    error</span>; ignore the token.</p>

    <p>Otherwise:</p>

    <p><span>Generate implied end tags</span>.</p>

    <p>Now, if the <span>current node</span> is not an <span data-x="HTML elements">HTML
    element</span> with the same tag name as the token, then this is a <span>parse error</span>.</p>

    <p>Pop elements from the <span>stack of open elements</span> stack until an <span data-x="HTML
    elements">HTML element</span> with the same tag name as the token has been popped from the
    stack.</p>

    <p><span>Clear the list of active formatting elements up to the last marker</span>.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in row">in
    row</span>".</p> <!-- current node here will be a <tr> normally; but could be <html> in the
    fragment case, or <template> in the template case -->

   </dd>

   <dt>A start tag whose tag name is one of: "caption", "col",
   "colgroup", "tbody", "td", "tfoot", "th", "thead", "tr"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does <em>not</em> <span data-x="has an element in
    table scope">have a <code>td</code> or <code>th</code> element in table scope</span>, then this
    is a <span>parse error</span>; ignore the token. (<span>fragment case</span>)</p>

    <p>Otherwise, <span>close the cell</span> (see below) and reprocess the token.</p>

   </dd>

   <dt>An end tag whose tag name is one of: "body", "caption",
   "col", "colgroup", "html"</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>An end tag whose tag name is one of: "table", "tbody",
   "tfoot", "thead", "tr"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in table
    scope">have an element in table scope</span> that is an <span data-x="HTML elements">HTML
    element</span> with the same tag name as that of the token, then this is a <span>parse
    error</span>; ignore the token.</p>

    <p>Otherwise, <span>close the cell</span> (see below) and reprocess the token.</p>

   </dd>

   <dt>Anything else</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

  </dl>

  <p>Where the steps above say to <dfn>close the cell</dfn>, they mean to run the following
  algorithm:</p>

  <ol>

   <!-- fake </td> or </th> -->
   <li><p><span>Generate implied end tags</span>.</p></li>

   <li><p>If the <span>current node</span> is not now a <code>td</code> element or a <code>th</code>
   element, then this is a <span>parse error</span>.</p></li>

   <li><p>Pop elements from the <span>stack of open elements</span> stack until a <code>td</code>
   element or a <code>th</code> element has been popped from the stack.</p></li>

   <li><p><span>Clear the list of active formatting elements up to the last marker</span>.</p></li>

   <li><p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in row">in
   row</span>".</p></li> <!-- current node here will be a <tr> normally; but could be <html> in the
   fragment case, or <template> in the template case -->
   <!-- end of fake </td> or </th> -->

  </ol>

  <p class="note">The <span>stack of open elements</span> cannot have both a <code>td</code> and a
  <code>th</code> element <span data-x="has an element in table scope">in table scope</span> at the
  same time, nor can it have neither when the <span>close the cell</span> algorithm is invoked.</p>


  <h6 id="parsing-main-inselect">The "<dfn data-x="insertion mode: in select">in select</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: in select">in
  select</span>" <span>insertion mode</span>, the user agent must handle the token as follows:</p>

  <dl class="switch">

   <dt>A character token that is U+0000 NULL</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>Any other character token</dt>
   <dd>

    <p><span data-x="insert a character">Insert the token's character</span>.</p>

   </dd>

   <dt>A comment token</dt>
   <dd>
    <p><span>Insert a comment</span>.</p>
   </dd>

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A start tag whose tag name is "html"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>A start tag whose tag name is "option"</dt>
   <dd>

    <!-- fake </option> (maybe) -->
    <p>If the <span>current node</span> is an <code>option</code> element, pop that node from the
    <span>stack of open elements</span>.</p>
    <!-- end of fake </option> -->

    <p><span>Insert an HTML element</span> for the token.</p>

   </dd>

   <dt>A start tag whose tag name is "optgroup"</dt>
   <dd>

    <!-- fake </option> (maybe) -->
    <p>If the <span>current node</span> is an <code>option</code> element, pop that node from the
    <span>stack of open elements</span>.</p>
    <!-- end of fake </option> -->

    <!-- fake </optgroup> (maybe) -->
    <p>If the <span>current node</span> is an <code>optgroup</code> element, pop that node from the
    <span>stack of open elements</span>.</p>
    <!-- end of fake </optgroup> -->

    <p><span>Insert an HTML element</span> for the token.</p>

   </dd>

   <dt>An end tag whose tag name is "optgroup"</dt>
   <dd>

    <!-- fake </option> (maybe) -->
    <p>First, if the <span>current node</span> is an <code>option</code> element, and the node
    immediately before it in the <span>stack of open elements</span> is an <code>optgroup</code>
    element, then pop the <span>current node</span> from the <span>stack of open
    elements</span>.</p>
    <!-- end of fake </option> -->

    <p>If the <span>current node</span> is an <code>optgroup</code> element, then pop that node from
    the <span>stack of open elements</span>. Otherwise, this is a <span>parse error</span>; ignore
    the token.</p>

   </dd>

   <dt>An end tag whose tag name is "option"</dt>
   <dd>

    <p>If the <span>current node</span> is an <code>option</code> element, then pop that node from
    the <span>stack of open elements</span>. Otherwise, this is a <span>parse error</span>; ignore
    the token.</p>

   </dd>

   <dt>An end tag whose tag name is "select"</dt>
   <dd>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in select
    scope">have a <code>select</code> element in select scope</span>, this is a <span>parse
    error</span>; ignore the token. (<span>fragment case</span>)</p>

    <p>Otherwise:</p>

    <p>Pop elements from the <span>stack of open elements</span> until a <code>select</code> element
    has been popped from the stack.</p>

    <p><span>Reset the insertion mode appropriately</span>.</p>

   </dd>

   <dt>A start tag whose tag name is "select"</dt>
   <dd>

    <p><span>Parse error</span>.</p>

    <!-- fake </select> -->
    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in select
    scope">have a <code>select</code> element in select scope</span>, ignore the token.
    (<span>fragment case</span>)</p>

    <p>Otherwise:</p>

    <p>Pop elements from the <span>stack of open elements</span> until a <code>select</code> element
    has been popped from the stack.</p>

    <p><span>Reset the insertion mode appropriately</span>.</p>
    <!-- end of fake </select> -->

    <p class="note">It just gets treated like an end tag.</p>

   </dd>

   <dt>A start tag whose tag name is one of: "input", "keygen", "textarea"</dt>
   <dd>

    <p><span>Parse error</span>.</p>

    <!-- fake </select> -->
    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in select
    scope">have a <code>select</code> element in select scope</span>, ignore the token.
    (<span>fragment case</span>)</p>

    <p>Otherwise:</p>

    <p>Pop elements from the <span>stack of open elements</span> until a <code>select</code> element
    has been popped from the stack.</p>

    <p><span>Reset the insertion mode appropriately</span>.</p>
    <!-- end of fake </select> -->

    <p>Reprocess the token.</p>

   </dd>

   <dt>A start tag whose tag name is one of: "script", "template"</dt>
   <dt>An end tag whose tag name is "template"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    head">in head</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>An end-of-file token</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>Anything else</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

  </dl>


  <h6 id="parsing-main-inselectintable">The "<dfn data-x="insertion mode: in select in table">in select in table</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: in select in
  table">in select in table</span>" <span>insertion mode</span>, the user agent must handle the
  token as follows:</p>

  <dl class="switch">

   <dt>A start tag whose tag name is one of: "caption", "table", "tbody", "tfoot", "thead", "tr",
   "td", "th"</dt>
   <dd>

    <p><span>Parse error</span>.</p>

    <!-- fake </select> -->
    <p>Pop elements from the <span>stack of open elements</span> until a <code>select</code> element
    has been popped from the stack.</p>

    <p><span>Reset the insertion mode appropriately</span>.</p>
    <!-- end of fake </select> -->

    <p>Reprocess the token.</p>

   </dd>

   <dt>An end tag whose tag name is one of: "caption", "table", "tbody", "tfoot", "thead", "tr",
   "td", "th"</dt>
   <dd>

    <p><span>Parse error</span>.</p>

    <p>If the <span>stack of open elements</span> does not <span data-x="has an element in table
    scope">have an element in table scope</span> that is an <span data-x="HTML elements">HTML
    element</span> with the same tag name as that of the token, then ignore the token.</p>

    <p>Otherwise:</p>

    <!-- fake </select> -->
    <p>Pop elements from the <span>stack of open elements</span> until a <code>select</code> element
    has been popped from the stack.</p>

    <p><span>Reset the insertion mode appropriately</span>.</p>
    <!-- end of fake </select> -->

    <p>Reprocess the token.</p>

   </dd>

   <dt>Anything else</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    select">in select</span>" <span>insertion mode</span>.</p>

   </dd>

  </dl>



  <h6 id="parsing-main-intemplate">The "<dfn data-x="insertion mode: in template">in template</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: in template">in
  template</span>" <span>insertion mode</span>, the user agent must handle the token as follows:</p>

  <dl class="switch">

   <!-- first, tokens we always ignore: -->

   <!-- html: ignored in "in body" mode if there's a <template> on the stack -->
   <!-- head: ignored in "in body" mode always -->
   <!-- body: ignored in "in body" mode if there's a <template> on the stack -->
   <!-- frameset: ignored in "in body" mode if frameset-ok is set to not-ok, which <template> sets it to -->


   <!-- second, tokens that are ambiguous (allowed in multiple modes), let's just handle them in a generic way and not pick a mode: -->

   <dt>A character token</dt>
   <dt>A comment token</dt>
   <dt>A DOCTYPE token</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>A start tag whose tag name is one of: "base", "basefont", "bgsound", "link", "meta", "noframes", "script", "style", "template", "title"</dt>
   <dt>An end tag whose tag name is "template"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    head">in head</span>" <span>insertion mode</span>.</p>

   </dd>

   <!-- now, tokens that imply certain modes -->

   <dt>A start tag whose tag name is one of: "caption", "colgroup", "tbody", "tfoot", "thead"</dt>
   <dd>

    <p>Pop the <span>current template insertion mode</span> off the <span>stack of template
    insertion modes</span>.</p>

    <p>Push "<span data-x="insertion mode: in table">in table</span>" onto the <span>stack of
    template insertion modes</span> so that it is the new <span>current template insertion
    mode</span>.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in table">in
    table</span>", and reprocess the token.</p>

   </dd>

   <dt>A start tag whose tag name is "col"</dt>
   <dd>

    <p>Pop the <span>current template insertion mode</span> off the <span>stack of template
    insertion modes</span>.</p>

    <p>Push "<span data-x="insertion mode: in column group">in column group</span>" onto the
    <span>stack of template insertion modes</span> so that it is the new <span>current template
    insertion mode</span>.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in column group">in
    column group</span>", and reprocess the token.</p>

   </dd>

   <dt>A start tag whose tag name is "tr"</dt>
   <dd>

    <p>Pop the <span>current template insertion mode</span> off the <span>stack of template
    insertion modes</span>.</p>

    <p>Push "<span data-x="insertion mode: in table body">in table body</span>" onto the <span>stack
    of template insertion modes</span> so that it is the new <span>current template insertion
    mode</span>.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in table body">in
    table body</span>", and reprocess the token.</p>

   </dd>

   <dt>A start tag whose tag name is one of: "td", "th"</dt>
   <dd>

    <p>Pop the <span>current template insertion mode</span> off the <span>stack of template
    insertion modes</span>.</p>

    <p>Push "<span data-x="insertion mode: in row">in row</span>" onto the <span>stack of template
    insertion modes</span> so that it is the new <span>current template insertion mode</span>.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in row">in
    row</span>", and reprocess the token.</p>

   </dd>

   <!-- default to in-body mode -->

   <dt>Any other start tag</dt>
   <dd>

    <p>Pop the <span>current template insertion mode</span> off the <span>stack of template
    insertion modes</span>.</p>

    <p>Push "<span data-x="insertion mode: in body">in body</span>" onto the <span>stack of template
    insertion modes</span> so that it is the new <span>current template insertion mode</span>.</p>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: in body">in
    body</span>", and reprocess the token.</p>

   </dd>

   <dt>Any other end tag</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <!-- EOF -->


   <dt>An end-of-file token</dt>
   <dd>

    <p>If there is no <code>template</code> element on the <span>stack of open elements</span>, then
    <span>stop parsing</span>. (<span>fragment case</span>)</p>

    <p>Otherwise, this is a <span>parse error</span>.</p>

    <!-- fake </template> -->
    <p>Pop elements from the <span>stack of open elements</span> until a <code>template</code>
    element has been popped from the stack.</p>

    <p><span>Clear the list of active formatting elements up to the last marker</span>.</p>

    <p>Pop the <span>current template insertion mode</span> off the <span>stack of template
    insertion modes</span>.</p>

    <p><span>Reset the insertion mode appropriately</span>.</p>
    <!-- end of fake </template> -->

    <p>Reprocess the token.</p>

   </dd>

  </dl>


  <h6 id="parsing-main-afterbody">The "<dfn data-x="insertion mode: after body">after body</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: after body">after body</span>" <span>insertion mode</span>, the user agent must handle the token as follows:</p>

  <dl class="switch">

   <dt>A character token that is one of U+0009 CHARACTER TABULATION, U+000A LINE FEED (LF), U+000C
   FORM FEED (FF), U+000D CARRIAGE RETURN (CR), or U+0020 SPACE</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>A comment token</dt>
   <dd>

    <p><span>Insert a comment</span> as the last child of the first element in the <span>stack of
    open elements</span> (the <code>html</code> element).</p>

   </dd>

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A start tag whose tag name is "html"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>An end tag whose tag name is "html"</dt>
   <dd>

    <p>If the parser was originally created as part of the <span>HTML fragment parsing
    algorithm</span>, this is a <span>parse error</span>; ignore the token. (<span>fragment
    case</span>)</p>

    <p>Otherwise, switch the <span>insertion mode</span> to "<span data-x="insertion mode: after
    after body">after after body</span>".</p>

   </dd>

   <dt>An end-of-file token</dt>
   <dd>
    <p><span>Stop parsing</span>.</p>
   </dd>

   <dt>Anything else</dt>
   <dd>

    <p><span>Parse error</span>. Switch the <span>insertion mode</span> to "<span data-x="insertion
    mode: in body">in body</span>" and reprocess the token.</p>

   </dd>

  </dl>


  <h6 id="parsing-main-inframeset">The "<dfn data-x="insertion mode: in frameset">in frameset</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: in frameset">in
  frameset</span>" <span>insertion mode</span>, the user agent must handle the token as follows:</p>

  <dl class="switch">

   <dt>A character token that is one of U+0009 CHARACTER TABULATION, U+000A LINE FEED (LF), U+000C
   FORM FEED (FF), U+000D CARRIAGE RETURN (CR), or U+0020 SPACE</dt>
   <dd>
    <p><span data-x="insert a character">Insert the character</span>.</p>
   </dd>

   <dt>A comment token</dt>
   <dd>
    <p><span>Insert a comment</span>.</p>
   </dd>

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A start tag whose tag name is "html"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>A start tag whose tag name is "frameset"</dt>
   <dd>
    <p><span>Insert an HTML element</span> for the token.</p>
   </dd>

   <dt>An end tag whose tag name is "frameset"</dt>
   <dd>

    <p>If the <span>current node</span> is the root <code>html</code> element, then this is a
    <span>parse error</span>; ignore the token. (<span>fragment case</span>)</p>

    <p>Otherwise, pop the <span>current node</span> from the <span>stack of open
    elements</span>.</p>

    <p>If the parser was <em>not</em> originally created as part of the <span>HTML fragment parsing
    algorithm</span> (<span>fragment case</span>), and the <span>current node</span> is no longer a
    <code>frameset</code> element, then switch the <span>insertion mode</span> to "<span
    data-x="insertion mode: after frameset">after frameset</span>".</p>

   </dd>

   <dt>A start tag whose tag name is "frame"</dt>
   <dd>

    <p><span>Insert an HTML element</span> for the token. Immediately pop the <span>current
    node</span> off the <span>stack of open elements</span>.</p>

    <p><span data-x="acknowledge self-closing flag">Acknowledge the token's <i data-x="self-closing flag">self-closing
    flag</i></span>, if it is set.</p>

   </dd>

   <dt>A start tag whose tag name is "noframes"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    head">in head</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>An end-of-file token</dt>
   <dd>

    <p>If the <span>current node</span> is not the root <code>html</code> element, then this is a
    <span>parse error</span>.</p>

    <p class="note">The <span>current node</span> can only be the root
    <code>html</code> element in the <span>fragment case</span>.</p>

    <p><span>Stop parsing</span>.</p>

   </dd>

   <dt>Anything else</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

  </dl>


  <h6 id="parsing-main-afterframeset">The "<dfn data-x="insertion mode: after frameset">after frameset</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: after
  frameset">after frameset</span>" <span>insertion mode</span>, the user agent must handle the token
  as follows:</p>

  <!-- due to rules in the "in frameset" mode, this can't be entered in the fragment case -->
  <dl class="switch">

   <dt>A character token that is one of U+0009 CHARACTER TABULATION, U+000A LINE FEED (LF), U+000C
   FORM FEED (FF), U+000D CARRIAGE RETURN (CR), or U+0020 SPACE</dt>
   <dd>
    <p><span data-x="insert a character">Insert the character</span>.</p>
   </dd>

   <dt>A comment token</dt>
   <dd>
    <p><span>Insert a comment</span>.</p>
   </dd>

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A start tag whose tag name is "html"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>An end tag whose tag name is "html"</dt>
   <dd>

    <p>Switch the <span>insertion mode</span> to "<span data-x="insertion mode: after after
    frameset">after after frameset</span>".</p>

   </dd>

   <dt>A start tag whose tag name is "noframes"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    head">in head</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>An end-of-file token</dt>
   <dd>
    <p><span>Stop parsing</span>.</p>
   </dd>

   <dt>Anything else</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

  </dl>


  <h6>The "<dfn data-x="insertion mode: after after body">after after body</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: after after
  body">after after body</span>" <span>insertion mode</span>, the user agent must handle the token
  as follows:</p>

  <dl class="switch">

   <dt>A comment token</dt>
   <dd>
    <p><span>Insert a comment</span> as the last child of the <code>Document</code> object.</p>
   </dd>

   <dt>A DOCTYPE token</dt>
   <dt>A character token that is one of U+0009 CHARACTER TABULATION, U+000A LINE FEED (LF), U+000C
   FORM FEED (FF), U+000D CARRIAGE RETURN (CR), or U+0020 SPACE</dt>
   <dt>A start tag whose tag name is "html"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>An end-of-file token</dt>
   <dd>
    <p><span>Stop parsing</span>.</p>
   </dd>

   <dt>Anything else</dt>
   <dd>

    <p><span>Parse error</span>. Switch the <span>insertion mode</span> to "<span data-x="insertion
    mode: in body">in body</span>" and reprocess the token.</p>

   </dd>

  </dl>


  <h6>The "<dfn data-x="insertion mode: after after frameset">after after frameset</dfn>" insertion mode</h6>

  <p>When the user agent is to apply the rules for the "<span data-x="insertion mode: after after
  frameset">after after frameset</span>" <span>insertion mode</span>, the user agent must handle the
  token as follows:</p>

  <dl class="switch">

   <dt>A comment token</dt>
   <dd>
    <p><span>Insert a comment</span> as the last child of the <code>Document</code> object.</p>
   </dd>

   <dt>A DOCTYPE token</dt>
   <dt>A character token that is one of U+0009 CHARACTER TABULATION, U+000A LINE FEED (LF), U+000C
   FORM FEED (FF), U+000D CARRIAGE RETURN (CR), or U+0020 SPACE</dt>
   <dt>A start tag whose tag name is "html"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    body">in body</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>An end-of-file token</dt>
   <dd>
    <p><span>Stop parsing</span>.</p>
   </dd>

   <dt>A start tag whose tag name is "noframes"</dt>
   <dd>

    <p>Process the token <span>using the rules for</span> the "<span data-x="insertion mode: in
    head">in head</span>" <span>insertion mode</span>.</p>

   </dd>

   <dt>Anything else</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

  </dl>



  <h5 id="parsing-main-inforeign">The rules for parsing tokens <dfn data-x="insertion mode: in foreign content">in foreign content</dfn></h5>

  <p>When the user agent is to apply the rules for parsing tokens in foreign content, the user agent
  must handle the token as follows:</p>

  <dl class="switch">

   <dt>A character token that is U+0000 NULL</dt>
   <dd>

    <p><span>Parse error</span>. <span data-x="insert a character">Insert a U+FFFD REPLACEMENT
    CHARACTER character</span>.</p>

   </dd>

   <dt>A character token that is one of U+0009 CHARACTER TABULATION, U+000A LINE FEED (LF), U+000C
   FORM FEED (FF), U+000D CARRIAGE RETURN (CR), or U+0020 SPACE</dt>
   <dd>

    <p><span data-x="insert a character">Insert the token's character</span>.</p>

   </dd>

   <dt>Any other character token</dt>
   <dd>

    <p><span data-x="insert a character">Insert the token's character</span>.</p>

    <p>Set the <span>frameset-ok flag</span> to "not ok".</p>

   </dd>

   <dt>A comment token</dt>
   <dd>

    <p><span>Insert a comment</span>.</p>

   </dd>

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A start tag whose tag name is one of: <!--"a",--> "b", "big", "blockquote", "body"<!--by
   inspection-->, "br", "center", "code", "dd", "div", "dl", "dt"<!-- so that dd and dt can be
   handled uniformly throughout the parser -->, "em", "embed", "h1", "h2", "h3", "h4"<!--for
   completeness-->, "h5", "h6"<!--for completeness-->, "head"<!--by inspection-->, "hr", "i", "img",
   "li", "listing"<!-- so that pre and listing can be handled uniformly throughout the parser -->,
   "menu", "meta", "nobr", "ol"<!-- so that dl, ul, and ol can be handled uniformly throughout the
   parser -->, "p", "pre", "ruby", "s", <!--"script",--> "small", "span", "strong", "strike"<!-- so
   that s and strike can be handled uniformly throughout the parser -->, <!--"style",--> "sub",
   "sup", "table"<!--by inspection-->, "tt", "u", "ul", "var"</dt> <!-- this list was determined
   empirically by studying over 6,000,000,000 pages that were specifically not XML pages -->
   <dt>A start tag whose tag name is "font", if the token has any attributes named "color", "face",
   or "size"</dt> <!-- the attributes here are required so that SVG <font> will go through as SVG
   but legacy <font>s won't -->

   <dd>

    <p><span>Parse error</span>.</p>

    <!-- for sanity's sake, we limit this wacked quirk to legacy full-document parsing, not to
    innerHTML. We have no data showing whether (or that) this is needed for innerHTML. If innerHTML
    is used on an SVG or MathML node, it definitely doesn't make any sense (there's nothing to pop
    to in the first place). Therefore, rather than trying to figure out in what convoluted
    conditions we could actually do this quirk for innerHTML, we just don't do it at all. -->

    <p>If the parser was originally created for the <span>HTML fragment parsing algorithm</span>,
    then act as described in the "any other start tag" entry below. (<span>fragment case</span>)</p>

    <p>Otherwise:</p>

    <p>Pop an element from the <span>stack of open elements</span>, and then keep popping more
    elements from the <span>stack of open elements</span> until the <span>current node</span> is a
    <span>MathML text integration point</span>, an <span>HTML integration point</span>, or an
    element in the <span>HTML namespace</span>.</p>

    <p>Then, reprocess the token.</p>

   </dd>

   <dt>Any other start tag</dt>
   <dd>

    <p>If the <span>adjusted current node</span> is an element in the <span>MathML namespace</span>,
    <span>adjust MathML attributes</span> for the token. (This fixes the case of MathML attributes
    that are not all lowercase.)</p>

    <p>If the <span>adjusted current node</span> is an element in the <span>SVG namespace</span>, and the
    token's tag name is one of the ones in the first column of the following table, change the tag
    name to the name given in the corresponding cell in the second column. (This fixes the case of
    SVG elements that are not all lowercase.)</p>

    <table>
     <thead>
      <tr> <th> Tag name <th> Element name
     <tbody>
      <tr> <td> <code>altglyph</code> <td> <code>altGlyph</code>
      <tr> <td> <code>altglyphdef</code> <td> <code>altGlyphDef</code>
      <tr> <td> <code>altglyphitem</code> <td> <code>altGlyphItem</code>
      <tr> <td> <code>animatecolor</code> <td> <code>animateColor</code>
      <tr> <td> <code>animatemotion</code> <td> <code>animateMotion</code>
      <tr> <td> <code>animatetransform</code> <td> <code>animateTransform</code>
      <tr> <td> <code>clippath</code> <td> <code>clipPath</code>
      <tr> <td> <code>feblend</code> <td> <code>feBlend</code>
      <tr> <td> <code>fecolormatrix</code> <td> <code>feColorMatrix</code>
      <tr> <td> <code>fecomponenttransfer</code> <td> <code>feComponentTransfer</code>
      <tr> <td> <code>fecomposite</code> <td> <code>feComposite</code>
      <tr> <td> <code>feconvolvematrix</code> <td> <code>feConvolveMatrix</code>
      <tr> <td> <code>fediffuselighting</code> <td> <code>feDiffuseLighting</code>
      <tr> <td> <code>fedisplacementmap</code> <td> <code>feDisplacementMap</code>
      <tr> <td> <code>fedistantlight</code> <td> <code>feDistantLight</code>
      <tr> <td> <code>fedropshadow</code> <td> <code>feDropShadow</code>
      <tr> <td> <code>feflood</code> <td> <code>feFlood</code>
      <tr> <td> <code>fefunca</code> <td> <code>feFuncA</code>
      <tr> <td> <code>fefuncb</code> <td> <code>feFuncB</code>
      <tr> <td> <code>fefuncg</code> <td> <code>feFuncG</code>
      <tr> <td> <code>fefuncr</code> <td> <code>feFuncR</code>
      <tr> <td> <code>fegaussianblur</code> <td> <code>feGaussianBlur</code>
      <tr> <td> <code>feimage</code> <td> <code>feImage</code>
      <tr> <td> <code>femerge</code> <td> <code>feMerge</code>
      <tr> <td> <code>femergenode</code> <td> <code>feMergeNode</code>
      <tr> <td> <code>femorphology</code> <td> <code>feMorphology</code>
      <tr> <td> <code>feoffset</code> <td> <code>feOffset</code>
      <tr> <td> <code>fepointlight</code> <td> <code>fePointLight</code>
      <tr> <td> <code>fespecularlighting</code> <td> <code>feSpecularLighting</code>
      <tr> <td> <code>fespotlight</code> <td> <code>feSpotLight</code>
      <tr> <td> <code>fetile</code> <td> <code>feTile</code>
      <tr> <td> <code>feturbulence</code> <td> <code>feTurbulence</code>
      <tr> <td> <code>foreignobject</code> <td> <code>foreignObject</code>
      <tr> <td> <code>glyphref</code> <td> <code>glyphRef</code>
      <tr> <td> <code>lineargradient</code> <td> <code>linearGradient</code>
      <tr> <td> <code>radialgradient</code> <td> <code>radialGradient</code>
      <!--<tr> <td> <code>solidcolor</code> <td> <code>solidColor</code> (SVG 1.2)-->
      <tr> <td> <code>textpath</code> <td> <code>textPath</code>
    </table>

    <p>If the <span>adjusted current node</span> is an element in the <span>SVG namespace</span>,
    <span>adjust SVG attributes</span> for the token. (This fixes the case of SVG attributes that
    are not all lowercase.)</p>

    <p><span>Adjust foreign attributes</span> for the token. (This fixes the use of namespaced
    attributes, in particular XLink in SVG.)</p>

    <p><span>Insert a foreign element</span> for the token, in the same namespace as the
    <span>adjusted current node</span>.</p>

    <p>If the token has its <i data-x="self-closing flag">self-closing flag</i> set, then run the appropriate steps from the
    following list:</p>

    <dl class="switch">

     <dt>If the token's tag name is "script", and the new <span>current node</span> is in the <span>SVG namespace</span></dt>

     <dd>

      <p><span data-x="acknowledge self-closing flag">Acknowledge the token's <i data-x="self-closing flag">self-closing
      flag</i></span>, and then act as described in the steps for a "script" end tag below.</p>

     </dd>

     <dt>Otherwise</dt>

     <dd>

      <p>Pop the <span>current node</span> off the <span>stack of open elements</span> and <span
      data-x="acknowledge self-closing flag">acknowledge the token's <i data-x="self-closing flag">self-closing
      flag</i></span>.</p>

     </dd>

    </dl>

   </dd>

   <dt id="scriptForeignEndTag">An end tag whose tag name is "script", if the <span>current node</span> is a <code>script</code> element in the <span>SVG namespace</span></dt>
   <dd>

    <p>Pop the <span>current node</span> off the <span>stack of open elements</span>.</p>

    <p>Let the <var>old insertion point</var> have the same value as the current
    <span>insertion point</span>. Let the <span>insertion point</span> be just before the <span>next
    input character</span>.</p>

    <p>Increment the parser's <span>script nesting level</span> by one. Set the <span>parser pause
    flag</span> to true.</p>

    <p><a href="http://www.w3.org/TR/SVGMobile12/script.html#ScriptContentProcessing">Process the
    <code>script</code> element</a> according to the SVG rules, if the user agent supports
    SVG. <a href="#refsSVG">\[SVG]</a></p>

    <p class="note">Even if this causes <span data-x="dom-document-write">new characters to be
    inserted into the tokenizer</span>, the parser will not be executed reentrantly, since the
    <span>parser pause flag</span> is true.</p>

    <p>Decrement the parser's <span>script nesting level</span> by one. If the parser's <span>script
    nesting level</span> is zero, then set the <span>parser pause flag</span> to false.</p>

    <p>Let the <span>insertion point</span> have the value of the <var>old insertion
    point</var>. (In other words, restore the <span>insertion point</span> to its previous value.
    This value might be the "undefined" value.)</p>

   </dd>

   <dt>Any other end tag</dt>

   <dd>

    <p>Run these steps:</p>

    <ol>

     <li><p>Initialize <var>node</var> to be the <span>current node</span> (the bottommost
     node of the stack).</p></li>

     <li><p>If <var>node</var>'s tag name, <span>converted to ASCII lowercase</span>, is
     not the same as the tag name of the token, then this is a <span>parse error</span>.</p></li>

     <li><p><i>Loop</i>: If <var>node</var> is the topmost element in the <span>stack of
     open elements</span>, abort these steps. (<span>fragment case</span>)</p></li>

     <li><p>If <var>node</var>'s tag name, <span>converted to ASCII lowercase</span>, is
     the same as the tag name of the token, pop elements from the <span>stack of open
     elements</span> until <var>node</var> has been popped from the stack, and then abort
     these steps.</p></li>

     <li><p>Set <var>node</var> to the previous entry in the <span>stack of open
     elements</span>.</p></li>

     <li><p>If <var>node</var> is not an element in the <span>HTML namespace</span>, return
     to the step labeled <i>loop</i>.</p></li>

     <li><p>Otherwise, process the token according to the rules given in the section corresponding
     to the current <span>insertion mode</span> in HTML content.</li>

    </ol>

   </dd>

  </dl>

  </div>


  <div class="impl">

  <h4 id="the-end">The end</h4>

  <p>Once the user agent <dfn data-x="stop parsing">stops parsing</dfn> the document, the user agent
  must run the following steps:</p>

  <ol>

   <!-- this happens as part of one of the tasks that runs the parser -->

   <li><p>Set the <span>current document readiness</span> to "<code>interactive</code>"
   <!-- this also immediately fires an event --> and the <span>insertion point</span> to
   undefined.</p></li>

   <li><p>Pop <em>all</em> the nodes off the <span>stack of open elements</span>.</p></li>

   <li><p>If the <span>list of scripts that will execute when the document has finished
   parsing</span> is not empty, run these substeps:</p>

    <ol>

     <li><p><span>Spin the event loop</span> until the first <code>script</code> in the <span>list
     of scripts that will execute when the document has finished parsing</span> has its <span>"ready
     to be parser-executed"</span> flag set <em>and</em> the parser's <code>Document</code>
     <span>has no style sheet that is blocking scripts</span>.</p></li>

     <li><p><span data-x="execute the script block">Execute</span> the first <code>script</code> in
     the <span>list of scripts that will execute when the document has finished
     parsing</span>.</p></li>

     <li><p>Remove the first <code>script</code> element from the <span>list of scripts that will
     execute when the document has finished parsing</span> (i.e. shift out the first entry in the
     list).</p></li>

     <li><p>If the <span>list of scripts that will execute when the document has finished
     parsing</span> is still not empty, repeat these substeps again from substep 1.</p>

    </ol>

   </li>

   <li><p><span>Queue a task</span> to <span>fire a simple event</span> that bubbles named <code
   data-x="event-DOMContentLoaded">DOMContentLoaded</code> at the <code>Document</code>.</p></li>

   <li><p><span>Spin the event loop</span> until the <span>set of scripts that will execute as soon
   as possible</span> and the <span>list of scripts that will execute in order as soon as
   possible</span> are empty.</p></li> <!-- this step is not redundant with the next one, since
   <script> nodes delay the load event of the document they are in, but they might change document
   between being added to one document's set/list and executing those scripts, so they might be
   delaying another document but still be in this document's set/list. -->

   <li><p><span>Spin the event loop</span> until there is nothing that <dfn data-x="delay the load
   event">delays the load event</dfn> in the <code>Document</code>.</p></li>

   <li>

    <p><span>Queue a task</span> to run the following substeps:</p>

    <ol>

     <li><p>Set the <span>current document readiness</span> to "<code>complete</code>"<!--
     this also fires an event immediately during the task -->.</p></li>

     <li><p><i>Load event</i>: If the <code>Document</code> is in a <span>browsing context</span>,
     <span>fire a simple event</span> named <code data-x="event-load">load</code> at the
     <code>Document</code>'s <code>Window</code> object, with <i
     data-x="concept-event-target-override">target override</i> set to the <code>Document</code>
     object.</p></li>

    </ol>

   </li>

   <li>

    <p>If the <code>Document</code> is in a <span>browsing context</span>, then <span>queue a
    task</span> to run the following substeps:</p>

    <ol>

     <li><p>If the <code>Document</code>'s <span>page showing</span> flag is true, then abort this
     task (i.e. don't fire the event below).</p></li> <!-- i don't see how this could be, but just
     to be sure... -->

     <li><p>Set the <code>Document</code>'s <span>page showing</span> flag to true.</p></li>

     <li><p><span data-x="concept-event-fire">Fire</span> a <span
     data-x="concept-events-trusted">trusted</span> event with the name <code
     data-x="event-pageshow">pageshow</code> at the <code>Window</code> object of the
     <code>Document</code>, with <i
     data-x="concept-event-target-override">target override</i> set to the <code>Document</code>
     object,
     using the <code>PageTransitionEvent</code> interface, with the <code
     data-x="dom-PageTransitionEvent-persisted">persisted</code> attribute initialized to false. This
     event must not bubble, must not be cancelable, and has no default action.</p></li>

    </ol>

   </li>

   <li><p>If the <code>Document</code> has any <span>pending application cache download process
   tasks</span>, then <span data-x="queue a task">queue</span> each such <span
   data-x="concept-task">task</span> in the order they were added to the list of <span>pending
   application cache download process tasks</span>, and then empty the list of <span>pending
   application cache download process tasks</span>. The <span>task source</span> for these <span
   data-x="concept-task">tasks</span> is the <span>networking task source</span>.</p></li>

   <li><p>If the <code>Document</code>'s <span>print when loaded</span> flag is set, then run the
   <span>printing steps</span>.</p></li>

   <li><p>The <code>Document</code> is now <dfn>ready for post-load tasks</dfn>.</p></li>

   <li><p><span>Queue a task</span> to mark the <code>Document</code> as <dfn>completely
   loaded</dfn>.</p></li>

  </ol>

  <p>When the user agent is to <dfn>abort a parser</dfn>, it must run the following steps:</p>

  <ol>

   <li><p>Throw away any pending content in the <span>input stream</span>, and discard any future
   content that would have been added to it.</p></li>

   <li><p>Set the <span>current document readiness</span> to "<code>interactive</code>"<!--
   this immediately fires an event -->.</p></li>

   <li><p>Pop <em>all</em> the nodes off the <span>stack of open elements</span>.</p></li>

   <li><p>Set the <span>current document readiness</span> to "<code>complete</code>"<!--
   this also immediately fires an event -->.</p></li>

   <!-- anything else? this is things that happen when you call document.open() on a document that's
   still being parsed, or when you navigate a document that's still parsing, or navigate the parent
   of a frame with a document that's still parsing, or the user hits "stop". Should the pending
   scripts be blown away or anything? -->

  </ol>

  <p>Except where otherwise specified, the <span>task source</span> for the <span
  data-x="concept-task">tasks</span> mentioned in this section is the <span>DOM manipulation task
  source</span>.</p>

  </div>


  <div class="impl">

  <h4 id="coercing-an-html-dom-into-an-infoset">Coercing an HTML DOM into an infoset</h4>

  <p>When an application uses an <span>HTML parser</span> in conjunction with an XML pipeline, it is
  possible that the constructed DOM is not compatible with the XML tool chain in certain subtle
  ways. For example, an XML toolchain might not be able to represent attributes with the name <code
 >xmlns</code>, since they conflict with the Namespaces in XML syntax. There is also some
  data that the <span>HTML parser</span> generates that isn't included in the DOM itself. This
  section specifies some rules for handling these issues.</p>

  <p>If the XML API being used doesn't support DOCTYPEs, the tool may drop DOCTYPEs altogether.</p>

  <p>If the XML API doesn't support attributes in no namespace that are named "<code
 >xmlns</code>", attributes whose names start with "<code>xmlns:</code>", or
  attributes in the <span>XMLNS namespace</span>, then the tool may drop such attributes.</p>

  <p>The tool may annotate the output with any namespace declarations required for proper
  operation.</p>

  <p>If the XML API being used restricts the allowable characters in the local names of elements and
  attributes, then the tool may map all element and attribute local names that the API wouldn't
  support to a set of names that <em>are</em> allowed, by replacing any character that isn't
  supported with the uppercase letter U and the six digits of the character's Unicode code point
  when expressed in hexadecimal, using digits 0-9 and capital letters A-F as the symbols, in
  increasing numeric order.</p>

  <p class="example">For example, the element name <code>foo&lt;bar</code>, which can be
  output by the <span>HTML parser</span>, though it is neither a legal HTML element name nor a
  well-formed XML element name, would be converted into <code>fooU00003Cbar</code>, which
  <em>is</em> a well-formed XML element name (though it's still not legal in HTML by any means).</p>

  <p class="example">As another example, consider the attribute <code>xlink:href</code>.
  Used on a MathML element, it becomes, after being <span data-x="adjust foreign
  attributes">adjusted</span>, an attribute with a prefix "<code>xlink</code>" and a local
  name "<code>href</code>". However, used on an HTML element, it becomes an attribute with
  no prefix and the local name "<code>xlink:href</code>", which is not a valid NCName, and
  thus might not be accepted by an XML API. It could thus get converted, becoming "<code
 >xlinkU00003Ahref</code>".</p>

  <p class="note">The resulting names from this conversion conveniently can't clash with any
  attribute generated by the <span>HTML parser</span>, since those are all either lowercase or those
  listed in the <span>adjust foreign attributes</span> algorithm's table.</p>

  <p>If the XML API restricts comments from having two consecutive U+002D HYPHEN-MINUS characters
  (--), the tool may insert a single U+0020 SPACE character between any such offending
  characters.</p>

  <p>If the XML API restricts comments from ending in a U+002D HYPHEN-MINUS character (-), the tool
  may insert a single U+0020 SPACE character at the end of such comments.</p>

  <p>If the XML API restricts allowed characters in character data, attribute values, or comments,
  the tool may replace any U+000C FORM FEED (FF) character with a U+0020 SPACE character, and any
  other literal non-XML character with a U+FFFD REPLACEMENT CHARACTER.</p>

  <p>If the tool has no way to convey out-of-band information, then the tool may drop the following
  information:</p>

  <ul>

   <li>Whether the document is set to <i data-x="no-quirks mode">no-quirks mode</i>, <i data-x="limited-quirks mode">limited-quirks mode</i>, or
   <i data-x="quirks mode">quirks mode</i></li>

   <li>The association between form controls and forms that aren't their nearest <code>form</code>
   element ancestor (use of the <span><code>form</code> element pointer</span> in the parser)</li>

   <li>The <span>template contents</span> of any <code>template</code> elements.</li>

  </ul>

  <p class="note">The mutations allowed by this section apply <em>after</em> the <span>HTML
  parser</span>'s rules have been applied. For example, a <code>&lt;a::></code> start tag
  will be closed by a <code>&lt;/a::></code> end tag, and never by a <code
 >&lt;/aU00003AU00003A></code> end tag, even if the user agent is using the rules above to
  then generate an actual element in the DOM with the name <code>aU00003AU00003A</code> for
  that start tag.</p>

  </div>


  <div class="impl">

  <h4 id="an-introduction-to-error-handling-and-strange-cases-in-the-parser">An introduction to error handling and strange cases in the parser</h4>

  <p><em>This section is non-normative.</em></p>

  <p>This section examines some erroneous markup and discusses how the <span>HTML parser</span>
  handles these cases.</p>


  <h5 id="misnested-tags">Misnested tags: &lt;b>&lt;i>&lt;/b>&lt;/i></h5>

  <p><em>This section is non-normative.</em></p>

  <p>The most-often discussed example of erroneous markup is as follows:</p>

  <pre>&lt;p>1&lt;b>2&lt;i>3&lt;/b>4&lt;/i>5&lt;/p></pre>

  <p>The parsing of this markup is straightforward up to the "3". At this point, the DOM looks like
  this:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>p</code><ul><li class="t3"><code>#text</code>: <span>1</span></li><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>2</span></li><li class="t1"><code>i</code><ul><li class="t3"><code>#text</code>: <span>3</span></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul>

  <p>Here, the <span>stack of open elements</span> has five elements on it: <code>html</code>,
  <code>body</code>, <code>p</code>, <code>b</code>, and <code>i</code>. The <span>list of active
  formatting elements</span> just has two: <code>b</code> and <code>i</code>. The <span>insertion
  mode</span> is "<span data-x="insertion mode: in body">in body</span>".</p>

  <p>Upon receiving the end tag token with the tag name "b", the "<a href="#adoptionAgency">adoption
  agency algorithm</a>" is invoked. This is a simple case, in that the <var>formatting
  element</var> is the <code>b</code> element, and there is no <var>furthest block</var>.
  Thus, the <span>stack of open elements</span> ends up with just three elements: <code>html</code>,
  <code>body</code>, and <code>p</code>, while the <span>list of active formatting elements</span>
  has just one: <code>i</code>. The DOM tree is unmodified at this point.</p>

  <p>The next token is a character ("4"), triggers the <span data-x="reconstruct the active
  formatting elements">reconstruction of the active formatting elements</span>, in this case just
  the <code>i</code> element. A new <code>i</code> element is thus created for the "4"
  <code>Text</code> node. After the end tag token for the "i" is also received, and the "5"
  <code>Text</code> node is inserted, the DOM looks as follows:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>p</code><ul><li class="t3"><code>#text</code>: <span>1</span></li><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>2</span></li><li class="t1"><code>i</code><ul><li class="t3"><code>#text</code>: <span>3</span></li></ul></li></ul></li><li class="t1"><code>i</code><ul><li class="t3"><code>#text</code>: <span>4</span></li></ul></li><li class="t3"><code>#text</code>: <span>5</span></li></ul></li></ul></li></ul></li></ul>


  <h5 id="misnested-tags:-&lt;b>&lt;p>&lt;/b>&lt;/p>">Misnested tags: &lt;b>&lt;p>&lt;/b>&lt;/p></h5>

  <p><em>This section is non-normative.</em></p>

  <p>A case similar to the previous one is the following:</p>

  <pre>&lt;b>1&lt;p>2&lt;/b>3&lt;/p></pre>

  <p>Up to the "2" the parsing here is straightforward:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>1</span></li><li class="t1"><code>p</code><ul><li class="t3"><code>#text</code>: <span>2</span></li></ul></li></ul></li></ul></li></ul></li></ul>

  <p>The interesting part is when the end tag token with the tag name "b" is parsed.</p>

  <p>Before that token is seen, the <span>stack of open elements</span> has four elements on it:
  <code>html</code>, <code>body</code>, <code>b</code>, and <code>p</code>. The <span>list of active
  formatting elements</span> just has the one: <code>b</code>. The <span>insertion mode</span> is
  "<span data-x="insertion mode: in body">in body</span>".</p>

  <p>Upon receiving the end tag token with the tag name "b", the "<a href="#adoptionAgency">adoption
  agency algorithm</a>" is invoked, as in the previous example. However, in this case, there
  <em>is</em> a <var>furthest block</var>, namely the <code>p</code> element. Thus, this
  time the adoption agency algorithm isn't skipped over.</p>

  <p>The <var>common ancestor</var> is the <code>body</code> element. A conceptual
  "bookmark" marks the position of the <code>b</code> in the <span>list of active formatting
  elements</span>, but since that list has only one element in it, the bookmark won't have much
  effect.</p>

  <p>As the algorithm progresses, <var>node</var> ends up set to the formatting element
  (<code>b</code>), and <var>last node</var> ends up set to the <var>furthest
  block</var> (<code>p</code>).</p>

  <p>The <var>last node</var> gets appended (moved) to the <var>common
  ancestor</var>, so that the DOM looks like:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>1</span></li></ul></li><li class="t1"><code>p</code><ul><li class="t3"><code>#text</code>: <span>2</span></li></ul></li></ul></li></ul></li></ul>

  <p>A new <code>b</code> element is created, and the children of the <code>p</code> element are
  moved to it:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>1</span></li></ul></li><li class="t1"><code>p</code></li></ul></li></ul></li></ul>
  <ul class="domTree"><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>2</span></li></ul></li></ul>

  <p>Finally, the new <code>b</code> element is appended to the <code>p</code> element, so that the
  DOM looks like:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>1</span></li></ul></li><li class="t1"><code>p</code><ul><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>2</span></li></ul></li></ul></li></ul></li></ul></li></ul>

  <p>The <code>b</code> element is removed from the <span>list of active formatting elements</span>
  and the <span>stack of open elements</span>, so that when the "3" is parsed, it is appended to the
  <code>p</code> element:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>1</span></li></ul></li><li class="t1"><code>p</code><ul><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>2</span></li></ul></li><li class="t3"><code>#text</code>: <span>3</span></li></ul></li></ul></li></ul></li></ul>


  <h5 id="unexpected-markup-in-tables">Unexpected markup in tables</h5>

  <p><em>This section is non-normative.</em></p>

  <p>Error handling in tables is, for historical reasons, especially strange. For example, consider
  the following markup:</p>

  <pre>&lt;table><strong>&lt;b></strong>&lt;tr>&lt;td>aaa&lt;/td>&lt;/tr><strong>bbb</strong>&lt;/table>ccc</pre>

  <p>The highlighted <code>b</code> element start tag is not allowed directly inside a table like
  that, and the parser handles this case by placing the element <em>before</em> the table. (This is
  called <i data-x="foster parent">foster parenting</i>.) This can be seen by examining the DOM tree
  as it stands just after the <code>table</code> element's start tag has been seen:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>table</code></li></ul></li></ul></li></ul>

  <p>...and then immediately after the <code>b</code> element start tag has been seen:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>b</code></li><li class="t1"><code>table</code></li></ul></li></ul></li></ul>

  <p>At this point, the <span>stack of open elements</span> has on it the elements
  <code>html</code>, <code>body</code>, <code>table</code>, and <code>b</code> (in that order,
  despite the resulting DOM tree); the <span>list of active formatting elements</span> just has the
  <code>b</code> element in it; and the <span>insertion mode</span> is "<span data-x="insertion mode:
  in table">in table</span>".</p>

  <p>The <code>tr</code> start tag causes the <code>b</code> element to be popped off the stack and
  a <code>tbody</code> start tag to be implied; the <code>tbody</code> and <code>tr</code> elements
  are then handled in a rather straight-forward manner, taking the parser through the "<span
  data-x="insertion mode: in table body">in table body</span>" and "<span data-x="insertion mode: in
  row">in row</span>" insertion modes, after which the DOM looks as follows:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>b</code></li><li class="t1"><code>table</code><ul><li class="t1"><code>tbody</code><ul><li class="t1"><code>tr</code></li></ul></li></ul></li></ul></li></ul></li></ul>

  <p>Here, the <span>stack of open elements</span> has on it the elements <code>html</code>,
  <code>body</code>, <code>table</code>, <code>tbody</code>, and <code>tr</code>; the <span>list of
  active formatting elements</span> still has the <code>b</code> element in it; and the
  <span>insertion mode</span> is "<span data-x="insertion mode: in row">in row</span>".</p>

  <p>The <code>td</code> element start tag token, after putting a <code>td</code> element on the
  tree, puts a <span data-x="concept-parser-marker">marker</span> on the <span>list of active
  formatting elements</span> (it also switches to the "<span data-x="insertion mode: in cell">in
  cell</span>" <span>insertion mode</span>).</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>b</code></li><li class="t1"><code>table</code><ul><li class="t1"><code>tbody</code><ul><li class="t1"><code>tr</code><ul><li class="t1"><code>td</code></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul>

  <p>The <span data-x="concept-parser-marker">marker</span> means that when the "aaa" character
  tokens are seen, no <code>b</code> element is created to hold the resulting <code>Text</code>
  node:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>b</code></li><li class="t1"><code>table</code><ul><li class="t1"><code>tbody</code><ul><li class="t1"><code>tr</code><ul><li class="t1"><code>td</code><ul><li class="t3"><code>#text</code>: <span>aaa</span></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul>

  <p>The end tags are handled in a straight-forward manner; after handling them, the <span>stack of
  open elements</span> has on it the elements <code>html</code>, <code>body</code>,
  <code>table</code>, and <code>tbody</code>; the <span>list of active formatting elements</span>
  still has the <code>b</code> element in it (the <span data-x="concept-parser-marker">marker</span>
  having been removed by the "td" end tag token); and the <span>insertion mode</span> is "<span
  data-x="insertion mode: in table body">in table body</span>".</p>

  <p>Thus it is that the "bbb" character tokens are found. These trigger the "<span data-x="insertion
  mode: in table text">in table text</span>" insertion mode to be used (with the <span>original
  insertion mode</span> set to "<span data-x="insertion mode: in table body">in table body</span>").
  The character tokens are collected, and when the next token (the <code>table</code> element end
  tag) is seen, they are processed as a group. Since they are not all spaces, they are handled as
  per the "anything else" rules in the "<span data-x="insertion mode: in table">in table</span>"
  insertion mode, which defer to the "<span data-x="insertion mode: in body">in body</span>"
  insertion mode but with <span data-x="foster parent">foster parenting</span>.</p>

  <p>When <span data-x="reconstruct the active formatting elements">the active formatting elements
  are reconstructed</span>, a <code>b</code> element is created and <span data-x="foster
  parent">foster parented</span>, and then the "bbb" <code>Text</code> node is appended to it:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>b</code></li><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>bbb</span></li></ul></li><li class="t1"><code>table</code><ul><li class="t1"><code>tbody</code><ul><li class="t1"><code>tr</code><ul><li class="t1"><code>td</code><ul><li class="t3"><code>#text</code>: <span>aaa</span></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul>

  <p>The <span>stack of open elements</span> has on it the elements <code>html</code>,
  <code>body</code>, <code>table</code>, <code>tbody</code>, and the new <code>b</code> (again, note
  that this doesn't match the resulting tree!); the <span>list of active formatting elements</span>
  has the new <code>b</code> element in it; and the <span>insertion mode</span> is still "<span
  data-x="insertion mode: in table body">in table body</span>".</p>

  <p>Had the character tokens been only <span data-x="space character">space characters</span>
  instead of "bbb", then those <span data-x="space character">space characters</span> would just be
  appended to the <code>tbody</code> element.</p>

  <p>Finally, the <code>table</code> is closed by a "table" end tag. This pops all the nodes from
  the <span>stack of open elements</span> up to and including the <code>table</code> element, but it
  doesn't affect the <span>list of active formatting elements</span>, so the "ccc" character tokens
  after the table result in yet another <code>b</code> element being created, this time after the
  table:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>b</code></li><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>bbb</span></li></ul></li><li class="t1"><code>table</code><ul><li class="t1"><code>tbody</code><ul><li class="t1"><code>tr</code><ul><li class="t1"><code>td</code><ul><li class="t3"><code>#text</code>: <span>aaa</span></li></ul></li></ul></li></ul></li></ul></li><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>ccc</span></li></ul></li></ul></li></ul></li></ul>


  <h5 id="scripts-that-modify-the-page-as-it-is-being-parsed">Scripts that modify the page as it is being parsed</h5>

  <p><em>This section is non-normative.</em></p>

  <p>Consider the following markup, which for this example we will assume is the document with
  <span>URL</span> <code>http://example.com/inner</code>, being rendered as the content of
  an <code>iframe</code> in another document with the <span>URL</span> <code
 >http://example.com/outer</code>:</p>

  <pre>&lt;div id=a>
 &lt;script>
  var div = document.getElementById('a');
  parent.document.body.appendChild(div);
 &lt;/script>
 &lt;script>
  alert(document.URL);
 &lt;/script>
&lt;/div>
&lt;script>
 alert(document.URL);
&lt;/script></pre>

  <p>Up to the first "script" end tag, before the script is parsed, the result is relatively
  straightforward:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>div</code> <span class="t2"><code class="attribute name" data-x="attr-id">id</code>="<code class="attribute value">a</code>"</span><ul><li class="t3"><code>#text</code>: <span>
 </span></li><li class="t1"><code>script</code><ul><li class="t3"><code>#text</code>: <span>var div = document.getElementById('a'); &#x23CE; parent.document.body.appendChild(div);</span></li></ul></li></ul></li></ul></li></ul></li></ul>

  <p>After the script is parsed, though, the <code>div</code> element and its child
  <code>script</code> element are gone:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code></li></ul></li></ul>

  <p>They are, at this point, in the <code>Document</code> of the aforementioned outer
  <span>browsing context</span>. However, the <span>stack of open elements</span> <em>still contains
  the <code>div</code> element</em>.</p>

  <p>Thus, when the second <code>script</code> element is parsed, it is inserted <em>into the outer
  <code>Document</code> object</em>.</p>

  <p>Those parsed into different <code>Document</code>s than the one the parser was created for do
  not execute, so the first alert does not show.</p>

  <p>Once the <code>div</code> element's end tag is parsed, the <code>div</code> element is popped
  off the stack, and so the next <code>script</code> element is in the inner
  <code>Document</code>:</p>

  <ul class="domTree"><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>script</code><ul><li class="t3"><code>#text</code>: <span>alert(document.URL);</span></li></ul></li></ul></li></ul></li></ul>

  <p>This script does execute, resulting in an alert that says "http://example.com/inner".</p>


  <h5 id="the-execution-of-scripts-that-are-moving-across-multiple-documents">The execution of scripts that are moving across multiple documents</h5>

  <p><em>This section is non-normative.</em></p>

  <p>Elaborating on the example in the previous section, consider the case where the second
  <code>script</code> element is an external script (i.e. one with a <code
  data-x="attr-script-src">src</code> attribute). Since the element was not in the parser's
  <code>Document</code> when it was created, that external script is not even downloaded.</p>

  <p>In a case where a <code>script</code> element with a <code data-x="attr-script-src">src</code>
  attribute is parsed normally into its parser's <code>Document</code>, but while the external
  script is being downloaded, the element is moved to another document, the script continues to
  download, but does not execute.</p>

  <p class="note">In general, moving <code>script</code> elements between <code>Document</code>s is
  considered a bad practice.</p>



  <h5 id="unclosed-formatting-elements">Unclosed formatting elements</h5>

  <p><em>This section is non-normative.</em></p>

  <p>The following markup shows how nested formatting elements (such as <code>b</code>) get
  collected and continue to be applied even as the elements they are contained in are closed, but
  that excessive duplicates are thrown away.</p>

  <pre>&lt;!DOCTYPE html>
&lt;p>&lt;b class=x>&lt;b class=x>&lt;b>&lt;b class=x>&lt;b class=x>&lt;b>X
&lt;p>X
&lt;p>&lt;b>&lt;b class=x>&lt;b>X
&lt;p>&lt;/b>&lt;/b>&lt;/b>&lt;/b>&lt;/b>&lt;/b>X</pre>

  <p>The resulting DOM tree is as follows:</p>

  <ul class="domTree"><li class="t10">DOCTYPE: <code>html</code></li><li class="t1"><code>html</code><ul><li class="t1"><code>head</code></li><li class="t1"><code>body</code><ul><li class="t1"><code>p</code><ul><li class="t1"><code>b</code> <span class="t2"><code class="attribute name" data-x="attr-class">class</code>="<code class="attribute value">x</code>"</span><ul><li class="t1"><code>b</code> <span class="t2"><code class="attribute name" data-x="attr-class">class</code>="<code class="attribute value">x</code>"</span><ul><li class="t1"><code>b</code><ul><li class="t1"><code>b</code> <span class="t2"><code class="attribute name" data-x="attr-class">class</code>="<code class="attribute value">x</code>"</span><ul><li class="t1"><code>b</code> <span class="t2"><code class="attribute name" data-x="attr-class">class</code>="<code class="attribute value">x</code>"</span><ul><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>X&#X23CE;</span></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li><li class="t1"><code>p</code><ul><li class="t1"><code>b</code> <span class="t2"><code class="attribute name" data-x="attr-class">class</code>="<code class="attribute value">x</code>"</span><ul><li class="t1"><code>b</code><ul><li class="t1"><code>b</code> <span class="t2"><code class="attribute name" data-x="attr-class">class</code>="<code class="attribute value">x</code>"</span><ul><li class="t1"><code>b</code> <span class="t2"><code class="attribute name" data-x="attr-class">class</code>="<code class="attribute value">x</code>"</span><ul><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>X&#X23CE;</span></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li><li class="t1"><code>p</code><ul><li class="t1"><code>b</code> <span class="t2"><code class="attribute name" data-x="attr-class">class</code>="<code class="attribute value">x</code>"</span><ul><li class="t1"><code>b</code><ul><li class="t1"><code>b</code> <span class="t2"><code class="attribute name" data-x="attr-class">class</code>="<code class="attribute value">x</code>"</span><ul><li class="t1"><code>b</code> <span class="t2"><code class="attribute name" data-x="attr-class">class</code>="<code class="attribute value">x</code>"</span><ul><li class="t1"><code>b</code><ul><li class="t1"><code>b</code><ul><li class="t1"><code>b</code> <span class="t2"><code class="attribute name" data-x="attr-class">class</code>="<code class="attribute value">x</code>"</span><ul><li class="t1"><code>b</code><ul><li class="t3"><code>#text</code>: <span>X&#X23CE;</span></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li><li class="t1"><code>p</code><ul><li class="t3"><code>#text</code>: <span>X&#X23CE;</span></li></ul></li></ul></li></ul></li></ul>

  <p>Note how the second <code>p</code> element in the markup has no explicit <code>b</code>
  elements, but in the resulting DOM, up to three of each kind of formatting element (in this case
  three <code>b</code> elements with the class attribute, and two unadorned <code>b</code> elements)
  get reconstructed before the element's "X".</p>

<!--CLEANUP-->
  <p>Also note how this means that in the final paragraph only six <code>b</code> end tags are
  needed to completely clear the <span>list of active formatting elements</span>, even though nine <code>b</code> start
  tags have been seen up to this point.</p>


<!--/HTMLPARSER-->


  <h3 id="serializing-html-fragments">Serializing HTML fragments</h3>

  <p>The following steps form the <dfn>HTML fragment serialization algorithm</dfn>. The algorithm
  takes as input a DOM <code>Element</code>, <code>Document</code>, or <code>DocumentFragment</code>
  referred to as <var>the node</var>, and either returns a string or throws an
  exception.</p>

  <p class="note">This algorithm serializes the <em>children</em> of the node being serialized, not
  the node itself.</p>

  <ol>

   <li><p>Let <var>s</var> be a string, and initialize it to the empty string.</p></li>

   <li><p>If <var>the node</var> is a <code>template</code> element, then let <var>the node</var> instead be the <code>template</code> element's <span>template
   contents</span> (a <code>DocumentFragment</code> node).</p></li>

   <li>

    <p>For each child node of <var>the node</var>, in <span>tree order</span>, run the
    following steps:

    <ol>

     <li><p>Let <var>current node</var> be the child node being processed.</p></li>

     <li>

      <p>Append the appropriate string from the following list to <var>s</var>:</p>

      <dl class="switch">

       <dt>If <var>current node</var> is an <code>Element</code></dt>

       <dd>

        <p>If <var>current node</var> is an element in the <span>HTML namespace</span>, the
        <span>MathML namespace</span>, or the <span>SVG namespace</span>, then let <var>tagname</var> be <var>current node</var>'s local name. Otherwise, let <var>tagname</var> be <var>current node</var>'s qualified name.</p>

        <p>Append a U+003C LESS-THAN SIGN character (&lt;), followed by <var>tagname</var>.</p>

        <p class="note">For <span>HTML elements</span> created by the <span>HTML parser</span> or
        <code>Document.createElement()</code>, <var>tagname</var> will be
        lowercase.</p>

        <p>For each attribute that the element has, append a U+0020 SPACE character, the <span
        data-x="attribute's serialized name">attribute's serialized name as described below</span>, a
        U+003D EQUALS SIGN character (=), a U+0022 QUOTATION MARK character (&quot;), the
        attribute's value, <span data-x="escaping a string">escaped as described below</span> in
        <i>attribute mode</i>, and a second U+0022 QUOTATION MARK character (&quot;).</p>

        <p>An <dfn>attribute's serialized name</dfn> for the purposes of the previous paragraph must
        be determined as follows:</p>

        <dl class="switch">

         <dt>If the attribute has no namespace</dt>

         <dd>

          <p>The attribute's serialized name is the attribute's local name.</p>

          <p class="note">For attributes on <span>HTML elements</span> set by the <span>HTML
          parser</span> or by <code>Element.setAttribute()</code>, the local name will be
          lowercase.</p>

         </dd>


         <dt>If the attribute is in the <span>XML namespace</span></dt>

         <dd><p>The attribute's serialized name is the string "<code>xml:</code>" followed
         by the attribute's local name.</p></dd>


         <dt>If the attribute is in the <span>XMLNS namespace</span> and the attribute's local name
         is <code>xmlns</code></dt>

         <dd><p>The attribute's serialized name is the string "<code
        >xmlns</code>".</p></dd>


         <dt>If the attribute is in the <span>XMLNS namespace</span> and the attribute's local name
         is not <code>xmlns</code></dt>

         <dd><p>The attribute's serialized name is the string "<code>xmlns:</code>"
         followed by the attribute's local name.</p></dd>


         <dt>If the attribute is in the <span>XLink namespace</span></dt>

         <dd><p>The attribute's serialized name is the string "<code>xlink:</code>"
         followed by the attribute's local name.</p></dd>


         <dt>If the attribute is in some other namespace</dt>

         <dd><p>The attribute's serialized name is the attribute's qualified name.</p></dd>

        </dl>

        <p>While the exact order of attributes is UA-defined, and may depend on factors such as the
        order that the attributes were given in the original markup, the sort order must be stable,
        such that consecutive invocations of this algorithm serialize an element's attributes in the
        same order.</p>

        <p>Append a U+003E GREATER-THAN SIGN character (&gt;).</p>

        <p>If <var>current node</var> is an <code>area</code>, <code>base</code>,
        <code>basefont</code>, <code>bgsound</code>, <code>br</code>, <code>col</code>,
        <code>embed</code>, <code>frame</code>, <code>hr</code>, <code>img</code>,
        <code>input</code>, <code>keygen</code>, <code>link</code>, <code>menuitem</code>,
        <code>meta</code>, <code>param</code>, <code>source</code>, <code>track</code> or
        <code>wbr</code> element, then continue on to the next child node at this point.</p>
        <!-- VOIDLIST superset -->
        <!-- also, i guess: image and isindex, but we don't list those because we don't consider
        those "elements", more "macros", and thus we should never serialize them -->

        <p>If <var>current node</var> is a <code>pre</code>, <code>textarea</code>, or
        <code>listing</code> element, and the first child node of the element, if any, is a
        <code>Text</code> node whose character data has as its first character a U+000A LINE FEED
        (LF) character, then append a U+000A LINE FEED (LF) character.</p>

        <p>Append the value of running the <span>HTML fragment serialization algorithm</span> on the
        <var>current node</var> element (thus recursing into this algorithm for that
        element), followed by a U+003C LESS-THAN SIGN character (&lt;), a U+002F SOLIDUS character
        (/), <var>tagname</var> again, and finally a U+003E GREATER-THAN SIGN character
        (&gt;).</p>

       </dd>


       <dt>If <var>current node</var> is a <code>Text</code> node</dt>

       <dd>

        <p>If the parent of <var>current node</var> is a <code>style</code>,
        <code>script</code>, <code>xmp</code>, <code>iframe</code>, <code>noembed</code>,
        <code>noframes</code>, or <code>plaintext</code> element, or if the parent of <var>current node</var> is a <code>noscript</code> element and <span
        data-x="concept-n-script">scripting is enabled</span> for the node, then append the value of
        <var>current node</var>'s <code>data</code> IDL attribute literally.</p>

        <p>Otherwise, append the value of <var>current node</var>'s <code
       >data</code> IDL attribute, <span data-x="escaping a string">escaped as described
        below</span>.</p>

       </dd>


       <dt>If <var>current node</var> is a <code>Comment</code></dt>

       <dd>

        <p>Append the literal string "<code>&lt;!--</code>" (U+003C LESS-THAN SIGN, U+0021
        EXCLAMATION MARK, U+002D HYPHEN-MINUS, U+002D HYPHEN-MINUS), followed by the value of <var>current node</var>'s <code>data</code> IDL attribute, followed by the
        literal string "<code>--&gt;</code>" (U+002D HYPHEN-MINUS, U+002D HYPHEN-MINUS,
        U+003E GREATER-THAN SIGN).</p>

       </dd>


       <dt>If <var>current node</var> is a <code>ProcessingInstruction</code></dt>

       <dd>

        <p>Append the literal string "<code>&lt;?</code>" (U+003C LESS-THAN SIGN, U+003F
        QUESTION MARK), followed by the value of <var>current node</var>'s <code
       >target</code> IDL attribute, followed by a single U+0020 SPACE character, followed
        by the value of <var>current node</var>'s <code>data</code> IDL
        attribute, followed by a single U+003E GREATER-THAN SIGN character (>).</p>

       </dd>


       <dt>If <var>current node</var> is a <code>DocumentType</code></dt>

       <dd>

        <p>Append the literal string "<code>&lt;!DOCTYPE</code>" (U+003C LESS-THAN SIGN, U+0021
        EXCLAMATION MARK, U+0044 LATIN CAPITAL LETTER D, U+004F LATIN CAPITAL LETTER O, U+0043 LATIN
        CAPITAL LETTER C, U+0054 LATIN CAPITAL LETTER T, U+0059 LATIN CAPITAL LETTER Y, U+0050 LATIN
        CAPITAL LETTER P, U+0045 LATIN CAPITAL LETTER E), followed by a space (U+0020 SPACE),
        followed by the value of <var>current node</var>'s <code>name</code> IDL
        attribute, followed by the literal string "<code>&gt;</code>" (U+003E GREATER-THAN SIGN).</p>

       </dd>


      </dl>

      <!--
      <p>Other node types (e.g. <code>Attr</code>) cannot occur as children of elements.
      If, despite this, they somehow do occur, this algorithm must throw an
      <code>InvalidStateError</code> exception.</p>
      -->

     </li>

    </ol>

   </li>

   <li><p>The result of the algorithm is the string <var>s</var>.</p></li>

  </ol>

  <p class="warning">It is possible that the output of this algorithm, if parsed with an <span>HTML
  parser</span>, will not return the original tree structure.</p>

  <div class="example">

   <p>For instance, if a <code>textarea</code> element to which a <code>Comment</code> node
   has been appended is serialized and the output is then reparsed, the comment will end up being
   displayed in the text field. Similarly, if, as a result of DOM manipulation, an element contains
   a comment that contains the literal string "<code>--&gt;</code>", then when the result
   of serializing the element is parsed, the comment will be truncated at that point and the rest of
   the comment will be interpreted as markup. More examples would be making a <code>script</code>
   element contain a <code>Text</code> node with the text string "<code>&lt;/script></code>", or
   having a <code>p</code> element that contains a <code>ul</code> element (as the <code>ul</code>
   element's <span data-x="syntax-start-tag">start tag</span> would imply the end tag for the
   <code>p</code>).</p>

   <p>This can enable cross-site scripting attacks. An example of this would be a page that lets the
   user enter some font family names that are then inserted into a CSS <code>style</code> block via
   the DOM and which then uses the <code data-x="dom-innerHTML">innerHTML</code> IDL attribute to get
   the HTML serialization of that <code>style</code> element: if the user enters
   "<code>&lt;/style>&lt;script>attack&lt;/script></code>" as a font family name, <code
   data-x="dom-innerHTML">innerHTML</code> will return markup that, if parsed in a different context,
   would contain a <code>script</code> node, even though no <code>script</code> node existed in the
   original DOM.</p>

  </div>

  <p><dfn id="escapingString">Escaping a string</dfn> (for the purposes of the algorithm above)
  consists of running the following steps:</p>

  <ol>

   <li><p>Replace any occurrence of the "<code>&amp;</code>" character by the string "<code
  >&amp;amp;</code>".</p></li>

   <li><p>Replace any occurrences of the U+00A0 NO-BREAK SPACE character by the string "<code
  >&amp;nbsp;</code>".</p></li>

   <li><p>If the algorithm was invoked in the <i>attribute mode</i>, replace any occurrences of the
   "<code>&quot;</code>" character by the string "<code
  >&amp;quot;</code>".</p></li>

   <li><p>If the algorithm was <em>not</em> invoked in the <i>attribute mode</i>, replace any
   occurrences of the "<code>&lt;</code>" character by the string "<code
  >&amp;lt;</code>", and any occurrences of the "<code>&gt;</code>" character by
   the string "<code>&amp;gt;</code>".</p></li>

  </ol>


  <h3 id="parsing-html-fragments">Parsing HTML fragments</h3>

  <p>The following steps form the <dfn>HTML fragment parsing algorithm</dfn>. The algorithm
  takes as input an <code>Element</code> node, referred to as the <dfn
  data-x="concept-frag-parse-context"><var>context</var></dfn> element, which gives the context for
  the parser, as well as <var>input</var>, a string to parse, and returns a list of zero or
  more nodes.</p>

  <p class="note">Parts marked <dfn>fragment case</dfn> in algorithms in the parser section are
  parts that only occur if the parser was created for the purposes of this algorithm. The algorithms have been annotated
  with such markings for informational purposes only; such markings have no normative weight. If it
  is possible for a condition described as a <span>fragment case</span> to occur even when the
  parser wasn't created for the purposes of handling this algorithm, then that is an error in the
  specification.</p>

  <ol>

   <li>

    <p>Create a new <code>Document</code> node, and mark it as being an <span data-x="HTML
    documents">HTML document</span>.</p>

   </li>

   <li>

    <p>If the
    <span>node document</span> of the <var data-x="concept-frag-parse-context">context</var> element is in
    <span>quirks mode</span>, then let the <code>Document</code> be in <span>quirks mode</span>.
    Otherwise, the
    <span>node document</span> of the <var data-x="concept-frag-parse-context">context</var> element is in
    <span>limited-quirks mode</span>, then let the <code>Document</code> be in <span>limited-quirks
    mode</span>. Otherwise, leave the <code>Document</code> in <span>no-quirks mode</span>.</p>

   </li>

   <li>

    <p>Create a new <span>HTML parser</span>, and associate it with the just created
    <code>Document</code> node.</p>

   </li>

   <li>

    <p>Set the state of the <span>HTML parser</span>'s <span>tokenization</span> stage as
    follows:</p>

    <dl class="switch">

     <dt>If it is a <code>title</code> or <code>textarea</code> element</dt>

     <dd>Switch the tokenizer to the <span>RCDATA state</span>.</dd>


     <dt>If it is a <code>style</code>, <code>xmp</code>, <code>iframe</code>,
     <code>noembed</code>, or <code>noframes</code> element</dt>

     <dd>Switch the tokenizer to the <span>RAWTEXT state</span>.</dd>


     <dt>If it is a <code>script</code> element</dt>

     <dd>Switch the tokenizer to the <span>script data state</span>.</dd>


     <dt>If it is a <code>noscript</code> element</dt>

     <dd>If the <span>scripting flag</span> is enabled, switch the tokenizer to the <span>RAWTEXT
     state</span>. Otherwise, leave the tokenizer in the <span>data state</span>.</dd>


     <dt>If it is a <code>plaintext</code> element</dt>

     <dd>Switch the tokenizer to the <span>PLAINTEXT state</span>.</dd>


     <dt>Otherwise</dt>

     <dd>Leave the tokenizer in the <span>data state</span>.</dd>

    </dl>

    <p class="note">For performance reasons, an implementation that does not report errors and
    that uses the actual state machine described in this specification directly could use the
    PLAINTEXT state instead of the RAWTEXT and script data states where those are mentioned in the
    list above. Except for rules regarding parse errors, they are equivalent, since there is no
    <span>appropriate end tag token</span> in the fragment case, yet they involve far fewer state
    transitions.</p>

   </li>

   <li>

    <p>Let <var>root</var> be a new <code>html</code> element with no attributes.</p>

   </li>

   <li>

    <p>Append the element <var>root</var> to the <code>Document</code> node created
    above.</p>

   </li>

   <li>

    <p>Set up the parser's <span>stack of open elements</span> so that it contains just the single
    element <var>root</var>.</p>

   </li>

   <li>

    <p>If the <var data-x="concept-frag-parse-context">context</var> element is a
    <code>template</code> element, push "<span data-x="insertion mode: in template">in
    template</span>" onto the <span>stack of template insertion modes</span> so that it is the new
    <span>current template insertion mode</span>.</p>

   </li>

   <li>

    <p>Create a start tag token whose name is the local name of <var
    data-x="concept-frag-parse-context">context</var> and whose attributes are the attributes of
    <var data-x="concept-frag-parse-context">context</var>.</p>

    <p>Let this start tag token be the start tag token of the <var
    data-x="concept-frag-parse-context">context</var> node, e.g. for the purposes of determining
    if it is an <span>HTML integration point</span>.</p>

   </li>

   <li>

    <p><span data-x="reset the insertion mode appropriately">Reset the parser's insertion mode
    appropriately</span>.</p>

    <p class="note">The parser will reference the <var
    data-x="concept-frag-parse-context">context</var> element as part of that algorithm.</p>

   </li>

   <li>

    <p>Set the parser's <span><code>form</code> element pointer</span> to the nearest node to the
    <var data-x="concept-frag-parse-context">context</var> element that is a <code>form</code>
    element (going straight up the ancestor chain, and including the element itself, if it is a
    <code>form</code> element), if any. (If there is no such <code>form</code> element, the
    <span><code>form</code> element pointer</span> keeps its initial value, null.)</p>

   </li>

   <li>

    <p>Place the <var>input</var> into the <span>input stream</span> for the <span>HTML
    parser</span> just created. The encoding <span
    data-x="concept-encoding-confidence">confidence</span> is <i>irrelevant</i>.</p>

   </li>

   <li>

    <p>Start the parser and let it run until it has consumed all the characters just inserted into
    the input stream.</p>

   </li>

   <li>

    <p>Return the child
    nodes of <var>root</var>, in <span>tree order</span>.</p>

   </li>

  </ol>

  </div>



  <h3 id="named-character-references"><dfn>Named character references</dfn></h3>

  <p>This table lists the character reference names that are supported by HTML, and the code points
  to which they refer. It is referenced by the previous sections.</p>

  <div id="named-character-references-table">
   <table>
    <thead>
     <tr> <th> Name </th> <th> Character(s) </th> <th> Glyph </th> </tr>
    </thead>
<!--BOILERPLATE entities.inc-->
   </table>
  <!--
   If we want to add character references, Almorca suggests:
   > I would add &sub1; (character U+2081), &sub2; (character U+2082) and &sub3; (character U+2083).
   > They would are the equivalent to &sup1;, &sup2;, and &sup3;.
   See also: http://www.w3.org/2003/entities/
  -->
  </div>

  <p>This data is also available <a href="entities.json">as a JSON file</a>.</p>

  <p><i>The glyphs displayed above are non-normative. Refer to the Unicode specifications for formal
  definitions of the characters listed above.</i></p>


  <h2 id="xhtml">The XHTML syntax</h2>

  <p class="note">This section only describes the rules for XML resources. Rules for
  <code>text/html</code> resources are discussed in the section above entitled "<span>The HTML
  syntax</span>".</p>


  <div class="impl">

  <h3 id="writing-xhtml-documents">Writing XHTML documents</h3>

  </div>

  <p>The syntax for using HTML with XML, whether in XHTML documents or embedded in other XML
  documents, is defined in the XML and Namespaces in XML specifications. <a
  href="#refsXML">\[XML]</a> <a href="#refsXMLNS">\[XMLNS]</a></p>

  <p>This specification does not define any syntax-level requirements beyond those defined for XML
  proper.</p>

  <p>XML documents may contain a <code>DOCTYPE</code> if desired, but this is not required
  to conform to this specification. This specification does not define a public or system
  identifier, nor provide a formal DTD.</p>

  <p class="note">According to the XML specification, XML processors are not guaranteed to process
  the external DTD subset referenced in the DOCTYPE. This means, for example, that using <a
  href="http://www.w3.org/TR/xml/#dt-entref">entity references</a> for characters in XHTML documents
  is unsafe if they are defined in an external file (except for <code>&amp;lt;</code>,
  <code>&amp;gt;</code>, <code>&amp;amp;</code>, <code>&amp;quot;</code>
  and <code>&amp;apos;</code>).</p>


  <div class="impl">

  <h3 id="parsing-xhtml-documents">Parsing XHTML documents</h3>

  <p>This section describes the relationship between XML and the DOM, with a particular emphasis on
  how this interacts with HTML.</p>

  <p>An <dfn>XML parser</dfn>, for the purposes of this specification, is a construct that follows
  the rules given in the XML specification to map a string of bytes or characters into a
  <code>Document</code> object.</p>

  <p class="note">At the time of writing, no such rules actually exist.</p><!--XMLPARSE-->

  <p>An <span>XML parser</span> is either associated with a <code>Document</code> object when it is
  created, or creates one implicitly.</p>

  <p>This <code>Document</code> must then be populated with DOM nodes that represent the tree
  structure of the input passed to the parser, as defined by the XML specification, the Namespaces
  in XML specification, and the DOM specification. DOM mutation events must not fire for the
  operations that the <span>XML parser</span> performs on the <code>Document</code>'s tree, but the
  user agent must act as if elements and attributes were individually appended and set respectively
  so as to trigger rules in this specification regarding what happens when an element is inserted
  into a document or has its attributes set, and the DOM specification's requirements regarding
  mutation observers mean that mutation observers <em>are</em> fired (unlike mutation events). <a
  href="#refsXML">\[XML]</a> <a href="#refsXMLNS">\[XMLNS]</a> <a href="#refsDOM">\[DOM]</a> <a
  href="#refsUIEVENTS">\[UIEVENTS]</a></p>

  <p>Between the time an element's start tag is parsed and the time either the element's end tag is
  parsed or the parser detects a well-formedness error, the user agent must act as if the element
  was in a <span>stack of open elements</span>.</p>

  <p class="note">This is used, e.g. by the <code>object</code> element to avoid instantiating plugins
  before the <code>param</code> element children have been parsed.</p>

  <p>This specification provides the following additional information that user agents should use
  when retrieving an external entity: the public identifiers given in the following list all
  correspond to <a href="<!--BOILERPLATE entities-dtd.url-->">the URL given by this link</a>. (This
  URL is a DTD containing the <a href="http://www.w3.org/TR/xml/#sec-entity-decl">entity
  declarations</a> for the names listed in the <span>named character references</span> section.) <a
  href="#refsXML">\[XML]</a></p>

  <ul class="brief">
   <li><code>-//W3C//DTD&nbsp;XHTML&nbsp;1.0&nbsp;Transitional//EN</code></li>
   <li><code>-//W3C//DTD&nbsp;XHTML&nbsp;1.1//EN</code></li>
   <li><code>-//W3C//DTD&nbsp;XHTML&nbsp;1.0&nbsp;Strict//EN</code></li>
   <li><code>-//W3C//DTD&nbsp;XHTML&nbsp;1.0&nbsp;Frameset//EN</code></li>
   <li><code>-//W3C//DTD&nbsp;XHTML&nbsp;Basic&nbsp;1.0//EN</code></li>
   <li><code>-//W3C//DTD&nbsp;XHTML&nbsp;1.1&nbsp;plus&nbsp;MathML&nbsp;2.0//EN</code></li>
   <li><code>-//W3C//DTD&nbsp;XHTML&nbsp;1.1&nbsp;plus&nbsp;MathML&nbsp;2.0&nbsp;plus&nbsp;SVG&nbsp;1.1//EN</code></li>
   <li><code>-//W3C//DTD&nbsp;MathML&nbsp;2.0//EN</code></li>
   <li><code>-//WAPFORUM//DTD&nbsp;XHTML&nbsp;Mobile&nbsp;1.0//EN</code></li>
  </ul>

  <p>Furthermore, user agents should attempt to retrieve the above external entity's content when
  one of the above public identifiers is used, and should not attempt to retrieve any other external
  entity's content.</p>

  <p class="note">This is not strictly a <span data-x="willful violation">violation</span> of the XML
  specification, but it does contradict the spirit of the XML specification's requirements. This is
  motivated by a desire for user agents to all handle entities in an interoperable fashion without
  requiring any network access for handling external subsets. <a href="#refsXML">\[XML]</a></p>

  <p>XML parsers can be invoked with <dfn>XML scripting support enabled</dfn> or <dfn data-x="XML
  scripting support disabled">disabled</dfn>. Except where otherwise specified, XML parsers are
  invoked with <span>XML scripting support enabled</span>.</p>

  <p id="scriptTagXML">When an <span>XML parser</span> with <span>XML scripting support enabled</span>
  creates a <code>script</code> element, it
  must be marked as being <span>"parser-inserted"</span> and its <span>"non-blocking"</span> flag
  must be unset. If the parser was originally created for the <span>XML fragment parsing
  algorithm</span>, then the element must be marked as <span>"already started"</span> also. When the
  element's end tag is subsequently parsed, the user agent must <span>perform a microtask checkpoint</span>, and
  then <span data-x="prepare a script">prepare</span> the <code>script</code> element. If this
  causes there to be a <span>pending parsing-blocking script</span>, then the user agent must run
  the following steps:</p>

  <ol>

   <li><p>Block this instance of the <span>XML parser</span>, such that the <span>event loop</span>
   will not run <span data-x="concept-task">tasks</span> that invoke it.</p></li>

   <li><p><span>Spin the event loop</span> until the parser's <code>Document</code> <span>has no
   style sheet that is blocking scripts</span> and the <span>pending parsing-blocking
   script</span>'s <span>"ready to be parser-executed"</span> flag is set.</p></li>

   <li><p>Unblock this instance of the <span>XML parser</span>, such that <span
   data-x="concept-task">tasks</span> that invoke it can again be run.</p></li>

   <li><p><span data-x="execute the script block">Execute</span> the <span>pending parsing-blocking
   script</span>.</p></li>

   <li><p>There is no longer a <span>pending parsing-blocking script</span>.</p></li>

  </ol>

  <p class="note">Since the <code data-x="dom-document-write">document.write()</code> API is not
  available for <span>XML documents</span>, much of the complexity in the <span>HTML parser</span>
  is not needed in the <span>XML parser</span>.</p>

  <p class="note">When the <span>XML parser</span> has <span>XML scripting support disabled</span>,
  none of this happens.</p>

  <p id="templateTagXML">When an <span>XML parser</span> would append a node to a
  <code>template</code> element, it must instead append it to the <code>template</code> element's
  <span>template contents</span> (a <code>DocumentFragment</code> node).</p>

  <p class="note">This is a <span>willful violation</span> of the XML specification; unfortunately,
  XML is not formally extensible in the manner that is needed for <code>template</code> processing.
  <a href="#refsXML">\[XML]</a></p>

  <p>When an <span>XML parser</span> creates a <code>Node</code> object, its <span>node document</span>
  must be set to the <span>node document</span> of
  the node into which the newly created node is to be inserted.</p>

  <p>Certain algorithms in this specification <dfn data-x="feed the parser">spoon-feed the
  parser</dfn> characters one string at a time. In such cases, the <span>XML parser</span> must act
  as it would have if faced with a single string consisting of the concatenation of all those
  characters.</p>

  <p>When an <span>XML parser</span> reaches the end of its input, it must <span>stop
  parsing</span>, following the same rules as the <span>HTML parser</span>. An <span>XML
  parser</span> can also be <span data-x="abort a parser">aborted</span>, which must again be done in
  the same way as for an <span>HTML parser</span>.</p>

  <p>For the purposes of conformance checkers, if a resource is determined to be in <span>the XHTML
  syntax</span>, then it is an <span data-x="XML documents">XML document</span>.</p>


<!--//HTMLPARSER-->


  <h3 id="serializing-xhtml-fragments">Serializing XHTML fragments</h3>

  <p>The <dfn>XML fragment serialization algorithm</dfn> for a <code>Document</code> or
  <code>Element</code> node either returns a fragment of XML that represents that node or throws an
  exception.</p>

  <p>For <code>Document</code>s, the algorithm must return a string in the form of a <a
  href="http://www.w3.org/TR/xml/#sec-well-formed">document entity</a>, if none of the error cases
  below apply.</p>

  <p>For <code>Element</code>s, the algorithm must return a string in the form of an <a
  href="http://www.w3.org/TR/xml/#wf-entities">internal general parsed entity</a>, if none of the
  error cases below apply.</p>

  <p>In both cases, the string returned must be XML namespace-well-formed and must be an isomorphic
  serialization of all of that node's <span>relevant child nodes</span>, in <span>tree order</span>.
  User agents may adjust prefixes and namespace declarations in the serialization (and indeed might
  be forced to do so in some cases to obtain namespace-well-formed XML). User agents may use a
  combination of regular text and character references to represent <code>Text</code> nodes in the
  DOM.</p>

  <p>A node's <dfn>relevant child nodes</dfn> are those that apply given the following rules:</p>

  <dl>

   <dt>For <code>template</code> elements</dt>

   <dd>The <span>relevant child nodes</span> are the child nodes of the <code>template</code>
   element's <span>template contents</span>, if any.</dd>

   <dt>For all other nodes</dt>

   <dd>The <span>relevant child nodes</span> are the child nodes of node itself, if any.</dd>

  </dl>

  <p>For <code>Element</code>s, if any of the elements in the serialization are in no namespace, the
  default namespace in scope for those elements must be explicitly declared as the empty string.<!--
  because otherwise round-tripping might break since it'll pick up the surrounding default ns when
  setting --> (This doesn't apply in the <code>Document</code> case.) <a href="#refsXML">\[XML]</a>
  <a href="#refsXMLNS">\[XMLNS]</a></p>

  <p>For the purposes of this section, an internal general parsed entity is considered XML
  namespace-well-formed if a document consisting of an element with no namespace declarations whose
  contents are the internal general parsed entity would itself be XML namespace-well-formed.</p>

  <p>If any of the following error cases are found in the DOM subtree being serialized, then the
  algorithm must throw an <code>InvalidStateError</code> exception instead of returning a
  string:</p>

  <ul>

   <li>A <code>Document</code> node with no child element nodes.</li>

   <li>A <code>DocumentType</code> node that has an external subset public identifier that contains
   characters that are not matched by the XML <code>PubidChar</code> production. <a href="#refsXML">\[XML]</a></li>

   <li>A <code>DocumentType</code> node that has an external subset system identifier that contains
   both a U+0022 QUOTATION MARK (") and a U+0027 APOSTROPHE (') or that contains characters that are
   not matched by the XML <code>Char</code> production. <a href="#refsXML">\[XML]</a></li>

   <li>A node with a <!--prefix or--> local name containing a U+003A COLON (:).</li> <!--(prefixes
   can get adjusted, so this isn't an excuse) -->

   <li>A node with a <!--prefix or--> local name that does not match the XML <code
  >Name</code> production. <a href="#refsXML">\[XML]</a></li> <!--(again, prefixes can get
   adjusted, so this isn't an excuse) -->

   <li>An <code>Attr</code> node with no namespace whose local name is the lowercase string "<code
  >xmlns</code>". <a href="#refsXMLNS">\[XMLNS]</a></li>

   <li>An <code>Element</code> node with two or more attributes with the same local name and
   namespace.</li>

   <li>An <code>Attr</code> node, <code>Text</code> node, <code>Comment</code> node, or
   <code>ProcessingInstruction</code> node whose data contains characters that are not matched by
   the XML <code>Char</code> production. <a href="#refsXML">\[XML]</a></li>

   <li>A <code>Comment</code> node whose data contains two adjacent U+002D HYPHEN-MINUS characters
   (-) or ends with such a character.</li>

   <li>A <code>ProcessingInstruction</code> node whose target name is an <span>ASCII
   case-insensitive</span> match for the string "<code>xml</code>".</li>

   <li>A <code>ProcessingInstruction</code> node whose target name contains a U+003A COLON (:).</li>

   <li>A <code>ProcessingInstruction</code> node whose data contains the string "<code
  >?></code>".</li>

  </ul>

  <p class="note">These are the only ways to make a DOM unserialisable. The DOM enforces all the
  other XML constraints; for example, trying to append two elements to a <code>Document</code> node
  will throw a <code>HierarchyRequestError</code> exception.</p>



  <h3 id="parsing-xhtml-fragments">Parsing XHTML fragments</h3>

  <p>The <dfn>XML fragment parsing algorithm</dfn> either returns a <code>Document</code> or throws
  a <code>SyntaxError</code> exception. Given a string <var>input</var> and a
  context element <var data-x="concept-frag-parse-context">context</var>, the algorithm is as
  follows:</p>

  <ol>

   <li>

    <p>Create a new <span>XML parser</span>.</p>

   </li>

   <li>

    <p><span>Feed the
    parser</span> just created the string corresponding to the start tag of the <var
    data-x="concept-frag-parse-context">context</var> element, declaring
    all the namespace prefixes that are in scope on that element in the DOM, as well as declaring
    the default namespace (if any) that is in scope on that element in the DOM.</p>

    <p>A namespace prefix is in scope if the DOM <code>lookupNamespaceURI()</code> method
    on the element would return a non-null value for that prefix.</p>

    <p>The default namespace is the namespace for which the DOM <code
   >isDefaultNamespace()</code> method on the element would return true.</p>

    <p class="note">No
    <code>DOCTYPE</code> is passed to the parser, and therefore no external subset is
    referenced, and therefore no entities will be recognized.</p>

   </li>

   <li>

    <p><span>Feed the parser</span> just created the string <var>input</var>.</p>

   </li>

   <li>

    <p><span>Feed the parser</span> just created the string corresponding to the end tag of the <var
    data-x="concept-frag-parse-context">context</var> element.</p>

   </li>

   <li>

    <p>If there is an XML well-formedness or XML namespace well-formedness error, then throw a
    <code>SyntaxError</code> exception and abort these steps.</p>

   </li>

   <li>

    <p>If the root
    element of the resulting <code>Document</code> has any sibling nodes, then throw a
    <code>SyntaxError</code> exception and abort these steps.</p>

    <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1443 -->

   </li>

   <li>

    <p>Return the
    child nodes of the root element of the resulting <code>Document</code>, in <span>tree
    order</span>.</p>

   </li>

  </ol>

  </div>


<!--TOPIC:Rendering-->

  <div class="impl">

  <h2 id="rendering">Rendering</h2>

  <p><i>User agents are not required to present HTML documents in any particular way. However, this
  section provides a set of suggestions for rendering HTML documents that, if followed, are likely
  to lead to a user experience that closely resembles the experience intended by the documents'
  authors. So as to avoid confusion regarding the normativity of this section, RFC2119 terms have
  not been used. Instead, the term "expected" is used to indicate behavior that will lead to this
  experience. For the purposes of conformance for user agents designated as <a
  href="#renderingUA">supporting the suggested default rendering</a>, the term "expected" in this
  section has the same conformance implications as the RFC2119-defined term "must".</i></p>


  <h3 id="introduction">Introduction</h3>

  <p>In general, user agents are expected to support CSS, and many of the suggestions in this
  section are expressed in CSS terms. User agents that use other presentation mechanisms can derive
  their expected behavior by translating from the CSS rules given in this section.</p>

  <p>In the absence of style-layer rules to the contrary (e.g. author style sheets), user agents are
  expected to render an element so that it conveys to the user the meaning that the element
  <span>represents</span>, as described by this specification.</p>

  <p>The suggestions in this section generally assume a visual output medium with a resolution of
  96dpi or greater, but HTML is intended to apply to multiple media (it is a
  <i>media-independent</i> language). User agent implementors are encouraged to adapt the
  suggestions in this section to their target media.</p>

  <hr>

  <p>An element is <dfn>being rendered</dfn> if it has any associated CSS layout boxes, SVG layout
  boxes, or some equivalent in other styling languages.</p>

  <p class="note">Just being off-screen does not mean the element is not <span>being
  rendered</span>. The presence of the <code data-x="attr-hidden">hidden</code> attribute normally
  means the element is not <span>being rendered</span>, though this might be overridden by the style
  sheets.</p>

  <hr>

  <p>User agents that do not honor author-level CSS style sheets are nonetheless expected to act as
  if they applied the CSS rules given in these sections in a manner consistent with this
  specification and the relevant CSS and Unicode specifications. <a href="#refsCSS">\[CSS]</a> <a href="#refsUNICODE">\[UNICODE]</a> <a href="#refsBIDI">\[BIDI]</a></p>

  <p class="note">This is especially important for issues relating to the 'display', 'unicode-bidi',
  and 'direction' properties.</p>



  <h3 id="the-css-user-agent-style-sheet-and-presentational-hints">The CSS user agent style sheet and presentational hints</h3>

  <p>The CSS rules given in these subsections are, except where otherwise specified, expected to be
  used as part of the user-agent level style sheet defaults for all documents that contain
  <span>HTML elements</span>.</p>

  <p>Some rules are intended for the author-level zero-specificity presentational hints part of the
  CSS cascade; these are explicitly called out as <dfn>presentational hints</dfn>.</p>

  <p>Some of the rules regarding left and right margins are given here as appropriate for elements
  whose 'direction' property is 'ltr', and are expected to be flipped around on elements whose
  'direction' property is 'rtl'. These are marked "<dfn>LTR-specific</dfn>".</p>

  <p class="note">These markings only affect the handling of attribute <em>values</em>, not
  attribute names or element names.</p>

  <hr>

  <p>When the text below says that an attribute <var>attribute</var> on an element
  <var>element</var> <dfn>maps to the pixel length property</dfn> (or properties)
  <var>properties</var>, it means that if <var>element</var> has an attribute <var>attribute</var>
  set, and parsing that attribute's value using the <span>rules for parsing non-negative
  integers</span> doesn't generate an error, then the user agent is expected to use the parsed value
  as a pixel length for a <span data-x="presentational hints">presentational hint</span> for
  <var>properties</var>.</p>

  <p>When the text below says that an attribute <var>attribute</var> on an element
  <var>element</var> <dfn>maps to the dimension property</dfn> (or properties)
  <var>properties</var>, it means that if <var>element</var> has an attribute <var>attribute</var>
  set, and parsing that attribute's value using the <span>rules for parsing dimension values</span>
  doesn't generate an error, then the user agent is expected to use the parsed dimension as the
  value for a <span data-x="presentational hints">presentational hint</span> for
  <var>properties</var>, with the value given as a pixel length if the dimension was a length, and
  with the value given as a percentage if the dimension was a percentage.</p>

  <p>When the text below says that an attribute <var>attribute</var> on an element
  <var>element</var> <dfn>maps to the dimension property (ignoring zero)</dfn> (or properties)
  <var>properties</var>, it means that if <var>element</var> has an attribute <var>attribute</var>
  set, and parsing that attribute's value using the <span>rules for parsing non-zero dimension
  values</span> doesn't generate an error, then the user agent is expected to use the parsed
  dimension as the value for a <span data-x="presentational hints">presentational hint</span> for
  <var>properties</var>, with the value given as a pixel length if the dimension was a length, and
  with the value given as a percentage if the dimension was a percentage.</p>

  <p>When a user agent is to <dfn>align descendants</dfn> of a node, the user agent is expected to
  align only those descendants that have both their 'margin-left' and 'margin-right' properties
  computing to a value other than 'auto', that are over-constrained and that have one of those two
  margins with a used value forced to a greater value, and that do not themselves have an applicable
  <code>align</code> attribute. When multiple elements are to <span
  data-x="align descendants">align</span> a particular descendant, the most deeply nested such
  element is expected to override the others. Aligned elements are expected to be aligned by having
  the used values of their left and right margins be set accordingly.</p>



  <h3 id="non-replaced-elements">Non-replaced elements</h3>


  <h4 id="hidden-elements">Hidden elements</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

<span id="hiddenCSS">[hidden]</span>, area, base, basefont, datalist, head, link, menu[type=context i], meta,
noembed, noframes, param, rp, script, source, style, template, track, title {
  display: none;
}

embed[hidden] { display: inline; height: 0; width: 0; } <!-- because for legacy reasons it still needs to instantiate the plugin -->

input[type=hidden i] { display none ! important; }

@media (scripting) {
  noscript { display: none !important; }
}</pre>


  <h4 id="the-page">The page</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

html, body { display: block; }</pre>


  <!-- body { margin: 8px; } -->

  <p>For each property in the table below, given a <code>body</code> element, the first attribute
  that exists <span>maps to the pixel length property</span> on the <code>body</code> element. If
  none of the attributes for a property are found, or if the value of the attribute that was found
  cannot be parsed successfully, then, if the <code>body</code> element's <span>node document</span>'s
  <span>browsing context</span> does not have its <span>seamless browsing context flag</span> set, a
  default value of 8px is expected to be used for that property instead.</p>

  <table>
   <thead>
    <tr>
     <th>Property
     <th>Source
   <tbody>
    <tr>
     <td rowspan="3">'margin-top'
     <td><code>body</code> element's <code data-x="attr-body-marginheight">marginheight</code> attribute
    <tr>
     <td>The <code>body</code> element's <span>container frame element</span>'s <code data-x="attr-iframe-marginheight">marginheight</code> attribute
    <tr>
     <td><code>body</code> element's <code data-x="attr-body-topmargin">topmargin</code> attribute
   <tbody>
    <tr>
     <td rowspan="3">'margin-right'
     <td><code>body</code> element's <code data-x="attr-body-marginwidth">marginwidth</code> attribute
    <tr>
     <td>The <code>body</code> element's <span>container frame element</span>'s <code data-x="attr-iframe-marginwidth">marginwidth</code> attribute
    <tr>
     <td><code>body</code> element's <code data-x="attr-body-rightmargin">rightmargin</code> attribute
   <tbody>
    <tr>
     <td rowspan="3">'margin-bottom'
     <td><code>body</code> element's <code data-x="attr-body-marginheight">marginheight</code> attribute
    <tr>
     <td>The <code>body</code> element's <span>container frame element</span>'s <code data-x="attr-iframe-marginheight">marginheight</code> attribute
    <tr>
     <td><code>body</code> element's <code data-x="attr-body-bottommargin">bottommargin</code> attribute
   <tbody>
    <tr>
     <td rowspan="3">'margin-left'
     <td><code>body</code> element's <code data-x="attr-body-marginwidth">marginwidth</code> attribute
    <tr>
     <td>The <code>body</code> element's <span>container frame element</span>'s <code data-x="attr-iframe-marginwidth">marginwidth</code> attribute
    <tr>
     <td><code>body</code> element's <code data-x="attr-body-leftmargin">leftmargin</code> attribute
  </table>

  <p>If the <code>body</code> element's <span>node document</span>'s <span>browsing context</span> is a
  <span>nested browsing context</span>, and the <span>browsing context container</span> of that
  <span>nested browsing context</span> is a <code>frame</code> or <code>iframe</code> element, then
  the <dfn>container frame element</dfn> of the <code>body</code> element is that <code>frame</code>
  or <code>iframe</code> element. Otherwise, there is no <span>container frame element</span>.</p>

  <p class="warning">The above requirements imply that a page can change the margins of another page
  (including one from another <span>origin</span>) using, for example, an <code>iframe</code>. This
  is potentially a security risk, as it might in some cases allow an attack to contrive a situation
  in which a page is rendered not as the author intended, possibly for the purposes of phishing or
  otherwise misleading the user.</p>

  <hr>

  <p>If a <code>Document</code> is in a <span>nested browsing context</span>, it is expected to be
  positioned and sized to fit inside the content box of its <span>browsing context container</span>.
  If a <span>browsing context</span> is not <span>being rendered</span>, it is expected to have a
  viewport with zero width and zero height.</p>

  <p>If the <code>Document</code> is in a <span>nested browsing context</span>, and the
  <span>browsing context container</span> of that <span>nested browsing context</span> is a
  <code>frame</code> or <code>iframe</code> element, and that element has a <code
 >scrolling</code> attribute, and that attribute's value is an <span>ASCII
  case-insensitive</span> match for the string "<code>off</code>", "<code
 >noscroll</code>", or "<code>no</code>", then the user agent is expected to
  prevent any scroll bars from being shown for the viewport of the <span>nested browsing
  context</span>, regardless of the 'overflow' property that applies to that viewport.</p>

  <hr>

  <p>When a <code>body</code> element has a <code data-x="attr-background">background</code>
  attribute set to a non-empty value, the new value is expected to be <span data-x="resolve a
  url">resolved</span> relative to the element, and if this is successful, the user agent is
  expected to treat the attribute as a <span data-x="presentational hints">presentational hint</span>
  setting the element's 'background-image' property to the resulting <span>absolute URL</span>.</p>

  <p>When a <code>body</code> element has a <code data-x="attr-body-bgcolor">bgcolor</code> attribute
  set, the new value is expected to be parsed using the <span>rules for parsing a legacy color
  value</span>, and if that does not return an error, the user agent is expected to treat the
  attribute as a <span data-x="presentational hints">presentational hint</span> setting the element's
  'background-color' property to the resulting color.</p>

  <p>When a <code>body</code> element has a <code data-x="attr-body-text">text</code> attribute, its
  value is expected to be parsed using the <span>rules for parsing a legacy color value</span>, and
  if that does not return an error, the user agent is expected to treat the attribute as a <span
  data-x="presentational hints">presentational hint</span> setting the element's 'color' property to
  the resulting color.</p>

  <p>When a <code>body</code> element has a <code data-x="attr-body-link">link</code> attribute, its
  value is expected to be parsed using the <span>rules for parsing a legacy color value</span>, and
  if that does not return an error, the user agent is expected to treat the attribute as a <span
  data-x="presentational hints">presentational hint</span> setting the 'color' property of any
  element in the <code>Document</code> matching the ':link' pseudo-class to the resulting color.</p>

  <p>When a <code>body</code> element has a <code data-x="attr-body-vlink">vlink</code> attribute,
  its value is expected to be parsed using the <span>rules for parsing a legacy color value</span>,
  and if that does not return an error, the user agent is expected to treat the attribute as a <span
  data-x="presentational hints">presentational hint</span> setting the 'color' property of any
  element in the <code>Document</code> matching the ':visited' pseudo-class to the resulting
  color.</p>

  <p>When a <code>body</code> element has an <code data-x="attr-body-alink">alink</code> attribute,
  its value is expected to be parsed using the <span>rules for parsing a legacy color value</span>,
  and if that does not return an error, the user agent is expected to treat the attribute as a <span
  data-x="presentational hints">presentational hint</span> setting the 'color' property of any
  element in the <code>Document</code> matching the ':active' pseudo-class and either the ':link'
  pseudo-class or the ':visited' pseudo-class to the resulting color.</p>



  <h4 id="flow-content">Flow content</h4>

  <!-- del, ins, and map are inline. -->

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

address, blockquote, center, div, figure, figcaption, footer, form, header, hr,
legend, listing, main, p, plaintext, pre, summary, xmp {
  display: block;<!-- see also unicode-bidi: isolate rules-->
}

blockquote, figure, listing, p, plaintext, pre, xmp {
  margin-top: 1em; margin-bottom: 1em;
}

blockquote, figure { margin-left: 40px; margin-right: 40px; }

address { font-style: italic; }
listing, plaintext, pre, xmp {
  font-family: monospace; white-space: pre;
}

dialog:not([open]) { display: none; }
dialog {
  position: absolute;
  left: 0; right: 0;
  width: fit-content;
  height: fit-content;
  margin: auto;
  border: solid;
  padding: 1em;
  background: white;
  color: black;
}
dialog::backdrop {
  position: fixed;
  top: 0; right: 0; bottom: 0; left: 0;
  background: rgba(0,0,0,0.1);
}

/* for small devices, modal dialogs go full-screen */
@media screen and (max-width: 540px) {
  dialog:modal {
    top: 0;
    width: auto;
    margin: 1em;
  }
}
</pre>

  <p>The following rules are also expected to apply, as <span>presentational hints</span>:</p>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

pre[wrap] { white-space: pre-wrap; }</pre>

  <p>In <span>quirks mode</span>, the following rules are also expected to apply:</p>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

form { margin-bottom: 1em; }</pre>

  <hr>

  <p>The <code>center</code> element, and the <code>div</code> element when it has an <code
  data-x="attr-div-align">align</code> attribute whose value is an <span>ASCII
  case-insensitive</span> match for either the string "<code>center</code>" or the string
  "<code>middle</code>", are expected to center text within themselves, as if they had
  their 'text-align' property set to 'center' in a <span data-x="presentational
  hints">presentational hint</span>, and to <span>align descendants</span> to the center.</p>

  <p>The <code>div</code> element, when it has an <code data-x="attr-div-align">align</code>
  attribute whose value is an <span>ASCII case-insensitive</span> match for the string "<code
 >left</code>", is expected to left-align text within itself, as if it had its
  'text-align' property set to 'left' in a <span data-x="presentational hints">presentational
  hint</span>, and to <span>align descendants</span> to the left.</p>

  <p>The <code>div</code> element, when it has an <code data-x="attr-div-align">align</code>
  attribute whose value is an <span>ASCII case-insensitive</span> match for the string "<code
 >right</code>", is expected to right-align text within itself, as if it had its
  'text-align' property set to 'right' in a <span data-x="presentational hints">presentational
  hint</span>, and to <span>align descendants</span> to the right.</p>

  <p>The <code>div</code> element, when it has an <code data-x="attr-div-align">align</code>
  attribute whose value is an <span>ASCII case-insensitive</span> match for the string "<code
 >justify</code>", is expected to full-justify text within itself, as if it had its
  'text-align' property set to 'justify' in a <span data-x="presentational hints">presentational
  hint</span>, and to <span>align descendants</span> to the left.</p>



  <h4 id="phrasing-content">Phrasing content</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

cite, dfn, em, i, var { font-style: italic; }
b, strong { font-weight: bolder; }
code, kbd, samp, tt { font-family: monospace; }
big { font-size: larger; }
small { font-size: smaller; }

sub { vertical-align: sub; }
sup { vertical-align: super; }
sub, sup { line-height: normal; font-size: smaller; }

<!-- FORK -->
ruby { display: ruby; }
rb   { display: ruby-base; white-space: nowrap; }
rt   {
    display: ruby-text;
    white-space: nowrap;
    font-size: 50%;
    font-variant-east-asian: ruby;
    text-emphasis: none;
}
rbc  { display: ruby-base-container; }
rtc  { display: ruby-text-container; }
ruby, rb, rt, rbc, rtc { unicode-bidi: isolate; }
<!-- /FORK -->

:link { color: #0000EE; }
:visited { color: #551A8B; }
:link:active, :visited:active { color: #FF0000; }
:link, :visited { text-decoration: underline; cursor: pointer; }
a:link[rel~=help], a:visited[rel~=help],
area:link[rel~=help], area:visited[rel~=help] { cursor: help; }

:focus { outline: auto; }

mark { background: yellow; color: black; } /* this color is just a suggestion and can be changed based on implementation feedback */

abbr[title], acronym[title] { text-decoration: dotted underline; }<!-- CSS3 https://drafts.csswg.org/css3-text/#text-decoration-style -->
ins, u { text-decoration: underline; }
del, s, strike { text-decoration: line-through; }
blink { text-decoration: blink; }

q::before { content: open-quote; }
q::after { content: close-quote; }

<span id="br-wbr-content">br { display-outside: newline; } /* <a href="#bidi-rendering">this also has bidi implications</a> */
nobr { white-space: nowrap; }
wbr { display-outside: break-opportunity; } /* <a href="#bidi-rendering">this also has bidi implications</a> */
nobr wbr { white-space: normal; }</span></pre>

  <p>The following rules are also expected to apply, as
  <span>presentational hints</span>:</p>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

br[clear=left i] { clear: left; }
br[clear=right i] { clear: right; }
br[clear=all i], br[clear=both i] { clear: both; }</pre>

  <!-- FORK -->
  <p>User agents that do not support correct ruby rendering are expected to render parentheses
  around the text of <code>rt</code> elements in the absence of <code>rp</code> elements.
  <a href="#refsCSSRUBY">\[CSSRUBY]</a></p>
  <!-- /FORK -->

  <hr>

  <p>User agents are expected to support the 'clear' property on inline elements (in order to render
  <code>br</code> elements with <code data-x="attr-br-clear">clear</code> attributes) in the manner
  described in the non-normative note to this effect in CSS2.1.</p> <!-- section 9.5.2 of CSS2.1 -->

  <p>The initial value for the 'color' property is expected to be black. The initial value for the
  'background-color' property is expected to be 'transparent'. The canvas' background is expected to
  be white.</p>

  <hr>

  <p>When a <code>font</code> element has a <code data-x="attr-font-color" undefined>color</code>
  attribute, its value is expected to be parsed using the <span>rules for parsing a legacy color
  value</span>, and if that does not return an error, the user agent is expected to treat the
  attribute as a <span data-x="presentational hints">presentational hint</span> setting the
  element's 'color' property to the resulting color.</p>

  <p id="the-font-element-text-decoration-color-quirk">The <code>font</code> element is expected to
  override the color of any text decoration that spans the text of the element to the used value of
  the element's 'color' property.</p>

  <p>When a <code>font</code> element has a <code data-x="attr-font-face" undefined>face</code>
  attribute, the user agent is expected to treat the attribute as a <span data-x="presentational
  hints">presentational hint</span> setting the element's 'font-family' property to the attribute's
  value.</p>

  <!-- (Apparently only IE supports this?) (Note: if you add this back, make sure to define which of
  'size' vs 'pointsize' wins.)

  <p>When a <code>font</code> element has a <code data-x="attr-font-pointsize"
  undefined>pointsize</code> attribute, the user agent is expected to parse that attribute's value
  using the <span>rules for parsing non-negative integers</span>, and if this doesn't generate an
  error, then the user agent is expected to use the parsed value as a <em>point</em> length for a
  <span data-x="presentational hints">presentational hint</span> for the 'font-size' property on the
  element.</p>
  -->

  <p>When a <code>font</code> element has a <code data-x="attr-font-size" undefined>size</code>
  attribute, the user agent is expected to use the following steps, known as the <dfn>rules for
  parsing a legacy font size</dfn>, to treat the attribute as a <span data-x="presentational
  hints">presentational hint</span> setting the element's 'font-size' property:</p>

  <ol>

   <li><p>Let <var>input</var> be the attribute's value.</p></li>

   <li><p>Let <var>position</var> be a pointer into <var>input</var>, initially pointing at the
   start of the string.</p></li>

   <li><p><span>Skip whitespace</span>.</p></li>

   <li><p>If <var>position</var> is past the end of <var>input</var>, there is no <span
   data-x="presentational hints">presentational hint</span>. Abort these steps.</p></li>

   <li><p>If the character at <var>position</var> is a U+002B PLUS SIGN character (+), then let
   <var>mode</var> be <i>relative-plus</i>, and advance <var>position</var> to the next character.
   Otherwise, if the character at <var>position</var> is a U+002D HYPHEN-MINUS character (-), then
   let <var>mode</var> be <i>relative-minus</i>, and advance <var>position</var> to the next
   character. Otherwise, let <var>mode</var> be <i>absolute</i>.</p></li>

   <li><p><span>Collect a sequence of characters</span> that are <span>ASCII digits</span>, and let
   the resulting sequence be <var>digits</var>.</p></li>

   <li><p>If <var>digits</var> is the empty string, there is no <span data-x="presentational
   hints">presentational hint</span>. Abort these steps.</p></li>

   <li><p>Interpret <var>digits</var> as a base-ten integer. Let <var>value</var> be the resulting
   number.</p></li>

   <li>

    <!-- basefont support would go here, but we removed it -->

    <p>If <var>mode</var> is <i>relative-plus</i>, then increment <var>value</var> by 3. If
    <var>mode</var> is <i>relative-minus</i>, then let <var>value</var> be the result of subtracting
    <var>value</var> from 3.</p>

   </li>

   <li><p>If <var>value</var> is greater than 7, let it be 7.</p></li>

   <li><p>If <var>value</var> is less than 1, let it be 1.</p></li>

   <li>

    <p>Set 'font-size' to the keyword corresponding to the value of <var>value</var> according to
    the following table:</p>

    <table>
     <thead>
      <tr>
       <th><var>value</var>
       <th>'font-size' keyword
       <th>Notes
     <tbody>
      <tr>
       <td>1
       <td>x-small
       <td>
      <tr>
       <td>2
       <td>small
       <td>
      <tr>
       <td>3
       <td>medium
       <td>
      <tr>
       <td>4
       <td>large
       <td>
      <tr>
       <td>5
       <td>x-large
       <td>
      <tr>
       <td>6
       <td>xx-large
       <td>
      <tr>
       <td>7
       <td>x<!---->xx-large
       <td><i>see below</i>
    </table>

    <p class="tablenote"><small>The 'x<!---->xx-large' value is a non-CSS value used here to
    indicate a font size 50% larger than 'xx-large'.</small></p>

   </li>

  </ol>


  <h4 id="bidi-rendering">Bidirectional text</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

[dir]:dir(ltr), bdi:dir(ltr), input[type=tel i]:dir(ltr) { direction: ltr; }
[dir]:dir(rtl), bdi:dir(rtl) { direction: rtl; }

address, blockquote, center, div, figure, figcaption, footer, form, header, hr,
legend, listing, main, p, plaintext, pre, summary, xmp, article, aside, h1, h2,
h3, h4, h5, h6, nav, section, table, caption, colgroup, col, thead,
tbody, tfoot, tr, td, th, dir, dd, dl, dt, menu, ol, ul, li, bdi, output,
[dir=ltr i], [dir=rtl i], [dir=auto i] {
  unicode-bidi: isolate; <!-- anything that's similar to display:block, plus <bdi>, <output>, and dir="" -->
}

bdo, bdo[dir] { unicode-bidi: isolate-override; } <!-- bdo[dir] rule is to override the otherwise higher-specificity attribute selectors in the previous rule -->

input[dir=auto i]:matches([type=search i], [type=tel i], [type=url i],
[type=email i]), textarea[dir=auto i], pre[dir=auto i] {
  unicode-bidi: plaintext;
}
/* see prose for input elements whose type attribute is in the Text state */

/* the <a href="#br-wbr-content">rules setting the 'content' property</a> on <code>br</code> and <code>wbr</code> elements also has bidi implications */</pre>

  <p>When an <code>input</code> element's <code data-x="attr-dir">dir</code> attribute is in the
  <span data-x="attr-dir-auto">auto</span> state and its <code data-x="attr-input-type">type</code>
  attribute is in the <span data-x="attr-input-type-text">Text</span> state, then the user agent is
  expected to act as if it had a user-agent-level style sheet rule setting the 'unicode-bidi'
  property to 'plaintext'.</p>

  <p>Input fields (i.e. <code>textarea</code> elements, and <code>input</code> elements when their
  <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-text">Text</span>, <span data-x="attr-input-type-search">Search</span>,
  <span data-x="attr-input-type-tel">Telephone</span>, <span data-x="attr-input-type-url">URL</span>,
  or <span data-x="attr-input-type-email">E-mail</span> state) are expected to present an editing
  user interface with a directionality that matches the element's 'direction' property.</p>

  <p>When the document's character encoding is ISO-8859-8, the following rules are additionally
  expected to apply, following those above: <a href="#refsENCODING">\[ENCODING]</a></p>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

address, blockquote, center, div, figure, figcaption, footer, form, header, hr,
legend, listing, main, p, plaintext, pre, summary, xmp, article, aside, h1, h2,
h3, h4, h5, h6, nav, section, table, caption, colgroup, col, thead,
tbody, tfoot, tr, td, th, dir, dd, dl, dt, menu, ol, ul, li, [dir=ltr i],
[dir=rtl i], [dir=auto i], *|* {
  unicode-bidi: bidi-override;
}
input:not([type=submit i]):not([type=reset i]):not([type=button i]),
textarea, keygen {
  unicode-bidi: normal;
}</pre>


  <h4 id="quotes">Quotes</h4>

  <p>This block is automatically generated from the Unicode Common Locale Data Repository. <a
  href="#refsCLDR">\[CLDR]</a></p>

  <p>User agents are expected to use either the block below (which will be regularly updated) or to
  automatically generate their own copy directly from the source material. The language codes are
  derived from the CLDR file names. The quotes are derived from the <code>delimiter</code>
  blocks, with fallback handled as specified in the CLDR documentation.</p>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

<!--BOILERPLATE cldr.inc--></pre>


  <h4 id="sections-and-headings">Sections and headings</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

article, aside, h1, h2, h3, h4, h5, h6, nav, section {
  display: block;<!-- see also unicode-bidi: isolate rules-->
}

h1 { margin-top: 0.67em; margin-bottom: 0.67em; font-size: 2.00em; font-weight: bold; }
h2 { margin-top: 0.83em; margin-bottom: 0.83em; font-size: 1.50em; font-weight: bold; }
h3 { margin-top: 1.00em; margin-bottom: 1.00em; font-size: 1.17em; font-weight: bold; }
h4 { margin-top: 1.33em; margin-bottom: 1.33em; font-size: 1.00em; font-weight: bold; }
h5 { margin-top: 1.67em; margin-bottom: 1.67em; font-size: 0.83em; font-weight: bold; }
h6 { margin-top: 2.33em; margin-bottom: 2.33em; font-size: 0.67em; font-weight: bold; }</pre>

  <p>In the following CSS block, <var>x</var> is shorthand for the following selector:
  <code>:matches(article, aside, nav, section)</code></p>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

<var>x</var> h1 { margin-top: 0.83em; margin-bottom: 0.83em; font-size: 1.50em; }
<var>x</var> <var>x</var> h1 { margin-top: 1.00em; margin-bottom: 1.00em; font-size: 1.17em; }
<var>x</var> <var>x</var> <var>x</var> h1 { margin-top: 1.33em; margin-bottom: 1.33em; font-size: 1.00em; }
<var>x</var> <var>x</var> <var>x</var> <var>x</var> h1 { margin-top: 1.67em; margin-bottom: 1.67em; font-size: 0.83em; }
<var>x</var> <var>x</var> <var>x</var> <var>x</var> <var>x</var> h1 { margin-top: 2.33em; margin-bottom: 2.33em; font-size: 0.67em; }</pre>

  <p class="note">The shorthand is used to keep this block at least mildly readable.</p>


  <h4 id="lists">Lists</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

dir, dd, dl, dt, menu, ol, ul { display: block; }<!-- see also unicode-bidi:isolate rules -->
li { display: list-item; }<!-- see also unicode-bidi:isolate rules -->

dir, dl, menu, ol, ul { margin-top: 1em; margin-bottom: 1em; }

:matches(dir, dl, menu, ol, ul) :matches(dir, dl, menu, ol, ul) {
  margin-top: 0; margin-bottom: 0;
}

dd { margin-left: 40px; } /* <span>LTR-specific</span>: use 'margin-right' for rtl elements */
dir, menu, ol, ul { padding-left: 40px; } /* <span>LTR-specific</span>: use 'padding-right' for rtl elements */

ol { list-style-type: decimal; }

dir, menu, ul {
  list-style-type: disc;
}
:matches(dir, menu, ol, ul) :matches(dir, menu, ul) {
  list-style-type: circle;
}
:matches(dir, menu, ol, ul) :matches(dir, menu, ol, ul) :matches(dir, menu, ul) {
  list-style-type: square;
}</pre>

  <p id="decohints">The following rules are also expected to apply, as <span>presentational
  hints</span>:</p>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

ol[type=1], li[type=1] { list-style-type: decimal; }
ol[type=a], li[type=a] { list-style-type: lower-alpha; }
ol[type=A], li[type=A] { list-style-type: upper-alpha; }
ol[type=i], li[type=i] { list-style-type: lower-roman; }
ol[type=I], li[type=I] { list-style-type: upper-roman; }
ul[type=none i], li[type=none i] { list-style-type: none; }
ul[type=disc i], li[type=disc i] { list-style-type: disc; }
ul[type=circle i], li[type=circle i] { list-style-type: circle; }
ul[type=square i], li[type=square i] { list-style-type: square; }</pre>

  <p id="attribute-selector-case-sensitive">In the above stylesheet, the attribute selectors for the
  <code>ol</code> and <code>li</code> elements are expected to be treated as
  <span>case-sensitive</span>.</p>

  <p>When rendering <code>li</code> elements, non-CSS user agents are expected to use the
  <span>ordinal value</span> of the <code>li</code> element to render the counter in the list item
  marker.</p>

  <p class="critical" id="css-list-rendering">This specification does not yet define the
  CSS-specific rules for rendering <code>li</code> elements, because CSS doesn't yet provide
  sufficient hooks for this purpose.</p>


  <h4 id="tables">Tables</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

table { display: table; }<!-- see also unicode-bidi:isolate rules -->
caption { display: table-caption; }<!-- see also unicode-bidi:isolate rules -->
colgroup, colgroup[hidden] { display: table-column-group; }<!-- see also unicode-bidi:isolate rules -->
col, col[hidden] { display: table-column; }<!-- see also unicode-bidi:isolate rules -->
thead, thead[hidden] { display: table-header-group; }<!-- see also unicode-bidi:isolate rules -->
tbody, tbody[hidden] { display: table-row-group; }<!-- see also unicode-bidi:isolate rules -->
tfoot, tfoot[hidden] { display: table-footer-group; }<!-- see also unicode-bidi:isolate rules -->
tr, tr[hidden] { display: table-row; }<!-- see also unicode-bidi:isolate rules -->
td, th, td[hidden], th[hidden] { display: table-cell; }<!-- see also unicode-bidi:isolate rules -->

colgroup[hidden], col[hidden], thead[hidden], tbody[hidden],
tfoot[hidden], tr[hidden], td[hidden], th[hidden] {
  visibility: collapse;
}

table {
  box-sizing: border-box;
  border-spacing: 2px;
  border-collapse: separate;
  text-indent: initial;
}
td, th { padding: 1px; }
th { font-weight: bold; }

thead, tbody, tfoot, table > tr { vertical-align: middle; }
tr, td, th { vertical-align: inherit; }

table, td, th { border-color: gray; }
thead, tbody, tfoot, tr { border-color: inherit; }
table[rules=none i], table[rules=groups i], table[rules=rows i],
table[rules=cols i], table[rules=all i], table[frame=void i],
table[frame=above i], table[frame=below i], table[frame=hsides i],
table[frame=lhs i], table[frame=rhs i], table[frame=vsides i],
table[frame=box i], table[frame=border i],
table[rules=none i] > tr > td, table[rules=none i] > tr > th,
table[rules=groups i] > tr > td, table[rules=groups i] > tr > th,
table[rules=rows i] > tr > td, table[rules=rows i] > tr > th,
table[rules=cols i] > tr > td, table[rules=cols i] > tr > th,
table[rules=all i] > tr > td, table[rules=all i] > tr > th,
table[rules=none i] > thead > tr > td, table[rules=none i] > thead > tr > th,
table[rules=groups i] > thead > tr > td, table[rules=groups i] > thead > tr > th,
table[rules=rows i] > thead > tr > td, table[rules=rows i] > thead > tr > th,
table[rules=cols i] > thead > tr > td, table[rules=cols i] > thead > tr > th,
table[rules=all i] > thead > tr > td, table[rules=all i] > thead > tr > th,
table[rules=none i] > tbody > tr > td, table[rules=none i] > tbody > tr > th,
table[rules=groups i] > tbody > tr > td, table[rules=groups i] > tbody > tr > th,
table[rules=rows i] > tbody > tr > td, table[rules=rows i] > tbody > tr > th,
table[rules=cols i] > tbody > tr > td, table[rules=cols i] > tbody > tr > th,
table[rules=all i] > tbody > tr > td, table[rules=all i] > tbody > tr > th,
table[rules=none i] > tfoot > tr > td, table[rules=none i] > tfoot > tr > th,
table[rules=groups i] > tfoot > tr > td, table[rules=groups i] > tfoot > tr > th,
table[rules=rows i] > tfoot > tr > td, table[rules=rows i] > tfoot > tr > th,
table[rules=cols i] > tfoot > tr > td, table[rules=cols i] > tfoot > tr > th,
table[rules=all i] > tfoot > tr > td, table[rules=all i] > tfoot > tr > th {
  border-color: black;
}</pre>

  <p>The following rules are also expected to apply, as <span>presentational hints</span>:</p>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

table[align=left i] { float: left; }
table[align=right i] { float: right; }
table[align=center i] { margin-left: auto; margin-right: auto; }
thead[align=absmiddle i], tbody[align=absmiddle i], tfoot[align=absmiddle i],
tr[align=absmiddle i], td[align=absmiddle i], th[align=absmiddle i] {
  text-align: center;
}

caption[align=bottom i] { caption-side: bottom; }
p[align=left i], h1[align=left i], h2[align=left i], h3[align=left i],
h4[align=left i], h5[align=left i], h6[align=left i] {
  text-align: left;
}
p[align=right i], h1[align=right i], h2[align=right i], h3[align=right i],
h4[align=right i], h5[align=right i], h6[align=right i] {
  text-align: right;
}
p[align=center i], h1[align=center i], h2[align=center i], h3[align=center i],
h4[align=center i], h5[align=center i], h6[align=center i] {
  text-align: center;
}
p[align=justify i], h1[align=justify i], h2[align=justify i], h3[align=justify i],
h4[align=justify i], h5[align=justify i], h6[align=justify i] {
  text-align: justify;
}
thead[valign=top i], tbody[valign=top i], tfoot[valign=top i],
tr[valign=top i], td[valign=top i], th[valign=top i] {
  vertical-align: top;
}
thead[valign=middle i], tbody[valign=middle i], tfoot[valign=middle i],
tr[valign=middle i], td[valign=middle i], th[valign=middle i] {
  vertical-align: middle;
}
thead[valign=bottom i], tbody[valign=bottom i], tfoot[valign=bottom i],
tr[valign=bottom i], td[valign=bottom i], th[valign=bottom i] {
  vertical-align: bottom;
}
thead[valign=baseline i], tbody[valign=baseline i], tfoot[valign=baseline i],
tr[valign=baseline i], td[valign=baseline i], th[valign=baseline i] {
  vertical-align: baseline;
}

td[nowrap], th[nowrap] { white-space: nowrap; }

table[rules=none i], table[rules=groups i], table[rules=rows i],
table[rules=cols i], table[rules=all i] {
  border-style: hidden;
  border-collapse: collapse;
}
table[border] { border-style: outset; } /* <span>only if border is not equivalent to zero</span> */
table[frame=void i] { border-style: hidden; }
table[frame=above i] { border-style: outset hidden hidden hidden; }
table[frame=below i] { border-style: hidden hidden outset hidden; }
table[frame=hsides i] { border-style: outset hidden outset hidden; }
table[frame=lhs i] { border-style: hidden hidden hidden outset; }
table[frame=rhs i] { border-style: hidden outset hidden hidden; }
table[frame=vsides i] { border-style: hidden outset; }
table[frame=box i], table[frame=border i] { border-style: outset; }

table[border] > tr > td, table[border] > tr > th,
table[border] > thead > tr > td, table[border] > thead > tr > th,
table[border] > tbody > tr > td, table[border] > tbody > tr > th,
table[border] > tfoot > tr > td, table[border] > tfoot > tr > th {
  /* <span>only if border is not equivalent to zero</span> */
  border-width: 1px;
  border-style: inset;
}
table[rules=none i] > tr > td, table[rules=none i] > tr > th,
table[rules=none i] > thead > tr > td, table[rules=none i] > thead > tr > th,
table[rules=none i] > tbody > tr > td, table[rules=none i] > tbody > tr > th,
table[rules=none i] > tfoot > tr > td, table[rules=none i] > tfoot > tr > th,
table[rules=groups i] > tr > td, table[rules=groups i] > tr > th,
table[rules=groups i] > thead > tr > td, table[rules=groups i] > thead > tr > th,
table[rules=groups i] > tbody > tr > td, table[rules=groups i] > tbody > tr > th,
table[rules=groups i] > tfoot > tr > td, table[rules=groups i] > tfoot > tr > th,
table[rules=rows i] > tr > td, table[rules=rows i] > tr > th,
table[rules=rows i] > thead > tr > td, table[rules=rows i] > thead > tr > th,
table[rules=rows i] > tbody > tr > td, table[rules=rows i] > tbody > tr > th,
table[rules=rows i] > tfoot > tr > td, table[rules=rows i] > tfoot > tr > th {
  border-width: 1px;
  border-style: none;
}
table[rules=cols i] > tr > td, table[rules=cols i] > tr > th,
table[rules=cols i] > thead > tr > td, table[rules=cols i] > thead > tr > th,
table[rules=cols i] > tbody > tr > td, table[rules=cols i] > tbody > tr > th,
table[rules=cols i] > tfoot > tr > td, table[rules=cols i] > tfoot > tr > th {
  border-width: 1px;
  border-style: none solid;
}
table[rules=all i] > tr > td, table[rules=all i] > tr > th,
table[rules=all i] > thead > tr > td, table[rules=all i] > thead > tr > th,
table[rules=all i] > tbody > tr > td, table[rules=all i] > tbody > tr > th,
table[rules=all i] > tfoot > tr > td, table[rules=all i] > tfoot > tr > th {
  border-width: 1px;
  border-style: solid;
}

table[rules=groups i] > colgroup {
  border-left-width: 1px;
  border-left-style: solid;
  border-right-width: 1px;
  border-right-style: solid;
}
table[rules=groups i] > thead,
table[rules=groups i] > tbody,
table[rules=groups i] > tfoot {
  border-top-width: 1px;
  border-top-style: solid;
  border-bottom-width: 1px;
  border-bottom-style: solid;
}

table[rules=rows i] > tr, table[rules=rows i] > thead > tr,
table[rules=rows i] > tbody > tr, table[rules=rows i] > tfoot > tr {
  border-top-width: 1px;
  border-top-style: solid;
  border-bottom-width: 1px;
  border-bottom-style: solid;
}</pre>

<!--
 Demos that the above (and prose below) must explain:
   http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1191
   http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1194
   http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1195
   http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1196
   http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1197
   http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1199
   http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1200
   http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1201
   http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1209
-->


  <p>In <span>quirks mode</span>, the following rules are also expected to apply:</p>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

table {
  font-weight: initial;
  font-style: initial;
  font-variant: initial;
  font-size: initial;
  line-height: initial;
  white-space: initial;
  text-align: initial;
}</pre>

  <hr>

  <p>For the purposes of the CSS table model, the <code>col</code> element is expected to be treated
  as if it was present as many times as its <code data-x="attr-col-span">span</code> attribute <span
  data-x="rules for parsing non-negative integers">specifies</span>.</p>

  <p>For the purposes of the CSS table model, the <code>colgroup</code> element, if it contains no
  <code>col</code> element, is expected to be treated as if it had as many such children as its
  <code data-x="attr-colgroup-span">span</code> attribute <span data-x="rules for parsing non-negative
  integers">specifies</span>.</p>

  <p>For the purposes of the CSS table model, the <code data-x="attr-tdth-colspan">colspan</code> and
  <code data-x="attr-tdth-rowspan">rowspan</code> attributes on <code>td</code> and <code>th</code>
  elements are expected to <span data-x="rules for parsing non-negative integers">provide</span> the
  <i>special knowledge</i> regarding cells spanning rows and columns.</p>

  <p>In <span>HTML documents</span>, the following rules are also expected to apply:</p>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

:matches(table, thead, tbody, tfoot, tr) > form {  display: none !important; }</pre>

  <hr>

  <p>The <code>table</code> element's <code data-x="attr-table-cellspacing">cellspacing</code>
  attribute <span>maps to the pixel length property</span> 'border-spacing' on the element.</p>

  <p>The <code>table</code> element's <code data-x="attr-table-cellpadding">cellpadding</code>
  attribute <span data-x="maps to the pixel length property">maps to the pixel length
  properties</span> 'padding-top', 'padding-right', 'padding-bottom', and 'padding-left' of any
  <code>td</code> and <code>th</code> elements that have corresponding <span
  data-x="concept-cell">cells</span> in the <span data-x="concept-table">table</span> corresponding to
  the <code>table</code> element.</p>

  <p>The <code>table</code> element's <code data-x="attr-table-hspace">hspace</code> attribute <span
  data-x="maps to the dimension property">maps to the dimension properties</span> 'margin-left' and
  'margin-right' on the <code>table</code> element.</p>

  <p>The <code>table</code> element's <code data-x="attr-table-vspace">vspace</code> attribute <span
  data-x="maps to the dimension property">maps to the dimension properties</span> 'margin-top' and
  'margin-bottom' on the <code>table</code> element.</p>

  <p>The <code>table</code> element's <code data-x="attr-table-height">height</code> attribute
  <span>maps to the dimension property (ignoring zero)</span> 'height' on the <code>table</code>
  element.</p>

  <p>The <code>table</code> element's <code data-x="attr-table-width">width</code> attribute
  <span>maps to the dimension property (ignoring zero)</span> 'width' on the <code>table</code>
  element.</p>

  <p>The <code>col</code> element's <code data-x="attr-col-width">width</code> attribute <span>maps
  to the dimension property (ignoring zero)</span> 'width' on the <code>col</code> element.</p>

  <p>The <code>tr</code> element's <code data-x="attr-tr-height">height</code> attribute <span>maps
  to the dimension property (ignoring zero)</span> 'height' on the <code>tr</code> element.</p>

  <p>The <code>td</code> and <code>th</code> elements' <code data-x="attr-tdth-height">height</code>
  attributes <span data-x="maps to the dimension property (ignoring zero)">map to the dimension
  property (ignoring zero)</span> 'height' on the element.</p>

  <p>The <code>td</code> and <code>th</code> elements' <code data-x="attr-tdth-width">width</code>
  attributes <span data-x="maps to the dimension property (ignoring zero)">map to the dimension
  property (ignoring zero)</span> 'width' on the element.</p>

  <hr>

  <p>The <code>caption</code> element unless specified otherwise below, and the <code>thead</code>,
  <code>tbody</code>, <code>tfoot</code>, <code>tr</code>, <code>td</code>, and <code>th</code>
  elements when they have an <code>align</code> attribute whose value is an <span>ASCII
  case-insensitive</span> match for either the string "<code>center</code>" or the string
  "<code>middle</code>", are expected to center text within themselves, as if they had
  their 'text-align' property set to 'center' in a <span data-x="presentational
  hints">presentational hint</span>, and to <span>align descendants</span> to the center.</p>

  <p>The <code>caption</code>, <code>thead</code>, <code>tbody</code>, <code>tfoot</code>,
  <code>tr</code>, <code>td</code>, and <code>th</code> elements, when they have an <code
 >align</code> attribute whose value is an <span>ASCII case-insensitive</span> match for
  the string "<code>left</code>", are expected to left-align text within themselves, as if
  they had their 'text-align' property set to 'left' in a <span data-x="presentational
  hints">presentational hint</span>, and to <span>align descendants</span> to the left.</p>

  <p>The <code>caption</code>, <code>thead</code>, <code>tbody</code>, <code>tfoot</code>,
  <code>tr</code>, <code>td</code>, and <code>th</code> elements, when they have an <code
 >align</code> attribute whose value is an <span>ASCII case-insensitive</span> match for
  the string "<code>right</code>", are expected to right-align text within themselves, as
  if they had their 'text-align' property set to 'right' in a <span data-x="presentational
  hints">presentational hint</span>, and to <span>align descendants</span> to the right.</p>

  <p>The <code>caption</code>, <code>thead</code>, <code>tbody</code>, <code>tfoot</code>,
  <code>tr</code>, <code>td</code>, and <code>th</code> elements, when they have an <code
 >align</code> attribute whose value is an <span>ASCII case-insensitive</span> match for
  the string "<code>justify</code>", are expected to full-justify text within themselves,
  as if they had their 'text-align' property set to 'justify' in a <span data-x="presentational
  hints">presentational hint</span>, and to <span>align descendants</span> to the left.</p>

  <p>User agents are expected to have a rule in their user agent stylesheet that matches
  <code>th</code> elements that have a parent node whose computed value for the 'text-align'
  property is its initial value, whose declaration block consists of just a single declaration that
  sets the 'text-align' property to the value 'center'.</p> <!-- q.v. '-moz-center-or-inherit' -->

  <hr>

  <p>When a <code>table</code>, <code>thead</code>, <code>tbody</code>, <code>tfoot</code>,
  <code>tr</code>, <code>td</code>, or <code>th</code> element has a <code
  data-x="attr-background">background</code> attribute set to a non-empty value, the new value is
  expected to be <span data-x="resolve a url">resolved</span> relative to the element, and if this is
  successful, the user agent is expected to treat the attribute as a <span data-x="presentational
  hints">presentational hint</span> setting the element's 'background-image' property to the
  resulting <span>absolute URL</span>.</p>

  <p>When a <code>table</code>, <code>thead</code>, <code>tbody</code>, <code>tfoot</code>,
  <code>tr</code>, <code>td</code>, or <code>th</code> element has a <code>bgcolor</code>
  attribute set, the new value is expected to be parsed using the <span>rules for parsing a legacy
  color value</span>, and if that does not return an error, the user agent is expected to treat the
  attribute as a <span data-x="presentational hints">presentational hint</span> setting the element's
  'background-color' property to the resulting color.</p>

  <p>When a <code>table</code> element has a <code data-x="attr-table-bordercolor">bordercolor</code>
  attribute, its value is expected to be parsed using the <span>rules for parsing a legacy color
  value</span>, and if that does not return an error, the user agent is expected to treat the
  attribute as a <span data-x="presentational hints">presentational hint</span> setting the element's
  'border-top-color', 'border-right-color', 'border-bottom-color', and 'border-left-color'
  properties to the resulting color.</p>

  <hr>

  <p>The <code>table</code> element's <code data-x="attr-table-border">border</code> attribute <span
  data-x="maps to the pixel length property">maps to the pixel length properties</span>
  'border-top-width', 'border-right-width', 'border-bottom-width', 'border-left-width' on the
  element. If the attribute is present but parsing the attribute's value using the <span>rules for
  parsing non-negative integers</span> generates an error, a default value of 1px is expected to be
  used for that property instead.</p>

  <p>Rules marked "<dfn id="magic-border-selector">only if border is not equivalent to zero</dfn>"
  in the CSS block above is expected to only be applied if the <code
  data-x="attr-table-border">border</code> attribute mentioned in the selectors for the rule is not
  only present but, when parsed using the <span>rules for parsing non-negative integers</span>, is
  also found to have a value other than zero or to generate an error.</p>

  <hr>

  <p>In <span>quirks mode</span>, a <code>td</code> element or a <code>th</code> element that has a
  <code data-x="attr-tdth-nowrap">nowrap</code> attribute but also has a <code
  data-x="attr-tdth-width">width</code> attribute whose value, when parsed using the <span>rules for
  parsing non-zero dimension values</span>, is found to be a length (not an error or a number
  classified as a percentage), is expected to have a <span data-x="presentational
  hints">presentational hint</span> setting the element's 'white-space' property to 'normal',
  overriding the rule in the CSS block above that sets it to 'nowrap'.</p> <!--
  http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1793 --> <!-- note that the "rules for
  parsing non-zero dimension values" can't return 0, if the value is "0" they treat it as an error
  -->

  <hr>

  <p id="sortable-ui">User agents are expected to render <span data-x="sorting interface th
  element">sorting interface <code>th</code> elements</span> in such a manner as to indicate that
  activating the elements will cause the table to be sorted.</p>


  <h4 id="margin-collapsing-quirks">Margin collapsing quirks</h4>

  <p>A node is <dfn data-x="concept-rendering-substantial">substantial</dfn> if it is a text node
  that is not <span>inter-element whitespace</span>, or if it is an element node.</p>

  <p>A node is <dfn data-x="concept-rendering-blank">blank</dfn> if it is an element that contains no
  <span data-x="concept-rendering-substantial">substantial</span> nodes.</p>

  <p>The <dfn data-x="concept-rendering-elements-with-margins">elements with default margins</dfn>
  are the following elements: <code>blockquote</code>, <code>dir</code>, <code>dl</code>,
  <code>h1</code>, <code>h2</code>, <code>h3</code>, <code>h4</code>, <code>h5</code>,
  <code>h6</code>, <code>listing</code>, <code>menu</code>, <code>ol</code>,
  <code>p</code>, <code>plaintext</code>, <code>pre</code>, <code>ul</code>, <code>xmp</code></p>

  <p>In <span>quirks mode</span>, any <span data-x="concept-rendering-elements-with-margins">element
  with default margins</span> that is the child of a <code>body</code>, <code>td</code>, or
  <code>th</code> element and has no <span data-x="concept-rendering-substantial">substantial</span>
  previous siblings is expected to have a user-agent level style sheet rule that sets its
  'margin-top' property to zero.</p>

  <p>In <span>quirks mode</span>, any <span data-x="concept-rendering-elements-with-margins">element
  with default margins</span> that is the child of a <code>body</code>, <code>td</code>, or
  <code>th</code> element, has no <span data-x="concept-rendering-substantial">substantial</span>
  previous siblings, and is <span data-x="concept-rendering-blank">blank</span>, is expected to have
  a user-agent level style sheet rule that sets its 'margin-bottom' property to zero also.</p>

  <p>In <span>quirks mode</span>, any <span data-x="concept-rendering-elements-with-margins">element
  with default margins</span> that is the child of a <code>td</code> or <code>th</code> element, has
  no <span data-x="concept-rendering-substantial">substantial</span> following siblings, and is <span
  data-x="concept-rendering-blank">blank</span>, is expected to have a user-agent level style sheet
  rule that sets its 'margin-top' property to zero.</p>

  <p>In <span>quirks mode</span>, any <code>p</code> element that is the child of a <code>td</code>
  or <code>th</code> element and has no <span
  data-x="concept-rendering-substantial">substantial</span> following siblings, is expected to have a
  user-agent level style sheet rule that sets its 'margin-bottom' property to zero.</p>


  <h4 id="form-controls">Form controls</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

input, select, option, optgroup, button, textarea, keygen {
  text-indent: initial;
}

input:matches([type=radio i], [type=checkbox i], [type=reset i], [type=button i],
[type=submit i], [type=search i]), select, button {
  box-sizing: border-box;
}</pre>

  <p>In <span>quirks mode</span>, the following rules are also expected to apply:</p>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

input:not([type=image i]), textarea { box-sizing: border-box; }</pre>

  <p>Each kind of form control is also given a specific default binding, as described in subsequent
  sections, which implements the look and feel of the control.</p> <!-- a binding -->



  <h4>The <code>hr</code> element</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

hr { color: gray; border-style: inset; border-width: 1px; margin: 0.5em auto; }</pre>

  <p>The following rules are also expected to apply, as <span>presentational hints</span>:</p>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

hr[align=left] { margin-left: 0; margin-right: auto; }
hr[align=right] { margin-left: auto; margin-right: 0; }
hr[align=center] { margin-left: auto; margin-right: auto; }
hr[color], hr[noshade] { border-style: solid; }</pre>

  <p>If an <code>hr</code> element has either a <code data-x="attr-hr-color">color</code> attribute
  or a <code data-x="attr-hr-noshade">noshade</code> attribute, and furthermore also has a <code
  data-x="attr-hr-size">size</code> attribute, and parsing that attribute's value using the
  <span>rules for parsing non-negative integers</span> doesn't generate an error, then the user
  agent is expected to use the parsed value divided by two as a pixel length for
  <span>presentational hints</span> for the properties 'border-top-width', 'border-right-width',
  'border-bottom-width', and 'border-left-width' on the element.</p>

  <p>Otherwise, if an <code>hr</code> element has neither a <code data-x="attr-hr-color">color</code>
  attribute nor a <code data-x="attr-hr-noshade">noshade</code> attribute, but does have a <code
  data-x="attr-hr-size">size</code> attribute, and parsing that attribute's value using the
  <span>rules for parsing non-negative integers</span> doesn't generate an error, then: if the
  parsed value is one, then the user agent is expected to use the attribute as a <span
  data-x="presentational hints">presentational hint</span> setting the element's
  'border-bottom-width' to 0; otherwise, if the parsed value is greater than one, then the user
  agent is expected to use the parsed value minus two as a pixel length for <span>presentational
  hints</span> for the 'height' property on the element.</p>

  <p>The <code data-x="attr-hr-width">width</code> attribute on an <code>hr</code> element <span>maps
  to the dimension property</span> 'width' on the element.</p>

  <p>When an <code>hr</code> element has a <code data-x="attr-hr-color">color</code> attribute, its
  value is expected to be parsed using the <span>rules for parsing a legacy color value</span>, and
  if that does not return an error, the user agent is expected to treat the attribute as a <span
  data-x="presentational hints">presentational hint</span> setting the element's 'color' property to
  the resulting color.</p>



  <h4>The <code>fieldset</code> and <code>legend</code> elements</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

fieldset {
  display: block;
  margin-left: 2px; margin-right: 2px;
  border: groove 2px ThreeDFace;
  padding: 0.35em 0.625em 0.75em;
  min-width: min-content;
}

legend {
  padding-left: 2px; padding-right: 2px;
}</pre>

  <p>The <code>fieldset</code> element is expected to establish a new block formatting context.</p>

  <p>If the <code>fieldset</code> element has a child that matches the conditions in the list below,
  then the first such child is the <code>fieldset</code> element's <dfn>rendered legend</dfn>:</p>

  <ul class="brief">

   <li>The child is a <code>legend</code> element.</li>

   <li>The child is not out-of-flow (e.g. not absolutely positioned or floated).</li>

   <li>The child is generating a box (e.g. it is not 'display:none').</li>

  </ul>

  <p>A <code>fieldset</code> element's <span>rendered legend</span>, if any, is expected to be
  rendered over the top border edge of the <code>fieldset</code> element as a 'block' box
  (overriding any explicit 'display' value). In the absence of an explicit width, the box should
  shrink-wrap. If the <code>legend</code> element in question has an <code
  data-x="attr-legend-align">align</code> attribute, and its value is an <span>ASCII
  case-insensitive</span> match for one of the strings in the first column of the following table,
  then the <code>legend</code> is expected to be rendered horizontally aligned over the border edge
  in the position given in the corresponding cell on the same row in the second column. If the
  attribute is absent or has a value that doesn't match any of the cases in the table, then the
  position is expected to be on the right if the 'direction' property on this element has a computed
  value of 'rtl', and on the left otherwise.</p>

  <table>
   <thead>
    <tr>
     <th>Attribute value
     <th>Alignment position
   <tbody>
    <tr>
     <td><code>left</code>
     <td>On the left
    <tr>
     <td><code>right</code>
     <td>On the right
    <tr>
     <td><code>center</code>
     <td>In the middle
  </table>


  <h3 id="replaced-elements">Replaced elements</h3>

  <h4 id="embedded-content-rendering-rules">Embedded content</h4>

  <p>The <code>embed</code>, <code>iframe</code>, and <code>video</code> elements are expected to be
  treated as <span data-x="replaced element">replaced elements</span>.</p>

  <p>A <code>canvas</code> element that <span>represents</span> <span>embedded content</span> is
  expected to be treated as a <span>replaced element</span>; the contents of such elements are the
  element's bitmap, if any, or else a transparent black bitmap with the same <span>intrinsic
  dimensions</span> as the element. Other <code>canvas</code> elements are expected to be treated
  as ordinary elements in the rendering model.</p>

  <p>An <code>object</code> element that <span>represents</span> an image, plugin, or <span>nested
  browsing context</span> is expected to be treated as a <span>replaced element</span>. Other
  <code>object</code> elements are expected to be treated as ordinary elements in the rendering
  model.</p>

  <p>An <code>applet</code> element that <span>represents</span> a <span>plugin</span> is expected
  to be treated as a <span>replaced element</span>. Other <code>applet</code> elements are expected
  to be treated as ordinary elements in the rendering model.</p>

  <p>The <code>audio</code> element, when it is <span data-x="expose a user interface to the
  user">exposing a user interface</span>, is expected to be treated as a
  <span>replaced element</span> about one line high, as wide as is necessary to expose the user
  agent's user interface features. When an <code>audio</code> element is not <span data-x="expose a
  user interface to the user">exposing a user interface</span>, the user agent is expected to force
  its 'display' property to compute to 'none', irrespective of CSS rules.</p>

  <p>Whether a <code>video</code> element is <span data-x="expose a user interface to the
  user">exposing a user interface</span> is not expected to affect the size of the rendering;
  controls are expected to be overlaid above the page content without causing any layout changes,
  and are expected to disappear when the user does not need them.</p>

  <p>When a <code>video</code> element represents a poster frame or frame of video, the poster frame
  or frame of video is expected to be rendered at the largest size that maintains the aspect ratio
  of that poster frame or frame of video without being taller or wider than the <code>video</code>
  element itself, and is expected to be centered in the <code>video</code> element.</p>

  <p>Any subtitles or captions are expected to be overlayed directly on top of their
  <code>video</code> element, as defined by the relevant rendering rules; for WebVTT, those are the
  <span>rules for updating the display of WebVTT text tracks</span>. <a href="#refsWEBVTT">\[WEBVTT]</a></p>

  <p>When the user agent starts <span data-x="expose a user interface to the user">exposing a user
  interface</span> for a <code>video</code> element, the user agent should run the <span>rules for
  updating the text track rendering</span> of each of the <span data-x="text track">text
  tracks</span> in the <code>video</code> element's <span>list of text tracks</span> that are <span
  data-x="text track showing">showing</span> and whose <span>text track kind</span> is one of <code
  data-x="dom-TextTrack-kind-subtitles">subtitles</code> or <code
  data-x="dom-TextTrack-kind-captions">captions</code> (e.g., for <span data-x="text track">text
  tracks</span> based on <span>WebVTT</span>, the <span>rules for updating the display of WebVTT
  text tracks</span>). <a href="#refsWEBVTT">\[WEBVTT]</a></p>

  <p class="note">Resizing <code>video</code> and <code>canvas</code> elements does not interrupt
  video playback or clear the canvas.</p>

  <hr>

  <p>The following CSS rules are expected to apply:</p>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

iframe:not([seamless]) { border: 2px inset; }
iframe[seamless] { display: block; }
<span id="video-object-fit">video { object-fit: contain; }</span></pre>


  <h4 id="images">Images</h4>

  <p>User agents are expected to render <code>img</code> elements and <code>input</code> elements
  whose <code data-x="attr-input-type">type</code> attributes are in the <span
  data-x="attr-input-type-image">Image Button</span> state, according to the first applicable rules
  from the following list:</p>

  <dl class="switch">


   <dt>If the element <span>represents</span> an image</dt>

   <dd>The user agent is expected to treat the element as a <span>replaced element</span> and
   render the image according to the rules for doing so defined in CSS.</dd>


   <dt>

    If the element does not <span data-x="represents">represent</span> an image, but the element
    already has <span>intrinsic dimensions</span> (e.g. from the <span>dimension attributes</span>
    or CSS rules), and either:

    <ul>

     <li>the user agent has reason to believe that the image will become <i
     data-x="img-available">available</i><!--input-img-available also--> and be rendered in due
     course, or

     <li>the element has no <code>alt</code> attribute<!-- attr-img-alt, attr-input-alt -->, or

     <li>the <code>Document</code> is in <span>quirks mode</span>

    </ul>

   </dt>

   <dd>The user agent is expected to treat the element as a <span>replaced element</span> whose
   content is the text that the element represents, if any, optionally alongside an icon indicating
   that the image is being obtained (if applicable). For <code>input</code> elements, the element
   is expected to appear button-like to indicate that the element is a <span
   data-x="concept-button">button</span>.</dd>


   <!-- no-quirks and limited-quirks modes only-->
   <dt>If the element is an <code>img</code> element that <span>represents</span> some text and the
   user agent does not expect this to change</dt>

   <dd>The user agent is expected to treat the element as a non-replaced phrasing element whose
   content is the text, optionally with an icon indicating that an image is missing, so that the
   user can request the image be displayed or investigate why it is not rendering. In non-graphical
   contexts, such an icon should be omitted.</dd>


   <!-- no-quirks and limited-quirks modes only-->
   <dt>If the element is an <code>img</code> element that <span>represents</span> nothing and the
   user agent does not expect this to change</dt>

   <dd>The user agent is expected to treat the element as an empty inline element. (In the absence
   of further styles, this will cause the element to essentially not be rendered.)</dd>


   <!-- no-quirks and limited-quirks modes only-->
   <dt>If the element is an <code>input</code> element that does not <span
   data-x="represents">represent</span> an image and the user agent does not expect this to change</dt>

   <dd>The user agent is expected to treat the element as a <span>replaced element</span>
   consisting of a button whose content is the element's alternative text. The <span>intrinsic
   dimensions</span> of the button are expected to be about one line in height and whatever width
   is necessary to render the text on one line.</dd>

  </dl>

  <p>The icons mentioned above are expected to be relatively small so as not to disrupt most text
  but be easily clickable. In a visual environment, for instance, icons could be 16 pixels by 16
  pixels square, or 1em by 1em if the images are scalable. In an audio environment, the icon could
  be a short bleep. The icons are intended to indicate to the user that they can be used to get to
  whatever options the UA provides for images, and, where appropriate, are expected to provide
  access to the context menu that would have come up if the user interacted with the actual
  image.</p>

  <hr>

  <p>All animated images with the same <span>absolute URL</span> and the same image data are
  expected to be rendered synchronized to the same timeline as a group, with the timeline starting
  at the time of the least recent addition to the group.</p>

  <p class="note">In other words, when a second image with the same <span>absolute URL</span> and
  animated image data is inserted into a document, it jumps to the point in the animation cycle that
  is currently being displayed by the first image.</p>

  <p>When a user agent is to <dfn>restart the animation</dfn> for an <code>img</code> element
  showing an animated image, all animated images with the same <span>absolute URL</span> and the
  same image data in that <code>img</code> element's <span>node document</span> are expected to restart
  their animation from the beginning.</p>

  <hr>

  <p>The following CSS rules are expected to apply when the <code>Document</code> is in <span>quirks
  mode</span>:</p>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

img[align=left i] { margin-right: 3px; }
img[align=right i] { margin-left: 3px; }</pre>

  </div>


  <div class="impl">

  <h4 id="attributes-for-embedded-content-and-images">Attributes for embedded content and images</h4>

  <p>The following CSS rules are expected to apply as <span>presentational hints</span>:</p>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

iframe[frameborder=0], iframe[frameborder=no i] { border: none; }

applet[align=left i], embed[align=left i], iframe[align=left i],
img[align=left i], input[type=image i][align=left i], object[align=left i] {
  float: left;
}

applet[align=right i], embed[align=right i], iframe[align=right i],
img[align=right i], input[type=image i][align=right i], object[align=right i] {
  float: right;
}

applet[align=top i], embed[align=top i], iframe[align=top i],
img[align=top i], input[type=image i][align=top i], object[align=top i] {
  vertical-align: top;
}

applet[align=baseline i], embed[align=baseline i], iframe[align=baseline i],
img[align=baseline i], input[type=image i][align=baseline i], object[align=baseline i] {
  vertical-align: baseline;
}

applet[align=texttop i], embed[align=texttop i], iframe[align=texttop i],
img[align=texttop i], input[type=image i][align=texttop i], object[align=texttop i] {
  vertical-align: text-top;
}

applet[align=absmiddle i], embed[align=absmiddle i], iframe[align=absmiddle i],
img[align=absmiddle i], input[type=image i][align=absmiddle i], object[align=absmiddle i],
applet[align=abscenter i], embed[align=abscenter i], iframe[align=abscenter i],
img[align=abscenter i], input[type=image i][align=abscenter i], object[align=abscenter i] {
  vertical-align: middle;
}

applet[align=bottom i], embed[align=bottom i], iframe[align=bottom i],
img[align=bottom i], input[type=image i][align=bottom i],
object[align=bottom i] {
  vertical-align: bottom;
}</pre>

  <p>When an <code>applet</code>, <code>embed</code>, <code>iframe</code>, <code>img</code>, or
  <code>object</code> element, or an <code>input</code> element whose <code
  data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-image">Image Button</span> state, has an <code>align</code>
  attribute whose value is an <span>ASCII case-insensitive</span> match for the string "<code
 >center</code>" or the string "<code>middle</code>", the user agent is expected
  to act as if the element's 'vertical-align' property was set to a value that aligns the vertical
  middle of the element with the parent element's baseline.</p>

  <p>The <code>hspace</code> attribute of <code>applet</code>, <code>embed</code>,
  <code>iframe</code>, <code>img</code>, or <code>object</code> elements, and <code>input</code>
  elements with a <code data-x="attr-input-type">type</code> attribute in the <span
  data-x="attr-input-type-image">Image Button</span> state, <span data-x="maps to the dimension
  property">maps to the dimension properties</span> 'margin-left' and 'margin-right' on the
  element.</p>

  <p>The <code>vspace</code> attribute of <code>applet</code>, <code>embed</code>,
  <code>iframe</code>, <code>img</code>, or <code>object</code> elements, and <code>input</code>
  elements with a <code data-x="attr-input-type">type</code> attribute in the <span
  data-x="attr-input-type-image">Image Button</span> state, <span data-x="maps to the dimension
  property">maps to the dimension properties</span> 'margin-top' and 'margin-bottom' on the
  element.</p>

  <p>When an <code>img</code> element, <code>object</code> element, or <code>input</code> element
  with a <code data-x="attr-input-type">type</code> attribute in the <span
  data-x="attr-input-type-image">Image Button</span> state has a <code
 >border</code> attribute whose value, when parsed using the <span>rules for
  parsing non-negative integers</span>, is found to be a number greater than zero, the user agent is
  expected to use the parsed value for eight <span>presentational hints</span>: four setting the
  parsed value as a pixel length for the element's 'border-top-width', 'border-right-width',
  'border-bottom-width', and 'border-left-width' properties, and four setting the element's
  'border-top-style', 'border-right-style', 'border-bottom-style', and 'border-left-style'
  properties to the value 'solid'.</p>

  <p id="dimRendering">The <code data-x="attr-dim-width">width</code> and <code
  data-x="attr-dim-height">height</code> attributes on <code>applet</code>, <code>embed</code>,
  <code>iframe</code>, <code>img</code>, <code>object</code> or <code>video</code> elements, and
  <code>input</code> elements with a <code data-x="attr-input-type">type</code> attribute in the
  <span data-x="attr-input-type-image">Image Button</span> state and that either represents an image
  or that the user expects will eventually represent an image, <span data-x="maps to the dimension
  property">map to the dimension properties</span> 'width' and 'height' on the element
  respectively.</p>

  </div>


  <div class="impl">

  <h4 id="image-maps">Image maps</h4>

  <p>Shapes on an <span>image map</span> are expected to act, for the purpose of the CSS cascade, as
  elements independent of the original <code>area</code> element that happen to match the same style
  rules but inherit from the <code>img</code> or <code>object</code> element.</p>

  <p>For the purposes of the rendering, only the 'cursor' property is expected to have any effect on
  the shape.</p>

  <p class="example">Thus, for example, if an <code>area</code> element has a <code
  data-x="attr-style">style</code> attribute that sets the 'cursor' property to 'help', then when the
  user designates that shape, the cursor would change to a Help cursor.</p>

  <p class="example">Similarly, if an <code>area</code> element had a CSS rule that set its 'cursor'
  property to 'inherit' (or if no rule setting the 'cursor' property matched the element at all),
  the shape's cursor would be inherited from the <code>img</code> or <code>object</code> element of
  the <span>image map</span>, not from the parent of the <code>area</code> element.</p>

  </div>


  <div class="impl">

  <h3 id="bindings">Bindings</h3> <!-- a binding -->

  <h4 id="introduction">Introduction</h4>

  <p>A number of elements have their rendering defined in terms of the 'binding' property. <a
  href="#refsBECSS">\[BECSS]</a></p>

  <p>The CSS snippets below set the 'binding' property to a user-agent-defined value, represented
  below by keywords like <code><i>button</i></code>. The rules then described for
  these bindings are only expected to apply if the element's 'binding' property has not been
  overridden (e.g. by the author) to have another value.</p>

  <p>Exactly how the bindings are implemented is not specified by this specification. User agents
  are encouraged to make their bindings set the 'appearance' CSS property appropriately to achieve
  platform-native appearances for widgets, and are expected to implement any relevant animations,
  etc, that are appropriate for the platform. <a href="#refsCSSUI">\[CSSUI]</a></p>

  </div>


  <div class="impl">

  <h4>The <code>button</code> element</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

button { binding: <i>button</i>; }</pre>

  <p>When the <i>button</i> binding applies to a <code>button</code> element, the element
  is expected to render as an 'inline-block' box rendered as a button whose contents are the
  contents of the element.</p>

  <p>When the <code>button</code> element's <code data-x="attr-button-type">type</code> attribute is
  in the <span data-x="attr-button-type-menu-state">Menu</span> state, the user agent is expected to
  indicate that activating the element will display a menu, e.g. by displaying a down-pointing
  triangle after the button's label.</p>

  </div>


  <div class="impl">

  <h4>The <code>details</code> element</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

details { binding: <i>details</i>; }</pre>

  <p>When the <i>details</i> binding applies to a <code>details</code> element, the element
  is expected to render as a 'block' box with its 'padding-left' property set to '40px' for
  left-to-right elements (<span>LTR-specific</span>) and with its 'padding-right' property set to
  '40px' for right-to-left elements. The element's shadow tree is expected to take the element's
  first child <code>summary</code> element, if any, and place it in a first 'block' box container,
  and then take the element's remaining descendants, if any, and place them in a second 'block' box
  container.</p>

  <p>The first container is expected to contain at least one line box, and that line box is expected
  to contain a disclosure widget (typically a triangle), horizontally positioned within the left
  padding of the <code>details</code> element. That widget is expected to allow the user to request
  that the details be shown or hidden.</p>

  <p>The second container is expected to have its 'overflow' property set to 'hidden'. When the
  <code>details</code> element does not have an <code data-x="attr-details-open">open</code>
  attribute, this second container is expected to be removed from the rendering.</p>

  <!-- http://mail.gnome.org/archives/usability/2006-June/msg00015.html -->

  </div>

  <div class="impl">

  <h4>The <code>input</code> element as a text entry widget</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

input { binding: <i>input-textfield</i>; }
input[type=password i] { binding: <i>input-password</i>; }
/* later rules override this for other values of type="" */</pre>

  <p>When the <i>input-textfield</i> binding applies to an <code>input</code> element whose
  <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-text">Text</span>, <span data-x="attr-input-type-search">Search</span>,
  <span data-x="attr-input-type-tel">Telephone</span>, <span data-x="attr-input-type-url">URL</span>,
  or <span data-x="attr-input-type-email">E-mail</span> state, the element is expected to render as
  an 'inline-block' box rendered as a text field.</p>

  <p>When the <i>input-password</i> binding applies to an <code>input</code> element whose
  <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-password">Password</span> state, the element is expected to render as an
  'inline-block' box rendered as a text field whose contents are obscured.</p>

  <p>If these text fields provide a text selection, then, when the user changes the currect
  selection in such a binding, the user agent is expected to <span>queue a task</span> to <span>fire
  a simple event</span> that bubbles named <code data-x="event-select">select</code> at the element,
  using the <span>user interaction task source</span> as the task source.</p>

  <p>If an <code>input</code> element whose <code data-x="attr-input-type">type</code> attribute is
  in one of the above states has a <code data-x="attr-input-size">size</code> attribute, and parsing
  that attribute's value using the <span>rules for parsing non-negative integers</span> doesn't
  generate an error, then the user agent is expected to use the attribute as a <span
  data-x="presentational hints">presentational hint</span> for the 'width' property on the element,
  with the value obtained from applying the <span>converting a character width to pixels</span>
  algorithm to the value of the attribute.</p>

  <p>If an <code>input</code> element whose <code data-x="attr-input-type">type</code> attribute is
  in one of the above states does <em>not</em> have a <code data-x="attr-input-size">size</code>
  attribute, then the user agent is expected to act as if it had a user-agent-level style sheet rule
  setting the 'width' property on the element to the value obtained from applying the
  <span>converting a character width to pixels</span> algorithm to the number 20.</p>

  <p>The <dfn>converting a character width to pixels</dfn> algorithm returns <span>(<var>size</var>-1)&times;<var>avg</var>&nbsp;+&nbsp;<var>max</var></span>,
  where <var>size</var> is the character width to convert, <var>avg</var> is the
  average character width of the primary font for the element for which the algorithm is being run,
  in pixels, and <var>max</var> is the maximum character width of that same font, also in
  pixels. (The element's 'letter-spacing' property does not affect the result.)</p>

  <p>When the <i>input-textfield</i> binding applies to an element, the 'line-height'
  property, if it has a computed value equivalent to a value that is less than 1.0, must have a used
  value of 1.0.</p>

  </div>


  <div class="impl">

  <h4>The <code>input</code> element as domain-specific widgets</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

input[type=datetime i] { binding: <i>input-datetime</i>; }
input[type=date i] { binding: <i>input-date</i>; }
input[type=month i] { binding: <i>input-month</i>; }
input[type=week i] { binding: <i>input-week</i>; }
input[type=time i] { binding: <i>input-time</i>; }
input[type=datetime-local i] { binding: <i>input-datetime-local</i>; }
input[type=number i] { binding: <i>input-number</i>; }</pre>

  <p>When the <i>input-datetime</i> binding applies to an <code>input</code> element whose
  <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-datetime">Date and Time</span> state, the element is expected to render as
  an 'inline-block' box depicting a Date and Time control.</p>

  <p>When the <i>input-date</i> binding applies to an <code>input</code> element whose
  <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-date">Date</span> state, the element is expected to render as an
  'inline-block' box depicting a Date control.</p>

  <p>When the <i>input-month</i> binding applies to an <code>input</code> element whose
  <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-month">Month</span> state, the element is expected to render as an
  'inline-block' box depicting a Month control.</p>

  <p>When the <i>input-week</i> binding applies to an <code>input</code> element whose
  <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-week">Week</span> state, the element is expected to render as an
  'inline-block' box depicting a Week control.</p>

  <p>When the <i>input-time</i> binding applies to an <code>input</code> element whose
  <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-time">Time</span> state, the element is expected to render as an
  'inline-block' box depicting a Time control.</p>

  <p>When the <i>input-datetime-local</i> binding applies to an <code>input</code> element
  whose <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-datetime-local">Local Date and Time</span> state, the element is expected
  to render as an 'inline-block' box depicting a Local Date and Time control.</p>

  <p>When the <i>input-number</i> binding applies to an <code>input</code> element whose
  <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-number">Number</span> state, the element is expected to render as an
  'inline-block' box depicting a Number control.</p>

  <p>These controls are all expected to be about one line high, and about as wide as necessary to
  show the widest possible value.</p>

  </div>


  <div class="impl">

  <h4>The <code>input</code> element as a range control</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

input[type=range i] { binding: <i>input-range</i>; }</pre>

  <p>When the <i>input-range</i> binding applies to an <code>input</code> element whose
  <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-range">Range</span> state, the element is expected to render as an
  'inline-block' box depicting a slider control.</p>

  <p>When the control is wider than it is tall (or square), the control is expected to be a
  horizontal slider, with the lowest value on the right if the 'direction' property on this element
  has a computed value of 'rtl', and on the left otherwise. When the control is taller than it is
  wide, it is expected to be a vertical slider, with the lowest value on the bottom.</p>

  <p>Predefined suggested values (provided by the <code data-x="attr-input-list">list</code>
  attribute) are expected to be shown as tick marks on the slider, which the slider can snap to.</p>

  <p>User agents are expected to use the used value of the 'direction' property on the element to
  determine the direction in which the slider operates. Typically, a left-to-right ('ltr')
  horizontal control would have the lowest value on the left and the highest value on the right, and
  vice versa.</p>

  </div>


  <div class="impl">

  <h4>The <code>input</code> element as a color well</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

input[type=color i] { binding: <i>input-color</i>; }</pre>

  <p>When the <i>input-color</i> binding applies to an <code>input</code> element whose
  <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-color">Color</span> state, the element is expected to render as an
  'inline-block' box depicting a color well, which, when activated, provides the user with a color
  picker (e.g. a color wheel or color palette) from which the color can be changed.</p>

  <p>Predefined suggested values (provided by the <code data-x="attr-input-list">list</code>
  attribute) are expected to be shown in the color picker interface, not on the color well
  itself.</p>

  </div>


  <div class="impl">

  <h4>The <code>input</code> element as a checkbox and radio button widgets</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

input[type=checkbox i] { binding: <i>input-checkbox</i>; }
input[type=radio i] { binding: <i>input-radio</i>; }</pre>

  <p>When the <i>input-checkbox</i> binding applies to an <code>input</code> element whose
  <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-checkbox">Checkbox</span> state, the element is expected to render as an
  'inline-block' box containing a single checkbox control, with no label.</p>

  <p>When the <i>input-radio</i> binding applies to an <code>input</code> element whose
  <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-radio">Radio Button</span> state, the element is expected to render as an
  'inline-block' box containing a single radio button control, with no label.</p>

  </div>


  <div class="impl">

  <h4>The <code>input</code> element as a file upload control</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

input[type=file i] { binding: <i>input-file</i>; }</pre>

  <p>When the <i>input-file</i> binding applies to an <code>input</code> element whose
  <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-file">File Upload</span> state, the element is expected to render as an
  'inline-block' box containing a span of text giving the file name(s) of the <span
  data-x="concept-input-type-file-selected">selected files</span>, if any, followed by a button that,
  when activated, provides the user with a file picker from which the selection can be changed.</p>

  </div>


  <div class="impl">

  <h4>The <code>input</code> element as a button</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

input[type=submit i], input[type=reset i], input[type=button i] {
  binding: <i>input-button</i>;
}</pre>

  <p>When the <i>input-button</i> binding applies to an <code>input</code> element whose
  <code data-x="attr-input-type">type</code> attribute is in the <span
  data-x="attr-input-type-submit">Submit Button</span>, <span data-x="attr-input-type-reset">Reset
  Button</span>, or <span data-x="attr-input-type-button">Button</span> state, the element is
  expected to render as an 'inline-block' box rendered as a button, about one line high, containing
  the contents of the element's <code data-x="attr-input-value">value</code> attribute, if any, or
  text derived from the element's <code data-x="attr-input-type">type</code> attribute in a
  user-agent-defined (and probably locale-specific) fashion, if not.</p>

  </div>


  <div class="impl">

  <h4>The <code>marquee</code> element</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

marquee { binding: <i>marquee</i>; }</pre>

  <p>When the <i>marquee</i> binding applies to a <code>marquee</code> element, while the
  element is <span data-x="concept-marquee-on">turned on</span>, the element is expected to render in
  an animated fashion according to its attributes as follows:</p>

  <dl>

   <dt>If the element's <code data-x="attr-marquee-behavior">behavior</code> attribute is in the
   <span data-x="attr-marquee-behavior-scroll">scroll</span> state</dt>

   <dd>

    <p>Slide the contents of the element in the direction described by the <code
    data-x="attr-marquee-direction">direction</code> attribute as defined below, such that it begins
    off the start side of the <code>marquee</code>, and ends flush with the inner end side.</p>

    <p class="example">For example, if the <code data-x="attr-marquee-direction">direction</code>
    attribute is <span data-x="attr-marquee-direction-left">left</span> (the default), then the
    contents would start such that their left edge are off the side of the right edge of the
    <code>marquee</code>'s content area, and the contents would then slide up to the point where the
    left edge of the contents are flush with the left inner edge of the <code>marquee</code>'s
    content area.</p>

    <p>Once the animation has ended, the user agent is expected to <span>increment the marquee
    current loop index</span>. If the element is still <span data-x="concept-marquee-on">turned
    on</span> after this, then the user agent is expected to restart the animation.</p>

   </dd>

   <dt>If the element's <code data-x="attr-marquee-behavior">behavior</code> attribute is in the
   <span data-x="attr-marquee-behavior-slide">slide</span> state</dt>

   <dd>

    <p>Slide the contents of the element in the direction described by the <code
    data-x="attr-marquee-direction">direction</code> attribute as defined below, such that it begins
    off the start side of the <code>marquee</code>, and ends off the end side of the
    <code>marquee</code>.</p>

    <p class="example">For example, if the <code data-x="attr-marquee-direction">direction</code>
    attribute is <span data-x="attr-marquee-direction-left">left</span> (the default), then the
    contents would start such that their left edge are off the side of the right edge of the
    <code>marquee</code>'s content area, and the contents would then slide up to the point where the
    <em>right</em> edge of the contents are flush with the left inner edge of the
    <code>marquee</code>'s content area.</p>

    <p>Once the animation has ended, the user agent is expected to <span>increment the marquee
    current loop index</span>. If the element is still <span data-x="concept-marquee-on">turned
    on</span> after this, then the user agent is expected to restart the animation.</p>

   </dd>

   <dt>If the element's <code data-x="attr-marquee-behavior">behavior</code> attribute is in the
   <span data-x="attr-marquee-behavior-alternate">alternate</span> state</dt>

   <dd>

    <p>When the <span>marquee current loop index</span> is even (or zero), slide the contents of the
    element in the direction described by the <code data-x="attr-marquee-direction">direction</code>
    attribute as defined below, such that it begins flush with the start side of the
    <code>marquee</code>, and ends flush with the end side of the <code>marquee</code>.</p>

    <p>When the <span>marquee current loop index</span> is odd, slide the contents of the element in
    the opposite direction than that described by the <code
    data-x="attr-marquee-direction">direction</code> attribute as defined below, such that it begins
    flush with the end side of the <code>marquee</code>, and ends flush with the start side of the
    <code>marquee</code>.</p>

    <p class="example">For example, if the <code data-x="attr-marquee-direction">direction</code>
    attribute is <span data-x="attr-marquee-direction-left">left</span> (the default), then the
    contents would with their right edge flush with the right inner edge of the
    <code>marquee</code>'s content area, and the contents would then slide up to the point where the
    <em>left</em> edge of the contents are flush with the left inner edge of the
    <code>marquee</code>'s content area.</p>

    <p>Once the animation has ended, the user agent is expected to <span>increment the marquee
    current loop index</span>. If the element is still <span data-x="concept-marquee-on">turned
    on</span> after this, then the user agent is expected to continue the animation.</p>

   </dd>

  </dl>

  <p>The <code data-x="attr-marquee-direction">direction</code> attribute has the meanings described
  in the following table:</p>

  <table>
   <thead>
    <tr>
     <th><code data-x="attr-marquee-direction">direction</code> attribute state
     <th>Direction of animation
     <th>Start edge
     <th>End edge
     <th>Opposite direction
   <tbody>
    <tr>
     <td><span data-x="attr-marquee-direction-left">left</span>
     <td>&larr; Right to left
     <td>Right
     <td>Left
     <td>&rarr; Left to Right
    <tr>
     <td><span data-x="attr-marquee-direction-right">right</span>
     <td>&rarr; Left to Right
     <td>Left
     <td>Right
     <td>&larr; Right to left
    <tr>
     <td><span data-x="attr-marquee-direction-up">up</span>
     <td>&uarr; Up (Bottom to Top)
     <td>Bottom
     <td>Top
     <td>&darr; Down (Top to Bottom)
    <tr>
     <td><span data-x="attr-marquee-direction-down">down</span>
     <td>&darr; Down (Top to Bottom)
     <td>Top
     <td>Bottom
     <td>&uarr; Up (Bottom to Top)
  </table>

  <p>In any case, the animation should proceed such that there is a delay given by the <span>marquee
  scroll interval</span> between each frame, and such that the content moves at most the distance
  given by the <span>marquee scroll distance</span> with each frame.</p>

  <p>When a <code>marquee</code> element has a <code undefined data-x="attr-marquee-bgcolor">bgcolor</code>
  attribute set, the value is expected to be parsed using the <span>rules for parsing a legacy color
  value</span>, and if that does not return an error, the user agent is expected to treat the
  attribute as a <span data-x="presentational hints">presentational hint</span> setting the element's
  'background-color' property to the resulting color.</p>

  <p>The <code undefined data-x="attr-marquee-width">width</code> and <code
  undefined data-x="attr-marquee-height">height</code> attributes on a <code>marquee</code> element <span
  data-x="maps to the dimension property">map to the dimension properties</span> 'width' and 'height'
  on the element respectively.</p>

  <p>The <span>intrinsic height</span> of a <code>marquee</code> element with its <code
  data-x="attr-marquee-direction">direction</code> attribute in the <span
  data-x="attr-marquee-direction-up">up</span> or <span
  data-x="attr-marquee-direction-down">down</span> states is 200 CSS pixels.</p>

  <p>The <code undefined data-x="attr-marquee-vspace">vspace</code> attribute of a <code>marquee</code> element
  <span data-x="maps to the dimension property">maps to the dimension properties</span> 'margin-top'
  and 'margin-bottom' on the element. The <code undefined data-x="attr-marquee-hspace">hspace</code> attribute
  of a <code>marquee</code> element <span data-x="maps to the dimension property">maps to the
  dimension properties</span> 'margin-left' and 'margin-right' on the element.</p>

  <p>The 'overflow' property on the <code>marquee</code> element is expected to be ignored; overflow
  is expected to always be hidden.</p>

  </div>


  <div class="impl">

  <h4>The <code>meter</code> element</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

meter { binding: <i>meter</i>; }</pre>

  <p>When the <i>meter</i> binding applies to a <code>meter</code> element, the element is
  expected to render as an 'inline-block' box with a 'height' of '1em' and a 'width' of '5em', a
  'vertical-align' of '-0.2em', and with its contents depicting a gauge.</p>

  <p>When the element is wider than it is tall (or square), the depiction is expected to be of a
  horizontal gauge, with the minimum value on the right if the 'direction' property on this element
  has a computed value of 'rtl', and on the left otherwise. When the element is taller than it is
  wide, it is expected to depict a vertical gauge, with the minimum value on the bottom.</p>

  <p>User agents are expected to use a presentation consistent with platform conventions for gauges,
  if any.</p>

  <p class="note">Requirements for what must be depicted in the gauge are included in the definition
  of the <code>meter</code> element.</p>

  </div>


  <div class="impl">

  <h4>The <code>progress</code> element</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

progress { binding: <i>progress</i>; }</pre>

  <p>When the <i>progress</i> binding applies to a <code>progress</code> element, the
  element is expected to render as an 'inline-block' box with a 'height' of '1em' and a 'width' of
  '10em', and a 'vertical-align' of '-0.2em'.</p>

  <!-- http://software.hixie.ch/utilities/js/canvas/?c.clearRect(0%2C%200%2C%20640%2C%20480)%3B%0Ac.save()%3B%0Atry%20{%0A%20%20c.fillStyle%20%3D%20'black'%3B%0A%20%20c.font%20%3D%20'8px%20sans-serif'%3B%0A%20%20c.fillText('Wide'%2C%2043%2C105)%3B%0A%20%20c.fillText('Tall'%2C%20100%2C105)%3B%0A%20%20c.fillText('Square'%2C%20128%2C105)%3B%0A%20%20c.font%20%3D%20'700%2010px%20sans-serif'%3B%0A%20%20c.fillText('Progress%20Bars'%2C%2013%2C30)%3B%0A%20%20c.font%20%3D%20'100%2010px%20sans-serif'%3B%0A%20%20c.fillText('(80%25)'%2C%2037%2C45)%3B%0A%20%20c.beginPath()%3B%0A%20%20var%20g%20%3D%20c.createLinearGradient(10%2C0%2C80%2C0)%3B%0A%20%20g.addColorStop(0%2C%20'%2300FF00')%3B%0A%20%20g.addColorStop(0.8%2C%20'%2300FF00')%3B%0A%20%20g.addColorStop(0.9%2C%20'%23FFFF00')%3B%0A%20%20c.fillStyle%20%3D%20g%3B%0A%20%20c.rect(10%2C80%2C80%2C15)%3B%0A%20%20c.fill()%3B%0A%20%20c.strokeStyle%20%3D%20'black'%3B%0A%20%20c.stroke()%3B%0A%20%20c.beginPath()%3B%0A%20%20var%20g%20%3D%20c.createLinearGradient(0%2C80%2C0%2C20)%3B%0A%20%20g.addColorStop(0%2C%20'%2300FF00')%3B%0A%20%20g.addColorStop(0.75%2C%20'%2300FF00')%3B%0A%20%20g.addColorStop(0.85%2C%20'%23FFFF00')%3B%0A%20%20c.fillStyle%20%3D%20g%3B%0A%20%20c.rect(100%2C15%2C15%2C80)%3B%0A%20%20c.fill()%3B%0A%20%20c.strokeStyle%20%3D%20'black'%3B%0A%20%20c.stroke()%3B%0A%0A%20%20c.beginPath()%3B%0A%20%20c.fillStyle%20%3D%20'yellow'%3B%0A%20%20c.arc(140%2C80%2C15%2C0%2C2*Math.PI%2C%20true)%3B%0A%20%20c.fill()%3B%0A%20%20c.beginPath()%3B%0A%20%20c.fillStyle%20%3D%20'lime'%3B%0A%20%20c.moveTo(140%2C80)%3B%0A%20%20c.arc(140%2C80%2C15%2C-Math.PI%2F2%2C1.2*Math.PI%2C%20false)%3B%0A%20%20c.fill()%3B%0A%20%20c.beginPath()%3B%0A%20%20c.arc(140%2C80%2C15%2C0%2C2*Math.PI%2C%20true)%3B%0A%20%20c.strokeStyle%20%3D%20'black'%3B%0A%20%20c.stroke()%3B%0A}%20finally%20{%0A%20%20c.restore()%3B%0A}%0A -->

  <p> <img class="extra" src="images/sample-progress.png" alt="" width=157 height=103> When the
  element is wider than it is tall, the element is expected to be depicted as a horizontal progress
  bar, with the start on the right and the end on the left if the 'direction' property on this
  element has a computed value of 'rtl', and with the start on the left and the end on the right
  otherwise. When the element is taller than it is wide, it is expected to depicted as a vertical
  progress bar, with the lowest value on the bottom. When the element is square, it is expected to
  be depicted as a direction-independent progress widget (e.g. a circular progress ring).</p>

  <p>User agents are expected to use a presentation consistent with platform conventions for
  progress bars. In particular, user agents are expected to use different presentations for
  determinate and indeterminate progress bars. User agents are also expected to vary the
  presentation based on the dimensions of the element.</p>

  <p class="example">For example, on some platforms for showing indeterminate progress there is a
  "spinner" progress indicator with square dimensions, which could be used when the element is
  square, and an indeterminate progress bar, which could be used when the element is wide.</p>

  <p class="note">Requirements for how to determine if the progress bar is determinate or
  indeterminate, and what progress a determinate progress bar is to show, are included in the
  definition of the <code>progress</code> element.</p>

  </div>


  <div class="impl">

  <h4>The <code>select</code> element</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

select { binding: <i>select</i>; }</pre>

  <p>When the <i>select</i> binding applies to a <code>select</code> element whose <code
  data-x="attr-select-multiple">multiple</code> attribute is present, the element is expected to
  render as a multi-select list box.</p>

  <p>When the <i>select</i> binding applies to a <code>select</code> element whose <code
  data-x="attr-select-multiple">multiple</code> attribute is absent, and the element's <span
  data-x="concept-select-size">display size</span> is greater than 1, the element is expected to
  render as a single-select list box.</p>

  <p>When the element renders as a list box, it is expected to render as an 'inline-block' box whose
  'height' is the height necessary to contain as many rows for items as given by the element's <span
  data-x="concept-select-size">display size</span>, or four rows if the attribute is absent, and
  whose 'width' is the <span>width of the <code>select</code>'s labels</span> plus the width of a
  scrollbar.</p>

  <p>When the <i>select</i> binding applies to a <code>select</code> element whose <code
  data-x="attr-select-multiple">multiple</code> attribute is absent, and the element's <span
  data-x="concept-select-size">display size</span> is 1, the element is expected to render as a
  one-line drop down box whose width is the <span>width of the <code>select</code>'s
  labels</span>.</p>

  <p>In either case (list box or drop-down box), the element's items are expected to be the
  element's <span data-x="concept-select-option-list">list of options</span>, with the element's
  <code>optgroup</code> element children providing headers for groups of options where
  applicable.</p>

  <p>An <code>optgroup</code> element is expected to be rendered by displaying the element's <code
  data-x="attr-optgroup-label">label</code> attribute.</p>

  <p>An <code>option</code> element is expected to be rendered by displaying the element's <span
  data-x="concept-option-label">label</span>, indented under its <code>optgroup</code> element if it
  has one.</p>

  <p>The <dfn>width of the <code>select</code>'s labels</dfn> is the wider of the width necessary to
  render the widest <code>optgroup</code>, and the width necessary to render the widest
  <code>option</code> element in the element's <span data-x="concept-select-option-list">list of
  options</span> (including its indent, if any).</p>

  <p>If a <code>select</code> element contains a <span>placeholder label option</span>, the user
  agent is expected to render that <code>option</code> in a manner that conveys that it is a label,
  rather than a valid option of the control. This can include preventing the <span>placeholder label
  option</span> from being explicitly selected by the user. When the <span>placeholder label
  option</span>'s <span data-x="concept-option-selectedness">selectedness</span> is true, the control
  is expected to be displayed in a fashion that indicates that no valid option is currently
  selected.</p>

  <p>User agents are expected to render the labels in a <code>select</code> in such a manner that
  any alignment remains consistent whether the label is being displayed as part of the page or in a
  menu control.</p>

  </div>


  <div class="impl">

  <h4>The <code>textarea</code> element</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

textarea { binding: <i>textarea</i>; white-space: pre-wrap; }</pre>

  <p>When the <i>textarea</i> binding applies to a <code>textarea</code> element, the
  element is expected to render as an 'inline-block' box rendered as a multiline text field. If this
  text field provides a selection, then, when the user changes the currect selection in such a
  binding, the user agent is expected to <span>queue a task</span> to <span>fire a simple
  event</span> that bubbles named <code data-x="event-select">select</code> at the element, using
  the <span>user interaction task source</span> as the task source.</p>

  <p>If the element has a <code data-x="attr-textarea-cols">cols</code> attribute, and parsing that
  attribute's value using the <span>rules for parsing non-negative integers</span> doesn't generate
  an error, then the user agent is expected to use the attribute as a <span data-x="presentational
  hints">presentational hint</span> for the 'width' property on the element, with the value being
  the <span>textarea effective width</span> (as defined below). Otherwise, the user agent is
  expected to act as if it had a user-agent-level style sheet rule setting the 'width' property on
  the element to the <span>textarea effective width</span>.</p>

  <p>The <dfn>textarea effective width</dfn> of a <code>textarea</code> element is <span
 ><var>size</var>&times;<var>avg</var>&nbsp;+&nbsp;<var>sbw</var></span>, where <var>size</var> is the element's <span
  data-x="attr-textarea-cols-value">character width</span>, <var>avg</var> is the average
  character width of the primary font of the element, in CSS pixels, and <var>sbw</var> is
  the width of a scroll bar, in CSS pixels. (The element's 'letter-spacing' property does not affect
  the result.)</p>

  <p>If the element has a <code data-x="attr-textarea-rows">rows</code> attribute, and parsing that
  attribute's value using the <span>rules for parsing non-negative integers</span> doesn't generate
  an error, then the user agent is expected to use the attribute as a <span data-x="presentational
  hints">presentational hint</span> for the 'height' property on the element, with the value being
  the <span>textarea effective height</span> (as defined below). Otherwise, the user agent is
  expected to act as if it had a user-agent-level style sheet rule setting the 'height' property on
  the element to the <span>textarea effective height</span>.</p>

  <p>The <dfn>textarea effective height</dfn> of a <code>textarea</code> element is the height in
  CSS pixels of the number of lines specified the element's <span
  data-x="attr-textarea-rows-value">character height</span>, plus the height of a scrollbar in CSS
  pixels.</p>

  <p>User agents are expected to apply the 'white-space' CSS property to <code>textarea</code>
  elements. For historical reasons, if the element has a <code
  data-x="attr-textarea-wrap">wrap</code> attribute whose value is an <span>ASCII
  case-insensitive</span> match for the string "<code data-x="attr-textarea-wrap-off"
  undefined>off</code>", then the user agent is expected to treat the attribute as a <span
  data-x="presentational hints">presentational hint</span> setting the element's 'white-space'
  property to 'pre'.</p>

  </div>


  <div class="impl">

  <h4>The <code>keygen</code> element</h4>

  <pre class="css">@namespace url(http://www.w3.org/1999/xhtml);

keygen { binding: <i>keygen</i>; }</pre>

  <p>When the <i>keygen</i> binding applies to a <code>keygen</code> element, the element
  is expected to render as an 'inline-block' box containing a user interface to configure the key
  pair to be generated.</p>

  </div>



  <div class="impl">

  <h3 id="frames-and-framesets">Frames and framesets</h3>

  <p>User agent are expected to render <code>frameset</code> elements as a box with the height and
  width of the viewport, with a surface rendered according to the following layout algorithm:</p>

  <ol>

   <li>

    <p>The <var>cols</var> and <var>rows</var> variables are lists of zero or more pairs consisting
    of a number and a unit, the unit being one of <i>percentage</i>, <i>relative</i>, and
    <i>absolute</i>.</p>

    <p>Use the <span>rules for parsing a list of dimensions</span> to parse the value of the
    element's <code undefined data-x="attr-frameset-cols">cols</code> attribute, if there is one.
    Let <var>cols</var> be the result, or an empty list if there is no such attribute.</p>

    <p>Use the <span>rules for parsing a list of dimensions</span> to parse the value of the
    element's <code undefined data-x="attr-frameset-rows">rows</code> attribute, if there is one.
    Let <var>rows</var> be the result, or an empty list if there is no such attribute.</p>

   </li>

   <li>

    <p>For any of the entries in <var>cols</var> or <var>rows</var> that have the number zero and
    the unit <i>relative</i>, change the entry's number to one.</p>

   </li>

   <li>

    <p>If <var>cols</var> has no entries, then add a single entry consisting of the value 1 and the
    unit <i>relative</i> to <var>cols</var>.</p>

    <p>If <var>rows</var> has no entries, then add a single entry consisting of the value 1 and the
    unit <i>relative</i> to <var>rows</var>.</p>

   </li>

   <li>

    <p>Invoke the algorithm defined below to <span>convert a list of dimensions to a list of pixel
    values</span> using <var>cols</var> as the input list, and the width of the surface that the
    <code>frameset</code> is being rendered into, in CSS pixels, as the input dimension. Let
    <var>sized cols</var> be the resulting list.</p>

    <p>Invoke the algorithm defined below to <span>convert a list of dimensions to a list of pixel
    values</span> using <var>rows</var> as the input list, and the height of the surface that the
    <code>frameset</code> is being rendered into, in CSS pixels, as the input dimension. Let
    <var>sized rows</var> be the resulting list.</p>

   </li>

   <li>

    <p>Split the surface into a grid of <span><var>w</var>&times;<var>h</var></span>
    rectangles, where <var>w</var> is the number of entries in <var>sized cols</var> and
    <var>h</var> is the number of entries in <var>sized rows</var>.</p>

    <p>Size the columns so that each column in the grid is as many CSS pixels wide as the
    corresponding entry in the <var>sized cols</var> list.</p>

    <p>Size the rows so that each row in the grid is as many CSS pixels high as the corresponding
    entry in the <var>sized rows</var> list.</p>

   </li>

   <li>

    <p>Let <var>children</var> be the list of <code>frame</code> and <code>frameset</code> elements
    that are children of the <code>frameset</code> element for which the algorithm was invoked.</p>

   </li>

   <li>

    <p>For each row of the grid of rectangles created in the previous step, from top to bottom, run
    these substeps:</p>

    <ol>

     <li>

      <p>For each rectangle in the row, from left to right, run these substeps:</p>

      <ol>

       <li>

        <p>If there are any elements left in <var>children</var>, take the first element in the
        list, and assign it to the rectangle.</p>

        <p>If this is a <code>frameset</code> element, then recurse the entire <code>frameset</code>
        layout algorithm for that <code>frameset</code> element, with the rectangle as the
        surface.</p>

        <p>Otherwise, it is a <code>frame</code> element; render its <span>nested browsing
        context</span>, positoned and sized to fit the rectangle.</p>

       </li>

       <li>

        <p>If there are any elements left in <var>children</var>, remove the first element from
        <var>children</var>.</p>

       </li>

      </ol>

     </li>

    </ol>

   </li>

   <li>

    <p>If the <code>frameset</code> element <span>has a border</span>, draw an outer set of borders
    around the rectangles, using the element's <span>frame border color</span>.</p>

    <p>For each rectangle, if there is an element assigned to that rectangle, and that element
    <span>has a border</span>, draw an inner set of borders around that rectangle, using the
    element's <span>frame border color</span>.</p>

    <p>For each (visible) border that does not abut a rectangle that is assigned a
    <code>frame</code> element with a <code undefined data-x="attr-frame-noresize">noresize</code>
    attribute (including rectangles in further nested <code>frameset</code> elements), the user
    agent is expected to allow the user to move the border, resizing the rectangles within, keeping
    the proportions of any nested <code>frameset</code> grids.</p>

    <p>A <code>frameset</code> or <code>frame</code> element <dfn>has a border</dfn> if the
    following algorithm returns true:</p>

    <ol>

     <li><p>If the element has a <code>frameborder</code> attribute whose value is not the
     empty string and whose first character is either a U+0031 DIGIT ONE (1) character, a U+0079
     LATIN SMALL LETTER Y character (y), or a U+0059 LATIN CAPITAL LETTER Y character (Y), then
     return true.</p></li>

     <li><p>Otherwise, if the element has a <code>frameborder</code> attribute, return
     false.</p></li>

     <li><p>Otherwise, if the element has a parent element that is a <code>frameset</code> element,
     then return true if <em>that</em> element <span>has a border</span>, and false if it does
     not.</p></li>

     <li><p>Otherwise, return true.</p></li>

    </ol>

    <p>The <dfn>frame border color</dfn> of a <code>frameset</code> or <code>frame</code> element
    is the color obtained from the following algorithm:</p>

    <ol>

     <li><p>If the element has a <code>bordercolor</code> attribute, and applying the
     <span>rules for parsing a legacy color value</span> to that attribute's value does not result
     in an error, then return the color so obtained.</p></li>

     <li><p>Otherwise, if the element has a parent element that is a <code>frameset</code> element,
     then return the <span>frame border color</span> of that element.</p>

     <li><p>Otherwise, return gray.</p></li>

    </ol>

   </li>

  </ol>

  <p>The algorithm to <dfn>convert a list of dimensions to a list of pixel values</dfn> consists of
  the following steps:</p>

  <ol>

   <li>

    <p>Let <var>input list</var> be the list of numbers and units passed to the algorithm.</p>

    <p>Let <var>output list</var> be a list of numbers the same length as <var>input list</var>, all
    zero.</p>

    <p>Entries in <var>output list</var> correspond to the entries in <var>input list</var> that
    have the same position.</p>

   </li>

   <li><p>Let <var>input dimension</var> be the size passed to the algorithm.</p>

   <li>

    <p>Let <var>count percentage</var> be the number of entries in <var>input list</var> whose unit
    is <i>percentage</i>.</p>

    <p>Let <var>total percentage</var> be the sum of all the numbers in <var>input list</var> whose
    unit is <i>percentage</i>.</p>

    <p>Let <var>count relative</var> be the number of entries in <var>input list</var> whose unit is
    <i>relative</i>.</p>

    <p>Let <var>total relative</var> be the sum of all the numbers in <var>input list</var> whose
    unit is <i>relative</i>.</p>

    <p>Let <var>count absolute</var> be the number of entries in <var>input list</var> whose unit is
    <i>absolute</i>.</p>

    <p>Let <var>total absolute</var> be the sum of all the numbers in <var>input list</var> whose
    unit is <i>absolute</i>.</p>

    <p>Let <var>remaining space</var> be the value of <var>input dimension</var>.</p>

   </li>

   <li>

    <p>If <var>total absolute</var> is greater than <var>remaining space</var>, then for each entry
    in <var>input list</var> whose unit is <i>absolute</i>, set the corresponding value in
    <var>output list</var> to the number of the entry in <var>input list</var> multiplied by
    <var>remaining space</var> and divided by <var>total absolute</var>. Then, set <var>remaining
    space</var> to zero.</p>

    <p>Otherwise, for each entry in <var>input list</var> whose unit is <i>absolute</i>, set the
    corresponding value in <var>output list</var> to the number of the entry in <var>input
    list</var>. Then, decrement <var>remaining space</var> by <var>total absolute</var>.</p>

   </li>

   <li>

    <p>If <var>total percentage</var> multiplied by the <var>input dimension</var> and divided by
    100 is greater than <var>remaining space</var>, then for each entry in <var>input list</var>
    whose unit is <i>percentage</i>, set the corresponding value in <var>output list</var> to the
    number of the entry in <var>input list</var> multiplied by <var>remaining space</var> and
    divided by <var>total percentage</var>. Then, set <var>remaining space</var> to zero.</p>

    <p>Otherwise, for each entry in <var>input list</var> whose unit is <i>percentage</i>, set the
    corresponding value in <var>output list</var> to the number of the entry in <var>input
    list</var> multiplied by the <var>input dimension</var> and divided by 100. Then, decrement
    <var>remaining space</var> by <var>total percentage</var> multiplied by the <var>input
    dimension</var> and divided by 100.</p>

   </li>

   <li>

    <p>For each entry in <var>input list</var> whose unit is <i>relative</i>, set the corresponding
    value in <var>output list</var> to the number of the entry in <var>input list</var> multiplied
    by <var>remaining space</var> and divided by <var>total relative</var>.</p>

   </li>

   <li><p>Return <var>output list</var>.</p></li>

  </ol>

  <p>User agents working with integer values for frame widths (as opposed to user agents that can
  lay frames out with subpixel accuracy) are expected to distribute the remainder first to the last
  entry whose unit is <i>relative</i>, then equally (not proportionally) to each entry whose unit is
  <i>percentage</i>, then equally (not proportionally) to each entry whose unit is <i>absolute</i>,
  and finally, failing all else, to the last entry.</p>

  <hr>

<!--
  <p>The user agent is expected to force the 'display' property of <code>frame</code> elements to
  'block', the 'height' property of <code>frame</code> elements to 0, and the 'width' property of
  <code>frame</code> elements to 0, irrespective of CSS rules. (This only matters for when a
  <code>frame</code> element is rendered outside a <code>frameset</code>.)</p>
  http://software.hixie.ch/utilities/js/live-dom-viewer/?saved=2722 - as of Jan 2014, Chrome did this, but Firefox did not
-->

  <p>The contents of a <code>frame</code> element that does not have a <code>frameset</code> parent
  are expected to be rendered as transparent black; the user agent is expected to not render the
  <span>nested browsing context</span> in this case, and that <span>nested browsing context</span>
  is expected to have a viewport with zero width and zero height.</p>

  </div>


  <div class="impl">

  <h3 id="interactive-media">Interactive media</h3>

  <h4 id="links,-forms,-and-navigation">Links, forms, and navigation</h4>

  <p>User agents are expected to allow the user to control aspects of <span>hyperlink</span>
  activation and <span>form submission</span>, such as which <span>browsing context</span> is to be
  used for the subsequent <span data-x="navigate">navigation</span>.</p>

  <p>User agents are expected to allow users to discover the destination of <span
  data-x="hyperlink">hyperlinks</span> and of <span data-x="form">forms</span> before triggering their
  <span data-x="navigate">navigation</span>.</p>

  <p>User agents may allow users to <span>navigate</span><!--DONAV cite=""--> <span data-x="browsing
  context">browsing contexts</span> to the URLs <span data-x="resolve a url">indicated</span> by the
  <code>cite</code> attributes on <code>q</code>, <code>blockquote</code>,
  <code>ins</code>, and <code>del</code> elements.</p>

  <p>User agents may surface <span data-x="hyperlink">hyperlinks</span> created by <code>link</code>
  elements in their user interface.</p>

  <p class="note">While <code>link</code> elements that create <span
  data-x="hyperlink">hyperlinks</span> will match the ':link' or ':visited' pseudo-classes, will
  react to clicks if visible, and so forth, this does not extend to any browser interface constructs
  that expose those same links. Activating a link through the browser's interface, rather than in
  the page itself, does not trigger <code data-x="event-click">click</code> events and the like.</p>




  <h4>The <code data-x="attr-title">title</code> attribute</h4>

  <p>User agents are expected to expose the <span>advisory information</span> of elements upon user
  request, and to make the user aware of the presence of such information.</p>

  <p>On interactive graphical systems where the user can use a pointing device, this could take the
  form of a tooltip. When the user is unable to use a pointing device, then the user agent is
  expected to make the content available in some other fashion, e.g. by making the element a
  <i>focusable area</i> and always displaying the <span>advisory information</span> of the currently
  <span>focused</span> element, or by showing the <span>advisory information</span> of the elements
  under the user's finger on a touch device as the user pans around the screen.</p>

  <p>U+000A LINE FEED (LF) characters are expected to cause line breaks in the tooltip; U+0009
  CHARACTER TABULATION (tab) characters are expected to render as a non-zero horizontal shift that
  lines up the next glyph with the next tab stop, with tab stops occurring at points that are
  multiples of 8 times the width of a U+0020 SPACE character.</p>

  <div class="example">

   <p>For example, a visual user agent could make elements with a <code
   data-x="attr-title">title</code> attribute <span data-x="focusable area">focusable</span>, and could make any <span>focused</span> element with a
   <code data-x="attr-title">title</code> attribute show its tooltip under the element while the
   element has focus. This would allow a user to tab around the document to find all the advisory
   text.</p>

  </div>

  <div class="example">

   <p>As another example, a screen reader could provide an audio cue when reading an element with a
   tooltip, with an associated key to read the last tooltip for which a cue was played.</p>

  </div>


  <h4 id="editing-hosts">Editing hosts</h4>

  <p>The current text editing caret (i.e. the <span>active range</span>, if it is empty and in an
  <span>editing host</span>), if any, is expected to act like an inline
  <span>replaced element</span> with the vertical dimensions of the caret and with zero width for
  the purposes of the CSS rendering model.</p>

  <p class="note">This means that even an empty block can have the caret inside it, and that when
  the caret is in such an element, it prevents margins from collapsing through the element.</p>



  <h4 id="text-rendered-in-native-user-interfaces">Text rendered in native user interfaces</h4>

  <p>User agents are expected to honor the Unicode semantics of text that is exposed in user
  interfaces, for example supporting the bidirectional algorithm in text shown in dialogs, title
  bars, pop-up menus, and tooltips. Text from the contents of elements is expected to be rendered in
  a manner that honors <span>the directionality</span> of the element from which the text was
  obtained. Text from attributes is expected to be rendered in a manner that honours the
  <span>directionality of the attribute</span>.</p>

  <div class="example">

   <p>Consider the following markup, which has Hebrew text asking for a programming language, the
   languages being text for which a left-to-right direction is important given the punctuation in
   some of their names:</p>

   <pre>&lt;p dir="rtl" lang="he">
 &lt;label>
  <span dir="rtl" lang="he">&#x5d1;&#x5d7;&#x5e8; &#x5e9;&#x5e4;&#x5ea; &#x5ea;&#x5db;&#x5e0;&#x5d5;&#x5ea;:</span>
  &lt;select>
   &lt;option dir="ltr">C++&lt;/option>
   &lt;option dir="ltr">C#&lt;/option>
   &lt;option dir="ltr">FreePascal&lt;/option>
   &lt;option dir="ltr">F#&lt;/option>
  &lt;/select>
 &lt;/label>
&lt;/p></pre>

   <p>If the <code>select</code> element was rendered as a drop down box, a correct rendering would
   ensure that the punctuation was the same both in the drop down, and in the box showing the
   current selection.</p>

   <p><img src="images/bidizelect.png" width="206" height="105" alt=""></p> <!-- no need for alt
   text, the previous paragraph describes it completely -->

  </div>

  <div class="example">

   <p>The directionality of attributes depends on the attribute and on the element's <code
   data-x="attr-dir">dir</code> attribute, as the following example demonstrates. Consider this
   markup:</p>

   <pre><bdo dir=ltr>&lt;table>
 &lt;tr>
  &lt;th abbr="(&#x05D0;" dir=ltr>A
  &lt;th abbr="(&#x05D0;" dir=rtl>A
  &lt;th abbr="(&#x05D0;" dir=auto>A
&lt;/table></bdo></pre>

   <p>If the <code data-x="attr-th-abbr">abbr</code> attributes are rendered, e.g. in a tooltip or
   other user interface, the first will have a left parenthesis (because the direction is 'ltr'),
   the second will have a right parenthesis (because the direction is 'rtl'), and the third will
   have a right parenthesis (because the direction is determined <em>from the attribute value</em>
   to be 'rtl').</p>

   <p>However, if instead the attribute was not a <span>directionality-capable attribute</span>, the
   results would be different:</p>

   <pre><bdo dir=ltr>&lt;table>
 &lt;tr>
  &lt;th data-abbr="(&#x05D0;" dir=ltr>A
  &lt;th data-abbr="(&#x05D0;" dir=rtl>A
  &lt;th data-abbr="(&#x05D0;" dir=auto>A
&lt;/table></bdo></pre>

   <p>In this case, if the user agent were to expose the <code>data-abbr</code> attribute
   in the user interface (e.g. in a debugging environment), the last case would be rendered with a
   <em>left</em> parenthesis, because the direction would be determined from the element's
   contents.</p>

  </div>

  <p>A string provided by a script (e.g. the argument to <code
  data-x="dom-alert">window.alert()</code>) is expected to be treated as an independent set of one or
  more bidirectional algorithm paragraphs when displayed, as defined by the bidirectional algorithm,
  including, for instance, supporting the paragraph-breaking behavior of U+000A LINE FEED (LF)
  characters. For the purposes of determining the paragraph level of such text in the bidirectional
  algorithm, this specification does <em>not</em> provide a higher-level override of rules P2 and
  P3. <a href="#refsBIDI">\[BIDI]</a></p>

  <p>When necessary, authors can enforce a particular direction for a given paragraph by starting it
  with the Unicode U+200E LEFT-TO-RIGHT MARK or U+200F RIGHT-TO-LEFT MARK characters.</p>

  <div class="example">

   <p>Thus, the following script:</p>

   <pre>alert('\u05DC\u05DE\u05D3 HTML \u05D4\u05D9\u05D5\u05DD!')</pre>

   <p>...would always result in a message reading
        "<bdo lang="" dir=rtl>&#x05DC;&#x05DE;&#x05D3;&nbsp;LMTH&nbsp;&#x05D4;&#x05D9;&#x05D5;&#x05DD;!</bdo>"
   (not "<bdo lang="" dir=ltr>&#x05D3;&#x05DE;&#x05DC;&nbsp;HTML&nbsp;&#x05DD;&#x05D5;&#x05D9;&#x05D4;!</bdo>"),
   regardless of the language of the user agent interface or the
   direction of the page or any of its elements.</p>

  </div>

  <div class="example">

   <p>For a more complex example, consider the following script:</p>

   <pre class="bad">/* Warning: this script does not handle right-to-left scripts correctly */
var s;
if (s = prompt('What is your name?')) {
  alert(s + '! Ok, Fred, ' + s + ', and Wilma will get the car.');
}</pre>

   <p>When the user enters "<kbd>Kitty</kbd>", the user agent would alert "<samp>Kitty! Ok, Fred,
   Kitty, and Wilma will get the car.</samp>". However, if the user enters "<kbd dir="rtl"
   lang="ar">&#x644;&#x627;&nbsp;&#x623;&#x641;&#x647;&#x645;</kbd>", then the bidirectional
   algorithm will determine that the direction of the paragraph is right-to-left, and so the output
   will be the following unintended mess: "<samp lang=""><bdo
   dir="rtl">&#x644;&#x627;&nbsp;&#x623;&#x641;&#x647;&#x645;!&nbsp;derF&nbsp;,kO,&nbsp;&#x644;&#x627;&nbsp;&#x623;&#x641;&#x647;&#x645;,&nbsp;rac&nbsp;eht&nbsp;teg&nbsp;lliw&nbsp;amliW&nbsp;dna.</bdo></samp>"</p>

   <p>To force an alert that starts with user-provided text (or other text of unknown
   directionality) to render left-to-right, the string can be prefixed with a U+200E LEFT-TO-RIGHT
   MARK character:</p>

   <pre>var s;
if (s = prompt('What is your name?')) {
  alert('<strong>\u200E</strong>' + s + '! Ok, Fred, ' + s + ', and Wilma will get the car.');
}</pre>

  </div>



  <h3 id="print-media">Print media</h3>

  <p>User agents are expected to allow the user to request the opportunity to <dfn>obtain a physical
  form</dfn> (or a representation of a physical form) of a <code>Document</code>. For example,
  selecting the option to print a page or convert it to PDF format. <a href="#refsPDF">\[PDF]</a></p>

  <p>When the user actually <span data-x="obtain a physical form">obtains a physical form</span> (or
  a representation of a physical form) of a <code>Document</code>, the user agent is expected to
  create a new rendering of the <code>Document</code> for the print media.</p>



  <h3 id="unstyled-xml-documents">Unstyled XML documents</h3>

  <p>HTML user agents may, in certain circumstances, find themselves rendering non-HTML documents
  that use vocabularies for which they lack any built-in knowledge. This section provides for a way
  for user agents to handle such documents in a somewhat useful manner.</p>

  <p>While a <code>Document</code> is an <span>unstyled document</span>, the user agent is expected
  to render <span>an unstyled document view</span>.</p>

  <p>A <code>Document</code> is an <dfn>unstyled document</dfn> while it matches the following
  conditions:</p>

  <ul>
   <li>The <code>Document</code> has no author style sheets (whether referenced by HTTP headers, processing instructions, elements like <code>link</code>, inline elements like <code>style</code>, or any other mechanism).
   <li>None of the elements in the <code>Document</code> have any <span>presentational hints</span>.
   <li>None of the elements in the <code>Document</code> have any <span data-x="CSS styling attribute">CSS styling attributes</span>.
   <li>None of the elements in the <code>Document</code> are in any of the following namespaces: <span>HTML namespace</span>, <span>SVG namespace</span>, <span>MathML namespace</span>
   <li>The <code>Document</code> has no <i>focusable area</i> (e.g. from XLink) other than the viewport.
   <li>The <code>Document</code> has no <span data-x="hyperlink">hyperlinks</span> (e.g. from XLink).
   <li>There exists no <span data-x="concept-script">script</span> whose <span>settings object</span> specifies this <code>Document</code> as the <span>responsible document</span>.
   <li>None of the elements in the <code>Document</code> have any registered event listeners.
  </ul>

  <p><dfn>An unstyled document view</dfn> is one where the DOM is not rendered according to CSS
  (which would, since there are no applicable styles in this context, just result in a wall of
  text), but is instead rendered in a manner that is useful for a developer. This could consist of
  just showing the <code>Document</code> object's source, maybe with syntax highlighting, or it
  could consist of displaying just the DOM tree, or simply a message saying that the page is not a
  styled document.</p>

  <p class="note">If a <code>Document</code> stops being an <span>unstyled document</span>, then the
  conditions above stop applying, and thus a user agent following these requirements will switch to
  using the regular CSS rendering.</p>
